<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Whiteboard 3.0 (AI Image Gen)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ¨</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- Base & Layout Styles --- */
        :root {
            --bg-color: #111827;
            --surface-color: rgba(31, 41, 55, 0.7);
            --border-color: rgba(55, 65, 81, 0.8);
            --accent-color: #4f46e5;
            --text-color: #ffffff;
            --text-muted-color: #9ca3af;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
        }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }

        #main-layout { display: flex; height: 100vh; width: 100vw; }
        #whiteboard-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        #app-container { width: 100%; height: 100%; display: flex; flex-direction: column; padding: 1rem; }
        #main-content { position: relative; flex-grow: 1; background-color: transparent; border-radius: 0.75rem; }

        /* --- Glassmorphism & Enhanced UI --- */
        .glass-ui {
            background: var(--surface-color);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }

        /* --- Chat Column --- */
        #chat-container {
            width: 350px;
            flex-shrink: 0; display: flex; flex-direction: column;
            padding: 1rem; position: relative; transition: all 0.3s ease; z-index: 50;
        }
        #chat-container.hidden { width: 0; padding: 0; transform: translateX(-100%); overflow: hidden; }
        #chat-content-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; }
        #toggle-chat-btn {
            position: absolute; top: 50%; right: -14px; transform: translateY(-50%); z-index: 55;
            background-color: #374151; color: white; border: 1px solid #4b5563; border-left: none;
            width: 28px; height: 60px; border-radius: 0 1rem 1rem 0; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        #show-chat-btn {
            position: absolute; top: 50%; left: 0; transform: translateY(-50%); z-index: 55;
            background-color: #374151; color: white; border: 1px solid #4b5563; border-left: none;
            width: 28px; height: 60px; border-radius: 0 1rem 1rem 0; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        #chat-header { font-size: 1.5rem; font-weight: bold; color: white; margin-bottom: 1rem; text-align: center; border-bottom: 1px solid #4b5563; padding-bottom: 0.5rem;}
        #chat-messages { flex-grow: 1; overflow-y: auto; color: white; scrollbar-width: thin; scrollbar-color: var(--accent-color) transparent; padding: 0 0.5rem;}
        .chat-message { margin-bottom: 1rem; display: flex; align-items: flex-start; }
        .chat-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; background-color: #4b5563; object-fit: cover;}
        .chat-content { display: flex; flex-direction: column; max-width: calc(100% - 50px); }
        .chat-author { font-weight: bold; color: #a5b4fc; font-size: 0.8rem; margin-bottom: 2px;  word-break: break-all; }
        .chat-text { word-wrap: break-word; white-space: pre-wrap; }
        .chat-image { max-width: 100%; border-radius: 0.5rem; cursor: pointer; margin-top: 0.5rem; }
        #chat-input { background: #374151; border: 1px solid #4b5563; color: white; padding: 0.5rem; border-radius: 0.5rem; outline: none; resize: none; height: 6rem; width: 100%; margin-bottom: 0.5rem; }
        .chat-btn { background: var(--accent-color); color: white; padding: 0 1rem; border-radius: 0.5rem; border: none; cursor: pointer; height: 2.5rem; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, transform 0.1s; }
        .chat-btn:hover { background: #4338ca; transform: translateY(-2px); }
        .chat-btn:disabled { background: #374151; opacity: 0.5; cursor: not-allowed; transform: none; }

        /* --- Whiteboard Canvas --- */
        #whiteboard, #event-capture-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: transparent; border-radius: 0.75rem;
        }
        #whiteboard { z-index: 1; }
        #event-capture-layer { z-index: 3; background-color: transparent; }
        #text-input-container { position: absolute; display: none; z-index: 60; }
        #text-input { background: #1f2937; border: 1px dashed #6b7280; color: white; outline: none; padding: 4px; border-radius: 4px; }

        /* --- Revamped Toolbar --- */
        #toolbar {
            display: flex; align-items: center; justify-content: center; flex-wrap: wrap;
            gap: 0.75rem; padding: 0.5rem; margin-bottom: 1rem; position: relative; z-index: 100;
        }
        .toolbar-group { display: flex; align-items: center; padding: 0.25rem; gap: 0.25rem; }
        .divider { width: 1px; height: 24px; background-color: var(--border-color); margin: 0 0.5rem; }
        .tool-btn, .size-btn { background: transparent; border: none; color: var(--text-muted-color); padding: 0.5rem; border-radius: 0.5rem; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .tool-btn:hover:not(:disabled), .size-btn:hover { transform: scale(1.15) rotate(-5deg); filter: brightness(1.2); color: var(--text-color); }
        .tool-btn.selected, .size-btn.selected { background-color: var(--accent-color); color: white; transform: scale(1.1); }
        .tool-btn:disabled { color: #555; cursor: not-allowed; }
        .tool-btn:disabled:hover { transform: none; filter: none; }

        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            visibility: hidden; opacity: 0; transition: all 0.2s ease-out;
            position: absolute; top: 120%; left: 50%; transform: translateX(-50%) translateY(-10px);
            z-index: 110; padding: 0.5rem;
        }
        .dropdown.open .dropdown-content { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
        .shape-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; width: 100%; height: 50px; font-size: 0.65rem;
        }
        .shape-btn i { font-size: 1.1rem; }
       
        /* Other styles remain the same... */
        #color-picker-popover { visibility: hidden; opacity: 0; position: absolute; padding: 1rem; z-index: 1000; transition: all 0.2s ease-out; transform: translateY(-10px); }
        #color-picker-popover.visible { visibility: visible; opacity: 1; transform: translateY(0); }
        #color-picker-btn { width: 2.25rem; height: 2.25rem; border-radius: 50%; border: 2px solid white; cursor: pointer; transition: transform 0.2s; }
        #color-picker-btn:hover { transform: scale(1.1); }
        #eyedropper-btn { font-size: 1.25rem; }
        body.eyedropper-active { cursor: crosshair; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal { transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal { transform: scale(1); }
        .loader { width: 2rem; height: 2rem; border-radius: 50%; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-white antialiased">
    <div id="main-layout">
        <div id="chat-container">
            <div id="chat-content-wrapper" class="glass-ui">
                <button id="toggle-chat-btn"><i class="fa-solid fa-chevron-left"></i></button>
                <div class="flex justify-between items-center mb-4 p-4">
                     <h2 id="chat-header" class="flex-grow text-center">Live Chat</h2>
                    <button id="summarize-chat-btn" class="chat-btn !p-2" title="Summarize Chat"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
                </div>
                <div id="chat-messages" class="flex-grow px-4"></div>
                <div id="chat-input-area" class="p-4">
                     <textarea id="chat-input" placeholder="Sign in to use the chat." disabled></textarea>
                    <div class="flex justify-between w-full">
                        <button id="gif-search-btn" class="chat-btn" disabled><i class="fa-solid fa-photo-film"></i> &nbsp; GIF</button>
                        <button id="chat-send-btn" class="chat-btn" disabled><i class="fa-solid fa-paper-plane"></i> &nbsp; Send</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="whiteboard-wrapper">
            <button id="show-chat-btn" class="hidden"><i class="fa-solid fa-chevron-right"></i></button>
            <div id="app-container">
                <header class="flex flex-col md:flex-row justify-between items-start mb-4">
                    <div>
                        <h1 id="whiteboard-title" class="text-2xl font-bold text-white rounded px-1"></h1>
                        <p id="whiteboard-description" class="text-sm text-gray-400 rounded px-1"></p>
                    </div>
                     <div class="flex flex-col items-end mt-2 md:mt-0 space-y-2">
                        <div id="auth-container" class="flex items-center gap-2">
                             <span id="user-display-name" class="text-sm text-white font-semibold"></span>
                            <button id="google-signin-btn" class="p-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-sm font-semibold flex items-center gap-2">
                                 <i class="fa-brands fa-google"></i> Sign In
                            </button>
                            <button id="signout-btn" class="hidden p-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-semibold">
                                 Sign Out
                            </button>
                        </div>
                        <div class="text-xs text-gray-500">User ID: <span id="userId" class="font-mono bg-gray-700 px-2 py-1 rounded">Not Signed In</span></div>
                         <div class="text-xs text-gray-500">Version: <span id="version-number" class="font-mono bg-gray-700 px-2 py-1 rounded">4.0-3D</span></div>
                         <button id="help-btn" class="p-2 text-blue-400 hover:text-blue-500 text-2xl" title="Help (Ctrl+K)"><i class="fa-solid fa-circle-question"></i></button>
                    </div>
                </header>
                 <div id="toolbar" class="glass-ui">
                    <div class="toolbar-group">
                        <p class="text-sm text-gray-400 px-2">3D Navigation Enabled</p>
                    </div>
                    <div class="divider"></div>
                    <div class="toolbar-group">
                        <button data-tool="select" class="tool-btn p-2" title="Select & Move (V)" disabled><i class="fa-solid fa-arrow-pointer"></i></button>
                        <button data-tool="pen" class="tool-btn p-2" title="Pen (P)" disabled><i class="fa-solid fa-pen"></i></button>
                        <div id="shapes-dropdown" class="dropdown">
                             <button class="tool-btn p-2" title="Shapes (S)" disabled><i class="fa-solid fa-shapes"></i></button>
                             <div class="dropdown-content glass-ui grid grid-cols-4 gap-2 p-3 w-64 rounded-md shadow-lg"></div>
                         </div>
                        <button data-tool="text" class="tool-btn p-2" title="Text (T)" disabled><i class="fa-solid fa-font"></i></button>
                        <button id="clear-canvas-btn" class="tool-btn p-2 text-red-400" title="Clear Canvas"><i class="fa-solid fa-eraser"></i></button>
                    </div>
                     <div class="divider"></div>
                     <p class="text-sm text-gray-400 px-2">Use mouse to navigate: <kbd>L-Click+Drag</kbd> to Rotate, <kbd>R-Click+Drag</kbd> to Pan, <kbd>Scroll</kbd> to Zoom</p>
                </div>

                <main id="main-content" class="flex-grow w-full h-full min-h-0 relative">
                    <canvas id="whiteboard"></canvas>
                    <div id="event-capture-layer"></div>
                    </main>
            </div>
        </div>
    </div>
    
    <script type="module">
        // --- Three.js Imports ---
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.166.1/build/three.module.js';
        import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.166.1/examples/jsm/controls/OrbitControls.js';

        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection, addDoc, doc, setDoc, getDoc, query, where, updateDoc, serverTimestamp, writeBatch, getDocs, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'whiteboard-00-default';
        const whiteboardId = appId;
        
        // --- API Key Globals ---
        let firebaseApiKey; // Tenor key not used in this PoC

        // --- DOM Elements ---
        const main_content = document.getElementById('main-content');
        const canvas = document.getElementById('whiteboard');
        // eventCaptureLayer is now used for OrbitControls
        const eventCaptureLayer = document.getElementById('event-capture-layer');
        // Other DOM elements... (truncated)
        const googleSignInBtn = document.getElementById('google-signin-btn');
        const signOutBtn = document.getElementById('signout-btn');

        // --- Firebase & State Globals ---
        let db, userId, auth;
        let unsubscribeFromDrawings, unsubscribeFromState;
        const state = {
            allDrawings: new Map(),
            currentEpoch: 0,
        };
        const threeObjects = new Map(); // Map Firestore ID to Three.js Object3D

        // --- Three.js Globals ---
        let scene, camera, renderer, controls, gridHelper;
        const textureLoader = new THREE.TextureLoader();
        const imageCache = new Map();

        // --- Core Drawing & State Logic (NOW 3D) ---

        function initThree() {
            const rect = main_content.getBoundingClientRect();

            // 1. Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111827);

            // 2. Camera
            camera = new THREE.PerspectiveCamera(75, rect.width / rect.height, 0.1, 5000);
            camera.position.set(0, 200, 500);

            // 3. Renderer
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(rect.width, rect.height);
            renderer.setPixelRatio(window.devicePixelRatio);

            // 4. Controls
            controls = new OrbitControls(camera, eventCaptureLayer);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // 5. Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(100, 200, 300);
            scene.add(directionalLight);

            // 6. Grid Helper
            gridHelper = new THREE.GridHelper(2000, 100, 0x444444, 0x222222);
            scene.add(gridHelper);

            // 7. Start Animation Loop
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update(); // only required if controls.enableDamping = true
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const rect = main_content.getBoundingClientRect();
            if (rect.width === 0 || rect.height === 0) return;

            // Update camera aspect ratio and renderer size
            camera.aspect = rect.width / rect.height;
            camera.updateProjectionMatrix();
            renderer.setSize(rect.width, rect.height);
        }
        
        // REPLACES redrawCanvas
        function updateSceneFromState() {
            const existingIds = new Set(threeObjects.keys());
            const firestoreIds = new Set(state.allDrawings.keys());

            // Add new or update existing objects
            state.allDrawings.forEach((data, id) => {
                if (threeObjects.has(id)) {
                    // Update logic would go here in a full implementation
                } else {
                    // Create and add new object
                    const threeObj = createThreeObject(data);
                    if (threeObj) {
                        threeObjects.set(id, threeObj);
                        scene.add(threeObj);
                    }
                }
            });

            // Remove objects that are no longer in Firestore
            existingIds.forEach(id => {
                if (!firestoreIds.has(id)) {
                    const objToRemove = threeObjects.get(id);
                    scene.remove(objToRemove);
                    threeObjects.delete(id);
                }
            });
        }
        
        // REPLACES drawObject
        function createThreeObject(data) {
            if (!data) return null;
            
            const material = new THREE.MeshStandardMaterial({
                color: data.color || 0xffffff,
                side: THREE.DoubleSide,
                transparent: true, // Needed for images with alpha
            });

            let obj;

            // Position objects based on their center, with Z determined by timestamp
            // This gives a slight depth effect to older vs newer drawings
            const zPos = (data.timestamp?.seconds || 0) % 100;

            switch (data.type) {
                case 'rectangle':
                    obj = new THREE.Mesh(new THREE.PlaneGeometry(data.width, data.height), material);
                    obj.position.set(data.x + data.width / 2, - (data.y + data.height / 2), zPos);
                    break;

                case 'circle':
                    obj = new THREE.Mesh(new THREE.CircleGeometry(data.radius, 32), material);
                    obj.position.set(data.x, -data.y, zPos);
                    break;
                
                case 'path':
                    if (!data.points || data.points.length < 2) return null;
                    const points = data.points.map(p => new THREE.Vector3(p.x, -p.y, zPos));
                    const geometry = new THREE.BufferGeometry().setFromPoints(points);
                    const lineMaterial = new THREE.LineBasicMaterial({ color: data.color || 0xffffff });
                    obj = new THREE.Line(geometry, lineMaterial);
                    break;
                
                case 'image':
                    const planeGeom = new THREE.PlaneGeometry(data.width, data.height);
                    const imageMaterial = material.clone();
                    
                    if (imageCache.has(data.url)) {
                        imageMaterial.map = imageCache.get(data.url);
                        imageMaterial.needsUpdate = true;
                    } else {
                        textureLoader.load(data.url, (texture) => {
                            imageCache.set(data.url, texture);
                            imageMaterial.map = texture;
                            imageMaterial.needsUpdate = true;
                        });
                    }
                    obj = new THREE.Mesh(planeGeom, imageMaterial);
                    obj.position.set(data.x, -data.y, zPos);
                    break;

                default:
                    return null;
            }

            if (obj) {
                obj.userData.firestoreId = data.id; // Link back to Firestore data
                obj.rotation.x = -Math.PI / 2; // Rotate from XY plane to be upright on the XZ grid
            }
            return obj;
        }

        // --- Firebase Listeners ---
        function setupStateListener() {
            const stateDocPath = `artifacts/${whiteboardId}/public/data/state/main`;
            if (unsubscribeFromState) unsubscribeFromState();
            unsubscribeFromState = onSnapshot(doc(db, stateDocPath), (docSnapshot) => {
                const boardState = docSnapshot.data() || {};
                const newEpoch = boardState.epoch || Date.now();
                if (newEpoch !== state.currentEpoch) {
                    state.currentEpoch = newEpoch;
                    setupDrawingsListener();
                }
            });
        }

        function setupDrawingsListener() {
            if (state.currentEpoch === 0) return;
            if (unsubscribeFromDrawings) unsubscribeFromDrawings();
            
            // Clear existing objects before listening
            threeObjects.forEach(obj => scene.remove(obj));
            threeObjects.clear();
            state.allDrawings.clear();

            const drawingsCollectionPath = `artifacts/${whiteboardId}/public/data/drawings`;
            const q = query(collection(db, drawingsCollectionPath), where("epoch", "==", state.currentEpoch));
            
            unsubscribeFromDrawings = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const docData = change.doc.data();
                    if (change.type === 'removed' || docData.isDeleted) {
                        state.allDrawings.delete(change.doc.id);
                    } else {
                        state.allDrawings.set(change.doc.id, { id: change.doc.id, ...docData });
                    }
                });
                updateSceneFromState(); // Update the 3D scene with new data
            }, error => console.error("Drawings listener error:", error));
        }

        async function clearAllDrawings() {
            // This function remains largely the same logic
            const drawingsCollectionPath = `artifacts/${whiteboardId}/public/data/drawings`;
            const q = query(collection(db, drawingsCollectionPath));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) return;
            const batch = writeBatch(db);
            querySnapshot.forEach((doc) => batch.delete(doc.ref));
            await batch.commit();
            await setDoc(doc(db, `artifacts/${whiteboardId}/public/data/state/main`), { epoch: Date.now() }, { merge: true });
        }
        
        // --- Main App Initialization ---
        function initializeAppLogic(fKey) {
            firebaseApiKey = fKey;
            const firebaseConfig = { apiKey: firebaseApiKey, authDomain: "whiteboard-00.firebaseapp.com", projectId: "whiteboard-00" /* ...rest of config */ };
            
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                // Handle error...
                return;
            }

            // --- NEW: Initialize 3D Scene ---
            initThree();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    // Auth UI logic...
                    setupStateListener();
                    setupDrawingsListener();
                } else {
                    userId = null;
                    // De-auth UI logic...
                }
            });

            if (!auth.currentUser) {
                signInAnonymously(auth).catch(console.error);
            }
            
            // Setup Event Listeners
            googleSignInBtn.addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));
            signOutBtn.addEventListener('click', () => signOut(auth));
            window.addEventListener('resize', onWindowResize, { passive: true });
            document.getElementById('clear-canvas-btn').addEventListener('click', () => {
                 // Confirmation modal logic would go here
                 clearAllDrawings();
            });
            // Other listeners for chat, etc. would remain...
        }

        // --- Entry Point ---
        window.addEventListener('load', () => {
            // Simplified for PoC
            const storedFirebaseKey = localStorage.getItem('firebaseApiKey');
            if (storedFirebaseKey) {
                initializeAppLogic(storedFirebaseKey);
            } else {
                // API key modal logic...
                console.log("API Key modal would show here");
            }
        });
    </script>
</body>
</html>
