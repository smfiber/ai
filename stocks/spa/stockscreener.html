<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magickal SPA</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Apply the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for the modal to be hidden by default */
        .modal {
            display: none;
        }
        /* Styles for accordion transition */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        /* Hide tab content by default */
        .tab-content {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Application Content -->
    <div id="appContent" class="p-4 md:p-8">
        <h1 class="text-3xl md:text-4xl font-bold text-indigo-600 text-center mb-8">Magickal SPA Dashboard</h1>
        
        <!-- Tab Navigation -->
        <div class="max-w-6xl mx-auto mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button id="ai-tab-button" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        AI Analysis
                    </button>
                    <button id="screener-tab-button" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Stock Screener
                    </button>
                    <button id="news-tab-button" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Price Target News
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab Content Area -->
        <div class="max-w-6xl mx-auto">
            <!-- AI Analysis Tab -->
            <div id="ai-tab-content" class="tab-content">
                <div class="space-y-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">AI-Powered News Summaries</h2>
                        <div id="nasdaq-summary-container" class="bg-white p-6 rounded-xl shadow-md"></div>
                    </div>
                    <div>
                        <div id="nyse-summary-container" class="bg-white p-6 rounded-xl shadow-md"></div>
                    </div>
                    <div>
                        <div id="amex-summary-container" class="bg-white p-6 rounded-xl shadow-md"></div>
                    </div>
                </div>
            </div>

            <!-- Stock Screener Tab -->
            <div id="screener-tab-content" class="tab-content">
                <div class="space-y-4">
                    <!-- Accordions for Stock Screener Tables -->
                    <div id="nasdaqScreenerAccordion" class="bg-white rounded-xl shadow-md">
                        <button id="nasdaq-accordion-button" class="w-full flex justify-between items-center p-5 text-left font-semibold text-lg hover:bg-gray-50 rounded-t-xl focus:outline-none">
                            <span>Stock Screener Table: NASDAQ (Market Cap > $1B)</span>
                            <svg id="nasdaq-accordion-icon" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="nasdaq-accordion-content" class="accordion-content px-5 pb-5">
                            <div id="nasdaq-screener-data-container" class="mt-4 border-t pt-4"></div>
                        </div>
                    </div>
                    <div id="nyseScreenerAccordion" class="bg-white rounded-xl shadow-md">
                        <button id="nyse-accordion-button" class="w-full flex justify-between items-center p-5 text-left font-semibold text-lg hover:bg-gray-50 rounded-t-xl focus:outline-none">
                            <span>Stock Screener Table: NYSE (Market Cap > $1B)</span>
                            <svg id="nyse-accordion-icon" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="nyse-accordion-content" class="accordion-content px-5 pb-5">
                            <div id="nyse-screener-data-container" class="mt-4 border-t pt-4"></div>
                        </div>
                    </div>
                    <div id="amexScreenerAccordion" class="bg-white rounded-xl shadow-md">
                        <button id="amex-accordion-button" class="w-full flex justify-between items-center p-5 text-left font-semibold text-lg hover:bg-gray-50 rounded-t-xl focus:outline-none">
                            <span>Stock Screener Table: AMEX (Market Cap > $1B)</span>
                            <svg id="amex-accordion-icon" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="amex-accordion-content" class="accordion-content px-5 pb-5">
                            <div id="amex-screener-data-container" class="mt-4 border-t pt-4"></div>
                        </div>
                    </div>
                </div>

                <!-- Card View Section -->
                <div class="mt-12">
                    <h2 class="text-2xl font-bold text-center mb-6">Stock Card View by Sector & Industry</h2>
                    <div id="nasdaq-card-view" class="mb-8"></div>
                    <div id="nyse-card-view" class="mb-8"></div>
                    <div id="amex-card-view" class="mb-8"></div>
                </div>
            </div>

            <!-- Price Target News Tab -->
            <div id="news-tab-content" class="tab-content">
                <div class="space-y-4">
                    <!-- NASDAQ News Accordion -->
                    <div class="bg-white rounded-xl shadow-md">
                        <div id="nasdaq-news-accordion-button" class="w-full flex justify-between items-center p-5 text-left font-semibold text-lg hover:bg-gray-50 rounded-xl focus:outline-none cursor-pointer">
                            <span>NASDAQ Price Target News</span>
                            <div class="flex items-center">
                                <button id="refresh-nasdaq-news" class="text-sm bg-indigo-100 text-indigo-700 hover:bg-indigo-200 rounded-md px-3 py-1 mr-4">Refresh News</button>
                                <svg id="nasdaq-news-accordion-icon" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                        <div id="nasdaq-news-accordion-content" class="accordion-content px-5 pb-5">
                            <div id="nasdaq-news-container" class="mt-4 border-t pt-4 space-y-4"></div>
                        </div>
                    </div>
                    <!-- NYSE News Accordion -->
                    <div class="bg-white rounded-xl shadow-md">
                        <div id="nyse-news-accordion-button" class="w-full flex justify-between items-center p-5 text-left font-semibold text-lg hover:bg-gray-50 rounded-xl focus:outline-none cursor-pointer">
                            <span>NYSE Price Target News</span>
                            <div class="flex items-center">
                                <button id="refresh-nyse-news" class="text-sm bg-indigo-100 text-indigo-700 hover:bg-indigo-200 rounded-md px-3 py-1 mr-4">Refresh News</button>
                                <svg id="nyse-news-accordion-icon" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                        <div id="nyse-news-accordion-content" class="accordion-content px-5 pb-5">
                            <div id="nyse-news-container" class="mt-4 border-t pt-4 space-y-4"></div>
                        </div>
                    </div>
                    <!-- AMEX News Accordion -->
                    <div class="bg-white rounded-xl shadow-md">
                        <div id="amex-news-accordion-button" class="w-full flex justify-between items-center p-5 text-left font-semibold text-lg hover:bg-gray-50 rounded-xl focus:outline-none cursor-pointer">
                            <span>AMEX Price Target News</span>
                            <div class="flex items-center">
                                <button id="refresh-amex-news" class="text-sm bg-indigo-100 text-indigo-700 hover:bg-indigo-200 rounded-md px-3 py-1 mr-4">Refresh News</button>
                                <svg id="amex-news-accordion-icon" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                        <div id="amex-news-accordion-content" class="accordion-content px-5 pb-5">
                            <div id="amex-news-container" class="mt-4 border-t pt-4 space-y-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 z-[100] items-center justify-center p-4 modal">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-75"></div>
        <div class="relative bg-white rounded-2xl shadow-lg border border-gray-200 p-8 w-full max-w-lg m-4 overflow-y-auto max-h-[90vh]">
            <h2 class="text-2xl font-bold mb-4">API Keys Required</h2>
            <p class="text-gray-500 mb-6">Please provide your API keys to get started.</p>
            <form id="apiKeyForm">
                <div class="space-y-4">
                    <div>
                        <label for="geminiApiKeyInput" class="block text-sm font-semibold text-gray-800 mb-1">Google Gemini API Key</label>
                        <input type="password" id="geminiApiKeyInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your Google Gemini API Key">
                    </div>
                    <div>
                        <label for="googleClientIdInput" class="block text-sm font-semibold text-gray-800 mb-1">Google Cloud Client ID</label>
                        <input type="password" id="googleClientIdInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your Google Cloud Web Client ID">
                    </div>
                    <div>
                        <label for="webSearchApiKeyInput" class="block text-sm font-semibold text-gray-800 mb-1">Web Search API Key (Google)</label>
                        <input type="password" id="webSearchApiKeyInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your Google Cloud API Key">
                    </div>
                    <div>
                        <label for="searchEngineIdInput" class="block text-sm font-semibold text-gray-800 mb-1">Search Engine ID (cx value)</label>
                        <input type="text" id="searchEngineIdInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your Custom Search Engine ID">
                    </div>
                    <div>
                        <label for="fmpApiKeyInput" class="block text-sm font-semibold text-gray-800 mb-1">Financial Modeling Prep API Key</label>
                        <input type="password" id="fmpApiKeyInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your FMP API Key">
                    </div>
                    <div>
                        <label for="firebaseConfigInput" class="block text-sm font-semibold text-gray-800 mb-1">Firebase Web App Config</label>
                        <textarea id="firebaseConfigInput" class="border border-gray-300 rounded-lg w-full p-2 font-mono text-xs" rows="6" placeholder="Paste your Firebase Web App Config Object"></textarea>
                    </div>
                </div>
                <p id="api-key-error" class="text-red-500 text-sm mt-4 h-5"></p>
                <div class="mt-6 flex justify-end">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition-colors">Save and Continue</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Floating Action Button for CRUD -->
    <button id="manageSummariesBtn" class="fixed bottom-8 right-8 bg-indigo-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-indigo-700 transition-transform transform hover:scale-110 focus:outline-none">
        <i class="fas fa-archive fa-lg"></i>
    </button>

    <!-- CRUD Modal for Summaries -->
    <div id="summaryCrudModal" class="fixed inset-0 z-[100] items-center justify-center p-4 modal">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-75" id="crudModalOverlay"></div>
        <div class="relative bg-white rounded-2xl shadow-lg border border-gray-200 p-8 w-full max-w-3xl m-4 overflow-y-auto max-h-[90vh]">
            <h2 class="text-2xl font-bold mb-6">Manage Saved Summaries</h2>
            
            <!-- Container for the list of saved summaries -->
            <div id="savedSummariesList" class="space-y-4">
                <!-- Summaries will be dynamically inserted here -->
            </div>

            <!-- Hidden Edit Form -->
            <div id="editSummaryFormContainer" class="hidden mt-8 p-6 bg-gray-50 rounded-lg">
                <h3 class="text-xl font-bold mb-4">Edit Summary</h3>
                <form id="editSummaryForm">
                    <input type="hidden" id="editSummaryId">
                    <input type="hidden" id="editSummaryExchange">
                    <textarea id="editSummaryText" class="w-full p-2 border border-gray-300 rounded-lg" rows="6"></textarea>
                    <div class="mt-4 flex justify-end space-x-3">
                        <button type="button" id="cancelEditBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancel</button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-database-compat.js"></script>

    <script>
        // Version 2.9
        document.addEventListener("DOMContentLoaded", () => {
            // --- 1. Global Configuration Object ---
            const appConfig = {
                fmpApiKey: "",
                geminiApiKey: "",
                searchApiKey: "",
                searchEngineId: "",
                googleClientId: "",
                firebaseConfig: {},
                currentSummaries: {
                    nasdaq: null,
                    nyse: null,
                    amex: null
                }
            };
            
            let db = null;

            // --- Utility to pause execution ---
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            // --- 2. DOM Element Selection ---
            const apiKeyModal = document.getElementById('apiKeyModal');
            const apiKeyForm = document.getElementById('apiKeyForm');
            const errorMessage = document.getElementById('api-key-error');
            const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
            const googleClientIdInput = document.getElementById('googleClientIdInput');
            const webSearchApiKeyInput = document.getElementById('webSearchApiKeyInput');
            const searchEngineIdInput = document.getElementById('searchEngineIdInput');
            const fmpApiKeyInput = document.getElementById('fmpApiKeyInput');
            const firebaseConfigInput = document.getElementById('firebaseConfigInput');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const manageSummariesBtn = document.getElementById('manageSummariesBtn');
            const summaryCrudModal = document.getElementById('summaryCrudModal');
            const crudModalOverlay = document.getElementById('crudModalOverlay');
            const savedSummariesList = document.getElementById('savedSummariesList');
            const editSummaryFormContainer = document.getElementById('editSummaryFormContainer');
            const editSummaryForm = document.getElementById('editSummaryForm');
            const cancelEditBtn = document.getElementById('cancelEditBtn');


            // --- 3. Initialization Logic ---
            function initialize() {
                showModal();
            }

            // --- 4. Form Submission Handler ---
            apiKeyForm.addEventListener('submit', (event) => {
                event.preventDefault();
                errorMessage.textContent = '';
                const formValues = {
                    geminiApiKey: geminiApiKeyInput.value.trim(),
                    googleClientId: googleClientIdInput.value.trim(),
                    searchApiKey: webSearchApiKeyInput.value.trim(),
                    searchEngineId: searchEngineIdInput.value.trim(),
                    fmpApiKey: fmpApiKeyInput.value.trim(),
                    firebaseConfigString: firebaseConfigInput.value.trim()
                };
                if (Object.values(formValues).some(value => value === '')) {
                    errorMessage.textContent = 'All fields are required.';
                    return;
                }
                try {
                    const parsedFirebaseConfig = JSON.parse(formValues.firebaseConfigString);
                    if (!parsedFirebaseConfig.databaseURL) {
                        errorMessage.textContent = 'Firebase Config must include a "databaseURL" property.';
                        return;
                    }
                    Object.assign(appConfig, { ...formValues, firebaseConfig: parsedFirebaseConfig });
                    hideModal();
                    startApp();
                } catch (error) {
                    errorMessage.textContent = 'Invalid Firebase Config JSON.';
                }
            });

            // --- 5. Modal & Tab Utility Functions ---
            function showModal() { apiKeyModal.style.display = 'flex'; }
            function hideModal() { apiKeyModal.style.display = 'none'; }
            
            function setupTabs() {
                const tabMap = {
                    'ai-tab-button': 'ai-tab-content',
                    'screener-tab-button': 'screener-tab-content',
                    'news-tab-button': 'news-tab-content'
                };

                const setActiveTab = (activeButtonId) => {
                    tabButtons.forEach(button => {
                        const is_active = button.id === activeButtonId;
                        button.classList.toggle('border-indigo-500', is_active);
                        button.classList.toggle('text-indigo-600', is_active);
                        button.classList.toggle('border-transparent', !is_active);
                        button.classList.toggle('text-gray-500', !is_active);
                    });
                    Object.values(tabMap).forEach(contentId => {
                        document.getElementById(contentId).style.display = (tabMap[activeButtonId] === contentId) ? 'block' : 'none';
                    });
                };

                tabButtons.forEach(button => {
                    button.addEventListener('click', () => setActiveTab(button.id));
                });
                
                setActiveTab('ai-tab-button');
            }

            // --- 6. Main Application Logic ---
            async function startApp() {
                console.log("Application starting...");
                setupTabs();
                setupCrudModalListeners();

                try {
                    if (appConfig.firebaseConfig && appConfig.firebaseConfig.databaseURL) {
                        firebase.initializeApp(appConfig.firebaseConfig);
                        db = firebase.database();
                        console.log("Firebase initialized successfully.");
                    } else {
                        console.warn("Firebase config is missing or does not contain a databaseURL. Cannot initialize Firebase.");
                    }
                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    alert("Could not initialize Firebase. Please check your configuration.");
                }

                const exchanges = ['nasdaq', 'nyse', 'amex'];
                for (const exchange of exchanges) {
                    console.log(`Initializing components for ${exchange.toUpperCase()}...`);
                    await initExchangeData(exchange);
                    console.log(`Completed ${exchange.toUpperCase()}.`);
                }
                console.log("All data loaded.");
            }

            // --- 7. Data Initialization for Each Exchange ---
            async function initExchangeData(exchange) {
                const exchangeUpperCase = exchange.toUpperCase();
                const screenerAccordionButton = document.getElementById(`${exchange}-accordion-button`);
                const screenerAccordionContent = document.getElementById(`${exchange}-accordion-content`);
                const screenerAccordionIcon = document.getElementById(`${exchange}-accordion-icon`);
                const newsAccordionButton = document.getElementById(`${exchange}-news-accordion-button`);
                const newsAccordionContent = document.getElementById(`${exchange}-news-accordion-content`);
                const newsAccordionIcon = document.getElementById(`${exchange}-news-accordion-icon`);
                const tableContainer = document.getElementById(`${exchange}-screener-data-container`);
                const cardContainer = document.getElementById(`${exchange}-card-view`);
                const newsContainer = document.getElementById(`${exchange}-news-container`);
                const summaryContainer = document.getElementById(`${exchange}-summary-container`);
                const refreshButton = document.getElementById(`refresh-${exchange}-news`);

                setupAccordionToggle(screenerAccordionButton, screenerAccordionContent, screenerAccordionIcon);
                setupAccordionToggle(newsAccordionButton, newsAccordionContent, newsAccordionIcon);

                const screenerData = await fetchStockScreener(exchangeUpperCase, tableContainer, cardContainer);
                
                const loadedFromCache = await loadNewsFromFirebase(exchange, newsContainer, summaryContainer);
                if (!loadedFromCache) {
                    await fetchAndRenderPriceTargetNews(screenerData, newsContainer, summaryContainer, exchange);
                }

                refreshButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    newsContainer.innerHTML = `<p class="text-indigo-500 font-semibold p-4">Refreshing news for ${exchangeUpperCase}...</p>`;
                    summaryContainer.innerHTML = `<h3>${exchangeUpperCase} News Summary</h3><p class="text-gray-500">Loading summary...</p>`;
                    fetchAndRenderPriceTargetNews(screenerData, newsContainer, summaryContainer, exchange);
                });
            }

            // --- 8. Accordion Toggle Logic ---
            function setupAccordionToggle(button, content, icon) {
                if (!button) return;
                button.addEventListener('click', () => {
                    const isOpen = content.style.maxHeight && content.style.maxHeight !== "0px";
                    content.style.maxHeight = isOpen ? "0px" : content.scrollHeight + "px";
                    icon.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
                });
            }

            // --- 9. Fetch Stock Screener Data ---
            async function fetchStockScreener(exchange, tableEl, cardEl) {
                const loadingMsg = `<p class="text-gray-500">Loading screener for ${exchange}...</p>`;
                [tableEl, cardEl].forEach(el => { if(el) el.innerHTML = loadingMsg });

                if (!appConfig.fmpApiKey) {
                    const errorMsg = '<p class="text-red-500">Financial Modeling Prep API Key is missing.</p>';
                    [tableEl, cardEl].forEach(el => { if(el) el.innerHTML = errorMsg });
                    return [];
                }

                const url = `https://financialmodelingprep.com/api/v3/stock-screener?marketCapMoreThan=1000000000&exchange=${exchange}&limit=1000&apikey=${appConfig.fmpApiKey}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                    const data = await response.json();
                    
                    renderStockTable(data, tableEl);
                    renderStockCards(data, cardEl, exchange);
                    return data;
                } catch (error) {
                    console.error(`Error fetching screener data for ${exchange}:`, error);
                    const errorMsg = `<p class="text-red-500">Error fetching data for ${exchange}.</p>`;
                    [tableEl, cardEl].forEach(el => { if(el) el.innerHTML = errorMsg });
                    return [];
                }
            }
            
            // --- 10. Fetch and Render Price Target News ---
            async function fetchAndRenderPriceTargetNews(screenerData, newsContainer, summaryContainer, exchange) {
                if (summaryContainer) {
                    summaryContainer.innerHTML = `<h3>${exchange.toUpperCase()} News Summary</h3><p class="text-gray-500">Loading summary...</p>`;
                }
                
                const symbols = screenerData.map(stock => stock.symbol);

                if (symbols.length === 0) {
                    const noDataMsg = `<p class="text-gray-500">No stocks found to fetch news for.</p>`;
                    newsContainer.innerHTML = noDataMsg;
                    if (summaryContainer) {
                        summaryContainer.innerHTML = `<h3>${exchange.toUpperCase()} News Summary</h3>${noDataMsg}`;
                    }
                    return;
                }

                let allNews = [];
                for (const [index, symbol] of symbols.entries()) {
                    try {
                        const url = `https://financialmodelingprep.com/stable/price-target-news?symbol=${symbol}&page=0&limit=10&apikey=${appConfig.fmpApiKey}`;
                        newsContainer.innerHTML = `<p class="text-gray-500 p-4">Fetching news for ${symbol} (${index + 1} of ${symbols.length})...<br><code class="text-xs text-indigo-500">${url}</code></p>`;
                        
                        const response = await fetch(url);

                        if (response.status === 429) {
                            console.error(`Rate limit exceeded when fetching news for ${symbol}. Stopping further requests.`);
                            newsContainer.innerHTML += `<p class="text-red-500 p-4 font-semibold">API rate limit reached. Please wait a moment and try refreshing again.</p>`;
                            break;
                        }

                        if(response.ok) {
                            const newsItems = await response.json();
                            if (newsItems && newsItems.length > 0) {
                                allNews.push(...newsItems);
                            }
                        } else {
                            console.warn(`Could not fetch news for ${symbol}: ${response.status} ${response.statusText}`);
                        }
                        await delay(600);
                    } catch (loopError) {
                        console.error(`An error occurred in the news fetching loop for ${symbol}:`, loopError);
                    }
                }

                let filteredNews = allNews.flat().filter(item => item && item.newsTitle && item.publishedDate && item.newsURL);

                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                filteredNews = filteredNews.filter(newsItem => {
                    const newsDate = new Date(newsItem.publishedDate);
                    return newsDate >= thirtyDaysAgo;
                });
                
                filteredNews.sort((a, b) => new Date(b.publishedDate) - new Date(a.publishedDate));

                renderNewsCards(filteredNews, newsContainer);
                await summarizeNewsWithGemini(filteredNews, summaryContainer, exchange);
                await saveNewsToFirebase(exchange, filteredNews);
            }
            
            // --- 11. Firebase Functions ---
            async function saveNewsToFirebase(exchange, newsData) {
                if (!db) {
                    console.warn("Firebase not initialized, cannot save news.");
                    return;
                }
                try {
                    await db.ref(`news/${exchange}`).set(newsData);
                    console.log(`News for ${exchange.toUpperCase()} saved to Firebase.`);
                } catch (error) {
                    console.error(`Failed to save news for ${exchange} to Firebase:`, error);
                }
            }

            async function loadNewsFromFirebase(exchange, newsContainer, summaryContainer) {
                if (!db) {
                    console.warn("Firebase not initialized, cannot load news.");
                    return false;
                }
                try {
                    const snapshot = await db.ref(`news/${exchange}`).get();
                    if (snapshot.exists()) {
                        const newsData = snapshot.val();
                        console.log(`Loaded news for ${exchange.toUpperCase()} from Firebase.`);
                        renderNewsCards(newsData, newsContainer);
                        await summarizeNewsWithGemini(newsData, summaryContainer, exchange);
                        return true;
                    } else {
                        console.log(`No cached news found for ${exchange.toUpperCase()} in Firebase.`);
                        return false;
                    }
                } catch (error) {
                    console.error(`Failed to load news for ${exchange} from Firebase:`, error);
                    return false;
                }
            }

            // --- 12. Summarize News with Gemini ---
            async function summarizeNewsWithGemini(newsData, container, exchange) {
                if (!appConfig.geminiApiKey) {
                    container.innerHTML = `<h3>${exchange.toUpperCase()} News Summary</h3><p class="text-red-500">Gemini API Key is missing.</p>`;
                    return;
                }

                const newsToSummarize = newsData.slice(0, 10);

                if (newsToSummarize.length < 3) {
                    container.innerHTML = `<h3>${exchange.toUpperCase()} News Summary</h3><p class="text-gray-500">Not enough recent news to summarize.</p>`;
                    return;
                }

                const articlesText = newsToSummarize.map(n => `- ${n.newsTitle} (Source: ${n.newsURL})`).join('\n');
                const prompt = `
                    Act as an expert financial analyst. I will provide you with a list of recent news headlines and their URLs for the ${exchange.toUpperCase()} stock exchange from the last 30 days.
                    Based on the content likely found at these URLs, provide a concise 3-4 sentence summary of the key themes, overall market sentiment (e.g., bullish, bearish, mixed), and any significant price target updates.
                    Synthesize the information into a professional, easy-to-read analysis.

                    NEWS ARTICLES:
                    ${articlesText}
                `;

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${appConfig.geminiApiKey}`;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error("Gemini API Error:", errorBody);
                        throw new Error(`Gemini API request failed: ${response.status}`);
                    }
                    const result = await response.json();
                    const summary = result.candidates[0].content.parts[0].text;
                    
                    appConfig.currentSummaries[exchange] = summary;
                    container.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h3 class="text-lg font-bold text-indigo-600 mb-2">${exchange.toUpperCase()} News Summary</h3>
                            <button id="save-${exchange}-summary" class="save-summary-btn text-sm bg-green-100 text-green-700 hover:bg-green-200 rounded-md px-3 py-1">
                                <i class="fas fa-save mr-2"></i>Save Summary
                            </button>
                        </div>
                        <p class="text-gray-600 mt-2">${summary.replace(/\n/g, '<br>')}</p>
                    `;
                    document.getElementById(`save-${exchange}-summary`).addEventListener('click', () => {
                        saveSummaryToFirebase(exchange);
                    });

                } catch (error) {
                    console.error(`Error summarizing news for ${exchange}:`, error);
                    container.innerHTML = `<h3>${exchange.toUpperCase()} News Summary</h3><p class="text-red-500">Could not generate summary.</p>`;
                }
            }
            
            // --- 13. CRUD Functions for Summaries ---
            function setupCrudModalListeners() {
                manageSummariesBtn.addEventListener('click', async () => {
                    summaryCrudModal.style.display = 'flex';
                    await loadSummariesForCrud();
                });
                crudModalOverlay.addEventListener('click', () => {
                    summaryCrudModal.style.display = 'none';
                    editSummaryFormContainer.classList.add('hidden');
                });
                cancelEditBtn.addEventListener('click', () => {
                    editSummaryFormContainer.classList.add('hidden');
                });
                savedSummariesList.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    const summaryId = target.dataset.id;
                    const exchange = target.dataset.exchange;

                    if (target.classList.contains('edit-btn')) {
                        handleEditClick(summaryId, exchange);
                    } else if (target.classList.contains('delete-btn')) {
                        handleDeleteClick(summaryId, exchange);
                    }
                });
                editSummaryForm.addEventListener('submit', handleUpdateSubmit);
            }

            async function saveSummaryToFirebase(exchange) {
                if (!db) return alert("Firebase not initialized.");
                const summaryText = appConfig.currentSummaries[exchange];
                if (!summaryText) return alert("No summary to save.");

                const summaryData = {
                    text: summaryText,
                    timestamp: new Date().toISOString()
                };

                try {
                    await db.ref(`summaries/${exchange}`).push(summaryData);
                    alert(`${exchange.toUpperCase()} summary saved successfully!`);
                } catch (error) {
                    console.error("Error saving summary:", error);
                    alert("Failed to save summary.");
                }
            }
            
            async function loadSummariesForCrud() {
                if (!db) return;
                savedSummariesList.innerHTML = '<p>Loading saved summaries...</p>';
                try {
                    const snapshot = await db.ref('summaries').get();
                    if (!snapshot.exists()) {
                        savedSummariesList.innerHTML = '<p>No summaries have been saved yet.</p>';
                        return;
                    }
                    const allSummaries = snapshot.val();
                    let html = '';
                    for (const exchange in allSummaries) {
                        html += `<h3 class="text-xl font-bold mt-4 mb-2 text-gray-700">${exchange.toUpperCase()}</h3>`;
                        const summaries = allSummaries[exchange];
                        for (const id in summaries) {
                            const summary = summaries[id];
                            html += `
                                <div class="bg-gray-50 p-4 rounded-lg border">
                                    <p class="text-sm text-gray-500 mb-2">Saved on: ${new Date(summary.timestamp).toLocaleString()}</p>
                                    <p class="text-gray-800">${summary.text.replace(/\n/g, '<br>')}</p>
                                    <div class="flex justify-end space-x-2 mt-3">
                                        <button data-id="${id}" data-exchange="${exchange}" class="edit-btn text-sm text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i> Edit</button>
                                        <button data-id="${id}" data-exchange="${exchange}" class="delete-btn text-sm text-red-600 hover:text-red-800"><i class="fas fa-trash"></i> Delete</button>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    savedSummariesList.innerHTML = html || '<p>No summaries have been saved yet.</p>';
                } catch (error) {
                    console.error("Error loading summaries for CRUD:", error);
                    savedSummariesList.innerHTML = '<p class="text-red-500">Could not load summaries.</p>';
                }
            }

            async function handleEditClick(summaryId, exchange) {
                const snapshot = await db.ref(`summaries/${exchange}/${summaryId}`).get();
                if (snapshot.exists()) {
                    const summary = snapshot.val();
                    document.getElementById('editSummaryId').value = summaryId;
                    document.getElementById('editSummaryExchange').value = exchange;
                    document.getElementById('editSummaryText').value = summary.text;
                    editSummaryFormContainer.classList.remove('hidden');
                }
            }

            async function handleDeleteClick(summaryId, exchange) {
                if (confirm('Are you sure you want to delete this summary?')) {
                    try {
                        await db.ref(`summaries/${exchange}/${summaryId}`).remove();
                        await loadSummariesForCrud(); // Refresh the list
                    } catch (error) {
                        console.error("Error deleting summary:", error);
                        alert("Failed to delete summary.");
                    }
                }
            }

            async function handleUpdateSubmit(e) {
                e.preventDefault();
                const summaryId = document.getElementById('editSummaryId').value;
                const exchange = document.getElementById('editSummaryExchange').value;
                const newText = document.getElementById('editSummaryText').value;

                try {
                    await db.ref(`summaries/${exchange}/${summaryId}/text`).set(newText);
                    editSummaryFormContainer.classList.add('hidden');
                    await loadSummariesForCrud(); // Refresh the list
                } catch (error) {
                    console.error("Error updating summary:", error);
                    alert("Failed to update summary.");
                }
            }


            // --- 14. Rendering Functions ---
            const formatText = (text) => text || 'N/A';
            const formatMarketCap = (num) => {
                if (!num) return 'N/A';
                if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
                if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
                return num.toLocaleString();
            };

            function renderStockTable(data, container) {
                if (!data || data.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">No stock data found.</p>';
                    return;
                }
                const tableRows = data.map(stock => `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-indigo-600">${formatText(stock.symbol)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${formatText(stock.companyName)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-right">${formatMarketCap(stock.marketCap)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatText(stock.sector)}</td>
                    </tr>`).join('');
                container.innerHTML = `<div class="overflow-x-auto max-h-96"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50 sticky top-0"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Symbol</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Company</th><th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Market Cap</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sector</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody></table></div>`;
            }

            function renderStockCards(data, container, exchange) {
                if (!data || data.length === 0) {
                    container.innerHTML = ''; return;
                }
                const grouped = data.reduce((acc, stock) => {
                    const sector = stock.sector || 'Unclassified';
                    const industry = stock.industry || 'Unclassified';
                    acc[sector] = acc[sector] || {};
                    acc[sector][industry] = acc[sector][industry] || [];
                    acc[sector][industry].push(stock);
                    return acc;
                }, {});

                let html = `<h3 class="text-xl font-bold mb-4 text-gray-700">${exchange.toUpperCase()} Stocks by Sector</h3>`;
                for (const sector in grouped) {
                    html += `<div class="mb-6"><h4 class="text-lg font-semibold text-indigo-700 p-2 bg-indigo-50 rounded-md">${sector}</h4>`;
                    for (const industry in grouped[sector]) {
                        html += `<div class="mt-4"><h5 class="text-md font-medium text-gray-600 mb-3 ml-2">${industry}</h5><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">`;
                        grouped[sector][industry].forEach(stock => {
                            html += `<div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
                                        <div class="flex justify-between items-baseline mb-1">
                                            <p class="font-bold text-sm text-indigo-600 truncate pr-2">${formatText(stock.symbol)}</p>
                                            <p class="text-xs font-semibold text-gray-700 whitespace-nowrap">${formatMarketCap(stock.marketCap)}</p>
                                        </div>
                                        <p class="text-xs text-gray-500">${formatText(stock.companyName)}</p>
                                    </div>`;
                        });
                        html += `</div></div>`;
                    }
                    html += `</div>`;
                }
                container.innerHTML = html;
            }

            function renderNewsCards(newsData, container) {
                if (!newsData || newsData.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 p-4">No recent price target news found for the selected stocks in this exchange for the last 30 days. Click "Refresh News" to fetch the latest.</p>';
                    return;
                }
                const newsHtml = newsData.map(news => `
                    <a href="${news.newsURL}" target="_blank" rel="noopener noreferrer" class="block bg-gray-50 p-4 rounded-lg shadow-sm hover:bg-gray-100 transition-colors">
                        <div class="flex justify-between items-start mb-1">
                            <p class="font-bold text-indigo-600">${formatText(news.symbol)}</p>
                            <p class="text-xs text-gray-500">${new Date(news.publishedDate).toLocaleDateString()}</p>
                        </div>
                        <h4 class="font-semibold text-gray-800">${formatText(news.newsTitle)}</h4>
                        <div class="text-xs text-gray-500 flex flex-wrap gap-x-4 gap-y-1 mt-2">
                            <span><strong>Publisher:</strong> ${formatText(news.newsPublisher)}</span>
                            <span><strong>Analyst:</strong> ${formatText(news.analystName) || 'N/A'} @ ${formatText(news.analystCompany)}</span>
                            <span><strong>Posted Price:</strong> ${news.priceWhenPosted ? '$'+news.priceWhenPosted.toFixed(2) : 'N/A'}</span>
                            <span><strong>Target Price:</strong> ${news.priceTarget ? '$'+news.priceTarget.toFixed(2) : 'N/A'}</span>
                        </div>
                    </a>
                `).join('');
                container.innerHTML = newsHtml;
            }

            // --- Run the initialization function ---
            initialize();
        });
    </script>

</body>
</html>
