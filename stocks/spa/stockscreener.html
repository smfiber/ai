<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magickal SPA</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for the modal to be hidden by default */
        .modal {
            display: none;
        }
        /* Styles for accordion transition */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        /* Hide tab content by default */
        .tab-content {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Application Content -->
    <div id="appContent" class="p-4 md:p-8">
        <h1 class="text-3xl md:text-4xl font-bold text-indigo-600 text-center mb-8">Magickal SPA Dashboard</h1>
        
        <!-- Tab Navigation -->
        <div class="max-w-6xl mx-auto mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button id="ai-tab-button" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        AI Analysis
                    </button>
                    <button id="screener-tab-button" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Stock Screener
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab Content Area -->
        <div class="max-w-6xl mx-auto">
            <!-- AI Analysis Tab -->
            <div id="ai-tab-content" class="tab-content">
                <div class="bg-white p-8 rounded-xl shadow-md text-center">
                    <h2 class="text-2xl font-bold text-gray-800">AI Analysis</h2>
                    <p class="mt-2 text-gray-500">This section is under construction. AI-powered insights will be available here soon!</p>
                </div>
            </div>

            <!-- Stock Screener Tab -->
            <div id="screener-tab-content" class="tab-content">
                <div class="space-y-4">
                    <!-- Accordion for NASDAQ Stock Screener -->
                    <div id="nasdaqScreenerAccordion" class="bg-white rounded-xl shadow-md">
                        <button id="nasdaq-accordion-button" class="w-full flex justify-between items-center p-5 text-left font-semibold text-lg hover:bg-gray-50 rounded-t-xl focus:outline-none">
                            <span>Stock Screener Table: NASDAQ (Market Cap > $1B)</span>
                            <svg id="nasdaq-accordion-icon" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="nasdaq-accordion-content" class="accordion-content px-5 pb-5">
                            <div id="nasdaq-screener-data-container" class="mt-4 border-t pt-4">
                                <p class="text-gray-500">Loading stock data...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Accordion for NYSE Stock Screener -->
                    <div id="nyseScreenerAccordion" class="bg-white rounded-xl shadow-md">
                        <button id="nyse-accordion-button" class="w-full flex justify-between items-center p-5 text-left font-semibold text-lg hover:bg-gray-50 rounded-t-xl focus:outline-none">
                            <span>Stock Screener Table: NYSE (Market Cap > $1B)</span>
                            <svg id="nyse-accordion-icon" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="nyse-accordion-content" class="accordion-content px-5 pb-5">
                            <div id="nyse-screener-data-container" class="mt-4 border-t pt-4">
                                <p class="text-gray-500">Loading stock data...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Accordion for AMEX Stock Screener -->
                    <div id="amexScreenerAccordion" class="bg-white rounded-xl shadow-md">
                        <button id="amex-accordion-button" class="w-full flex justify-between items-center p-5 text-left font-semibold text-lg hover:bg-gray-50 rounded-t-xl focus:outline-none">
                            <span>Stock Screener Table: AMEX (Market Cap > $1B)</span>
                            <svg id="amex-accordion-icon" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="amex-accordion-content" class="accordion-content px-5 pb-5">
                            <div id="amex-screener-data-container" class="mt-4 border-t pt-4">
                                <p class="text-gray-500">Loading stock data...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card View Section -->
                <div class="mt-12">
                    <h2 class="text-2xl font-bold text-center mb-6">Stock Card View by Sector & Industry</h2>
                    <div id="nasdaq-card-view" class="mb-8"></div>
                    <div id="nyse-card-view" class="mb-8"></div>
                    <div id="amex-card-view" class="mb-8"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 modal">
        <!-- Modal Backdrop -->
        <div class="absolute inset-0 bg-gray-900 bg-opacity-75"></div>
        <!-- Modal Content -->
        <div class="relative bg-white rounded-2xl shadow-lg border border-gray-200 p-8 w-full max-w-lg m-4 overflow-y-auto max-h-[90vh]">
            <h2 class="text-2xl font-bold mb-4">API Keys Required</h2>
            <p class="text-gray-500 mb-6">Please provide your API keys to get started. These are required for the application to function.</p>
            <form id="apiKeyForm">
                <div class="space-y-4">
                    <div>
                        <label for="geminiApiKeyInput" class="block text-sm font-semibold text-gray-800 mb-1">Google Gemini API Key</label>
                        <input type="password" id="geminiApiKeyInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your Google Gemini API Key">
                    </div>
                    <div>
                        <label for="googleClientIdInput" class="block text-sm font-semibold text-gray-800 mb-1">Google Cloud Client ID</label>
                        <input type="password" id="googleClientIdInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your Google Cloud Web Client ID">
                    </div>
                    <div>
                        <label for="webSearchApiKeyInput" class="block text-sm font-semibold text-gray-800 mb-1">Web Search API Key (Google)</label>
                        <input type="password" id="webSearchApiKeyInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your Google Cloud API Key">
                    </div>
                    <div>
                        <label for="searchEngineIdInput" class="block text-sm font-semibold text-gray-800 mb-1">Search Engine ID (cx value)</label>
                        <input type="text" id="searchEngineIdInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your Custom Search Engine ID">
                    </div>
                    <div>
                        <label for="fmpApiKeyInput" class="block text-sm font-semibold text-gray-800 mb-1">Financial Modeling Prep API Key</label>
                        <input type="password" id="fmpApiKeyInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your FMP API Key">
                    </div>
                    <div>
                        <label for="firebaseConfigInput" class="block text-sm font-semibold text-gray-800 mb-1">Firebase Web App Config</label>
                        <textarea id="firebaseConfigInput" class="border border-gray-300 rounded-lg w-full p-2 font-mono text-xs" rows="6" placeholder="Paste your Firebase Web App Config Object"></textarea>
                    </div>
                </div>
                <p id="api-key-error" class="text-red-500 text-sm mt-4 h-5"></p>
                <div class="mt-6 flex justify-end">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition-colors">Save and Continue</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // --- 1. Global Configuration Object ---
            const appConfig = {
                fmpApiKey: "",
                geminiApiKey: "",
                searchApiKey: "",
                searchEngineId: "",
                googleClientId: "",
                firebaseConfig: {}
            };

            // --- 2. DOM Element Selection ---
            const apiKeyModal = document.getElementById('apiKeyModal');
            const apiKeyForm = document.getElementById('apiKeyForm');
            const errorMessage = document.getElementById('api-key-error');

            // Input Fields
            const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
            const googleClientIdInput = document.getElementById('googleClientIdInput');
            const webSearchApiKeyInput = document.getElementById('webSearchApiKeyInput');
            const searchEngineIdInput = document.getElementById('searchEngineIdInput');
            const fmpApiKeyInput = document.getElementById('fmpApiKeyInput');
            const firebaseConfigInput = document.getElementById('firebaseConfigInput');

            // Tab Elements
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            // --- 3. Initialization Logic ---
            function initialize() {
                const savedKeys = localStorage.getItem('magickalApiKeys');
                if (savedKeys) {
                    const parsedKeys = JSON.parse(savedKeys);
                    Object.assign(appConfig, parsedKeys);
                    hideModal();
                    startApp();
                } else {
                    showModal();
                }
            }

            // --- 4. Form Submission Handler ---
            apiKeyForm.addEventListener('submit', (event) => {
                event.preventDefault();
                errorMessage.textContent = '';

                const formValues = {
                    geminiApiKey: geminiApiKeyInput.value.trim(),
                    googleClientId: googleClientIdInput.value.trim(),
                    searchApiKey: webSearchApiKeyInput.value.trim(),
                    searchEngineId: searchEngineIdInput.value.trim(),
                    fmpApiKey: fmpApiKeyInput.value.trim(),
                    firebaseConfigString: firebaseConfigInput.value.trim()
                };
                
                if (Object.values(formValues).some(value => value === '')) {
                    errorMessage.textContent = 'All fields are required.';
                    return;
                }

                let parsedFirebaseConfig;
                try {
                    parsedFirebaseConfig = JSON.parse(formValues.firebaseConfigString);
                } catch (error) {
                    errorMessage.textContent = 'The Firebase Web App Config is not a valid JSON object.';
                    return;
                }

                Object.assign(appConfig, {
                    geminiApiKey: formValues.geminiApiKey,
                    googleClientId: formValues.googleClientId,
                    searchApiKey: formValues.searchApiKey,
                    searchEngineId: formValues.searchEngineId,
                    fmpApiKey: formValues.fmpApiKey,
                    firebaseConfig: parsedFirebaseConfig
                });

                try {
                    localStorage.setItem('magickalApiKeys', JSON.stringify(appConfig));
                    hideModal();
                    startApp();
                } catch (error) {
                    errorMessage.textContent = 'Could not save keys to local storage.';
                }
            });

            // --- 5. Modal Utility Functions ---
            function showModal() { apiKeyModal.style.display = 'flex'; }
            function hideModal() { apiKeyModal.style.display = 'none'; }
            
            // --- 6. Main Application Logic ---
            function startApp() {
                console.log("Application starting with loaded configuration.");
                setupTabs();
                initAccordion('nasdaq');
                initAccordion('nyse');
                initAccordion('amex');
            }

            // --- 7. Tab Setup ---
            function setupTabs() {
                const aiTabButton = document.getElementById('ai-tab-button');
                const screenerTabButton = document.getElementById('screener-tab-button');
                const aiTabContent = document.getElementById('ai-tab-content');
                const screenerTabContent = document.getElementById('screener-tab-content');

                const setActiveTab = (activeButton, activeContent) => {
                    // Reset all buttons
                    tabButtons.forEach(button => {
                        button.classList.remove('border-indigo-500', 'text-indigo-600');
                        button.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    });
                    // Reset all content
                    tabContents.forEach(content => {
                        content.style.display = 'none';
                    });

                    // Set active button
                    activeButton.classList.add('border-indigo-500', 'text-indigo-600');
                    activeButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    
                    // Set active content
                    activeContent.style.display = 'block';
                };

                aiTabButton.addEventListener('click', () => setActiveTab(aiTabButton, aiTabContent));
                screenerTabButton.addEventListener('click', () => setActiveTab(screenerTabButton, screenerTabContent));

                // Set initial tab
                setActiveTab(aiTabButton, aiTabContent);
            }

            // --- 8. Accordion Initialization ---
            function initAccordion(exchange) {
                const button = document.getElementById(`${exchange}-accordion-button`);
                const content = document.getElementById(`${exchange}-accordion-content`);
                const icon = document.getElementById(`${exchange}-accordion-icon`);
                const tableContainer = document.getElementById(`${exchange}-screener-data-container`);
                const cardContainer = document.getElementById(`${exchange}-card-view`);
                const exchangeUpperCase = exchange.toUpperCase();

                setupAccordionToggle(button, content, icon);
                fetchStockScreener(exchangeUpperCase, tableContainer, cardContainer);
            }

            // --- 9. Accordion Toggle Logic ---
            function setupAccordionToggle(button, content, icon) {
                button.addEventListener('click', () => {
                    const isOpen = content.style.maxHeight && content.style.maxHeight !== "0px";
                    if (isOpen) {
                        content.style.maxHeight = "0px";
                        icon.style.transform = "rotate(0deg)";
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                        icon.style.transform = "rotate(180deg)";
                    }
                });
            }

            // --- 10. Fetch Stock Screener Data ---
            async function fetchStockScreener(exchange, tableContainerElement, cardContainerElement) {
                tableContainerElement.innerHTML = `<p class="text-gray-500">Loading stock data for ${exchange}...</p>`;
                cardContainerElement.innerHTML = `<p class="text-gray-500">Loading card data for ${exchange}...</p>`;
                const apiKey = appConfig.fmpApiKey;
                if (!apiKey) {
                    const errorMsg = '<p class="text-red-500">Financial Modeling Prep API Key is missing.</p>';
                    tableContainerElement.innerHTML = errorMsg;
                    cardContainerElement.innerHTML = errorMsg;
                    return;
                }

                const url = `https://financialmodelingprep.com/api/v3/stock-screener?marketCapMoreThan=1000000000&exchange=${exchange}&limit=1000&apikey=${apiKey}`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`API request for ${exchange} failed with status ${response.status}`);
                    }
                    const data = await response.json();
                    renderStockTable(data, tableContainerElement);
                    renderStockCards(data, cardContainerElement, exchange);
                } catch (error) {
                    console.error(`Error fetching stock data for ${exchange}:`, error);
                    const errorMsg = `<p class="text-red-500">Error fetching data for ${exchange}. Check the console and API key.</p>`;
                    tableContainerElement.innerHTML = errorMsg;
                    cardContainerElement.innerHTML = errorMsg;
                }
            }
            
            // --- 11. Shared Helper Functions for Rendering ---
            const formatPrice = (num) => num ? `$${num.toFixed(2)}` : 'N/A';
            const formatNumber = (num) => num ? num.toLocaleString() : 'N/A';
            const formatBeta = (num) => num ? num.toFixed(3) : 'N/A';
            const formatText = (text) => text || 'N/A';
            const formatMarketCap = (num) => {
                if (!num) return 'N/A';
                if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
                if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
                if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
                return num.toLocaleString();
            };

            // --- 12. Render Stock Table ---
            function renderStockTable(data, containerElement) {
                if (!data || data.length === 0) {
                    containerElement.innerHTML = '<p class="text-gray-500">No stock data found for the specified criteria.</p>';
                    return;
                }

                const tableRows = data.map(stock => `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-indigo-600">${formatText(stock.symbol)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${formatText(stock.companyName)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-right">${formatPrice(stock.price)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-right">${formatNumber(stock.volume)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-right">${formatMarketCap(stock.marketCap)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatText(stock.sector)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-right">${formatBeta(stock.beta)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-center">${formatText(stock.country)}</td>
                    </tr>
                `).join('');

                containerElement.innerHTML = `
                    <div class="overflow-x-auto max-h-96">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company Name</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Volume</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Market Cap</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sector</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Beta</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Country</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                        </table>
                    </div>
                `;
            }

            // --- 13. Render Stock Cards ---
            function renderStockCards(data, containerElement, exchange) {
                if (!data || data.length === 0) {
                    containerElement.innerHTML = ''; // Clear loading message if no data
                    return;
                }

                // Group data by sector, then by industry
                const groupedData = data.reduce((acc, stock) => {
                    const sector = stock.sector || 'Unclassified';
                    const industry = stock.industry || 'Unclassified';
                    if (!acc[sector]) {
                        acc[sector] = {};
                    }
                    if (!acc[sector][industry]) {
                        acc[sector][industry] = [];
                    }
                    acc[sector][industry].push(stock);
                    return acc;
                }, {});

                let cardHtml = `<h3 class="text-xl font-bold mb-4 text-gray-700">${exchange.toUpperCase()} Stocks by Sector</h3>`;

                // Generate HTML for each sector and industry
                for (const sector in groupedData) {
                    cardHtml += `<div class="mb-6">
                                    <h4 class="text-lg font-semibold text-indigo-700 p-2 bg-indigo-50 rounded-md">${sector}</h4>`;
                    for (const industry in groupedData[sector]) {
                        cardHtml += `<div class="mt-4">
                                        <h5 class="text-md font-medium text-gray-600 mb-3 ml-2">${industry}</h5>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">`;
                        
                        groupedData[sector][industry].forEach(stock => {
                            cardHtml += `
                                <div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm flex flex-col justify-between">
                                    <div>
                                        <div class="flex justify-between items-baseline mb-1">
                                            <p class="font-bold text-sm text-indigo-600 truncate pr-2">${formatText(stock.symbol)}</p>
                                            <p class="text-xs font-semibold text-gray-700 whitespace-nowrap">${formatMarketCap(stock.marketCap)}</p>
                                        </div>
                                        <p class="text-xs text-gray-500">${formatText(stock.companyName)}</p>
                                    </div>
                                </div>`;
                        });

                        cardHtml += `</div></div>`;
                    }
                    cardHtml += `</div>`;
                }
                
                containerElement.innerHTML = cardHtml;
            }

            // --- Run the initialization function ---
            initialize();
        });
    </script>

</body>
</html>
