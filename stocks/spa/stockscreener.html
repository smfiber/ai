<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magickal Portfolio Oracle</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Apply the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for the modal to be hidden by default */
        .modal {
            display: none;
        }
        /* Styles for accordion transition */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        /* Hide tab content by default */
        .tab-content {
            display: none;
        }
        /* Styles for nested generative AI tabs */
        .gen-ai-tab-button {
            transition: all 0.3s ease;
        }
        .gen-ai-tab-content {
            display: none;
        }
        /* Custom scrollbar for nested tabs */
        .nested-tabs-container::-webkit-scrollbar {
            height: 4px;
        }
        .nested-tabs-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .nested-tabs-container::-webkit-scrollbar-thumb {
            background: #6366f1;
            border-radius: 10px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Application Content -->
    <div id="appContent" class="p-4 md:p-8">
        <h1 class="text-3xl md:text-4xl font-bold text-indigo-600 text-center mb-8">Magickal Portfolio Oracle</h1>
        
        <!-- Main Tab Navigation -->
        <div class="max-w-6xl mx-auto mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button id="gen-ai-tab-button" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Generative AI Analysis
                    </button>
                    <button id="screener-tab-button" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Stock Screener
                    </button>
                    <button id="news-tab-button" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Price Target News
                    </button>
                </nav>
            </div>
        </div>

        <!-- Main Tab Content Area -->
        <div class="max-w-6xl mx-auto">

            <!-- Generative AI Analysis Tab -->
            <div id="gen-ai-tab-content" class="tab-content">
                <!-- This will be populated by JS -->
            </div>

            <!-- Stock Screener Tab -->
            <div id="screener-tab-content" class="tab-content">
                <div class="space-y-4">
                    <!-- Accordions for Stock Screener Tables -->
                    <div id="nasdaqScreenerAccordion" class="bg-white rounded-xl shadow-md">
                        <button id="nasdaq-accordion-button" class="w-full flex justify-between items-center p-5 text-left font-semibold text-lg hover:bg-gray-50 rounded-t-xl focus:outline-none">
                            <span>Stock Screener Table: NASDAQ (Market Cap > $1B)</span>
                            <svg id="nasdaq-accordion-icon" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="nasdaq-accordion-content" class="accordion-content px-5 pb-5">
                            <div id="nasdaq-screener-data-container" class="mt-4 border-t pt-4"></div>
                        </div>
                    </div>
                    <div id="nyseScreenerAccordion" class="bg-white rounded-xl shadow-md">
                        <button id="nyse-accordion-button" class="w-full flex justify-between items-center p-5 text-left font-semibold text-lg hover:bg-gray-50 rounded-t-xl focus:outline-none">
                            <span>Stock Screener Table: NYSE (Market Cap > $1B)</span>
                            <svg id="nyse-accordion-icon" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="nyse-accordion-content" class="accordion-content px-5 pb-5">
                            <div id="nyse-screener-data-container" class="mt-4 border-t pt-4"></div>
                        </div>
                    </div>
                    <div id="amexScreenerAccordion" class="bg-white rounded-xl shadow-md">
                        <button id="amex-accordion-button" class="w-full flex justify-between items-center p-5 text-left font-semibold text-lg hover:bg-gray-50 rounded-t-xl focus:outline-none">
                            <span>Stock Screener Table: AMEX (Market Cap > $1B)</span>
                            <svg id="amex-accordion-icon" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="amex-accordion-content" class="accordion-content px-5 pb-5">
                            <div id="amex-screener-data-container" class="mt-4 border-t pt-4"></div>
                        </div>
                    </div>
                </div>

                <!-- Card View Section -->
                <div class="mt-12">
                    <h2 class="text-2xl font-bold text-center mb-6">Stock Card View by Sector & Industry</h2>
                    <div id="nasdaq-card-view" class="mb-8"></div>
                    <div id="nyse-card-view" class="mb-8"></div>
                    <div id="amex-card-view" class="mb-8"></div>
                </div>
            </div>

            <!-- Price Target News Tab -->
            <div id="news-tab-content" class="tab-content">
                <div class="space-y-4">
                    <!-- NASDAQ News Accordion -->
                    <div class="bg-white rounded-xl shadow-md">
                        <div id="nasdaq-news-accordion-button" class="w-full flex justify-between items-center p-5 text-left font-semibold text-lg hover:bg-gray-50 rounded-xl focus:outline-none cursor-pointer">
                            <span>NASDAQ Price Target News</span>
                            <div class="flex items-center">
                                <button id="refresh-nasdaq-news" class="text-sm bg-indigo-100 text-indigo-700 hover:bg-indigo-200 rounded-md px-3 py-1 mr-4">Refresh News</button>
                                <svg id="nasdaq-news-accordion-icon" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                        <div id="nasdaq-news-accordion-content" class="accordion-content px-5 pb-5">
                            <div id="nasdaq-news-container" class="mt-4 border-t pt-4 space-y-4"></div>
                        </div>
                    </div>
                    <!-- NYSE News Accordion -->
                    <div class="bg-white rounded-xl shadow-md">
                        <div id="nyse-news-accordion-button" class="w-full flex justify-between items-center p-5 text-left font-semibold text-lg hover:bg-gray-50 rounded-xl focus:outline-none cursor-pointer">
                            <span>NYSE Price Target News</span>
                            <div class="flex items-center">
                                <button id="refresh-nyse-news" class="text-sm bg-indigo-100 text-indigo-700 hover:bg-indigo-200 rounded-md px-3 py-1 mr-4">Refresh News</button>
                                <svg id="nyse-news-accordion-icon" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                        <div id="nyse-news-accordion-content" class="accordion-content px-5 pb-5">
                            <div id="nyse-news-container" class="mt-4 border-t pt-4 space-y-4"></div>
                        </div>
                    </div>
                    <!-- AMEX News Accordion -->
                    <div class="bg-white rounded-xl shadow-md">
                        <div id="amex-news-accordion-button" class="w-full flex justify-between items-center p-5 text-left font-semibold text-lg hover:bg-gray-50 rounded-xl focus:outline-none cursor-pointer">
                            <span>AMEX Price Target News</span>
                            <div class="flex items-center">
                                <button id="refresh-amex-news" class="text-sm bg-indigo-100 text-indigo-700 hover:bg-indigo-200 rounded-md px-3 py-1 mr-4">Refresh News</button>
                                <svg id="amex-news-accordion-icon" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                        <div id="amex-news-accordion-content" class="accordion-content px-5 pb-5">
                            <div id="amex-news-container" class="mt-4 border-t pt-4 space-y-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 z-[100] items-center justify-center p-4 modal">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-75"></div>
        <div class="relative bg-white rounded-2xl shadow-lg border border-gray-200 p-8 w-full max-w-lg m-4 overflow-y-auto max-h-[90vh]">
            <h2 class="text-2xl font-bold mb-4">API Keys Required</h2>
            <p class="text-gray-500 mb-6">Please provide your API keys to get started.</p>
            <form id="apiKeyForm">
                <div class="space-y-4">
                    <div>
                        <label for="geminiApiKeyInput" class="block text-sm font-semibold text-gray-800 mb-1">Google Gemini API Key</label>
                        <input type="password" id="geminiApiKeyInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your Google Gemini API Key">
                    </div>
                    <div>
                        <label for="googleClientIdInput" class="block text-sm font-semibold text-gray-800 mb-1">Google Cloud Client ID</label>
                        <input type="password" id="googleClientIdInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your Google Cloud Web Client ID">
                    </div>
                    <div>
                        <label for="webSearchApiKeyInput" class="block text-sm font-semibold text-gray-800 mb-1">Web Search API Key (Google)</label>
                        <input type="password" id="webSearchApiKeyInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your Google Cloud API Key">
                    </div>
                    <div>
                        <label for="searchEngineIdInput" class="block text-sm font-semibold text-gray-800 mb-1">Search Engine ID (cx value)</label>
                        <input type="text" id="searchEngineIdInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your Custom Search Engine ID">
                    </div>
                    <div>
                        <label for="fmpApiKeyInput" class="block text-sm font-semibold text-gray-800 mb-1">Financial Modeling Prep API Key</label>
                        <input type="password" id="fmpApiKeyInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your FMP API Key">
                    </div>
                    <div>
                        <label for="firebaseConfigInput" class="block text-sm font-semibold text-gray-800 mb-1">Firebase Web App Config</label>
                        <textarea id="firebaseConfigInput" class="border border-gray-300 rounded-lg w-full p-2 font-mono text-xs" rows="6" placeholder="Paste your Firebase Web App Config Object"></textarea>
                    </div>
                </div>
                <p id="api-key-error" class="text-red-500 text-sm mt-4 h-5"></p>
                <div class="mt-6 flex justify-end">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition-colors">Save and Continue</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Floating Action Button for CRUD -->
    <button id="manageSummariesBtn" class="fixed bottom-8 right-8 bg-indigo-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-indigo-700 transition-transform transform hover:scale-110 focus:outline-none">
        <i class="fas fa-archive fa-lg"></i>
    </button>

    <!-- CRUD Modal for Summaries -->
    <div id="summaryCrudModal" class="fixed inset-0 z-[100] items-center justify-center p-4 modal">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-75" id="crudModalOverlay"></div>
        <div class="relative bg-white rounded-2xl shadow-lg border border-gray-200 p-8 w-full max-w-4xl m-4 overflow-y-auto max-h-[90vh]">
            <h2 class="text-2xl font-bold mb-6">Manage Saved Analyses</h2>
            
            <!-- Container for the list of saved summaries -->
            <div id="savedSummariesList" class="space-y-4">
                <!-- Summaries will be dynamically inserted here -->
            </div>

            <!-- Hidden Edit Form -->
            <div id="editSummaryFormContainer" class="hidden mt-8 p-6 bg-gray-50 rounded-lg">
                <h3 class="text-xl font-bold mb-4">Edit Analysis</h3>
                <form id="editSummaryForm">
                    <input type="hidden" id="editAnalysisId">
                    <input type="hidden" id="editAnalysisExchange">
                    <input type="hidden" id="editAnalysisType">
                    <textarea id="editAnalysisText" class="w-full p-2 border border-gray-300 rounded-lg" rows="10"></textarea>
                    <div class="mt-4 flex justify-end space-x-3">
                        <button type="button" id="cancelEditBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancel</button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-database-compat.js"></script>

    <script>
        // Version 4.3
        document.addEventListener("DOMContentLoaded", () => {
            // --- 1. Global Configuration Object ---
            const appConfig = {
                fmpApiKey: "",
                geminiApiKey: "",
                searchApiKey: "",
                searchEngineId: "",
                googleClientId: "",
                firebaseConfig: {},
                generativeAnalyses: {} // Holds the latest generated analysis text
            };
            
            let db = null;

            // --- Utility to pause execution ---
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            // --- 2. DOM Element Selection ---
            const apiKeyModal = document.getElementById('apiKeyModal');
            const apiKeyForm = document.getElementById('apiKeyForm');
            const errorMessage = document.getElementById('api-key-error');
            const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
            const googleClientIdInput = document.getElementById('googleClientIdInput');
            const webSearchApiKeyInput = document.getElementById('webSearchApiKeyInput');
            const searchEngineIdInput = document.getElementById('searchEngineIdInput');
            const fmpApiKeyInput = document.getElementById('fmpApiKeyInput');
            const firebaseConfigInput = document.getElementById('firebaseConfigInput');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const manageSummariesBtn = document.getElementById('manageSummariesBtn');
            const summaryCrudModal = document.getElementById('summaryCrudModal');
            const crudModalOverlay = document.getElementById('crudModalOverlay');
            const savedSummariesList = document.getElementById('savedSummariesList');
            const editSummaryFormContainer = document.getElementById('editSummaryFormContainer');
            const editSummaryForm = document.getElementById('editSummaryForm');
            const cancelEditBtn = document.getElementById('cancelEditBtn');


            // --- 3. Initialization Logic ---
            function initialize() {
                showModal();
            }

            // --- 4. Form Submission Handler ---
            apiKeyForm.addEventListener('submit', (event) => {
                event.preventDefault();
                errorMessage.textContent = '';
                const formValues = {
                    geminiApiKey: geminiApiKeyInput.value.trim(),
                    googleClientId: googleClientIdInput.value.trim(),
                    searchApiKey: webSearchApiKeyInput.value.trim(),
                    searchEngineId: searchEngineIdInput.value.trim(),
                    fmpApiKey: fmpApiKeyInput.value.trim(),
                    firebaseConfigString: firebaseConfigInput.value.trim()
                };
                if (Object.values(formValues).some(value => value === '')) {
                    errorMessage.textContent = 'All fields are required.';
                    return;
                }
                try {
                    const parsedFirebaseConfig = JSON.parse(formValues.firebaseConfigString);
                    if (!parsedFirebaseConfig.databaseURL) {
                        errorMessage.textContent = 'Firebase Config must include a "databaseURL" property.';
                        return;
                    }
                    Object.assign(appConfig, { ...formValues, firebaseConfig: parsedFirebaseConfig });
                    hideModal();
                    startApp();
                } catch (error) {
                    errorMessage.textContent = 'Invalid Firebase Config JSON.';
                }
            });

            // --- 5. Modal & Tab Utility Functions ---
            function showModal() { apiKeyModal.style.display = 'flex'; }
            function hideModal() { apiKeyModal.style.display = 'none'; }
            
            function setupTabs() {
                const tabMap = {
                    'gen-ai-tab-button': 'gen-ai-tab-content',
                    'screener-tab-button': 'screener-tab-content',
                    'news-tab-button': 'news-tab-content'
                };

                const setActiveTab = (activeButtonId) => {
                    tabButtons.forEach(button => {
                        const isActive = button.id === activeButtonId;
                        button.classList.toggle('border-indigo-500', isActive);
                        button.classList.toggle('text-indigo-600', isActive);
                        button.classList.toggle('border-transparent', !isActive);
                        button.classList.toggle('text-gray-500', !isActive);
                    });
                    Object.values(tabMap).forEach(contentId => {
                        const contentEl = document.getElementById(contentId);
                        if (contentEl) {
                           contentEl.style.display = (tabMap[activeButtonId] === contentId) ? 'block' : 'none';
                        }
                    });
                };

                tabButtons.forEach(button => {
                    button.addEventListener('click', () => setActiveTab(button.id));
                });
                
                setActiveTab('gen-ai-tab-button');
            }

            // --- 6. Main Application Logic ---
            async function startApp() {
                console.log("Application starting...");
                setupTabs();
                setupCrudModalListeners();
                
                try {
                    if (appConfig.firebaseConfig && appConfig.firebaseConfig.databaseURL) {
                        firebase.initializeApp(appConfig.firebaseConfig);
                        db = firebase.database();
                        console.log("Firebase initialized successfully.");
                    } else {
                        console.warn("Firebase config is missing or does not contain a databaseURL. Cannot initialize Firebase.");
                    }
                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    alert("Could not initialize Firebase. Please check your configuration.");
                }

                const exchanges = ['nasdaq', 'nyse', 'amex'];
                const genAiContainer = document.getElementById('gen-ai-tab-content');
                genAiContainer.innerHTML = exchanges.map(ex => `
                    <div id="${ex}-gen-ai-section" class="mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">${ex.toUpperCase()} Analysis</h2>
                        <div class="bg-white rounded-xl shadow-md p-4">
                            <div class="border-b border-gray-200 overflow-x-auto nested-tabs-container">
                                <nav id="${ex}-gen-ai-tabs-nav" class="-mb-px flex space-x-6" aria-label="Nested Tabs"></nav>
                            </div>
                            <div id="${ex}-gen-ai-tabs-content" class="mt-4"></div>
                        </div>
                    </div>
                `).join('');

                for (const exchange of exchanges) {
                    console.log(`Initializing components for ${exchange.toUpperCase()}...`);
                    await initExchangeData(exchange);
                    console.log(`Completed ${exchange.toUpperCase()}.`);
                }
                console.log("All data loaded.");
            }

            // --- 7. Data Initialization for Each Exchange ---
            async function initExchangeData(exchange) {
                const exchangeUpperCase = exchange.toUpperCase();
                // Screener Accordion
                const screenerAccordionButton = document.getElementById(`${exchange}-accordion-button`);
                const screenerAccordionContent = document.getElementById(`${exchange}-accordion-content`);
                const screenerAccordionIcon = document.getElementById(`${exchange}-accordion-icon`);
                // News Accordion
                const newsAccordionButton = document.getElementById(`${exchange}-news-accordion-button`);
                const newsAccordionContent = document.getElementById(`${exchange}-news-accordion-content`);
                const newsAccordionIcon = document.getElementById(`${exchange}-news-accordion-icon`);
                // Data Containers
                const tableContainer = document.getElementById(`${exchange}-screener-data-container`);
                const cardContainer = document.getElementById(`${exchange}-card-view`);
                const newsContainer = document.getElementById(`${exchange}-news-container`);
                const refreshButton = document.getElementById(`refresh-${exchange}-news`);

                setupAccordionToggle(screenerAccordionButton, screenerAccordionContent, screenerAccordionIcon);
                setupAccordionToggle(newsAccordionButton, newsAccordionContent, newsAccordionIcon);
                
                const screenerData = await fetchStockScreener(exchangeUpperCase, tableContainer, cardContainer);
                
                const loadedFromCache = await loadNewsFromFirebase(exchange, newsContainer, screenerData);
                if (!loadedFromCache) {
                    await fetchAndRenderPriceTargetNews(screenerData, newsContainer, exchange);
                }

                refreshButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    newsContainer.innerHTML = `<p class="text-indigo-500 font-semibold p-4">Refreshing news for ${exchangeUpperCase}...</p>`;
                    const genAiNav = document.getElementById(`${exchange}-gen-ai-tabs-nav`);
                    const genAiContent = document.getElementById(`${exchange}-gen-ai-tabs-content`);
                    if(genAiNav) genAiNav.innerHTML = '';
                    if(genAiContent) genAiContent.innerHTML = '';
                    fetchAndRenderPriceTargetNews(screenerData, newsContainer, exchange, true); // Force refresh
                });
            }

            // --- 8. Accordion Toggle Logic ---
            function setupAccordionToggle(button, content, icon) {
                if (!button) return;
                button.addEventListener('click', () => {
                    const isOpen = content.style.maxHeight && content.style.maxHeight !== "0px";
                    content.style.maxHeight = isOpen ? "0px" : content.scrollHeight + "px";
                    if(icon) icon.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
                });
            }

            // --- 9. Fetch Stock Screener Data ---
            async function fetchStockScreener(exchange, tableEl, cardEl) {
                const loadingMsg = `<p class="text-gray-500">Loading screener for ${exchange}...</p>`;
                if(tableEl) tableEl.innerHTML = loadingMsg;
                if(cardEl) cardEl.innerHTML = loadingMsg;

                if (!appConfig.fmpApiKey) {
                    const errorMsg = '<p class="text-red-500">Financial Modeling Prep API Key is missing.</p>';
                    if(tableEl) tableEl.innerHTML = errorMsg;
                    if(cardEl) cardEl.innerHTML = errorMsg;
                    return [];
                }

                const url = `https://financialmodelingprep.com/api/v3/stock-screener?marketCapMoreThan=1000000000&exchange=${exchange}&limit=1000&apikey=${appConfig.fmpApiKey}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                    const data = await response.json();
                    
                    renderStockTable(data, tableEl);
                    renderStockCards(data, cardEl, exchange);
                    return data;
                } catch (error) {
                    console.error(`Error fetching screener data for ${exchange}:`, error);
                    const errorMsg = `<p class="text-red-500">Error fetching data for ${exchange}.</p>`;
                     if(tableEl) tableEl.innerHTML = errorMsg;
                    if(cardEl) cardEl.innerHTML = errorMsg;
                    return [];
                }
            }
            
            // --- 10. Fetch and Render Price Target News ---
            async function fetchAndRenderPriceTargetNews(screenerData, newsContainer, exchange, forceGenAiRefresh = false) {
                const symbols = screenerData.map(stock => stock.symbol);

                if (symbols.length === 0) {
                    newsContainer.innerHTML = `<p class="text-gray-500">No stocks found to fetch news for.</p>`;
                    return;
                }

                let allNews = [];
                for (const [index, symbol] of symbols.entries()) {
                    try {
                        const url = `https://financialmodelingprep.com/stable/price-target-news?symbol=${symbol}&page=0&limit=10&apikey=${appConfig.fmpApiKey}`;
                        newsContainer.innerHTML = `<p class="text-gray-500 p-4">Fetching news for ${symbol} (${index + 1} of ${symbols.length})...<br><code class="text-xs text-indigo-500">${url}</code></p>`;
                        
                        const response = await fetch(url);

                        if (response.status === 429) {
                            console.error(`Rate limit exceeded when fetching news for ${symbol}. Stopping further requests.`);
                            newsContainer.innerHTML += `<p class="text-red-500 p-4 font-semibold">API rate limit reached. Please wait a moment and try refreshing again.</p>`;
                            break;
                        }

                        if(response.ok) {
                            const newsItems = await response.json();
                            if (newsItems && newsItems.length > 0) {
                                allNews.push(...newsItems);
                            }
                        } else {
                            console.warn(`Could not fetch news for ${symbol}: ${response.status} ${response.statusText}`);
                        }
                        await delay(600);
                    } catch (loopError) {
                        console.error(`An error occurred in the news fetching loop for ${symbol}:`, loopError);
                    }
                }

                let filteredNews = allNews.flat().filter(item => item && item.newsTitle && item.publishedDate && item.newsURL);

                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                filteredNews = filteredNews.filter(newsItem => {
                    const newsDate = new Date(newsItem.publishedDate);
                    return newsDate >= thirtyDaysAgo;
                });
                
                filteredNews.sort((a, b) => new Date(b.publishedDate) - new Date(a.publishedDate));

                renderNewsCards(filteredNews, newsContainer);
                await runGenerativeAnalyses(filteredNews, screenerData, exchange, forceGenAiRefresh);
                await saveNewsToFirebase(exchange, filteredNews);
            }
            
            // --- 11. Firebase Functions ---
            async function saveNewsToFirebase(exchange, newsData) {
                if (!db) return;
                try {
                    await db.ref(`news/${exchange}`).set(newsData);
                    console.log(`News for ${exchange.toUpperCase()} saved to Firebase.`);
                } catch (error) {
                    console.error(`Failed to save news for ${exchange} to Firebase:`, error);
                }
            }

            async function loadNewsFromFirebase(exchange, newsContainer, screenerData) {
                if (!db) return false;
                try {
                    const snapshot = await db.ref(`news/${exchange}`).get();
                    if (snapshot.exists()) {
                        const newsData = snapshot.val();
                        console.log(`Loaded news for ${exchange.toUpperCase()} from Firebase.`);
                        renderNewsCards(newsData, newsContainer);
                        await runGenerativeAnalyses(newsData, screenerData, exchange, false); // Don't force refresh on initial load
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error(`Failed to load news for ${exchange} from Firebase:`, error);
                    return false;
                }
            }
            
            async function autoSaveAnalysisToFirebase(exchange, analysisId, analysisData) {
                if (!db) return;
                try {
                    // Using set() to overwrite the previous cache for this specific analysis type
                    await db.ref(`analyses-cache/${exchange}/${analysisId}`).set(analysisData);
                    console.log(`Auto-saved analysis '${analysisId}' for ${exchange.toUpperCase()}.`);
                } catch (error) {
                    console.error(`Failed to auto-save analysis for ${exchange}:`, error);
                }
            }

            async function loadAnalysesFromCache(exchange) {
                if (!db) return null;
                try {
                    const snapshot = await db.ref(`analyses-cache/${exchange}`).get();
                    if (snapshot.exists()) {
                        console.log(`Loaded analyses from cache for ${exchange.toUpperCase()}.`);
                        return snapshot.val();
                    }
                    return null;
                } catch (error) {
                    console.error(`Failed to load analyses from cache for ${exchange}:`, error);
                    return null;
                }
            }


            // --- 12. Generative AI Analysis ---
            
            const analysisPrompts = [
                {
                    title: "Market Summary",
                    id: "market-summary",
                    prompt: (exchange, articlesText) => `
                        Act as an expert financial analyst. I will provide you with a list of recent news articles as JSON objects for the ${exchange.toUpperCase()} stock exchange from the last 30 days.
                        Your task is to synthesize this information into a concise market briefing.

                        Please structure your analysis into three parts:
                        1.  **Key Themes:** In bullet points, identify 2-3 dominant themes or narratives driving analyst commentary (e.g., AI investment, inflation concerns, specific sector strength).
                        2.  **Overall Sentiment:** State the prevailing market sentiment (e.g., Bullish ðŸ‚, Bearish ðŸ», or Mixed/Neutral âš–ï¸) and provide a one-sentence justification based on the balance of positive versus negative analyst ratings.
                        3.  **Notable Movers:** Mention 1-2 companies that received particularly significant or frequent analyst attention.

                        Format your response using Markdown.

                        NEWS ARTICLES:
                        ${articlesText}`
                },
                {
                    title: "Battleground Stocks",
                    id: "battleground-stocks",
                    prompt: (exchange, articlesText) => `
                        Act as a quantitative financial analyst. Based on the provided news articles as JSON objects for the ${exchange.toUpperCase()} stock exchange, identify the top 2-3 "battleground stocks."
                        These are stocks with the widest disparity in analyst price targets, indicating significant debate about their future value.

                        For each identified battleground stock, provide:
                        -   **Stock Symbol:** The ticker symbol.
                        -   **Price Target Range:** The highest and lowest price target issued in the provided data.
                        -   **Analyst Disagreement:** A brief (1-2 sentence) summary of the likely reasons for the conflicting opinions, as inferred from the data.

                        Conclude with a sentence on what this level of disagreement implies for investors. Format using Markdown.

                        NEWS ARTICLES:
                        ${articlesText}`
                },
                {
                    title: "Top Upside",
                    id: "top-upside",
                    prompt: (exchange, articlesText) => `
                        Act as a financial analyst for a growth-focused fund. Your goal is to identify stocks with the highest potential upside based on recent analyst price targets from the ${exchange.toUpperCase()}. The news is provided as JSON objects.

                        Please perform the following:
                        1.  For each article containing a price target, calculate the potential upside using the formula: Upside % = (priceTarget - priceWhenPosted) / priceWhenPosted.
                        2.  Identify the top 5 stocks with the highest calculated potential upside.
                        3.  Present the results in a Markdown numbered list, including the **stock symbol**, the **highest price target**, the **analyst firm** that set it, and the **calculated upside percentage**.

                        NEWS ARTICLES:
                        ${articlesText}`
                },
                {
                    title: "Firm Views",
                    id: "firm-views",
                    prompt: (exchange, articlesText) => `
                        Act as a financial markets strategist. I have provided a list of analyst actions as JSON objects on the ${exchange.toUpperCase()} stock exchange.
                        Your task is to analyze the "house view" of the most active analyst firms.

                        1.  Identify the 3 firms (e.g., "Wolfe Research", "Goldman Sachs") with the highest number of published ratings in the dataset.
                        2.  For each of these top 3 firms, provide a 2-3 sentence summary of their overall stance.
                        3.  Note whether they appear generally bullish, bearish, or focused on a specific sector. Mention one stock they are particularly positive or negative on, if the data shows a clear example. Format using Markdown.

                        NEWS ARTICLES:
                        ${articlesText}`
                },
                {
                    title: "Single-Stock Deep Dive",
                    id: "single-stock-deep-dive",
                    prompt: (exchange, articlesText, symbol) => `
                        Act as a senior equity research analyst. I will provide you with all recent news articles (as JSON objects) concerning the stock symbol ${symbol.toUpperCase()} from the last 30 days.
                        Synthesize all the provided information into a professional "Deep Dive" summary.

                        Your summary must include:
                        -   **Analyst Consensus:** What is the general consensus (Buy, Hold, Sell)? What is the average or consensus price target from the data?
                        -   **Bull Case Summary:** Briefly summarize the key arguments from analysts with positive ratings or high price targets.
                        -   **Bear Case Summary:** Briefly summarize the key arguments or risks highlighted by analysts with more cautious ratings.
                        -   **Recent Timeline:** Note any recent upgrades, downgrades, or target changes in chronological order.

                        Format using Markdown.

                        NEWS ARTICLES for ${symbol.toUpperCase()}:
                        ${articlesText}`
                },
                {
                    title: "Sector Sentiment",
                    id: "sector-sentiment",
                    prompt: (exchange, articlesText) => `
                        Act as a macro-focused financial analyst. Using the provided news (as JSON objects) from the ${exchange.toUpperCase()}, perform a sector-level sentiment analysis.
                        You will need to infer the sector for each company (e.g., technology, healthcare, financials, consumer discretionary), likely from the company name or your own knowledge.

                        1.  Identify the 3 sectors that received the most news coverage in the dataset.
                        2.  For each of these top 3 sectors, assign a sentiment score (e.g., Positive, Negative, Neutral).
                        3.  Provide a 1-2 sentence justification for the assigned sentiment, referencing specific company examples or trends. Format using Markdown.

                        NEWS ARTICLES:
                        ${articlesText}`
                },
                {
                    title: "Upgrades/Downgrades",
                    id: "upgrades-downgrades",
                    prompt: (exchange, articlesText) => `
                        Act as an equity analyst. Your task is to track and summarize significant analyst rating changes from the provided news (as JSON objects) on the ${exchange.toUpperCase()}.
                        Scan all headlines for keywords indicating a change (e.g., "Upgrades," "Downgrades," "Initiates Coverage," "Lowers Rating").

                        Create two Markdown lists: **"Recent Upgrades"** and **"Recent Downgrades."**

                        For each entry in the lists, provide:
                        -   The stock symbol.
                        -   The analyst firm making the change.
                        -   A 1-sentence summary of the new rating and price target (e.g., "Upgraded to Outperform with a $120 price target.").

                        If there are no significant upgrades or downgrades, state that analyst sentiment appears stable.

                        NEWS ARTICLES:
                        ${articlesText}`
                },
                {
                    title: "Influential Analysts",
                    id: "influential-analysts",
                     prompt: (exchange, articlesText) => `
                        Act as a financial markets commentator. From the list of news articles (as JSON objects) for the ${exchange.toUpperCase()}, identify the most influential analysts in the past 30 days.

                        Your analysis should name the **Top 3 Most Active Analysts** based on the number of reports in the data.
                        For each of these three analysts, provide:
                        -   **Analyst Name and Firm:** e.g., "Akash Tewari (Wolfe Research)".
                        -   **General Stance:** A brief description of their recent activity (e.g., "Appears bullish on the biotech sector, reiterating multiple 'Outperform' ratings.").
                        -   **Highlight Call:** Mention their most optimistic or notable call from the dataset.
                        
                        Format using Markdown.

                        NEWS ARTICLES:
                        ${articlesText}`
                },
                {
                    title: "Target Revisions",
                    id: "target-revisions",
                    prompt: (exchange, articlesText) => `
                        Act as an equity analyst tracking sentiment momentum. From the provided news articles (as JSON objects) on the ${exchange.toUpperCase()}, identify stocks that have received multiple price target revisions within the last 30 days.

                        Your goal is to find companies where analyst sentiment is actively shifting.
                        Identify up to 3 companies with the most revisions and for each, describe the trend:
                        -   **Stock Symbol:** The ticker symbol.
                        -   **Trend Direction:** Is the consensus price target trending Upward, Downward, or is it Mixed?
                        -   **Summary of Revisions:** Briefly explain the changes. For example: "Morgan Stanley raised its target from $150 to $175, followed by Goldman Sachs increasing its target to $180, indicating a strengthening positive outlook."
                        
                        Format using Markdown.

                        NEWS ARTICLES:
                        ${articlesText}`
                },
                {
                    title: "New Coverage",
                    id: "new-coverage",
                    prompt: (exchange, articlesText) => `
                        Act as a special situations analyst. Your specific task is to scan the provided news (as JSON objects) from the ${exchange.toUpperCase()} and identify all instances of **new analyst coverage initiations.**

                        Filter for headlines containing keywords like "Initiates," "Starts," or "Begins Coverage."

                        Present your findings as a Markdown summary list. For each new coverage initiation, detail:
                        -   **Stock Symbol:** The company being covered.
                        -   **Analyst Firm:** The firm initiating coverage.
                        -   **Initial Rating:** The starting rating (e.g., Buy, Hold, Outperform).
                        -   **Initial Price Target:** The new price target assigned to the stock.

                        If no new coverage was initiated, simply state that.

                        NEWS ARTICLES:
                        ${articlesText}`
                }
            ];

            async function runGenerativeAnalyses(newsData, screenerData, exchange, forceRefresh = false) {
                if (!appConfig.geminiApiKey) {
                    console.error("Gemini API Key is missing. Cannot run generative analyses.");
                    return;
                }

                appConfig.generativeAnalyses[exchange] = {}; 
                const cachedAnalyses = forceRefresh ? null : await loadAnalysesFromCache(exchange);

                const navContainer = document.getElementById(`${exchange}-gen-ai-tabs-nav`);
                const contentContainer = document.getElementById(`${exchange}-gen-ai-tabs-content`);
                
                if(!navContainer || !contentContainer) return;

                navContainer.innerHTML = analysisPrompts.map((p, index) => `
                    <button id="${exchange}-${p.id}-tab" class="gen-ai-tab-button whitespace-nowrap py-3 px-4 text-sm font-medium rounded-t-lg ${index === 0 ? 'bg-indigo-50 text-indigo-700' : 'text-gray-500 hover:text-indigo-600 hover:bg-indigo-50'}">
                        ${p.title}
                    </button>
                `).join('');

                contentContainer.innerHTML = analysisPrompts.map((p, index) => `
                    <div id="${exchange}-${p.id}-content" class="gen-ai-tab-content p-4 border border-t-0 rounded-b-lg ${index === 0 ? 'block' : 'hidden'}">
                        <p class="text-gray-500">Loading analysis...</p>
                    </div>
                `).join('');

                setupGenerativeTabs(exchange);

                const articlesText = newsData.map(n => JSON.stringify(n)).join('\n');
                const singleStockSymbol = screenerData.length > 0 ? screenerData[0].symbol : null;

                for (const analysis of analysisPrompts) {
                    const container = document.getElementById(`${exchange}-${analysis.id}-content`);
                    const cached = cachedAnalyses ? cachedAnalyses[analysis.id] : null;

                    if (cached) {
                        console.log(`Using cached analysis for ${exchange} - ${analysis.title}`);
                        renderAnalysis(cached.text, container, exchange, analysis.id, analysis.title);
                        appConfig.generativeAnalyses[exchange][analysis.id] = cached.text; // Store for manual save
                        continue;
                    }
                    
                    console.log(`Generating analysis for ${exchange} - ${analysis.title}`);
                    let promptText;

                    if (analysis.id === 'single-stock-deep-dive') {
                        if (!singleStockSymbol) {
                            container.innerHTML = '<p class="text-gray-500">No stock available for a deep dive.</p>';
                            continue;
                        }
                        const stockNews = newsData.filter(n => n.symbol === singleStockSymbol);
                        if (stockNews.length === 0) {
                             container.innerHTML = `<p class="text-gray-500">No recent news found for ${singleStockSymbol} to perform a deep dive.</p>`;
                             continue;
                        }
                        const stockNewsText = stockNews.map(n => JSON.stringify(n)).join('\n');
                        promptText = analysis.prompt(exchange, stockNewsText, singleStockSymbol);
                    } else {
                        promptText = analysis.prompt(exchange, articlesText);
                    }
                    
                    await generateAndSaveAnalysis(promptText, container, exchange, analysis.id, analysis.title);
                    await delay(1500); // Delay to avoid rate limiting
                }
            }
            
            async function generateAndSaveAnalysis(prompt, container, exchange, analysisId, analysisTitle) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${appConfig.geminiApiKey}`;
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error("Gemini API Error:", errorBody);
                        throw new Error(`Gemini API request failed: ${response.status}`);
                    }
                    const result = await response.json();
                    const analysisText = result.candidates[0].content.parts[0].text;
                    
                    renderAnalysis(analysisText, container, exchange, analysisId, analysisTitle);
                    
                    const analysisData = {
                        text: analysisText,
                        title: analysisTitle,
                        timestamp: new Date().toISOString()
                    };
                    await autoSaveAnalysisToFirebase(exchange, analysisId, analysisData);

                } catch (error) {
                    console.error(`Error generating analysis:`, error);
                    container.innerHTML = `<p class="text-red-500">Could not generate analysis. Check console for details.</p>`;
                }
            }
            
            function renderAnalysis(analysisText, container, exchange, analysisId, analysisTitle) {
                 if (!appConfig.generativeAnalyses[exchange]) {
                    appConfig.generativeAnalyses[exchange] = {};
                }
                appConfig.generativeAnalyses[exchange][analysisId] = analysisText;

                let formattedAnalysis = analysisText
                    .replace(/(\*\*|__)(.*?)\1/g, '<strong>$2</strong>')
                    .replace(/(\*|_)(.*?)\1/g, '<em>$2</em>')
                    .replace(/### (.*)/g, '<h4 class="text-md font-semibold mt-4 mb-2">$1</h4>')
                    .replace(/## (.*)/g, '<h3 class="text-lg font-bold mt-4 mb-2">$1</h3>')
                    .replace(/^- (.*)/gm, '<li class="ml-4 list-disc">$1</li>')
                    .replace(/\n/g, '<br>');
                
                container.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-bold text-indigo-600">${analysisTitle}</h3>
                        <button data-exchange="${exchange}" data-analysis-id="${analysisId}" class="save-analysis-btn text-sm bg-green-100 text-green-700 hover:bg-green-200 rounded-md px-3 py-1">
                            <i class="fas fa-save mr-2"></i>Save Manually
                        </button>
                    </div>
                    <div class="prose prose-sm max-w-none text-gray-700 leading-relaxed">${formattedAnalysis}</div>
                `;

                container.querySelector('.save-analysis-btn').addEventListener('click', (e) => {
                    const ex = e.currentTarget.dataset.exchange;
                    const id = e.currentTarget.dataset.analysisId;
                    manualSaveAnalysisToFirebase(ex, id);
                });
            }


            function setupGenerativeTabs(exchange) {
                const buttons = document.querySelectorAll(`#${exchange}-gen-ai-tabs-nav .gen-ai-tab-button`);
                const contents = document.querySelectorAll(`#${exchange}-gen-ai-tabs-content .gen-ai-tab-content`);

                buttons.forEach(button => {
                    button.addEventListener('click', () => {
                        buttons.forEach(btn => {
                            btn.classList.remove('bg-indigo-50', 'text-indigo-700');
                            btn.classList.add('text-gray-500', 'hover:text-indigo-600', 'hover:bg-indigo-50');
                        });
                        button.classList.add('bg-indigo-50', 'text-indigo-700');
                        button.classList.remove('text-gray-500', 'hover:text-indigo-600', 'hover:bg-indigo-50');

                        contents.forEach(content => {
                            content.style.display = 'none';
                        });

                        const targetId = button.id.replace('-tab', '-content');
                        const targetContent = document.getElementById(targetId);
                        if (targetContent) {
                            targetContent.style.display = 'block';
                        }
                    });
                });
            }
            
            // --- 13. CRUD Functions for Analyses ---
            function setupCrudModalListeners() {
                manageSummariesBtn.addEventListener('click', async () => {
                    summaryCrudModal.style.display = 'flex';
                    await loadAnalysesForCrud();
                });
                crudModalOverlay.addEventListener('click', () => {
                    summaryCrudModal.style.display = 'none';
                    editSummaryFormContainer.classList.add('hidden');
                });
                cancelEditBtn.addEventListener('click', () => {
                    editSummaryFormContainer.classList.add('hidden');
                });
                savedSummariesList.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    const analysisId = target.dataset.id;
                    const exchange = target.dataset.exchange;
                    const analysisType = target.dataset.type;

                    if (target.classList.contains('edit-btn')) {
                        handleEditClick(analysisId, exchange, analysisType);
                    } else if (target.classList.contains('delete-btn')) {
                        handleDeleteClick(analysisId, exchange, analysisType);
                    }
                });
                editSummaryForm.addEventListener('submit', handleUpdateSubmit);
            }

            async function manualSaveAnalysisToFirebase(exchange, analysisId) {
                if (!db) return alert("Firebase not initialized.");
                const analysisText = appConfig.generativeAnalyses[exchange]?.[analysisId];
                const analysisTitle = analysisPrompts.find(p => p.id === analysisId)?.title || 'Analysis';

                if (!analysisText) return alert("No analysis text found to save.");

                const analysisData = {
                    title: analysisTitle,
                    text: analysisText,
                    timestamp: new Date().toISOString()
                };

                try {
                    // Using push() for manual saves to allow multiple snapshots
                    await db.ref(`manual-analyses/${exchange}/${analysisId}`).push(analysisData);
                    alert(`${exchange.toUpperCase()} - ${analysisTitle} analysis saved successfully!`);
                } catch (error) {
                    console.error("Error saving analysis:", error);
                    alert("Failed to save analysis.");
                }
            }
            
            async function loadAnalysesForCrud() {
                if (!db) return;
                savedSummariesList.innerHTML = '<p>Loading saved analyses...</p>';
                try {
                    const snapshot = await db.ref('manual-analyses').get();
                    if (!snapshot.exists()) {
                        savedSummariesList.innerHTML = '<p>No analyses have been manually saved yet.</p>';
                        return;
                    }
                    const allAnalyses = snapshot.val();
                    let html = '';
                    for (const exchange in allAnalyses) {
                        html += `<h3 class="text-xl font-bold mt-6 mb-2 text-gray-700 border-b pb-2">${exchange.toUpperCase()}</h3>`;
                        const exchangeAnalyses = allAnalyses[exchange];
                        for (const analysisType in exchangeAnalyses) {
                            const analyses = exchangeAnalyses[analysisType];
                             for (const id in analyses) {
                                const analysis = analyses[id];
                                html += `
                                    <div class="bg-gray-50 p-4 rounded-lg border mb-4">
                                        <p class="font-bold text-indigo-600">${analysis.title}</p>
                                        <p class="text-sm text-gray-500 mb-2">Saved on: ${new Date(analysis.timestamp).toLocaleString()}</p>
                                        <p class="text-gray-800">${analysis.text.replace(/\n/g, '<br>')}</p>
                                        <div class="flex justify-end space-x-2 mt-3">
                                            <button data-id="${id}" data-exchange="${exchange}" data-type="${analysisType}" class="edit-btn text-sm text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i> Edit</button>
                                            <button data-id="${id}" data-exchange="${exchange}" data-type="${analysisType}" class="delete-btn text-sm text-red-600 hover:text-red-800"><i class="fas fa-trash"></i> Delete</button>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    }
                    savedSummariesList.innerHTML = html || '<p>No analyses have been saved yet.</p>';
                } catch (error) {
                    console.error("Error loading analyses for CRUD:", error);
                    savedSummariesList.innerHTML = '<p class="text-red-500">Could not load analyses.</p>';
                }
            }

            async function handleEditClick(analysisId, exchange, analysisType) {
                const snapshot = await db.ref(`manual-analyses/${exchange}/${analysisType}/${analysisId}`).get();
                if (snapshot.exists()) {
                    const analysis = snapshot.val();
                    document.getElementById('editAnalysisId').value = analysisId;
                    document.getElementById('editAnalysisExchange').value = exchange;
                    document.getElementById('editAnalysisType').value = analysisType;
                    document.getElementById('editAnalysisText').value = analysis.text;
                    editSummaryFormContainer.classList.remove('hidden');
                }
            }

            async function handleDeleteClick(analysisId, exchange, analysisType) {
                if (confirm('Are you sure you want to delete this analysis?')) {
                    try {
                        await db.ref(`manual-analyses/${exchange}/${analysisType}/${analysisId}`).remove();
                        await loadAnalysesForCrud(); // Refresh the list
                    } catch (error) {
                        console.error("Error deleting analysis:", error);
                        alert("Failed to delete analysis.");
                    }
                }
            }

            async function handleUpdateSubmit(e) {
                e.preventDefault();
                const analysisId = document.getElementById('editAnalysisId').value;
                const exchange = document.getElementById('editAnalysisExchange').value;
                const analysisType = document.getElementById('editAnalysisType').value;
                const newText = document.getElementById('editAnalysisText').value;

                try {
                    await db.ref(`manual-analyses/${exchange}/${analysisType}/${analysisId}/text`).set(newText);
                    editSummaryFormContainer.classList.add('hidden');
                    await loadAnalysesForCrud(); // Refresh the list
                } catch (error) {
                    console.error("Error updating analysis:", error);
                    alert("Failed to update analysis.");
                }
            }

            // --- 14. Rendering Functions ---
            const formatText = (text) => text || 'N/A';
            const formatMarketCap = (num) => {
                if (!num) return 'N/A';
                if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
                if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
                return num.toLocaleString();
            };

            function renderStockTable(data, container) {
                if (!container) return;
                if (!data || data.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">No stock data found.</p>';
                    return;
                }
                const tableRows = data.map(stock => `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-indigo-600">${formatText(stock.symbol)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${formatText(stock.companyName)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-right">${formatMarketCap(stock.marketCap)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatText(stock.sector)}</td>
                    </tr>`).join('');
                container.innerHTML = `<div class="overflow-x-auto max-h-96"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50 sticky top-0"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Symbol</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Company</th><th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Market Cap</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sector</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody></table></div>`;
            }

            function renderStockCards(data, container, exchange) {
                if (!container) return;
                if (!data || data.length === 0) {
                    container.innerHTML = ''; return;
                }
                const grouped = data.reduce((acc, stock) => {
                    const sector = stock.sector || 'Unclassified';
                    const industry = stock.industry || 'Unclassified';
                    acc[sector] = acc[sector] || {};
                    acc[sector][industry] = acc[sector][industry] || [];
                    acc[sector][industry].push(stock);
                    return acc;
                }, {});

                let html = `<h3 class="text-xl font-bold mb-4 text-gray-700">${exchange.toUpperCase()} Stocks by Sector</h3>`;
                for (const sector in grouped) {
                    html += `<div class="mb-6"><h4 class="text-lg font-semibold text-indigo-700 p-2 bg-indigo-50 rounded-md">${sector}</h4>`;
                    for (const industry in grouped[sector]) {
                        html += `<div class="mt-4"><h5 class="text-md font-medium text-gray-600 mb-3 ml-2">${industry}</h5><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">`;
                        grouped[sector][industry].forEach(stock => {
                            html += `<div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
                                        <div class="flex justify-between items-baseline mb-1">
                                            <p class="font-bold text-sm text-indigo-600 truncate pr-2">${formatText(stock.symbol)}</p>
                                            <p class="text-xs font-semibold text-gray-700 whitespace-nowrap">${formatMarketCap(stock.marketCap)}</p>
                                        </div>
                                        <p class="text-xs text-gray-500">${formatText(stock.companyName)}</p>
                                    </div>`;
                        });
                        html += `</div></div>`;
                    }
                    html += `</div>`;
                }
                container.innerHTML = html;
            }

            function renderNewsCards(newsData, container) {
                if (!container) return;
                if (!newsData || newsData.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 p-4">No recent price target news found for the selected stocks in this exchange for the last 30 days. Click "Refresh News" to fetch the latest.</p>';
                    return;
                }
                const newsHtml = newsData.map(news => `
                    <a href="${news.newsURL}" target="_blank" rel="noopener noreferrer" class="block bg-gray-50 p-4 rounded-lg shadow-sm hover:bg-gray-100 transition-colors">
                        <div class="flex justify-between items-start mb-1">
                            <p class="font-bold text-indigo-600">${formatText(news.symbol)}</p>
                            <p class="text-xs text-gray-500">${new Date(news.publishedDate).toLocaleDateString()}</p>
                        </div>
                        <h4 class="font-semibold text-gray-800">${formatText(news.newsTitle)}</h4>
                        <div class="text-xs text-gray-500 flex flex-wrap gap-x-4 gap-y-1 mt-2">
                            <span><strong>Publisher:</strong> ${formatText(news.newsPublisher)}</span>
                            <span><strong>Analyst:</strong> ${formatText(news.analystName) || 'N/A'} @ ${formatText(news.analystCompany)}</span>
                            <span><strong>Posted Price:</strong> ${news.priceWhenPosted ? '$'+news.priceWhenPosted.toFixed(2) : 'N/A'}</span>
                            <span><strong>Target Price:</strong> ${news.priceTarget ? '$'+news.priceTarget.toFixed(2) : 'N/A'}</span>
                        </div>
                    </a>
                `).join('');
                container.innerHTML = newsHtml;
            }

            // --- Run the initialization function ---
            initialize();
        });
    </script>

</body>
</html>
