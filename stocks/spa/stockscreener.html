<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magickal SPA</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for the modal to be hidden by default */
        .modal {
            display: none;
        }
        /* Styles for accordion transition */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Application Content -->
    <div id="appContent" class="p-4 md:p-8">
        <h1 class="text-3xl md:text-4xl font-bold text-indigo-600 text-center mb-8">Magickal SPA Dashboard</h1>
        
        <!-- Accordion for Stock Screener -->
        <div id="stockScreenerAccordion" class="bg-white rounded-xl shadow-md max-w-4xl mx-auto">
            <button id="accordion-button" class="w-full flex justify-between items-center p-5 text-left font-semibold text-lg hover:bg-gray-50 rounded-t-xl focus:outline-none">
                <span>Stock Screener: NASDAQ (Market Cap > $1B)</span>
                <!-- Chevron Icon -->
                <svg id="accordion-icon" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="accordion-content" class="accordion-content px-5 pb-5">
                <div id="screener-data-container" class="mt-4 border-t pt-4">
                    <p class="text-gray-500">Loading stock data...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 modal">
        <!-- Modal Backdrop -->
        <div class="absolute inset-0 bg-gray-900 bg-opacity-75"></div>
        <!-- Modal Content -->
        <div class="relative bg-white rounded-2xl shadow-lg border border-gray-200 p-8 w-full max-w-lg m-4 overflow-y-auto max-h-[90vh]">
            <h2 class="text-2xl font-bold mb-4">API Keys Required</h2>
            <p class="text-gray-500 mb-6">Please provide your API keys to get started. These are required for the application to function.</p>
            <form id="apiKeyForm">
                <div class="space-y-4">
                    <div>
                        <label for="geminiApiKeyInput" class="block text-sm font-semibold text-gray-800 mb-1">Google Gemini API Key</label>
                        <input type="password" id="geminiApiKeyInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your Google Gemini API Key">
                    </div>
                    <div>
                        <label for="googleClientIdInput" class="block text-sm font-semibold text-gray-800 mb-1">Google Cloud Client ID</label>
                        <input type="password" id="googleClientIdInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your Google Cloud Web Client ID">
                    </div>
                    <div>
                        <label for="webSearchApiKeyInput" class="block text-sm font-semibold text-gray-800 mb-1">Web Search API Key (Google)</label>
                        <input type="password" id="webSearchApiKeyInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your Google Cloud API Key">
                    </div>
                    <div>
                        <label for="searchEngineIdInput" class="block text-sm font-semibold text-gray-800 mb-1">Search Engine ID (cx value)</label>
                        <input type="text" id="searchEngineIdInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your Custom Search Engine ID">
                    </div>
                    <div>
                        <label for="fmpApiKeyInput" class="block text-sm font-semibold text-gray-800 mb-1">Financial Modeling Prep API Key</label>
                        <input type="password" id="fmpApiKeyInput" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Enter your FMP API Key">
                    </div>
                    <div>
                        <label for="firebaseConfigInput" class="block text-sm font-semibold text-gray-800 mb-1">Firebase Web App Config</label>
                        <textarea id="firebaseConfigInput" class="border border-gray-300 rounded-lg w-full p-2 font-mono text-xs" rows="6" placeholder="Paste your Firebase Web App Config Object"></textarea>
                    </div>
                </div>
                <p id="api-key-error" class="text-red-500 text-sm mt-4 h-5"></p>
                <div class="mt-6 flex justify-end">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition-colors">Save and Continue</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // --- 1. Global Configuration Object ---
            const appConfig = {
                fmpApiKey: "",
                geminiApiKey: "",
                searchApiKey: "",
                searchEngineId: "",
                googleClientId: "",
                firebaseConfig: {}
            };

            // --- 2. DOM Element Selection ---
            const apiKeyModal = document.getElementById('apiKeyModal');
            const apiKeyForm = document.getElementById('apiKeyForm');
            const errorMessage = document.getElementById('api-key-error');
            const screenerContainer = document.getElementById('screener-data-container');
            const accordionButton = document.getElementById('accordion-button');
            const accordionContent = document.getElementById('accordion-content');
            const accordionIcon = document.getElementById('accordion-icon');

            // Input Fields
            const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
            const googleClientIdInput = document.getElementById('googleClientIdInput');
            const webSearchApiKeyInput = document.getElementById('webSearchApiKeyInput');
            const searchEngineIdInput = document.getElementById('searchEngineIdInput');
            const fmpApiKeyInput = document.getElementById('fmpApiKeyInput');
            const firebaseConfigInput = document.getElementById('firebaseConfigInput');

            // --- 3. Initialization Logic ---
            function initialize() {
                const savedKeys = localStorage.getItem('magickalApiKeys');
                if (savedKeys) {
                    const parsedKeys = JSON.parse(savedKeys);
                    Object.assign(appConfig, parsedKeys);
                    hideModal();
                    startApp();
                } else {
                    showModal();
                }
            }

            // --- 4. Form Submission Handler ---
            apiKeyForm.addEventListener('submit', (event) => {
                event.preventDefault();
                errorMessage.textContent = '';

                const formValues = {
                    geminiApiKey: geminiApiKeyInput.value.trim(),
                    googleClientId: googleClientIdInput.value.trim(),
                    searchApiKey: webSearchApiKeyInput.value.trim(),
                    searchEngineId: searchEngineIdInput.value.trim(),
                    fmpApiKey: fmpApiKeyInput.value.trim(),
                    firebaseConfigString: firebaseConfigInput.value.trim()
                };
                
                if (Object.values(formValues).some(value => value === '')) {
                    errorMessage.textContent = 'All fields are required.';
                    return;
                }

                let parsedFirebaseConfig;
                try {
                    parsedFirebaseConfig = JSON.parse(formValues.firebaseConfigString);
                } catch (error) {
                    errorMessage.textContent = 'The Firebase Web App Config is not a valid JSON object.';
                    return;
                }

                Object.assign(appConfig, {
                    geminiApiKey: formValues.geminiApiKey,
                    googleClientId: formValues.googleClientId,
                    searchApiKey: formValues.searchApiKey,
                    searchEngineId: formValues.searchEngineId,
                    fmpApiKey: formValues.fmpApiKey,
                    firebaseConfig: parsedFirebaseConfig
                });

                try {
                    localStorage.setItem('magickalApiKeys', JSON.stringify(appConfig));
                    hideModal();
                    startApp();
                } catch (error) {
                    errorMessage.textContent = 'Could not save keys to local storage.';
                }
            });

            // --- 5. Modal Utility Functions ---
            function showModal() { apiKeyModal.style.display = 'flex'; }
            function hideModal() { apiKeyModal.style.display = 'none'; }
            
            // --- 6. Main Application Logic ---
            function startApp() {
                console.log("Application starting with loaded configuration.");
                setupAccordion();
                fetchStockScreener();
            }

            // --- 7. Accordion Setup ---
            function setupAccordion() {
                accordionButton.addEventListener('click', () => {
                    const isOpen = accordionContent.style.maxHeight;
                    if (isOpen && isOpen !== "0px") {
                        accordionContent.style.maxHeight = "0px";
                        accordionIcon.style.transform = "rotate(0deg)";
                    } else {
                        // Set max-height to its scroll height to animate open
                        accordionContent.style.maxHeight = accordionContent.scrollHeight + "px";
                        accordionIcon.style.transform = "rotate(180deg)";
                    }
                });
            }

            // --- 8. Fetch Stock Screener Data ---
            async function fetchStockScreener() {
                // Show loading state
                screenerContainer.innerHTML = '<p class="text-gray-500">Loading stock data...</p>';
                const apiKey = appConfig.fmpApiKey;
                if (!apiKey) {
                    screenerContainer.innerHTML = '<p class="text-red-500">Financial Modeling Prep API Key is missing.</p>';
                    return;
                }

                const url = `https://financialmodelingprep.com/api/v3/stock-screener?marketCapMoreThan=1000000000&exchange=NASDAQ&limit=1000&apikey=${apiKey}`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    const data = await response.json();
                    renderStockData(data);
                } catch (error) {
                    console.error("Error fetching stock data:", error);
                    screenerContainer.innerHTML = `<p class="text-red-500">Error fetching data. Check the console and ensure your FMP API key is correct.</p>`;
                }
            }

            // --- 9. Render Stock Data ---
            function renderStockData(data) {
                if (!data || data.length === 0) {
                    screenerContainer.innerHTML = '<p class="text-gray-500">No stock data found for the specified criteria.</p>';
                    return;
                }

                // Create a table to display the data
                let tableHtml = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Market Cap</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;

                // Format number to be more readable (e.g., 1.23B)
                const formatMarketCap = (num) => {
                    if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
                    if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
                    if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
                    return num.toLocaleString();
                };

                // Populate table rows
                data.forEach(stock => {
                    tableHtml += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${stock.symbol}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stock.companyName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatMarketCap(stock.marketCap)}</td>
                        </tr>
                    `;
                });

                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                `;

                screenerContainer.innerHTML = tableHtml;
            }

            // --- Run the initialization function ---
            initialize();
        });
    </script>

</body>
</html>
