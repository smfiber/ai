<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Stretch Solution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .custom-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="%2364748b" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-chevron-down" viewBox="0 0 24 24"><path d="m6 9 6 6 6-6"/></svg>');
            background-position: right 1rem center;
            background-repeat: no-repeat;
            background-size: 1em;
            padding-right: 2.5rem;
        }
        .view { display: none; }
        .view.active { display: block; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .custom-modal {
            display: none; 
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border: 1px solid #888;
            width: 80%;
            max-width: 450px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .modal-button {
            background-color: #4f46e5;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 16px;
            width: 100%;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #475569;
        }
        .tab-button.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .action-btn {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid;
            transition: all 0.2s;
        }
        .approve-btn { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .approve-btn:hover { background-color: #bbf7d0; }
        .deny-btn { background-color: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .deny-btn:hover { background-color: #fecaca; }
        .illustrate-btn { background-color: #e0e7ff; color: #3730a3; border-color: #c7d2fe; }
        .illustrate-btn:hover { background-color: #c7d2fe; }
    </style>
</head>
<body class="text-slate-800">

    <!-- App Container -->
    <div class="min-h-screen flex flex-col">

        <!-- Header -->
        <header class="w-full bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky top-0 z-10">
            <div class="w-full flex justify-between items-center p-4 px-4 md:px-8">
                <div class="flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M16.465 16.465a5 5 0 1 0-7.07-7.07l7.07 7.07Z"/><path d="m10.243 19.314 5.303-5.303"/><path d="M14.121 15.536 12 17.657"/><path d="m12.687 12.687 5.303-5.303"/><path d="m8.808 11.879 2.121-2.121"/><path d="m7.364 7.364 5.303 5.303"/><path d="m2.05 2.05 5.303 5.303"/></svg>
                    <h1 class="text-2xl font-bold text-slate-900">The Stretch Solution</h1>
                </div>
                <nav class="hidden md:flex items-center space-x-6">
                    <a href="#" id="home-link" class="text-slate-600 hover:text-indigo-600 transition-colors">Home</a>
                    <a href="#" id="about-link" class="text-slate-600 hover:text-indigo-600 transition-colors">About</a>
                    <a href="#" id="my-routines-link" class="text-slate-600 hover:text-indigo-600 transition-colors">My Routines</a>
                </nav>
                 <div id="auth-container" class="flex items-center space-x-2"></div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow w-full py-10 px-4 md:px-8">
            <div id="app-content" class="hidden">
                <!-- Routine Creation Section -->
                <div id="creation-section" class="view active w-full mx-auto text-center">
                    <h2 class="text-4xl md:text-5xl font-bold tracking-tight text-slate-900">Intelligent Stretching, Personalized for You</h2>
                    <p class="mt-4 text-lg text-slate-600 max-w-2xl mx-auto">Select your focus and preferences to begin your custom stretching routine.</p>
                    <div class="mt-10 p-6 md:p-8 bg-white border border-slate-200 rounded-xl shadow-sm max-w-5xl mx-auto">
                        <div class="border-b border-slate-200 mb-6">
                            <nav class="-mb-px flex flex-wrap justify-center gap-x-6" aria-label="Tabs">
                                <button class="tab-button active" data-tab="search">Custom Search</button>
                                <button class="tab-button" data-tab="muscle">Target Muscle</button>
                                <button class="tab-button" data-tab="ailment">Common Ailments</button>
                                <button class="tab-button" data-tab="yoga">Yoga Asanas</button>
                            </nav>
                        </div>
                        <div class="grid grid-cols-1 gap-6 text-left">
                            <div id="search-tab" class="tab-content active">
                                 <label for="search-bar" class="block text-sm font-medium text-slate-700 mb-1">Enter a Custom Focus</label>
                                 <div class="relative">
                                    <input type="text" id="search-bar" placeholder="e.g., 'lower back pain', 'tight hips'..." class="w-full p-3 pl-10 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></div>
                                </div>
                            </div>
                            <div id="muscle-tab" class="tab-content">
                                <label for="muscle-select" class="block text-sm font-medium text-slate-700 mb-1">Choose a Muscle</label>
                                <select id="muscle-select" class="custom-select w-full p-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
                            </div>
                            <div id="ailment-tab" class="tab-content">
                                <label for="ailment-select" class="block text-sm font-medium text-slate-700 mb-1">Choose an Ailment</label>
                                <select id="ailment-select" class="custom-select w-full p-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
                            </div>
                            <div id="yoga-tab" class="tab-content">
                                <label for="yoga-select" class="block text-sm font-medium text-slate-700 mb-1">Focus on Yoga Asanas (Poses)</label>
                                <select id="yoga-select" class="custom-select w-full p-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
                            </div>
                            <div class="border-t border-slate-200 pt-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
                                 <div>
                                    <label for="routine-type-select" class="block text-sm font-medium text-slate-700 mb-1">Type of Routine</label>
                                    <select id="routine-type-select" class="custom-select w-full p-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
                                </div>
                                <div>
                                    <label for="modality-select" class="block text-sm font-medium text-slate-700 mb-1">Stretching Modality</label>
                                    <select id="modality-select" class="custom-select w-full p-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
                                </div>
                                <div>
                                    <label for="duration-select" class="block text-sm font-medium text-slate-700 mb-1">Duration</label>
                                    <select id="duration-select" class="custom-select w-full p-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
                                </div>
                                <div>
                                    <label for="exercises-select" class="block text-sm font-medium text-slate-700 mb-1"># of Exercises</label>
                                    <select id="exercises-select" class="custom-select w-full p-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8">
                            <button id="generate-btn" class="w-full md:w-auto px-10 py-4 text-lg font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all transform hover:scale-105">Generate My Routine</button>
                        </div>
                    </div>
                </div>

                <div id="results-section" class="view w-full mx-auto">
                    <div class="text-center mb-8 max-w-5xl mx-auto">
                         <h2 id="routine-title" class="text-3xl font-bold text-slate-900"></h2>
                        <div id="routine-summary-icons" class="mt-4 flex flex-wrap justify-center items-center gap-x-6 gap-y-2 text-slate-600"></div>
                    </div>
                    <div id="loader-container" class="flex justify-center items-center h-64"></div>
                    <div id="routine-list" class="space-y-6 max-w-5xl mx-auto"></div>
                     <div id="results-buttons" class="mt-8 flex flex-col sm:flex-row justify-center gap-4 hidden">
                        <button id="save-routine-btn" class="px-6 py-3 text-base font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">Save Routine</button>
                        <button id="start-over-btn" class="px-6 py-3 text-base font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50">Start Over</button>
                    </div>
                </div>
                <div id="my-routines-section" class="view w-full mx-auto">
                     <h2 class="text-3xl font-bold text-slate-900 mb-6 max-w-5xl mx-auto">My Saved Routines</h2>
                    <div id="saved-routines-list" class="space-y-4 max-w-5xl mx-auto"></div>
                </div>
                <div id="about-section" class="view w-full mx-auto">
                    <h2 class="text-3xl font-bold text-slate-900 mb-6 max-w-5xl mx-auto">About The Stretch Solution</h2>
                    <div class="bg-white p-8 rounded-lg shadow-sm space-y-4 text-slate-600 max-w-5xl mx-auto">
                        <p>...</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center py-8 border-t border-slate-200 bg-white mt-auto">
             <div class="w-full px-4 md:px-8">
                <p class="text-xs text-slate-500 max-w-2xl mx-auto">...</p>
                <p class="mt-4 text-xs text-slate-400">Version 4.6</p>
            </div>
        </footer>
        
        <!-- MODALS -->
        <div id="custom-alert-modal" class="custom-modal">
             <div class="modal-content">
                <p id="modal-text" class="text-slate-700"></p>
                <button id="modal-close-btn" class="modal-button !mt-6">OK</button>
            </div>
        </div>
        
        <div id="setup-modal" class="custom-modal" style="display: flex;">
            <div class="modal-content">
                 <h3 class="text-xl font-semibold mb-4">Application Setup & Login</h3>
                <div class="text-left mb-4">
                    <label for="api-key-input" class="block text-sm font-medium text-slate-700">Gemini API Key (Required)</label>
                    <input type="password" id="api-key-input" class="mt-1 w-full p-2 border border-slate-300 rounded-lg" placeholder="Enter your Gemini API Key...">
                </div>
                <div class="text-left mb-4">
                     <label for="firebase-config-input" class="block text-sm font-medium text-slate-700">Firebase Config (Required)</label>
                     <textarea id="firebase-config-input" rows="6" class="mt-1 w-full p-2 border border-slate-300 rounded-lg font-mono text-xs" placeholder="Paste your Firebase config object here..."></textarea>
                </div>
                <div class="border-t border-slate-200 my-4"></div>
                 <div id="auth-tabs" class="border-b border-slate-200 mb-4">
                    <nav class="-mb-px flex justify-center gap-x-6" aria-label="Tabs">
                        <button class="tab-button active" data-auth-tab="login">Login</button>
                        <button class="tab-button" data-auth-tab="signup">Sign Up</button>
                    </nav>
                </div>
                <div id="login-form-container" class="tab-content active" data-auth-tab-content="login">
                    <form id="login-form" class="space-y-4 text-left">
                        <div>
                            <label for="login-email-input" class="block text-sm font-medium text-slate-700">Email</label>
                            <input type="email" id="login-email-input" required class="mt-1 block w-full px-3 py-2 bg-white border-slate-300 rounded-md text-sm shadow-sm">
                        </div>
                        <div>
                            <label for="login-password-input" class="block text-sm font-medium text-slate-700">Password</label>
                            <input type="password" id="login-password-input" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                        </div>
                        <button type="submit" class="modal-button">Login & Initialize</button>
                    </form>
                </div>
                <div id="signup-form-container" class="tab-content" data-auth-tab-content="signup">
                     <form id="signup-form" class="space-y-4 text-left">
                        <div>
                            <label for="signup-email-input" class="block text-sm font-medium text-slate-700">Email</label>
                            <input type="email" id="signup-email-input" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                        </div>
                        <div>
                            <label for="signup-password-input" class="block text-sm font-medium text-slate-700">Password</label>
                             <input type="password" id="signup-password-input" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                             <p class="text-xs text-slate-500 mt-1">Must be at least 6 characters.</p>
                        </div>
                        <button type="submit" class="modal-button">Create Account & Initialize</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection, getDocs, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let app, auth, db;
        let geminiApiKey = null; 
        let firebaseConfigObj = null;
        let userId = null;
        let isInitialized = false;
        let currentRoutine = null;

        const ui = {
            appContent: document.getElementById('app-content'),
            setupModal: document.getElementById('setup-modal'),
            customAlertModal: document.getElementById('custom-alert-modal'),
            modalText: document.getElementById('modal-text'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            authContainer: document.getElementById('auth-container'),
            loginForm: document.getElementById('login-form'),
            signupForm: document.getElementById('signup-form'),
            authTabs: document.getElementById('auth-tabs'),
            muscleSelect: document.getElementById('muscle-select'),
            ailmentSelect: document.getElementById('ailment-select'),
            yogaSelect: document.getElementById('yoga-select'),
            routineTypeSelect: document.getElementById('routine-type-select'),
            modalitySelect: document.getElementById('modality-select'),
            durationSelect: document.getElementById('duration-select'),
            exercisesSelect: document.getElementById('exercises-select'),
            searchBar: document.getElementById('search-bar'),
            generateBtn: document.getElementById('generate-btn'),
            routineList: document.getElementById('routine-list'),
            loaderContainer: document.getElementById('loader-container'),
            views: Array.from(document.querySelectorAll('.view'))
        };
        
        window.onload = () => {
            setupModalEventListeners();
            setupNavigationEventListeners();
            ui.modalCloseBtn.onclick = () => { ui.customAlertModal.style.display = 'none'; };
        };
        
        function setupModalEventListeners() {
            ui.authTabs.addEventListener('click', (e) => {
                if (e.target.matches('.tab-button')) {
                    const tab = e.target.dataset.authTab;
                    ui.authTabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll('[data-auth-tab-content]').forEach(content => {
                        content.style.display = content.dataset.authTabContent === tab ? 'block' : 'none';
                    });
                }
            });
            ui.loginForm.addEventListener('submit', (e) => { e.preventDefault(); triggerInitialization(false); });
            ui.signupForm.addEventListener('submit', (e) => { e.preventDefault(); triggerInitialization(true); });
        }
        
        function setupNavigationEventListeners() {
            handleMainTabs();
            ui.generateBtn.addEventListener('click', generateRoutine);
            document.getElementById('save-routine-btn').addEventListener('click', saveRoutine);
            ui.routineList.addEventListener('click', handleRoutineListClick);
            document.getElementById('home-link').addEventListener('click', (e) => { e.preventDefault(); showView('creation-section'); });
            document.getElementById('about-link').addEventListener('click', (e) => { e.preventDefault(); showView('about-section'); });
            document.getElementById('my-routines-link').addEventListener('click', (e) => { 
                e.preventDefault(); 
                if (userId) { loadSavedRoutines(); showView('my-routines-section'); } 
                else { showAlert('Please log in to view your routines.'); }
            });
            document.getElementById('start-over-btn').addEventListener('click', () => showView('creation-section'));
        }
        
        function triggerInitialization(isSignUp) {
            geminiApiKey = document.getElementById('api-key-input').value.trim();
            const configString = document.getElementById('firebase-config-input').value.trim();
            if (!geminiApiKey || !configString) { showAlert("Please provide both your Gemini API Key and Firebase Config."); return; }
            try {
                const jsonString = configString.match(/\{[\s\S]*\}/)[0];
                if (!jsonString) throw new Error("Invalid format.");
                firebaseConfigObj = new Function(`return ${jsonString}`)();
            } catch (e) { showAlert("Invalid Firebase config format. Please paste the entire object."); return; }
            initializeAppAndAuth(isSignUp);
        }

        async function initializeAppAndAuth(isSignUp) {
            if (isInitialized) { isSignUp ? await handleSignUp() : await handleLogin(); return; }
            try {
                app = initializeApp(firebaseConfigObj);
                auth = getAuth(app);
                db = getFirestore(app);
                onAuthStateChanged(auth, user => { updateAuthStateUI(user); });
                await (isSignUp ? handleSignUp() : handleLogin());
            } catch (e) {
                 showAlert(`Firebase initialization failed: ${e.message}`);
                 console.error("Firebase Init Error:", e);
                 isInitialized = false; 
            }
        }

        async function handleLogin() {
            const email = document.getElementById('login-email-input').value;
            const password = document.getElementById('login-password-input').value;
            try { await signInWithEmailAndPassword(auth, email, password); } 
            catch (error) { handleFirebaseError(error); }
        }

        async function handleSignUp() {
             const email = document.getElementById('signup-email-input').value;
             const password = document.getElementById('signup-password-input').value;
             try {
                await createUserWithEmailAndPassword(auth, email, password);
                showAlert('Account created successfully! You are now logged in.');
             } catch (error) { handleFirebaseError(error); }
        }
        
        function updateAuthStateUI(user) {
            if (user) {
                if (!isInitialized) { // Only run this part once on initial successful login
                    isInitialized = true;
                    userId = user.uid;
                    ui.appContent.style.display = 'block';
                    ui.setupModal.style.display = 'none';
                    ui.authContainer.innerHTML = `<p class="text-sm text-slate-600 mr-2 hidden sm:block">Welcome, ${user.email}</p><button id="logout-btn" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50">Logout</button>`;
                    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth).catch(err => showAlert(`Logout failed: ${err.message}`)));
                    populateAllDropDowns();
                }
            } else {
                isInitialized = false; 
                userId = null;
                ui.appContent.style.display = 'none';
                ui.setupModal.style.display = 'flex';
                ui.authContainer.innerHTML = `<button id="login-show-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">Setup / Login</button>`;
                document.getElementById('login-show-btn').addEventListener('click', () => { ui.setupModal.style.display = 'flex'; });
            }
        }

        function showView(viewId) {
            ui.views.forEach(view => view.style.display = view.id === viewId ? 'block' : 'none');
            window.scrollTo(0,0);
        }

        function handleMainTabs() {
            const mainTabsContainer = document.querySelector('#creation-section nav[aria-label="Tabs"]');
            mainTabsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.tab-button')) {
                    const tab = e.target.dataset.tab;
                    mainTabsContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('#creation-section .tab-content').forEach(content => content.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById(`${tab}-tab`).classList.add('active');
                }
            });
        }
        
        function handleFirebaseError(error) {
            console.error("Firebase Auth Error:", error.code, error.message);
            const messages = {
                'auth/invalid-email': 'Please enter a valid email address.',
                'auth/user-not-found': 'Invalid email or password.',
                'auth/invalid-credential': 'Invalid email or password.',
                'auth/wrong-password': 'Incorrect password.',
                'auth/email-already-in-use': 'An account with this email already exists.',
                'auth/weak-password': 'Password must be at least 6 characters.'
            };
            showAlert(messages[error.code] || `An error occurred: ${error.message}`);
        }
        
        async function populateSelectFromAI(selectElement, prompt, schema, loadingText, errorText, sort = true) {
            selectElement.innerHTML = `<option value="">-- ${loadingText} --</option>`;
            if (!geminiApiKey) { selectElement.innerHTML = `<option value="">-- API Key Required --</option>`; return; }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema }};
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API call failed: ${response.status}`);
                const result = await response.json();
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                const dataKey = Object.keys(data)[0];
                let items = data[dataKey];
                if (sort) items.sort();
                selectElement.innerHTML = `<option value="">-- Select an Option --</option>`;
                items.forEach(item => { const option = document.createElement('option'); option.value = item; option.textContent = item; selectElement.appendChild(option); });
            } catch (error) {
                console.error(`Error populating ${selectElement.id}:`, error);
                selectElement.innerHTML = `<option value="">-- ${errorText} --</option>`;
                showAlert(`Could not load data for ${selectElement.id}. Check API key & network.`);
            }
        }
        
        function populateAllDropDowns() {
            const commonSchema = (key) => ({ type: "OBJECT", properties: { [key]: { type: "ARRAY", items: { type: "STRING" } } } });
            const musclePrompt = `When considering exercise for rehabilitation or flexibility, what are all of the major and minor muscle groups, and individual muscles within those groups, that people commonly focus on stretching? Return a JSON object containing a single key 'muscleFocusAreas' which is an array of strings. Each string should represent a muscle group or individual muscle, formatted as 'Common Name - Technical Term(s)'. For example: 'Hamstrings - Biceps Femoris, Semitendinosus, Semimembranosus'. Provide an extensive and exhaustive list, ordered alphabetically.`;
            populateSelectFromAI(ui.muscleSelect, musclePrompt, commonSchema('muscleFocusAreas'), "Loading Muscles...", "Load Failed");
            const ailmentPrompt = `When considering exercise for rehabilitation, what are all the common ailments, injuries, or conditions that individuals seek to address or recover from through structured exercise programs? Return a JSON object containing a single key 'commonAilments' which is an array of strings. Each string should be a concise and commonly understood name for an ailment, suitable for a dropdown menu. Aim for a comprehensive and exhaustive list of these conditions, ordered alphabetically.`;
            populateSelectFromAI(ui.ailmentSelect, ailmentPrompt, commonSchema('commonAilments'), "Loading Ailments...", "Load Failed");
            const yogaPrompt = `When practicing yoga asanas (poses), what are all of the major and minor muscle groups, and individual muscles within those groups, that people commonly focus on engaging, strengthening, or stretching? Return a JSON object containing a single key 'yogaFocusAreas' which is an array of strings. Each string should represent a muscle group or individual muscle, formatted as 'Common Name - Technical Term(s)'. Prioritize common yoga terminology for groups where applicable (e.g., 'Core', 'Hamstrings'), but expand to include all relevant anatomical muscles that are specifically targeted. Provide an extensive and exhaustive list, ordered alphabetically.`;
            populateSelectFromAI(ui.yogaSelect, yogaPrompt, commonSchema('yogaFocusAreas'), "Loading Yoga Areas...", "Load Failed");
            populateSelectFromAI(ui.routineTypeSelect, `Return a JSON object with a key 'routineTypes' containing an array of common stretching routine types (e.g., "Restorative"), ordered alphabetically.`, commonSchema('routineTypes'), "Loading Types...", "Load Failed");
            const modalityPrompt = `When considering exercise, what are the primary modalities or overarching categories of routines that focus on mind-body connection, flexibility, and gentle movement? Return a JSON object containing a single key 'routineModalities' which is an array of strings. Each string should be a concise and commonly understood name for a distinct exercise modality, suitable for a dropdown menu. Aim for a comprehensive and exhaustive list of these broader categories. Provide the list ordered alphabetically.`;
            populateSelectFromAI(ui.modalitySelect, modalityPrompt, commonSchema('routineModalities'), "Loading Modalities...", "Load Failed");
            populateSelectFromAI(ui.durationSelect, `Return a JSON object with a key 'durations' which is an array of strings for routine durations from 15 to 120 minutes in 15-min increments (e.g., '15 Minutes').`, commonSchema('durations'), "Loading Durations...", "Load Failed", false);
            populateSelectFromAI(ui.exercisesSelect, `Return a JSON object with a key 'exerciseCounts' which is an array of strings for number of exercises from 3 to 15 (e.g., '3 Exercises').`, commonSchema('exerciseCounts'), "Loading Counts...", "Load Failed", false);
        }
        
        function showAlert(message) {
            ui.modalText.textContent = message;
            ui.customAlertModal.style.display = 'flex';
        }
        
        async function generateRoutine() {
            showView('results-section');
            ui.routineList.innerHTML = '';
            ui.loaderContainer.innerHTML = '<div class="loader"></div>';
            document.getElementById('results-buttons').classList.add('hidden');
            
            const routineType = ui.routineTypeSelect.value, modality = ui.modalitySelect.value, duration = ui.durationSelect.value, numExercisesText = ui.exercisesSelect.value;
            const numExercises = parseInt(numExercisesText.split(' ')[0]);
            const activeTab = document.querySelector('.tab-button.active').dataset.tab;
            let focus = '';

            switch (activeTab) {
                case 'search': focus = ui.searchBar.value.trim(); break;
                case 'muscle': focus = ui.muscleSelect.value; break;
                case 'ailment': focus = ui.ailmentSelect.value; break;
                case 'yoga': focus = ui.yogaSelect.value; break;
            }

            if (!focus) { showAlert("Please select an option or enter a search term."); showView('creation-section'); return; }
            let title = `Your ${duration} ${modality} Routine for ${focus}`;
            document.getElementById('routine-title').textContent = title;

            const prompt = `Generate a "${routineType}" stretching routine for "${focus}". The routine should last approximately ${duration} and consist of ${numExercises} exercises. For each exercise, provide a name, step-by-step instructions, and its benefit.`;

            try {
                const response = await callGeminiForRoutine(prompt);
                currentRoutine = { title, exercises: response.exercises, createdAt: new Date().toISOString() };
                await renderRoutine(currentRoutine);
            } catch (error) {
                console.error("Error generating routine:", error);
                ui.routineList.innerHTML = `<div class="bg-red-100 p-4 rounded-lg text-center text-red-700"><p><strong>Generation Failed!</strong> Please try again later.</p></div>`;
            } finally {
                ui.loaderContainer.innerHTML = '';
                document.getElementById('results-buttons').classList.remove('hidden');
            }
        }
        
        async function renderRoutine(routine) {
            ui.routineList.innerHTML = '';
            for (const [index, exercise] of routine.exercises.entries()) {
                const exerciseEl = document.createElement('div');
                exerciseEl.className = 'bg-white border border-slate-200 rounded-xl shadow-sm p-6 flex flex-col md:flex-row gap-6';
                const imageContainerId = `image-container-${Date.now()}-${index}`;
                exerciseEl.innerHTML = `
                    <div class="w-full md:w-1/3">
                        <div id="${imageContainerId}" class="w-full h-64 bg-slate-100 rounded-lg flex items-center justify-center p-2">
                             <button class="action-btn illustrate-btn" data-exercise-name="${exercise.name}">Illustrate</button>
                        </div>
                        <div class="moderation-controls mt-2 flex justify-center gap-x-2" style="display: none;">
                            <button class="action-btn approve-btn" data-exercise-name="${exercise.name}">Approve</button>
                            <button class="action-btn deny-btn">Deny</button>
                        </div>
                    </div>
                    <div class="w-full md:w-2/3">
                        <h3 class="text-xl font-semibold text-slate-900">${exercise.name}</h3>
                        <div class="mt-4 text-slate-600 space-y-4">
                            <div><h4 class="font-semibold text-slate-800">Instructions:</h4><p class="mt-1">${exercise.instructions}</p></div>
                            <div><h4 class="font-semibold text-slate-800">Why it's beneficial:</h4><p class="mt-1">${exercise.benefit}</p></div>
                        </div>
                    </div>
                `;
                ui.routineList.appendChild(exerciseEl);
                if (isInitialized) { // Check if we are online before checking for image
                   await getImageForExercise(exercise.name, document.getElementById(imageContainerId), true);
                }
            }
        }
        
        async function getImageForExercise(exerciseName, containerElement, isInitialLoad = false) {
             if (!isInitialized || !db) {
                console.error("Firestore not ready for image check.");
                return;
            }
            containerElement.innerHTML = '<div class="loader"></div>';

            const approvedImg = await findApprovedImageInFirebase(exerciseName);
            if (approvedImg) {
                containerElement.innerHTML = approvedImg.svgData;
                containerElement.nextElementSibling.style.display = 'none';
            } else if (isInitialLoad) {
                 containerElement.innerHTML = `<button class="action-btn illustrate-btn" data-exercise-name="${exerciseName}">Illustrate</button>`;
            } 
            else {
                const generatedSvg = await generateSvgForExercise(exerciseName);
                if (generatedSvg) {
                    containerElement.innerHTML = generatedSvg;
                    containerElement.nextElementSibling.style.display = 'flex';
                } else {
                     containerElement.innerHTML = '<p class="text-xs text-slate-500">Illustration failed.</p>';
                     containerElement.nextElementSibling.style.display = 'none';
                }
            }
        }
        
        async function findApprovedImageInFirebase(exerciseName) {
            if (!isInitialized) return null;
            try {
                const docRef = doc(db, "approved_images", exerciseName);
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data() : null;
            } catch (error) {
                console.error("Error fetching approved image:", error);
                // Don't show alert here, it can be spammy. The error is logged.
                return null;
            }
        }

        async function generateSvgForExercise(exerciseName) {
            const prompt = `Generate only the raw SVG code for an anatomically correct, minimalist stick-figure illustration showing a person performing the '${exerciseName}' stretch. The SVG must clearly show the body's position and the muscles being targeted. Use a viewBox of '0 0 100 100', a transparent background, and a 'currentColor' stroke with a width of 1.5. Do not include any XML declaration, comments, or other text outside of the <svg> tags.`;
            try {
                 const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
                 const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                 const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                 if (!response.ok) throw new Error(`API call failed: ${response.status}`);
                 const result = await response.json();
                 const rawText = result.candidates[0].content.parts[0].text;
                 const svgMatch = rawText.match(/<svg[\s\S]*?<\/svg>/);
                 return svgMatch ? svgMatch[0] : null;
            } catch(error) {
                console.error(`Error generating SVG for ${exerciseName}:`, error);
                return null;
            }
        }
        
        async function callGeminiForRoutine(prompt) {
            const schema = { type: "OBJECT", properties: { "exercises": { type: "ARRAY", items: { type: "OBJECT", properties: { "name": { "type": "STRING" }, "instructions": { "type": "STRING" }, "benefit": { "type": "STRING" }}, required: ["name", "instructions", "benefit"]}}}};
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema }};
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API call failed: ${response.status}`);
            const result = await response.json();
            return JSON.parse(result.candidates[0].content.parts[0].text);
        }

        async function handleRoutineListClick(e) {
            const target = e.target;
            const exerciseName = target.dataset.exerciseName;

            if (target.classList.contains('illustrate-btn')) {
                const imageContainer = target.parentElement;
                await getImageForExercise(exerciseName, imageContainer, false);
            } else if (target.classList.contains('approve-btn')) {
                const moderationControls = target.closest('.moderation-controls');
                const imageContainer = moderationControls.previousElementSibling;
                const svgData = imageContainer.innerHTML;
                if (exerciseName && svgData.startsWith('<svg')) {
                    await saveApprovedImageToFirebase(exerciseName, svgData);
                    moderationControls.innerHTML = `<p class="text-xs text-green-700">Approved!</p>`;
                }
            } else if (target.classList.contains('deny-btn')) {
                const moderationControls = target.closest('.moderation-controls');
                const imageContainer = moderationControls.previousElementSibling;
                imageContainer.innerHTML = `<button class="action-btn illustrate-btn" data-exercise-name="${exerciseName}">Illustrate Again</button>`;
                moderationControls.style.display = 'none';
            }
        }
        
        async function saveApprovedImageToFirebase(exerciseName, svgData) {
             try {
                const docRef = doc(db, "approved_images", exerciseName);
                await setDoc(docRef, { svgData, approvedAt: new Date().toISOString() });
                showAlert(`Image for "${exerciseName}" approved and saved.`);
            } catch (error) {
                console.error("Error saving approved image:", error);
                showAlert("Could not save approved image.");
            }
        }
        
        async function saveRoutine() {
            if (!userId) { showAlert("Please log in to save routines."); return; }
            if (!currentRoutine) { showAlert("No routine to save."); return; }
            try {
                const routinesCol = collection(db, "users", userId, "routines");
                await addDoc(routinesCol, currentRoutine);
                showAlert("Routine saved successfully!");
            } catch (error) {
                console.error("Error saving routine: ", error);
                showAlert("Could not save routine.");
            }
        }

        async function loadSavedRoutines() {
            if (!userId) return;
            const routinesCol = collection(db, "users", userId, "routines");
            const savedList = document.getElementById('saved-routines-list');
            try {
                const routineSnapshot = await getDocs(routinesCol);
                savedList.innerHTML = routineSnapshot.empty ? '<p class="text-slate-500">You have no saved routines yet.</p>' : '';
                const routines = [];
                routineSnapshot.forEach(doc => routines.push({ id: doc.id, ...doc.data() }));
                routines.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                routines.forEach(routine => {
                    const routineEl = document.createElement('div');
                    routineEl.className = 'bg-white p-4 rounded-lg shadow-sm border cursor-pointer hover:border-indigo-500';
                    routineEl.innerHTML = `<h4 class="font-semibold text-lg">${routine.title}</h4><p class="text-xs text-slate-400">Saved: ${new Date(routine.createdAt).toLocaleDateString()}</p>`;
                    routineEl.addEventListener('click', async () => {
                        document.getElementById('routine-title').textContent = routine.title;
                        showView('results-section');
                        await renderRoutine(routine);
                    });
                    savedList.appendChild(routineEl);
                });
            } catch (error) {
                console.error("Error loading saved routines: ", error);
                savedList.innerHTML = `<p class="text-red-500">Could not load routines. Check connection.</p>`
            }
        }
    </script>
</body>
</html>
