<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Stretch Solution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Open Sans', sans-serif;
            font-size: 18px;
            line-height: 1.5;
            background-color: #f8fafc; /* slate-50 */
            color: #334155; /* slate-700 */
        }
        .custom-select, .custom-input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding: 0.75rem 1rem;
            width: 100%;
            background-color: white;
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.5rem;
        }
        .custom-select {
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="%2364748b" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-chevron-down" viewBox="0 0 24 24"><path d="m6 9 6 6 6-6"/></svg>');
            background-position: right 1rem center;
            background-repeat: no-repeat;
            background-size: 1em;
            padding-right: 2.5rem;
        }
        .view { display: none; }
        .view.active { display: block; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5; /* indigo-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #app-container {
            position: relative;
        }
        .custom-modal {
            display: none; 
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 850px; /* Increased modal width */
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .modal-button {
            background-color: #4f46e5;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 16px;
        }
        #details-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: #1e293b;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
         #details-content h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #334155;
        }
        #details-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
        }
        #details-content li {
            margin-bottom: 0.5rem;
        }
        #details-content p {
             margin-bottom: 0.75rem;
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f1f1f1;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
        }
        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }
        .dropdown-content a:hover {background-color: #ddd;}
        .dropdown:hover .dropdown-content {display: block;}

        .focus-tab {
            cursor: pointer;
            padding: 12px 16px;
            border-bottom: 3px solid transparent;
            color: #475569;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 1rem;
        }
        .focus-tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
        .focus-content {
            display: none;
        }
        .focus-content.active {
            display: block;
        }

        @media print {
            body.printing * {
                visibility: hidden;
            }
            body.printing #exercise-details-modal,
            body.printing #exercise-details-modal * {
                visibility: visible;
            }
            body.printing #exercise-details-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background-color: white !important;
                overflow: visible !important;
                display: block !important;
            }
            body.printing .modal-content {
                box-shadow: none !important;
                border: none !important;
                padding: 1rem !important;
                margin: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            body.printing #details-content {
                max-height: none !important;
                overflow: visible !important;
            }
            body.printing #details-close-btn,
            body.printing #print-details-btn,
            body.printing #details-youtube-buttons {
                display: none !important;
            }
        }
    </style>
</head>
<body>

    <!-- App Container -->
    <div id="app-container" class="min-h-screen flex flex-col">

        <!-- Header -->
        <header class="w-full bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky top-0 z-10">
            <div class="w-full flex justify-between items-center p-4 px-4 md:px-8">
                <div class="flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M16.465 16.465a5 5 0 1 0-7.07-7.07l7.07 7.07Z"/><path d="m10.243 19.314 5.303-5.303"/><path d="M14.121 15.536 12 17.657"/><path d="m12.687 12.687 5.303-5.303"/><path d="m8.808 11.879 2.121-2.121"/><path d="m7.364 7.364 5.303 5.303"/><path d="m2.05 2.05 5.303 5.303"/></svg>
                    <h1 class="text-2xl font-bold text-slate-900">The Stretch Solution</h1>
                </div>
                <nav class="hidden md:flex items-center space-x-6">
                    <a href="#" id="home-link" class="text-slate-600 hover:text-indigo-600 transition-colors">Home</a>
                    <a href="#" id="about-link" class="text-slate-600 hover:text-indigo-600 transition-colors">About</a>
                    <div class="dropdown">
                        <button class="text-slate-600 hover:text-indigo-600 transition-colors">Tools</button>
                        <div class="dropdown-content">
                            <a href="#" id="prompt-inspector-link">Prompt Inspector</a>
                        </div>
                    </div>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow w-full py-10 px-4 md:px-8">
            <div id="app-content" class="hidden">
                <!-- Creation Section -->
                <div id="creation-section" class="view active w-full mx-auto text-center">
                    <h2 class="text-4xl md:text-5xl font-bold tracking-tight text-slate-900">Intelligent Health Routines, Personalized for You</h2>
                    <p class="mt-4 text-lg text-slate-600 max-w-3xl mx-auto">Select your focus area and preferences, and let our AI create the perfect stretching or yoga routine for you.</p>
                    <div class="mt-10 p-6 md:p-8 bg-white border border-slate-200 rounded-xl shadow-sm max-w-7xl mx-auto">
                        
                        <div class="border-b border-slate-200 mb-6">
                            <nav id="focus-tabs-container" class="-mb-px flex flex-wrap justify-center gap-x-1 sm:gap-x-4">
                                <button class="focus-tab active" data-target="muscle-focus">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                                    <span>Muscle Group</span>
                                </button>
                                <button class="focus-tab" data-target="system-focus">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                    <span>Organ System</span>
                                </button>
                                <button class="focus-tab" data-target="pose-type-focus">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                    <span>Pose Type</span>
                                </button>
                                <button class="focus-tab" data-target="benefit-focus">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2z"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><path d="M9 9h.01"/><path d="M15 9h.01"/></svg>
                                    <span>Desired Benefit</span>
                                </button>
                                 <button class="focus-tab" data-target="chakra-focus">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10" /><path d="M12 2a10 10 0 0 0-10 10" /><path d="M12 22a10 10 0 0 1-10-10" /><path d="M2 12a10 10 0 0 1 10 10" /><path d="M22 12a10 10 0 0 0-10 10" /></svg>
                                    <span>Chakra System</span>
                                </button>
                                <button class="focus-tab" data-target="difficulty-focus">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
                                    <span>Difficulty Level</span>
                                </button>
                                <button class="focus-tab" data-target="movement-focus">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20.94c1.5 0 2.75 1.06 4 1.06 3 0 6-8 6-12.22A4.91 4.91 0 0 0 17 5c-1.5 0-2.25 1.06-4 1.06-2 0-2-1-4-1-3 0-6 8-6 12.22A4.91 4.91 0 0 0 7 17c1.5 0 2.25-1.06 4-1.06Z"/></svg>
                                    <span>Anatomical Movement</span>
                                </button>
                                <button class="focus-tab" data-target="props-focus">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></svg>
                                    <span>Props</span>
                                </button>
                                <button class="focus-tab" data-target="peak-pose-focus">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a4 4 0 0 0 4 4h0a4 4 0 0 0 4-4V3"/><path d="M12 10v11"/><path d="M6 8.5C6 7 7.5 3 12 3s6 4 6 5.5"/><path d="M2 14h20"/></svg>
                                    <span>Peak Pose Sequence</span>
                                </button>
                                <button class="focus-tab" data-target="ailment-focus">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l2 2"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m4.93 19.07 1.41-1.41"/><path d="m17.66 6.34 1.41-1.41"/></svg>
                                    <span>Ailment Relief</span>
                                </button>
                            </nav>
                        </div>

                        <div id="focus-content-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                           <div id="muscle-focus" class="focus-content active">
                                <label for="muscle-group-select" class="block text-sm font-medium text-slate-700 mb-1">Select Muscle Group</label>
                                <select id="muscle-group-select" class="custom-select"></select>
                           </div>
                           <div id="system-focus" class="focus-content">
                                <label for="organ-system-select" class="block text-sm font-medium text-slate-700 mb-1">Select Organ System</label>
                                <select id="organ-system-select" class="custom-select"></select>
                           </div>
                           <div id="pose-type-focus" class="focus-content">
                                <label for="pose-type-select" class="block text-sm font-medium text-slate-700 mb-1">Select Pose Type</label>
                                <select id="pose-type-select" class="custom-select"></select>
                           </div>
                           <div id="benefit-focus" class="focus-content">
                                <label for="benefit-select" class="block text-sm font-medium text-slate-700 mb-1">Select Desired Benefit</label>
                                <select id="benefit-select" class="custom-select"></select>
                           </div>
                           <div id="chakra-focus" class="focus-content">
                                <label for="chakra-select" class="block text-sm font-medium text-slate-700 mb-1">Select Chakra</label>
                                <select id="chakra-select" class="custom-select"></select>
                           </div>
                           <div id="difficulty-focus" class="focus-content">
                                <label for="difficulty-select" class="block text-sm font-medium text-slate-700 mb-1">Select Difficulty Level</label>
                                <select id="difficulty-select" class="custom-select"></select>
                           </div>
                           <div id="movement-focus" class="focus-content">
                                <label for="movement-select" class="block text-sm font-medium text-slate-700 mb-1">Select Anatomical Movement</label>
                                <select id="movement-select" class="custom-select"></select>
                           </div>
                           <div id="props-focus" class="focus-content">
                                <label for="props-select" class="block text-sm font-medium text-slate-700 mb-1">Select Prop</label>
                                <select id="props-select" class="custom-select"></select>
                           </div>
                           <div id="peak-pose-focus" class="focus-content">
                                <label for="peak-pose-input" class="block text-sm font-medium text-slate-700 mb-1">Enter a Peak Pose</label>
                                <input type="text" id="peak-pose-input" class="custom-input" placeholder="e.g., Crow Pose">
                           </div>
                            <div id="ailment-focus" class="focus-content">
                                <label for="ailment-input" class="block text-sm font-medium text-slate-700 mb-1">Enter Ailment for Relief</label>
                                <input type="text" id="ailment-input" class="custom-input" placeholder="e.g., Lower Back Pain">
                           </div>
                           <div>
                                <label for="exercises-select" class="block text-sm font-medium text-slate-700 mb-1">Number of Exercises</label>
                                <select id="exercises-select" class="custom-select"></select>
                           </div>
                        </div>
                        <div class="mt-8">
                            <button id="generate-btn" class="w-full md:w-auto px-10 py-4 text-lg font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all transform hover:scale-105">Generate My Routine</button>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results-section" class="view w-full mx-auto">
                    <div class="text-center mb-8 max-w-5xl mx-auto">
                         <h2 id="routine-title" class="text-3xl font-bold text-slate-900"></h2>
                    </div>
                    <div id="disclaimer-container" class="max-w-5xl mx-auto mb-6"></div>
                    <div id="loader-container" class="flex justify-center items-center h-64" style="display: none;"></div>
                    <div id="routine-list" class="space-y-6 max-w-5xl mx-auto"></div>
                     <div id="results-buttons" class="mt-8 flex flex-col sm:flex-row justify-center gap-4 hidden">
                        <button id="start-over-btn" class="px-6 py-3 text-base font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50">Start Over</button>
                    </div>
                </div>
                
                <!-- About Section -->
                <div id="about-section" class="view w-full mx-auto">
                    <h2 class="text-3xl font-bold text-slate-900 mb-6 max-w-5xl mx-auto">About The Stretch Solution</h2>
                    <div class="bg-white p-8 rounded-lg shadow-sm space-y-4 max-w-5xl mx-auto">
                        <p>This application leverages the Google Gemini API to generate dynamic and personalized health and stretching routines. Simply select a focus area—like a muscle group, organ system, pose type, or desired benefit—choose the number of exercises, and the AI will create a custom routine for you.</p>
                        <p>For each exercise, you can now search for a demonstration video on YouTube with a single click. If the initial search isn't perfect, a "Detailed Search" option uses more information from the AI to find a better match.</p>
                        <p>You can also click "More Details" on any exercise to get an in-depth guide, also generated by the AI. This approach ensures that the content is always fresh, relevant, and tailored to your specific needs.</p>
                    </div>
                </div>
                
                <!-- Prompt Inspector View -->
                <div id="prompt-inspector-section" class="view w-full mx-auto">
                    <div class="bg-white p-8 rounded-lg shadow-sm max-w-5xl mx-auto">
                        <h2 class="text-2xl font-bold text-slate-900 mb-4">AI Prompt Inspector</h2>
                        
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-slate-800 border-b pb-2 mb-3">Static Prompt Templates</h3>
                            <div id="static-prompts-container" class="space-y-4 text-sm"></div>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-slate-800 border-b pb-2 mb-3">Session Prompt & Response History</h3>
                            <div id="session-prompts-container" class="space-y-4 text-sm max-h-[60vh] overflow-y-auto">
                                <p class="text-slate-500">No prompts have been generated in this session yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center py-8 border-t border-slate-200 bg-white mt-auto">
             <div class="w-full px-4 md:px-8">
                 <p class="mt-4 text-xs text-slate-500 max-w-3xl mx-auto">
                    **Disclaimer:** The content provided by this application is for informational purposes only and is not intended as a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of your physician or other qualified health provider with any questions you may have regarding a medical condition. Use this application at your own risk.
                 </p>
                <p class="mt-4 text-xs text-slate-400">Version 8.8</p>
            </div>
        </footer>
        
        <!-- MODALS -->
        <div id="custom-alert-modal" class="custom-modal">
             <div class="modal-content text-center">
                <p id="modal-text" class="text-slate-700"></p>
                <button id="modal-close-btn" class="modal-button !mt-6 w-full">OK</button>
            </div>
        </div>
        
        <div id="exercise-details-modal" class="custom-modal">
             <div class="modal-content text-left">
                <div class="flex justify-between items-start">
                    <h3 id="details-title" class="text-xl font-semibold text-slate-900 mb-4"></h3>
                    <button id="print-details-btn" class="p-2 text-slate-500 hover:text-indigo-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                    </button>
                </div>
                 <div id="details-youtube-buttons" class="mb-4 flex flex-wrap gap-3"></div>
                <div id="details-content" class="text-slate-700 space-y-4 max-h-[50vh] overflow-y-auto pr-2"></div>
                <div class="mt-6 flex justify-end">
                    <button id="details-close-btn" class="modal-button w-auto">Close</button>
                </div>
            </div>
        </div>

        <div id="setup-modal" class="custom-modal" style="display: flex;">
            <div class="modal-content">
                 <h3 class="text-xl font-semibold mb-4">Application Setup</h3>
                <div class="text-left mb-4">
                    <label for="api-key-input" class="block text-sm font-medium text-slate-700">Gemini API Key (Required)</label>
                    <input type="password" id="api-key-input" class="mt-1 w-full p-2 border border-slate-300 rounded-lg" placeholder="Enter your Gemini API Key...">
                </div>
                <button id="start-app-btn" class="modal-button">Start Application</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        let geminiApiKey = null; 
        let isInitialized = false;
        let currentRoutine = [];
        let promptHistory = []; 

        // --- PROMPT TEMPLATES ---
        const PROMPT_TEMPLATES = {
            // Category Population Prompts
            getMuscleGroups: () => `When practicing yoga asanas (poses), what are all of the major and minor muscle groups that people commonly focus on? Return a JSON object with a single key 'muscleGroups'. This key should hold an array of objects. Each object must have two keys: 'displayName' (the common, user-friendly name, e.g., 'Hamstrings') and 'fullName' (the more technical name including specific muscles, e.g., 'Hamstrings - Biceps Femoris, Semitendinosus, Semimembranosus'). Provide an extensive list, ordered alphabetically by displayName.`,
            getOrganSystems: () => `When practicing yoga asanas (poses), what are all of the major and minor organ systems of the human body that people commonly believe are stimulated, supported, or positively impacted by the practice? Return a JSON object containing a single key 'organSystems' which is an array of strings. Each string should represent an organ system, formatted as 'Common Name - Technical Term(s)' if a common name exists, or just the technical term if it's widely recognized. Provide an extensive and exhaustive list, ordered alphabetically.`,
            getPoseTypes: () => `List the common categories of yoga asanas based on the physical action or position involved (e.g., 'Standing Poses', 'Backbends', 'Forward Bends', 'Twists', 'Inversions', 'Balancing Poses'). Return a JSON object with a single key 'poseTypes' which holds an array of these category names as strings. Provide a comprehensive list, ordered alphabetically.`,
            getDesiredBenefits: () => `What are the common therapeutic benefits or wellness goals that people seek to achieve through a yoga or stretching routine (e.g., 'Stress Relief', 'Improved Flexibility', 'Increased Energy', 'Better Sleep')? Return a JSON object with a single key 'benefits' which holds an array of these benefit-oriented goals as strings. The list should be comprehensive and ordered alphabetically.`,
            getChakras: () => `List the seven primary chakras in yogic philosophy. Return a JSON object with a key 'chakras' holding an array of strings (e.g., "Root Chakra - Muladhara"), ordered from the first to the seventh chakra.`,
            getAnatomicalMovements: () => `List common anatomical movements focused on in yoga (e.g., 'Hip Opening', 'Spinal Extension', 'Shoulder Flexion'). Return a JSON object with a key 'movements' holding an array of these strings, ordered alphabetically.`,
            getProps: () => `List common props used in yoga (e.g., 'Block', 'Strap', 'Bolster', 'Blanket'). Return a JSON object with a key 'props' holding an array of these strings, ordered alphabetically.`,
            
            // Routine Generation Prompts
            routine: (numExercises, focusArea) => `Create a balanced routine with exactly ${numExercises} yoga poses or exercises that primarily target or support the '${focusArea}'. For each item, provide a "name", brief step-by-step "instructions", and its single primary "benefit". Keep the instructions and benefit to 1-2 sentences each. The tone should be encouraging and informative.`,
            routineByProp: (numExercises, propName) => `Generate a routine of ${numExercises} yoga poses that can be effectively modified or supported using a '${propName}'. For each pose, provide a "name", "instructions" on how to use the prop, and the primary "benefit" of using the prop.`,
            peakPoseSequence: (numExercises, peakPose) => `Create a preparatory yoga sequence with exactly ${numExercises} poses to build towards the peak pose: '${peakPose}'. The sequence should be ordered logically to warm up the body. For each pose, provide a "name", "instructions", and a "preparation_focus" explaining how it prepares the body for the peak pose.`,
            ailmentRoutine: (ailment) => `Generate a list of yoga asanas commonly recommended for '${ailment}'. The tone must be supportive and cautious. Return a JSON object with two keys: 'disclaimer' and 'recommendedPoses'. The 'disclaimer' key must hold this exact string: "The following yoga poses are for informational purposes only and are not a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of your physician or other qualified health provider with any questions you may have regarding a medical condition. Stop any exercise that causes you pain or discomfort.". The 'recommendedPoses' key should hold an array of objects, each with 'name', brief step-by-step 'instructions', 'how_it_helps' (1-2 sentences), and 'contraindications' (e.g., 'High blood pressure').`,

            // Details Prompt
            details: (exerciseName) => `Provide a detailed guide for the yoga pose or topic "${exerciseName}". Include the following sections with clear headings using markdown ###: "Step-by-Step Instructions", "Key Benefits", and "Modifications and Precautions". Use bullet points for the benefits and modifications sections. The tone should be encouraging and informative, like a professional yoga guide.`,
        };

        // --- UI ELEMENTS MAPPING ---
        const ui = {
            appContent: document.getElementById('app-content'),
            setupModal: document.getElementById('setup-modal'),
            startAppBtn: document.getElementById('start-app-btn'),
            apiKeyInput: document.getElementById('api-key-input'),

            // Main UI
            focusTabsContainer: document.getElementById('focus-tabs-container'),
            exercisesSelect: document.getElementById('exercises-select'),
            generateBtn: document.getElementById('generate-btn'),
            routineList: document.getElementById('routine-list'),
            loaderContainer: document.getElementById('loader-container'),
            routineTitle: document.getElementById('routine-title'),
            resultsButtons: document.getElementById('results-buttons'),
            disclaimerContainer: document.getElementById('disclaimer-container'),
            
            // Selects & Inputs
            muscleGroupSelect: document.getElementById('muscle-group-select'),
            organSystemSelect: document.getElementById('organ-system-select'),
            poseTypeSelect: document.getElementById('pose-type-select'),
            benefitSelect: document.getElementById('benefit-select'),
            chakraSelect: document.getElementById('chakra-select'),
            difficultySelect: document.getElementById('difficulty-select'),
            movementSelect: document.getElementById('movement-select'),
            propsSelect: document.getElementById('props-select'),
            peakPoseInput: document.getElementById('peak-pose-input'),
            ailmentInput: document.getElementById('ailment-input'),

            // Nav
            homeLink: document.getElementById('home-link'),
            aboutLink: document.getElementById('about-link'),
            promptInspectorLink: document.getElementById('prompt-inspector-link'),
            startOverBtn: document.getElementById('start-over-btn'),

            // Prompt Inspector
            promptInspectorSection: document.getElementById('prompt-inspector-section'),
            staticPromptsContainer: document.getElementById('static-prompts-container'),
            sessionPromptsContainer: document.getElementById('session-prompts-container'),

            // Modals
            customAlertModal: document.getElementById('custom-alert-modal'),
            modalText: document.getElementById('modal-text'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            
            exerciseDetailsModal: document.getElementById('exercise-details-modal'),
            detailsTitle: document.getElementById('details-title'),
            detailsYoutubeButtons: document.getElementById('details-youtube-buttons'),
            detailsContent: document.getElementById('details-content'),
            detailsCloseBtn: document.getElementById('details-close-btn'),
            printDetailsBtn: document.getElementById('print-details-btn'),
        };
        
        // --- INITIALIZATION AND EVENT LISTENERS ---
        window.onload = () => {
            setupEventListeners();
        };
        
        function setupEventListeners() {
            ui.startAppBtn.addEventListener('click', initializeApp);
            ui.generateBtn.addEventListener('click', generateRoutine);
            ui.focusTabsContainer.addEventListener('click', handleTabClick);

            // Navigation
            ui.homeLink.addEventListener('click', (e) => { e.preventDefault(); showView('creation-section'); });
            ui.aboutLink.addEventListener('click', (e) => { e.preventDefault(); showView('about-section'); });
            ui.promptInspectorLink.addEventListener('click', (e) => {
                e.preventDefault();
                showView('prompt-inspector-section');
                populatePromptInspector();
            });
            ui.startOverBtn.addEventListener('click', () => showView('creation-section'));
            
            // Modal Buttons
            ui.modalCloseBtn.addEventListener('click', () => ui.customAlertModal.style.display = 'none');
            ui.detailsCloseBtn.addEventListener('click', () => ui.exerciseDetailsModal.style.display = 'none');
            ui.printDetailsBtn.addEventListener('click', () => {
                document.body.classList.add('printing');
                window.print();
                document.body.classList.remove('printing');
            });
        }
        
        async function initializeApp() {
            if (isInitialized) return;
            geminiApiKey = ui.apiKeyInput.value.trim();
            if (!geminiApiKey) {
                showAlert("Please provide a Gemini API Key.");
                return;
            }
            
            isInitialized = true;
            ui.appContent.style.display = 'block';
            ui.setupModal.style.display = 'none';

            populateStaticDropdowns();
            // Fire off all category population requests
            populateDropdown('getMuscleGroups', ui.muscleGroupSelect, 'muscleGroups', { valKey: 'fullName', textKey: 'displayName' });
            populateDropdown('getOrganSystems', ui.organSystemSelect, 'organSystems');
            populateDropdown('getPoseTypes', ui.poseTypeSelect, 'poseTypes');
            populateDropdown('getDesiredBenefits', ui.benefitSelect, 'benefits');
            populateDropdown('getChakras', ui.chakraSelect, 'chakras');
            populateDropdown('getAnatomicalMovements', ui.movementSelect, 'movements');
            populateDropdown('getProps', ui.propsSelect, 'props');
        }

        function logPrompt(type, prompt, response) {
            promptHistory.unshift({ type, prompt, response, timestamp: new Date() });
            if (promptHistory.length > 50) promptHistory.pop();
        }

        // --- DYNAMIC UI POPULATION ---
        function populateStaticDropdowns() {
            const counts = [3, 5, 7, 10, 12, 15, 20];
            ui.exercisesSelect.innerHTML = counts.map(c => `<option value="${c}">${c} Exercises</option>`).join('');
            
            const difficulties = ['Beginner', 'Intermediate', 'Advanced'];
            ui.difficultySelect.innerHTML = `<option value="">-- Select a Level --</option>` + difficulties.map(d => `<option value="${d}">${d}</option>`).join('');
        }
        
        async function populateDropdown(promptKey, selectElement, responseKey, options = {}) {
            const { valKey = null, textKey = null } = options;
            selectElement.disabled = true;
            selectElement.innerHTML = `<option>🤖 Asking AI...</option>`;
            try {
                const prompt = PROMPT_TEMPLATES[promptKey]();
                
                // Define the schema based on the prompt type to ensure correct API request
                let itemsSchema;
                if (promptKey === 'getMuscleGroups') {
                    // This prompt returns an array of objects
                    itemsSchema = {
                        type: "OBJECT",
                        properties: {
                            displayName: { type: "STRING" },
                            fullName: { type: "STRING" }
                        },
                        required: ["displayName", "fullName"]
                    };
                } else {
                    // All other dropdowns expect a simple array of strings
                    itemsSchema = { type: "STRING" };
                }

                const schema = {
                    type: "OBJECT",
                    properties: {
                        [responseKey]: {
                            type: "ARRAY",
                            items: itemsSchema
                        }
                    },
                    required: [responseKey]
                };

                const response = await callGeminiAPI(promptKey, prompt, schema);
                const items = response[responseKey];
                
                selectElement.innerHTML = `<option value="">-- Select an Option --</option>`;
                items.forEach(item => {
                    const value = valKey ? item[valKey] : item;
                    const text = textKey ? item[textKey] : item;
                    selectElement.add(new Option(text, value));
                });
                selectElement.disabled = false;
            } catch (error) {
                console.error(`Error populating ${promptKey}:`, error);
                selectElement.innerHTML = `<option>Error loading data</option>`;
                showAlert(`Could not load data for ${promptKey.replace('get', '')}. ${error.message}`);
            }
        }

        // --- ROUTINE GENERATION & DISPLAY ---
        async function generateRoutine() {
            const activeTab = ui.focusTabsContainer.querySelector('.active');
            const targetId = activeTab.dataset.target;
            const numExercises = ui.exercisesSelect.value;
            
            let focusArea = '';
            let selectedText = '';
            let prompt = '';
            let schema = null;
            let responseProcessor = (response) => response.exercises || response.peakPoseSequence || response.recommendedPoses;

            // Define reusable schemas for exercise objects
            const baseExerciseSchema = {
                type: "OBJECT",
                properties: { name: { type: "STRING" }, instructions: { type: "STRING" }, benefit: { type: "STRING" } },
                required: ["name", "instructions", "benefit"]
            };
            const peakPoseExerciseSchema = {
                type: "OBJECT",
                properties: { name: { type: "STRING" }, instructions: { type: "STRING" }, preparation_focus: { type: "STRING" } },
                required: ["name", "instructions", "preparation_focus"]
            };
            const ailmentExerciseSchema = {
                type: "OBJECT",
                properties: { name: { type: "STRING" }, instructions: { type: "STRING" }, how_it_helps: { type: "STRING" }, contraindications: { type: "STRING" } },
                required: ["name", "instructions", "how_it_helps", "contraindications"]
            };

            // Determine the focus area and prompt based on the active tab
            switch (targetId) {
                case 'ailment-focus':
                    focusArea = ui.ailmentInput.value.trim();
                    selectedText = focusArea;
                    prompt = PROMPT_TEMPLATES.ailmentRoutine(focusArea);
                    schema = { type: "OBJECT", properties: { disclaimer: { type: "STRING" }, recommendedPoses: { type: "ARRAY", items: ailmentExerciseSchema }}, required: ["disclaimer", "recommendedPoses"] };
                    responseProcessor = (response) => {
                        ui.disclaimerContainer.innerHTML = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert"><p class="font-bold">Important Disclaimer</p><p>${response.disclaimer}</p></div>`;
                        return response.recommendedPoses;
                    };
                    break;
                case 'peak-pose-focus':
                    focusArea = ui.peakPoseInput.value.trim();
                    selectedText = focusArea;
                    prompt = PROMPT_TEMPLATES.peakPoseSequence(numExercises, focusArea);
                    schema = { type: "OBJECT", properties: { peakPoseSequence: { type: "ARRAY", items: peakPoseExerciseSchema }}, required: ["peakPoseSequence"] };
                    responseProcessor = (response) => response.peakPoseSequence;
                    break;
                case 'props-focus':
                    focusArea = ui.propsSelect.value;
                    selectedText = ui.propsSelect.options[ui.propsSelect.selectedIndex].text;
                    prompt = PROMPT_TEMPLATES.routineByProp(numExercises, focusArea);
                    schema = { type: "OBJECT", properties: { exercises: { type: "ARRAY", items: baseExerciseSchema }}, required: ["exercises"] };
                    break;
                default:
                    // Generic handler for simple dropdown-based routines
                    const selectElement = document.getElementById(targetId.replace('-focus', '-select'));
                    focusArea = selectElement.value;
                    selectedText = selectElement.options[selectElement.selectedIndex].text;
                    let routineType = (targetId === 'difficulty-focus') ? `poses for a ${focusArea} practitioner` : focusArea;
                    prompt = PROMPT_TEMPLATES.routine(numExercises, routineType);
                    schema = { type: "OBJECT", properties: { exercises: { type: "ARRAY", items: baseExerciseSchema }}, required: ["exercises"] };
            }

            if (!focusArea) {
                showAlert(`Please select or enter a value for the active tab.`);
                return;
            }

            showView('results-section');
            ui.routineList.innerHTML = '';
            ui.disclaimerContainer.innerHTML = ''; // Clear previous disclaimers
            ui.loaderContainer.innerHTML = '<div class="loader"></div>';
            ui.loaderContainer.style.display = 'flex';
            ui.resultsButtons.classList.add('hidden');
            ui.routineTitle.textContent = `Generating Your Routine for ${selectedText}...`;

            try {
                const response = await callGeminiAPI("Routine Generation", prompt, schema);
                currentRoutine = responseProcessor(response);
                ui.routineTitle.textContent = `Your Custom Routine for ${selectedText}`;
                renderRoutine(currentRoutine, targetId);
            } catch (error) {
                console.error("Error generating routine:", error);
                ui.routineTitle.textContent = "Generation Failed";
                ui.routineList.innerHTML = `<div class="bg-red-100 border border-red-200 p-4 rounded-lg text-center text-red-700"><p><strong>Oops!</strong> ${error.message}</p><p class="mt-2 text-sm">The AI could not generate a routine. Please try different selections.</p></div>`;
            } finally {
                ui.loaderContainer.style.display = 'none';
                ui.resultsButtons.classList.remove('hidden');
            }
        }
        
        function renderRoutine(exercises, routineType) {
            ui.routineList.innerHTML = '';
            if (!exercises || exercises.length === 0) {
                ui.routineList.innerHTML = `<div class="bg-yellow-100 p-4 rounded-lg text-center text-yellow-700"><p>The AI was unable to generate a routine with the provided criteria. Please try again.</p></div>`;
                return;
            }
            exercises.forEach((exercise, index) => {
                const exerciseEl = document.createElement('div');
                exerciseEl.className = 'bg-white border border-slate-200 rounded-xl shadow-sm p-6';
                
                const sanitizedInstructions = (exercise.instructions || '').replace(/"/g, '&quot;');
                
                let benefitHtml = '';
                if (routineType === 'ailment-focus') {
                    benefitHtml = `
                        <div><h4 class="font-semibold text-slate-800">How it Helps:</h4><p class="mt-1">${exercise.how_it_helps || 'Not specified.'}</p></div>
                        <div><h4 class="font-semibold text-red-600 mt-2">Contraindications:</h4><p class="mt-1 text-red-600">${exercise.contraindications || 'None specified.'}</p></div>
                    `;
                } else {
                    const benefitLabel = (routineType === 'peak-pose-focus') ? 'Preparation Focus' : 'Benefit';
                    const benefitText = exercise.benefit || exercise.preparation_focus || 'Not specified.';
                    benefitHtml = `<div><h4 class="font-semibold text-slate-800">${benefitLabel}:</h4><p class="mt-1">${benefitText}</p></div>`;
                }

                exerciseEl.innerHTML = `
                    <div>
                        <h3 class="text-xl font-semibold text-slate-900">${exercise.name} ${exercise.sanskrit_name ? `(${exercise.sanskrit_name})` : ''}</h3>
                        <div class="mt-4 space-y-4">
                            <div><h4 class="font-semibold text-slate-800">Instructions:</h4><p class="mt-1 whitespace-pre-line">${exercise.instructions || 'No instructions provided.'}</p></div>
                            ${benefitHtml}
                        </div>
                        <div class="mt-6 pt-4 border-t border-slate-200 flex flex-wrap gap-4">
                           <button data-exercise-name="${exercise.name}" class="youtube-search-btn text-sm font-medium text-indigo-600 hover:text-indigo-800">Search Video (Simple) &rarr;</button>
                           <button data-exercise-name="${exercise.name}" data-exercise-instructions="${sanitizedInstructions}" class="youtube-search-detailed-btn text-sm font-medium text-green-600 hover:text-green-800">Search Video (Detailed) &rarr;</button>
                           <button data-index="${index}" class="details-btn text-sm font-medium text-slate-600 hover:text-slate-800">More Details &rarr;</button>
                        </div>
                    </div>
                `;
                ui.routineList.appendChild(exerciseEl);
            });
            
            document.querySelectorAll('.details-btn').forEach(btn => {
                btn.addEventListener('click', () => showExerciseDetails(btn.dataset.index));
            });
            document.querySelectorAll('.youtube-search-btn').forEach(btn => {
                btn.addEventListener('click', () => searchYouTubeSimple(btn.dataset.exerciseName));
            });
            document.querySelectorAll('.youtube-search-detailed-btn').forEach(btn => {
                btn.addEventListener('click', () => searchYouTubeDetailed(btn.dataset.exerciseName, btn.dataset.exerciseInstructions));
            });
        }
                
        async function showExerciseDetails(index) {
            const exercise = currentRoutine[index];
            if (!exercise) return;

            ui.detailsTitle.textContent = exercise.name;
            ui.detailsContent.innerHTML = '<div class="flex justify-center items-center h-32"><div class="loader"></div></div>';
            
            const sanitizedInstructions = (exercise.instructions || '').replace(/"/g, '&quot;');
            ui.detailsYoutubeButtons.innerHTML = `
                <button data-exercise-name="${exercise.name}" class="youtube-search-btn text-sm font-medium text-indigo-600 hover:text-indigo-800">Search Video (Simple) &rarr;</button>
                <button data-exercise-name="${exercise.name}" data-exercise-instructions="${sanitizedInstructions}" class="youtube-search-detailed-btn text-sm font-medium text-green-600 hover:text-green-800">Search Video (Detailed) &rarr;</button>
            `;
            ui.detailsYoutubeButtons.querySelector('.youtube-search-btn').addEventListener('click', (e) => searchYouTubeSimple(e.target.dataset.exerciseName));
            ui.detailsYoutubeButtons.querySelector('.youtube-search-detailed-btn').addEventListener('click', (e) => searchYouTubeDetailed(e.target.dataset.exerciseName, e.target.dataset.exerciseInstructions));

            ui.exerciseDetailsModal.style.display = 'flex';

            try {
                 const prompt = PROMPT_TEMPLATES.details(exercise.name);
                 const detailedContent = await callGeminiAPI("Detailed View", prompt, null, false);
                 ui.detailsContent.innerHTML = marked.parse(detailedContent);
            } catch (error) {
                 ui.detailsContent.innerHTML = `<p class="text-red-600">Could not load details. ${error.message}</p>`;
            }
        }

        function populatePromptInspector() {
            ui.staticPromptsContainer.innerHTML = '';
            for (const key in PROMPT_TEMPLATES) {
                const el = document.createElement('div');
                el.className = 'p-2 bg-slate-100 rounded';
                el.innerHTML = `
                    <h4 class="font-semibold text-slate-700">${key.charAt(0).toUpperCase() + key.slice(1)} Template</h4>
                    <pre class="whitespace-pre-wrap text-xs text-slate-600">${PROMPT_TEMPLATES[key].toString()}</pre>
                `;
                ui.staticPromptsContainer.appendChild(el);
            }

            ui.sessionPromptsContainer.innerHTML = '';
            if(promptHistory.length === 0) {
                 ui.sessionPromptsContainer.innerHTML = '<p class="text-slate-500">No prompts have been generated in this session yet.</p>';
                 return;
            }
            promptHistory.forEach(p => {
                 const el = document.createElement('div');
                el.className = 'p-4 bg-slate-50 rounded-lg border';
                const sanitizedResponse = String(p.response).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                el.innerHTML = `
                    <h4 class="font-semibold text-slate-800">${p.type} <span class="text-xs font-normal text-slate-500">- ${p.timestamp.toLocaleTimeString()}</span></h4>
                    <div class="mt-2">
                        <h5 class="font-semibold text-sm text-slate-600">Prompt Sent:</h5>
                        <pre class="mt-1 p-2 bg-slate-200 rounded text-xs whitespace-pre-wrap">${p.prompt}</pre>
                    </div>
                     <div class="mt-2">
                        <h5 class="font-semibold text-sm text-slate-600">Response Received:</h5>
                        <pre class="mt-1 p-2 bg-blue-50 border border-blue-200 rounded text-xs whitespace-pre-wrap">${sanitizedResponse}</pre>
                    </div>
                `;
                ui.sessionPromptsContainer.appendChild(el);
            });
        }


        // --- CORE API CALLER ---
        async function callGeminiAPI(type, prompt, schema = null, expectJson = true) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };

            if (schema) {
                payload.generationConfig = { responseMimeType: "application/json", responseSchema: schema };
            }

            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();

            if (!response.ok) {
                const errorText = result.error ? result.error.message : JSON.stringify(result);
                logPrompt(type + ' (Error)', prompt, errorText);
                throw new Error(`AI processing failed: ${errorText}`);
            }
            
            if (!result.candidates?.[0]?.content?.parts) {
                logPrompt(type + ' (Error)', prompt, 'Invalid response structure from AI.');
                throw new Error("Invalid response structure from AI.");
            }

            const responseText = result.candidates[0].content.parts[0].text;
            logPrompt(type, prompt, responseText);
            
            if (expectJson) {
                try {
                    return JSON.parse(responseText);
                } catch (e) {
                    console.error("Failed to parse AI JSON response:", responseText, e);
                    throw new Error("AI returned invalid JSON format.");
                }
            }
            return responseText;
        }

        // --- UTILITY FUNCTIONS ---
        function searchYouTubeSimple(exerciseName) {
            const cleanExerciseName = exerciseName.replace(/\s*\(.*\)\s*/, '').trim();
            const query = `How to do ${cleanExerciseName} yoga pose`;
            const youtubeSearchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
            window.open(youtubeSearchUrl, '_blank');
        }

        function searchYouTubeDetailed(name, instructions) {
            const cleanName = name.replace(/\s*\(.*\)\s*/, '').trim();
            const detailedQuery = `${cleanName} yoga pose tutorial ${instructions}`;
            const youtubeSearchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(detailedQuery)}`;
            window.open(youtubeSearchUrl, '_blank');
        }

        function handleTabClick(e) {
            const tabButton = e.target.closest('.focus-tab');
            if (tabButton) {
                const target = tabButton.dataset.target;
                
                ui.focusTabsContainer.querySelectorAll('.focus-tab').forEach(tab => tab.classList.remove('active'));
                tabButton.classList.add('active');
                
                document.querySelectorAll('.focus-content').forEach(content => content.classList.remove('active'));
                document.getElementById(target).classList.add('active');
            }
        }

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.style.display = view.id === viewId ? 'block' : 'none';
            });
            window.scrollTo(0,0);
        }
        
        function showAlert(message) {
            ui.modalText.textContent = message;
            ui.customAlertModal.style.display = 'flex';
        }
    </script>
</body>
</html>
