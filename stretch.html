<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Stretch Solution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .custom-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="%2364748b" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-chevron-down" viewBox="0 0 24 24"><path d="m6 9 6 6 6-6"/></svg>');
            background-position: right 1rem center;
            background-repeat: no-repeat;
            background-size: 1em;
            padding-right: 2.5rem;
        }
        .view { display: none; }
        .view.active { display: block; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5; /* indigo-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .custom-modal {
            display: none; 
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 650px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .modal-button {
            background-color: #4f46e5;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 16px;
        }
        #details-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: #1e293b;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
         #details-content h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #334155;
        }
        #details-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
            line-height: 1.6;
        }
        #details-content li {
            margin-bottom: 0.5rem;
        }
        #details-content p {
             margin-bottom: 0.75rem;
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f1f1f1;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
        }
        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }
        .dropdown-content a:hover {background-color: #ddd;}
        .dropdown:hover .dropdown-content {display: block;}

        .focus-tab {
            cursor: pointer;
            padding: 8px 16px;
            border-bottom: 2px solid transparent;
            color: #475569;
        }
        .focus-tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
            font-weight: 600;
        }
        .focus-content {
            display: none;
        }
        .focus-content.active {
            display: block;
        }


         @media print {
            body.is-printing > *:not(#exercise-details-modal) {
                display: none !important;
            }
            body.is-printing #exercise-details-modal {
                display: flex !important;
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
            }
            body.is-printing .modal-content {
                box-shadow: none !important;
                border: none !important;
                width: 100% !important;
                max-width: 100% !important;
                padding: 1rem !important;
                margin: 0 !important;
            }
            body.is-printing #details-content {
                max-height: none !important;
                overflow: visible !important;
            }
            body.is-printing #details-close-btn, body.is-printing #print-details-btn {
                display: none !important;
            }
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- App Container -->
    <div class="min-h-screen flex flex-col">

        <!-- Header -->
        <header class="w-full bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky top-0 z-10">
            <div class="w-full flex justify-between items-center p-4 px-4 md:px-8">
                <div class="flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M16.465 16.465a5 5 0 1 0-7.07-7.07l7.07 7.07Z"/><path d="m10.243 19.314 5.303-5.303"/><path d="M14.121 15.536 12 17.657"/><path d="m12.687 12.687 5.303-5.303"/><path d="m8.808 11.879 2.121-2.121"/><path d="m7.364 7.364 5.303 5.303"/><path d="m2.05 2.05 5.303 5.303"/></svg>
                    <h1 class="text-2xl font-bold text-slate-900">The Stretch Solution</h1>
                </div>
                <nav class="hidden md:flex items-center space-x-6">
                    <a href="#" id="home-link" class="text-slate-600 hover:text-indigo-600 transition-colors">Home</a>
                    <a href="#" id="about-link" class="text-slate-600 hover:text-indigo-600 transition-colors">About</a>
                    <div class="dropdown">
                        <button class="text-slate-600 hover:text-indigo-600 transition-colors">Tools</button>
                        <div class="dropdown-content">
                            <a href="#" id="prompt-inspector-link">Prompt Inspector</a>
                        </div>
                    </div>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow w-full py-10 px-4 md:px-8">
            <div id="app-content" class="hidden">
                <!-- Creation Section -->
                <div id="creation-section" class="view active w-full mx-auto text-center">
                    <h2 class="text-4xl md:text-5xl font-bold tracking-tight text-slate-900">Intelligent Health Routines, Personalized for You</h2>
                    <p class="mt-4 text-lg text-slate-600 max-w-2xl mx-auto">Select your focus and preferences to begin your custom routine.</p>
                    <div class="mt-10 p-6 md:p-8 bg-white border border-slate-200 rounded-xl shadow-sm max-w-5xl mx-auto">
                        
                        <div class="border-b border-slate-200 mb-6">
                            <nav id="focus-tabs-container" class="-mb-px flex justify-center gap-x-6">
                                <button class="focus-tab active" data-target="muscle-focus">1. By Muscle Group</button>
                                <button class="focus-tab" data-target="system-focus">1. By Organ System</button>
                            </nav>
                        </div>

                        <div id="focus-content-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                           <div id="muscle-focus" class="focus-content active">
                                <label for="muscle-group-select" class="block text-sm font-medium text-slate-700 mb-1">Select Muscle Group</label>
                                <select id="muscle-group-select" class="custom-select w-full p-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option>Loading...</option>
                                </select>
                           </div>
                           <div id="system-focus" class="focus-content">
                                <label for="organ-system-select" class="block text-sm font-medium text-slate-700 mb-1">Select Organ System</label>
                                <select id="organ-system-select" class="custom-select w-full p-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option>Loading...</option>
                                </select>
                           </div>
                             <div>
                                <label for="exercises-select" class="block text-sm font-medium text-slate-700 mb-1">2. # of Exercises</label>
                                <select id="exercises-select" class="custom-select w-full p-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
                            </div>
                        </div>
                        <div class="mt-8">
                            <button id="generate-btn" class="w-full md:w-auto px-10 py-4 text-lg font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all transform hover:scale-105">Generate My Routine</button>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results-section" class="view w-full mx-auto">
                    <div class="text-center mb-8 max-w-5xl mx-auto">
                         <h2 id="routine-title" class="text-3xl font-bold text-slate-900"></h2>
                    </div>
                    <div id="loader-container" class="flex justify-center items-center h-64" style="display: none;"></div>
                    <div id="routine-list" class="space-y-6 max-w-5xl mx-auto"></div>
                     <div id="results-buttons" class="mt-8 flex flex-col sm:flex-row justify-center gap-4 hidden">
                        <button id="start-over-btn" class="px-6 py-3 text-base font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50">Start Over</button>
                    </div>
                </div>
                
                <!-- About Section -->
                <div id="about-section" class="view w-full mx-auto">
                    <h2 class="text-3xl font-bold text-slate-900 mb-6 max-w-5xl mx-auto">About The Stretch Solution</h2>
                    <div class="bg-white p-8 rounded-lg shadow-sm space-y-4 text-slate-600 max-w-5xl mx-auto">
                        <p>This application leverages the Google Gemini API to generate dynamic and personalized health and stretching routines. Simply select a muscle group you'd like to focus on, choose the number of exercises, and the AI will create a custom routine for you.</p>
                        <p>You can click "More Details" on any exercise to get an in-depth guide, also generated by the AI. This approach ensures that the content is always fresh, relevant, and tailored to your specific needs.</p>
                    </div>
                </div>
                
                <!-- Prompt Inspector View -->
                <div id="prompt-inspector-section" class="view w-full mx-auto">
                    <div class="bg-white p-8 rounded-lg shadow-sm max-w-5xl mx-auto">
                        <h2 class="text-2xl font-bold text-slate-900 mb-4">AI Prompt Inspector</h2>
                        
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-slate-800 border-b pb-2 mb-3">Static Prompt Templates</h3>
                            <div id="static-prompts-container" class="space-y-4 text-sm"></div>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-slate-800 border-b pb-2 mb-3">Session Prompt & Response History</h3>
                            <div id="session-prompts-container" class="space-y-4 text-sm max-h-[60vh] overflow-y-auto">
                                <p class="text-slate-500">No prompts have been generated in this session yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center py-8 border-t border-slate-200 bg-white mt-auto">
             <div class="w-full px-4 md:px-8">
                 <p class="mt-4 text-xs text-slate-500 max-w-3xl mx-auto">
                    **Disclaimer:** The content provided by this application is for informational purposes only and is not intended as a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of your physician or other qualified health provider with any questions you may have regarding a medical condition. Use this application at your own risk.
                 </p>
                <p class="mt-4 text-xs text-slate-400">Version 7.3</p>
            </div>
        </footer>
        
        <!-- MODALS -->
        <div id="custom-alert-modal" class="custom-modal">
             <div class="modal-content text-center">
                <p id="modal-text" class="text-slate-700"></p>
                <button id="modal-close-btn" class="modal-button !mt-6 w-full">OK</button>
            </div>
        </div>
        
        <div id="exercise-details-modal" class="custom-modal">
             <div class="modal-content text-left">
                <div class="flex justify-between items-start">
                    <h3 id="details-title" class="text-xl font-semibold text-slate-900 mb-4"></h3>
                    <button id="print-details-btn" class="p-2 text-slate-500 hover:text-indigo-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                    </button>
                </div>
                <div id="details-image-container" class="mb-4"></div>
                <div id="details-content" class="text-slate-700 space-y-4 max-h-[50vh] overflow-y-auto pr-2"></div>
                <div class="mt-6 flex justify-end">
                    <button id="details-close-btn" class="modal-button w-auto">Close</button>
                </div>
            </div>
        </div>

        <div id="setup-modal" class="custom-modal" style="display: flex;">
            <div class="modal-content">
                 <h3 class="text-xl font-semibold mb-4">Application Setup</h3>
                <div class="text-left mb-4">
                    <label for="api-key-input" class="block text-sm font-medium text-slate-700">Gemini API Key (Required)</label>
                    <input type="password" id="api-key-input" class="mt-1 w-full p-2 border border-slate-300 rounded-lg" placeholder="Enter your Gemini API Key...">
                </div>
                <button id="start-app-btn" class="modal-button">Start Application</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        let geminiApiKey = null; 
        let isInitialized = false;
        let currentRoutine = [];
        let promptHistory = []; 
        let imageCache = {};

        // --- PROMPT TEMPLATES ---
        const PROMPT_TEMPLATES = {
            muscleGroups: () => `When practicing yoga asanas (poses), what are all of the major and minor muscle groups that people commonly focus on? Return a JSON object with a single key 'muscleGroups'. This key should hold an array of objects. Each object must have two keys: 'displayName' (the common, user-friendly name, e.g., 'Hamstrings') and 'fullName' (the more technical name including specific muscles, e.g., 'Hamstrings - Biceps Femoris, Semitendinosus, Semimembranosus'). Provide an extensive list, ordered alphabetically by displayName.`,
            organSystems: () => `When practicing yoga asanas (poses), what are all of the major and minor organ systems of the human body that people commonly believe are stimulated, supported, or positively impacted by the practice? Return a JSON object containing a single key 'yogaOrganSystemFocus' which is an array of strings. Each string should represent an organ system, formatted as 'Common Name - Technical Term(s)' if a common name exists, or just the technical term if it's widely recognized. Provide an extensive and exhaustive list, ordered alphabetically.`,
            routine: (numExercises, focusArea) => `Create a balanced routine with exactly ${numExercises} yoga poses or exercises that primarily target or support the '${focusArea}'. For each item, provide a "name", brief step-by-step "instructions", and its single primary "benefit". Keep the instructions and benefit to 1-2 sentences each. The tone should be encouraging and informative.`,
            details: (exerciseName) => `Provide a detailed guide for the yoga pose or topic "${exerciseName}". Include the following sections with clear headings using markdown ###: "Step-by-Step Instructions", "Key Benefits", and "Modifications and Precautions". Use bullet points for the benefits and modifications sections. The tone should be encouraging and informative, like a professional yoga guide.`,
            imageGeneration: (exerciseName) => `A clear, minimalist vector illustration of a person performing the yoga pose: '${exerciseName}'. The style should be clean line art with subtle, calming color accents like #4f46e5. The figure should be gender-neutral and depicted on a simple yoga mat against a plain, light gray background (#f3f4f6). Focus on anatomically correct form and clarity. Square aspect ratio.`
        };

        // --- UI ELEMENTS MAPPING ---
        const ui = {
            appContent: document.getElementById('app-content'),
            setupModal: document.getElementById('setup-modal'),
            startAppBtn: document.getElementById('start-app-btn'),
            apiKeyInput: document.getElementById('api-key-input'),

            // Main UI
            focusTabsContainer: document.getElementById('focus-tabs-container'),
            muscleGroupSelect: document.getElementById('muscle-group-select'),
            organSystemSelect: document.getElementById('organ-system-select'),
            exercisesSelect: document.getElementById('exercises-select'),
            generateBtn: document.getElementById('generate-btn'),
            routineList: document.getElementById('routine-list'),
            loaderContainer: document.getElementById('loader-container'),
            routineTitle: document.getElementById('routine-title'),
            resultsButtons: document.getElementById('results-buttons'),
            
            // Nav
            homeLink: document.getElementById('home-link'),
            aboutLink: document.getElementById('about-link'),
            promptInspectorLink: document.getElementById('prompt-inspector-link'),
            startOverBtn: document.getElementById('start-over-btn'),

            // Prompt Inspector
            promptInspectorSection: document.getElementById('prompt-inspector-section'),
            staticPromptsContainer: document.getElementById('static-prompts-container'),
            sessionPromptsContainer: document.getElementById('session-prompts-container'),

            // Modals
            customAlertModal: document.getElementById('custom-alert-modal'),
            modalText: document.getElementById('modal-text'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            
            exerciseDetailsModal: document.getElementById('exercise-details-modal'),
            detailsTitle: document.getElementById('details-title'),
            detailsImageContainer: document.getElementById('details-image-container'),
            detailsContent: document.getElementById('details-content'),
            detailsCloseBtn: document.getElementById('details-close-btn'),
            printDetailsBtn: document.getElementById('print-details-btn'),
        };
        
        // --- INITIALIZATION AND EVENT LISTENERS ---
        window.onload = () => {
            setupEventListeners();
        };
        
        function setupEventListeners() {
            ui.startAppBtn.addEventListener('click', initializeApp);
            ui.generateBtn.addEventListener('click', generateRoutine);
            ui.focusTabsContainer.addEventListener('click', handleTabClick);

            // Navigation
            ui.homeLink.addEventListener('click', (e) => { e.preventDefault(); showView('creation-section'); });
            ui.aboutLink.addEventListener('click', (e) => { e.preventDefault(); showView('about-section'); });
            ui.promptInspectorLink.addEventListener('click', (e) => {
                e.preventDefault();
                showView('prompt-inspector-section');
                populatePromptInspector();
            });
            ui.startOverBtn.addEventListener('click', () => showView('creation-section'));
            
            // Modal Buttons
            ui.modalCloseBtn.addEventListener('click', () => ui.customAlertModal.style.display = 'none');
            ui.detailsCloseBtn.addEventListener('click', () => ui.exerciseDetailsModal.style.display = 'none');
            ui.printDetailsBtn.addEventListener('click', () => {
                document.body.classList.add('is-printing');
                setTimeout(() => {
                    window.print();
                    document.body.classList.remove('is-printing');
                }, 100);
            });
        }
        
        async function initializeApp() {
            if (isInitialized) return;
            geminiApiKey = ui.apiKeyInput.value.trim();
            if (!geminiApiKey) {
                showAlert("Please provide a Gemini API Key.");
                return;
            }
            
            isInitialized = true;
            ui.appContent.style.display = 'block';
            ui.setupModal.style.display = 'none';

            populateStaticDropdowns();
            populateMuscleGroupDropdown();
            populateOrganSystemDropdown();
        }

        function logPrompt(type, prompt, response) {
            promptHistory.unshift({ type, prompt, response, timestamp: new Date() });
            if (promptHistory.length > 50) promptHistory.pop();
        }

        // --- DYNAMIC UI POPULATION ---
        function populateStaticDropdowns() {
            const counts = [3, 5, 7, 10];
            ui.exercisesSelect.innerHTML = counts.map(c => `<option value="${c}">${c} Exercises</option>`).join('');
        }

        async function populateMuscleGroupDropdown() {
            ui.muscleGroupSelect.disabled = true;
            ui.muscleGroupSelect.innerHTML = `<option>ðŸ¤– Asking AI...</option>`;
            try {
                const prompt = PROMPT_TEMPLATES.muscleGroups();
                const schema = { type: "OBJECT", properties: { "muscleGroups": { type: "ARRAY", items: { type: "OBJECT", properties: { "displayName": { "type": "STRING" }, "fullName": { "type": "STRING" } }, required: ["displayName", "fullName"] }}}, required: ["muscleGroups"] };
                const response = await callGeminiAPI("Muscle Groups", prompt, schema);
                const muscleGroups = response.muscleGroups;
                ui.muscleGroupSelect.innerHTML = `<option value="">-- Select a Focus Area --</option>`;
                muscleGroups.forEach(group => {
                    ui.muscleGroupSelect.add(new Option(group.displayName, group.fullName));
                });
                ui.muscleGroupSelect.disabled = false;
            } catch (error) {
                console.error("Error populating muscle groups:", error);
                ui.muscleGroupSelect.innerHTML = `<option>Error loading data</option>`;
                showAlert(`Could not load muscle groups from the AI. ${error.message}`);
            }
        }

        async function populateOrganSystemDropdown() {
            ui.organSystemSelect.disabled = true;
            ui.organSystemSelect.innerHTML = `<option>ðŸ¤– Asking AI...</option>`;
            try {
                const prompt = PROMPT_TEMPLATES.organSystems();
                const schema = { type: "OBJECT", properties: { "yogaOrganSystemFocus": { type: "ARRAY", items: { type: "STRING" } } }, required: ["yogaOrganSystemFocus"] };
                const response = await callGeminiAPI("Organ Systems", prompt, schema);
                const organSystems = response.yogaOrganSystemFocus;
                ui.organSystemSelect.innerHTML = `<option value="">-- Select a System --</option>`;
                organSystems.forEach(system => {
                    ui.organSystemSelect.add(new Option(system, system));
                });
                ui.organSystemSelect.disabled = false;
            } catch (error) {
                console.error("Error populating organ systems:", error);
                ui.organSystemSelect.innerHTML = `<option>Error loading data</option>`;
                showAlert(`Could not load organ systems from the AI. ${error.message}`);
            }
        }
        
        // --- ROUTINE GENERATION & DISPLAY ---
        async function generateRoutine() {
            const activeTab = ui.focusTabsContainer.querySelector('.active');
            const targetId = activeTab.dataset.target;
            
            let focusArea = '';
            let selectedText = '';
            
            if (targetId === 'muscle-focus') {
                focusArea = ui.muscleGroupSelect.value;
                selectedText = ui.muscleGroupSelect.options[ui.muscleGroupSelect.selectedIndex].text;
            } else {
                focusArea = ui.organSystemSelect.value;
                selectedText = ui.organSystemSelect.options[ui.organSystemSelect.selectedIndex].text;
            }

            const numExercises = ui.exercisesSelect.value;

            if (!focusArea) {
                showAlert(`Please select a focus area from the active tab.`);
                return;
            }

            showView('results-section');
            ui.routineList.innerHTML = '';
            ui.loaderContainer.innerHTML = '<div class="loader"></div>';
            ui.loaderContainer.style.display = 'flex';
            ui.resultsButtons.classList.add('hidden');
            ui.routineTitle.textContent = `Generating Your ${numExercises}-Pose Routine for ${selectedText}...`;

            try {
                const prompt = PROMPT_TEMPLATES.routine(numExercises, focusArea);
                const schema = { type: "OBJECT", properties: { "exercises": { type: "ARRAY", items: { type: "OBJECT", properties: { "name": { "type": "STRING" }, "instructions": { "type": "STRING" }, "benefit": { "type": "STRING" }}, required: ["name", "instructions", "benefit"] }}}, required: ["exercises"] };
                const response = await callGeminiAPI("Routine Generation", prompt, schema);
                currentRoutine = response.exercises;
                ui.routineTitle.textContent = `Your Custom Routine for ${selectedText}`;
                renderRoutine(currentRoutine);
            } catch (error) {
                console.error("Error generating routine:", error);
                ui.routineTitle.textContent = "Generation Failed";
                ui.routineList.innerHTML = `<div class="bg-red-100 border border-red-200 p-4 rounded-lg text-center text-red-700"><p><strong>Oops!</strong> ${error.message}</p><p class="mt-2 text-sm">The AI could not generate a routine. Please try different selections.</p></div>`;
            } finally {
                ui.loaderContainer.style.display = 'none';
                ui.resultsButtons.classList.remove('hidden');
            }
        }
        
        function renderRoutine(exercises) {
            ui.routineList.innerHTML = '';
            if (!exercises || exercises.length === 0) {
                ui.routineList.innerHTML = `<div class="bg-yellow-100 p-4 rounded-lg text-center text-yellow-700"><p>The AI was unable to generate a routine with the provided criteria. Please try again.</p></div>`;
                return;
            }
            exercises.forEach((exercise, index) => {
                const exerciseEl = document.createElement('div');
                exerciseEl.className = 'bg-white border border-slate-200 rounded-xl shadow-sm p-6 flex flex-col md:flex-row gap-6';
                const exerciseId = `exercise-image-${index}`;

                exerciseEl.innerHTML = `
                    <div class="w-full md:w-1/3">
                        <div id="${exerciseId}-container" class="aspect-square bg-slate-100 rounded-lg flex items-center justify-center p-2">
                             <div class="loader"></div>
                        </div>
                    </div>
                    <div class="w-full md:w-2/3">
                        <h3 class="text-xl font-semibold text-slate-900">${exercise.name}</h3>
                        <div class="mt-4 text-slate-600 space-y-4">
                            <div><h4 class="font-semibold text-slate-800">Instructions:</h4><p class="mt-1 whitespace-pre-line">${exercise.instructions}</p></div>
                            <div><h4 class="font-semibold text-slate-800">Benefit:</h4><p class="mt-1">${exercise.benefit}</p></div>
                        </div>
                        <div class="mt-4">
                           <button data-index="${index}" class="details-btn text-sm font-medium text-indigo-600 hover:text-indigo-800">More Details &rarr;</button>
                        </div>
                    </div>
                `;
                ui.routineList.appendChild(exerciseEl);
                const imageContainer = document.getElementById(`${exerciseId}-container`);
                generateAndDisplayImage(exercise.name, imageContainer);
            });
            
            document.querySelectorAll('.details-btn').forEach(btn => {
                btn.addEventListener('click', () => showExerciseDetails(btn.dataset.index));
            });
        }
                
        async function showExerciseDetails(index) {
            const exercise = currentRoutine[index];
            if (!exercise) return;

            ui.detailsTitle.textContent = exercise.name;
            ui.detailsContent.innerHTML = '<div class="flex justify-center items-center h-32"><div class="loader"></div></div>';
            ui.exerciseDetailsModal.style.display = 'flex';
            
            // Handle image display in modal
            ui.detailsImageContainer.innerHTML = ''; // Clear previous
            const img = document.createElement('img');
            img.className = 'w-full h-auto object-cover rounded-lg';
            img.alt = `Illustration for ${exercise.name}`;
            if (imageCache[exercise.name]) {
                img.src = imageCache[exercise.name];
            } else {
                 // You can optionally show a mini-loader here too
                 img.src = `https://placehold.co/400x400/eef2ff/4f46e5?text=Loading...`;
                 generateAndDisplayImage(exercise.name, null, img); // Generate and update the modal image
            }
            ui.detailsImageContainer.appendChild(img);


            try {
                 const prompt = PROMPT_TEMPLATES.details(exercise.name);
                 const detailedContent = await callGeminiAPI("Detailed View", prompt, null, false);
                 ui.detailsContent.innerHTML = marked.parse(detailedContent);
            } catch (error) {
                 ui.detailsContent.innerHTML = `<p class="text-red-600">Could not load details. ${error.message}</p>`;
            }
        }

        async function generateAndDisplayImage(exerciseName, container, modalImgElement = null) {
            if (imageCache[exerciseName]) {
                const imageUrl = imageCache[exerciseName];
                if (container) {
                    container.innerHTML = `<img src="${imageUrl}" alt="Illustration for ${exerciseName}" class="w-full h-full object-cover rounded-lg">`;
                }
                if (modalImgElement) {
                    modalImgElement.src = imageUrl;
                }
                return;
            }

            try {
                const prompt = PROMPT_TEMPLATES.imageGeneration(exerciseName);
                const imageUrl = await callImagenAPI(prompt);
                imageCache[exerciseName] = imageUrl; // Cache the result
                if (container) {
                    container.innerHTML = `<img src="${imageUrl}" alt="Illustration for ${exerciseName}" class="w-full h-full object-cover rounded-lg">`;
                }
                 if (modalImgElement) {
                    modalImgElement.src = imageUrl;
                }
            } catch (error) {
                console.error(`Failed to generate image for ${exerciseName}:`, error);
                if (container) {
                     container.innerHTML = `<div class="text-center text-xs text-red-500 p-2">Image generation failed</div>`;
                }
                 if (modalImgElement) {
                    modalImgElement.alt = "Image generation failed";
                 }
            }
        }

        function populatePromptInspector() {
            ui.staticPromptsContainer.innerHTML = '';
            for (const key in PROMPT_TEMPLATES) {
                const el = document.createElement('div');
                el.className = 'p-2 bg-slate-100 rounded';
                el.innerHTML = `
                    <h4 class="font-semibold text-slate-700">${key.charAt(0).toUpperCase() + key.slice(1)} Template</h4>
                    <pre class="whitespace-pre-wrap text-xs text-slate-600">${PROMPT_TEMPLATES[key].toString()}</pre>
                `;
                ui.staticPromptsContainer.appendChild(el);
            }

            ui.sessionPromptsContainer.innerHTML = '';
            if(promptHistory.length === 0) {
                 ui.sessionPromptsContainer.innerHTML = '<p class="text-slate-500">No prompts have been generated in this session yet.</p>';
                 return;
            }
            promptHistory.forEach(p => {
                 const el = document.createElement('div');
                el.className = 'p-4 bg-slate-50 rounded-lg border';
                const sanitizedResponse = String(p.response).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                el.innerHTML = `
                    <h4 class="font-semibold text-slate-800">${p.type} <span class="text-xs font-normal text-slate-500">- ${p.timestamp.toLocaleTimeString()}</span></h4>
                    <div class="mt-2">
                        <h5 class="font-semibold text-sm text-slate-600">Prompt Sent:</h5>
                        <pre class="mt-1 p-2 bg-slate-200 rounded text-xs whitespace-pre-wrap">${p.prompt}</pre>
                    </div>
                     <div class="mt-2">
                        <h5 class="font-semibold text-sm text-slate-600">Response Received:</h5>
                        <pre class="mt-1 p-2 bg-blue-50 border border-blue-200 rounded text-xs whitespace-pre-wrap">${p.response.startsWith('data:image') ? 'Base64 Image Data...' : sanitizedResponse}</pre>
                    </div>
                `;
                ui.sessionPromptsContainer.appendChild(el);
            });
        }


        // --- CORE API CALLERS ---
        async function callGeminiAPI(type, prompt, schema = null, expectJson = true) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };

            if (schema) {
                payload.generationConfig = { responseMimeType: "application/json", responseSchema: schema };
            }

            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();

            if (!response.ok) {
                const errorText = result.error ? result.error.message : JSON.stringify(result);
                logPrompt(type + ' (Error)', prompt, errorText);
                throw new Error(`AI processing failed: ${errorText}`);
            }
            
            if (!result.candidates?.[0]?.content?.parts) {
                logPrompt(type + ' (Error)', prompt, 'Invalid response structure from AI.');
                throw new Error("Invalid response structure from AI.");
            }

            const responseText = result.candidates[0].content.parts[0].text;
            logPrompt(type, prompt, responseText);
            
            if (expectJson) {
                try {
                    return JSON.parse(responseText);
                } catch (e) {
                    console.error("Failed to parse AI JSON response:", responseText, e);
                    throw new Error("AI returned invalid JSON format.");
                }
            }
            return responseText;
        }

        async function callImagenAPI(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${geminiApiKey}`;
            const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };

            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();

            if (!response.ok) {
                 const errorText = result.error ? result.error.message : JSON.stringify(result);
                 logPrompt('Image Generation (Error)', prompt, errorText);
                 throw new Error(`Image generation failed: ${errorText}`);
            }

            if (result.predictions && result.predictions[0].bytesBase64Encoded) {
                 const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                 logPrompt('Image Generation', prompt, imageUrl);
                 return imageUrl;
            } else {
                 logPrompt('Image Generation (Error)', prompt, 'No image data in response.');
                 throw new Error("No image data received from the AI.");
            }
        }

        // --- UTILITY FUNCTIONS ---
        function handleTabClick(e) {
            if (e.target.matches('.focus-tab')) {
                const target = e.target.dataset.target;
                
                ui.focusTabsContainer.querySelectorAll('.focus-tab').forEach(tab => tab.classList.remove('active'));
                e.target.classList.add('active');
                
                document.querySelectorAll('.focus-content').forEach(content => content.classList.remove('active'));
                document.getElementById(target).classList.add('active');
            }
        }

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.style.display = view.id === viewId ? 'block' : 'none';
            });
            window.scrollTo(0,0);
        }
        
        function showAlert(message) {
            ui.modalText.textContent = message;
            ui.customAlertModal.style.display = 'flex';
        }
    </script>
</body>
</html>
