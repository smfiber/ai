<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Story Weaver</title>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Main font styling for the app */
        body {
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            line-height: 1.6;
            letter-spacing: 0.01em;
        }

        /* Styling for the paragraphs to distinguish authors */
        .story-paragraph-wrapper {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user-paragraph {
            background-image: linear-gradient(to right, #374151, #2f3743); /* gray-700 to darker */
        }

        .ai-paragraph {
            background-image: linear-gradient(to left, #1e293b, #1a222f); /* slate-800 to darker */
        }
        
        .error-paragraph, .system-message-paragraph {
             align-self: center;
             text-align: center;
             padding: 1rem;
             border-radius: 0.5rem;
             font-weight: bold;
             max-width: 80%;
        }

        .error-paragraph {
             background-color: #dc2626; /* red-600 */
             color: #fee2e2; /* red-100 */
        }

        .system-message-paragraph {
            background-color: #374151; /* gray-700 */
            color: #a78bfa; /* violet-400 */
            white-space: pre-wrap;
        }

        /* Custom scrollbar for a cleaner look */
        #story-container::-webkit-scrollbar, textarea::-webkit-scrollbar {
            width: 8px;
        }
        #story-container::-webkit-scrollbar-track, textarea::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        #story-container::-webkit-scrollbar-thumb, textarea::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        #story-container::-webkit-scrollbar-thumb:hover, textarea::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-full flex items-center justify-center p-4 antialiased">
    <div id="app-container" class="w-full max-w-4xl h-[95vh] flex flex-col bg-gray-800 rounded-2xl shadow-2xl p-4 sm:p-6">
        <!-- Header Section -->
        <header class="flex flex-col sm:flex-row justify-between items-center w-full mb-4 pb-4 border-b border-gray-700">
            <div class="text-center sm:text-left">
                <h1 class="text-3xl font-bold text-white">AI Story Weaver</h1>
                <p class="text-sm text-gray-400 mt-1">Guide the AI with up to 10 prompts to weave a collaborative story.</p>
                <p class="text-xs text-gray-500 mt-2">Version: <span id="version-number" class="font-mono bg-gray-700 px-2 py-1 rounded">1.46</span></p>
            </div>
            
            <div class="flex flex-col items-center sm:items-end gap-4 mt-4 sm:mt-0">
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1 min-w-[150px]">
                        <label for="persona-select" class="block mb-1 text-gray-400 text-sm">Story Weaver:</label>
                        <select id="persona-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-base focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label for="tone-select" class="block mb-1 text-gray-400 text-sm">Tone:</label>
                        <select id="tone-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-base focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <!-- Row 1: Save buttons -->
                    <div class="flex flex-wrap justify-end gap-2">
                        <button id="save-story-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Save Story</button>
                        <button id="save-weaver-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Save Weaver</button>
                        <button id="save-prompts-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Save Prompts</button>
                        <button id="save-titles-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Save Titles</button>
                    </div>
                    <!-- Row 2: Action buttons -->
                    <div class="flex flex-wrap justify-end gap-2">
                         <button id="undo-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Undo</button>
                         <button id="redo-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Redo</button>
                         <button id="reset-story-btn" class="bg-red-700 hover:bg-red-600 text-white text-xs py-1 px-3 rounded-lg transition-colors">New Story</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Story Display Area -->
        <main id="story-container" class="flex-grow w-full min-h-0 overflow-y-auto p-4 space-y-6 flex flex-col"></main>

        <!-- User Input Area -->
        <footer class="mt-4 pt-4 border-t border-gray-700">
            <div class="relative">
                <textarea id="prompt-input" class="w-full bg-gray-700 text-white rounded-lg p-3 pr-40 focus:ring-2 focus:ring-indigo-500 focus:outline-none transition resize-none" rows="3" placeholder="Add the next part of the story..."></textarea>
                <button id="continue-btn" class="absolute right-3 top-1/2 -translate-y-1/2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg active:scale-95 flex items-center gap-2 disabled:bg-gray-500 disabled:cursor-not-allowed">
                    <span id="btn-text">Add to Story</span>
                    <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const storyContainer = document.getElementById('story-container');
            const promptInput = document.getElementById('prompt-input');
            const continueBtn = document.getElementById('continue-btn');
            const btnText = document.getElementById('btn-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const personaSelect = document.getElementById('persona-select');
            const toneSelect = document.getElementById('tone-select');
            const resetStoryBtn = document.getElementById('reset-story-btn');
            const saveStoryBtn = document.getElementById('save-story-btn');
            const saveTitlesBtn = document.getElementById('save-titles-btn');
            const saveWeaverBtn = document.getElementById('save-weaver-btn');
            const savePromptsBtn = document.getElementById('save-prompts-btn');
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');

            // --- Application State ---
            const MAX_PROMPTS = 10;
            const MIN_PROMPTS_FOR_SAVE = 5;
            let isAITurn = false;
            let isEditing = false;
            let editingParagraphIndex = null;
            let currentPersonaIndex = 0;
            let currentToneIndex = 0;
            let lastSuggestedTitles = '';
            
            let storyHistory = [];
            let historyStack = [];
            let historyPointer = -1;

            // --- Persona & Tone Data (Sorted) ---
            const personas = [
                { name: "Ayurveda Alchemist (Balance)", systemPrompt: "You are the Ayurveda Alchemist. Based on the user's prompts, continue the narrative focusing on holistic well-being and balance. Seamlessly continue the story in the same narrative person and style as the preceding text, avoiding direct questions or conversational fillers. Limit your response to exactly 2 sentences." },
                { name: "Bodhi Tree Chronicler (Awakening)", systemPrompt: "You are the Bodhi Tree Chronicler. Based on the user's prompts, continue the narrative telling stories of awakening and compassionate understanding. Seamlessly continue the story in the same narrative person and style as the preceding text, avoiding direct questions or conversational fillers. Limit your response to exactly 2 sentences." },
                { name: "Chakra Oracle (Energy)", systemPrompt: "You are the Chakra Oracle. Based on the user's prompts, continue the narrative exploring energy centers and emotional landscapes. Seamlessly continue the story in the same narrative person and style as the preceding text, avoiding direct questions or conversational fillers. Limit your response to exactly 2 sentences." },
                { name: "Dharma Protector (Justice)", systemPrompt: "You are the Dharma Protector. Based on the user's prompts, continue the narrative where justice and righteousness are central. Seamlessly continue the story in the same narrative person and style as the preceding text, avoiding direct questions or conversational fillers. Limit your response to exactly 2 sentences." },
                { name: "Karma Weaver (Dharma)", systemPrompt: "You are a Karma Weaver storyteller. Based on the user's prompts, continue the narrative exploring themes of cause and effect, and duty (dharma). Gently illustrate consequences and personal growth. Seamlessly continue the story in the same narrative person and style as the preceding text, avoiding direct questions or conversational fillers. Limit your response to exactly 2 sentences." },
                { name: "Mandala Architect (Pattern)", systemPrompt: "You are the Mandala Architect. Based on the user's prompts, continue the narrative revealing intricate patterns and interconnectedness. Seamlessly continue the story in the same narrative person and style as the preceding text, avoiding direct questions or conversational fillers. Limit your response to exactly 2 sentences." },
                { name: "Sankalpa Seeker (Intention)", systemPrompt: "You are the Sankalpa Seeker. Based on the user's prompts, continue the narrative around the power of intention and resolve. Seamlessly continue the story in the same narrative person and style as the preceding text, avoiding direct questions or conversational fillers. Limit your response to exactly 2 sentences." },
                { name: "Taoist Sage (Flow)", systemPrompt: "You are a Taoist Sage. Based on the user's prompts, continue the narrative embodying effortless flow (wu wei) and the beauty of nature's path. Seamlessly continue the story in the same narrative person and style as the preceding text, avoiding direct questions or conversational fillers. Limit your response to exactly 2 sentences." },
                { name: "Yoga Sutra Guide (Unity)", systemPrompt: "You are a Yoga Sutra Guide. Based on the user's prompts, continue the narrative focusing on the journey towards union (yoga) and harmony of mind and body. Seamlessly continue the story in the same narrative person and style as the preceding text, avoiding direct questions or conversational fillers. Limit your response to exactly 2 sentences." },
                { name: "Zen Master (Wisdom)", systemPrompt: "You are a Zen Master storyteller. Based on the user's prompts, continue the narrative with profound wisdom, focusing on simplicity and enlightenment. Seamlessly continue the story in the same narrative person and style as the preceding text, avoiding direct questions or conversational fillers. Limit your response to exactly 2 sentences." }
            ].sort((a, b) => a.name.localeCompare(b.name));

            const tones = [
                { name: "Dramatic", description: "a dramatic and intense" },
                { name: "Factual", description: "a factual and descriptive" },
                { name: "Humorous", description: "a funny and lighthearted" },
                { name: "Magical", description: "a magical and enchanting" },
                { name: "Mysterious", description: "a mysterious and suspenseful" },
                { name: "Newscast", description: "a formal and journalistic" },
                { name: "Optimistic", description: "an optimistic and uplifting" },
                { name: "Poetic", description: "a poetic and lyrical" },
                { name: "Romantic", description: "a romantic and tender" },
                { name: "Whimsical", description: "a whimsical and fantastical" }
            ].sort((a, b) => a.name.localeCompare(b.name));
            
            // --- Core Functions ---

            function initializeApp() {
                populatePersonaSelect();
                populateToneSelect();
                resetApp();
            }

            function resetApp() {
                storyHistory = [ getSystemPrompt() ];
                historyStack = [ JSON.parse(JSON.stringify(storyHistory)) ];
                historyPointer = 0;
                lastSuggestedTitles = '';
                isEditing = false;
                editingParagraphIndex = null;
                
                updateUIFromHistory();
                displaySystemMessage("Provide a prompt to begin your story.", 'system-message');
                promptInput.focus();
            }
            
            function getSystemPrompt() {
                const selectedPersona = personas[currentPersonaIndex];
                const selectedTone = tones[currentToneIndex];
                const text = `${selectedPersona.systemPrompt} The story should have ${selectedTone.description} tone.`;
                return { role: "user", parts: [{ text }] };
            }

            function populatePersonaSelect() {
                personas.forEach((persona, index) => {
                    const option = document.createElement('option');
                    // Store the original index before sorting
                    option.value = personas.findIndex(p => p.name === persona.name);
                    option.textContent = persona.name;
                    personaSelect.appendChild(option);
                });
            }

            function populateToneSelect() {
                tones.forEach((tone, index) => {
                    const option = document.createElement('option');
                     // Store the original index before sorting
                    option.value = tones.findIndex(t => t.name === tone.name);
                    option.textContent = tone.name;
                    toneSelect.appendChild(option);
                });
            }

            async function handleContinueStory() {
                const userPrompt = promptInput.value.trim();
                if (!userPrompt || isAITurn || getUserPromptCount() >= MAX_PROMPTS) return;

                setLoading(true);

                if (isEditing) {
                    storyHistory[editingParagraphIndex].parts[0].text = userPrompt;
                    storyHistory.splice(editingParagraphIndex + 1); // Truncate history
                } else {
                    storyHistory.push({ role: 'user', parts: [{ text: userPrompt }] });
                }
                
                promptInput.value = '';
                isEditing = false;
                editingParagraphIndex = null;

                try {
                    const aiResponseText = await getAIResponse(storyHistory);
                    storyHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
                    pushToHistory();
                } catch (error) {
                    console.error("Error continuing story:", error);
                    displaySystemMessage(error.message, 'error');
                    storyHistory.pop(); // Remove user prompt that caused error
                } finally {
                    setLoading(false);
                    updateUIFromHistory();
                }
            }
            
            // --- UI & Display ---

            function updateUIFromHistory() {
                storyContainer.innerHTML = '';
                storyHistory.forEach((part, i) => {
                    if (i === 0) return; // Don't display system prompt
                    addParagraphToUI(part.role, part.parts[0].text, i);
                });
                storyContainer.scrollTop = storyContainer.scrollHeight; // Auto-scroll
                updateButtonStates();
                if (!promptInput.disabled) {
                    promptInput.focus();
                }
            }
            
            function addParagraphToUI(role, text, index) {
                const wrapper = document.createElement('div');
                wrapper.classList.add('story-paragraph-wrapper', 'flex', 'items-start', 'gap-4');
                
                const paragraphContent = document.createElement('div');
                paragraphContent.classList.add('flex-grow', 'p-4', 'rounded-lg');
                
                const contentTag = document.createElement('p');
                contentTag.textContent = text;
                paragraphContent.appendChild(contentTag);

                const controlsContainer = document.createElement('div');
                controlsContainer.classList.add('flex-shrink-0', 'py-4');

                if (role === 'user') {
                    wrapper.classList.add('justify-start');
                    paragraphContent.classList.add('user-paragraph', 'rounded-bl-none');
                    const editBtn = createControlButton('Edit', () => enterEditMode(index, text));
                    controlsContainer.appendChild(editBtn);
                    wrapper.appendChild(paragraphContent);
                    wrapper.appendChild(controlsContainer);
                } else if (role === 'model') {
                    wrapper.classList.add('justify-end');
                    paragraphContent.classList.add('ai-paragraph', 'rounded-br-none');
                    const regenBtn = createControlButton('Regen', () => handleRegenerate(index));
                    controlsContainer.appendChild(regenBtn);
                    wrapper.appendChild(controlsContainer);
                    wrapper.appendChild(paragraphContent);
                }
                storyContainer.appendChild(wrapper);
            }
            
            function createControlButton(text, onClick) {
                const button = document.createElement('button');
                button.textContent = text;
                button.classList.add('bg-gray-600', 'hover:bg-gray-500', 'text-white', 'text-xs', 'py-1', 'px-2', 'rounded-md', 'transition-colors');
                button.addEventListener('click', onClick);
                return button;
            }

            function displaySystemMessage(text, type = 'system-message') {
                storyContainer.querySelectorAll('.system-message-paragraph, .error-paragraph').forEach(el => el.remove());
                const messageWrapper = document.createElement('div');
                messageWrapper.classList.add('story-paragraph-wrapper', type === 'error' ? 'error-paragraph' : 'system-message-paragraph');
                messageWrapper.innerHTML = text.replace(/\n/g, '<br>'); // Use innerHTML to render line breaks
                storyContainer.appendChild(messageWrapper);
                storyContainer.scrollTop = storyContainer.scrollHeight; // Auto-scroll
            }

            // --- Edit & Regenerate ---

            function enterEditMode(index, text) {
                if(isAITurn) return;
                isEditing = true;
                editingParagraphIndex = index;
                promptInput.value = text;
                btnText.textContent = 'Update';
                promptInput.focus();
                updateButtonStates();
            }

            async function handleRegenerate(index) {
                if (isAITurn) return;
                setLoading(true);
                
                const historyForRegen = storyHistory.slice(0, index);
                try {
                    const newAiResponse = await getAIResponse(historyForRegen);
                    storyHistory[index].parts[0].text = newAiResponse;
                    storyHistory.splice(index + 1);
                    pushToHistory();
                } catch (error) {
                    console.error("Error regenerating:", error);
                    displaySystemMessage(error.message, 'error');
                } finally {
                    setLoading(false);
                    updateUIFromHistory();
                }
            }
            
            // --- Saving & Export ---

            function handleSaveAndTitle() {
                if (isAITurn || getUserPromptCount() < MIN_PROMPTS_FOR_SAVE) return;
                
                setLoading(true);
                const fullStoryText = storyHistory
                    .filter(p => p.role === 'model')
                    .map(p => p.parts[0].text)
                    .join('\n\n');

                const titlePrompt = `Based on the following story, suggest 5 creative titles:\n\n"${fullStoryText}"`;

                getAIResponse([{ role: 'user', parts: [{ text: titlePrompt }] }])
                    .then(titles => {
                        lastSuggestedTitles = titles.split('\n').filter(Boolean).join('\n');
                        displaySystemMessage("Story saved! Suggested Titles below. You can save them separately.", 'system-message');
                        saveAsHtml(getStoryHtml(), 'AI-Woven-Story.html');
                    })
                    .catch(error => {
                        console.error("Error getting titles:", error);
                        displaySystemMessage(error.message, 'error');
                    })
                    .finally(() => {
                        setLoading(false);
                        updateButtonStates();
                    });
            }

            function getStoryHtml() {
                const storyContent = storyHistory
                    .filter(p => p.role === 'model')
                    .map(p => `<p>${p.parts[0].text}</p>`).join('');
                return createHtmlWrapper(`<div class="ai-paragraph p-4">${storyContent}</div>`, "Your AI-Woven Story");
            }
            
            function savePrompts() {
                const promptsText = storyHistory
                    .filter(p => p.role === 'user' && p.parts[0].text !== getSystemPrompt().parts[0].text)
                    .map((p, i) => `Prompt ${i + 1}:\n${p.parts[0].text}`)
                    .join('\n\n---\n\n');
                saveAsTxt(promptsText, 'My-Prompts.txt');
            }
            
            function saveWeaver() {
                const weaverText = storyHistory
                    .slice(1)
                    .map(p => `[${p.role === 'user' ? 'You' : 'Story Weaver'}]:\n${p.parts[0].text}`)
                    .join('\n\n');
                saveAsTxt(weaverText, 'Weaver-Chat.txt');
            }
            
            function saveTitles() {
                if (!lastSuggestedTitles) return;
                saveAsTxt(lastSuggestedTitles, 'Suggested-Titles.txt');
            }
            
            function createHtmlWrapper(content, title) {
                const styles = `body{font-family:'Inter',sans-serif;background-color:#111827;color:white;padding:2rem;display:flex;flex-direction:column;align-items:center;} div{border-radius:1rem;margin-bottom:1rem;max-width:800px;width:100%;} .user-paragraph{background-color:#374151;} .ai-paragraph{background-color:#1e293b;} .system-message-paragraph{background-color:#374151;color:#a78bfa;text-align:center;}`;
                return `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>${title}</title><script src="https://cdn.tailwindcss.com"><\/script><style>${styles}</style></head><body><h1 class="text-3xl font-bold mb-4">${title}</h1>${content}</body></html>`;
            }

            function saveAsTxt(textContent, filename) {
                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function saveAsHtml(htmlContent, filename) {
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            // --- History & State Management ---

            function pushToHistory() {
                historyStack = historyStack.slice(0, historyPointer + 1);
                historyStack.push(JSON.parse(JSON.stringify(storyHistory)));
                historyPointer++;
                updateButtonStates();
            }

            function handleUndo() {
                if (historyPointer > 0) {
                    historyPointer--;
                    storyHistory = JSON.parse(JSON.stringify(historyStack[historyPointer]));
                    updateUIFromHistory();
                }
            }

            function handleRedo() {
                if (historyPointer < historyStack.length - 1) {
                    historyPointer++;
                    storyHistory = JSON.parse(JSON.stringify(historyStack[historyPointer]));
                    updateUIFromHistory();
                }
            }

            function getUserPromptCount() {
                return storyHistory.filter(p => p.role === 'user').length - 1; // Subtract system prompt
            }

            function updateButtonStates() {
                const promptCount = getUserPromptCount();
                const isStoryComplete = promptCount >= MAX_PROMPTS;
                const canSave = promptCount >= MIN_PROMPTS_FOR_SAVE;
                
                const isBusy = isAITurn;
                
                continueBtn.disabled = isBusy || isStoryComplete || isEditing;
                if(isEditing) {
                    btnText.textContent = 'Update';
                } else {
                     btnText.textContent = 'Add to Story';
                }

                if (isStoryComplete && !isBusy) {
                    promptInput.placeholder = "Story complete! You can save your story now.";
                    promptInput.disabled = true;
                } else {
                    promptInput.placeholder = `Add prompt ${promptCount + 1} of ${MAX_PROMPTS}...`;
                    promptInput.disabled = isBusy;
                }

                undoBtn.disabled = isBusy || historyPointer <= 0;
                redoBtn.disabled = isBusy || historyPointer >= historyStack.length - 1;
                
                saveStoryBtn.disabled = isBusy || !canSave;
                saveWeaverBtn.disabled = isBusy || storyHistory.length <= 1;
                savePromptsBtn.disabled = isBusy || promptCount < 1;
                saveTitlesBtn.disabled = isBusy || !lastSuggestedTitles;
            }
            
            function setLoading(isLoading) {
                isAITurn = isLoading;
                loadingSpinner.classList.toggle('hidden', !isLoading);
                continueBtn.disabled = isLoading;
                updateButtonStates();
            }

            async function getAIResponse(history) {
                const apiKey = "AIzaSyBV0I7cih-RvH0TZx3fQDdOHiGNY5dg1Wg";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: history };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const responseText = await response.text();

                if (!response.ok) {
                    const errorData = JSON.parse(responseText || "{}");
                    throw new Error(errorData?.error?.message || `API request failed with status ${response.status}`);
                }
                const result = JSON.parse(responseText);
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error(`Unexpected API response format.`);
                }
            }
            
            // --- Event Listeners ---
            continueBtn.addEventListener('click', handleContinueStory);
            promptInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleContinueStory();
                }
            });
            
            resetStoryBtn.addEventListener('click', resetApp);
            saveStoryBtn.addEventListener('click', handleSaveAndTitle);
            saveTitlesBtn.addEventListener('click', saveTitles);
            saveWeaverBtn.addEventListener('click', saveWeaver);
            savePromptsBtn.addEventListener('click', savePrompts);
            undoBtn.addEventListener('click', handleUndo);
            redoBtn.addEventListener('click', handleRedo);

            personaSelect.addEventListener('change', (e) => { currentPersonaIndex = parseInt(e.target.value); resetApp() });
            toneSelect.addEventListener('change', (e) => { currentToneIndex = parseInt(e.target.value); resetApp() });

            // --- Initialization ---
            initializeApp();
        });
    </script>
</body>
</html>
