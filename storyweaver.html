<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Story Weaver</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html-to-image library for PNG export -->
    <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.js"></script>
    <style>
        /* Embedded Google Fonts to prevent CORS issues with html-to-image */
        /* latin */
        @font-face {
          font-family: 'Inter';
          font-style: normal;
          font-weight: 300;
          font-display: swap;
          src: url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');
          unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
        /* latin */
        @font-face {
          font-family: 'Inter';
          font-style: normal;
          font-weight: 400;
          font-display: swap;
          src: url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');
          unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
        /* latin */
        @font-face {
          font-family: 'Inter';
          font-style: normal;
          font-weight: 700;
          font-display: swap;
          src: url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');
          unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }

        /* Main font styling for the app */
        body {
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            line-height: 1.6;
            letter-spacing: 0.01em;
        }

        /* Styling for the paragraphs to distinguish authors */
        .story-paragraph-wrapper {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user-paragraph {
            background-image: linear-gradient(to right, #374151, #2f3743); /* gray-700 to darker */
        }

        .ai-paragraph {
            background-image: linear-gradient(to left, #1e293b, #1a222f); /* slate-800 to darker */
        }
        
        .error-paragraph, .system-message-paragraph {
             align-self: center;
             text-align: center;
             padding: 1rem;
             border-radius: 0.5rem;
             font-weight: bold;
             max-width: 80%;
        }

        .error-paragraph {
             background-color: #dc2626; /* red-600 */
             color: #fee2e2; /* red-100 */
        }

        .system-message-paragraph {
            background-color: #374151; /* gray-700 */
            color: #a78bfa; /* violet-400 */
            white-space: pre-wrap;
        }

        /* Custom scrollbar for a cleaner look */
        #story-container::-webkit-scrollbar, textarea::-webkit-scrollbar, #instructions-modal-content::-webkit-scrollbar {
            width: 8px;
        }
        #story-container::-webkit-scrollbar-track, textarea::-webkit-scrollbar-track, #instructions-modal-content::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        #story-container::-webkit-scrollbar-thumb, textarea::-webkit-scrollbar-thumb, #instructions-modal-content::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        #story-container::-webkit-scrollbar-thumb:hover, textarea::-webkit-scrollbar-thumb:hover, #instructions-modal-content::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        
        .illustration-container {
            margin-bottom: 1rem; /* Space between image and text */
            position: relative;
            width: 100%;
            padding-top: 75%; /* 4:3 Aspect Ratio */
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .illustration-container img, .illustration-container .loading-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-full flex items-center justify-center p-4 antialiased">
    <div id="app-container" class="w-full max-w-5xl h-[95vh] flex flex-col bg-gray-800 rounded-2xl shadow-2xl p-4 sm:p-6">
        <!-- Header Section -->
        <header class="flex flex-col sm:flex-row justify-between items-start w-full mb-4 pb-4 border-b border-gray-700">
            <div class="flex-shrink-0 mr-6">
                <h1 class="text-xl font-bold text-white flex items-baseline gap-2">
                    AI Story Weaver
                    <span id="version-number" class="text-xs font-mono bg-gray-700 px-2 py-1 rounded">1.73</span>
                    <button id="help-icon" title="How to Use">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-question-circle text-gray-400 hover:text-white" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                        </svg>
                    </button>
                </h1>
                <p class="text-xs text-gray-400 mt-1 max-w-xs">Guide the AI with prompts, add your own narration, illustrate scenes, and fine-tune the story with powerful editing controls.</p>
            </div>
            
            <div class="flex-grow flex flex-col items-end gap-2 mt-4 sm:mt-0">
                <div class="flex flex-col sm:flex-row gap-4 w-full justify-end">
                    <div class="flex-1 min-w-[150px] max-w-xs">
                        <label for="persona-select" class="block mb-1 text-gray-400 text-sm">Story Weaver:</label>
                        <select id="persona-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-base focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                    <div class="flex-1 min-w-[150px] max-w-xs">
                        <label for="tone-select" class="block mb-1 text-gray-400 text-sm">Tone:</label>
                        <select id="tone-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-base focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                     <div class="flex-1 min-w-[150px] max-w-xs">
                        <label for="image-style-select" class="block mb-1 text-gray-400 text-sm">Image Style:</label>
                        <select id="image-style-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-base focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                    <div class="flex-1 min-w-[120px] max-w-xs">
                        <label for="sentence-length-select" class="block mb-1 text-gray-400 text-sm">Sentences:</label>
                        <select id="sentence-length-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-base focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2 mt-2">
                    <!-- Row 1: Save buttons -->
                    <div class="flex flex-wrap justify-end gap-2">
                        <button id="save-story-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Save Story</button>
                        <button id="save-weaver-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Save Weaver</button>
                        <button id="save-prompts-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Save Prompts</button>
                        <button id="save-lamination-btn" class="bg-green-600 hover:bg-green-700 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Save Lamination</button>
                        <button id="save-narration-btn" class="bg-teal-600 hover:bg-teal-700 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Save Narration</button>
                    </div>
                    <!-- Row 2: Action buttons -->
                    <div class="flex flex-wrap justify-end gap-2">
                         <button id="undo-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Undo</button>
                         <button id="redo-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Redo</button>
                         <button id="reset-story-btn" class="bg-red-700 hover:bg-red-600 text-white text-xs py-1 px-3 rounded-lg transition-colors">New Story</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Story Display Area -->
        <main id="story-container" class="flex-grow w-full min-h-0 overflow-y-auto p-4 space-y-6 flex flex-col"></main>
        
        <!-- User Input Area -->
        <footer class="mt-4 pt-4 border-t border-gray-700">
            <textarea id="prompt-input" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none transition resize-none" rows="3" placeholder="Add the next part of the story..."></textarea>
            <div class="flex justify-end items-center mt-2 gap-4">
                 <button id="create-lamination-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Create Lamination
                </button>
                 <button id="add-narration-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Add as Narration
                </button>
                <button id="continue-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg active:scale-95 flex items-center gap-2 disabled:bg-gray-500 disabled:cursor-not-allowed">
                    <span id="btn-text">Add to Story</span>
                    <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </footer>
    </div>
    
    <!-- Instructions Modal -->
    <div id="instructions-modal" class="hidden fixed inset-0 bg-black/75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-3xl h-[80vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4 text-white text-center">How to Use AI Story Weaver</h2>
            <div id="instructions-modal-content" class="flex-grow overflow-y-auto pr-4 text-gray-300 space-y-4">
                <div class="prose prose-invert">
                    <h3 class="font-semibold text-white">Core Controls</h3>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>Add to Story:</strong> Submits your text as a prompt for the AI to continue the narrative.</li>
                        <li><strong>Add as Narration:</strong> Inserts your text directly into the story without AI generation. This is useful for adding your own voice, descriptions, or transitions.</li>
                        <li><strong>Create Lamination:</strong> Takes the text in the prompt box and generates a single, shareable image with the text overlaid on a themed background.</li>
                    </ul>
                    <h3 class="font-semibold text-white mt-4">Creative Direction</h3>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>Story Weaver:</strong> Choose the AI's personality. This sets the overall narrative style and voice. Changing this will start a new story.</li>
                        <li><strong>Tone:</strong> Select the emotional mood of the AI's writing. Changing this will also start a new story.</li>
                        <li><strong>Image Style:</strong> Pick an artistic style for the illustrations you generate.</li>
                        <li><strong>Sentences:</strong> Control the length of the AI's response (1-5 sentences). Changing this will start a new story.</li>
                    </ul>
                     <h3 class="font-semibold text-white mt-4">Editing & Refining</h3>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>Edit:</strong> Appears next to your prompts and narrations. Click to modify your text.</li>
                        <li><strong>Regen:</strong> Appears next to AI-generated paragraphs. Click to ask the AI for a different response based on the same preceding text.</li>
                        <li><strong>Illustrate:</strong> Appears next to AI-generated paragraphs and your narrations. Click to generate an image based on the text of that paragraph. You can re-click to get a new image.</li>
                         <li><strong>Undo/Redo:</strong> Step backward or forward through your story's history.</li>
                    </ul>
                     <h3 class="font-semibold text-white mt-4">Saving Your Work</h3>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>Save Story:</strong> Becomes active after 1 prompt. Saves the full illustrated story as a styled HTML file.</li>
                        <li><strong>Save Weaver:</strong> Saves the entire back-and-forth dialogue between you and the AI as a .txt file.</li>
                        <li><strong>Save Prompts:</strong> Saves only your prompts as a .txt file.</li>
                        <li><strong>Save Lamination:</strong> Saves the currently displayed lamination image as a PNG file.</li>
                        <li><strong>Save Narration:</strong> Saves the most recently added narration block as a PNG file.</li>
                    </ul>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button id="close-instructions-modal-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Close</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const storyContainer = document.getElementById('story-container');
            const promptInput = document.getElementById('prompt-input');
            const continueBtn = document.getElementById('continue-btn');
            const addNarrationBtn = document.getElementById('add-narration-btn');
            const createLaminationBtn = document.getElementById('create-lamination-btn');
            const btnText = document.getElementById('btn-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const personaSelect = document.getElementById('persona-select');
            const toneSelect = document.getElementById('tone-select');
            const imageStyleSelect = document.getElementById('image-style-select');
            const sentenceLengthSelect = document.getElementById('sentence-length-select');
            const resetStoryBtn = document.getElementById('reset-story-btn');
            const saveStoryBtn = document.getElementById('save-story-btn');
            const saveWeaverBtn = document.getElementById('save-weaver-btn');
            const savePromptsBtn = document.getElementById('save-prompts-btn');
            const saveLaminationBtn = document.getElementById('save-lamination-btn');
            const saveNarrationBtn = document.getElementById('save-narration-btn');
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            const helpIcon = document.getElementById('help-icon');
            const instructionsModal = document.getElementById('instructions-modal');
            const closeInstructionsModalBtn = document.getElementById('close-instructions-modal-btn');


            // --- Application State ---
            const MAX_PROMPTS = 10;
            const MIN_PROMPTS_FOR_SAVE = 1;
            let isAITurn = false;
            let isEditing = false;
            let editingParagraphIndex = null;
            let currentPersonaIndex = 0;
            let currentToneIndex = 0;
            let currentImageStyleIndex = 0;
            let currentSentenceLength = 2;
            let currentLaminationText = '';
            let isLaminationMode = false;
            
            let storyHistory = [];
            let historyStack = [];
            let historyPointer = -1;

            // --- Persona, Tone, Style & Length Data (Sorted) ---
            const personas = [
                { name: "Ask me anything", systemPrompt: "You are a helpful and factual assistant. Answer the user's question directly and concisely." },
                { name: "Ayurveda Alchemist (Balance)", systemPrompt: "You are the Ayurveda Alchemist. Based on the user's prompts, continue the narrative focusing on holistic well-being and balance." },
                { name: "Bodhi Tree Chronicler (Awakening)", systemPrompt: "You are the Bodhi Tree Chronicler. Based on the user's prompts, continue the narrative telling stories of awakening and compassionate understanding." },
                { name: "Chakra Oracle (Energy)", systemPrompt: "You are the Chakra Oracle. Based on the user's prompts, continue the narrative exploring energy centers and emotional landscapes." },
                { name: "Cosmic Dreamer", systemPrompt: "You are a Cosmic Dreamer. Based on the user's prompts, continue the narrative with a sense of wonder, exploring space, the universe, and philosophical questions about existence." },
                { name: "Cyberpunk Netrunner", systemPrompt: "You are a Cyberpunk Netrunner. Based on the user's prompts, continue the narrative with a high-tech, gritty, and futuristic feel. Use slang and concepts from the cyberpunk genre." },
                { name: "Dharma Protector (Justice)", systemPrompt: "You are the Dharma Protector. Based on the user's prompts, continue the narrative where justice and righteousness are central." },
                { name: "Gothic Novelist", systemPrompt: "You are a Gothic Novelist. Based on the user's prompts, continue the narrative in a dark, mysterious, and atmospheric style, focusing on themes of horror, romance, and the sublime." },
                { name: "Haiku Poet", systemPrompt: "You are a Haiku Poet. Respond to the user's prompt by continuing the narrative in a short, three-phrase block structured with a 5, 7, 5 syllable pattern." },
                { name: "Karma Weaver (Dharma)", systemPrompt: "You are a Karma Weaver storyteller. Based on the user's prompts, continue the narrative exploring themes of cause and effect, and duty (dharma)." },
                { name: "Mandala Architect (Pattern)", systemPrompt: "You are the Mandala Architect. Based on the user's prompts, continue the narrative revealing intricate patterns and interconnectedness." },
                { name: "Mythic Chronicler", systemPrompt: "You are a Mythic Chronicler. Based on the user's prompts, continue the narrative in an epic, mythological style, with heroic deeds and legendary events." },
                { name: "Nature Documentarian", systemPrompt: "You are a Nature Documentarian. Based on the user's prompts, describe the scene with the clinical yet awe-filled detail of a nature documentary." },
                { name: "Noir Detective", systemPrompt: "You are a Noir Detective. Based on the user's prompts, continue the narrative in a hardboiled, cynical, and stylish manner, filled with witty one-liners and a sense of moral ambiguity." },
                { name: "Sankalpa Seeker (Intention)", systemPrompt: "You are the Sankalpa Seeker. Based on the user's prompts, continue the narrative around the power of intention and resolve." },
                { name: "Stoic Philosopher", systemPrompt: "You are a Stoic Philosopher. Based on the user's prompts, continue the narrative with a focus on logic, virtue, and acceptance of fate." },
                { name: "Taoist Sage (Flow)", systemPrompt: "You are a Taoist Sage. Based on the user's prompts, continue the narrative embodying effortless flow (wu wei) and the beauty of nature's path." },
                { name: "Vedic Scholar", systemPrompt: "You are a Vedic Scholar. Based on the user's prompts, continue the narrative by weaving in themes from the Vedas and ancient Indian philosophy." },
                { name: "Yoga Sutra Guide (Unity)", systemPrompt: "You are a Yoga Sutra Guide. Based on the user's prompts, continue the narrative focusing on the journey towards union (yoga) and harmony of mind and body." },
                { name: "Zen Master (Wisdom)", systemPrompt: "You are a Zen Master storyteller. Based on the user's prompts, continue the narrative with profound wisdom, focusing on simplicity and enlightenment." }
            ].sort((a, b) => a.name.localeCompare(b.name));

            const tones = [
                { name: "Acerbic", description: "an acerbic, witty, and sarcastic" },
                { name: "Awestruck", description: "an awestruck and amazed" },
                { name: "Clinical", description: "a clinical, detached, and precise" },
                { name: "Comforting", description: "a comforting, gentle, and warm" },
                { name: "Cynical", description: "a cynical and distrustful" },
                { name: "Dramatic", description: "a dramatic and intense" },
                { name: "Eerie", description: "an eerie, strange, and frightening" },
                { name: "Empathetic", description: "an empathetic, understanding, and compassionate" },
                { name: "Euphoric", description: "a euphoric, intensely happy, and excited" },
                { name: "Factual", description: "a factual and descriptive" },
                { name: "Humorous", description: "a funny and lighthearted" },
                { name: "Magical", description: "a magical and enchanting" },
                { name: "Mysterious", description: "a mysterious and suspenseful" },
                { name: "Newscast", description: "a formal and journalistic" },
                { name: "Nostalgic", description: "a nostalgic and sentimental" },
                { name: "Optimistic", description: "an optimistic and uplifting" },
                { name: "Poetic", description: "a poetic and lyrical" },
                { name: "Romantic", description: "a romantic and tender" },
                { name: "Scholarly", description: "a scholarly, academic, and formal" },
                { name: "Whimsical", description: "a whimsical and fantastical" }
            ].sort((a, b) => a.name.localeCompare(b.name));

             const imageStyles = [
                { name: "Surreal", prefix: "A surrealist painting of" },
                { name: "Highly Detailed", prefix: "A highly detailed, intricate illustration of" },
                { name: "Photorealistic", prefix: "A photorealistic image of" },
                { name: "Anime", prefix: "An anime style illustration of" },
                { name: "Watercolor", prefix: "A watercolor painting of" },
                { name: "Oil Painting", prefix: "An oil painting of" },
                { name: "Charcoal Sketch", prefix: "A charcoal sketch of" },
                { name: "Pixel Art", prefix: "16-bit pixel art of" },
                { name: "Art Deco", prefix: "An art deco illustration of" },
                { name: "Minimalist", prefix: "A minimalist, simple line drawing of" },
                { name: "Blueprint Diagram", prefix: "A blueprint diagram of" },
                { name: "Cubism", prefix: "A cubist painting of" },
                { name: "Gothic Art", prefix: "Gothic art of" },
                { name: "Impressionism", prefix: "An impressionist painting of" },
                { name: "Pop Art", prefix: "Pop art of" },
                { name: "Rococo", prefix: "A rococo painting of" },
                { name: "Steampunk", prefix: "A steampunk illustration of" },
                { name: "Synthwave", prefix: "Synthwave art of" },
                { name: "Tribal Art", prefix: "Tribal art of" },
                { name: "Infographic", prefix: "An infographic about" }
            ].sort((a, b) => a.name.localeCompare(b.name));
            
            const sentenceLengths = [1, 2, 3, 4, 5];
            
            const laminationThemes = [
                { name: "Ladybug on Leaf", prompt: "A beautiful, photorealistic background of a ladybug on a dewy green leaf" },
                { name: "Cherry Blossoms", prompt: "A soft-focus background of cherry blossoms in spring" },
                { name: "Zen Garden", prompt: "A serene zen garden with stacked stones and raked sand" },
                { name: "Lotus Flower", prompt: "A tranquil pond with a single, perfect lotus flower" },
                { name: "Sunflowers", prompt: "A field of bright, cheerful sunflowers under a blue sky" },
                { name: "Mandala Pattern", prompt: "A detailed, calming mandala pattern" },
                { name: "Sunset Beach", prompt: "A calm beach at sunset with gentle waves" },
                { name: "Misty Forest", prompt: "A misty, atmospheric forest path" },
                { name: "Cosmic Yoga", prompt: "A celestial, starry galaxy background suitable for yoga and inspiration" },
                { name: "Lavender Fields", prompt: "A beautiful, calming field of lavender" }
            ];

            // --- Core Functions ---

            function initializeApp() {
                populatePersonaSelect();
                populateToneSelect();
                populateImageStyleSelect();
                populateSentenceLengthSelect();
                
                currentPersonaIndex = personas.findIndex(p => p.name === "Ask me anything");
                currentToneIndex = tones.findIndex(t => t.name === "Factual");
                personaSelect.value = currentPersonaIndex;
                toneSelect.value = currentToneIndex;
                sentenceLengthSelect.value = 2; // Default to 2 sentences

                resetApp();
            }

            function resetApp() {
                storyContainer.classList.remove('hidden');
                isLaminationMode = false;
                storyHistory = [ getSystemPrompt() ];
                historyStack = [ JSON.parse(JSON.stringify(storyHistory)) ];
                historyPointer = 0;
                isEditing = false;
                editingParagraphIndex = null;
                
                updateUIFromHistory();
                displaySystemMessage("Provide a prompt to begin your story.", 'system-message');
                promptInput.focus();
            }
            
            function getSystemPrompt() {
                const selectedPersona = personas[currentPersonaIndex];
                const selectedTone = tones[currentToneIndex];
                const text = `${selectedPersona.systemPrompt} Limit your response to exactly ${currentSentenceLength} sentence(s).`;
                return { role: "user", parts: [{ text }] };
            }

            function populatePersonaSelect() {
                personas.forEach((persona, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = persona.name;
                    personaSelect.appendChild(option);
                });
            }

            function populateToneSelect() {
                tones.forEach((tone, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = tone.name;
                    toneSelect.appendChild(option);
                });
            }
            
             function populateImageStyleSelect() {
                imageStyles.forEach((style, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = style.name;
                    imageStyleSelect.appendChild(option);
                });
            }

            function populateSentenceLengthSelect() {
                sentenceLengths.forEach(length => {
                    const option = document.createElement('option');
                    option.value = length;
                    option.textContent = length;
                    sentenceLengthSelect.appendChild(option);
                });
            }

            async function handleContinueStory() {
                const userPrompt = promptInput.value.trim();
                if (!userPrompt || isAITurn || getUserPromptCount() >= MAX_PROMPTS) return;

                setLoading(true);

                if (isEditing) {
                    storyHistory[editingParagraphIndex].parts[0].text = userPrompt;
                    storyHistory.splice(editingParagraphIndex + 1);
                } else {
                    storyHistory.push({ role: 'user', parts: [{ text: userPrompt }] });
                }
                
                promptInput.value = '';
                isEditing = false;
                editingParagraphIndex = null;

                try {
                    const aiResponseText = await getAIResponse(storyHistory);
                    storyHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
                    pushToHistory();
                } catch (error) {
                    console.error("Error continuing story:", error);
                     if (error.message.includes("overloaded")) {
                        displaySystemMessage("The AI model is currently busy. Please try again in a moment.", 'error');
                    } else {
                        displaySystemMessage(error.message, 'error');
                    }
                    storyHistory.pop();
                } finally {
                    setLoading(false);
                    updateUIFromHistory();
                }
            }

            function handleAddNarration() {
                const userText = promptInput.value.trim();
                if (!userText || isAITurn) return;

                storyHistory.push({ role: 'narrator', parts: [{ text: userText }] });
                pushToHistory();
                promptInput.value = '';
                updateUIFromHistory();
            }

             async function handleCreateLamination(themePrompt) {
                if(!themePrompt) { // Initial creation
                     currentLaminationText = promptInput.value.trim();
                     if (!currentLaminationText || isAITurn) return;
                     isLaminationMode = true;
                     storyContainer.innerHTML = ''; // Clear story view
                }
               
                setLoading(true);
                storyContainer.innerHTML = `<div id="lamination-creator" class="w-full p-4 flex flex-col items-center"></div>`;
                const laminationCreatorEl = document.getElementById('lamination-creator');

                const imageDisplayContainer = document.createElement('div');
                imageDisplayContainer.id = "lamination-image-container";
                imageDisplayContainer.className = 'w-full max-w-2xl relative pt-[75%] bg-gray-700 rounded-lg flex items-center justify-center';
                imageDisplayContainer.innerHTML = `<svg class="animate-spin h-8 w-8 text-white absolute" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                laminationCreatorEl.appendChild(imageDisplayContainer);

                const controlsContainer = document.createElement('div');
                controlsContainer.id = "lamination-controls";
                controlsContainer.className = "flex items-center gap-4 mt-4";
                laminationCreatorEl.appendChild(controlsContainer);
                
                const imagePrompt = `${themePrompt || 'A beautiful, serene background'}`;

                try {
                    const imageUrl = await generateImage(imagePrompt);
                    imageDisplayContainer.innerHTML = ''; 
                    
                    const img = new Image();
                    img.src = imageUrl;
                    img.className = 'absolute top-0 left-0 w-full h-full object-cover';
                    
                    const textOverlay = document.createElement('div');
                    textOverlay.className = "absolute inset-0 flex items-center justify-center p-8 bg-black bg-opacity-50";
                    textOverlay.innerHTML = `<p class="text-white text-2xl font-semibold text-center whitespace-pre-wrap">${currentLaminationText}</p>`;

                    imageDisplayContainer.appendChild(img);
                    imageDisplayContainer.appendChild(textOverlay);

                    renderLaminationThemes(controlsContainer);
                } catch (error) {
                    console.error("Error creating lamination:", error);
                    imageDisplayContainer.innerHTML = `<p class="text-red-400 text-center p-4">Image generation failed. Please try again.</p>`;
                } finally {
                    setLoading(false);
                }
            }
            
            function renderLaminationThemes(container) {
                container.innerHTML = ''; // Clear old controls

                const themeLabel = document.createElement('label');
                themeLabel.textContent = "Theme:";
                themeLabel.className = "text-sm text-gray-400";

                const themeSelect = document.createElement('select');
                themeSelect.className = "p-2 bg-gray-600 border border-gray-500 rounded-lg text-white";
                
                laminationThemes.forEach(theme => {
                    const option = document.createElement('option');
                    option.value = theme.prompt;
                    option.textContent = theme.name;
                    themeSelect.appendChild(option);
                });

                const redesignButton = document.createElement('button');
                redesignButton.textContent = "Redesign";
                redesignButton.className = "bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg";
                redesignButton.onclick = () => {
                    const selectedThemePrompt = themeSelect.value;
                    const selectedImageStyle = imageStyles[imageStyleSelect.value];
                    handleCreateLamination(`${selectedImageStyle.prefix} of ${selectedThemePrompt}`);
                };
                
                container.appendChild(themeLabel);
                container.appendChild(themeSelect);
                container.appendChild(redesignButton);
            }
            
            // --- UI & Display ---

            function updateUIFromHistory() {
                if (isLaminationMode) return;
                storyContainer.innerHTML = '';
                storyHistory.forEach((part, i) => {
                    if (i === 0) return;
                    addParagraphToUI(part, i);
                });
                storyContainer.scrollTop = storyContainer.scrollHeight;
                updateButtonStates();
                if (!promptInput.disabled) {
                    promptInput.focus();
                }
            }
            
            function addParagraphToUI(part, index) {
                const { role, parts, imageUrl } = part;
                const text = parts[0].text;

                const wrapper = document.createElement('div');
                wrapper.classList.add('story-paragraph-wrapper', 'flex', 'items-start', 'gap-4');
                
                const paragraphContent = document.createElement('div');
                paragraphContent.classList.add('flex-grow', 'p-4', 'rounded-lg');
                
                if (imageUrl) {
                    const imageContainer = document.createElement('div');
                    imageContainer.classList.add('illustration-container');
                    imageContainer.innerHTML = `<img src="${imageUrl}" alt="Generated illustration of the scene" class="w-full h-full">`;
                    paragraphContent.insertBefore(imageContainer, paragraphContent.firstChild);
                }

                const contentTag = document.createElement('p');
                contentTag.textContent = text;
                paragraphContent.appendChild(contentTag);

                const controlsContainer = document.createElement('div');
                controlsContainer.classList.add('flex-shrink-0', 'py-4', 'flex', 'flex-col', 'gap-2');

                if (role === 'user') {
                    wrapper.classList.add('justify-start');
                    paragraphContent.classList.add('user-paragraph', 'rounded-bl-none');
                    const editBtn = createControlButton('Edit', () => enterEditMode(index, text));
                    controlsContainer.appendChild(editBtn);
                    wrapper.appendChild(paragraphContent);
                    wrapper.appendChild(controlsContainer);
                } else if (role === 'model' || role === 'narrator') {
                    wrapper.classList.add('justify-end');
                    paragraphContent.classList.add('ai-paragraph', 'rounded-br-none');

                    if(role === 'narrator'){
                         const editBtn = createControlButton('Edit', () => enterEditMode(index, text));
                         controlsContainer.appendChild(editBtn);
                    } else {
                         const regenBtn = createControlButton('Regen', () => handleRegenerate(index));
                         controlsContainer.appendChild(regenBtn);
                    }

                    const illustrateBtn = createControlButton('Illustrate', () => handleIllustration(index));
                    controlsContainer.appendChild(illustrateBtn);
                    wrapper.appendChild(controlsContainer);
                    wrapper.appendChild(paragraphContent);
                }
                storyContainer.appendChild(wrapper);
            }
            
            function createControlButton(text, onClick) {
                const button = document.createElement('button');
                button.textContent = text;
                button.classList.add('bg-gray-600', 'hover:bg-gray-500', 'text-white', 'text-xs', 'py-1', 'px-2', 'rounded-md', 'transition-colors');
                button.addEventListener('click', onClick);
                return button;
            }

            function displaySystemMessage(text, type = 'system-message') {
                storyContainer.querySelectorAll('.system-message-paragraph, .error-paragraph').forEach(el => el.remove());
                const messageWrapper = document.createElement('div');
                messageWrapper.classList.add('story-paragraph-wrapper', type === 'error' ? 'error-paragraph' : 'system-message-paragraph');
                messageWrapper.innerHTML = text.replace(/\n/g, '<br>');
                storyContainer.appendChild(messageWrapper);
                storyContainer.scrollTop = storyContainer.scrollHeight;
            }

            // --- Edit, Regenerate, Illustrate ---

            function enterEditMode(index, text) {
                if(isAITurn) return;
                isEditing = true;
                editingParagraphIndex = index;
                promptInput.value = text;
                btnText.textContent = 'Update';
                promptInput.focus();
                updateButtonStates();
            }

            async function handleRegenerate(index) {
                if (isAITurn) return;
                setLoading(true);
                
                const historyForRegen = storyHistory.slice(0, index);
                try {
                    const newAiResponse = await getAIResponse(historyForRegen);
                    storyHistory[index].parts[0].text = newAiResponse;
                    storyHistory.splice(index + 1);
                    pushToHistory();
                } catch (error) {
                    console.error("Error regenerating:", error);
                    displaySystemMessage(error.message, 'error');
                } finally {
                    setLoading(false);
                    updateUIFromHistory();
                }
            }
            
            async function handleIllustration(index) {
                 if (isAITurn) return;
                 setLoading(true);
                 
                 const sceneText = storyHistory[index].parts[0].text;
                 const paragraphWrapper = storyContainer.children[index - 1];
                 const paragraphContent = paragraphWrapper.querySelector('.flex-grow');

                 let imageContainer = paragraphContent.querySelector('.illustration-container');
                 if (!imageContainer) {
                     imageContainer = document.createElement('div');
                     imageContainer.classList.add('illustration-container');
                     paragraphContent.insertBefore(imageContainer, paragraphContent.firstChild);
                 }
                 
                 imageContainer.innerHTML = `<div class="loading-placeholder flex items-center justify-center bg-gray-700 text-center p-4"><svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>`;

                 try {
                    const style = imageStyles[currentImageStyleIndex];
                    const imagePrompt = `${style.prefix} of ${sceneText}`;
                    const imageUrl = await generateImage(imagePrompt);
                    imageContainer.innerHTML = `<img src="${imageUrl}" alt="Generated illustration of the scene">`;
                    storyHistory[index].imageUrl = imageUrl;
                    pushToHistory();
                 } catch(error) {
                    console.error("Error generating image:", error);
                    if (error.message.includes("billed users")) {
                        imageContainer.innerHTML = `<p class="text-red-400 text-center">Image generation failed.<br>This feature requires a billed Google Cloud account.</p>`;
                    } else {
                        imageContainer.innerHTML = `<p class="text-red-400 text-center">Image generation failed.</p>`;
                    }
                 } finally {
                    setLoading(false);
                 }
            }
            
            // --- Saving & Export ---

            function handleSaveStory() {
                if (isAITurn || getUserPromptCount() < MIN_PROMPTS_FOR_SAVE) return;
                
                setLoading(true);
                saveAsHtml(getStoryHtml(), 'AI-Woven-Story.html');
                displaySystemMessage("Story saved successfully!", 'system-message');
                setLoading(false);
                updateButtonStates();
            }

            function getStoryHtml() {
                const storyContent = storyHistory
                    .filter(part => part.role === 'model' || part.role === 'narrator')
                    .map(part => {
                        let html = '';
                        if (part.imageUrl) {
                            html += `<div style="position: relative; width: 100%; padding-top: 75%; margin-bottom: 1rem; border-radius: 0.5rem; overflow: hidden;"><img src="${part.imageUrl}" alt="Illustration" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain;"></div>`;
                        }
                        html += `<p>${part.parts[0].text}</p>`;
                        return `<div>${html}</div>`;
                    })
                    .join('');
                return createHtmlWrapper(`<div class="ai-paragraph p-4">${storyContent}</div>`);
            }

            
            function savePrompts() {
                const promptsText = storyHistory
                    .filter(p => p.role === 'user' && p.parts[0].text !== getSystemPrompt().parts[0].text)
                    .map((p, i) => `Prompt ${i + 1}:\n${p.parts[0].text}`)
                    .join('\n\n---\n\n');
                saveAsTxt(promptsText, 'My-Prompts.txt');
            }
            
            function saveWeaver() {
                const weaverText = storyHistory
                    .slice(1)
                    .map(p => {
                        let author = 'Unknown';
                        if(p.role === 'user') author = 'You';
                        else if (p.role === 'model') author = 'Story Weaver';
                        else if (p.role === 'narrator') author = 'Narration';
                        return `[${author}]:\n${p.parts[0].text}`
                    })
                    .join('\n\n');
                saveAsTxt(weaverText, 'Weaver-Chat.txt');
            }

            function createHtmlWrapper(content, title = "AI-Woven Story") {
                const styles = `body{font-family:'Inter',sans-serif;background-color:#111827;color:white;padding:2rem;display:flex;flex-direction:column;align-items:center;} div{border-radius:1rem;margin-bottom:1rem;max-width:800px;width:100%;} .user-paragraph{background-color:#374151;} .ai-paragraph{background-color:#1e293b;} .system-message-paragraph{background-color:#374151;color:#a78bfa;text-align:center;}`;
                return `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>${title}</title><script src="https://cdn.tailwindcss.com"><\/script><style>${styles}</style></head><body>${content}</body></html>`;
            }

            function saveAsTxt(textContent, filename) {
                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function saveAsHtml(htmlContent, filename) {
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            function saveElementAsPng(element, filename) {
                htmlToImage.toPng(element)
                    .then(function (dataUrl) {
                        const a = document.createElement('a');
                        a.href = dataUrl;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    })
                    .catch(function (error) {
                        console.error('oops, something went wrong!', error);
                        displaySystemMessage('Could not save image.', 'error');
                    });
            }

            // --- History & State Management ---

            function pushToHistory() {
                historyStack = historyStack.slice(0, historyPointer + 1);
                historyStack.push(JSON.parse(JSON.stringify(storyHistory)));
                historyPointer++;
                updateButtonStates();
            }

            function handleUndo() {
                if (historyPointer > 0) {
                    historyPointer--;
                    storyHistory = JSON.parse(JSON.stringify(historyStack[historyPointer]));
                    updateUIFromHistory();
                }
            }

            function handleRedo() {
                if (historyPointer < historyStack.length - 1) {
                    historyPointer++;
                    storyHistory = JSON.parse(JSON.stringify(historyStack[historyPointer]));
                    updateUIFromHistory();
                }
            }

            function getUserPromptCount() {
                return storyHistory.filter(p => p.role === 'user').length - 1; // Subtract system prompt
            }

            function updateButtonStates() {
                const promptCount = getUserPromptCount();
                const isStoryComplete = promptCount >= MAX_PROMPTS;
                const canSave = promptCount >= MIN_PROMPTS_FOR_SAVE;
                
                const isBusy = isAITurn;
                
                continueBtn.disabled = isBusy || isStoryComplete || isEditing;
                addNarrationBtn.disabled = isBusy || isEditing;
                
                if(isEditing) {
                    btnText.textContent = 'Update';
                } else {
                     btnText.textContent = 'Add to Story';
                }

                if (isStoryComplete && !isBusy) {
                    promptInput.placeholder = "Story complete! You can save your story now.";
                    promptInput.disabled = true;
                } else {
                    promptInput.placeholder = `Add prompt ${promptCount + 1} of ${MAX_PROMPTS}...`;
                    promptInput.disabled = isBusy;
                }

                undoBtn.disabled = isBusy || historyPointer <= 0;
                redoBtn.disabled = isBusy || historyPointer >= historyStack.length - 1;
                
                saveStoryBtn.disabled = isBusy || !canSave;
                saveWeaverBtn.disabled = isBusy || storyHistory.length <= 1;
                savePromptsBtn.disabled = isBusy || promptCount < 1;
                saveLaminationBtn.disabled = isBusy || !isLaminationMode;
                saveNarrationBtn.disabled = isBusy || !storyHistory.some(p => p.role === 'narrator');
            }
            
            function setLoading(isLoading) {
                isAITurn = isLoading;
                loadingSpinner.classList.toggle('hidden', !isLoading);
                continueBtn.disabled = isLoading;
                addNarrationBtn.disabled = isLoading;
                createLaminationBtn.disabled = isLoading;
                updateButtonStates();
            }

            async function getAIResponse(history) {
                const apiKey = "AIzaSyA29N25PG96j0NURl1m-Hn8ydX9P_X97kY";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const cleanHistory = history.map(({role, parts}) => ({role, parts}));

                const payload = { contents: cleanHistory };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const responseText = await response.text();

                if (!response.ok) {
                    const errorData = JSON.parse(responseText || "{}");
                    throw new Error(errorData?.error?.message || `API request failed with status ${response.status}`);
                }
                const result = JSON.parse(responseText);
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error(`Unexpected API response format.`);
                }
            }
            
             async function generateImage(prompt) {
                const apiKey = "AIzaSyA29N25PG96j0NURl1m-Hn8ydX9P_X97kY";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                
                const payload = {
                    instances: [{ "prompt": prompt }],
                    parameters: { "sampleCount": 1 }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Image generation API error:", errorText);
                    throw new Error(`Image generation failed with status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                } else {
                    console.error("Unexpected image generation response:", result);
                    throw new Error('Could not retrieve image from API response.');
                }
            }
            
            // --- Event Listeners ---
            continueBtn.addEventListener('click', handleContinueStory);
            addNarrationBtn.addEventListener('click', handleAddNarration);
            createLaminationBtn.addEventListener('click', () => handleCreateLamination());
            promptInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleContinueStory();
                }
            });
            
            resetStoryBtn.addEventListener('click', resetApp);
            saveStoryBtn.addEventListener('click', handleSaveStory);
            saveWeaverBtn.addEventListener('click', saveWeaver);
            savePromptsBtn.addEventListener('click', savePrompts);
            saveLaminationBtn.addEventListener('click', () => saveElementAsPng(document.querySelector('#lamination-creator > div'), 'lamination.png'));
            saveNarrationBtn.addEventListener('click', () => {
                const narrationBlocks = document.querySelectorAll('.ai-paragraph');
                const lastNarration = Array.from(narrationBlocks).pop();
                if(lastNarration) saveElementAsPng(lastNarration, 'narration.png')
            });
            
            undoBtn.addEventListener('click', handleUndo);
            redoBtn.addEventListener('click', handleRedo);
            helpIcon.addEventListener('click', () => { instructionsModal.classList.remove('hidden'); });
            closeInstructionsModalBtn.addEventListener('click', () => { instructionsModal.classList.add('hidden'); });
            instructionsModal.addEventListener('click', (e) => {
                if (e.target === instructionsModal) {
                    instructionsModal.classList.add('hidden');
                }
            });


            personaSelect.addEventListener('change', (e) => { currentPersonaIndex = parseInt(e.target.value); resetApp() });
            toneSelect.addEventListener('change', (e) => { currentToneIndex = parseInt(e.target.value); resetApp() });
            imageStyleSelect.addEventListener('change', (e) => { currentImageStyleIndex = parseInt(e.target.value); });
            sentenceLengthSelect.addEventListener('change', (e) => { currentSentenceLength = parseInt(e.target.value); resetApp(); });


            // --- Initialization ---
            initializeApp();
        });
    </script>
</body>
</html>
