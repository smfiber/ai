<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Story Weaver</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html-to-image library for PNG export (for illustrations) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .story-paragraph-wrapper { opacity: 0; transform: translateY(20px); animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        .user-paragraph { background-image: linear-gradient(to right, #374151, #2f3743); }
        .ai-paragraph { background-image: linear-gradient(to left, #1e293b, #1a222f); }
        .error-paragraph, .system-message-paragraph { align-self: center; text-align: center; padding: 1rem; border-radius: 0.5rem; font-weight: bold; max-width: 80%; }
        .error-paragraph { background-color: #dc2626; color: #fee2e2; }
        .system-message-paragraph { background-color: #374151; color: #a78bfa; white-space: pre-wrap; }
        #story-container::-webkit-scrollbar, textarea::-webkit-scrollbar, #instructions-modal-content::-webkit-scrollbar, .custom-dropdown-content::-webkit-scrollbar { width: 8px; }
        #story-container::-webkit-scrollbar-track, textarea::-webkit-scrollbar-track, #instructions-modal-content::-webkit-scrollbar-track, .custom-dropdown-content::-webkit-scrollbar-track { background: #1f2937; }
        #story-container::-webkit-scrollbar-thumb, textarea::-webkit-scrollbar-thumb, #instructions-modal-content::-webkit-scrollbar-thumb, .custom-dropdown-content::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        #story-container::-webkit-scrollbar-thumb:hover, textarea::-webkit-scrollbar-thumb:hover, #instructions-modal-content::-webkit-scrollbar-thumb:hover, .custom-dropdown-content::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .illustration-container { margin-bottom: 1rem; position: relative; width: 100%; padding-top: 56.25%; /* 16:9 Aspect Ratio */ border-radius: 0.5rem; overflow: hidden; }
        .illustration-container img, .illustration-container .loading-placeholder { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        .dropdown-label {
            display: block;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        .dropdown-label:hover {
            background-color: #374151;
        }
        .dropdown-label input {
            margin-right: 0.75rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-full flex items-center justify-center p-4 antialiased">
    <div id="app-container" class="w-full max-w-6xl h-[95vh] flex flex-col bg-gray-800 rounded-2xl shadow-2xl p-4 sm:p-6">
        <!-- Header Section -->
        <header class="flex flex-col w-full mb-4 pb-4 border-b border-gray-700">
            <div class="flex justify-between items-center w-full mb-4">
                 <div class="flex-shrink-0">
                    <h1 class="text-2xl font-bold text-white flex items-baseline gap-2">
                        AI Story Weaver
                        <!-- NOTE TO DEVS: Remember to increment the version number for each revision. -->
                        <span id="version-number" class="text-xs font-mono bg-gray-700 px-2 py-1 rounded">2.05</span>
                        <button id="help-icon" title="How to Use">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-question-circle text-gray-400 hover:text-white" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                            </svg>
                        </button>
                    </h1>
                     <p class="text-sm text-gray-400 mt-1 max-w-xs">Collaboratively write stories with an AI partner.</p>
                </div>
                <div class="flex items-end gap-4">
                    <div class="w-48 relative">
                        <label class="block mb-1 text-gray-400 text-sm">AI Persona:</label>
                        <button id="persona-dropdown-button" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-base text-left focus:ring-indigo-500 focus:border-indigo-500 flex justify-between items-center truncate">
                            <span>Select Persona</span>
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="persona-dropdown-content" class="hidden absolute z-20 w-full mt-1 bg-gray-800 border border-gray-600 rounded-lg shadow-lg max-h-60 overflow-y-auto custom-dropdown-content"></div>
                    </div>
                    <div class="w-48">
                        <label for="tone-select" class="block mb-1 text-gray-400 text-sm">Story Tone:</label>
                        <select id="tone-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-base focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                     <div class="w-48 relative">
                        <label class="block mb-1 text-gray-400 text-sm">Image Style:</label>
                        <button id="style-dropdown-button" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-base text-left focus:ring-indigo-500 focus:border-indigo-500 flex justify-between items-center">
                            <span>Select Styles (0)</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="style-dropdown-content" class="hidden absolute z-10 w-full mt-1 bg-gray-800 border border-gray-600 rounded-lg shadow-lg max-h-60 overflow-y-auto custom-dropdown-content"></div>
                    </div>
                     <div class="w-32">
                        <label for="sentence-length-select" class="block mb-1 text-gray-400 text-sm">Sentences:</label>
                        <select id="sentence-length-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-base focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                </div>
            </div>
             <div class="flex items-center justify-end gap-2 mt-3 w-full">
                <button id="save-story-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Save Story</button>
                <button id="save-weaver-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Save Weaver</button>
                <button id="save-prompts-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Save Prompts</button>
                <span class="border-l border-gray-600 h-4 mx-2"></span>
                <button id="undo-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Undo</button>
                <button id="redo-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Redo</button>
                <button id="reset-story-btn" class="bg-red-700 hover:bg-red-600 text-white text-xs py-1 px-3 rounded-lg transition-colors">New Story</button>
            </div>
        </header>

        <!-- Story Display Area -->
        <main id="story-container" class="flex-grow w-full min-h-0 overflow-y-auto p-4 space-y-6 flex flex-col"></main>
        
        <!-- User Input Area -->
        <footer class="mt-4 pt-4 border-t border-gray-700">
            <textarea id="prompt-input" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none transition resize-none" rows="3" placeholder="Add the next part of the story..."></textarea>
            <div class="flex justify-end items-center mt-2 gap-4">
                <button id="continue-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg active:scale-95 flex items-center gap-2 disabled:bg-gray-500 disabled:cursor-not-allowed">
                    <span id="btn-text">Add to Story</span>
                    <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </footer>
    </div>
    
    <!-- Instructions Modal -->
    <div id="instructions-modal" class="hidden fixed inset-0 bg-black/75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-3xl h-[80vh] flex flex-col">
            <!-- NOTE TO DEVS: Remember to update this modal's content with any feature changes. -->
            <h2 class="text-2xl font-bold mb-4 text-white text-center">How to Use AI Story Weaver</h2>
            <div id="instructions-modal-content" class="flex-grow overflow-y-auto pr-4 text-gray-300 space-y-4">
                <div class="prose prose-invert">
                    <h3 class="font-semibold text-white">Core Controls</h3>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>Add to Story:</strong> Submits your text as a prompt for the AI to continue the narrative. This is the main way to build your story turn-by-turn.</li>
                        <li><strong>Update:</strong> After clicking "Edit" on one of your prompts, this button will appear. It saves your changes and regenerates the story from that point onward.</li>
                    </ul>
                    <h3 class="font-semibold text-white mt-4">Creative Direction</h3>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>AI Persona:</strong> Choose the AI's personality from the searchable dropdown menu. This sets the overall narrative style and voice. Changing this will start a new story.</li>
                        <li><strong>Story Tone:</strong> Select the emotional mood of the AI's writing. Changing this will also start a new story.</li>
                        <li><strong>Image Style:</strong> Click the button to open a dropdown where you can select one or more artistic styles for the illustrations you generate.</li>
                        <li><strong>Sentences:</strong> Control the length of the AI's response (1-5 sentences, or Unlimited for a longer response).</li>
                    </ul>
                     <h3 class="font-semibold text-white mt-4">Editing & Refining</h3>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>Edit:</strong> Appears next to your prompts. Click to modify your text. The main button will change to "Update". You will be asked to confirm before the story is changed.</li>
                        <li><strong>Regen:</strong> Appears next to AI-generated paragraphs. Click to ask the AI for a different response based on the same preceding text.</li>
                        <li><strong>Illustrate:</strong> Appears next to AI-generated paragraphs. Click to generate an image based on the text of that paragraph. You can re-click to get a new image.</li>
                         <li><strong>Undo/Redo:</strong> Step backward or forward through your story's history.</li>
                    </ul>
                     <h3 class="font-semibold text-white mt-4">Saving Your Work</h3>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>Save Story (HTML):</strong> Saves the full story, including dialogue and images, as a self-contained HTML file with a generated title.</li>
                        <li><strong>Save Weaver:</strong> Saves the complete back-and-forth dialogue between you and the AI as a .txt file.</li>
                        <li><strong>Save Prompts:</strong> Saves only your prompts as a .txt file.</li>
                    </ul>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button id="close-instructions-modal-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-update-modal" class="hidden fixed inset-0 bg-black/75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md text-center">
            <h3 class="text-xl font-bold mb-2 text-white">Confirm Update</h3>
            <p class="text-gray-300 mb-6">This will change your prompt and regenerate all following parts of the story. Are you sure you want to continue?</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-update-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">Cancel</button>
                <button id="confirm-update-btn" class="bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">Confirm</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const storyContainer = document.getElementById('story-container');
            const promptInput = document.getElementById('prompt-input');
            const continueBtn = document.getElementById('continue-btn');
            const btnText = document.getElementById('btn-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const personaDropdownButton = document.getElementById('persona-dropdown-button');
            const personaDropdownContent = document.getElementById('persona-dropdown-content');
            const toneSelect = document.getElementById('tone-select');
            const styleDropdownButton = document.getElementById('style-dropdown-button');
            const styleDropdownContent = document.getElementById('style-dropdown-content');
            const sentenceLengthSelect = document.getElementById('sentence-length-select');
            const resetStoryBtn = document.getElementById('reset-story-btn');
            const saveStoryBtn = document.getElementById('save-story-btn');
            const saveWeaverBtn = document.getElementById('save-weaver-btn');
            const savePromptsBtn = document.getElementById('save-prompts-btn');
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            const helpIcon = document.getElementById('help-icon');
            const instructionsModal = document.getElementById('instructions-modal');
            const closeInstructionsModalBtn = document.getElementById('close-instructions-modal-btn');
            const confirmUpdateModal = document.getElementById('confirm-update-modal');
            const confirmUpdateBtn = document.getElementById('confirm-update-btn');
            const cancelUpdateBtn = document.getElementById('cancel-update-btn');

            // --- Application State ---
            const MAX_PROMPTS = 10;
            let isAITurn = false;
            let isEditing = false;
            let editingParagraphIndex = null;
            let currentPersonaIndex = 0;
            let currentToneIndex = 0;
            let currentSentenceLength = 2;

            let storyHistory = [];
            let historyStack = [];
            let historyPointer = -1;

            // --- Persona, Tone, Style & Length Data (Sorted) ---
             const personas = [
                { name: "The Ally/Companion", systemPrompt: "You are The Ally/Companion. A loyal friend or supporter to the protagonist who offers aid, comic relief, or serves as a moral sounding board." },
                { name: "The Archetype Bender/Deconstructor", systemPrompt: "You are The Archetype Bender/Deconstructor. Intentionally subvert or combine traditional archetypes in novel ways for unique storytelling." },
                { name: "The Beat Poet", systemPrompt: "You are The Beat Poet. Rebellious, improvisational, and rhythmic, exploring themes of freedom, existentialism, and counter-culture." },
                { name: "The Caregiver", systemPrompt: "You are The Caregiver. A selfless, compassionate, and nurturing figure driven to protect and help others." },
                { name: "The Cosmic Horror Protagonist", systemPrompt: "You are The Cosmic Horror Protagonist. An ordinary academic who stumbles upon a terrifying, incomprehensible truth about the universe. The narrative is one of psychological unraveling." },
                { name: "The Creator/Artist", systemPrompt: "You are The Creator/Artist. Fueled by imagination and innovation, driven to bring new ideas and visions into existence." },
                { name: "The Dialogue Writer", systemPrompt: "You are The Dialogue Writer. Specialize in generating realistic, character-driven dialogue for specific personas or scenes." },
                { name: "The Emotional Instigator", systemPrompt: "You are The Emotional Instigator. Explore complex emotions, psychological states, and character motivations, often for dramatic effect." },
                { name: "The Ethical Dilemma Presenter", systemPrompt: "You are The Ethical Dilemma Presenter. Craft narratives that explore moral ambiguities, difficult choices, and their consequences." },
                { name: "The Everyman/Everywoman", systemPrompt: "You are The Orphan/Everyman. A relatable, down-to-earth individual who seeks belonging and connection. They often feel unprivileged or like an outcast but have a strong sense of empathy and resilience." },
                { name: "The Explorer", systemPrompt: "You are The Explorer. Driven by curiosity, a thirst for discovery, and a desire to push boundaries and experience the unknown." },
                { name: "The Femme Fatale", systemPrompt: "You are The Femme Fatale. A mysterious and alluring woman who leads men into dangerous or compromising situations. She is often cynical and has her own hidden agenda." },
                { name: "The Friendly Children's Storyteller", systemPrompt: "You are The Friendly Children's Storyteller. A warm, whimsical, and reassuring voice that uses simple language, repetition, and clear moral lessons." },
                { name: "The Game Master (GM)", systemPrompt: "You are The Tabletop Game Master (GM). A master of exposition and improvisation who sets scenes vividly, introduces characters (NPCs) with distinct voices, and presents challenges, often in the second person ('You enter the tavern...')." },
                { name: "The Gentle Guide", systemPrompt: "You are The Gentle Guide. Empathetic, validating, and patient. This persona focuses on emotional exploration and self-discovery, often asking gentle, probing questions." },
                { name: "The Genre Specialist", systemPrompt: "You are The Genre Specialist. Generate stories adhering strictly to the conventions of a specific genre (e.g., 'Hard Sci-Fi,' 'Cozy Mystery,' 'Gritty Noir')." },
                { name: "The Hardboiled Detective", systemPrompt: "You are The Hardboiled Detective. Cynical, world-weary, direct, and observant, with terse dialogue and vivid descriptions of urban grit and crime." },
                { name: "The Healer", systemPrompt: "You are The Healer. Focused on mending what is broken—physically, spiritually, or psychologically. Possesses specialized knowledge or an innate gift for restoration." },
                { name: "The Herald", systemPrompt: "You are The Herald. A character who delivers a message or announcement that signals a coming change or a call to adventure." },
                { name: "The Hero", systemPrompt: "You are The Hero. Driven by courage and a desire to prove their worth, the Hero embarks on a journey, faces challenges, and makes sacrifices for a greater good." },
                { name: "The Idea Generator/Creative Muse", systemPrompt: "You are The Idea Generator/Creative Muse. Focus on brainstorming plot twists, character concepts, unique settings, or overcoming writer's block." },
                { name: "The Innocent", systemPrompt: "You are The Innocent. Embodies purity, optimism, simplicity, and a desire for happiness and safety. This archetype is often naive and vulnerable but possesses an unwavering faith and moral compass." },
                { name: "The Interactive Story Guide", systemPrompt: "You are The Interactive Story Guide. Facilitate choose-your-own-adventure style narratives, adapting the story based on user choices." },
                { name: "The Investigative Journalist", systemPrompt: "You are The Investigative Journalist. Factual, objective, and curious. This persona presents information in a structured, evidence-based manner." },
                { name: "The Jester/Fool", systemPrompt: "You are The Jester/Fool. Lives in the moment, using humor and wit to break tension, provide comic relief, or subtly expose truths." },
                { name: "The Judge/Arbiter", systemPrompt: "You are The Judge/Arbiter. Embodies impartiality, reason, and the quest for justice. The Judge weighs evidence, makes difficult decisions, and restores balance." },
                { name: "The Lore Master/World-Builder", systemPrompt: "You are The Lore Master/World-Builder. Your role is to help users develop intricate world details, histories, and background lore for their stories." },
                { name: "The Lover", systemPrompt: "You are The Lover. Guided by passion, intimacy, and a desire for unity. The Lover can be romantic and idealistic but is also prone to irrationality or obsession." },
                { name: "The Magician", systemPrompt: "You are The Magician. Transforms reality by harnessing knowledge and intuition, creating impactful change and wonder." },
                { name: "The Maiden", systemPrompt: "You are The Maiden. Represents purity, beauty, and new beginnings. She is often in need of rescue but can also be a catalyst for change." },
                { name: "The Martyr", systemPrompt: "You are The Martyr. Willingly suffers or sacrifices their life for a cause, a belief, or for the sake of others." },
                { name: "The Mentor/Sage", systemPrompt: "You are The Sage/Mentor. Embodies wisdom, insight, and profound understanding. The Sage guides the protagonist, providing crucial knowledge or skills." },
                { name: "The Mindfulness Guide", systemPrompt: "You are The Mindfulness Guide. The voice is calm, present, and observational, using simple language and sensory details to draw focus to the 'now'." },
                { name: "The Motivational Coach", systemPrompt: "You are The Motivational Coach. Energetic, direct, and empowering. This persona uses positive affirmations and speaks directly to the reader to build confidence." },
                { name: "The Mystical Poet", systemPrompt: "You are The Mystical Poet. Inspired by devotional poets like Rumi or Hafiz, this persona uses ecstatic, metaphorical, and often paradoxical language to explore themes of divine love and transcendence." },
                { name: "The Productivity Hacker", systemPrompt: "You are The Productivity Hacker. A data-driven, efficient, and methodical voice that uses frameworks, bullet points, and clear, concise language." },
                { name: "The Rebel/Outlaw", systemPrompt: "You are The Rebel/Outlaw. Challenges the status quo, embraces rebellion, and seeks radical change or vengeance." },
                { name: "The Ruler", systemPrompt: "You are The Ruler. Values control, order, and leadership, striving to create a stable and successful environment." },
                { name: "The Shadow", systemPrompt: "You are The Shadow. Represents the repressed, darker impulses or unacknowledged aspects of a protagonist's personality." },
                { name: "The Southern Gothic Voice", systemPrompt: "You are The Southern Gothic Voice. Atmospheric and melancholic, this voice explores decay, grotesque elements, and dark secrets within a specific regional setting." },
                { name: "The Stoic Philosopher", systemPrompt: "You are The Stoic Philosopher. A voice of reason, resilience, and self-control. This persona writes with clarity and logic, focusing on what we can and cannot control." },
                { name: "The Style Mimic", systemPrompt: "You are The Style Mimic. Generate stories in the style of a specific author, literary movement, or historical period." },
                { name: "The Temptress/Seducer", systemPrompt: "You are The Temptress/Seducer. Uses beauty, charm, or promises of pleasure and power to manipulate or lead others astray." },
                { name: "The Trickster", systemPrompt: "You are The Trickster. A chaotic, mischievous, and often amoral figure who delights in deception and subverting expectations." },
                { name: "The Villain", systemPrompt: "You are The Villain. The primary antagonist who actively seeks to harm or oppose the protagonist, driven by malice, greed, power, or ideology." }
             ].sort((a, b) => a.name.localeCompare(b.name));

            const tones = [
                { name: "Informative/Explanatory", description: "an informative and explanatory" },
                { name: "Neutral/Objective", description: "a neutral and objective" },
                { name: "Formal", description: "a formal" },
                { name: "Enthusiastic/Optimistic", description: "an enthusiastic and optimistic" },
                { name: "Descriptive/Evocative", description: "a descriptive and evocative" },
                { name: "Mysterious/Suspenseful", description: "a mysterious and suspenseful" },
                { name: "Whimsical/Fantastical", description: "a whimsical and fantastical" },
                { name: "Melancholic/Somber", description: "a melancholic and somber" },
                { name: "Humorous/Playful", description: "a humorous and playful" },
                { name: "Dramatic/Intense", description: "a dramatic and intense" },
                { name: "Sarcastic/Ironic", description: "a sarcastic and ironic" },
                { name: "Cynical/Skeptical", description: "a cynical and skeptical" },
                { name: "Nostalgic", description: "a nostalgic" },
                { name: "Urgent/Pressing", description: "an urgent and pressing" },
                { name: "Philosophical/Reflective", description: "a philosophical and reflective" },
                { name: "Gritty/Realistic", description: "a gritty and realistic" },
                { name: "Empathetic/Compassionate", description: "an empathetic and compassionate" },
                { name: "Authoritative/Confident", description: "an authoritative and confident" },
                { name: "Playful/Flirty", description: "a playful and flirty" },
                { name: "Foreboding/Ominous", description: "a foreboding and ominous" }
            ].sort((a, b) => a.name.localeCompare(b.name));

            const imageStyles = [
                { name: "Academic Art", prefix: "in the style of Academic Art, highly polished, with technically precise and idealized forms" },
                { name: "Abstract Expressionism", prefix: "in the style of Abstract Expressionism, with large scale, spontaneous brushwork and emotional intensity" },
                { name: "Afrofuturism", prefix: "in the style of Afrofuturism, combining sci-fi, fantasy, and African culture" },
                { name: "Anime", prefix: "in a vibrant, high-quality anime style, with cinematic lighting" },
                { name: "Art Deco", prefix: "in an elegant Art Deco style, featuring geometric patterns and bold lines" },
                { name: "Art Nouveau", prefix: "in an Art Nouveau style, with organic, flowing lines and natural forms" },
                { name: "Baroque", prefix: "in a Baroque style, with dramatic light and shadow (tenebrism) and intense emotion" },
                { name: "Bauhaus", prefix: "in a Bauhaus style, with minimalism, functionality, and geometric forms" },
                { name: "Biedermeier", prefix: "in a Biedermeier style, depicting comfortable, quiet, and intimate domesticity" },
                { name: "Biopunk", prefix: "in a Biopunk style, with visceral forms and biological manipulation themes" },
                { name: "Blueprint", prefix: "as a detailed blueprint diagram, with annotations and technical specifications" },
                { name: "Byzantine Mosaic", prefix: "as a Byzantine mosaic, with gold tesserae and shimmering, majestic light" },
                { name: "Celtic Knotwork", prefix: "with intricate Insular Art (Celtic Knotwork) interlace patterns and zoomorphic designs" },
                { name: "Charcoal Sketch", prefix: "as a dramatic charcoal sketch on textured paper, with high contrast" },
                { name: "Concept Art", prefix: "as detailed concept art for a film or video game" },
                { name: "Constructivism", prefix: "in a Constructivist style, with geometric abstraction and functional forms" },
                { name: "Cubism", prefix: "in a Cubist style, fragmented and abstracted from multiple viewpoints" },
                { name: "Cyberpunk", prefix: "in a neon-drenched cyberpunk aesthetic, with a grimy, high-tech feel" },
                { name: "Dada", prefix: "as a Dadaist collage, absurd and nonsensical" },
                { name: "De Stijl", prefix: "in the De Stijl style, with rigid geometric abstraction and primary colors" },
                { name: "Digital Art", prefix: "as modern digital art" },
                { name: "Dutch Golden Age", prefix: "in the style of the Dutch Golden Age, with realistic portraiture and masterful use of light" },
                { name: "Expressionism", prefix: "in an Expressionist style, with emotional intensity and distorted figures" },
                { name: "Fantasy Art", prefix: "as epic fantasy art, with dramatic lighting and mystical elements" },
                { name: "Fauvism", prefix: "in a Fauvist style, with bold, non-naturalistic colors and expressive brushwork" },
                { name: "Fractal Art", prefix: "as intricate fractal art, with complex, self-similar mathematical patterns" },
                { name: "Futurism", prefix: "in a Futurist style, depicting dynamic movement, technology, and speed" },
                { name: "Game Art", prefix: "in a modern, stylized 3D game art aesthetic" },
                { name: "Generative Art", prefix: "as algorithm-based generative art" },
                { name: "Glitch Art", prefix: "with intentional digital glitches, pixelation, and distortion" },
                { name: "Gothic Illuminated Manuscript", prefix: "as a Gothic illuminated manuscript, with delicate details and vibrant colors" },
                { name: "Gothic Stained Glass", prefix: "as Gothic stained glass, with deep, jewel-like colors and strong lead lines" },
                { name: "Graffiti", prefix: "in a bold, urban graffiti or street art style" },
                { name: "Greek Vase Painting", prefix: "in the style of Ancient Greek red-figure or black-figure vase painting" },
                { name: "High Renaissance", prefix: "in the style of the High Renaissance, with chiaroscuro and anatomical accuracy" },
                { name: "Hieroglyphic", prefix: "as an Ancient Egyptian hieroglyphic, with flat, profile figures and symbolic imagery" },
                { name: "Hyperrealism", prefix: "as a hyperrealistic, photorealistic painting, with extreme detail" },
                { name: "Impressionism", prefix: "in an Impressionist style, with visible brushstrokes focusing on light and atmosphere" },
                { name: "Islamic Geometric Pattern", prefix: "with intricate Islamic geometric patterns (Arabesque)" },
                { name: "Jugendstil", prefix: "in a Jugendstil (German Art Nouveau) style, with linear, geometric patterns" },
                { name: "Low Poly", prefix: "as a stylized low poly 3D render" },
                { name: "Mannerism", prefix: "in a Mannerist style, with elongated figures and dramatic lighting" },
                { name: "Medieval Tapestry", prefix: "as a medieval narrative tapestry, like the Bayeux Tapestry" },
                { name: "Minimalism", prefix: "in a minimalist style, focusing on simplicity and basic elements" },
                { name: "Neoclassicism", prefix: "in a Neoclassical style, with strict lines and classical subject matter" },
                { name: "Oil Painting", prefix: "as a classic oil painting with rich colors and visible texture" },
                { name: "Op Art", prefix: "as Op Art, with geometric patterns creating optical illusions" },
                { name: "Photorealistic", prefix: "as a photorealistic, cinematic, 4k, high-resolution photograph" },
                { name: "Pixel Art", prefix: "as detailed 16-bit pixel art" },
                { name: "Pop Art", prefix: "in a Pop Art style, with bold colors and a comic book feel" },
                { name: "Post-Impressionism", prefix: "in a Post-Impressionist style, with symbolic color and expressive brushwork" },
                { name: "Pre-Raphaelite", prefix: "in a Pre-Raphaelite style, with intense detail, vivid colors, and rich symbolism" },
                { name: "Realism", prefix: "in a Realist style, depicting an unidealized, everyday scene" },
                { name: "Rococo", prefix: "in a light, playful Rococo style with pastel colors and ornate decoration" },
                { name: "Roman Fresco", prefix: "as a Roman fresco, with vibrant colors and an illusion of depth" },
                { name: "Romanticism", prefix: "in a Romanticist style, emphasizing emotion, drama, and the sublime" },
                { name: "Solarpunk", prefix: "in an optimistic Solarpunk aesthetic, with eco-friendly technology and lush environments" },
                { name: "Steampunk", prefix: "in a detailed Steampunk style, featuring gears, cogs, and Victorian-era technology" },
                { name: "Street Art", prefix: "in a bold, urban street art style" },
                { name: "Suprematism", prefix: "in a Suprematist style, with pure geometric forms and a limited color palette" },
                { name: "Surrealism", "prefix": "in a dream-like, surrealist style with illogical juxtapositions" },
                { name: "Symbolism", prefix: "in a Symbolist style, evoking dreams and the subconscious with mysterious imagery" },
                { name: "Synthwave", prefix: "in a Synthwave aesthetic, with neon grids and a retro-futuristic 1980s feel" },
                { name: "Vaporwave", prefix: "in a Vaporwave aesthetic, with digital glitches, classical sculptures, and pastel colors" },
                { name: "Vintage Photo", prefix: "as a vintage, sepia-toned photograph from the 1940s" },
                { name: "Watercolor", prefix: "as a beautiful watercolor painting with soft, translucent colors" }
            ].sort((a, b) => a.name.localeCompare(b.name));

            const sentenceLengths = [1, 2, 3, 4, 5, 0]; // 0 represents "Unlimited"

            // --- Core Functions ---

            function initializeApp() {
                populatePersonaSelect();
                populateToneSelect();
                populateImageStyleSelect();
                populateSentenceLengthSelect();
                
                currentPersonaIndex = personas.findIndex(p => p.name === "The Hero");
                currentToneIndex = tones.findIndex(t => t.name === "Descriptive/Evocative");
                updatePersonaButton(currentPersonaIndex);
                toneSelect.value = currentToneIndex;
                sentenceLengthSelect.value = 2;

                resetApp();
                addEventListeners();
            }

            function addEventListeners() {
                const primaryAction = () => {
                    if (isEditing) {
                        confirmUpdateModal.classList.remove('hidden');
                    } else {
                        handleAddNewPart();
                    }
                };

                continueBtn.addEventListener('click', primaryAction);
                promptInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        primaryAction();
                    }
                });
            
                resetStoryBtn.addEventListener('click', resetApp);
                saveStoryBtn.addEventListener('click', saveStoryAsHtml);
                saveWeaverBtn.addEventListener('click', () => {
                    const weaverText = storyHistory
                        .map(p => {
                            let author = p.role === 'user' ? 'You' : 'AI Story Weaver';
                            return `[${author}]:\n${p.parts[0].text}`
                        })
                        .join('\n\n');
                    saveAsTxt(weaverText, 'Weaver-Chat.txt');
                });
                savePromptsBtn.addEventListener('click', () => {
                    const promptsText = storyHistory
                        .filter(p => p.role === 'user')
                        .map((p, i) => `Prompt ${i + 1}:\n${p.parts[0].text}`)
                        .join('\n\n---\n\n');
                    saveAsTxt(promptsText, 'My-Prompts.txt');
                });

                undoBtn.addEventListener('click', handleUndo);
                redoBtn.addEventListener('click', handleRedo);
                helpIcon.addEventListener('click', () => { instructionsModal.classList.remove('hidden'); });
                closeInstructionsModalBtn.addEventListener('click', () => { instructionsModal.classList.add('hidden'); });
                
                confirmUpdateBtn.addEventListener('click', () => {
                    confirmUpdateModal.classList.add('hidden');
                    handleUpdateAndRegenerate();
                });
                cancelUpdateBtn.addEventListener('click', () => {
                     confirmUpdateModal.classList.add('hidden');
                });
                
                styleDropdownButton.addEventListener('click', () => {
                    styleDropdownContent.classList.toggle('hidden');
                });

                personaDropdownButton.addEventListener('click', () => {
                    personaDropdownContent.classList.toggle('hidden');
                });

                document.addEventListener('click', (event) => {
                    if (!styleDropdownButton.contains(event.target) && !styleDropdownContent.contains(event.target)) {
                        styleDropdownContent.classList.add('hidden');
                    }
                    if (!personaDropdownButton.contains(event.target) && !personaDropdownContent.contains(event.target)) {
                        personaDropdownContent.classList.add('hidden');
                    }
                });

                toneSelect.addEventListener('change', (e) => { currentToneIndex = parseInt(e.target.value); resetApp() });
                sentenceLengthSelect.addEventListener('change', (e) => { currentSentenceLength = parseInt(e.target.value); resetApp(); });
            }

            function resetApp() {
                storyContainer.innerHTML = '';
                storyHistory = [ ];
                historyStack = [ JSON.parse(JSON.stringify(storyHistory)) ];
                historyPointer = 0;
                isEditing = false;
                editingParagraphIndex = null;
                
                updateUIFromHistory();
                displaySystemMessage("Provide a prompt to begin your story.", 'system-message');
                promptInput.focus();
            }
            
            function getSystemInstructionString() {
                const selectedPersona = personas[currentPersonaIndex];
                const selectedTone = tones[currentToneIndex];
                let lengthConstraint = `Limit your response to exactly ${currentSentenceLength} sentence(s).`;
                if(currentSentenceLength == 0) {
                     lengthConstraint = "There is no limit to the length of your response.";
                }
                return `${selectedPersona.systemPrompt} Continue the story based on the user's prompt. The story should have ${selectedTone.description} tone. ${lengthConstraint}`;
            }

            function populateSelect(selectElement, dataArray) {
                selectElement.innerHTML = '';
                dataArray.forEach((item, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = item.name || item;
                    if(item === 0) option.textContent = "Unlimited";
                    selectElement.appendChild(option);
                });
            }

            function populateToneSelect() { populateSelect(toneSelect, tones); }
            function populateSentenceLengthSelect() { populateSelect(sentenceLengthSelect, sentenceLengths); }
            
            function populatePersonaSelect() {
                personaDropdownContent.innerHTML = '';
                personas.forEach((persona, index) => {
                    const label = document.createElement('label');
                    label.className = 'dropdown-label';
                    
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'persona';
                    radio.value = index;
                    radio.className = 'accent-indigo-500';
                    if (index === currentPersonaIndex) {
                        radio.checked = true;
                    }

                    radio.addEventListener('change', () => {
                        currentPersonaIndex = parseInt(radio.value);
                        updatePersonaButton(currentPersonaIndex);
                        personaDropdownContent.classList.add('hidden');
                        resetApp();
                    });

                    label.appendChild(radio);
                    label.append(persona.name);
                    personaDropdownContent.appendChild(label);
                });
            }

            function updatePersonaButton(index) {
                personaDropdownButton.querySelector('span').textContent = personas[index].name;
            }

            function populateImageStyleSelect() {
                styleDropdownContent.innerHTML = '';
                imageStyles.forEach((style, index) => {
                    const label = document.createElement('label');
                    label.className = 'dropdown-label';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = index;
                    checkbox.className = 'accent-indigo-500';
                    checkbox.addEventListener('change', updateSelectedStyleCount);

                    label.appendChild(checkbox);
                    label.append(style.name);
                    styleDropdownContent.appendChild(label);
                });
            }

            function updateSelectedStyleCount() {
                const selectedCount = styleDropdownContent.querySelectorAll('input[type="checkbox"]:checked').length;
                styleDropdownButton.querySelector('span').textContent = `Select Styles (${selectedCount})`;
            }

            function getSelectedImageStylesPrefix() {
                const selectedCheckboxes = styleDropdownContent.querySelectorAll('input[type="checkbox"]:checked');
                if (selectedCheckboxes.length === 0) {
                    return "A photorealistic, cinematic, 4k, high-resolution photograph of {placeholder}";
                }
                const prefixes = Array.from(selectedCheckboxes).map(cb => {
                    return imageStyles[parseInt(cb.value)].prefix;
                });
                let combined = "A masterpiece of {placeholder}, combining the styles of ";
                combined += prefixes.join(', ');
                return combined;
            }


            async function handleAddNewPart() {
                const userPrompt = promptInput.value.trim();
                if (!userPrompt || isAITurn || (getUserPromptCount() >= MAX_PROMPTS && currentSentenceLength !== 0)) return;

                setLoading(true);
                storyHistory.push({ role: 'user', parts: [{ text: userPrompt }] });
                
                promptInput.value = '';
                updateUIFromHistory();

                try {
                    const aiResponseText = await getAIResponse(storyHistory, getSystemInstructionString());
                    storyHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
                    pushToHistory();
                } catch (error) {
                    console.error("Error continuing story:", error);
                     if (error.message.includes("overloaded")) {
                        displaySystemMessage("The AI model is currently busy. Please try again in a moment.", 'error');
                    } else {
                        displaySystemMessage(error.message, 'error');
                    }
                    storyHistory.pop();
                } finally {
                    setLoading(false);
                    updateUIFromHistory();
                }
            }

            async function handleUpdateAndRegenerate() {
                const userPrompt = promptInput.value.trim();
                if (!userPrompt || isAITurn || editingParagraphIndex === null) return;

                setLoading(true);

                storyHistory[editingParagraphIndex].parts[0].text = userPrompt;
                storyHistory.splice(editingParagraphIndex + 1);

                promptInput.value = '';
                isEditing = false;
                editingParagraphIndex = null;
                updateUIFromHistory();

                try {
                    const aiResponseText = await getAIResponse(storyHistory, getSystemInstructionString());
                    storyHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
                    pushToHistory(); 
                } catch (error) {
                   console.error("Error regenerating story:", error);
                   displaySystemMessage(error.message, 'error');
                } finally {
                    setLoading(false);
                    updateUIFromHistory();
                }
            }


            function updateUIFromHistory() {
                storyContainer.innerHTML = '';
                storyHistory.forEach((part, i) => {
                    addParagraphToUI(part, i);
                });
                storyContainer.scrollTop = storyContainer.scrollHeight;
                updateButtonStates();
                if (!promptInput.disabled) {
                    promptInput.focus();
                }
            }
            
            function addParagraphToUI(part, index) {
                const { role, parts, imageUrl } = part;
                const text = parts[0].text;

                const wrapper = document.createElement('div');
                wrapper.classList.add('story-paragraph-wrapper', 'flex', 'items-start', 'gap-4');
                wrapper.dataset.role = role; 
                
                const paragraphContent = document.createElement('div');
                paragraphContent.classList.add('flex-grow', 'p-4', 'rounded-lg', 'w-full');
                
                if (imageUrl) {
                    const imageContainer = document.createElement('div');
                    imageContainer.classList.add('illustration-container');
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.src = imageUrl;
                    img.alt = "Generated illustration of the scene";
                    img.className = 'w-full h-full';
                    imageContainer.appendChild(img);
                    paragraphContent.insertBefore(imageContainer, paragraphContent.firstChild);
                }

                const contentTag = document.createElement('p');
                contentTag.textContent = text;
                paragraphContent.appendChild(contentTag);

                const controlsContainer = document.createElement('div');
                controlsContainer.classList.add('flex-shrink-0', 'py-4', 'flex', 'flex-col', 'gap-2');

                if (role === 'user') {
                    wrapper.classList.add('justify-start');
                    paragraphContent.classList.add('user-paragraph', 'rounded-bl-none');
                    const editBtn = createControlButton('Edit', () => enterEditMode(index, text));
                    controlsContainer.appendChild(editBtn);
                    wrapper.appendChild(paragraphContent);
                    wrapper.appendChild(controlsContainer);
                } else {
                    wrapper.classList.add('justify-end');
                    paragraphContent.classList.add('ai-paragraph', 'rounded-br-none');
                    
                    const regenBtn = createControlButton('Regen', () => handleRegenerate(index));
                    controlsContainer.appendChild(regenBtn);

                    const illustrateBtn = createControlButton('Illustrate', () => handleIllustration(index));
                    controlsContainer.appendChild(illustrateBtn);
                    wrapper.appendChild(controlsContainer);
                    wrapper.appendChild(paragraphContent);
                }
                storyContainer.appendChild(wrapper);
            }
            
            function createControlButton(text, onClick) {
                const button = document.createElement('button');
                button.textContent = text;
                button.classList.add('bg-gray-600', 'hover:bg-gray-500', 'text-white', 'text-xs', 'py-1', 'px-2', 'rounded-md', 'transition-colors');
                button.addEventListener('click', onClick);
                return button;
            }

            function displaySystemMessage(text, type = 'system-message') {
                storyContainer.querySelectorAll('.system-message-paragraph, .error-paragraph').forEach(el => el.remove());
                const messageWrapper = document.createElement('div');
                messageWrapper.classList.add('story-paragraph-wrapper', type === 'error' ? 'error-paragraph' : 'system-message-paragraph');
                messageWrapper.innerHTML = text.replace(/\n/g, '<br>');
                storyContainer.appendChild(messageWrapper);
                storyContainer.scrollTop = storyContainer.scrollHeight;
            }

            function enterEditMode(index, text) {
                if(isAITurn) return;
                isEditing = true;
                editingParagraphIndex = index;
                promptInput.value = text;
                promptInput.focus();
                updateButtonStates();
            }

            async function handleRegenerate(index) {
                if (isAITurn) return;
                setLoading(true);
                
                const historyForRegen = storyHistory.slice(0, index);
                
                try {
                    const newAiResponse = await getAIResponse(historyForRegen, getSystemInstructionString());
                    storyHistory[index].parts[0].text = newAiResponse;
                    storyHistory.splice(index + 1);
                    pushToHistory();
                } catch (error) {
                    console.error("Error regenerating:", error);
                    displaySystemMessage(error.message, 'error');
                } finally {
                    setLoading(false);
                    updateUIFromHistory();
                }
            }
            
            async function handleIllustration(index) {
                 if (isAITurn) return;
                 setLoading(true);
                 
                 const sceneText = storyHistory[index].parts[0].text;
                 const paragraphWrapper = storyContainer.children[index];
                 const paragraphContent = paragraphWrapper.querySelector('.flex-grow');

                 let imageContainer = paragraphContent.querySelector('.illustration-container');
                 if (!imageContainer) {
                     imageContainer = document.createElement('div');
                     imageContainer.classList.add('illustration-container');
                     paragraphContent.insertBefore(imageContainer, paragraphContent.firstChild);
                 }
                 
                 imageContainer.innerHTML = `<div class="loading-placeholder flex items-center justify-center bg-gray-700 text-center p-4"><svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>`;

                 try {
                    const stylePrefix = getSelectedImageStylesPrefix();
                    const imagePrompt = stylePrefix.replace('{placeholder}', sceneText);
                    const imageUrl = await generateImage(imagePrompt);
                    
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.src = imageUrl;
                    img.alt = "Generated illustration of the scene";
                    imageContainer.innerHTML = '';
                    imageContainer.appendChild(img);

                    storyHistory[index].imageUrl = imageUrl;
                    pushToHistory();
                 } catch(error) {
                    console.error("Error generating image:", error);
                    imageContainer.innerHTML = `<p class="text-red-400 text-center p-2">Image generation failed.</p>`;
                 } finally {
                    setLoading(false);
                 }
            }

            function saveAsTxt(textContent, filename) {
                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            async function saveStoryAsHtml() {
                setLoading(true);
                displaySystemMessage("Generating story title...", "system-message");
                let storyTitle = "My AI-Woven Story";
                try {
                    const titlePrompt = "Based on the following story, provide a short, creative title. Respond with only the title text, without any quotation marks or labels.";
                    storyTitle = await getAIResponse(storyHistory, titlePrompt);
                } catch (error) {
                    console.error("Could not generate a title, using default.", error);
                }

                setLoading(false);
                displaySystemMessage("Saving story...", "system-message");
                
                const personaName = personas[currentPersonaIndex].name;
                const toneName = tones[currentToneIndex].name;

                let storyHtml = `
<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${storyTitle}</title><style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";background-color:#111827;color:#f9fafb;padding:2rem;line-height:1.6}.container{max-width:800px;margin:auto}h1,h2{color:#e5e7eb;border-bottom:1px solid #374151;padding-bottom:.5rem}h1{font-size:2.25rem}h2{font-size:1.5rem;margin-top:2rem}.meta-info{background-color:#1f2937;padding:1rem;border-radius:.5rem;margin-bottom:2rem;font-size:.9rem;color:#d1d5db}.story-part{padding:1rem;margin-bottom:1rem;border-radius:.75rem;max-width:90%;display:flex;flex-direction:column}.story-part p{margin:0;white-space:pre-wrap}.story-part img{max-width:100%;border-radius:.5rem;margin-bottom:1rem;object-fit:contain;align-self:center}.user-paragraph{background-color:#374151;margin-right:auto;border-bottom-left-radius:0}.ai-paragraph{background-color:#1e293b;margin-left:auto;align-items:flex-end;text-align:left;border-bottom-right-radius:0}</style></head><body><div class="container"><h1>${storyTitle}</h1><div class="meta-info"><strong>AI Persona:</strong> ${personaName}<br><strong>Story Tone:</strong> ${toneName}</div><h2>The Story</h2>`;

                storyHistory.forEach((part) => {
                    const { role, parts, imageUrl } = part;
                    const text = parts[0].text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    let roleClass = role === 'user' ? 'user-paragraph' : 'ai-paragraph';
                    storyHtml += `<div class="story-part ${roleClass}">`;
                    if (imageUrl) {
                        storyHtml += `<img src="${imageUrl}" alt="Story illustration">`;
                    }
                    storyHtml += `<p>${text}</p></div>`;
                });

                storyHtml += `</div></body></html>`;

                const blob = new Blob([storyHtml], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${storyTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function pushToHistory() {
                historyStack = historyStack.slice(0, historyPointer + 1);
                historyStack.push(JSON.parse(JSON.stringify(storyHistory)));
                historyPointer++;
                updateButtonStates();
            }

            function handleUndo() {
                if (historyPointer > 0) {
                    historyPointer--;
                    storyHistory = JSON.parse(JSON.stringify(historyStack[historyPointer]));
                    updateUIFromHistory();
                }
            }

            function handleRedo() {
                if (historyPointer < historyStack.length - 1) {
                    historyPointer++;
                    storyHistory = JSON.parse(JSON.stringify(historyStack[historyPointer]));
                    updateUIFromHistory();
                }
            }

            function getUserPromptCount() {
                return storyHistory.filter(p => p.role === 'user').length;
            }

            function updateButtonStates() {
                const promptCount = getUserPromptCount();
                const isStoryComplete = promptCount >= MAX_PROMPTS && currentSentenceLength !== 0;
                const canSaveStory = storyHistory.length > 0;
                
                const isBusy = isAITurn;
                
                continueBtn.disabled = isBusy || isStoryComplete; 
                
                if(isEditing) {
                    btnText.textContent = 'Update';
                } else {
                     btnText.textContent = 'Add to Story';
                }

                if (isStoryComplete && !isBusy) {
                    promptInput.placeholder = "Max prompts reached! You can save your story now.";
                    promptInput.disabled = true;
                } else {
                    const countText = currentSentenceLength === 0 ? '' : ` of ${MAX_PROMPTS}`;
                    promptInput.placeholder = isEditing ? 'Edit your prompt...' : `Add prompt ${promptCount + 1}${countText}...`;
                    promptInput.disabled = isBusy;
                }

                undoBtn.disabled = isBusy || historyPointer <= 0;
                redoBtn.disabled = isBusy || historyPointer >= historyStack.length - 1;
                
                saveStoryBtn.disabled = isBusy || !canSaveStory;
                saveWeaverBtn.disabled = isBusy || storyHistory.length < 1;
                savePromptsBtn.disabled = isBusy || promptCount < 1;
            }
            
            function setLoading(isLoading) {
                isAITurn = isLoading;
                loadingSpinner.classList.toggle('hidden', !isLoading);
                continueBtn.disabled = isLoading;
                updateButtonStates();
            }
            
            async function getAIResponse(chatHistory, systemInstruction) {
                const apiKey = "AIzaSyA29N25PG96j0NURl1m-Hn8ydX9P_X97kY"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const messagesForAPI = chatHistory.map(({role, parts}) => ({role, parts}));

                if (systemInstruction.includes("provide a short, creative title")) {
                    const titleGenerationPayload = {
                        contents: [...messagesForAPI, {role: 'user', parts: [{text: systemInstruction}]}]
                    };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(titleGenerationPayload) });
                    if (!response.ok) { throw new Error("API request for title failed."); }
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "Untitled Story";

                } else {
                     const firstUserMessageIndex = messagesForAPI.findIndex(msg => msg.role === 'user');
                    if (firstUserMessageIndex !== -1) {
                        messagesForAPI[firstUserMessageIndex].parts[0].text = 
                            `${systemInstruction}\n\n${messagesForAPI[firstUserMessageIndex].parts[0].text}`;
                    } else {
                        messagesForAPI.unshift({ role: 'user', parts: [{ text: systemInstruction }] });
                    }
                }

                const payload = { contents: messagesForAPI };
                
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("AI response API error:", errorText);
                    const errorData = JSON.parse(errorText || "{}");
                    throw new Error(errorData?.error?.message || `API request failed with status ${response.status}`);
                }

                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Unexpected AI response format:", result);
                    throw new Error(`Unexpected API response format.`);
                }
            }
            
             async function generateImage(prompt) {
                const apiKey = "AIzaSyA29N25PG96j0NURl1m-Hn8ydX9P_X97kY";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                
                const payload = {
                    instances: [{ "prompt": prompt }],
                    parameters: { "sampleCount": 1 }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Image generation API error:", errorText);
                    throw new Error(`Image generation failed with status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                } else {
                    console.error("Unexpected image generation response:", result);
                    throw new Error('Could not retrieve image from API response.');
                }
            }
            
            // --- Initialization ---
            initializeApp();
        });
    </script>
</body>
</html>
