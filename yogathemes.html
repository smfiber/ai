<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Yoga Class & Theme Generator v17.10</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter, Lato, Roboto Slab, Open Sans, Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* * ==============================================
         * CSS Custom Properties for Theming & Typography
         * ==============================================
        */
        :root {
            --color-bg: #f3e8ff;
            --color-text: #374151;
            --color-text-muted: #6b7280;
            --color-primary: #9333ea;
            --color-primary-dark: #7e22ce;
            --color-accent: #581c87;
            --color-card-bg: rgba(255, 255, 255, 0.9);
            --color-card-border: #e9d5ff;
            --color-input-bg: #f9fafb;
            --color-input-border: #d1d5db;
            --color-button-text: #ffffff;
        }

        /* Applying the theme variables */
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family);
            background-color: var(--color-bg);
            color: var(--color-text);
            font-size: var(--font-size-base);
            line-height: var(--line-height-base);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        .prose { font-size: inherit; line-height: inherit; }
        .prose p { margin-bottom: 1em; }
        .prose ul { margin-left: 1.5em; list-style-type: disc; }
        .prose strong:only-child { display: block; margin-top: 1.25em; margin-bottom: 0.75em; }

        .card {
            background-color: var(--color-card-bg);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, background-color 0.5s ease, border-color 0.5s ease;
            border: 1px solid var(--color-card-border);
            display: flex; flex-direction: column;
        }
        .card:hover { box-shadow: 0 10px 20px -5px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .card-content { flex-grow: 1; display: flex; flex-direction: column; }

        .btn-primary {
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text);
            font-weight: 600; padding: 12px 24px; border-radius: 8px;
            transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none; cursor: pointer;
        }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 7px 10px rgba(0, 0, 0, 0.15); filter: brightness(1.1); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-secondary {
            background-color: var(--color-input-bg); color: var(--color-text-muted);
            font-weight: 600; padding: 10px 20px; border-radius: 8px;
            border: 1px solid var(--color-input-border); cursor: pointer;
            transition: all 0.2s ease; display: inline-flex;
            align-items: center; justify-content: center; gap: 8px;
        }
        .btn-secondary:hover { background-color: #e5e7eb; color: var(--color-accent); }
        
        .btn-toggle {
            background-color: var(--color-input-bg); color: var(--color-text-muted);
            border: 1px solid var(--color-input-border); transition: all 0.2s ease;
        }
        .btn-toggle.active {
            background-color: var(--color-accent); color: var(--color-button-text);
            border-color: var(--color-primary-dark); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .jump-to-button {
            background-color: var(--color-card-bg); color: var(--color-text-muted);
            border: 1px solid var(--color-card-border); transition: all 0.2s ease;
            padding: 8px 16px; border-radius: 9999px; font-size: 0.875rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .jump-to-button:hover { background-color: var(--color-primary); color: var(--color-button-text); border-color: var(--color-primary-dark); transform: translateY(-1px); }

        .floating-action-button {
            position: fixed; background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text); width: 56px; height: 56px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.1);
            cursor: pointer; transition: all 0.3s ease; z-index: 40;
        }
        .floating-action-button:hover { transform: translateY(-3px) scale(1.05); }
        #new-plan-button { bottom: 2rem; right: 2rem; }
        #settings-button { bottom: 6.5rem; right: 2rem; }
        #ai-help-button { bottom: 11rem; right: 2rem; }
        #theme-changer-button { bottom: 15.5rem; right: 2rem; }
        #scroll-to-top-button { bottom: 2rem; left: 2rem; }
        
        #settings-panel {
            position: fixed; bottom: 11rem; right: 2rem;
            background-color: var(--color-card-bg); border: 1px solid var(--color-card-border);
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 1rem; width: 280px; z-index: 40;
            transition: opacity 0.3s ease, transform 0.3s ease; transform-origin: bottom right;
        }

        .themed-text-primary { color: var(--color-primary); }
        .themed-text-accent { color: var(--color-accent); }
        .themed-text-muted { color: var(--color-text-muted); }
        .themed-input {
            background-color: var(--color-input-bg); border-color: var(--color-input-border);
            color: var(--color-text); transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        .themed-input::placeholder { color: var(--color-text-muted); opacity: 0.7; }
        .themed-input:focus { --tw-ring-color: var(--color-primary); }

        .loader { border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .themed-loader { border: 4px solid var(--color-card-border); border-top: 4px solid var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header-bg-image { 
            background-image: url('https://i.ibb.co/gFXPP4Gt/Image-fx-88.png'); 
            background-size: cover; background-position: center; opacity: 1;
            transition: opacity 1.5s ease-in-out;
        }
        .header-loader-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: white; }

        .accordion-item { border-bottom: 1px solid var(--color-card-border); }
        .accordion-header {
            width: 100%; text-align: left; padding: 1rem; display: flex; justify-content: space-between; align-items: center; font-weight: 600;
            color: var(--color-text); background-color: transparent; border: none; cursor: pointer; transition: background-color 0.2s;
        }
        .accordion-header:hover { background-color: rgba(0,0,0,0.03); }
        .accordion-content { padding: 1rem; display: none; }
        .accordion-content.open { display: block; }
        .accordion-header .icon { transition: transform 0.3s ease; }
        .accordion-header.active .icon { transform: rotate(180deg); }

        .refine-container { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-card-border); }
        
        .card-grid-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem; margin-top: 1rem; padding: 0.5rem; border-radius: 8px;
            background: rgba(0,0,0,0.02);
        }
        .grid-card-selector {
            background-color: white; border: 1px solid var(--color-card-border);
            border-radius: 8px; padding: 1rem; text-align: center;
            cursor: pointer; transition: all 0.2s ease; font-size: 0.875rem; font-weight: 500;
        }
        .grid-card-selector:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .grid-card-selector.active {
            background-color: var(--color-accent); color: var(--color-button-text); border-color: var(--color-primary-dark);
        }
        .grid-card-selector .icon { margin-bottom: 0.5rem; }
        .grid-card-selector svg { width: 2.5rem; height: 2.5rem; margin: 0 auto; display: block; }
        .grid-card-selector.active small { color: rgba(255, 255, 255, 0.8); }

        .holiday-subheading {
            grid-column: 1 / -1; color: var(--color-accent);
            font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem;
            padding-bottom: 0.25rem; border-bottom: 2px solid var(--color-card-border);
        }

        /* --- Onboarding & Modal Styles --- */
        #onboarding-modal { background-color: var(--color-card-bg); border: 1px solid var(--color-card-border); z-index: 1060; }
        .onboarding-backdrop { z-index: 1050; }
        .onboarding-step { z-index: 1060; }
        .highlight-element {
            box-shadow: 0 0 0 4px var(--color-primary), 0 0 0 9999px rgba(0,0,0,0.5);
            border-radius: 8px; transition: box-shadow 0.3s ease; position: relative; z-index: 1051;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    
    <!-- Onboarding Tutorial -->
    <div id="onboarding-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden onboarding-backdrop"></div>
    <div id="onboarding-modal" class="fixed hidden p-6 rounded-lg shadow-xl max-w-sm onboarding-step">
        <div class="flex justify-between items-center mb-3">
            <h3 id="onboarding-title" class="text-xl font-bold themed-text-primary"></h3>
            <button id="onboarding-close-x" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Tutorial">&times;</button>
        </div>
        <p id="onboarding-text" class="themed-text-muted mb-4"></p>
        <div class="flex justify-between items-center">
            <div id="onboarding-progress" class="text-sm themed-text-muted"></div>
            <div>
                <button id="onboarding-skip" class="btn-secondary text-sm">Skip</button>
                <button id="onboarding-prev" class="btn-secondary text-sm" title="Previous Step">Prev</button>
                <button id="onboarding-next" class="btn-primary text-sm" title="Next Step">Next</button>
                <button id="onboarding-done" class="btn-primary text-sm hidden" title="Finish Tutorial">Done</button>
            </div>
        </div>
    </div>

    <!-- All Modals -->
     <div id="apiKeyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="card p-8 w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4 themed-text-primary">Enter Your API Key</h2>
            <p class="mb-6 themed-text-muted">To use the AI generators, please provide your API key. This key is stored only for your current session.</p>
            <form id="apiKeyForm">
                <input type="password" id="apiKeyInput" class="w-full px-4 py-2 themed-input border rounded-lg focus:ring-2" placeholder="Your API Key" required>
                <button type="submit" class="w-full btn-primary mt-6">Save Key and Start</button>
            </form>
        </div>
    </div>
    <div id="loadingStateModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="card p-8 w-full max-w-md m-4 text-center">
            <h2 class="text-2xl font-bold mb-4 themed-text-primary">Waking up the AI...</h2>
            <div class="flex justify-center my-4"><div class="loader themed-loader"></div></div>
            <p id="loading-message" class="mb-6 themed-text-muted">The AI is generating the initial content and themes. This may take a few moments.</p>
            <button id="closeLoadingStateModal" class="btn-secondary">Close</button>
        </div>
    </div>
    <div id="inDepthModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-3xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 id="inDepthModalTitle" class="text-2xl font-bold themed-text-primary">In-Depth Exploration</h2>
                <button id="closeInDepthModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="inDepthModalContent" class="p-6 overflow-y-auto prose max-w-none"></div>
            <div id="inDepthModalFooter" class="p-4 border-t" style="border-color: var(--color-card-border);"></div>
        </div>
    </div>
    <div id="themeGeneratorModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-lg m-4 flex flex-col">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 class="text-2xl font-bold themed-text-primary">AI Visual Theme Generator</h2>
                <button id="closeThemeGeneratorModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div class="p-6">
                <p class="mb-6 themed-text-muted">Describe a mood or concept to create a new color palette and header image for the app.</p>
                <textarea id="theme-prompt" rows="3" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'A quiet, misty forest at dawn'"></textarea>
                <button id="generate-theme-btn" class="btn-primary w-full mt-4" title="Generate new app visuals based on your text">Generate Visuals</button>
                <div id="theme-loader-container" class="hidden mt-4 flex items-center space-x-3">
                    <div class="loader themed-loader" style="width:25px; height:25px;"></div>
                    <span class="themed-text-muted">AI is generating colors & image...</span>
                </div>
                <div id="theme-error-container" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>
            </div>
        </div>
    </div>
    <div id="geminiSearchModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-3xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 id="geminiSearchModalTitle" class="text-2xl font-bold themed-text-primary">Gemini Search Results</h2>
                <button id="closeGeminiSearchModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="geminiSearchModalContent" class="p-6 overflow-y-auto prose max-w-none"></div>
        </div>
    </div>

    <div id="search-gemini-popup" class="fixed hidden bg-white shadow-lg rounded-lg p-2 z-50 border border-gray-200">
        <button id="search-gemini-btn" class="flex items-center gap-2 text-sm text-gray-800 hover:text-purple-600 font-semibold" title="Search for the selected text with Gemini">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-purple-500"><path d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <span>Search with Gemini</span>
        </button>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto">
        <header class="relative text-center mb-10 rounded-2xl overflow-hidden shadow-lg">
            <div id="header-loader" class="hidden absolute inset-0 bg-black bg-opacity-50 flex-col items-center justify-center z-20 transition-opacity duration-500">
                <div class="loader header-loader-spinner"></div>
                <p class="text-white mt-4 text-lg">Generating new header image...</p>
            </div>
            <div id="header-bg-image" class="absolute inset-0 header-bg-image"></div>
            <div class="absolute inset-0 bg-black opacity-40"></div>
            <div class="relative z-10 py-24 px-12 text-white">
                 <h1 class="text-4xl md:text-5xl font-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.6);">AI Yoga Class & Theme Generator</h1>
                <p class="text-lg text-purple-200 mt-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.6);">AI-powered inspiration and design for your practice.</p>
            </div>
            <div id="version-display" class="absolute bottom-2 right-4 text-white text-xs opacity-70">v17.10</div>
        </header>

        <nav id="jump-to-nav-container" class="hidden text-center mb-8"></nav>

        <main id="main-content" class="space-y-8">
            <nav id="breadcrumb-nav" aria-label="breadcrumb" class="mb-4 themed-text-muted text-sm hidden"></nav>
            
            <div id="custom-plan-card" class="card">
                <div class="p-8 card-content">
                    <h2 class="text-2xl font-bold mb-2 themed-text-primary">Custom Yoga Plan Generator</h2>
                    <p class="mb-6 themed-text-muted">Feeling creative? Enter any keyword or concept, and let AI craft a unique class plan for you.</p>
                    <form id="gemini-form">
                        <input type="text" id="gemini-prompt" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'Courage & Heart Opening'">
                        
                        <div class="my-4 border rounded-lg" style="border-color: var(--color-card-border);">
                            <div class="accordion-item">
                                <button type="button" class="accordion-header" title="Click to see more options">
                                    <span>Tailor Your Plan with AI-Powered Options:</span>
                                    <svg class="icon w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div class="accordion-content">
                                    <div id="tailoring-buttons-container" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary w-full mt-4" title="Generate a custom yoga plan based on your text">Generate AI Yoga Plan</button>
                    </form>
                    <div id="gemini-result-container" class="mt-6"></div>
                </div>
            </div>

            <div id="main-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- All cards below will be generated by AI -->
            </div>
            
            <div id="discover-more-container" class="text-center py-8">
                 <button id="discover-more-button" class="btn-primary px-8 py-4 text-lg" title="Generate a new random yoga category">
                    <span class="flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v2.5"/><path d="M12 22v-2.5"/><path d="M21.5 12.5h-2.5"/><path d="M4.5 12.5h2.5"/><path d="M18.89 6.11l-1.77 1.77"/><path d="M6.88 18.88l-1.77 1.77"/></svg>
                        Discover More Yoga Topics
                    </span>
                </button>
                <p id="discover-more-error" class="text-red-500 mt-2"></p>
            </div>
        </main>
    </div>

    <!-- Floating Action Buttons -->
    <button id="theme-changer-button" class="floating-action-button" title="Change Visual Theme">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l.34.34a8 8 0 0111.32 11.32l-.34.34a8 8 0 01-11.32-11.32l.34-.34z"/><path d="M16 12l-4.5 4.5-2.5-2.5"/><path d="M22 12s-4-8-10-8S2 12 2 12s4 8 10 8 10-8 10-8z"/></svg>
    </button>
    <button id="ai-help-button" class="floating-action-button" title="AI Help & Feedback">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l-3-3 3-3"/><path d="M15 6l3 3-3 3"/><path d="M12 19.52A10 10 0 1 0 12 4.48"/><path d="M12 2v2.5"/><path d="M12 22v-2.5"/><path d="M21.5 12.5h-2.5"/><path d="M4.5 12.5h2.5"/><path d="M18.89 6.11l-1.77 1.77"/><path d="M6.88 18.88l-1.77 1.77"/></svg>
    </button>
    <button id="settings-button" class="floating-action-button" title="Typography Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
    </button>
    <button id="new-plan-button" class="floating-action-button" title="New Plan">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
    </button>
    <button id="scroll-to-top-button" class="floating-action-button hidden" title="Scroll to top">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
    </button>
    <div id="settings-panel" class="hidden"><h3 class="text-lg font-bold themed-text-accent mb-4">Display Settings</h3><div class="space-y-4"><div><label for="font-family-select" class="block text-sm font-medium themed-text-muted mb-1">Font Family</label><select id="font-family-select" class="w-full p-2 themed-input border rounded-lg"></select></div><div><label for="font-size-select" class="block text-sm font-medium themed-text-muted mb-1">Font Size</label><select id="font-size-select" class="w-full p-2 themed-input border rounded-lg"></select></div><div><label for="line-height-select" class="block text-sm font-medium themed-text-muted mb-1">Line Spacing</label><select id="line-height-select" class="w-full p-2 themed-input border rounded-lg"></select></div></div></div>

    <footer class="mt-16 py-8 text-center border-t" style="border-color: var(--color-card-border);">
        <div class="max-w-4xl mx-auto px-4">
            <p class="themed-text-muted font-semibold">Disclaimer</p>
            <p class="themed-text-muted text-sm mt-2">
                This application and its content are for informational and inspirational purposes only. The yoga plans and suggestions generated by AI are not a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of your physician or other qualified health provider with any questions you may have regarding a medical condition. Never disregard professional medical advice or delay in seeking it because of something you have read on this application. The creators of this application are not responsible for any injuries or damages that may result from the use of these activities.
            </p>
        </div>
    </footer>


    <script type="module">
        // --- Global State & Configuration ---
        let apiKey = "";
        const root = document.documentElement;
        const allThemeData = {};
        let originalGeneratedText = new Map();
        let currentOnboardingStep = 0;
        
        // --- Onboarding Tutorial Configuration ---
        const onboardingSteps = [
            { title: "Welcome to the AI Yoga Generator!", text: "Let's begin a quick tour to explore the app's powerful features.", element: null, position: 'center' },
            { title: "Generate a Custom Plan", text: "Enter any theme here—like 'Yoga for a Rainy Day'—and the AI will craft a unique class plan for you.", element: '#custom-plan-card', position: 'bottom' },
            { title: "AI-Powered Options", text: "Click here to open a menu of AI-suggested components like 'Breathwork' to add more depth to your class.", element: '#custom-plan-card .accordion-header', position: 'bottom' },
            { title: "Change the Visuals", text: "Click here to describe a new visual style, like 'Calm ocean sunset', and the AI will create a new color palette and header image.", element: '#theme-changer-button', position: 'left' },
            { title: "Quick Navigation", text: "These AI-generated buttons let you jump directly to any category on the page.", element: '#jump-to-nav-container', position: 'bottom' },
            { title: "Specialized Gentle Yoga", text: "This dedicated card provides safe and gentle yoga plans specifically designed for recovery after hip replacement surgery.", element: '#hipReplacement-card', position: 'top' },
            { title: "Explore Pre-Built Categories", text: "The app is pre-loaded with dozens of AI-generated categories like Astrology, Chakras, and Yoga for Dancers.", element: '#main-grid', position: 'top' },
            { title: "Discover More Topics", text: "Want more inspiration? Click this, and the AI will generate a completely new category card and add it to the page.", element: '#discover-more-button', position: 'top' },
            { title: "Back to Top", text: "When you scroll down, this button will appear. Click it to return to the top of the page instantly.", element: '#scroll-to-top-button', position: 'right' },
            { title: "You're Ready to Go!", text: "That covers the main features! Click 'Done' to close this tutorial and begin creating.", element: null, position: 'center' }
        ];
        
        // --- App Initialization & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('apiKeyModal').classList.remove('hidden');
            setupEventListeners();
            populateTypographySettings();
            setupBreadcrumbListener();
        });

        function setupEventListeners() {
            // Main Actions
            document.getElementById('apiKeyForm').addEventListener('submit', handleApiKeySubmit);
            document.getElementById('gemini-form').addEventListener('submit', handleGeminiSubmit);
            document.getElementById('generate-theme-btn').addEventListener('click', handleCustomVisualThemeGeneration);
            document.getElementById('discover-more-button').addEventListener('click', handleDiscoverMoreClick);

            // Floating Action Buttons & Panels
            document.getElementById('new-plan-button').addEventListener('click', clearWorkspace);
            document.getElementById('theme-changer-button').addEventListener('click', () => document.getElementById('themeGeneratorModal').classList.remove('hidden'));
            document.getElementById('ai-help-button').addEventListener('click', handleAIHelpRequest);
            document.getElementById('scroll-to-top-button').addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

            // Settings Panel
            const settingsPanel = document.getElementById('settings-panel');
            document.getElementById('settings-button').addEventListener('click', (e) => {
                e.stopPropagation();
                settingsPanel.classList.toggle('hidden');
            });

            // Typography Selects
            document.getElementById('font-family-select').addEventListener('change', (e) => root.style.setProperty('--font-family', e.target.value));
            document.getElementById('font-size-select').addEventListener('change', (e) => root.style.setProperty('--font-size-base', e.target.value));
            document.getElementById('line-height-select').addEventListener('change', (e) => root.style.setProperty('--line-height-base', e.target.value));
            
            // Modal Closing Listeners
            ['themeGeneratorModal', 'inDepthModal', 'geminiSearchModal', 'loadingStateModal'].forEach(id => {
                 document.getElementById(id).addEventListener('click', (e) => {
                     if (e.target.id === id || e.target.closest('[id^="close"]')) {
                         document.getElementById(id).classList.add('hidden');
                     }
                 });
            });

            // Onboarding Listeners
            document.getElementById('onboarding-next').addEventListener('click', () => showOnboardingStep(++currentOnboardingStep));
            document.getElementById('onboarding-prev').addEventListener('click', () => showOnboardingStep(--currentOnboardingStep));
            document.getElementById('onboarding-skip').addEventListener('click', endOnboarding); 
            document.getElementById('onboarding-done').addEventListener('click', endOnboarding);
            document.getElementById('onboarding-close-x').addEventListener('click', endOnboarding);

            // Dynamic Content & Global Clicks
            document.addEventListener('mouseup', handleTextSelection);
            document.addEventListener('mousedown', (e) => {
                const popup = document.getElementById('search-gemini-popup');
                if (!popup.contains(e.target) && !e.target.closest('#search-gemini-btn')) {
                    popup.classList.add('hidden');
                }
                if (!settingsPanel.classList.contains('hidden') && !settingsPanel.contains(e.target) && !e.target.closest('#settings-button')) {
                    settingsPanel.classList.add('hidden');
                }
            });
            
            window.addEventListener('scroll', () => {
                const scrollTopButton = document.getElementById('scroll-to-top-button');
                if (window.scrollY > 300) {
                    scrollTopButton.classList.remove('hidden');
                } else {
                    scrollTopButton.classList.add('hidden');
                }
            });

            document.addEventListener('click', (e) => {
                const exploreBtn = e.target.closest('.explore-button');
                if (exploreBtn) handleExploreInDepth(exploreBtn.dataset.themeId, exploreBtn.dataset.themeType);
                
                const refineBtn = e.target.closest('.refine-button');
                if (refineBtn) toggleRefineUI(refineBtn.parentElement);

                const submitRefineBtn = e.target.closest('.submit-refinement-button');
                if(submitRefineBtn) handleRefineRequest(submitRefineBtn.closest('.refine-container'));

                const accordionHeader = e.target.closest('.accordion-header');
                if (accordionHeader) { 
                    accordionHeader.classList.toggle('active'); 
                    accordionHeader.nextElementSibling.classList.toggle('open'); 
                }
                
                const jumpToBtn = e.target.closest('.jump-to-button');
                if (jumpToBtn) {
                    const targetCard = document.getElementById(jumpToBtn.dataset.targetId);
                    if (targetCard) {
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'start'});
                        targetCard.classList.add('highlight-element');
                        setTimeout(() => targetCard.classList.remove('highlight-element'), 1500);
                    }
                }
            });
        }
        
        // --- Onboarding & Modal Flow ---
        function startOnboarding() {
            currentOnboardingStep = 0;
            document.getElementById('onboarding-backdrop').classList.remove('hidden');
            showOnboardingStep(currentOnboardingStep);
        }

        function showOnboardingStep(stepIndex) {
            const modal = document.getElementById('onboarding-modal');
            document.querySelectorAll('.highlight-element').forEach(el => el.classList.remove('highlight-element'));
            currentOnboardingStep = Math.max(0, Math.min(stepIndex, onboardingSteps.length - 1));
            const step = onboardingSteps[currentOnboardingStep];
            document.getElementById('onboarding-title').textContent = step.title;
            document.getElementById('onboarding-text').innerHTML = step.text;
            document.getElementById('onboarding-progress').textContent = `Step ${currentOnboardingStep + 1} of ${onboardingSteps.length}`;
            modal.classList.remove('hidden');
            document.getElementById('onboarding-prev').style.display = currentOnboardingStep === 0 ? 'none' : 'inline-flex';
            document.getElementById('onboarding-next').style.display = currentOnboardingStep === onboardingSteps.length - 1 ? 'none' : 'inline-flex';
            document.getElementById('onboarding-done').style.display = currentOnboardingStep === onboardingSteps.length - 1 ? 'inline-flex' : 'none';
            document.getElementById('onboarding-skip').style.display = currentOnboardingStep === onboardingSteps.length - 1 ? 'none' : 'inline-flex';
            if (step.element) {
                const targetElement = document.querySelector(step.element);
                if (targetElement) {
                    targetElement.classList.add('highlight-element');
                    if(step.element !== '#scroll-to-top-button') {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                    }
                    positionModal(modal, targetElement, step.position);
                } else {
                    positionModal(modal);
                }
            } else {
                 positionModal(modal);
            }
        }
        
        function positionModal(modal, targetElement = null, position = 'center') {
            if (!targetElement) {
                modal.style.top = '50%'; modal.style.left = '50%';
                modal.style.transform = 'translate(-50%, -50%)'; return;
            }
            const rect = targetElement.getBoundingClientRect();
            let modalLeft = rect.left + (rect.width / 2) - (modal.offsetWidth / 2);
            let modalTop = rect.top + (rect.height / 2) - (modal.offsetHeight / 2);
            const padding = 15;
            switch(position) {
                case 'bottom': modalTop = rect.bottom + padding; break;
                case 'top': modalTop = rect.top - modal.offsetHeight - padding; break;
                case 'left': modalLeft = rect.left - modal.offsetWidth - padding; modalTop = rect.top + (rect.height / 2) - (modal.offsetHeight / 2); break;
                case 'right': modalLeft = rect.right + padding; modalTop = rect.top + (rect.height / 2) - (modal.offsetHeight / 2); break;
            }
            modalLeft = Math.max(10, Math.min(modalLeft, window.innerWidth - modal.offsetWidth - 10));
            modalTop = Math.max(10, Math.min(modalTop, window.innerHeight - modal.offsetHeight - 10));
            modal.style.left = `${modalLeft}px`; modal.style.top = `${modalTop}px`;
            modal.style.transform = 'none';
        }

        function endOnboarding() {
            document.getElementById('onboarding-backdrop').classList.add('hidden');
            document.getElementById('onboarding-modal').classList.add('hidden');
            document.querySelectorAll('.highlight-element').forEach(el => el.classList.remove('highlight-element'));
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- Breadcrumb & Workspace Functions ---
        function setupBreadcrumbListener() {
            const breadcrumbNav = document.getElementById('breadcrumb-nav');
            breadcrumbNav.addEventListener('click', (e) => {
                if (e.target.tagName === 'A') {
                    e.preventDefault();
                    const level = parseInt(e.target.dataset.level, 10);
                    if (level === 0) {
                        clearWorkspace();
                    }
                }
            });
        }
        
        function clearWorkspace() {
            document.getElementById('main-grid').classList.remove('hidden');
            document.getElementById('custom-plan-card').classList.remove('hidden');
            document.getElementById('discover-more-container').classList.remove('hidden');
            document.getElementById('jump-to-nav-container').classList.remove('hidden');
            document.getElementById('gemini-result-container').innerHTML = '';
            document.getElementById('breadcrumb-nav').classList.add('hidden');
            document.getElementById('gemini-prompt').value = '';
        }

        // --- Main Content Loading ---
        async function handleApiKeySubmit(e) {
             e.preventDefault();
             const input = document.getElementById('apiKeyInput');
             if (!input.value.trim()) return;
             apiKey = input.value.trim();
             document.getElementById('apiKeyModal').classList.add('hidden');

             const loadingModal = document.getElementById('loadingStateModal');
             const loadingMessageEl = document.getElementById('loading-message');
             loadingMessageEl.textContent = "The AI is generating the initial content and themes. This may take a few moments.";
             loadingModal.classList.remove('hidden');

             const modalMessage = document.querySelector('#apiKeyModal p');
             modalMessage.textContent = 'To use the AI generators, please provide your API key...';
             modalMessage.classList.remove('text-red-600', 'font-bold');
             document.getElementById('main-grid').innerHTML = '';
             document.getElementById('jump-to-nav-container').innerHTML = '';
             document.getElementById('gemini-result-container').innerHTML = '';
             document.getElementById('discover-more-error').innerHTML = '';

             let isSuccess = false;
             try {
                 await generateAndApplyDefaultTheme();
                 await loadAppContent(loadingMessageEl); // Pass the element to update
                 isSuccess = true;
             } catch (error) {
                 console.error("A critical error occurred during app initialization:", error.message);
             } finally {
                 loadingModal.classList.add('hidden');
                 if (isSuccess) {
                     startOnboarding();
                 } else {
                    if (document.getElementById('apiKeyModal').classList.contains('hidden')) {
                        modalMessage.textContent = 'An error occurred during setup. Some content may have failed to load. Please check your API key and connection.';
                        modalMessage.classList.add('text-red-600', 'font-bold');
                        document.getElementById('apiKeyModal').classList.remove('hidden');
                    }
                 }
             }
        }

        async function loadAppContent(loadingMessageEl) {
            try {
                const categoriesToGenerate = [
                    { key: 'hipReplacement', title: 'Gentle Yoga After Hip Replacement', description: "Safe, modified practices to support recovery and mobility.", prompt: `Generate an extensive list of 40-50 gentle yoga class plans for hip replacement recovery. For each, give a unique "id", a "title", and a "description" emphasizing safety. Return ONLY a valid JSON array.` },
                    { key: 'neurodiversity', title: 'Yoga for Neurodiversity', description: "Practices for sensory regulation, mindfulness, and grounding.", prompt: `Generate 40-50 yoga themes for neurodiverse individuals, focusing on regulation and grounding. For each, give a unique "id", "title", and a "description". Return ONLY a valid JSON array.` },
                    { key: 'moonPhases', title: 'Moon Phases', description: "Align your practice with the energy of the lunar cycle.", prompt: `Generate data for the 8 moon phases. For each, give a unique "id", "title", and "explanation" for a yoga context. Return ONLY a valid JSON array.` },
                    { key: 'meridians', title: 'The Twelve Meridians', description: "Explore the major meridians of Traditional Chinese Medicine.", prompt: `Generate the 6 primary Meridian pairs from TCM. For each, give a unique "id", "title", and "explanation" for a yoga context. Return ONLY a valid JSON array.` },
                    { key: 'chakras', title: 'The Seven Chakras', description: "Align your practice with the body's primary energy centers.", prompt: `Generate data for the 7 primary chakras. For each, give a unique "id", "title", and "explanation" for a yoga context. Return ONLY a valid JSON array.` },
                    { key: 'seasons', title: 'The Four Seasons', description: "Align your practice with the natural cycles of the earth.", prompt: `Generate data for the 4 seasons. For each, give a unique "id", "title", its "date" (MM/DD), and "explanation" for a yoga context. Return ONLY a valid JSON array.` },
                    { key: 'styles', title: 'Yoga Styles', description: "Base your class around the principles of a specific yoga style.", prompt: `Generate 40-50 major and niche yoga styles. For each, give a unique "id", "title", "founder", and "description". Return ONLY a valid JSON array.` },
                    { key: 'astrology', title: 'Yoga and Astrology', description: "Connect your practice to the cosmos and the zodiac.", prompt: `Generate data for the 12 zodiac signs. For each, give an "id", "title", "dateRange", "planet", and "explanation". Return ONLY a valid JSON array.` },
                    { key: 'artists', title: 'Yoga for Artists', description: "Unlock creativity and release tension with tailored practices.", prompt: `Generate 40-50 yoga concepts for artists. For each, give a unique "id", "title", and "description". Return ONLY a valid JSON array.` },
                    { key: 'dancers', title: 'Yoga for Dancers', description: "Enhance flexibility, strength, and recovery for dancers.", prompt: `Generate 40-50 yoga concepts for dancers. For each, give a unique "id", "title", and "description". Return ONLY a valid JSON array.` },
                    { key: 'holidays', title: 'US Holidays', description: "Find themed yoga practices inspired by US holidays.", prompt: `Generate 40-50 US holidays for yoga themes. For each, give a unique "id", "title", "date" (MM/DD), and "explanation". Return ONLY a valid JSON array.` },
                    { key: 'easternHolidays', title: 'Eastern Holidays', description: "Explore themes from Hindu and Buddhist traditions.", prompt: `Generate 40-50 Hindu & Buddhist holidays. For each, give an "id", "title", "date" (MM/DD), "explanation", and "tradition". Return ONLY a valid JSON array.` }
                ];

                await Promise.allSettled([loadAITailoringOptions(), loadDynamicPlaceholders()]);
                
                let hasFailures = false;
                for (const cat of categoriesToGenerate) {
                    if (loadingMessageEl) loadingMessageEl.textContent = `Generating themes for: ${cat.title}...`;
                    try {
                        await generateAndPopulateAICategory(cat);
                    } catch (e) {
                        hasFailures = true;
                        console.error(`Stopping content load due to failure in category: ${cat.title}`);
                        break; 
                    }
                }

                if (hasFailures) {
                    throw new Error("One or more AI content categories failed to load. The process has been stopped.");
                }
                
                if (loadingMessageEl) loadingMessageEl.textContent = `Generating a few more ideas...`;
                await generateInitialExtraCategories();
                
                if (loadingMessageEl) loadingMessageEl.textContent = `Building navigation...`;
                await generateJumpToButtons();

            } catch (error) {
                console.error("An error occurred while loading app content:", error.message);
                throw error; // Re-throw to be caught by the master handler
            }
        }
        
        async function generateAndPopulateAICategory({key, title, description, prompt}) {
            const mainGrid = document.getElementById('main-grid');
            const card = document.createElement('div');
            card.className = 'card md:col-span-2';
            card.id = `${key}-card`;
            const selectorId = `${key}-selector-visual`;
            card.innerHTML = `<div class="p-8 card-content"><h2 class="text-2xl font-bold mb-2 themed-text-primary">${title}</h2><p class="mb-6 themed-text-muted">${description}</p><div id="${selectorId}" class="w-full">${getLoaderHTML(`AI is generating ${title}...`)}</div><div id="${key}-details" class="details-container prose max-w-none"></div></div>`;
            mainGrid.appendChild(card);
            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if (!jsonText) {
                    throw new Error(`API returned empty content for ${title}.`);
                }
                allThemeData[key] = JSON.parse(jsonText);
                populateCardGridSelector(selectorId, key);
            } catch (error) {
                handleApiError(error, document.getElementById(selectorId), title, card);
                throw error; // Re-throw error to allow the loop to catch it
            }
        }

        function populateCardGridSelector(containerId, themeType) {
            const container = document.getElementById(containerId);
            const data = allThemeData[themeType];
            if (!container || !data || !Array.isArray(data)) {
                container.innerHTML = `<p class="themed-text-muted">No items to display.</p>`;
                return;
            }

            container.innerHTML = `<div class="card-grid-container">${data.map(item => `
                <div class="grid-card-selector" data-theme-id="${item.id}" data-theme-type="${themeType}" title="${item.description || item.explanation || ''}">
                    <div class="icon">${getIconForTheme(themeType, item.id)}</div>
                    <strong class="text-sm">${item.title}</strong>
                    <small class="block text-xs themed-text-muted">${item.dateRange || item.founder || item.tradition || ''}</small>
                </div>`).join('')}
            </div>`;

            container.addEventListener('click', (e) => {
                const selector = e.target.closest('.grid-card-selector');
                if (selector) {
                    const currentlyActive = container.querySelector('.grid-card-selector.active');
                    if(currentlyActive) currentlyActive.classList.remove('active');
                    selector.classList.add('active');
                    handleGridSelect(selector);
                }
            });
        }
        
        async function handleGridSelect(target) {
            const { themeId, themeType } = target.dataset;
            const item = allThemeData[themeType]?.find(d => d.id === themeId);
            if (!item) return;

            const prompt = `Generate a creative and inspiring yoga class plan based on the theme: "${item.title}". The class plan should be structured with the following sections: "Theme Introduction", "Opening Meditation & Breathwork", "Warm-up Sequence", "Main Sequence", "Peak Pose(s)", "Cool-down & Stretches", and "Savasana & Closing". Make each section detailed and evocative, suitable for a yoga teacher to use. For "${item.title}", incorporate its specific qualities: ${item.description || item.explanation}. Return the response as a simple markdown string.`;
            
            const resultContainer = document.getElementById(`${themeType}-details`);
            resultContainer.innerHTML = getLoaderHTML(`Generating plan for ${item.title}...`);

            try {
                const resultText = await callGeminiAPI(prompt);
                originalGeneratedText.set(themeId, resultText);
                resultContainer.innerHTML = robustMarkdownToHtml(resultText);
                addPostGenerationButtons(resultContainer, themeId, themeType);
            } catch (error) {
                handleApiError(error, resultContainer, `plan for ${item.title}`);
            }
        }

        async function handleGeminiSubmit(e) {
            e.preventDefault();
            const promptInput = document.getElementById('gemini-prompt');
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            const resultContainer = document.getElementById('gemini-result-container');
            resultContainer.innerHTML = getLoaderHTML('Generating your custom AI yoga plan...');

            try {
                const fullPrompt = `Generate a creative and inspiring yoga class plan based on the user's prompt: "${prompt}". The class plan should be structured with the following sections: "Theme Introduction", "Opening Meditation & Breathwork", "Warm-up Sequence", "Main Sequence", "Peak Pose(s)", "Cool-down & Stretches", and "Savasana & Closing". Make each section detailed and evocative, suitable for a yoga teacher to use. Return the response as a simple markdown string.`;
                const resultText = await callGeminiAPI(fullPrompt);
                
                resultContainer.innerHTML = robustMarkdownToHtml(resultText);
                originalGeneratedText.set('custom-plan', resultText);
                
                addPostGenerationButtons(resultContainer, 'custom-plan', 'custom');

            } catch(error) {
                handleApiError(error, resultContainer, 'custom yoga plan');
            }
        }

        // --- Core API Functions ---
        async function callApi(apiUrl, payload) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 45000); // Increased timeout to 45 seconds

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    let errorBody = await response.text();
                    try { errorBody = JSON.parse(errorBody); } catch { /* ignore */ }
                    console.error("API Error Response:", errorBody);
                    throw new Error(`API request failed with status ${response.status}. Message: ${errorBody?.error?.message || response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    console.error('Fetch API call timed out.');
                    throw new Error('The request to the AI service timed out. Please try again.');
                }
                console.error("Fetch API call failed:", error);
                throw error;
            }
        }

        async function callGeminiAPI(prompt, isJson = false) {
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            if (isJson) {
                payload.generationConfig = { responseMimeType: "application/json", maxOutputTokens: 8192 };
            }
            const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, payload);
            return result?.candidates?.[0]?.content?.parts?.[0]?.text || null;
        }

        async function callImageGenAPI(prompt) {
             const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
             const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`, payload);
             const base64 = result?.predictions?.[0]?.bytesBase64Encoded;
             return base64 ? `data:image/png;base64,${base64}` : null;
        }
        
        async function callColorGenAPI(prompt) {
             const fullPrompt = `Based on the theme "${prompt}", generate a color palette. I need a JSON object with keys: "bg", "text", "primary", "primaryDark", "accent", "cardBg", "cardBorder", "textMuted", "inputBg", "inputBorder". Then, determine if the "primary" color is light or dark. If it's dark, set "buttonText" to a light color like "#FFFFFF". If it's light, set "buttonText" to a dark color like "#111827". Return only the complete, valid JSON.`;
             const jsonText = await callGeminiAPI(fullPrompt, true);
             if (jsonText) return JSON.parse(jsonText.replace(/```json\n?|```/g, '').trim());
             throw new Error("Could not parse a valid color theme from API response.");
        }

        // --- Error, Theme, and UI Helper Functions ---
        function handleApiError(error, container, contentType = 'content', cardToRemove = null) {
            console.error(`Error generating ${contentType}:`, error);
            const errorMessage = generateErrorMessage(error, contentType);
            if (container) {
                container.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">${errorMessage}</div>`;
            }
        }
        
        async function generateAndApplyDefaultTheme() {
            showThemeLoading(true);
            const themePrompt = "Big Sunset on the beach";
            const imagePrompt = `Artistic, abstract background image inspired by "${themePrompt}". Suitable for a yoga website. Serene, calming. Wide aspect ratio, photographic, cinematic lighting.`;
            try {
                const [colorResult, imageResult] = await Promise.allSettled([callColorGenAPI(themePrompt), callImageGenAPI(imagePrompt)]);
                
                if (colorResult.status === 'fulfilled' && colorResult.value) {
                    applyTheme(colorResult.value);
                } else {
                    throw colorResult.reason || new Error("Failed to generate color theme.");
                }

                if (imageResult.status === 'fulfilled' && imageResult.value) {
                    applyHeaderImage(imageResult.value);
                } else {
                    throw imageResult.reason || new Error("Failed to generate header image.");
                }
            } catch (error) {
                 handleApiError(null, null, 'default theme'); // Don't display in a container
                 throw error; // Propagate error
            } finally {
                showThemeLoading(false);
            }
        }
        
        async function loadAITailoringOptions() {
            const container = document.getElementById('tailoring-buttons-container');
            container.innerHTML = getLoaderHTML('Loading AI options...');
            try {
                const prompt = `Generate a JSON array of 15-20 diverse, single-word or two-word concepts to refine a yoga class. Examples: "Energizing", "Grounding", "Restorative", "For Beginners", "Core Strength", "Flexibility", "Mindfulness", "Stress Relief". Return ONLY the valid JSON array of strings.`;
                const jsonText = await callGeminiAPI(prompt, true);
                const options = JSON.parse(jsonText);
                if (!Array.isArray(options)) throw new Error("AI did not return a valid array for tailoring options.");
                populateTailoringButtons(options);
            } catch (error) {
                handleApiError(error, container, 'tailoring options');
                throw error;
            }
        }

        function populateTailoringButtons(options) {
            const container = document.getElementById('tailoring-buttons-container');
            container.innerHTML = options.map(option =>
                `<button type="button" class="btn-toggle text-sm px-3 py-1 rounded-full">${option}</button>`
            ).join('');
        }
        
        async function generateInitialExtraCategories() {
            const prompt = `Generate 2 new, creative, and distinct high-level yoga categories that are NOT already on this list: Gentle Yoga After Hip Replacement, Yoga for Neurodiversity, Moon Phases, The Twelve Meridians, The Seven Chakras, The Four Seasons, Yoga Styles, Yoga and Astrology, Yoga for Artists, Yoga for Dancers, US Holidays, Eastern Holidays. For each category, provide a "key" (camelCase, e.g., 'yogaForAthletes'), a "title", a short "description", and a detailed "prompt" for the AI to generate 40-50 sub-items later. The prompt should ask for a JSON array of objects, each with an id, title, and description/explanation. Return ONLY a valid JSON array of these two category objects.`;
            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if(!jsonText) return; // Fail silently if no categories are returned
                const newCategories = JSON.parse(jsonText);
                for (const cat of newCategories) {
                    await generateAndPopulateAICategory(cat);
                }
            } catch (error) {
                console.error("Could not generate initial extra categories:", error);
                // Don't throw here, it's not a critical failure
            }
        }
        
        async function loadDynamicPlaceholders() {
            const promptInput = document.getElementById('gemini-prompt');
            const prompt = `Generate a JSON array of 3 creative and intriguing yoga class theme ideas to serve as placeholders in a search input. Examples: "Ocean Breath & Fluid Movement", "Finding Stillness in Chaos", "Yoga for a Joyful Heart". Return ONLY the valid JSON array of strings.`;
            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if(!jsonText) return;
                const placeholders = JSON.parse(jsonText);
                if (placeholders && placeholders.length > 0) {
                    let i = 0;
                    setInterval(() => {
                        promptInput.placeholder = `e.g., '${placeholders[i]}'`;
                        i = (i + 1) % placeholders.length;
                    }, 3000);
                }
            } catch(error) {
                console.error("Could not load dynamic placeholders", error);
                // Non-critical, so we don't re-throw
            }
        }

        function applyTheme(colors) {
            Object.keys(colors).forEach(key => {
                const cssVar = `--color-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                root.style.setProperty(cssVar, colors[key]);
            });
        }
        
        function applyHeaderImage(imageUrl) {
            const bgImageDiv = document.getElementById('header-bg-image');
            bgImageDiv.style.backgroundImage = `url('${imageUrl}')`;
        }

        function showThemeLoading(isLoading) {
            const loader = document.getElementById('header-loader');
            if (isLoading) {
                loader.classList.remove('hidden');
                loader.classList.add('flex');
            } else {
                loader.classList.add('hidden');
                loader.classList.remove('flex');
            }
        }

        function robustMarkdownToHtml(text) {
            if (!text) return '<p>No content received.</p>';
            let html = text
                .replace(/</g, "&lt;").replace(/>/g, "&gt;") // Sanitize HTML tags
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^\* (.*$)/gim, '<li>$1</li>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');

            // Wrap list items in <ul>
            html = html.replace(/<li>/g, '<ul><li>').replace(/<\/li>/g, '</li></ul>');
            html = html.replace(/<\/ul>\s*<ul>/g, '');
            return html;
        }

        function addPostGenerationButtons(container, themeId, themeType) {
            const buttonBar = document.createElement('div');
            buttonBar.className = 'flex flex-wrap gap-2 mt-4 pt-4 border-t';
            buttonBar.style.borderColor = 'var(--color-card-border)';
            buttonBar.innerHTML = `
                <button class="btn-secondary text-sm refine-button">Refine with AI</button>
                <button class="btn-secondary text-sm copy-button">Copy Text</button>
                <button class="btn-secondary text-sm explore-button" data-theme-id="${themeId}" data-theme-type="${themeType}">Explore In-Depth</button>
            `;
            container.appendChild(buttonBar);

            buttonBar.querySelector('.copy-button').addEventListener('click', (e) => {
                copyElementTextToClipboard(container, e.currentTarget);
            });
        }

        async function handleDiscoverMoreClick() {
            const button = document.getElementById('discover-more-button');
            const errorP = document.getElementById('discover-more-error');
            errorP.textContent = '';
            button.disabled = true;

            const existingTitles = Array.from(document.querySelectorAll('#main-grid h2')).map(h2 => h2.textContent);
            const prompt = `Generate 1 new, creative, and distinct high-level yoga category that is NOT on this list: ${existingTitles.join(', ')}. Provide a "key" (camelCase, e.g., 'yogaForAthletes'), a "title", a short "description", and a detailed "prompt" for the AI to generate 40-50 sub-items later. The sub-item prompt should ask for a JSON array of objects, each with an id, title, and description/explanation. Return ONLY a valid JSON object for this single new category, not an array.`;

            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if (!jsonText) throw new Error("AI did not return a new category.");
                const newCategory = JSON.parse(jsonText);
                await generateAndPopulateAICategory(newCategory);
            } catch (error) {
                console.error("Failed to discover more topics:", error);
                errorP.textContent = "Sorry, couldn't generate a new topic right now.";
            } finally {
                button.disabled = false;
            }
        }
        
        async function handleCustomVisualThemeGeneration() {
            const prompt = document.getElementById('theme-prompt').value;
            if(!prompt) return;

            const loader = document.getElementById('theme-loader-container');
            const errorContainer = document.getElementById('theme-error-container');
            const generateBtn = document.getElementById('generate-theme-btn');
            
            loader.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            generateBtn.disabled = true;

            try {
                const imagePrompt = `Artistic, abstract background image inspired by "${prompt}". Suitable for a yoga website. Serene, calming. Wide aspect ratio, photographic, cinematic lighting.`;
                const [colorResult, imageResult] = await Promise.allSettled([callColorGenAPI(prompt), callImageGenAPI(imagePrompt)]);
                
                if (colorResult.status === 'fulfilled' && colorResult.value) {
                    applyTheme(colorResult.value);
                } else {
                    throw colorResult.reason || new Error("Failed to generate color theme.");
                }

                if (imageResult.status === 'fulfilled' && imageResult.value) {
                    applyHeaderImage(imageResult.value);
                } else {
                    throw imageResult.reason || new Error("Failed to generate header image.");
                }
                document.getElementById('themeGeneratorModal').classList.add('hidden');
            } catch (error) {
                showThemeError(error.message);
            } finally {
                loader.classList.add('hidden');
                generateBtn.disabled = false;
            }
        }
        
        function showThemeError(message) {
            const errorContainer = document.getElementById('theme-error-container');
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        async function generateJumpToButtons() {
            const container = document.getElementById('jump-to-nav-container');
            const cards = Array.from(document.querySelectorAll('#main-grid .card, #custom-plan-card'));
            if (cards.length <= 1) return;

            const cardTitles = cards.map(card => {
                const h2 = card.querySelector('h2');
                return h2 ? h2.textContent : null;
            }).filter(Boolean);
            
            if (cardTitles.length === 0) return;
        
            const prompt = `For the following list of yoga category titles, generate a very short, one-or-two-word, engaging label for each. Return a valid JSON object where keys are the original titles and values are the short labels. Titles: ${JSON.stringify(cardTitles)}`;
            
            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if (!jsonText) {
                    console.error("AI returned empty data for jump-to buttons. Skipping.");
                    container.classList.add('hidden');
                    return;
                }
                const labels = JSON.parse(jsonText);
                
                const buttonsHtml = cards.map(card => {
                    const title = card.querySelector('h2').textContent;
                    if (!title) return '';
                    const label = labels[title] || title.split(' ')[0]; // Fallback to first word
                    return `<button class="jump-to-button" data-target-id="${card.id}">${label}</button>`;
                }).join('');

                container.innerHTML = `<div class="flex flex-wrap gap-2 justify-center">${buttonsHtml}</div>`;
                container.classList.remove('hidden');

            } catch (error) {
                console.error("Failed to generate or parse jump-to buttons:", error);
                container.classList.add('hidden'); 
            }
        }
        
        function handleTextSelection() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            const popup = document.getElementById('search-gemini-popup');
            
            if (selectedText.length > 2) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                popup.style.left = `${window.scrollX + rect.left + (rect.width / 2) - (popup.offsetWidth / 2)}px`;
                popup.style.top = `${window.scrollY + rect.top - popup.offsetHeight - 5}px`;
                popup.classList.remove('hidden');
                
                const searchBtn = document.getElementById('search-gemini-btn');
                // Clone and replace to remove old listeners
                const newBtn = searchBtn.cloneNode(true);
                searchBtn.parentNode.replaceChild(newBtn, searchBtn);
                newBtn.addEventListener('click', () => {
                    performGeminiSearch(selectedText);
                    popup.classList.add('hidden');
                });
            } else {
                popup.classList.add('hidden');
            }
        }
        
        async function performGeminiSearch(text) {
            const modal = document.getElementById('geminiSearchModal');
            const titleEl = document.getElementById('geminiSearchModalTitle');
            const contentEl = document.getElementById('geminiSearchModalContent');

            titleEl.textContent = `Gemini Search: "${text}"`;
            contentEl.innerHTML = getLoaderHTML(`Searching for insights on "${text}"...`);
            modal.classList.remove('hidden');

            const prompt = `Provide a detailed explanation or definition for the following term in a yoga and wellness context: "${text}". If it's a specific pose, describe it. If it's a concept, explain it. Format as clean markdown.`;
            try {
                const resultText = await callGeminiAPI(prompt);
                contentEl.innerHTML = robustMarkdownToHtml(resultText);
            } catch (error) {
                handleApiError(error, contentEl, 'Gemini search');
            }
        }

        function populateTypographySettings() {
            const fontSelect = document.getElementById('font-family-select');
            const sizeSelect = document.getElementById('font-size-select');
            const lineHeightSelect = document.getElementById('line-height-select');
            
            const fonts = { 'Inter': 'Inter, sans-serif', 'Lato': 'Lato, sans-serif', 'Montserrat': 'Montserrat, sans-serif', 'Open Sans': 'Open Sans, sans-serif', 'Roboto Slab': 'Roboto Slab, serif' };
            const sizes = { 'Small': '14px', 'Base': '16px', 'Large': '18px', 'X-Large': '20px' };
            const lineHeights = { 'Relaxed': '1.8', 'Default': '1.6', 'Tight': '1.4' };

            Object.keys(fonts).forEach(name => fontSelect.add(new Option(name, fonts[name])));
            Object.keys(sizes).forEach(name => sizeSelect.add(new Option(name, sizes[name])));
            Object.keys(lineHeights).forEach(name => lineHeightSelect.add(new Option(name, lineHeights[name])));

            root.style.setProperty('--font-family', fonts['Inter']);
            root.style.setProperty('--font-size-base', sizes['Base']);
            root.style.setProperty('--line-height-base', lineHeights['Default']);
        }

        function copyElementTextToClipboard(element, button) {
            const textToCopy = element.innerText;
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            button.textContent = 'Copied!';
            setTimeout(() => { button.textContent = 'Copy Text'; }, 2000);
        }

        async function handleAIHelpRequest() {
            const modal = document.getElementById('inDepthModal');
            const titleEl = document.getElementById('inDepthModalTitle');
            const contentEl = document.getElementById('inDepthModalContent');

            titleEl.textContent = "AI Help & Feedback";
            contentEl.innerHTML = getLoaderHTML("Loading help content...");
            modal.classList.remove('hidden');

            const prompt = "Please provide a helpful guide to using this AI Yoga Class & Theme Generator application. Explain the main features in a clear, friendly way. Use markdown for formatting, with headings for each feature: 'Custom Plan Generator', 'AI-Powered Options', 'Pre-Built Categories', 'Visual Theme Generator', and 'Other Features'.";
            try {
                const resultText = await callGeminiAPI(prompt);
                contentEl.innerHTML = robustMarkdownToHtml(resultText);
            } catch (error) {
                handleApiError(error, contentEl, 'help content');
            }
        }
        
        async function handleExploreInDepth(themeId, themeType) {
            const item = allThemeData[themeType]?.find(d => d.id === themeId);
            if (!item) return;

            const modal = document.getElementById('inDepthModal');
            const titleEl = document.getElementById('inDepthModalTitle');
            const contentEl = document.getElementById('inDepthModalContent');
            
            titleEl.textContent = `In-Depth: ${item.title}`;
            contentEl.innerHTML = getLoaderHTML(`Generating in-depth content for ${item.title}...`);
            modal.classList.remove('hidden');
            
            const prompt = `Provide an in-depth exploration of the yoga theme: "${item.title}". Discuss its history, philosophy, key concepts, and how it can be meaningfully integrated into a yoga practice. Go beyond a simple class plan. The context is: ${item.description || item.explanation}. Format as clean markdown.`;
            try {
                const resultText = await callGeminiAPI(prompt);
                contentEl.innerHTML = robustMarkdownToHtml(resultText);
            } catch (error) {
                handleApiError(error, contentEl, 'in-depth content');
            }
        }
        
        function toggleRefineUI(buttonContainer) {
            let refineContainer = buttonContainer.querySelector('.refine-container');
            if (refineContainer) {
                refineContainer.remove();
                return;
            }

            refineContainer = document.createElement('div');
            refineContainer.className = 'refine-container';
            refineContainer.innerHTML = `
                <textarea class="w-full p-2 themed-input border rounded-lg" rows="2" placeholder="e.g., 'Make it more gentle' or 'Add more hip openers'"></textarea>
                <button class="btn-primary text-sm mt-2 submit-refinement-button">Submit Refinement</button>
            `;
            buttonContainer.appendChild(refineContainer);
        }

        async function handleRefineRequest(refineContainer) {
            const promptText = refineContainer.querySelector('textarea').value;
            if (!promptText) return;

            const resultContainer = refineContainer.closest('.prose');
            const themeId = resultContainer.querySelector('.explore-button').dataset.themeId;
            const originalText = originalGeneratedText.get(themeId);
            
            if (!originalText) {
                resultContainer.innerHTML = `<p class="text-red-500">Could not find the original text to refine.</p>`;
                return;
            }
            
            resultContainer.innerHTML = getLoaderHTML(`Refining plan based on your request...`);
            
            const prompt = `The user wants to refine a yoga class plan.
            Original Plan:
            ---
            ${originalText}
            ---
            User's refinement request: "${promptText}".
            Please generate a new, complete yoga class plan that incorporates the user's request, while maintaining the original structure and theme. Return only the new markdown for the class plan.`;
            
            try {
                const newText = await callGeminiAPI(prompt);
                originalGeneratedText.set(themeId, newText); // Update with the newly refined text
                resultContainer.innerHTML = robustMarkdownToHtml(newText);
                addPostGenerationButtons(resultContainer, themeId, 'custom');
            } catch(error) {
                handleApiError(error, resultContainer, 'refinement');
            }
        }
        
        function getIconForTheme(themeType, themeId) { return `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`; }
        
        function getLoaderHTML(message) { return `<div class="flex justify-center items-center my-4"><div class="loader themed-loader"></div><p class="ml-4 themed-text-muted">${message}</p></div>`; }
        
        function createButton(text, className, type = 'button') { const btn = document.createElement('button'); btn.className = className; btn.type = type; btn.innerHTML = text; return btn; }
        
        function generateErrorMessage(error, type = 'general') { console.error(`Error during ${type} generation:`, error); let message = `An unknown ${type} error occurred. ${error.message}`; const err = error.message.toLowerCase(); if (err.includes('safety') || err.includes('blocked')) message = `Request blocked for safety reasons. Please try a different prompt.`; else if (err.includes('api key not valid')) message = `Authentication failed. Your API Key is not valid.`; else if (err.includes('429')) message = `Request limit exceeded. Please try again later.`; else if (err.includes('timed out')) message = `The request timed out. Please check your connection and try again.`; return `Sorry, something went wrong. ${message}`; }

    </script>
</body>
</html>
