<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Yoga Class & Theme Generator v23.1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Nunito+Sans:wght@400;700&family=Open+Sans:wght@400;700&family=Poppins:wght@400;500;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* * ==============================================
         * CSS Custom Properties for Theming & Typography
         * ==============================================
        */
        :root {
            --color-bg: #f3e8ff;
            --color-text: #374151;
            --color-text-muted: #6b7280;
            --color-primary: #9333ea;
            --color-primary-dark: #7e22ce;
            --color-accent: #581c87;
            --color-card-bg: rgba(255, 255, 255, 0.9);
            --color-card-border: #e9d5ff;
            --color-input-bg: #f9fafb;
            --color-input-border: #d1d5db;
            --color-button-text: #ffffff;
        }

        /* Applying the theme variables */
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family, 'Inter', sans-serif);
            background-color: var(--color-bg);
            color: var(--color-text);
            font-size: var(--font-size-base, '16px');
            line-height: var(--line-height-base, 1.5);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        .prose { font-size: inherit; line-height: 1.6; }
        .prose p { margin-bottom: 1rem; }
        .prose ul, .prose ol {
            margin-bottom: 1rem;
            padding-left: 1.75rem;
        }
        .prose ul { list-style-type: disc; }
        .prose li { margin-bottom: 0.5rem; padding-left: 0.25rem; }
        .prose h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-accent);
            margin-top: 1.25em;
            margin-bottom: 0.25em;
        }
        .prose h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-accent);
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        .prose h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
            margin-top: 1.75em;
            margin-bottom: 0.75em;
            padding-bottom: 0.25em;
            border-bottom: 1px solid var(--color-card-border);
        }


        .card {
            background-color: var(--color-card-bg);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, background-color 0.5s ease, border-color 0.5s ease;
            border: 1px solid var(--color-card-border);
            display: flex; flex-direction: column;
        }
        .card:hover { box-shadow: 0 10px 20px -5px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .card-content { flex-grow: 1; display: flex; flex-direction: column; }

        .btn-primary {
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text);
            font-weight: 600; padding: 12px 24px; border-radius: 8px;
            transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none; cursor: pointer;
        }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 7px 10px rgba(0, 0, 0, 0.15); filter: brightness(1.1); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-secondary {
            background-color: var(--color-input-bg); color: var(--color-text-muted);
            font-weight: 600; padding: 10px 20px; border-radius: 8px;
            border: 1px solid var(--color-input-border); cursor: pointer;
            transition: all 0.2s ease; display: inline-flex;
            align-items: center; justify-content: center; gap: 8px;
        }
        .btn-secondary:hover:not(:disabled) { background-color: #e5e7eb; color: var(--color-accent); }
        .btn-secondary:disabled { opacity: 0.7; cursor: not-allowed;}
        
        .btn-toggle {
            background-color: var(--color-input-bg); color: var(--color-text-muted);
            border: 1px solid var(--color-input-border); transition: all 0.2s ease;
        }
        .btn-toggle.active {
            background-color: var(--color-accent); color: var(--color-button-text);
            border-color: var(--color-primary-dark); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .jump-to-button {
            background-color: var(--color-card-bg); color: var(--color-text-muted);
            border: 1px solid var(--color-card-border); transition: all 0.2s ease;
            padding: 8px 16px; border-radius: 9999px; font-size: 0.875rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .jump-to-button:hover { background-color: var(--color-primary); color: var(--color-button-text); border-color: var(--color-primary-dark); transform: translateY(-1px); }

        .floating-action-button {
            position: fixed; background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text); width: 56px; height: 56px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.1);
            cursor: pointer; transition: all 0.3s ease; z-index: 40;
        }
        .floating-action-button:hover { transform: translateY(-3px) scale(1.05); }
        #new-plan-button { bottom: 2rem; right: 2rem; }
        #settings-button { bottom: 6.5rem; right: 2rem; }
        #theme-changer-button { bottom: 11rem; right: 2rem; }
        #scroll-to-top-button { bottom: 2rem; left: 2rem; }
        
        #settings-panel {
            position: fixed; bottom: 11rem; right: 2rem;
            background-color: var(--color-card-bg); border: 1px solid var(--color-card-border);
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 1rem; width: 280px; z-index: 40;
            transition: opacity 0.3s ease, transform 0.3s ease; transform-origin: bottom right;
        }

        .themed-text-primary { color: var(--color-primary); }
        .themed-text-accent { color: var(--color-accent); }
        .themed-text-muted { color: var(--color-text-muted); }
        .themed-input {
            background-color: var(--color-input-bg); border-color: var(--color-input-border);
            color: var(--color-text); transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        .themed-input::placeholder { color: var(--color-text-muted); opacity: 0.7; }
        .themed-input:focus { --tw-ring-color: var(--color-primary); }

        .loader { border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .themed-loader { border: 4px solid var(--color-card-border); border-top: 4px solid var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header-bg-image { 
            background-image: url('https://i.ibb.co/gFXPP4Gt/Image-fx-88.png'); 
            background-size: cover; background-position: center; opacity: 1;
            transition: opacity 1.5s ease-in-out;
        }
        .header-loader-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: white; }

        .accordion-item { border-bottom: 1px solid var(--color-card-border); }
        .accordion-item:last-child { border-bottom: none; }
        .accordion-header {
            width: 100%; text-align: left; padding: 1rem; display: flex; justify-content: space-between; align-items: center; font-weight: 600;
            color: var(--color-text); background-color: transparent; border: none; cursor: pointer; transition: background-color 0.2s;
        }
        .accordion-header:hover { background-color: rgba(0,0,0,0.03); }
        .accordion-content { padding: 1rem; display: none; }
        .accordion-content.open { display: block; }
        .accordion-header .icon { transition: transform 0.3s ease; }
        .accordion-header.active .icon { transform: rotate(180deg); }

        .refine-container { 
            margin-top: 1rem; padding: 1.5rem; border-radius: 12px;
            border: 1px solid var(--color-card-border);
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .card-grid-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 1rem; margin-top: 1rem; padding: 0.5rem; border-radius: 8px;
            background: rgba(0,0,0,0.02);
        }
        .grid-card-selector {
            background-color: white; border: 1px solid var(--color-card-border);
            border-radius: 8px; padding: 1rem; text-align: center;
            cursor: pointer; transition: all 0.2s ease; font-size: 0.875rem; font-weight: 500;
            display: flex; flex-direction: column; justify-content: space-between; height: 100%;
        }
        .grid-card-selector:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .grid-card-selector.active {
            background-color: var(--color-accent); color: var(--color-button-text); border-color: var(--color-primary-dark);
        }
        .grid-card-selector .icon { margin-bottom: 0.5rem; }
        .grid-card-selector svg { width: 2.5rem; height: 2.5rem; margin: 0 auto; display: block; }
        .grid-card-selector.active small { color: rgba(255, 255, 255, 0.8); }

        .week-by-week-grid { display: block; }
        .week-by-week-grid .grid-card-selector { text-align: left; display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1.25rem; }
        .week-by-week-grid .icon { margin-bottom: 0; }

        .tour-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.75); 
            z-index: 9998;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            opacity: 0; transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .tour-overlay.visible { 
            opacity: 1; 
            pointer-events: auto;
        }

        .tour-highlight {
            position: relative; z-index: 9999;
            box-shadow: 0 0 0 6px var(--color-primary), 0 0 30px 15px rgba(147, 51, 234, 0.4);
            border-radius: 12px;
            transition: box-shadow 0.3s ease;
        }

        .tour-popover {
            position: absolute;
            z-index: 10000;
            background-color: #fcfaff; 
            border-top: 4px solid var(--color-primary);
            border-radius: 16px;
            padding: 1.5rem;
            width: 340px; max-width: 90vw;
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            opacity: 0; transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            visibility: hidden;
        }
        .tour-popover.visible { opacity: 1; transform: translateY(0); visibility: visible; }
        .tour-popover h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 0.75rem;
        }
        .tour-popover p { font-size: 0.95rem; color: var(--color-text-muted); margin-bottom: 1.5rem; }
        
        .tour-popover-nav { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            width: 100%;
            margin-top: 1rem;
        }
        .tour-popover-dots { 
            display: flex; 
            gap: 6px;
            justify-content: center;
            width: 100%;
            margin-bottom: 1rem;
        }
        .tour-popover-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--color-card-border); transition: background-color 0.3s; }
        .tour-popover-dot.active { background-color: var(--color-primary); }
        #tour-skip-btn {
            background-color: transparent;
            color: var(--color-text-muted);
            border: none;
            padding: 0;
            font-size: 0.875rem;
            cursor: pointer;
        }
        #tour-skip-btn:hover { text-decoration: underline; }

        .tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .tooltip-icon {
            color: var(--color-text-muted);
            cursor: pointer;
        }
        .tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            background-color: var(--color-accent);
            color: var(--color-button-text);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            width: max-content;
            max-width: 250px;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 60;
        }
        .tooltip-container:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

    </style>
</head>
<body class="p-4 md:p-8">

    <div id="tour-overlay" class="tour-overlay"></div>
    <div id="tour-popover" class="tour-popover">
        <h3 id="tour-title"></h3>
        <p id="tour-content"></p>
        <div id="tour-dots" class="tour-popover-dots"></div>
        <div class="tour-popover-nav">
            <button id="tour-skip-btn">Skip Tour</button>
            <div class="flex gap-2">
                <button id="tour-back-btn" class="btn-secondary text-sm">Back</button>
                <button id="tour-next-btn" class="btn-primary text-sm">Next</button>
                <button id="tour-finish-btn" class="btn-primary text-sm hidden">Finish</button>
            </div>
        </div>
    </div>
    
    <div id="apiKeyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card p-8 w-full max-w-md m-4">
            <div class="flex justify-between items-start">
                <h2 class="text-2xl font-bold mb-4 themed-text-primary">Enter Your API Key</h2>
                <div class="tooltip-container ml-2">
                    <svg class="tooltip-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <div class="tooltip">An API key is required to use the AI generation features of this application. Your key is stored securely in your browser and not shared.</div>
                </div>
            </div>
            <p class="mb-6 themed-text-muted">To use the AI generators, please provide your API key. This key is stored only in your browser.</p>
            <form id="apiKeyForm">
                <input type="password" id="apiKeyInput" class="w-full px-4 py-2 themed-input border rounded-lg focus:ring-2" placeholder="Your API Key" required>
                <button type="submit" class="w-full btn-primary mt-6">Save Key and Start</button>
            </form>
        </div>
    </div>
    <div id="loadingStateModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="card p-8 w-full max-w-md m-4 text-center">
            <h2 class="text-2xl font-bold mb-4 themed-text-primary">Waking up the AI...</h2>
            <div class="flex justify-center my-4"><div class="loader themed-loader"></div></div>
            <p id="loading-message" class="mb-6 themed-text-muted">The AI is generating the initial content and themes. This may take a few moments.</p>
            <button id="closeLoadingStateModal" class="btn-secondary">Close</button>
        </div>
    </div>
    <div id="inDepthModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-5xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 id="inDepthModalTitle" class="text-2xl font-bold themed-text-primary">In-Depth Exploration</h2>
                <div class="flex items-center gap-4">
                    <div class="tooltip-container">
                         <svg class="tooltip-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                         <div class="tooltip">This view provides a more detailed, descriptive version of the selected yoga plan, broken down into sections.</div>
                    </div>
                    <button id="closeInDepthModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
                </div>
            </div>
            <div id="inDepthModalContent" class="p-6 overflow-y-auto"></div>
            <div id="inDepthModalFooter" class="p-4 border-t flex flex-wrap gap-2 justify-center" style="border-color: var(--color-card-border);"></div>
        </div>
    </div>
    <div id="themeGeneratorModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-lg m-4 flex flex-col">
             <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 class="text-2xl font-bold themed-text-primary">AI Visual Theme Generator</h2>
                <div class="flex items-center gap-4">
                     <div class="tooltip-container">
                         <svg class="tooltip-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                         <div class="tooltip">Describe a mood or scene (e.g., "Misty forest at dawn") and the AI will generate a new color palette and header image for the entire app.</div>
                    </div>
                    <button id="closeThemeGeneratorModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
                </div>
            </div>
            <div class="p-6">
                <p class="mb-6 themed-text-muted">Describe a mood or concept to create a new color palette and header image for the app.</p>
                <textarea id="theme-prompt" rows="3" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'A quiet, misty forest at dawn'"></textarea>
                <button id="generate-theme-btn" class="btn-primary w-full mt-4" title="Generate new app visuals based on your text">Generate Visuals</button>
                <div id="theme-loader-container" class="hidden mt-4 flex items-center space-x-3">
                    <div class="loader themed-loader" style="width:25px; height:25px;"></div>
                    <span class="themed-text-muted">AI is generating colors & image...</span>
                </div>
                <div id="theme-error-container" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>
            </div>
        </div>
    </div>
    <div id="readingModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-2xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 id="readingModalTitle" class="text-2xl font-bold themed-text-primary">Thematic Reading</h2>
                <button id="closeReadingModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="readingModalContent" class="p-6 overflow-y-auto">
                <div id="reading-input-container" class="mb-6">
                    <label for="reading-authors" class="block text-sm font-medium themed-text-muted mb-1">Preferred Authors (Optional)</label>
                    <input type="text" id="reading-authors" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., Rumi, Mary Oliver, Thich Nhat Hanh">
                    <button id="generate-reading-btn" class="btn-primary w-full mt-4">Generate Reading</button>
                </div>
                <div id="reading-result-container" class="prose max-w-none">
                    <!-- Loader and results will appear here -->
                </div>
            </div>
        </div>
    </div>
    <div id="musicModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-2xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 id="musicModalTitle" class="text-2xl font-bold themed-text-primary">AI Music Curator</h2>
                <button id="closeMusicModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="music-selection-container">
                    <p class="themed-text-muted mb-2">Select one or more genres to influence the playlist:</p>
                    <div id="genre-buttons-container" class="flex flex-wrap gap-2 mb-6">
                        <!-- Genre buttons will be injected here -->
                    </div>
                    <button id="generate-playlist-btn" class="btn-primary w-full">Generate Playlist</button>
                </div>
                <div id="music-results-container" class="mt-6 prose max-w-none"></div>
            </div>
        </div>
    </div>
    
    <div class="container mx-auto">
        <header id="app-header" class="relative text-center mb-10 rounded-2xl overflow-hidden shadow-lg">
            <div id="header-loader" class="hidden absolute inset-0 bg-black bg-opacity-50 flex-col items-center justify-center z-20 transition-opacity duration-500">
                <div class="loader header-loader-spinner"></div>
                <p class="text-white mt-4 text-lg">Generating new header image...</p>
            </div>
            <div id="header-bg-image" class="absolute inset-0 header-bg-image"></div>
            <div class="absolute inset-0 bg-black opacity-40"></div>
            <div class="relative z-10 py-24 px-12 text-white">
                 <h1 class="text-4xl md:text-5xl font-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.6);">AI Yoga Class & Theme Generator</h1>
                <p class="text-lg text-purple-200 mt-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.6);">AI-powered inspiration and design for your practice.</p>
            </div>
            <div id="version-display" class="absolute bottom-2 right-4 text-white text-xs opacity-70">v23.1.0</div>
        </header>

        <nav id="jump-to-nav-container" class="hidden text-center mb-8"></nav>

        <main id="main-content" class="space-y-8">
            
            <div id="custom-plan-card" class="card">
                <div class="p-8 card-content">
                    <h2 class="text-2xl font-bold mb-2 themed-text-primary">Custom Yoga Plan Generator</h2>
                    <p class="mb-6 themed-text-muted">Define a focus, add a creative theme, and let AI craft a unique class plan for you.</p>
                    <form id="gemini-form" class="space-y-4">
                        <div>
                            <label for="gemini-focus" class="block text-sm font-medium themed-text-muted mb-1">Core Focus (Required)</label>
                            <input type="text" id="gemini-focus" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'Hip Opening & Flexibility'" required>
                        </div>
                        <div>
                            <label for="gemini-theme" class="block text-sm font-medium themed-text-muted mb-1">Creative Theme (Optional)</label>
                            <input type="text" id="gemini-theme" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'The Rhythm of the Seasons'">
                        </div>
                        
                        <div id="tailor-accordion" class="my-4 border rounded-lg" style="border-color: var(--color-card-border);">
                            <div class="accordion-item">
                                <button type="button" class="accordion-header" title="Click to see more options">
                                    <span>Tailor Your Plan:</span>
                                    <svg class="icon w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div class="accordion-content">
                                    <div id="tailoring-buttons-container" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>

                        <button id="generate-plan-btn" type="submit" class="btn-primary w-full mt-4" title="Generate a custom yoga plan based on your text">Generate AI Yoga Plan</button>
                    </form>
                    <div id="gemini-result-container" class="mt-6 prose max-w-none"></div>
                </div>
            </div>

            <div id="main-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8">
            </div>
            
            <div id="discover-more-container" class="text-center py-8">
                 <button id="discover-more-button" class="btn-primary px-8 py-4 text-lg" title="Generate a new random yoga category">
                    <span class="flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v2.5"/><path d="M12 22v-2.5"/><path d="M21.5 12.5h-2.5"/><path d="M4.5 12.5h2.5"/><path d="M18.89 6.11l-1.77 1.77"/><path d="M6.88 18.88l-1.77 1.77"/></svg>
                        Discover More Yoga Topics
                    </span>
                </button>
                <p id="discover-more-error" class="text-red-500 mt-2"></p>
            </div>
        </main>
    </div>

    <button id="theme-changer-button" class="floating-action-button" title="Change Visual Theme">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l.34.34a8 8 0 0111.32 11.32l-.34.34a8 8 0 01-11.32-11.32l.34-.34z"/><path d="M16 12l-4.5 4.5-2.5-2.5"/><path d="M22 12s-4-8-10-8S2 12 2 12s4 8 10 8 10-8 10-8z"/></svg>
    </button>
    <button id="settings-button" class="floating-action-button" title="Typography Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
    </button>
    <button id="new-plan-button" class="floating-action-button" title="Reset View">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
    </button>
    <button id="scroll-to-top-button" class="floating-action-button hidden" title="Scroll to top">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
    </button>
    <div id="settings-panel" class="hidden">
        <h3 class="text-lg font-bold themed-text-accent mb-4">Display Settings</h3>
        <div class="space-y-4">
            <div>
                <label for="font-family-select" class="block text-sm font-medium themed-text-muted mb-1">Font Family</label>
                <select id="font-family-select" class="w-full p-2 themed-input border rounded-lg"></select>
            </div>
            <div>
                <label for="font-size-select" class="block text-sm font-medium themed-text-muted mb-1">Font Size (px)</label>
                <select id="font-size-select" class="w-full p-2 themed-input border rounded-lg"></select>
            </div>
            <div>
                <label for="line-height-select" class="block text-sm font-medium themed-text-muted mb-1">Line Spacing</label>
                <select id="line-height-select" class="w-full p-2 themed-input border rounded-lg"></select>
            </div>
            <div>
                <label for="temperature-slider" class="block text-sm font-medium themed-text-muted mb-1">
                    AI Creativity
                    <span class="tooltip-container inline-block ml-1">
                        <svg class="tooltip-icon w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <div class="tooltip" style="width: 220px; text-align: left; bottom: 100%; top: auto; margin-bottom: 8px;">Lower values are more focused/deterministic. Higher values are more random/creative.</div>
                    </span>
                </label>
                <div class="flex items-center gap-2">
                    <input id="temperature-slider" type="range" min="0.1" max="1.0" step="0.1" class="w-full">
                    <span id="temperature-value" class="text-sm themed-text-muted font-mono w-8 text-center">0.7</span>
                </div>
            </div>
        </div>
    </div>


    <footer class="mt-16 py-8 text-center border-t" style="border-color: var(--color-card-border);">
        <div class="max-w-4xl mx-auto px-4">
            <p class="themed-text-muted font-semibold">Disclaimer</p>
            <p class="themed-text-muted text-sm mt-2">
                This application and its content are for informational and inspirational purposes only. The yoga plans and suggestions generated by AI are not a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of your physician or other qualified health provider with any questions you may have regarding a medical condition. Never disregard professional medical advice or delay in seeking it because of something you have read on this application. The creators of this application are not responsible for any injuries or damages that may result from the use of these activities.
            </p>
        </div>
    </footer>


    <script type="module">
        // --- Global State & Configuration ---
        let userApiKey = "";
        let temperature = 0.7; // Default creativity/temperature value
        const root = document.documentElement;
        const allThemeData = {};
        const fullPrompts = {}; 
        let originalGeneratedText = new Map();
        let originalPlanContext = {}; // NEW: Stores context for refinement

        // --- App Initialization & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            populateTypographySettings();
            setupTour();
            marked.setOptions({
                renderer: new marked.Renderer(),
                gfm: true,
                breaks: false,
                sanitize: false
            });
        });

        function setupEventListeners() {
            // Main Actions
            document.getElementById('apiKeyForm').addEventListener('submit', handleApiKeySubmit);
            document.getElementById('gemini-form').addEventListener('submit', handleGeminiSubmit);
            document.getElementById('generate-theme-btn').addEventListener('click', handleCustomVisualThemeGeneration);
            document.getElementById('discover-more-button').addEventListener('click', handleDiscoverMoreClick);

            // Floating Action Buttons & Panels
            document.getElementById('new-plan-button').addEventListener('click', resetAppView);
            document.getElementById('theme-changer-button').addEventListener('click', () => {
                if(!userApiKey) { showNotification('Please enter your API key to use the theme generator.', true); return; }
                document.getElementById('themeGeneratorModal').classList.remove('hidden');
            });
            document.getElementById('scroll-to-top-button').addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

            // Settings Panel
            const settingsPanel = document.getElementById('settings-panel');
            document.getElementById('settings-button').addEventListener('click', (e) => {
                e.stopPropagation();
                settingsPanel.classList.toggle('hidden');
            });

            // Typography & Creativity Selects
            document.getElementById('font-family-select').addEventListener('change', (e) => root.style.setProperty('--font-family', e.target.value));
            document.getElementById('font-size-select').addEventListener('change', (e) => root.style.setProperty('--font-size-base', e.target.value));
            document.getElementById('line-height-select').addEventListener('change', (e) => root.style.setProperty('--line-height-base', e.target.value));
            const tempSlider = document.getElementById('temperature-slider');
            const tempValue = document.getElementById('temperature-value');
            tempSlider.value = temperature;
            tempValue.textContent = temperature.toFixed(1);
            tempSlider.addEventListener('input', (e) => {
                temperature = parseFloat(e.target.value);
                tempValue.textContent = temperature.toFixed(1);
            });
            
            // Modal Closing Listeners
            ['themeGeneratorModal', 'inDepthModal', 'loadingStateModal', 'readingModal', 'musicModal'].forEach(id => {
                 document.getElementById(id).addEventListener('click', (e) => {
                     if (e.target.closest('[id^="close"]')) {
                         document.getElementById(id).classList.add('hidden');
                     }
                 });
            });
            
            // Music Modal Specific Listener
            document.getElementById('generate-playlist-btn').addEventListener('click', handleGeneratePlaylist);


            // Global Clicks for dynamic content and closing panels
            document.addEventListener('click', (e) => {
                const tailorBtn = e.target.closest('.btn-toggle');
                if (tailorBtn && e.target.closest('#tailoring-buttons-container, .refine-tailoring-container')) {
                    tailorBtn.classList.toggle('active');
                    return;
                }
                
                const genreBtn = e.target.closest('#genre-buttons-container .btn-toggle');
                if (genreBtn) {
                    genreBtn.classList.toggle('active');
                    return;
                }

                const gridSelector = e.target.closest('.grid-card-selector');
                if (gridSelector) {
                    const container = gridSelector.closest('.card-grid-container, .week-by-week-grid').parentElement;
                    const currentlyActive = container.querySelector('.grid-card-selector.active');
                    if(currentlyActive) currentlyActive.classList.remove('active');
                    gridSelector.classList.add('active');
                    handleGridSelect(gridSelector);
                    return;
                }

                const exploreBtn = e.target.closest('.explore-button');
                if (exploreBtn) {
                    handleExploreInDepth(exploreBtn.dataset.themeId, exploreBtn.dataset.themeType);
                    return;
                }
                
                const refineBtn = e.target.closest('.refine-button');
                if (refineBtn) {
                    toggleRefineUI(refineBtn.parentElement);
                    return;
                }

                const modalRefineBtn = e.target.closest('.modal-refine-button');
                 if (modalRefineBtn) {
                    toggleRefineUI(modalRefineBtn.parentElement, true);
                    return;
                }
                
                const submitRefineBtn = e.target.closest('.submit-refinement-button');
                if(submitRefineBtn) {
                    handleRefineRequest(submitRefineBtn);
                    return;
                }
                
                const showAllBtn = e.target.closest('.show-all-button');
                if (showAllBtn) {
                    handleShowAllClick(showAllBtn);
                    return;
                }

                const accordionHeader = e.target.closest('.accordion-header');
                if (accordionHeader) { 
                    accordionHeader.classList.toggle('active'); 
                    const icon = accordionHeader.querySelector('.icon');
                    if (icon) icon.style.transform = accordionHeader.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0deg)';
                    accordionHeader.nextElementSibling.classList.toggle('open'); 
                    return;
                }
                
                const jumpToBtn = e.target.closest('.jump-to-button');
                if (jumpToBtn) {
                    const targetCard = document.getElementById(jumpToBtn.dataset.targetId);
                    if (targetCard) {
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'start'});
                        targetCard.style.boxShadow = '0 0 0 4px var(--color-primary)';
                        setTimeout(() => targetCard.style.boxShadow = '', 2000);
                    }
                    return;
                }

                const readingBtn = e.target.closest('.reading-button');
                if (readingBtn) {
                    handleFindReadingClick(readingBtn);
                    return;
                }

                const generateReadingBtn = e.target.closest('#generate-reading-btn');
                if (generateReadingBtn) {
                    handleGenerateReadingRequest(generateReadingBtn);
                    return;
                }
                
                const musicBtn = e.target.closest('.music-button');
                if(musicBtn) {
                    handleSuggestMusicClick(musicBtn);
                    return;
                }

                const newRoutineBtn = e.target.closest('.new-routine-button');
                if (newRoutineBtn) {
                    handleNewRoutineRequest(newRoutineBtn);
                    return;
                }
                
                const exportWordBtn = e.target.closest('.export-word-button');
                if (exportWordBtn) {
                    handleExportToWord();
                    return;
                }

                if (!settingsPanel.classList.contains('hidden') && !settingsPanel.contains(e.target) && !e.target.closest('#settings-button')) {
                    settingsPanel.classList.add('hidden');
                }
            });
            
            window.addEventListener('scroll', () => {
                const scrollTopButton = document.getElementById('scroll-to-top-button');
                if (window.scrollY > 300) {
                    scrollTopButton.classList.remove('hidden');
                } else {
                    scrollTopButton.classList.add('hidden');
                }
            });
        }
        
        async function handleApiKeySubmit(e) {
             e.preventDefault();
             const input = document.getElementById('apiKeyInput');
             if (!input.value.trim()) return;
             userApiKey = input.value.trim();
             document.getElementById('apiKeyModal').classList.add('hidden');

             const loadingModal = document.getElementById('loadingStateModal');
             const loadingMessageEl = document.getElementById('loading-message');
             loadingMessageEl.textContent = "The AI is generating the initial content and themes. This may take a few moments.";
             loadingModal.classList.remove('hidden');

             const modalMessage = document.querySelector('#apiKeyModal p');
             modalMessage.textContent = 'To use the AI generators, please provide your API key...';
             modalMessage.classList.remove('text-red-600', 'font-bold');
             document.getElementById('main-grid').innerHTML = '';
             document.getElementById('jump-to-nav-container').innerHTML = '';
             document.getElementById('gemini-result-container').innerHTML = '';
             document.getElementById('discover-more-error').innerHTML = '';

             try {
                 await generateAndApplyDefaultTheme();
                 await loadAppContent(loadingMessageEl);
                 if (localStorage.getItem('yogaTourCompleted') !== 'true') {
                    startTour();
                 }
             } catch (error) {
                 console.error("A critical error occurred during app initialization:", error);
                if (document.getElementById('apiKeyModal').classList.contains('hidden')) {
                    modalMessage.textContent = 'An error occurred during setup. Some content may have failed to load. Please check your API key and connection.';
                    modalMessage.classList.add('text-red-600', 'font-bold');
                    document.getElementById('apiKeyModal').classList.remove('hidden');
                }
             } finally {
                 loadingModal.classList.add('hidden');
             }
        }

        async function loadAppContent(loadingMessageEl) {
            try {
                const categoriesToGenerate = [
                    { key: 'hipReplacement', title: 'Gentle Yoga After Hip Replacement', description: "A week-by-week guide to support recovery and mobility.", initialPrompt: `Generate a 12-week yoga recovery plan for hip replacement. Structure as a JSON array where each object is a phase (e.g., "Weeks 1-2"). Each object must have a unique "id", a "title" (like "Weeks 1-2: Foundational Stability"), and a "description" of the focus for that phase. Provide 6-8 phases total. Return ONLY a valid JSON array.`, fullPrompt: `Generate a detailed 12-week yoga recovery plan for hip replacement. Structure as a JSON array where each object is a phase (e.g., "Weeks 1-2"). Each object must have a unique "id", a "title" (like "Weeks 1-2: Foundational Stability"), and a "description" of the focus for that phase. Provide all 12 weeks, grouped into logical phases. Return ONLY a valid JSON array.` },
                    { key: 'styles', title: 'Yoga Styles', description: "Base your class around a specific yoga style.", initialPrompt: `Generate 10 major yoga styles. For each, give a unique "id", "title", and "description". Return ONLY a valid JSON array.`, fullPrompt: `Generate 40-50 major and niche yoga styles. For each, give a unique "id", "title", "founder", and "description". Return ONLY a valid JSON array.` },
                    { key: 'chakras', title: 'The Seven Chakras', description: "Align your practice with the body's primary energy centers.", initialPrompt: `Generate data for the 7 primary chakras. For each, give "id", "title", and "explanation". Return ONLY a valid JSON array.`, fullPrompt: `Generate data for the 7 primary chakras with detailed explanations. For each, give "id", "title", and "explanation". Return ONLY a valid JSON array.` },
                    { key: 'seasons', title: 'The Four Seasons', description: "Align your practice with the natural cycles of the earth.", initialPrompt: `Generate data for the 4 seasons. For each, give a unique "id", "title", "date" (MM/DD), and "explanation" for a yoga context. Return ONLY a valid JSON array.`, fullPrompt: `Generate data for the 4 seasons with detailed explanations. For each, give "id", "title", "date" (MM/DD), and "explanation" for a yoga context. Return ONLY a valid JSON array.` },
                    { key: 'moonPhases', title: 'Moon Phases', description: "Align with the energy of the lunar cycle.", initialPrompt: `Generate data for the 8 moon phases. For each, give a unique "id", "title", and "explanation". Return ONLY a valid JSON array.`, fullPrompt: `Generate data for the 8 moon phases with detailed explanations. For each, give a unique "id", "title", and "explanation". Return ONLY a valid JSON array.` },
                    { key: 'meridians', title: 'The Twelve Meridians', description: "Explore the major meridians of Traditional Chinese Medicine.", initialPrompt: `Generate the 6 primary Meridian pairs from TCM. For each, give a unique "id", "title", and "explanation". Return ONLY a valid JSON array.`, fullPrompt: `Generate the 6 primary Meridian pairs from TCM with detailed explanations. For each, give a unique "id", "title", and "explanation". Return ONLY a valid JSON array.` },
                    { key: 'danceYoga', title: 'Dance & Movement Yoga', description: "Incorporate fluid dance-like movements into your flow.", initialPrompt: `Generate 10 yoga themes that incorporate dance and expressive movement. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, fullPrompt: `Generate 40-50 yoga themes that incorporate dance, expressive movement, and rhythm. For each, give a unique "id", "title", and a "description". Return ONLY a valid JSON array.` },
                    { key: 'yogaForAthletes', title: 'Yoga for Athletes', description: "Target specific muscle groups and improve recovery for athletic performance.", initialPrompt: `Generate 10 yoga themes for athletes (e.g., 'For Runners', 'For Cyclists'). For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, fullPrompt: `Generate 40-50 yoga themes for different types of athletes, focusing on recovery, flexibility, and injury prevention. For each, give a unique "id", "title", and a "description". Return ONLY a valid JSON array.` },
                    { key: 'archetypes', title: 'Mythical & Archetypal Yoga', description: "Embody the qualities of gods, goddesses, and archetypes.", initialPrompt: `Generate 10 yoga themes based on archetypes or mythical figures (e.g., 'The Warrior', 'The Sage'). For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, fullPrompt: `Generate 40-50 yoga themes based on global mythologies, archetypes, and legendary figures. For each, give a unique "id", "title", and a "description". Return ONLY a valid JSON array.` },
                    { key: 'holidays', title: 'Holidays & Celebrations', description: "Align your practice with festive and seasonal holidays.", initialPrompt: `Generate data for 10 major Western holidays. For each, give "id", "title", "date" (MM/DD), and a brief "explanation" for a yoga context. Return ONLY a valid JSON array.`, fullPrompt: `Generate data for 40-50 major global holidays and celebrations. For each, give "id", "title", "date" (MM/DD), and a detailed "explanation" for a yoga context. Return ONLY a valid JSON array.` },
                    { key: 'neurodiversity', title: 'Yoga for Neurodiversity', description: "Practices for sensory regulation and grounding.", initialPrompt: `Generate 10 yoga themes for neurodiverse individuals. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, fullPrompt: `Generate 40-50 yoga themes for neurodiverse individuals, focusing on regulation and grounding. For each, give a unique "id", "title", and a "description". Return ONLY a valid JSON array.` }
                ];

                await Promise.allSettled([loadAITailoringOptions(), loadDynamicPlaceholders(), loadThemePlaceholders()]);
                
                const generationPromises = categoriesToGenerate.map(cat => {
                    if (loadingMessageEl) loadingMessageEl.textContent = `Generating themes for: ${cat.title}...`;
                    return generateAndPopulateAICategory(cat).catch(e => {
                        console.error(`Failed to load category: ${cat.title}`, e);
                        return { key: cat.key, error: e };
                    });
                });

                const results = await Promise.all(generationPromises);
                const firstFailure = results.find(r => r && r.error);
                if(firstFailure){
                   throw new Error(`One or more AI content categories failed to load, starting with ${firstFailure.key}. The process has been stopped.`);
                }
                
                if (loadingMessageEl) loadingMessageEl.textContent = `Building navigation...`;
                await generateJumpToButtons();

            } catch (error) {
                console.error("An error occurred while loading app content:", error.message);
                throw error;
            }
        }
        
        async function generateAndPopulateAICategory({key, title, description, initialPrompt, fullPrompt}) {
            const mainGrid = document.getElementById('main-grid');
            const card = document.createElement('div');
            card.className = 'card md:col-span-2';
            card.id = `${key}-card`;
            const selectorId = `${key}-selector-visual`;
            card.innerHTML = `<div class="p-8 card-content"><h2 class="text-2xl font-bold mb-2 themed-text-primary">${title}</h2><p class="mb-6 themed-text-muted">${description}</p><div id="${selectorId}" class="w-full">${getLoaderHTML(`AI is generating ${title}...`)}</div><div id="${key}-details" class="details-container prose max-w-none mt-4"></div></div>`;
            mainGrid.appendChild(card);
            
            fullPrompts[key] = fullPrompt;

            try {
                const jsonText = await callGeminiAPI(initialPrompt, true);
                if (!jsonText) throw new Error(`API returned empty content for ${title}.`);
                
                const data = parseJsonWithCorrections(jsonText);
                allThemeData[key] = data;
                populateCardGridSelector(selectorId, key);
            } catch (error) {
                handleApiError(error, document.getElementById(selectorId), title, card);
                throw error;
            }
        }
        
        async function populateCardGridSelector(containerId, themeType) {
            const container = document.getElementById(containerId);
            const data = allThemeData[themeType];
            if (!container || !data || !Array.isArray(data) || data.length === 0) {
                if (container) container.innerHTML = `<p class="themed-text-muted">No items to display.</p>`;
                return;
            }
        
            if (themeType === 'holidays' || themeType === 'seasons') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const currentYear = today.getFullYear();

                data.forEach(item => {
                    if (item.date && /^\d{1,2}\/\d{1,2}$/.test(item.date)) {
                        const [month, day] = item.date.split('/').map(Number);
                        let itemDate = new Date(currentYear, month - 1, day);
                        if (itemDate < today) {
                            itemDate.setFullYear(currentYear + 1);
                        }
                        item.sortDate = itemDate;
                    } else {
                        item.sortDate = new Date(currentYear + 2, 0, 1); 
                    }
                });
                data.sort((a, b) => a.sortDate - b.sortDate);
            }
        
            const isWeekByWeek = themeType === 'hipReplacement';
            const gridClass = isWeekByWeek ? 'week-by-week-grid' : 'card-grid-container';
        
            const itemsHtml = data.map((item, index) => {
                const extraInfo = item.date || item.dateRange || item.founder || item.tradition || '';
                const icon = getIconForTheme(); // Always use fallback
                return `
                <div class="grid-card-selector" data-theme-id="${item.id}" data-theme-type="${themeType}" title="${item.description || item.explanation || ''}">
                    <div class="icon">${icon}</div>
                    <div class="mt-2">
                        <strong class="text-sm leading-tight block">${item.title}</strong>
                        ${extraInfo ? `<small class="block text-xs themed-text-muted mt-1">${extraInfo}</small>` : ''}
                    </div>
                </div>`;
            }).join('');
            
            const fullPrompt = fullPrompts[themeType];
            let showAllButtonHtml = '';
            
            if (fullPrompt && !isWeekByWeek && data.length < 35 && data.length > 0) {
                 showAllButtonHtml = `
                    <div class="col-span-full text-center mt-4">
                        <button class="show-all-button btn-secondary" data-container-id="${containerId}" data-theme-type="${themeType}">
                            Show All (${data.length} of ~50 shown)
                        </button>
                    </div>`;
            }

            container.innerHTML = `<div class="${gridClass}">${itemsHtml}</div>${showAllButtonHtml}`;
        }
        
        async function handleShowAllClick(button) {
            const { containerId, themeType } = button.dataset;
            const container = document.getElementById(containerId);
            const fullPrompt = fullPrompts[themeType];

            if (!container || !fullPrompt) return;

            button.disabled = true;
            button.innerHTML = `<span class="flex items-center justify-center gap-2"><div class="loader themed-loader" style="width:20px; height:20px; border-width: 2px;"></div>Loading all...</span>`;

            try {
                const jsonText = await callGeminiAPI(fullPrompt, true);
                if (!jsonText) throw new Error(`API returned empty content for ${themeType} (full list).`);
                allThemeData[themeType] = parseJsonWithCorrections(jsonText);
                populateCardGridSelector(containerId, themeType);
                document.getElementById(`${themeType}-details`).innerHTML = '';
            } catch (error) {
                button.disabled = false;
                button.classList.add('bg-red-100', 'text-red-700');
                button.textContent = "Error. Try again.";
                console.error(`Error loading full list for ${themeType}:`, error);
            }
        }

        async function handleGridSelect(target) {
            const { themeId, themeType } = target.dataset;
            const item = allThemeData[themeType]?.find(d => String(d.id) == String(themeId));
            if (!item) {
                console.error("Could not find theme item for:", {themeId, themeType});
                return;
            }

            const prompt = `Generate a very brief, condensed summary for a yoga class plan based on the theme: "${item.title}". For each section (Theme Introduction, Breathwork, Warm-up, Main Sequence, Cool-down, Savasana), provide a single descriptive sentence. Return the response as a simple markdown string where each section is a bullet point, starting with '*'.`;
            
            const resultContainer = document.getElementById(`${themeType}-details`);
            resultContainer.innerHTML = getLoaderHTML(`Generating summary for ${item.title}...`);

            try {
                let resultText = await callGeminiAPI(prompt);
                
                if (typeof resultText === 'object' && resultText !== null) {
                    const values = Object.values(resultText);
                    const markdownContent = values.find(v => typeof v === 'string' && v.includes('*'));
                    resultText = markdownContent || JSON.stringify(resultText, null, 2);
                }

                originalGeneratedText.set(themeId, resultText); 
                resultContainer.innerHTML = convertMarkdownToHtml(resultText);
                addPostGenerationButtons(resultContainer, themeId, themeType);
            } catch (error) {
                handleApiError(error, resultContainer, `plan for ${item.title}`);
            }
        }

        async function handleGeminiSubmit(e) {
            e.preventDefault();
            const focusInput = document.getElementById('gemini-focus');
            const themeInput = document.getElementById('gemini-theme');
            const focusPrompt = focusInput.value.trim();
            const themePrompt = themeInput.value.trim();

            if (!focusPrompt) {
                showNotification('Please enter a Core Focus for your plan.', true);
                focusInput.focus();
                return;
            }

            const resultContainer = document.getElementById('gemini-result-container');
            resultContainer.innerHTML = getLoaderHTML('Drafting your yoga plan summary...');
            
            let fullUserPrompt = `Core Focus: "${focusPrompt}"`;
            if (themePrompt) {
                fullUserPrompt += `, with a creative theme of "${themePrompt}"`;
            }
            
            const prompt = `Generate a very brief, condensed summary for a yoga class plan based on the following: ${fullUserPrompt}. For each section (Theme Introduction, Breathwork, Warm-up, Main Sequence, Cool-down, Savasana), provide a single descriptive sentence. Return the response as a simple markdown string where each section is a bullet point, starting with '*'.`;

            try {
                const resultText = await callGeminiAPI(prompt);
                originalGeneratedText.set('custom-plan', resultText);
                resultContainer.innerHTML = convertMarkdownToHtml(resultText);
                addPostGenerationButtons(resultContainer, 'custom-plan', 'custom');
            } catch(error) {
                handleApiError(error, resultContainer, 'custom yoga plan summary');
            }
        }
        
        function parseJsonWithCorrections(jsonString) {
            if (typeof jsonString !== 'string') {
                console.warn("parseJsonWithCorrections received non-string input:", jsonString);
                if (typeof jsonString === 'object' && jsonString !== null) {
                    try {
                        jsonString = JSON.stringify(jsonString);
                    } catch (e) {
                         throw new Error("Input is a non-stringifiable object.");
                    }
                } else {
                    throw new Error("Invalid input: not a string or stringifiable object.");
                }
            }
            
            let cleanedString = jsonString.replace(/^```(json|markdown)?\s*/, '').replace(/\s*```$/, '').trim();
            cleanedString = cleanedString.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
            cleanedString = cleanedString.replace(/,\s*(}|])/g, '$1');

            try {
                return JSON.parse(cleanedString);
            } catch (error) {
                console.error("JSON Parse Error:", error.message);
                console.error("Original string for context:", jsonString);
                console.error("Cleaned string before parse:", cleanedString);
                throw new Error(`JSON Parse Error: ${error.message}.`);
            }
        }

        async function callApi(apiUrl, payload) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000);

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    let errorBody;
                    try { errorBody = await response.json(); } catch { errorBody = await response.text(); }
                    console.error("API Error Response:", errorBody);
                    const errorMsg = errorBody?.error?.message || response.statusText;
                    throw new Error(`API request failed with status ${response.status}. Message: ${errorMsg}`);
                }
                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') throw new Error('The AI service request timed out. Please try again.');
                throw error;
            }
        }

        async function callGeminiAPI(prompt, isJson = false) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            const generationConfig = {
                temperature: temperature, // Use the global variable for creativity
                maxOutputTokens: 8192
            };

            if (isJson) {
                generationConfig.responseMimeType = "application/json";
            }

            payload.generationConfig = generationConfig;
            
            const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${userApiKey}`, payload);
            return result?.candidates?.[0]?.content?.parts?.[0]?.text || null;
        }

        async function callImageGenAPI(prompt) {
             const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
             const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${userApiKey}`, payload);
             const base64 = result?.predictions?.[0]?.bytesBase64Encoded;
             return base64 ? `data:image/png;base64,${base64}` : null;
        }
        
        async function callColorGenAPI(prompt) {
             const fullPrompt = `Based on the theme "${prompt}", generate a color palette. I need a JSON object with keys: "bg", "text", "primary", "primaryDark", "accent", "cardBg", "cardBorder", "textMuted", "inputBg", "inputBorder", "buttonText". Determine if the "primary" color is light or dark to set the "buttonText" appropriately (#FFFFFF for dark, #111827 for light). Return only the complete, valid JSON.`;
             const jsonText = await callGeminiAPI(fullPrompt, true);
             if (jsonText) return parseJsonWithCorrections(jsonText);
             throw new Error("Could not parse a valid color theme from API response.");
        }

        function handleApiError(error, container, contentType = 'content') {
            console.error(`Error generating ${contentType}:`, error);
            const errorMessage = generateErrorMessage(error, contentType);
            if (container) {
                container.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">${errorMessage}</div>`;
            }
        }
        
        async function generateAndApplyDefaultTheme() {
            showThemeLoading(true);
            const themePrompt = "Big Sunset on the beach";
            const imagePrompt = `Artistic, abstract background image inspired by "${themePrompt}". Suitable for a yoga website. Serene, calming. Wide aspect ratio, photographic, cinematic lighting.`;
            try {
                const [colorResult, imageResult] = await Promise.allSettled([callColorGenAPI(themePrompt), callImageGenAPI(imagePrompt)]);
                
                if (colorResult.status === 'fulfilled' && colorResult.value) applyTheme(colorResult.value);
                else throw colorResult.reason || new Error("Failed to generate color theme.");

                if (imageResult.status === 'fulfilled' && imageResult.value) applyHeaderImage(imageResult.value);
                else throw imageResult.reason || new Error("Failed to generate header image.");

            } catch (error) {
                 handleApiError(error, null, 'default theme');
                 throw error;
            } finally {
                showThemeLoading(false);
            }
        }
        
        async function loadAITailoringOptions() {
            const container = document.getElementById('tailoring-buttons-container');
            container.innerHTML = getLoaderHTML('Loading enhancement options...', true).innerHTML;
            try {
                const prompt = `You are an expert in yoga, functional fitness, and somatic practices. Generate a JSON array of 40-50 diverse focus areas for a movement practice. The list should be a blend of concepts from multiple disciplines.

**Include terms from:**
* **Traditional Yoga:** (e.g., 'Hip Opening', 'Arm Balances', 'Nadi Shodhana Pranayama', 'Yoga Nidra').
* **Functional Movement:** (e.g., 'Dynamic Core Stability', 'Gait & Proprioception', 'Shoulder Mobility Drills', 'Spinal Decompression').
* **Somatic/Mindful Practice:** (e.g., 'Somatic Exploration', 'Mind-to-Muscle Connection', 'Proprioceptive Awareness', 'Deep Relaxation').

Return ONLY a valid JSON array of strings.`;
                const jsonText = await callGeminiAPI(prompt, true);
                const options = parseJsonWithCorrections(jsonText);
                if (!options || !Array.isArray(options)) {
                    throw new Error("AI did not return a valid array of options.");
                }
                populateTailoringButtons(options);
            } catch (error) {
                console.error("Failed to load AI tailoring options, using fallback list.", error);
                handleApiError(error, container, 'tailoring options');
                const fallbackOptions = ["Mindfulness", "Balance", "Flexibility", "Strength", "Relaxation", "Meditation", "Breathing", "Alignment", "Gentle Flow", "Deep Stretch", "Core Work", "Hip Opening", "Back Care", "Stress Relief", "Yin Style", "Restorative"];
                populateTailoringButtons(fallbackOptions);
            }
        }

        function populateTailoringButtons(options, containerId = 'tailoring-buttons-container', selectedOptions = []) {
            const container = document.getElementById(containerId);
            const isRefineUI = containerId.startsWith('refine-tailoring-container');

            const staticButtons = `
                <button type="button" class="btn-toggle text-sm px-3 py-1 rounded-full ${!isRefineUI || selectedOptions.includes('Blocks') ? 'active' : ''}">Blocks</button>
                <button type="button" class="btn-toggle text-sm px-3 py-1 rounded-full ${!isRefineUI || selectedOptions.includes('Bolster') ? 'active' : ''}">Bolster</button>
                <button type="button" class="btn-toggle text-sm px-3 py-1 rounded-full ${!isRefineUI || selectedOptions.includes('Strap') ? 'active' : ''}">Strap</button>
                <button type="button" class="btn-toggle text-sm px-3 py-1 rounded-full ${!isRefineUI || selectedOptions.includes('Blanket') ? 'active' : ''}">Blanket</button>
            `;
            const dynamicButtons = options.map(option =>
                `<button type="button" class="btn-toggle text-sm px-3 py-1 rounded-full ${selectedOptions.includes(option) ? 'active' : ''}">${option}</button>`
            ).join('');
            container.innerHTML = staticButtons + dynamicButtons;
        }
        
        async function loadDynamicPlaceholders() {
            const promptInput = document.getElementById('gemini-focus');
            const prompt = `Generate a JSON array of 3 creative yoga class focus ideas for input placeholders. Examples: "Shoulder Mobility & Strength", "Full Body Unwind". Return ONLY the valid JSON array of strings.`;
            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if(!jsonText) return;
                const placeholders = parseJsonWithCorrections(jsonText);
                if (placeholders && placeholders.length > 0) {
                    let i = 0;
                    promptInput.placeholder = `e.g., '${placeholders[i]}'`;
                    setInterval(() => {
                        i = (i + 1) % placeholders.length;
                        promptInput.placeholder = `e.g., '${placeholders[i]}'`;
                    }, 3000);
                }
            } catch(error) {
                console.error("Could not load dynamic placeholders for focus", error);
            }
        }

        async function loadThemePlaceholders() {
            const themeInput = document.getElementById('gemini-theme');
            const prompt = `Generate a JSON array of 3 creative, evocative yoga class themes for input placeholders. Examples: "Finding Stillness in Chaos", "The Wisdom of the Forest". Return ONLY the valid JSON array of strings.`;
            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if(!jsonText) return;
                const placeholders = parseJsonWithCorrections(jsonText);
                if (placeholders && placeholders.length > 0) {
                    let i = 0;
                    themeInput.placeholder = `e.g., '${placeholders[i]}'`;
                    setInterval(() => {
                        i = (i + 1) % placeholders.length;
                        themeInput.placeholder = `e.g., '${placeholders[i]}'`;
                    }, 3500); // Stagger the interval
                }
            } catch(error) {
                console.error("Could not load dynamic placeholders for theme", error);
            }
        }

        function applyTheme(colors) {
            Object.entries(colors).forEach(([key, value]) => {
                const cssVar = `--color-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                root.style.setProperty(cssVar, value);
            });
        }
        
        function applyHeaderImage(imageUrl) {
            const bgImageDiv = document.getElementById('header-bg-image');
            bgImageDiv.style.backgroundImage = `url('${imageUrl}')`;
        }

        function showThemeLoading(isLoading) {
            const loader = document.getElementById('header-loader');
            loader.classList.toggle('hidden', !isLoading);
            loader.classList.toggle('flex', isLoading);
        }
        
        function convertMarkdownToHtml(text) {
            if (!text || typeof text !== 'string') {
                return '<p class="themed-text-muted">No content was generated or content was invalid.</p>';
            }
            let cleanText = text.replace(/^```(markdown|json)?\s*/g, '').replace(/```/g, '').trim();
            // FIX: Standardize list markers from * to - to ensure proper rendering
            cleanText = cleanText.replace(/^[\s]*\*[\s]/gm, '- ');
            if (!cleanText) {
                 return '<p class="themed-text-muted">No content was generated or content was invalid.</p>';
            }
            return marked.parse(cleanText);
        }
        
        function renderAccordionFromMarkdown(markdownText, containerElement) {
            containerElement.innerHTML = ''; 
            if (!markdownText || !markdownText.trim()) {
                containerElement.innerHTML = convertMarkdownToHtml(null);
                return;
            }

            const fullHtml = convertMarkdownToHtml(markdownText);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = fullHtml;

            const nodes = Array.from(tempDiv.childNodes);
            let currentAccordionItem = null;
            let introContent = document.createElement('div');
            introContent.className = 'accordion-intro mb-4 prose max-w-none';

            let firstHeaderFound = false;

            nodes.forEach(node => {
                const isHeader = (node.tagName === 'H3' || node.tagName === 'H2' || node.tagName === 'H1' || node.tagName === 'H4');

                if (!firstHeaderFound && !isHeader) {
                    introContent.appendChild(node.cloneNode(true));
                    return;
                }
                
                if (isHeader && (node.tagName !== 'H4')) {
                    firstHeaderFound = true;
                    if (introContent.hasChildNodes()) {
                        containerElement.appendChild(introContent);
                        introContent = document.createElement('div'); 
                        introContent.className = 'accordion-intro mb-4 prose max-w-none';
                    }

                    currentAccordionItem = document.createElement('div');
                    currentAccordionItem.className = 'accordion-item';

                    const title = node.textContent;
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'accordion-content prose max-w-none';

                    currentAccordionItem.innerHTML = `
                        <button type="button" class="accordion-header">
                            <span class="text-left">${title}</span>
                            <svg class="icon w-5 h-5 transition-transform shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    `;
                    currentAccordionItem.appendChild(contentDiv);
                    containerElement.appendChild(currentAccordionItem);
                } else if (currentAccordionItem) {
                    const contentDiv = currentAccordionItem.querySelector('.accordion-content');
                    contentDiv.appendChild(node.cloneNode(true));
                }
            });
            
            if (!firstHeaderFound) {
                containerElement.innerHTML = fullHtml;
                return;
            }

            if (introContent.hasChildNodes()) {
                containerElement.appendChild(introContent);
            }

            const firstItem = containerElement.querySelector('.accordion-item');
            if (firstItem) {
                const header = firstItem.querySelector('.accordion-header');
                header.classList.add('active');
                header.querySelector('.icon').style.transform = 'rotate(180deg)';
                firstItem.querySelector('.accordion-content').classList.add('open');
            }
        }


        function addPostGenerationButtons(container, themeId, themeType) {
            let buttonBar = container.querySelector('.button-bar');
            if (buttonBar) buttonBar.remove();

            buttonBar = document.createElement('div');
            buttonBar.className = 'button-bar flex flex-wrap gap-2 mt-4 pt-4 border-t';
            buttonBar.style.borderColor = 'var(--color-card-border)';
            
            buttonBar.innerHTML = `
                <button class="btn-primary text-sm explore-button" data-theme-id="${themeId}" data-theme-type="${themeType}">Explore In-Depth</button>
                <button class="btn-secondary text-sm refine-button">Refine with AI</button>
                <button class="btn-secondary text-sm copy-button">Copy Text</button>
            `;
            container.appendChild(buttonBar);
            buttonBar.querySelector('.copy-button').addEventListener('click', e => {
                 const contentToCopy = e.target.closest('.details-container, #gemini-result-container');
                 if(contentToCopy) copyElementTextToClipboard(contentToCopy, e.target);
            });
        }
        
        function addModalActionButtons(container, themeId, themeType) {
             container.innerHTML = `
                <button class="btn-primary text-sm new-routine-button">New Routine</button>
                <button class="btn-secondary text-sm modal-refine-button">Refine with AI</button>
                <button class="btn-secondary text-sm copy-button">Copy Text</button>
                <button class="btn-secondary text-sm reading-button" data-theme-id="${themeId}" data-theme-type="${themeType}">Find Reading</button>
                <button class="btn-secondary text-sm music-button" data-theme-id="${themeId}" data-theme-type="${themeType}">Suggest Music</button>
                <button class="btn-secondary text-sm print-button">Print Plan</button>
                <button class="btn-secondary text-sm export-word-button">Export to Word</button>
            `;
             container.querySelector('.copy-button').addEventListener('click', e => {
                 const contentToCopy = document.getElementById('inDepthModalContent');
                 copyElementTextToClipboard(contentToCopy, e.target);
            });
            container.querySelector('.print-button').addEventListener('click', handlePrint);
        }

        async function handleDiscoverMoreClick() {
            const button = document.getElementById('discover-more-button');
            const errorP = document.getElementById('discover-more-error');
            errorP.textContent = '';
            button.disabled = true;

            const existingTitles = Array.from(document.querySelectorAll('#main-grid h2')).map(h2 => h2.textContent);
            const prompt = `Generate 1 new, creative yoga category NOT on this list: ${existingTitles.join(', ')}. Provide a "key" (camelCase, unique), "title", "description", an "initialPrompt" (for 10 items), and a "fullPrompt" (for 40-50). Prompts must request a JSON array of objects, each with id, title, and description. Return ONLY a valid JSON object.`;

            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if (!jsonText) throw new Error("AI did not return a new category.");
                const newCategory = parseJsonWithCorrections(jsonText);
                await generateAndPopulateAICategory(newCategory);
                await generateJumpToButtons();
            } catch (error) {
                console.error("Failed to discover more topics:", error);
                errorP.textContent = "Sorry, couldn't generate a new topic right now.";
            } finally {
                button.disabled = false;
            }
        }
        
        async function handleCustomVisualThemeGeneration() {
            const prompt = document.getElementById('theme-prompt').value;
            if(!prompt) return;

            const loader = document.getElementById('theme-loader-container');
            const errorContainer = document.getElementById('theme-error-container');
            const generateBtn = document.getElementById('generate-theme-btn');
            
            loader.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            generateBtn.disabled = true;

            try {
                const imagePrompt = `Artistic, abstract background image inspired by "${prompt}". Suitable for a yoga website. Serene, calming. Wide aspect ratio, photographic, cinematic lighting.`;
                const [colorResult, imageResult] = await Promise.allSettled([callColorGenAPI(prompt), callImageGenAPI(imagePrompt)]);
                
                if (colorResult.status === 'fulfilled' && colorResult.value) applyTheme(colorResult.value);
                else throw colorResult.reason || new Error("Failed to generate color theme.");

                if (imageResult.status === 'fulfilled' && imageResult.value) applyHeaderImage(imageResult.value);
                else throw imageResult.reason || new Error("Failed to generate header image.");
                
                document.getElementById('themeGeneratorModal').classList.add('hidden');
            } catch (error) {
                showThemeError(error.message);
            } finally {
                loader.classList.add('hidden');
                generateBtn.disabled = false;
            }
        }
        
        function showThemeError(message) {
            const errorContainer = document.getElementById('theme-error-container');
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        async function generateJumpToButtons() {
            const container = document.getElementById('jump-to-nav-container');
            const cards = Array.from(document.querySelectorAll('#custom-plan-card, #main-grid .card'));
            if (cards.length <= 1) {
                container.classList.add('hidden');
                return;
            }

            const cardData = cards.map(card => ({
                id: card.id,
                title: card.querySelector('h2')?.textContent
            })).filter(c => c.id && c.title);
            
            if (cardData.length === 0) {
                container.classList.add('hidden');
                return;
            }
        
            const prompt = `For the following yoga category titles, generate a very short, engaging label (1-2 words). Return a valid JSON object where keys are the original titles and values are the short labels. Titles: ${JSON.stringify(cardData.map(c => c.title))}`;
            
            try {
                const jsonText = await callGeminiAPI(prompt, true);
                const labels = jsonText ? parseJsonWithCorrections(jsonText) : {};
                const buttonsHtml = cardData.map(card => {
                    const label = labels[card.title] || card.title.split(' ')[0];
                    return `<button class="jump-to-button" data-target-id="${card.id}">${label}</button>`;
                }).join('');

                container.innerHTML = `<div class="flex flex-wrap gap-2 justify-center">${buttonsHtml}</div>`;
                container.classList.remove('hidden');
            } catch (error) {
                console.error("AI failed to generate jump-to buttons, using fallback:", error);
                const fallbackButtonsHtml = cardData.map(card => {
                    const label = card.title.split(' ')[0];
                    return `<button class="jump-to-button" data-target-id="${card.id}">${label}</button>`;
                }).join('');
                container.innerHTML = `<div class="flex flex-wrap gap-2 justify-center">${fallbackButtonsHtml}</div>`;
                container.classList.remove('hidden');
            }
        }

        function populateTypographySettings() {
            const fontSelect = document.getElementById('font-family-select');
            const sizeSelect = document.getElementById('font-size-select');
            const lineHeightSelect = document.getElementById('line-height-select');
            
            const fonts = { 'Default (Inter)': "'Inter', sans-serif", 'Lato': "'Lato', sans-serif", 'Montserrat': "'Montserrat', sans-serif", 'Nunito Sans': "'Nunito Sans', sans-serif", 'Open Sans': "'Open Sans', sans-serif", 'Poppins': "'Poppins', sans-serif", 'Roboto Slab': "'Roboto Slab', serif" };
            const sizes = { '14': '14px', '15': '15px', '16 (Default)': '16px', '17': '17px', '18': '18px' };
            const lineHeights = { '1.4': '1.4', '1.5 (Default)': '1.5', '1.6': '1.6', '1.7': '1.7', '1.8': '1.8' };

            Object.entries(fonts).forEach(([name, value]) => fontSelect.add(new Option(name, value)));
            Object.entries(sizes).forEach(([name, value]) => sizeSelect.add(new Option(name, value)));
            Object.entries(lineHeights).forEach(([name, value]) => lineHeightSelect.add(new Option(name, value)));

            fontSelect.value = fonts['Default (Inter)'];
            sizeSelect.value = '16px';
            lineHeightSelect.value = '1.5';
            
            root.style.setProperty('--font-family', fontSelect.value);
            root.style.setProperty('--font-size-base', sizeSelect.value);
            root.style.setProperty('--line-height-base', lineHeightSelect.value);
        }

        function copyElementTextToClipboard(element, button) {
            const textToCopy = element.innerText;
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed'; 
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                const originalText = button.innerHTML;
                button.textContent = 'Copied!';
                setTimeout(() => { button.innerHTML = originalText; }, 2000);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textarea);
        }
        
        function getDraftPrompt(context) {
            let userThemePrompt = `a core focus on **${context.focus}**`;
            if (context.theme) {
                userThemePrompt += ` and inspired by the creative theme of **"${context.theme}"**`;
            }

            return `## AI Persona:
You are Kaia, a Syncretic Movement Guide. Your expertise is in blending traditional yoga with modern movement science.

## Core Task:
Create a high-level DRAFT of a thematic movement practice that is structured as half Yang (active) and half Yin (passive). Your goal is to brainstorm the key poses and concepts for the routine.

## Context:
* **User's Request:** A class with ${userThemePrompt}.
* **User's Focus Areas:** "${context.tailoring || 'None specified'}"

## Output Requirements:
Create a markdown draft. For each of the 9 sections below, list the key poses, movements, or concepts as bullet points. Be concise. This is a brainstorm draft, not the final detailed plan.

### Part 1: The Yang Practice (Active & Warming)
1.  **Thematic Intent & Centering:**
2.  **Yang Breathwork (Pranayama):**
3.  **Dynamic Warm-up & Mobility:**
4.  **Yang Main Sequence (5-6 Flows):**
5.  **Peak Yang Expression:**

### Part 2: The Yin Practice (Passive & Cooling)
6.  **The Transition:**
7.  **Yin Breathwork & Intention:**
8.  **Yin Sequence (5-6 Poses):**
9.  **Savasana & Integration:**`;
        }
        
        function getRevisionPrompt(draft) {
             return `## AI Persona:
You are Kaia, a Syncretic Movement Guide, and you are now acting as a critical editor to polish a draft into a comprehensive teaching guide.

## Core Task:
You will be given a DRAFT of a yoga plan. Your task is to expand this draft into a polished, final, and beautifully written teaching guide. You must flesh out all details, add instructor-specific sections, and ensure it meets all quality guidelines.

## The Draft to Revise:
---
${draft}
---

## Output Requirements for Final Instructor Guide:
You must transform the draft into a complete, detailed markdown plan. Follow the original 9-part structure precisely, but add significant detail.

### Global Requirements (at the top):
1.  **Props Needed:** Start with a bulleted list of all props required for the class.
2.  **Key Contraindications:** Below props, add a section outlining major safety warnings or conditions where poses should be avoided/modified (e.g., pregnancy, high blood pressure, acute injuries).

### Per-Section Requirements:
For each of the 9 sections, you must provide:
1.  **Main Description:** The core narrative explaining the purpose and flow of this section for the student.
2.  **Proposed Exercises:** This section should detail the specific poses or flows. For each exercise listed, add a nested bullet point beginning with the word 'Benefits:' followed by the description.
    * *Example:*
        * Downward-Facing Dog (Adho Mukha Svanasana)
            * Benefits: Stretches the hamstrings, calves, and shoulders; strengthens the arms and legs; improves spinal alignment.
3.  **Instructor Focus:** A paragraph or bullet points explaining the specific anatomical, energetic, or pedagogical goals for the instructor.
4.  **Verbal Cues:** A bulleted list of concise, actionable cues the instructor can say during the class.
5.  **Options & Modifications:** A bulleted list detailing how to make poses easier (regressions) or more challenging (progressions).
    * **Prop Integration:** Within the 'Options & Modifications' list, you **must** list all four props (Blocks, Bolster, Strap, and Blanket) as individual bullet points. For each one, provide a specific use or explicitly state 'Not applicable for this exercise'.
6.  **Thematic Cue:** A short, evocative sentence that weaves the user's original theme into the experience of a key pose in that section. **Format this cue as a markdown blockquote.**

### Formatting Rules:
* Use '###' for the main 9 section titles (e.g., "### Part 1: Thematic Intent & Centering").
* Use '####' for the sub-sections within each part (e.g., "#### Proposed Exercises", "#### Verbal Cues").
* Use '##### ' for individual poses or flows within the 'Yang Main Sequence' and 'Yin Sequence' to create clear visual separation.
* Add estimated timings for each of the 9 major sections.
* For the Yin sequence, you MUST specify a recommended **hold time** for each pose.
* **Do not** wrap entire sections or lists in markdown quotes (\`"\`) or asterisks (\`*\`). The output should be clean markdown only.

Return ONLY the final, polished, and complete markdown teaching guide.`;
        }

        async function generatePlanIteratively(context, loaderMessageElement) {
            // Step 1: Generate the Draft
            if (loaderMessageElement) loaderMessageElement.textContent = 'Drafting initial plan...';
            const draftPrompt = getDraftPrompt(context);
            const draftText = await callGeminiAPI(draftPrompt);
            if (!draftText) throw new Error("The AI failed to generate an initial draft.");

            // Step 2: Revise the Draft into the Final Plan
            if (loaderMessageElement) loaderMessageElement.textContent = 'Polishing final routine...';
            const revisionPrompt = getRevisionPrompt(draftText);
            const finalText = await callGeminiAPI(revisionPrompt);
            if (!finalText) throw new Error("The AI failed to revise the draft into a final plan.");

            return finalText;
        }

        async function handleExploreInDepth(themeId, themeType) {
            let context, themeTitle;
            const modal = document.getElementById('inDepthModal');
            const titleEl = document.getElementById('inDepthModalTitle');
            const contentEl = document.getElementById('inDepthModalContent');
            const footerEl = document.getElementById('inDepthModalFooter');
            
            const loaderMessageElement = getLoaderHTML(`Drafting full plan...`, true);
            contentEl.innerHTML = '';
            contentEl.appendChild(loaderMessageElement);
            
            footerEl.innerHTML = '';
            footerEl.dataset.themeId = themeId;
            footerEl.dataset.themeType = themeType;
            modal.classList.remove('hidden');

            const selectedTailoringOptions = Array.from(document.querySelectorAll('#tailoring-buttons-container .btn-toggle.active'))
                                         .map(btn => btn.textContent.trim())
                                         .join(', ');

            if (themeType === 'custom') {
                const focus = document.getElementById('gemini-focus').value.trim();
                const theme = document.getElementById('gemini-theme').value.trim();
                themeTitle = focus + (theme ? `: ${theme}` : '');
                context = { focus, theme, tailoring: selectedTailoringOptions };
            } else {
                const item = allThemeData[themeType]?.find(d => String(d.id) === String(themeId));
                if (!item) return;
                themeTitle = item.title;
                context = { focus: item.title, theme: item.description, tailoring: selectedTailoringOptions };
            }

            originalPlanContext[themeId] = context; // Save context for refinement
            titleEl.textContent = `In-Depth: ${themeTitle}`;
            
            try {
                const resultText = await generatePlanIteratively(context, loaderMessageElement.querySelector('p'));

                originalGeneratedText.set(themeId + '-full', resultText); 
                renderAccordionFromMarkdown(resultText, contentEl);
                addModalActionButtons(footerEl, themeId, themeType);
            } catch (error) {
                handleApiError(error, contentEl, 'in-depth content');
            }
        }
        
        function toggleRefineUI(buttonContainer, isModal = false) {
            let existingRefineContainer = buttonContainer.parentElement.querySelector('.refine-container');
            if (existingRefineContainer) {
                existingRefineContainer.remove();
                return;
            }

            const themeId = isModal 
                ? document.getElementById('inDepthModalFooter').dataset.themeId
                : buttonContainer.closest('.card-content').querySelector('.explore-button')?.dataset.themeId || 'custom-plan';
            
            const context = originalPlanContext[themeId];
            if (!context) {
                showNotification("Could not find original plan details. Please generate the detailed plan first.", true);
                return;
            }
            
            const refineContainer = document.createElement('div');
            refineContainer.className = 'refine-container w-full';
            refineContainer.innerHTML = `
                <h3 class="text-lg font-bold themed-text-accent mb-4">Refine and Regenerate Plan</h3>
                <div class="space-y-4">
                    <div>
                        <label for="refine-focus-${themeId}" class="block text-sm font-medium themed-text-muted mb-1">Core Focus</label>
                        <input type="text" id="refine-focus-${themeId}" class="w-full p-3 themed-input border rounded-lg focus:ring-2" value="${context.focus || ''}">
                    </div>
                    <div>
                        <label for="refine-theme-${themeId}" class="block text-sm font-medium themed-text-muted mb-1">Creative Theme</label>
                        <input type="text" id="refine-theme-${themeId}" class="w-full p-3 themed-input border rounded-lg focus:ring-2" value="${context.theme || ''}">
                    </div>
                    <div id="refine-tailor-accordion-${themeId}" class="border rounded-lg" style="border-color: var(--color-card-border);">
                        <div class="accordion-item">
                            <button type="button" class="accordion-header active">
                                <span>Tailoring Options:</span>
                                <svg class="icon w-5 h-5 transition-transform" style="transform: rotate(180deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div class="accordion-content open">
                                <div id="refine-tailoring-container-${themeId}" class="refine-tailoring-container flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>
                    <button class="btn-primary text-sm mt-2 submit-refinement-button" data-is-modal="${isModal}" data-theme-id="${themeId}">Regenerate Plan</button>
                </div>
            `;
            
            const robustButtonContainer = isModal ? buttonContainer : buttonContainer.closest('.button-bar');
            robustButtonContainer.insertAdjacentElement('afterend', refineContainer);

            const allOptions = Array.from(document.querySelectorAll('#tailoring-buttons-container .btn-toggle')).map(b => b.textContent.trim());
            const selectedOptions = context.tailoring ? context.tailoring.split(', ') : [];
            populateTailoringButtons(allOptions.slice(4), `refine-tailoring-container-${themeId}`, selectedOptions);
        }

        async function handleRefineRequest(refineButton) {
            const { isModal, themeId } = refineButton.dataset;
            const refineContainer = refineButton.closest('.refine-container');

            const newFocus = refineContainer.querySelector(`#refine-focus-${themeId}`).value.trim();
            const newTheme = refineContainer.querySelector(`#refine-theme-${themeId}`).value.trim();
            const newTailoring = Array.from(refineContainer.querySelectorAll(`#refine-tailoring-container-${themeId} .btn-toggle.active`))
                                      .map(btn => btn.textContent.trim())
                                      .join(', ');
            
            if (!newFocus) {
                showNotification("Core Focus cannot be empty.", true);
                return;
            }

            const contentArea = isModal === 'true'
                ? document.getElementById('inDepthModalContent') 
                : refineContainer.closest('.card-content').querySelector('.details-container, #gemini-result-container');
            
            const footerEl = document.getElementById('inDepthModalFooter');
            
            if (!contentArea) {
                console.error("Could not find content area for refinement.");
                return;
            }
            
            const loaderMessageElement = getLoaderHTML('Regenerating plan based on your new request...', true);
            contentArea.innerHTML = '';
            contentArea.appendChild(loaderMessageElement);
            refineContainer.remove(); // Remove the refine UI immediately

            const newContext = { focus: newFocus, theme: newTheme, tailoring: newTailoring };
            originalPlanContext[themeId] = newContext; // Update the stored context
            
            try {
                const newText = await generatePlanIteratively(newContext, loaderMessageElement.querySelector('p'));
                if (!newText || newText.trim() === '') {
                    handleApiError({ message: "The AI returned an empty response. Please try refining with a different request." }, contentArea, 'refinement');
                    return;
                }

                const textKey = themeId + '-full';
                originalGeneratedText.set(textKey, newText);
                
                if (isModal === 'true') {
                    renderAccordionFromMarkdown(newText, contentArea);
                    addModalActionButtons(footerEl, themeId, footerEl.dataset.themeType);
                } else {
                    // This case is less likely with the new UI but kept for robustness
                    contentArea.innerHTML = convertMarkdownToHtml(newText);
                    addPostGenerationButtons(contentArea, themeId, 'custom');
                }

            } catch(error) {
                handleApiError(error, contentArea, 'refinement');
            }
        }

        function handleFindReadingClick(button) {
            const modal = document.getElementById('readingModal');
            const titleEl = document.getElementById('readingModalTitle');
            const resultContainer = document.getElementById('reading-result-container');
            const authorsInput = document.getElementById('reading-authors');

            const { themeId } = button.dataset;
            const textKey = themeId + '-full';
            const planText = originalGeneratedText.get(textKey);
            const context = originalPlanContext[themeId];
            
            if (!planText || !context) {
                showNotification('Could not find the plan text to generate a reading. Please explore the plan first.', true);
                return;
            }
            const themeTitle = context.focus + (context.theme ? `: ${context.theme}` : '');

            titleEl.textContent = `Reading for "${themeTitle}"`;
            
            modal.dataset.planText = planText;
            modal.dataset.themeTitle = themeTitle;

            authorsInput.value = '';
            resultContainer.innerHTML = '<p class="themed-text-muted">Enter preferred authors above, or leave blank for a general suggestion, then click "Generate Reading".</p>';
            
            modal.classList.remove('hidden');
        }

        async function handleGenerateReadingRequest(button) {
            const modal = document.getElementById('readingModal');
            const resultContainer = document.getElementById('reading-result-container');
            const authorsInput = document.getElementById('reading-authors');
            
            const planText = modal.dataset.planText;
            const themeTitle = modal.dataset.themeTitle;
            const authors = authorsInput.value.trim();

            if (!planText || !themeTitle) {
                showNotification('Error: Could not find plan context.', true);
                return;
            }

            resultContainer.innerHTML = getLoaderHTML('Searching for inspiration...');
            button.disabled = true;

            try {
                const readingData = await getThematicReading(themeTitle, planText, authors);
                renderReading(readingData);
            } catch (error) {
                handleApiError(error, resultContainer, 'thematic reading');
            } finally {
                button.disabled = false;
            }
        }

        async function getThematicReading(theme, planText, authors = '') {
            let authorInstruction = '';
            if (authors) {
                authorInstruction = `**Crucially, you MUST prioritize finding a relevant reading from one of these preferred authors: ${authors}.** If, and only if, you cannot find a suitable piece from them, you may then broaden your search to other sources or generate an affirmation as a last resort. When you use a preferred author, mention it in your analysis.`;
            }

            const prompt = `
            You are an expert literary and spiritual research assistant for a yoga instructor.
            Your task is to find or create a thematic reading (a poem, short story excerpt, or affirmation) that is deeply resonant with a specific yoga class.

            **Your process must be:**
            1.  **Analyze the Full Context:** You will be given both a high-level theme and the full, detailed yoga plan. Analyze the entire plan—including the sequence, poses, and instructor cues—to understand its narrative arc, emotional tone, and physical focus.
            2.  **Deconstruct Core Concepts:** From your analysis, identify the core concepts. For example, a plan focused on warrior poses and hip openers might have concepts of "courage," "stability," "release," "grounding," and "emotional freedom."
            3.  **Smart Search (Internal Knowledge First):** Use your vast internal knowledge of literature, poetry, and spiritual texts to find a suitable reading. ${authorInstruction}
            4.  **Final Fallback - Generate:** If you cannot find a suitable existing text, you MUST generate a new, original, short affirmation that captures the essence of the plan's core concepts.
            5.  **Format Output:** Return a single, valid JSON object with the following structure:
                {
                  "type": "Poem" | "Affirmation" | "Story" | "Generated Affirmation",
                  "title": "Title of the work (if applicable)",
                  "author": "Author's name (or 'Original' if generated)",
                  "text": "The full text of the reading, using \\n for newlines.",
                  "source": "The source URL or publication. If generated, state 'AI-generated based on the class theme.'",
                  "analysis": "A brief explanation of why this reading is a good fit for the yoga class theme, connecting the reading's message directly to the specific elements of the provided yoga plan."
                }
            
            ## Yoga Class Context
            **Theme:** "${theme}"

            **Full Plan:**
            ---
            ${planText}
            ---
            `;

            const jsonText = await callGeminiAPI(prompt, true);
            if (!jsonText) throw new Error("The AI failed to find or generate a thematic reading.");
            return parseJsonWithCorrections(jsonText);
        }

        function renderReading(data) {
            const contentEl = document.getElementById('reading-result-container');

            if (data.type === 'None' || !data.text) {
                contentEl.innerHTML = `<p class="themed-text-muted">Sorry, I couldn't find a suitable reading for this theme at the moment. You could try refining the plan with a slightly different theme.</p>`;
                return;
            }

            const formattedText = data.text.replace(/\n/g, '<br>');

            contentEl.innerHTML = `
                <div class="p-4 rounded-lg" style="background-color: rgba(0,0,0,0.02);">
                    <h3 class="text-xl font-bold themed-text-accent">${data.title || data.type}</h3>
                    ${data.author ? `<p class="themed-text-muted text-sm mb-4">by ${data.author}</p>` : ''}
                    <blockquote class="border-l-4 pl-4 italic" style="border-color: var(--color-primary);">
                        <p>${formattedText}</p>
                    </blockquote>
                </div>
                <div class="mt-6">
                    <h4 class="font-bold themed-text-primary">AI Analysis</h4>
                    <p class="themed-text-muted">${data.analysis}</p>
                    <p class="text-xs mt-4 themed-text-muted"><strong>Source:</strong> ${data.source || 'Not specified'}</p>
                </div>
            `;
        }
        
        function handleSuggestMusicClick(button) {
            const { themeId } = button.dataset;
            const textKey = themeId + '-full';
            const planText = originalGeneratedText.get(textKey);
            const context = originalPlanContext[themeId];
             
            if (!planText || !context) {
                showNotification('Could not find the plan text to suggest music. Please generate the detailed plan first.', true);
                return;
            }
            const themeTitle = context.focus + (context.theme ? `: ${context.theme}` : '');

            const modal = document.getElementById('musicModal');
            const titleEl = document.getElementById('musicModalTitle');
            const genreContainer = document.getElementById('genre-buttons-container');
            const resultsContainer = document.getElementById('music-results-container');
            
            titleEl.textContent = `Music for "${themeTitle}"`;
            modal.dataset.planText = planText; // Store the plan text on the modal
            resultsContainer.innerHTML = '';
            document.getElementById('music-selection-container').style.display = 'block';


            const genres = ['Ambient & Drone', 'Lofi & Chillhop', 'Jazz', 'Dance', 'Electronic', '60s Hits', '70s Classics', '80s Pop & Rock', '90s Alternative & Pop', 'Award-Winning Songs', 'Traditional Indian & Chants', 'Modern Classical & Piano', 'Nature Sounds & Soundscapes', 'World Fusion & Medicine Music', 'Acoustic & Folk', 'Ethereal Vocals'];
            genreContainer.innerHTML = genres.map(genre => 
                `<button type="button" class="btn-toggle text-sm px-3 py-1 rounded-full">${genre}</button>`
            ).join('');

            modal.classList.remove('hidden');
        }
        
        async function handleGeneratePlaylist() {
            const modal = document.getElementById('musicModal');
            const planText = modal.dataset.planText;
            const resultsContainer = document.getElementById('music-results-container');
            
            const selectedGenres = Array.from(document.querySelectorAll('#genre-buttons-container .btn-toggle.active'))
                                      .map(btn => btn.textContent.trim());

            if (selectedGenres.length === 0) {
                showNotification('Please select at least one genre.', true);
                return;
            }
            
            document.getElementById('music-selection-container').style.display = 'none';
            resultsContainer.innerHTML = getLoaderHTML('Curating your playlist...');

            try {
                const playlistData = await getMusicSuggestions(planText, selectedGenres);
                renderMusicSuggestions(playlistData);
            } catch (error) {
                handleApiError(error, resultsContainer, 'music playlist');
                document.getElementById('music-selection-container').style.display = 'block';
            }
        }
        
        async function getMusicSuggestions(planText, genres) {
            const prompt = `
            You are an expert music curator and DJ for yoga and wellness experiences.
            Your task is to create a thematic playlist for a specific, detailed yoga class plan.

            **Your process must be:**
            1.  **Deeply Analyze the Plan:** Read the entire yoga plan provided below. Pay close attention to the structure (e.g., Warm-up, Yang Sequence, Yin Sequence, Savasana), the described energy levels, the emotional tone, and specific thematic cues.
            2.  **Filter by Genre:** Consider the user's preferred genres as your primary palette.
            3.  **Map Tracks to Flow:** Assign specific songs to the different sections of the yoga class. The music should match the intended energy of each part of the routine. For example, use more energetic music for the Yang section and calming, ambient music for the Yin and Savasana sections.
            4.  **Format Output:** Return a single, valid JSON object. The top-level keys should be the main sections of the yoga plan (e.g., "Yang Main Sequence"). The value for each key should be an array of track objects. Each track object must contain:
                * "artist": The name of the artist.
                * "song": The title of the song.
                * "spotify_search_url": A formatted URL to search for the track on Spotify, like 'https://open.spotify.com/search/Artist%20Name%20Song%20Title'.

            ## Yoga Class Context
            **Preferred Genres:** ${genres.join(', ')}

            **Full Plan:**
            ---
            ${planText}
            ---
            `;
            const jsonText = await callGeminiAPI(prompt, true);
            if (!jsonText) throw new Error("The AI failed to generate a music playlist.");
            return parseJsonWithCorrections(jsonText);
        }

        function renderMusicSuggestions(data) {
            const resultsContainer = document.getElementById('music-results-container');
            resultsContainer.innerHTML = ''; // Clear previous results
            
            let html = '';
            const hasTracks = Object.values(data).some(section => Array.isArray(section) && section.length > 0);

            if (hasTracks) {
                const exportButton = document.createElement('button');
                exportButton.id = 'export-playlist-btn';
                exportButton.className = 'btn-secondary mb-4';
                exportButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path></svg>
                    <span>Export Links</span>`;
                
                exportButton.addEventListener('click', (e) => {
                    const links = Array.from(resultsContainer.querySelectorAll('a'))
                                     .map(a => a.href)
                                     .join('\n');
                    
                    const textarea = document.createElement('textarea');
                    textarea.value = links;
                    textarea.style.position = 'fixed'; 
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        const originalText = e.currentTarget.querySelector('span').textContent;
                        e.currentTarget.querySelector('span').textContent = 'Copied!';
                        setTimeout(() => { e.currentTarget.querySelector('span').textContent = originalText; }, 2000);
                    } catch (err) {
                        console.error('Fallback: Oops, unable to copy', err);
                        showNotification('Could not copy links to clipboard.', true);
                    }
                    document.body.removeChild(textarea);
                });
                resultsContainer.appendChild(exportButton);
            }

            for (const section in data) {
                if (data.hasOwnProperty(section) && Array.isArray(data[section]) && data[section].length > 0) {
                    html += `<h3>${section}</h3><ul>`;
                    data[section].forEach(track => {
                        html += `
                            <li class="flex justify-between items-center py-2">
                                <div>
                                    <strong class="block">${track.song}</strong>
                                    <span class="text-sm themed-text-muted">${track.artist}</span>
                                </div>
                                <a href="${track.spotify_search_url}" target="_blank" class="btn-secondary text-sm !no-underline" title="Search on Spotify">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                                    <span>Find</span>
                                </a>
                            </li>`;
                    });
                    html += `</ul>`;
                }
            }

            if(html === '') {
                resultsContainer.innerHTML = `<p class="themed-text-muted">Could not generate a playlist for this plan. You can close this window and try again.</p>`;
            } else {
                const listContainer = document.createElement('div');
                listContainer.innerHTML = html;
                resultsContainer.appendChild(listContainer);
            }
        }
        
        async function handleNewRoutineRequest(button) {
            const modal = document.getElementById('inDepthModal');
            const contentEl = document.getElementById('inDepthModalContent');
            const footerEl = document.getElementById('inDepthModalFooter');
            
            const themeId = footerEl.dataset.themeId;
            const context = originalPlanContext[themeId];

            if (!context) {
                showNotification('Could not determine the theme to generate a new routine.', true);
                return;
            }
            const themeTitle = context.focus + (context.theme ? `: ${context.theme}` : '');

            const newContext = { ...context, tailoring: "A completely new interpretation." };
            const loaderMessageElement = getLoaderHTML(`Generating a completely new routine for "${themeTitle}"...`, true);
            contentEl.innerHTML = '';
            contentEl.appendChild(loaderMessageElement);
            button.disabled = true;

            try {
                const resultText = await generatePlanIteratively(newContext, loaderMessageElement.querySelector('p'));
                originalGeneratedText.set(themeId + '-full', resultText);
                renderAccordionFromMarkdown(resultText, contentEl);
            } catch (error) {
                handleApiError(error, contentEl, 'new routine generation');
            } finally {
                button.disabled = false;
            }
        }

        function getIconForTheme() {
            // Removed dynamic SVG generation in favor of a reliable fallback to prevent console errors.
            return `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2.143 2.143 0 0 1-3.214-3.214 2.143 2.143 0 0 1 3.214 3.214zm-11.64 0a2.143 2.143 0 0 1-3.214-3.214 2.143 2.143 0 0 1 3.214 3.214zM12 12a2.143 2.143 0 1 1 0-4.286 2.143 2.143 0 0 1 0 4.286z"></path></svg>`;
        }
        
        function getLoaderHTML(message, asElement = false) {
            const html = `<div class="flex justify-center items-center my-4"><div class="loader themed-loader"></div><p class="ml-4 themed-text-muted">${message}</p></div>`;
            if (asElement) {
                const div = document.createElement('div');
                div.innerHTML = html;
                return div.firstElementChild;
            }
            return html;
        }
        
        function generateErrorMessage(error, type = 'general') {
            console.error(`Error during ${type} generation:`, error);
            let message = `An unknown error occurred. ${(error && error.message) ? error.message : 'No additional details available.'}`;
            const errText = (error && error.message) ? error.message.toLowerCase() : '';

            if (errText.includes('safety') || errText.includes('blocked')) {
                message = `Request blocked for safety reasons. Please try a different prompt.`;
            } else if (errText.includes('api key not valid')) {
                message = `Authentication failed. Your API Key is not valid.`;
            } else if (errText.includes('429')) {
                message = `Request limit exceeded. Please try again later.`;
            } else if (errText.includes('timed out')) {
                message = `The request timed out. Please check your connection and try again.`;
            }
            return `Sorry, a critical error occurred: ${message}`;
        }

        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white z-50 transition-all duration-300 opacity-0 transform -translate-y-5';
            if(isError) {
                notification.classList.add('bg-red-500');
            } else {
                notification.style.background = `linear-gradient(to right, var(--color-primary), var(--color-primary-dark))`;
            }
            notification.textContent = message;
            document.body.appendChild(notification);
            
            requestAnimationFrame(() => {
                notification.classList.remove('opacity-0', '-translate-y-5');
            });

            setTimeout(() => {
                notification.classList.add('opacity-0');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function handlePrint() {
            const printContent = document.getElementById('inDepthModalContent').cloneNode(true);
            const printFrame = document.createElement('iframe');
            printFrame.style.position = 'absolute';
            printFrame.style.width = '0';
            printFrame.style.height = '0';
            printFrame.style.border = '0';
            document.body.appendChild(printFrame);

            const doc = printFrame.contentWindow.document;
            doc.open();
            doc.write(`
                <html>
                <head>
                    <title>Print Plan</title>
                    <style>
                        :root {
                            --color-bg: #ffffff;
                            --color-text: #000000;
                            --color-text-muted: #333333;
                            --color-primary: #581c87;
                            --color-primary-dark: #581c87;
                            --color-accent: #9333ea;
                        }
                        body { 
                            font-family: 'Inter', sans-serif;
                            color: var(--color-text);
                        }
                        .prose { font-size: 12pt; line-height: 1.4; }
                        .prose p { margin-bottom: 0.75rem; }
                        .prose ul, .prose ol { margin-bottom: 0.75rem; padding-left: 1.5rem; }
                        .prose h1, .prose h2, .prose h3, .prose h4 {
                             color: var(--color-accent);
                             margin-top: 1.25em;
                             margin-bottom: 0.5em;
                             page-break-after: avoid;
                        }
                        .accordion-header {
                            font-weight: bold;
                            font-size: 1.25rem;
                            padding: 1rem 0;
                            border-bottom: 1px solid #ccc;
                        }
                        .accordion-header .icon { display: none; }
                        .accordion-content { display: block !important; padding-top: 0.5rem; }
                        button { display: none; }
                        @media print {
                           .accordion-item { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <h1 style="font-size: 1.5rem; color: var(--color-primary);">${document.getElementById('inDepthModalTitle').textContent}</h1>
                    ${printContent.innerHTML}
                </body>
                </html>
            `);
            doc.close();

            const contentSections = doc.querySelectorAll('.accordion-content');
            contentSections.forEach(section => {
                section.classList.add('open');
            });

            setTimeout(() => {
                printFrame.contentWindow.focus();
                printFrame.contentWindow.print();
                document.body.removeChild(printFrame);
            }, 250);
        }
        
        function handleExportToWord() {
            const title = document.getElementById('inDepthModalTitle').textContent;
            const contentContainer = document.getElementById('inDepthModalContent').cloneNode(true);

            // Create a temporary div to parse the content and extract headers
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = contentContainer.innerHTML;

            // Make accordion headers visible and style them
            const headers = tempDiv.querySelectorAll('.accordion-header');
            headers.forEach(header => {
                const titleSpan = header.querySelector('span');
                if (titleSpan) {
                    const h3 = document.createElement('h3');
                    h3.innerHTML = titleSpan.innerHTML;
                    header.parentNode.insertBefore(h3, header);
                }
            });
            
            const contentHtml = tempDiv.innerHTML;
            
            const sourceHtml = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset='utf-8'>
                    <title>${title}</title>
                    <style>
                        /* Word-specific styles */
                        body { font-family: Calibri, sans-serif; font-size: 11pt; }
                        h1, h2, h3, h4, h5, h6 { font-family: 'Calibri Light', sans-serif; color: #2F5496; margin-bottom: 0; }
                        h1 { font-size: 20pt; }
                        h2 { font-size: 16pt; }
                        h3 { font-size: 14pt; color: #365F91; font-weight: bold; margin-top: 20px; }
                        h4 { font-size: 12pt; color: #4981B3; font-style: italic; }
                        p { margin-top: 0; }
                        ul { margin-top: 0; }
                        .accordion-header { display: none; }
                        .accordion-header .icon { display: none; }
                        .accordion-content { display: block !important; padding-left: 0; }
                        .accordion-item { page-break-inside: avoid; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    ${contentHtml}
                </body>
                </html>
            `;

            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHtml);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            
            // Sanitize title for filename
            const cleanTitle = title.replace("In-Depth: ", "").replace(/[^a-z0-9]/gi, '_').toLowerCase();
            fileDownload.download = `${cleanTitle || 'yoga_plan'}.doc`;
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }

        let tourSteps = [];
        let currentTourStep = 0;

        function setupTour() {
            tourSteps = [
                { title: 'Welcome!', content: 'This quick tour will show you the main features on this page. You can exit at any time.' },
                { element: '#app-header', title: 'The Header', content: 'The header image and the app\'s color scheme are generated by AI. You can create your own version using the floating action button.' },
                { element: '#custom-plan-card', title: 'Custom Plan Generator', content: 'This is the heart of the app. Start by typing a focus and an optional theme to create a unique yoga plan.' },
                { element: '#tailor-accordion', title: 'Tailor Your Plan', content: 'Click here to reveal dozens of options to fine-tune your request, such as adding a focus on "Balance" or "Deep Relaxation".' },
                { element: '#main-grid', title: 'Pre-Built Categories', content: 'If you need inspiration, scroll down to discover many AI-generated categories, from yoga styles to seasonal themes. Click any item to generate a plan.' },
                { element: '#discover-more-button', title: 'Discover More', content: 'Not seeing a category you like? Click this button to have the AI generate a brand new, random category of yoga themes for you to explore.' },
                { element: '#new-plan-button', title: 'Reset View', content: 'This button will clear your custom-generated plan and reset all category selections, giving you a fresh start without reloading the page.' },
                { title: 'You\'re All Set!', content: 'That\'s it for the main features. The other floating buttons open modals to change the visual theme and adjust typography. Enjoy exploring!' }
            ];

            document.getElementById('tour-next-btn').addEventListener('click', () => showTourStep(currentTourStep + 1));
            document.getElementById('tour-back-btn').addEventListener('click', () => showTourStep(currentTourStep - 1));
            document.getElementById('tour-finish-btn').addEventListener('click', endTour);
            document.getElementById('tour-skip-btn').addEventListener('click', endTour);
            document.getElementById('tour-overlay').addEventListener('click', endTour);
        }
        
        function resetAppView() {
            document.getElementById('gemini-result-container').innerHTML = '';
            document.getElementById('gemini-focus').value = '';
            document.getElementById('gemini-theme').value = '';
            document.querySelectorAll('#tailoring-buttons-container .btn-toggle.active').forEach(btn => btn.classList.remove('active'));

            document.querySelectorAll('.details-container').forEach(container => container.innerHTML = '');
            document.querySelectorAll('.grid-card-selector.active').forEach(card => card.classList.remove('active'));
            
            document.getElementById('custom-plan-card').scrollIntoView({ behavior: 'smooth', block: 'start'});
            showNotification('View has been reset.', false);
        }

        function startTour() {
            document.getElementById('tour-overlay').classList.add('visible');
            document.getElementById('tour-popover').classList.add('visible');
            showTourStep(0);
        }

        function endTour() {
            document.getElementById('tour-overlay').classList.remove('visible');
            document.getElementById('tour-popover').classList.remove('visible');
            const highlighted = document.querySelector('.tour-highlight');
            if (highlighted) {
                highlighted.classList.remove('tour-highlight');
            }
            localStorage.setItem('yogaTourCompleted', 'true');
        }
        
        function showTourStep(stepIndex) {
            currentTourStep = stepIndex;

            const previousHighlight = document.querySelector('.tour-highlight');
            if (previousHighlight) previousHighlight.classList.remove('tour-highlight');
            
            const step = tourSteps[stepIndex];
            if (!step) {
                endTour();
                return;
            }

            const popover = document.getElementById('tour-popover');
            document.getElementById('tour-title').textContent = step.title;
            document.getElementById('tour-content').textContent = step.content;

            const nextBtn = document.getElementById('tour-next-btn');
            const backBtn = document.getElementById('tour-back-btn');
            const finishBtn = document.getElementById('tour-finish-btn');
            
            backBtn.classList.toggle('hidden', stepIndex === 0);
            nextBtn.classList.toggle('hidden', stepIndex === tourSteps.length - 1);
            finishBtn.classList.toggle('hidden', stepIndex !== tourSteps.length - 1);
            
            const dotsContainer = document.getElementById('tour-dots');
            dotsContainer.innerHTML = tourSteps.map((_, i) => `<div class="tour-popover-dot ${i === stepIndex ? 'active' : ''}"></div>`).join('');

            const targetElement = step.element ? document.querySelector(step.element) : null;
            if (targetElement) {
                targetElement.classList.add('tour-highlight');
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });

                setTimeout(() => {
                    positionPopover(targetElement, popover);
                }, 350); 

            } else {
                popover.style.top = '50%';
                popover.style.left = '50%';
                popover.style.transform = 'translate(-50%, -50%)';
            }
        }

        function positionPopover(target, popover) {
            const rect = target.getBoundingClientRect();
            const popoverRect = popover.getBoundingClientRect();
            
            let top = rect.bottom + 15;
            let left = rect.left + (rect.width / 2) - (popoverRect.width / 2);

            if (top + popoverRect.height > window.innerHeight) {
                top = rect.top - popoverRect.height - 15;
            }
            if (left < 10) left = 10;
            if (left + popoverRect.width > window.innerWidth - 10) {
                left = window.innerWidth - popoverRect.width - 10;
            }
            if (top < 10) top = 10;

            popover.style.top = `${top}px`;
            popover.style.left = `${left}px`;
            popover.style.transform = ''; 
        }

    </script>
</body>
</html>
