<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Yoga Class & Theme Generator v16.18</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter, Lato, Roboto Slab, Open Sans, Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* * ==============================================
         * CSS Custom Properties for Theming & Typography
         * ==============================================
        */
        :root {
            /* Fallback theme in case the generative theme fails */
            --color-bg: #f3e8ff;
            --color-text: #374151;
            --color-text-muted: #6b7280;
            --color-primary: #9333ea;
            --color-primary-dark: #7e22ce;
            --color-accent: #581c87;
            --color-card-bg: rgba(255, 255, 255, 0.9);
            --color-card-border: #e9d5ff;
            --color-input-bg: #f9fafb;
            --color-input-border: #d1d5db;
            --color-button-text: #ffffff;
            /* Typography Settings */
            --font-family: 'Open Sans', sans-serif;
            --font-size-base: 16px;
            --line-height-base: 1.5;
        }

        /* Applying the theme variables */
        body {
            font-family: var(--font-family);
            background-color: var(--color-bg);
            color: var(--color-text);
            font-size: var(--font-size-base);
            line-height: var(--line-height-base);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        .prose {
             font-size: inherit;
             line-height: inherit;
        }
        .prose p { margin-bottom: 1em; }
        .prose ul { margin-left: 1.5em; list-style-type: disc; }
        .prose strong:only-child {
            display: block;
            margin-top: 1.25em;
            margin-bottom: 0.75em;
        }
        .card {
            background-color: var(--color-card-bg);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, background-color 0.5s ease, border-color 0.5s ease;
            border: 1px solid var(--color-card-border);
            display: flex;
            flex-direction: column;
        }
        .card:hover {
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Add subtle lift effect */
        }
        .card-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .btn-primary {
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text);
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 7px 10px rgba(0, 0, 0, 0.15);
            filter: brightness(1.1);
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: var(--color-input-bg);
            color: var(--color-text-muted);
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid var(--color-input-border);
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-secondary:hover {
            background-color: #e5e7eb; /* gray-200 */
            color: var(--color-accent);
        }
        
        .btn-toggle {
            background-color: var(--color-input-bg);
            color: var(--color-text-muted);
            border: 1px solid var(--color-input-border);
            transition: all 0.2s ease;
        }
        .btn-toggle.active {
            background-color: var(--color-accent);
            color: var(--color-button-text);
            border-color: var(--color-primary-dark);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .floating-action-button {
            position: fixed;
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 40;
        }
        .floating-action-button:hover {
            transform: translateY(-3px) scale(1.05);
        }
        #new-plan-button { bottom: 2rem; right: 2rem; }
        #settings-button { bottom: 6.5rem; right: 2rem; }
        #ai-help-button { bottom: 11rem; right: 2rem; }
        #theme-changer-button { bottom: 15.5rem; right: 2rem; }
        
        #settings-panel {
            position: fixed;
            bottom: 11rem; 
            right: 2rem;
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-card-border);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 1rem;
            width: 280px;
            z-index: 40;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform-origin: bottom right;
        }

        .themed-text-primary { color: var(--color-primary); }
        .themed-text-accent { color: var(--color-accent); }
        .themed-text-muted { color: var(--color-text-muted); }
        .themed-input {
            background-color: var(--color-input-bg);
            border-color: var(--color-input-border);
            color: var(--color-text);
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        .themed-input::placeholder { color: var(--color-text-muted); opacity: 0.7; }
        .themed-input:focus { --tw-ring-color: var(--color-primary); }

        .loader { border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .themed-loader {
            border: 4px solid var(--color-card-border);
            border-top: 4px solid var(--color-primary);
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header-bg-image { 
            background-image: url('https://i.ibb.co/gFXPP4Gt/Image-fx-88.png'); 
            background-size: cover; 
            background-position: center;
            opacity: 1;
            transition: opacity 1.5s ease-in-out;
        }
        .header-loader-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: white; }

        .accordion-item { border-bottom: 1px solid var(--color-card-border); }
        .accordion-header {
            width: 100%; text-align: left; padding: 1rem; display: flex;
            justify-content: space-between; align-items: center; font-weight: 600;
            color: var(--color-text); background-color: transparent; border: none; cursor: pointer;
            transition: background-color 0.2s;
        }
        .accordion-header:hover { background-color: rgba(0,0,0,0.03); }
        .accordion-content { padding: 1rem; display: none; }
        .accordion-content.open { display: block; }
        .accordion-header .icon { transition: transform 0.3s ease; }
        .accordion-header.active .icon { transform: rotate(180deg); }

        .refine-container {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--color-card-border);
        }
        
        .card-grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding: 0.5rem;
            border-radius: 8px;
            background: rgba(0,0,0,0.02);
        }
        .grid-card-selector {
            background-color: white; border: 1px solid var(--color-card-border);
            border-radius: 8px; padding: 1rem; text-align: center;
            cursor: pointer; transition: all 0.2s ease;
            font-size: 0.875rem; font-weight: 500;
        }
        .grid-card-selector:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .grid-card-selector.active {
            background-color: var(--color-accent); color: var(--color-button-text);
            border-color: var(--color-primary-dark);
        }
        .grid-card-selector .icon { margin-bottom: 0.5rem; }
        .grid-card-selector svg { width: 2.5rem; height: 2.5rem; margin: 0 auto; display: block; }
        .grid-card-selector.active small {
            color: rgba(255, 255, 255, 0.8);
        }

        .holiday-subheading {
            grid-column: 1 / -1;
            color: var(--color-accent);
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 2px solid var(--color-card-border);
        }

        /* --- Onboarding Tutorial Styles --- */
        #onboarding-modal {
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-card-border);
            z-index: 1060;
        }
        .onboarding-backdrop {
            z-index: 1050;
        }
        .onboarding-step {
            z-index: 1060;
        }
        .highlight-element {
            box-shadow: 0 0 0 4px var(--color-primary), 0 0 0 9999px rgba(0,0,0,0.5);
            border-radius: 8px;
            transition: box-shadow 0.3s ease;
            position: relative;
            z-index: 1051;
        }

    </style>
</head>
<body class="p-4 md:p-8">
    
    <!-- Onboarding Tutorial -->
    <div id="onboarding-backdrop" class="fixed inset-0 hidden onboarding-backdrop"></div>
    <div id="onboarding-modal" class="fixed hidden bg-white p-6 rounded-lg shadow-xl max-w-sm onboarding-step">
        <div class="flex justify-between items-center mb-3">
            <h3 id="onboarding-title" class="text-xl font-bold themed-text-primary"></h3>
            <button id="onboarding-close-x" class="text-gray-500 hover:text-gray-800 text-3xl leading-none" title="Close Tutorial">&times;</button>
        </div>
        <p id="onboarding-text" class="themed-text-muted mb-4"></p>
        <div class="flex justify-between items-center">
            <div id="onboarding-progress" class="text-sm themed-text-muted"></div>
            <div>
                <button id="onboarding-skip" class="btn-secondary text-sm">Skip</button>
                <button id="onboarding-prev" class="btn-secondary text-sm" title="Previous Step">Prev</button>
                <button id="onboarding-next" class="btn-primary text-sm" title="Next Step">Next</button>
                <button id="onboarding-done" class="btn-primary text-sm hidden" title="Finish Tutorial">Done</button>
            </div>
        </div>
    </div>


    <!-- All Modals -->
     <div id="apiKeyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Enter Your API Key</h2>
            <p class="mb-6 text-gray-600">To use the AI generators, please provide your API key. This key is used for both Gemini (text) and Imagen (image) generation and is only stored for your current session.</p>
            <form id="apiKeyForm">
                <input type="password" id="apiKeyInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Your API Key" required>
                <button type="submit" class="w-full btn-primary mt-6">Save Key and Start</button>
            </form>
        </div>
    </div>
    <div id="inDepthModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 id="inDepthModalTitle" class="text-2xl font-bold text-gray-800">In-Depth Exploration</h2>
                <button id="closeInDepthModal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="inDepthModalContent" class="p-6 overflow-y-auto prose max-w-none"></div>
            <div id="inDepthModalFooter" class="p-4 border-t border-gray-200 text-right"></div>
        </div>
    </div>
    <div id="themeGeneratorModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg m-4 flex flex-col">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">AI Visual Theme Generator</h2>
                <button id="closeThemeGeneratorModal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div class="p-6">
                <p class="mb-6 themed-text-muted">Describe a mood or concept to create a new color palette and header image for the app.</p>
                <textarea id="theme-prompt" rows="3" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'A quiet, misty forest at dawn'"></textarea>
                <button id="generate-theme-btn" class="btn-primary w-full mt-4" title="Generate new app visuals based on your text">Generate Visuals</button>
                <div id="theme-loader-container" class="hidden mt-4 flex items-center space-x-3">
                    <div class="loader themed-loader" style="width:25px; height:25px;"></div>
                    <span class="themed-text-muted">AI is generating colors & image...</span>
                </div>
                <div id="theme-error-container" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>
            </div>
        </div>
    </div>
    <div id="geminiSearchModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 id="geminiSearchModalTitle" class="text-2xl font-bold text-gray-800">Gemini Search Results</h2>
                <button id="closeGeminiSearchModal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="geminiSearchModalContent" class="p-6 overflow-y-auto prose max-w-none"></div>
        </div>
    </div>

    <div id="search-gemini-popup" class="fixed hidden bg-white shadow-lg rounded-lg p-2 z-50 border border-gray-200">
        <button id="search-gemini-btn" class="flex items-center gap-2 text-sm text-gray-800 hover:text-purple-600 font-semibold" title="Search for the selected text with Gemini">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-purple-500"><path d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <span>Search with Gemini</span>
        </button>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto">
        <header class="relative text-center mb-10 rounded-2xl overflow-hidden shadow-lg">
            <div id="header-loader" class="hidden absolute inset-0 bg-black bg-opacity-50 flex-col items-center justify-center z-20 transition-opacity duration-500">
                <div class="loader header-loader-spinner"></div>
                <p class="text-white mt-4 text-lg">Generating new header image...</p>
            </div>
            <div id="header-bg-image" class="absolute inset-0 header-bg-image"></div>
            <div class="absolute inset-0 bg-black opacity-40"></div>
            <div class="relative z-10 py-24 px-12 text-white">
                 <h1 class="text-4xl md:text-5xl font-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.6);">AI Yoga Class & Theme Generator</h1>
                <p class="text-lg text-purple-200 mt-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.6);">AI-powered inspiration and design for your practice.</p>
            </div>
            <div id="version-display" class="absolute bottom-2 right-4 text-white text-xs opacity-70">v16.18</div>
        </header>

        <main id="main-content" class="space-y-8">
            <nav id="breadcrumb-nav" aria-label="breadcrumb" class="mb-4 themed-text-muted text-sm hidden"></nav>
            
            <div id="custom-plan-card" class="card">
                <div class="p-8 card-content">
                    <h2 class="text-2xl font-bold mb-2 themed-text-primary">Custom Yoga Plan Generator</h2>
                    <p class="mb-6 themed-text-muted">Feeling creative? Enter any keyword or concept, and let AI craft a unique class plan for you.</p>
                    <form id="gemini-form">
                        <input type="text" id="gemini-prompt" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'Courage & Heart Opening'">
                        
                        <div class="my-4 border rounded-lg" style="border-color: var(--color-card-border);">
                            <div class="accordion-item">
                                <button type="button" class="accordion-header" title="Click to see more options">
                                    <span>Tailor Your Plan with AI-Powered Options:</span>
                                    <svg class="icon w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div class="accordion-content">
                                    <div id="tailoring-buttons-container" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary w-full mt-4" title="Generate a custom yoga plan based on your text">Generate AI Yoga Plan</button>
                    </form>
                    <div id="gemini-result-container" class="mt-6 text-gray-700"></div>
                </div>
            </div>

            <div id="hip-replacement-card-container"></div>

            <div id="main-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- All cards below will be generated by AI -->
            </div>
            
            <div id="discover-more-container" class="text-center py-8">
                 <button id="discover-more-button" class="btn-primary px-8 py-4 text-lg" title="Generate a new random yoga category">
                    <span class="flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v2.5"/><path d="M12 22v-2.5"/><path d="M21.5 12.5h-2.5"/><path d="M4.5 12.5h2.5"/><path d="M18.89 6.11l-1.77 1.77"/><path d="M6.88 18.88l-1.77 1.77"/></svg>
                        Discover More Yoga Topics
                    </span>
                </button>
                <p id="discover-more-error" class="text-red-500 mt-2"></p>
            </div>
        </main>
    </div>

    <!-- Floating Action Buttons -->
    <button id="theme-changer-button" class="floating-action-button" title="Change Visual Theme">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l.34.34a8 8 0 0111.32 11.32l-.34.34a8 8 0 01-11.32-11.32l.34-.34z"/><path d="M16 12l-4.5 4.5-2.5-2.5"/><path d="M22 12s-4-8-10-8S2 12 2 12s4 8 10 8 10-8 10-8z"/></svg>
    </button>
    <button id="ai-help-button" class="floating-action-button" title="AI Help & Feedback">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l-3-3 3-3"/><path d="M15 6l3 3-3 3"/><path d="M12 19.52A10 10 0 1 0 12 4.48"/><path d="M12 2v2.5"/><path d="M12 22v-2.5"/><path d="M21.5 12.5h-2.5"/><path d="M4.5 12.5h2.5"/><path d="M18.89 6.11l-1.77 1.77"/><path d="M6.88 18.88l-1.77 1.77"/></svg>
    </button>
    <button id="settings-button" class="floating-action-button" title="Typography Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
    </button>
    <button id="new-plan-button" class="floating-action-button" title="New Plan">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
    </button>
    <div id="settings-panel" class="hidden"><h3 class="text-lg font-bold themed-text-accent mb-4">Display Settings</h3><div class="space-y-4"><div><label for="font-family-select" class="block text-sm font-medium themed-text-muted mb-1">Font Family</label><select id="font-family-select" class="w-full p-2 themed-input border rounded-lg"></select></div><div><label for="font-size-select" class="block text-sm font-medium themed-text-muted mb-1">Font Size</label><select id="font-size-select" class="w-full p-2 themed-input border rounded-lg"></select></div><div><label for="line-height-select" class="block text-sm font-medium themed-text-muted mb-1">Line Spacing</label><select id="line-height-select" class="w-full p-2 themed-input border rounded-lg"></select></div></div></div>


    <script type="module">
        // --- Global Variables ---
        let apiKey = "";
        const root = document.documentElement;
        const allThemeData = {};
        let originalGeneratedText = new Map();
        let currentOnboardingStep = 0;
        let activeTutorialListener = null;

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('apiKeyModal').classList.remove('hidden');
            setupEventListeners();
            populateTypographySettings();
            setupBreadcrumbListener();
        });

        // --- Onboarding Tutorial ---
        const onboardingSteps = [
            {
                title: "Welcome to the App!",
                text: "Let's take a quick tour to see how everything works. This interactive guide will show you the main features.",
                element: null, 
                position: 'center',
                interactive: false
            },
            {
                title: "Custom Plan Generator",
                text: "This is where you can enter any keyword or concept, and the AI will generate a complete, unique class plan for you.",
                element: '#custom-plan-card', // Highlight the entire card
                position: 'center', // Position modal relative to this card
                interactive: false 
            },
            {
                title: "AI Visual Theme Generator",
                text: "Use this button to open the AI Visual Theme Generator. You can describe a mood or concept to generate a new color palette and header image for the app.",
                element: '#theme-changer-button',
                position: 'left', // Position to the left of the button
                interactive: false 
            },
            {
                title: "AI-Powered Categories",
                text: "Explore pre-made themes by clicking on any of the cards below. Each card provides a category with specific themes you can use to generate a detailed yoga plan.",
                element: '#main-grid', // Highlight the entire grid of categories
                position: 'top', // Position above the grid
                interactive: false 
            },
            {
                title: "Gentle Yoga After Hip Replacement",
                text: "This dedicated section offers safe and modified yoga class plans specifically designed for recovery and mobility after hip surgery.",
                element: '#hip-replacement-card-container', // Highlight this specific card
                position: 'top',
                interactive: false
            },
            {
                title: "Chakras Category",
                text: "Discover practices aligned with the body's seven primary energy centers. Each Chakra button provides a brief explanation and an option to generate a yoga plan.",
                element: '.card[id*="chakras"]', // Target the specific card by ID part
                position: 'top',
                interactive: false
            },
            {
                title: "Astrology Category",
                text: "Connect your yoga practice to the cosmos and the zodiac signs. Explore themes based on astrological energies and date ranges.",
                element: '.card[id*="astrology"]',
                position: 'top',
                interactive: false
            },
            {
                title: "Yoga for Artists Category",
                text: "Find yoga concepts and themes specifically tailored to boost creativity and release tension for artists.",
                element: '.card[id*="artists"]',
                position: 'top',
                interactive: false
            },
            {
                title: "Yoga for Dancers Category",
                text: "Enhance flexibility, strength, and aid recovery with yoga practices curated specifically for dancers.",
                element: '.card[id*="dancers"]',
                position: 'top',
                interactive: false
            },
            {
                title: "Yoga for Neurodiversity Category",
                text: "Explore practices adapted for sensory regulation, mindfulness, and grounding, suitable for neurodiverse individuals.",
                element: '.card[id*="neurodiversity"]',
                position: 'top',
                interactive: false
            },
            {
                title: "Seasons Category",
                text: "Align your yoga practice with the natural cycles of the earth and the energy of the four seasons.",
                element: '.card[id*="seasons"]',
                position: 'top',
                interactive: false
            },
            {
                title: "Moon Phases Category",
                text: "Discover how to align your practice with the energy of the lunar cycle, from new moon intentions to full moon release.",
                element: '.card[id*="moonPhases"]',
                position: 'top',
                interactive: false
            },
            {
                title: "Yoga Styles Category",
                text: "Base your class around the principles of a specific yoga style. This section offers an extensive list of major and niche styles.",
                element: '.card[id*="styles"]',
                position: 'top',
                interactive: false
            },
            {
                title: "US Holidays Category",
                text: "Find themed yoga practices inspired by major US holidays, perfect for special classes or personal reflection.",
                element: '.card[id*="holidays"]',
                position: 'top',
                interactive: false
            },
            {
                title: "Eastern Holidays Category",
                text: "Explore yoga themes and practices inspired by significant Hindu and Buddhist traditions and festivals.",
                element: '.card[id*="easternHolidays"]',
                position: 'top',
                interactive: false
            },
            {
                title: "Meridians Category",
                text: "Delve into the major meridians of Traditional Chinese Medicine and how they relate to energy flow in yoga.",
                element: '.card[id*="meridians"]',
                position: 'top',
                interactive: false
            },
            {
                title: "Discover More Yoga Topics",
                text: "Click this button to dynamically generate and load even more unique yoga topic categories for endless inspiration.",
                element: '#discover-more-button',
                position: 'top',
                interactive: false
            },
            {
                title: "AI Help & Feedback",
                text: "This button provides quick access to an AI assistant for help, FAQs, and to provide feedback on the app's features and user experience.",
                element: '#ai-help-button',
                position: 'left',
                interactive: false
            },
            {
                title: "Typography Settings",
                text: "Use this button to open display settings, allowing you to adjust the font family, font size, and line spacing of the app's text to suit your reading preferences.",
                element: '#settings-button',
                position: 'left',
                interactive: false
            },
            {
                title: "New Plan Button",
                text: "This floating action button allows you to quickly clear the current workspace and start generating a fresh yoga plan or theme at any time.",
                element: '#new-plan-button',
                position: 'left',
                interactive: false
            },
            {
                title: "Search with Gemini",
                text: "You can highlight any text on the page, and a 'Search with Gemini' popup will appear, offering you an option to get an in-depth explanation of the selected concept from Gemini AI.",
                element: '#custom-plan-card h2', // A visible element to highlight something on the main content
                position: 'bottom', // Position below the highlighted text
                interactive: false
            },
            {
                title: "You're All Set!",
                text: "That's it! You've seen the core features of the AI Yoga Class & Theme Generator. Click 'Done' to close this tutorial and start creating!",
                element: null,
                position: 'center',
                interactive: false
            }
        ];
        
        function cleanupStepListeners() {
            if (activeTutorialListener) {
                activeTutorialListener.element.removeEventListener(activeTutorialListener.eventType, activeTutorialListener.handler);
                activeTutorialListener = null;
            }
        }
        
        function moveToNextStep() {
            if (currentOnboardingStep < onboardingSteps.length - 1) {
                currentOnboardingStep++;
                showOnboardingStep(currentOnboardingStep);
            } else {
                // If it's the last step and "Next" is clicked, it means the tutorial is effectively done.
                endOnboarding();
            }
        }

        function startOnboarding() {
            currentOnboardingStep = 0;
            document.getElementById('onboarding-backdrop').classList.remove('hidden');
            showOnboardingStep(currentOnboardingStep);
        }

        function showOnboardingStep(stepIndex) {
            cleanupStepListeners(); // Clean up listeners from the previous step

            const modal = document.getElementById('onboarding-modal');
            // Remove highlight from any previously highlighted element
            document.querySelectorAll('.highlight-element').forEach(el => el.classList.remove('highlight-element'));

            const step = onboardingSteps[stepIndex];
            document.getElementById('onboarding-title').textContent = step.title;
            document.getElementById('onboarding-text').innerHTML = step.text;
            document.getElementById('onboarding-progress').textContent = `Step ${stepIndex + 1} of ${onboardingSteps.length}`;

            modal.classList.remove('hidden');
            
            const nextBtn = document.getElementById('onboarding-next');
            const skipBtn = document.getElementById('onboarding-skip');
            const prevBtn = document.getElementById('onboarding-prev');
            const doneBtn = document.getElementById('onboarding-done');

            // Manage button visibility
            prevBtn.style.display = stepIndex === 0 ? 'none' : 'inline-flex';
            nextBtn.style.display = stepIndex === onboardingSteps.length - 1 ? 'none' : 'inline-flex';
            doneBtn.style.display = stepIndex === onboardingSteps.length - 1 ? 'inline-flex' : 'none';
            // Skip button: Hide on the last two steps (last real step, and the "You're All Set!" step)
            // It advances to the next step, not ends the tutorial.
            skipBtn.style.display = (stepIndex >= onboardingSteps.length - 2) ? 'none' : 'inline-flex';


            // Next button is always enabled unless it's the very last step.
            nextBtn.disabled = false; // Always enable the next button, as interaction is no longer forced.
            
            if (step.element) {
                const targetElement = document.querySelector(step.element);
                if (targetElement) {
                    // Add highlight and scroll into view for the current step's element
                    targetElement.classList.add('highlight-element');
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });

                    const rect = targetElement.getBoundingClientRect();
                    
                    // Position the modal relative to the element
                    // Default to center if no specific position or if element is off-screen
                    let modalLeft = rect.left + (rect.width / 2) - (modal.offsetWidth / 2);
                    let modalTop = rect.top + (rect.height / 2) - (modal.offsetHeight / 2);

                    const padding = 15; // Padding from element and viewport edges

                    // Adjust position based on step.position to avoid covering element
                    switch(step.position) {
                        case 'bottom':
                            modalTop = rect.bottom + padding;
                            break;
                        case 'top':
                            modalTop = rect.top - modal.offsetHeight - padding;
                            break;
                        case 'left':
                            modalLeft = rect.left - modal.offsetWidth - padding;
                            // Vertically center with the element if positioned left/right
                            modalTop = rect.top + (rect.height / 2) - (modal.offsetHeight / 2);
                            break;
                        case 'right':
                            modalLeft = rect.right + padding;
                            // Vertically center with the element if positioned left/right
                            modalTop = rect.top + (rect.height / 2) - (modal.offsetHeight / 2);
                            break;
                        default: // 'center' or fallback
                            // Keep default centered positioning relative to element's bounding box
                            break;
                    }
                    
                    // Ensure modal stays within viewport boundaries after initial positioning
                    modalLeft = Math.max(10, Math.min(modalLeft, window.innerWidth - modal.offsetWidth - 10));
                    modalTop = Math.max(10, Math.min(modalTop, window.innerHeight - modal.offsetHeight - 10));

                    modal.style.left = `${modalLeft}px`;
                    modal.style.top = `${modalTop}px`;
                    modal.style.transform = 'none'; // Remove center transform if it was applied
                } else {
                    // If element is not found, center the modal on screen (e.g., for welcome/end steps)
                    modal.style.top = '50%';
                    modal.style.left = '50%';
                    modal.style.transform = 'translate(-50%, -50%)';
                }
            } else { // Center non-element steps (like the welcome or final message)
                 modal.style.top = '50%';
                 modal.style.left = '50%';
                 modal.style.transform = 'translate(-50%, -50%)';
            }
        }

        function endOnboarding() {
            cleanupStepListeners();
            document.getElementById('onboarding-backdrop').classList.add('hidden');
            document.getElementById('onboarding-modal').classList.add('hidden');
            document.querySelectorAll('.highlight-element').forEach(el => el.classList.remove('highlight-element'));
            // Scroll to the top of the page when the tutorial ends
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }


        // --- Breadcrumb Functions ---
        function updateBreadcrumbs(items = []) {
            const nav = document.getElementById('breadcrumb-nav');
            if (!nav) return;

            if (items.length === 0) {
                nav.innerHTML = '';
                nav.classList.add('hidden');
                return;
            }
            nav.classList.remove('hidden');

            let html = '<ol class="flex items-center space-x-2 flex-wrap">';
            items.forEach((item, index) => {
                html += '<li class="flex items-center">';
                if (index < items.length - 1) {
                    if (index === 0) {
                         html += `<a href="#" data-crumb-index="0" class="themed-text-primary hover:underline">${item}</a>`;
                    } else {
                         html += `<span class="themed-text-accent">${item}</span>`;
                    }
                    html += `<span class="mx-2 themed-text-muted">/</span>`;
                } else {
                    html += `<span class="font-semibold" aria-current="page">${item}</span>`;
                }
                html += '</li>';
            });
            html += '</ol>';
            nav.innerHTML = html;
        }

        function setupBreadcrumbListener() {
            document.getElementById('breadcrumb-nav').addEventListener('click', (e) => {
                if (e.target.matches('a[data-crumb-index="0"]')) {
                    e.preventDefault();
                    clearWorkspace();
                }
            });
        }
        
        // --- Function to clear the workspace ---
        function clearWorkspace() {
            document.getElementById('gemini-result-container').innerHTML = '';
            document.querySelectorAll('.details-container').forEach(el => el.innerHTML = '');
            document.getElementById('gemini-prompt').value = '';
            document.getElementById('theme-prompt').value = '';
            document.querySelectorAll('.btn-toggle.active, .grid-card-selector.active').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.search-bar').forEach(bar => {
                bar.value = '';
                bar.dispatchEvent(new Event('input'));
            });
            // Minimize all accordions
            document.querySelectorAll('.accordion-header.active').forEach(header => {
                header.classList.remove('active');
                header.nextElementSibling.classList.remove('open');
            });
            originalGeneratedText.clear();
            updateBreadcrumbs(); 
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // --- Main Content Loading Function ---
        async function loadAppContent() {
            await Promise.allSettled([
                loadAITailoringOptions(),
                loadDynamicPlaceholders(),
                loadHipReplacementCard() // Load the dedicated card first
            ]);
            
            const categoriesToGenerate = [
                { key: 'chakras', title: 'The Seven Chakras', description: "Align your practice with the body's seven primary energy centers.", prompt: `Generate data for the 7 primary chakras. For each, provide a unique "id" (kebab-case name, e.g., "muladhara"), a "title" (e.g., "Muladhara (Root)"), and a brief "explanation" for a yoga context. Return ONLY a valid JSON array of objects.` },
                { key: 'astrology', title: 'Yoga and Astrology', description: "Connect your practice to the cosmos and the zodiac.", prompt: `Generate data for the 12 zodiac signs. For each, provide a unique "id" (kebab-case name, e.g., "aries"), a "title" (e.g., "Aries"), its "dateRange" (e.g., "Mar 21 - Apr 19"), its ruling "planet", and a brief "explanation" of its energy for a yoga context. Return ONLY a valid JSON array of objects.` },
                { key: 'artists', title: 'Yoga for Artists', description: "Unlock creativity and release tension with practices tailored for artists.", prompt: `Generate an extensive list of 40 to 50 yoga concepts or themes tailored for artists to boost creativity and release tension. For each, provide a unique "id" (kebab-case), "title", and a short "description". Return ONLY a valid JSON array of objects.` },
                { key: 'dancers', title: 'Yoga for Dancers', description: "Enhance flexibility, strength, and recovery with yoga for dancers.", prompt: `Generate an extensive list of 40 to 50 yoga concepts or poses specifically beneficial for dancers, focusing on flexibility, strength, and recovery. For each, provide a unique "id" (kebab-case), "title", and a short "description". Return ONLY a valid JSON array of objects.` },
                { key: 'neurodiversity', title: 'Yoga for Neurodiversity', description: "Practices adapted for sensory regulation, mindfulness, and grounding.", prompt: `Generate an extensive list of 40 to 50 yoga themes or practices adapted for neurodiverse individuals, focusing on sensory regulation, mindfulness, and grounding. For each, provide a unique "id" (kebab-case), "title", and a short "description". Return ONLY a valid JSON array of objects.` },
                { key: 'seasons', title: 'The Four Seasons', description: "Align your practice with the natural cycles of the earth.", prompt: `Generate data for the 4 seasons. For each, provide a unique "id" (e.g., "spring-equinox"), a "title", its "date" in MM/DD format, and a brief "explanation" for a yoga context. Return ONLY a valid JSON array of objects.` },
                { key: 'moonPhases', title: 'Moon Phases', description: "Align your practice with the energy of the lunar cycle.", prompt: `Generate data for the 8 phases of the moon. For each, provide a unique "id" (e.g., "new-moon"), a "title", and a brief "explanation" for a yoga context. Return ONLY a valid JSON array of objects.` },
                { key: 'styles', title: 'Yoga Styles', description: "Base your class around the principles of a specific yoga style.", prompt: `Generate an extensive list of 40 to 50 major and niche yoga styles. For each style, provide a unique "id" (kebab-case), a "title", a "founder" (or key figure, can be an empty string), and a "description". Return ONLY a valid JSON array of objects.` },
                { key: 'holidays', title: 'US Holidays', description: "Find themed yoga practices inspired by US holidays.", prompt: `Generate an extensive list of 40 to 50 major US holidays suitable for yoga themes. For each, provide a unique "id" (kebab-case), a "title", its "date" in MM/DD format, and a brief "explanation". Return ONLY a valid JSON array of objects.` },
                { key: 'easternHolidays', title: 'Eastern Holidays', description: "Explore themes from Hindu and Buddhist traditions.", prompt: `Generate an extensive list of 40 to 50 major Hindu and Buddhist holidays. For each, provide a unique "id" (kebab-case), a "title", its "date" in MM/DD format, an "explanation", and a "tradition" ('Hindu' or 'Buddhist'). Return ONLY a valid JSON array of objects.` },
                { key: 'meridians', title: 'The Twelve Meridians', description: "Explore the major meridians of Traditional Chinese Medicine.", prompt: `Generate a list of the 6 primary Meridian pairs from TCM. For each pair, provide a unique "id" (kebab-case), a "title" (e.g., "Lung & Large Intestine"), and an "explanation" for a yoga context. Return ONLY a valid JSON array of objects.` }
            ];

            const promises = categoriesToGenerate.map(cat => generateAndPopulateAICategory(cat.key, cat.title, cat.description, cat.prompt));
            promises.push(generateInitialExtraCategories());

            await Promise.allSettled(promises);
            startOnboarding();
        }
        
        // --- Specific Card Loader: Hip Replacement ---
        async function loadHipReplacementCard() {
            const container = document.getElementById('hip-replacement-card-container');
            const categoryKey = 'hipReplacement';
            const categoryTitle = 'Gentle Yoga After Hip Replacement Surgery';
            const categoryDescription = "Safe, modified practices to support recovery and mobility after hip surgery.";
            // PROMPT MODIFIED: Ask for a class plan, not just poses/concepts
            const prompt = `Generate a list of 10-15 very gentle and safe yoga class plans or sequences suitable for someone recovering from hip replacement surgery. For each plan, provide a unique "id" (kebab-case), a concise "title" (e.g., "Supported Supine Flow"), and a "description" that outlines the plan's focus, emphasizing modifications and what to avoid. Return ONLY a valid JSON array of objects.`;

            const card = document.createElement('div');
            card.className = 'card mb-8'; // Added margin-bottom
            const selectorId = `${categoryKey}-selector-visual`;
            card.innerHTML = `
                <div class="p-8 card-content">
                    <h2 class="text-2xl font-bold mb-2 themed-text-primary">${categoryTitle}</h2>
                    <p class="mb-6 themed-text-muted">${categoryDescription}</p>
                    <div id="${selectorId}" class="w-full"></div>
                    <div id="${categoryKey}-details" class="details-container prose max-w-none"></div>
                </div>
            `;
            container.appendChild(card);
            
            const selectorContainer = document.getElementById(selectorId);
            selectorContainer.innerHTML = getLoaderHTML(`AI is generating ${categoryTitle}...`);

            try {
                const jsonText = await callGeminiAPI(prompt, true);
                const jsonData = JSON.parse(jsonText);
                allThemeData[categoryKey] = jsonData;
                selectorContainer.innerHTML = ''; // Clear loader
                populateCardGridSelector(selectorId, categoryKey);
            } catch (error) {
                if (error.message === 'Invalid API Key') {
                    handleInvalidApiKey(selectorContainer);
                } else {
                    console.error(`Failed to generate or populate ${categoryTitle}:`, error);
                    selectorContainer.innerHTML = `<p class="text-red-500 p-2 text-center">Sorry, could not load ${categoryTitle}. ${error.message}</p>`;
                    card.remove(); 
                }
            }
        }

        // --- Generic AI Category Loader ---
        async function generateAndPopulateAICategory(categoryKey, categoryTitle, categoryDescription, prompt) {
            const mainGrid = document.getElementById('main-grid');
            
            const card = document.createElement('div');
            card.className = 'card md:col-span-2';
            const selectorId = `${categoryKey}-selector-visual`;
            card.innerHTML = `
                <div class="p-8 card-content">
                    <h2 class="text-2xl font-bold mb-2 themed-text-primary">${categoryTitle}</h2>
                    <p class="mb-6 themed-text-muted">${categoryDescription}</p>
                    <div id="${selectorId}" class="w-full"></div>
                    <div id="${categoryKey}-details" class="details-container prose max-w-none"></div>
                </div>
            `;
            mainGrid.appendChild(card);
            
            const selectorContainer = document.getElementById(selectorId);
            selectorContainer.innerHTML = getLoaderHTML(`AI is generating ${categoryTitle}...`);

            try {
                const jsonText = await callGeminiAPI(prompt, true);
                const jsonData = JSON.parse(jsonText);
                allThemeData[categoryKey] = jsonData;
                selectorContainer.innerHTML = ''; // Clear loader
                populateCardGridSelector(selectorId, categoryKey);
            } catch (error) {
                if (error.message === 'Invalid API Key') {
                    handleInvalidApiKey(selectorContainer);
                } else {
                    console.error(`Failed to generate or populate ${categoryTitle}:`, error);
                    selectorContainer.innerHTML = `<p class="text-red-500 p-2 text-center">Sorry, could not load ${categoryTitle}. ${error.message}</p>`;
                    card.remove(); 
                }
            }
        }

        // --- UI Population Functions ---
        function populateCardGridSelector(containerId, themeType) {
            const container = document.getElementById(containerId);
            if(!container) return;
            container.innerHTML = `<input type="text" placeholder="Search..." class="themed-input w-full p-2 rounded-lg mb-2 search-bar" data-theme-type="${themeType}">
                                 <div class="card-grid-container"></div>`;
            const grid = container.querySelector('.card-grid-container');
            const searchBar = container.querySelector('.search-bar');
            
            const renderGrid = (filter = '') => {
                let data = [...(allThemeData[themeType] || [])];
                const holidayTypes = ['holidays', 'easternHolidays', 'astrology'];
                
                const createCardHtml = item => {
                    let dateHtml = '';
                    if (item.date && holidayTypes.includes(themeType)) {
                        try {
                            const [monthNum, dayNum] = item.date.split('/');
                            const date = new Date(2000, monthNum - 1, parseInt(dayNum)); 
                            const dateString = date.toLocaleString('en-US', { month: 'short', day: 'numeric' });
                            dateHtml = `<small class="block themed-text-muted mt-1 text-xs">${dateString}</small>`;
                        } catch(e) { /* ignore date if format is wrong */ }
                    } else if (item.dateRange && themeType === 'astrology') {
                         dateHtml = `<small class="block themed-text-muted mt-1 text-xs">${item.dateRange}</small>`;
                    }

                    return `
                    <div class="grid-card-selector flex flex-col justify-between h-full" data-theme-id="${item.id}" data-theme-type="${themeType}">
                        <div>
                            <div class="icon">${getIconForTheme(themeType, item.id)}</div>
                            <span>${item.title}</span>
                        </div>
                        ${dateHtml}
                    </div>`;
                };

                if (themeType === 'easternHolidays') {
                    const hinduHolidays = data.filter(h => h.tradition === 'Hindu' && h.title.toLowerCase().includes(filter.toLowerCase())).sort((a,b) => getNextHolidayDate(a) - getNextHolidayDate(b));
                    const buddhistHolidays = data.filter(h => h.tradition === 'Buddhist' && h.title.toLowerCase().includes(filter.toLowerCase())).sort((a,b) => getNextHolidayDate(a) - getNextHolidayDate(b));
                    let html = '';
                    if (hinduHolidays.length > 0) {
                        html += '<h3 class="holiday-subheading">Hindu Holidays</h3>' + hinduHolidays.map(createCardHtml).join('');
                    }
                    if (buddhistHolidays.length > 0) {
                        html += '<h3 class="holiday-subheading">Buddhist Holidays</h3>' + buddhistHolidays.map(createCardHtml).join('');
                    }
                    grid.innerHTML = html;
                } else {
                     if (holidayTypes.includes(themeType) || themeType === 'seasons') {
                        data.sort((a,b) => getNextHolidayDate(a) - getNextHolidayDate(b));
                    } else {
                        data.sort((a,b) => a.title.localeCompare(b.title));
                    }
                    grid.innerHTML = data.filter(item => item.title.toLowerCase().includes(filter.toLowerCase())).map(createCardHtml).join('');
                }
            };

            renderGrid();
            searchBar.addEventListener('input', e => renderGrid(e.target.value));
            grid.addEventListener('click', e => handleGridSelect(e.target.closest('.grid-card-selector')));
        }
        
        async function handleGridSelect(target) {
            if (!target) return;
            const container = target.closest('.card-grid-container, #hip-replacement-card-container');
            const detailsContainer = container.closest('.card-content').querySelector('.details-container');
            if(!checkApiKey(detailsContainer)) return;
            
            document.querySelectorAll('.grid-card-selector.active').forEach(el => el.classList.remove('active'));
            target.classList.add('active');
            
            const { themeId, themeType } = target.dataset;
            detailsContainer.dataset.themeId = themeId;
            detailsContainer.dataset.themeType = themeType; 
            const theme = allThemeData[themeType].find(t => t.id === themeId);
            
            const categoryTitle = target.closest('.card').querySelector('h2').textContent;
            updateBreadcrumbs(['Home', categoryTitle, theme.title]);

            detailsContainer.innerHTML = getLoaderHTML('Generating theme details...');
            const founderInfo = theme.founder ? `It was founded or popularized by ${theme.founder}.` : '';
            const description = theme.description || theme.explanation;
            let datePromptSection = '';
            const dateableThemes = ['seasons', 'holidays', 'easternHolidays'];
            if (dateableThemes.includes(themeType)) {
                datePromptSection = `The current year is ${new Date().getFullYear()}. First, state the next upcoming date for this event in the New York (EST) timezone for the current year, as a bolded line of text.\n\n`;
            }

            const prompt = `${datePromptSection}You are a creative yoga instructor. For a yoga class themed "${theme.title}" (which is about "${description}" ${founderInfo}), generate a short, engaging, and unique preview for a student. Use clear paragraphs for descriptions. For lists of items, use bullet points that start with a hyphen. For subheadings within the text, use bold text by enclosing it in double asterisks, like **This Is a Subheading**. Do not use hyphens or asterisks for subheadings. Ensure the output is well-structured.`;
            try {
                const markdownText = await callGeminiAPI(prompt);
                originalGeneratedText.set(detailsContainer, markdownText);
                detailsContainer.innerHTML = `<div class="prose-content">${robustMarkdownToHtml(markdownText)}</div>`;
                addPostGenerationButtons(detailsContainer, theme.id, themeType);
            } catch (error) {
                 if (error.message === 'Invalid API Key') {
                    handleInvalidApiKey(detailsContainer);
                } else {
                    detailsContainer.innerHTML = `<p class="text-red-500 p-2">${generateErrorMessage(error, 'text')}</p>`;
                }
            }
        }
        
        // --- Event Listeners and other functions ---
        function setupEventListeners() {
            document.getElementById('apiKeyForm').addEventListener('submit', handleApiKeySubmit);
            document.getElementById('generate-theme-btn').addEventListener('click', handleCustomVisualThemeGeneration);
            document.getElementById('gemini-form').addEventListener('submit', handleGeminiSubmit);
            document.getElementById('discover-more-button').addEventListener('click', handleDiscoverMoreClick);
            document.getElementById('font-family-select').addEventListener('change', (e) => root.style.setProperty('--font-family', e.target.value));
            document.getElementById('font-size-select').addEventListener('change', (e) => root.style.setProperty('--font-size-base', e.target.value));
            document.getElementById('line-height-select').addEventListener('change', (e) => root.style.setProperty('--line-height-base', e.target.value));
            
            // Onboarding listeners
            document.getElementById('onboarding-next').addEventListener('click', moveToNextStep);
            document.getElementById('onboarding-prev').addEventListener('click', () => {
                 if (currentOnboardingStep > 0) {
                    currentOnboardingStep--;
                    showOnboardingStep(currentOnboardingStep);
                }
            });
            // MODIFIED: Skip button now moves to the next step, not ends the tutorial
            document.getElementById('onboarding-skip').addEventListener('click', moveToNextStep); 
            document.getElementById('onboarding-done').addEventListener('click', endOnboarding);
            // NEW: Listener for the 'X' close button
            document.getElementById('onboarding-close-x').addEventListener('click', endOnboarding);


            document.addEventListener('mouseup', handleTextSelection);
            // MODIFIED: Only hide popup if click is outside popup and not on a selectable element
            document.addEventListener('mousedown', (e) => {
                const popup = document.getElementById('search-gemini-popup');
                // Only hide if the click is outside the popup AND the clicked element is not an interactive control (input, button)
                // AND there is no active text selection.
                // This prevents the popup from hiding when interacting with its own button or when simply de-selecting text.
                if (!popup.classList.contains('hidden') && 
                    !popup.contains(e.target) && 
                    !e.target.closest('input, textarea, button') && 
                    window.getSelection().toString().trim() === '') { // Only hide if nothing is selected
                    popup.classList.add('hidden');
                }
            });

            document.addEventListener('click', (e) => {
                if (e.target.closest('#new-plan-button')) clearWorkspace();
                if (e.target.closest('#theme-changer-button')) document.getElementById('themeGeneratorModal').classList.remove('hidden');
                if (e.target.closest('#closeThemeGeneratorModal') || e.target.id === 'themeGeneratorModal') document.getElementById('themeGeneratorModal').classList.add('hidden');
                if (e.target.closest('#closeGeminiSearchModal') || e.target.id === 'geminiSearchModal') document.getElementById('geminiSearchModal').classList.add('hidden');

                const inDepthModal = document.getElementById('inDepthModal');
                if (e.target.id === 'inDepthModal' || e.target.closest('#closeInDepthModal')) { if (inDepthModal) inDepthModal.classList.add('hidden'); }
                const exploreBtn = e.target.closest('.explore-button');
                if (exploreBtn) handleExploreInDepth(exploreBtn.dataset.themeId, exploreBtn.dataset.themeType);
                
                const refineBtn = e.target.closest('.refine-button');
                if (refineBtn) toggleRefineUI(refineBtn.parentElement);
                const submitRefineBtn = e.target.closest('.submit-refinement-button');
                if(submitRefineBtn) handleRefineRequest(submitRefineBtn.closest('.refine-container'));

                const header = e.target.closest('.accordion-header');
                if (header) { const content = header.nextElementSibling; header.classList.toggle('active'); content.classList.toggle('open'); }
                if (e.target.closest('#ai-help-button')) handleAIHelpRequest();
                const settingsPanel = document.getElementById('settings-panel');
                if (e.target.closest('#settings-button')) settingsPanel.classList.toggle('hidden');
                else if (!settingsPanel.contains(e.target) && !e.target.closest('#settings-button')) settingsPanel.classList.add('hidden');
            });
        }

        function populateTypographySettings() {
            const fontSelect = document.getElementById('font-family-select');
            const sizeSelect = document.getElementById('font-size-select');
            const heightSelect = document.getElementById('line-height-select');
            const fonts = ['Open Sans, sans-serif', 'Arial, sans-serif', 'Verdana, sans-serif', 'Georgia, serif', 'Times New Roman, serif', 'Courier New, monospace', 'Inter, sans-serif', 'Lato, sans-serif', 'Roboto Slab, serif', 'Montserrat, sans-serif'];
            fontSelect.innerHTML = fonts.map(font => `<option value="${font}" ${font.startsWith('Open Sans') ? 'selected' : ''}>${font.split(',')[0]}</option>`).join('');
            sizeSelect.innerHTML = Array.from({length: 7}, (_, i) => 12 + i*2).map(s => `<option value="${s}px" ${s === 16 ? 'selected' : ''}>${s}px</option>`).join('');
            heightSelect.innerHTML = Object.entries({ '1.2': 'Compact', '1.5': 'Default', '1.8': 'Spacious' }).map(([val, text]) => `<option value="${val}" ${val === '1.5' ? 'selected' : ''}>${text}</option>`).join('');
        }

        async function handleApiKeySubmit(e) {
             e.preventDefault(); 
             const input = document.getElementById('apiKeyInput'); 
             if (input.value.trim()) { 
                apiKey = input.value.trim(); 
                document.getElementById('apiKeyModal').classList.add('hidden'); 
                
                const modalMessage = document.querySelector('#apiKeyModal p');
                modalMessage.textContent = 'To use the AI generators, please provide your API key. This key is used for both Gemini (text) and Imagen (image) generation and is only stored for your current session.';
                modalMessage.classList.remove('text-red-600', 'font-bold');

                document.getElementById('main-grid').innerHTML = '';
                document.getElementById('gemini-result-container').innerHTML = '';
                document.getElementById('discover-more-error').innerHTML = '';
                
                await generateAndApplyDefaultTheme();
                loadAppContent(); 
            } 
        }
        
        async function handleGeminiSubmit(e) {
            e.preventDefault();
            const resultContainer = document.getElementById('gemini-result-container');
            if (!checkApiKey(resultContainer)) return;

            const userPrompt = document.getElementById('gemini-prompt').value.trim();
            if (!userPrompt) {
                resultContainer.innerHTML = `<p class="text-amber-600">Please enter a theme idea.</p>`;
                return;
            }
            
            updateBreadcrumbs(['Home', `Custom Plan: ${userPrompt.substring(0, 25)}...`]);

            resultContainer.dataset.themeId = userPrompt; 
            resultContainer.dataset.themeType = 'custom'; 

            const selectedOptions = Array.from(document.querySelectorAll('#tailoring-buttons-container .btn-toggle.active'))
                                             .map(btn => btn.dataset.option);

            resultContainer.innerHTML = getLoaderHTML('Crafting your base class plan...');
            
            // MODIFIED PROMPT: Request ~20 items in the custom plan
            const basePrompt = `You are a master yoga instructor creating a comprehensive and creative guide for a yoga class themed "${userPrompt}". Your goal is to provide a rich and detailed plan, including approximately 20 distinct elements such as poses, breathing techniques, meditation cues, or philosophical insights, organized into logical sections. Structure the response in a logical, easy-to-follow format. Organize the entire guide into several logical sections using '###' for each main heading (e.g., ### Introduction). For subheadings within a section, use bold text like **This is a Subheading**. For lists of items (like poses), use bullet points that start with a hyphen. Ensure the output is well-structured and provides around 20 actionable or conceptual items for the class.`;
            
            try {
                const baseText = await callGeminiAPI(basePrompt);
                originalGeneratedText.set(resultContainer, baseText);
                resultContainer.innerHTML = `<div class="prose-content p-4 border rounded-lg bg-white/50" style="border-color: var(--color-card-border);">${convertMarkdownToAccordion(baseText)}</div>`;
                addPostGenerationButtons(resultContainer, userPrompt, 'custom');
                
                if (selectedOptions.length > 0) {
                    const accordionContainer = resultContainer.querySelector('.prose-content .accordion');
                    if (accordionContainer) { 
                        for (const option of selectedOptions) {
                            const loaderId = `loader-${option.replace(/\s+/g, '-')}`;
                            const componentLoader = document.createElement('div');
                            componentLoader.id = loaderId;
                            componentLoader.innerHTML = getLoaderHTML(`Generating section for ${option}...`);
                            accordionContainer.appendChild(componentLoader);

                            try {
                                const componentPrompt = `You are a yoga expert. Provide a detailed explanation for incorporating "${option}" into a yoga class. Structure the response with a '###' for the main heading. Use bold text for any subheadings.`;
                                const componentText = await callGeminiAPI(componentPrompt);
                                document.getElementById(loaderId)?.remove();
                                accordionContainer.insertAdjacentHTML('beforeend', convertMarkdownToAccordion(componentText, false));
                                let currentText = originalGeneratedText.get(resultContainer) || "";
                                originalGeneratedText.set(resultContainer, currentText + `\n\n${componentText}`);
                            } catch (componentError) {
                                if (componentError.message === 'Invalid API Key') {
                                    handleInvalidApiKey(resultContainer);
                                    break; 
                                }
                                const loaderElement = document.getElementById(loaderId);
                                if(loaderElement) loaderElement.innerHTML = `<div class="p-4 text-red-500">Failed to generate section for <strong>${option}</strong>.</div>`;
                                console.error(`Error generating component for ${option}:`, componentError);
                            }
                        }
                    }
                }
            } catch (error) {
                if (error.message === 'Invalid API Key') {
                    handleInvalidApiKey(resultContainer);
                } else {
                    resultContainer.innerHTML = `<p class="text-red-500 p-2">${generateErrorMessage(error, 'text')}</p>`;
                }
            }
        }
        
        async function loadAITailoringOptions() {
            const container = document.getElementById('tailoring-buttons-container');
            if (!container || !checkApiKey(container)) return;
            container.innerHTML = getLoaderHTML('AI is generating tailoring options...');
            const fallbackOptions = ["Breathwork", "Essential Oils", "Chanting", "Poetry", "Props", "Meditation", "Mantra & Affirmations", "Partner Poses"];
            try {
                // PROMPT MODIFIED: Ask for 40-50 unique options
                const prompt = `Generate an extensive list of 40 to 50 unique and creative yoga class components suitable for integration into a yoga app. The elements should enrich a user's practice, rather than being types of classes. Return ONLY a valid JSON array of strings, with no other text, explanation, or markdown formatting. Example: ["Sanskrit Focus", "Mudras", "Sound Bath"]`;
                const tailoringOptions = await callGeminiAPI(prompt, true).then(JSON.parse);
                populateTailoringButtons(tailoringOptions);
            } catch (error) {
                if (error.message === 'Invalid API Key') {
                    handleInvalidApiKey(container);
                } else {
                    console.error("Failed to load AI tailoring options, using fallback.", error);
                    container.parentElement.previousElementSibling.click(); 
                    container.innerHTML = `<p class="text-amber-600 text-sm">Could not load AI options. Using defaults.</p>`;
                    populateTailoringButtons(fallbackOptions);
                }
            }
        }

        function populateTailoringButtons(options) { const container = document.getElementById('tailoring-buttons-container'); if (!container) return; container.innerHTML = ''; options.forEach(option => { const button = createButton(option, 'btn-toggle px-3 py-1.5 rounded-full text-sm'); button.dataset.option = option; button.title = `Toggle ${option}`; button.addEventListener('click', (e) => { e.preventDefault(); button.classList.toggle('active'); }); container.appendChild(button); }); }
        
        // --- Refine Functions ---
        function toggleRefineUI(buttonContainer) {
            const mainContentContainer = buttonContainer.parentElement;
            const contentArea = (mainContentContainer.id === 'inDepthModalFooter') ? document.getElementById('inDepthModalContent') : mainContentContainer;
            let refineContainer = contentArea.querySelector('.refine-container');
            if (refineContainer) {
                refineContainer.remove();
            } else {
                refineContainer = document.createElement('div');
                refineContainer.className = 'refine-container';
                refineContainer.innerHTML = `
                    <h4 class="font-semibold text-md mb-2 themed-text-accent">Refine This Plan</h4>
                    <textarea class="w-full p-2 themed-input border rounded-lg text-sm" rows="3" placeholder="e.g., 'Make it more beginner-friendly and add a peak pose.'"></textarea>
                    <div class="flex gap-2 mt-2">
                        <button class="btn-primary flex-grow submit-refinement-button text-sm" title="Submit your refinement request">Submit Refinement</button>
                        <button class="btn-secondary text-sm" onclick="this.closest('.refine-container').remove()" title="Cancel refinement">Cancel</button>
                    </div>`;
                const targetForInsertion = contentArea.querySelector('.prose-content, .accordion, .button-actions-container');
                if (targetForInsertion) targetForInsertion.insertAdjacentElement('afterend', refineContainer);
                else contentArea.appendChild(refineContainer);
            }
        }

        async function handleRefineRequest(refineContainer) {
            const contentArea = refineContainer.parentElement;
            if (!checkApiKey(contentArea)) return;
            const refinementPrompt = refineContainer.querySelector('textarea').value.trim();
            if (!refinementPrompt) {
                const textarea = refineContainer.querySelector('textarea');
                textarea.classList.add('border-red-500', 'ring-1', 'ring-red-500');
                textarea.placeholder = "Please enter your refinement request here.";
                return;
            }
            const originalText = originalGeneratedText.get(contentArea);
            if (!originalText) {
                contentArea.innerHTML = `<p class="text-red-500 p-2">Error: Could not find original text. Please generate content again.</p>`;
                return;
            }
            const { themeId, themeType } = contentArea.dataset;
            contentArea.innerHTML = getLoaderHTML('Refining the content...');
            const prompt = `You are a yoga instructor. You previously generated a yoga plan. Now, a user wants to refine it. Original Text: --- ${originalText} --- User's Refinement Request: "${refinementPrompt}" Please generate a new, complete version of the text that incorporates the user's request. Maintain the original markdown format: '###' for main accordion headings, and **bold text** for subheadings within sections.`;
            try {
                const refinedText = await callGeminiAPI(prompt);
                originalGeneratedText.set(contentArea, refinedText); 
                contentArea.innerHTML = refinedText.includes('###') ? `<div class="prose-content p-4 border rounded-lg bg-white/50" style="border-color: var(--color-card-border);">${convertMarkdownToAccordion(refinedText)}</div>` : `<div class="prose-content">${robustMarkdownToHtml(refinedText)}</div>`;
                addPostGenerationButtons(contentArea, themeId, themeType);
            } catch (error) {
                if (error.message === 'Invalid API Key') {
                    handleInvalidApiKey(contentArea);
                } else {
                    contentArea.innerHTML = `<p class="text-red-500 p-2">${generateErrorMessage(error, 'text')}</p>`;
                    addPostGenerationButtons(contentArea, themeId, themeType);
                }
            }
        }

        // --- API Calls, UI Utilities, and other handlers ---
        async function callApi(apiUrl, payload) {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                let errorBody;
                try {
                    errorBody = await response.json();
                } catch (e) {
                    errorBody = { error: { message: await response.text() } };
                }
                console.error("API Error Response:", errorBody);
                if (errorBody?.error?.message?.includes('API key not valid')) {
                    throw new Error('Invalid API Key');
                }
                throw new Error(`API request failed with status ${response.status}: ${errorBody.error.message}`);
            }
            return await response.json();
        }
        
        async function callGeminiAPI(prompt, isJson = false) { 
            const payload = { 
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    maxOutputTokens: 8192 
                }
            };
            if (isJson) {
                payload.generationConfig.responseMimeType = "application/json";
            }
            const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, payload); 
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (text) return text.replace(/```json\n?|```/g, '').trim();
            if (result.promptFeedback?.blockReason) throw new Error(`Request blocked for safety reasons: ${result.promptFeedback.blockReason}`);
            if (result.candidates?.[0]?.finishReason === 'SAFETY') throw new Error("Request blocked for safety reasons."); 
            if (result.candidates?.[0]?.finishReason === 'MAX_TOKENS') throw new Error("Response was too long and was cut short. Please try a less complex request.");
            throw new Error("Invalid response structure from Gemini API.");
        }

        async function callColorGenAPI(prompt) { const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", maxOutputTokens: 8192 } }); const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text; if (jsonText) return JSON.parse(jsonText.replace(/```json\n?|```/g, '').trim()); throw new Error("Could not parse a valid color theme from the AI's response."); }
        async function callImageGenAPI(prompt) { const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`, { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } }); const base64 = result.predictions?.[0]?.bytesBase64Encoded; if (base64) return `data:image/png;base64,${base64}`; throw new Error("Could not get a valid image from the AI's response."); }
        function checkApiKey(container) { if (!apiKey) { document.getElementById('apiKeyModal').classList.remove('hidden'); if(container) { container.innerHTML = `<p class="text-amber-600 p-2">Please enter your API key to continue.</p>`; } return false; } return true; }
        
        function handleInvalidApiKey(container) {
            apiKey = "";
            const apiKeyModal = document.getElementById('apiKeyModal');
            const modalMessage = apiKeyModal.querySelector('p');
            modalMessage.textContent = "Your previous API key was invalid. Please enter a valid one to continue.";
            modalMessage.classList.add('text-red-600', 'font-bold');
            apiKeyModal.classList.remove('hidden');
            if (container) {
                container.innerHTML = `<p class="text-red-500 p-2">Authentication failed. Please enter a valid API key.</p>`;
            }
        }

        function getLoaderHTML(message) { return `<div class="flex justify-center items-center my-4"><div class="loader themed-loader"></div><p class="ml-4 themed-text-muted">${message}</p></div>`; }
        function createButton(text, className, type = 'button') { const button = document.createElement('button'); button.className = className; button.type = type; button.innerHTML = text; return button; }
        
        function robustMarkdownToHtml(text) {
            if (!text) return '';
            let html = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            const lines = html.split('\n');
            html = '';
            let inList = false;
            lines.forEach(line => {
                line = line.trim();
                if (line.startsWith('- ') || line.startsWith('* ')) {
                    if (!inList) {
                        html += '<ul>';
                        inList = true;
                    }
                    html += `<li>${line.substring(2)}</li>`;
                } else {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    if (line) {
                         html += `<p>${line}</p>`;
                    }
                }
            });
            if (inList) {
                html += '</ul>';
            }
            return html;
        }

        function convertMarkdownToAccordion(text, openFirst = true) { const sections = text.split(/^(?:###) /m).slice(1); if (sections.length === 0) return `<div class="accordion">${robustMarkdownToHtml(text)}</div>`; const accordionItems = sections.map((section, index) => { const parts = section.split('\n'); const title = parts[0].trim().replace(/\*+/g, ''); const content = parts.slice(1).join('\n'); const isOpen = openFirst && index === 0; return `<div class="accordion-item"><button class="accordion-header ${isOpen ? 'active' : ''}" title="Toggle section: ${title}"><span>${title}</span><svg class="icon w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div class="accordion-content ${isOpen ? 'open' : ''}"><div class="prose max-w-none p-4">${robustMarkdownToHtml(content)}</div></div></div>`; }).join(''); return `<div class="accordion">${accordionItems}</div>`;}
        function generateErrorMessage(error, type = 'general') { console.error(`Error during ${type} generation:`, error); let message = `An unknown ${type} error occurred. Check the console for details.`; const errorMessage = error.message.toLowerCase(); if (errorMessage.includes('safety') || errorMessage.includes('blocked')) message = `The ${type} generation request was blocked for safety reasons. Please try a different prompt.`; else if (errorMessage.includes('400') && type === 'color') message = `The AI had trouble creating a color theme from that prompt. Try being more descriptive.`; else if (errorMessage.includes('api key not valid')) message = `Authentication failed. Your API Key is not valid. Please check it and try again.`; else if (errorMessage.includes('401') || errorMessage.includes('403')) message = `Authentication failed for ${type} generation. Check your API key.`; else if (errorMessage.includes('429')) message = `You have exceeded your request limit for ${type} generation. Please wait and try again.`; else if (errorMessage.includes('failed to fetch')) message = 'Network Error: Could not connect to the API.'; else if (errorMessage.includes('max_tokens')) message = `The AI's response was too long and was cut short. Please try a simpler request or break it into smaller parts.`; return `Sorry, something went wrong. ${message}`; }
        
        async function generateAndApplyDefaultTheme() {
            showThemeLoading(true);
            const themePrompt = "Big Sunset on the beach";
            const colorPrompt = `Based on the following text, generate a color palette that reflects its mood. I need a JSON object with keys: "bg", "text", "primary", "primaryDark", "accent", "cardBg", "cardBorder", "textMuted", "inputBg", "inputBorder", "buttonText". Ensure high contrast and accessibility, especially making sure the 'buttonText' color contrasts well with the 'primary' and 'accent' colors. Return only the JSON. Text: "${themePrompt}"`;
            const imagePrompt = `A beautiful, artistic, abstract background image inspired by the concept of "${themePrompt}". The style should be suitable for a yoga and wellness website header. Serene, calming, and visually appealing. Wide aspect ratio, photographic, cinematic lighting.`;
            try {
                const [colorResult, imageResult] = await Promise.allSettled([callColorGenAPI(colorPrompt), callImageGenAPI(imagePrompt)]);
                if (colorResult.status === 'fulfilled') {
                    applyTheme(colorResult.value);
                } else {
                    console.error("Default color theme generation failed, applying fallback.");
                    throw colorResult.reason; 
                }
                if (imageResult.status === 'fulfilled') {
                    applyHeaderImage(imageResult.value);
                } else {
                    console.error("Default header image generation failed.");
                    throw imageResult.reason;
                }
            } catch (error) {
                 if (error.message === 'Invalid API Key') {
                    handleInvalidApiKey();
                 } else {
                    console.error("Applying fallback theme due to an error.", error);
                 }
            } finally {
                showThemeLoading(false);
            }
        }

        async function handleCustomVisualThemeGeneration() { 
            const container = document.getElementById('theme-error-container');
            if (!checkApiKey()) return; 
            const prompt = document.getElementById('theme-prompt').value.trim(); 
            if (!prompt) { showThemeError("Please enter a description for your visual theme."); return; } 
            showThemeLoading(true); 
            const colorPrompt = `Based on the following text, generate a color palette that reflects its mood. I need a JSON object with keys: "bg", "text", "primary", "primaryDark", "accent", "cardBg", "cardBorder", "textMuted", "inputBg", "inputBorder", "buttonText". Ensure high contrast and accessibility, especially making sure the 'buttonText' color contrasts well with the 'primary' and 'accent' colors. Return only the JSON. Text: "${prompt}"`; 
            const imagePrompt = `A beautiful, artistic, abstract background image inspired by the concept of "${prompt}". The style should be suitable for a yoga and wellness website header. Serene, calming, and visually appealing. Wide aspect ratio, photographic, cinematic lighting.`; 
            try { 
                const [colorResult, imageResult] = await Promise.allSettled([callColorGenAPI(colorPrompt), callImageGenAPI(imagePrompt)]); 
                if (colorResult.status === 'fulfilled') { applyTheme(colorResult.value); } else { throw colorResult.reason; } 
                if (imageResult.status === 'fulfilled') { applyHeaderImage(imageResult.value); } else { throw imageResult.reason; } 
            } catch (error) 
            { 
                if (error.message === 'Invalid API Key') {
                    handleInvalidApiKey();
                } else {
                    showThemeError(generateErrorMessage(error, 'visual theme'));
                }
            } finally { 
                showThemeLoading(false); 
            } 
        }

        async function handleExploreInDepth(themeId, themeType) {
            const modal = document.getElementById('inDepthModal');
            const modalContent = document.getElementById('inDepthModalContent');
            const modalFooter = document.getElementById('inDepthModalFooter');
            if (!checkApiKey(modalContent)) return;
            modalContent.dataset.themeId = themeId;
            modalContent.dataset.themeType = themeType;
            const modalTitle = document.getElementById('inDepthModalTitle');
            const theme = (themeType === 'custom') ? { title: themeId, description: 'A custom user-generated theme.' } : allThemeData[themeType].find(t => t.id === themeId);
            modalTitle.textContent = `Exploring: ${theme.title}`;
            modalContent.innerHTML = getLoaderHTML('Generating your detailed guide...');
            modalFooter.innerHTML = '';
            modal.classList.remove('hidden');
            const founderInfo = theme.founder ? `It was founded or popularized by ${theme.founder}.` : '';
            const description = theme.description || theme.explanation;
            let datePromptSection = '';
            const dateableThemes = ['seasons', 'holidays', 'easternHolidays', 'moonPhases'];
            if (dateableThemes.includes(themeType)) {
                datePromptSection = `The current year is ${new Date().getFullYear()}. First, as a standalone bolded line, state the next upcoming date for this event in the New York (EST) timezone for the current year.\n\n`;
            }
            const prompt = `${datePromptSection}You are a master yoga instructor creating a comprehensive guide for a yoga class themed "${theme.title}", which is about: "${description}". ${founderInfo}. Structure the response in a logical, easy-to-follow format. Organize the entire guide into several logical sections using '###' for each main heading (e.g., ### Introduction). For subheadings within a section, use bold text like **This is a Subheading**. For lists of items (like poses), use bullet points that start with a hyphen. The content, titles, and number of sections are entirely up to you to best suit the theme.`;
            try {
                const text = await callGeminiAPI(prompt);
                originalGeneratedText.set(modalContent, text);
                modalContent.innerHTML = `<div class="prose-content">${convertMarkdownToAccordion(text)}</div>`;
                addPostGenerationButtons(modalFooter, themeId, themeType);
            } catch (error) {
                if (error.message === 'Invalid API Key') {
                    handleInvalidApiKey(modalContent);
                } else {
                    modalContent.innerHTML = `<p class="text-red-500 p-2">${generateErrorMessage(error, 'text')}</p>`;
                }
            }
        }

        async function handleAIHelpRequest() {
            const modal = document.getElementById('inDepthModal');
            const modalContent = document.getElementById('inDepthModalContent');
            const modalFooter = document.getElementById('inDepthModalFooter');
            if (!checkApiKey(modalContent)) return;
            const modalTitle = document.getElementById('inDepthModalTitle');
            modalTitle.textContent = "AI Help & Feedback";
            modalContent.innerHTML = getLoaderHTML('Generating help and suggestions...');
            modalFooter.innerHTML = '';
            modal.classList.remove('hidden');
            const prompt = `You are a helpful UI/UX assistant. Your task is to provide an overview and improvement suggestions for the "AI Yoga Class & Theme Generator" application. Structure your response with two main sections using '###' markdown headings: '### How This App Works' and '### UI/UX Improvement Suggestions'.

Under 'How This App Works', explain the following key features:
- **Custom Plan Generator:** Users can type any concept to get a unique yoga class plan.
- **AI-Powered Categories:** The app pre-loads numerous categories (like Chakras, Astrology, Yoga for Dancers) with specific themes to choose from.
- **Visual Theme Generation:** Users can describe a mood to generate a new color scheme and header image for the entire app.
- **In-Depth Exploration:** Users can get detailed guides on any topic.
- **Floating Action Buttons:** These provide quick access to key features like creating a new plan, changing the theme, getting help, and adjusting typography.

Under '### UI/UX Improvement Suggestions', offer a few specific, actionable ideas to improve the user experience. For example, suggest features like saving favorite plans, adding a search history, or improving layout on mobile devices.`;
            try {
                const text = await callGeminiAPI(prompt);
                originalGeneratedText.set(modalContent, text);
                modalContent.innerHTML = `<div class="prose-content">${convertMarkdownToAccordion(text)}</div>`;
                const exportButton = createButton('Copy Text', 'btn-secondary');
                exportButton.addEventListener('click', (e) => copyElementTextToClipboard(modalContent, e.currentTarget));
                modalFooter.appendChild(exportButton);
            } catch (error) {
                if (error.message === 'Invalid API Key') {
                    handleInvalidApiKey(modalContent);
                } else {
                    modalContent.innerHTML = `<p class="text-red-500 p-2">${generateErrorMessage(error, 'text')}</p>`;
                }
            }
        }
        
        function copyElementTextToClipboard(element, button) {
            if (!element) return;
            const textToCopy = element.innerText;
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                if (button) {
                    const originalText = button.innerHTML;
                    button.innerHTML = '<span>Copied!</span>';
                    button.disabled = true;
                    setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 2000);
                }
            } catch (err) { console.error('Oops, unable to copy', err); }
            document.body.removeChild(textArea);
        }

        function addPostGenerationButtons(container, themeId, themeType) { 
            const buttonContainer = document.createElement('div'); 
            buttonContainer.className = 'button-actions-container flex flex-col md:flex-row gap-2 mt-6'; 
            const refineButton = createButton(`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="16 3 21 8 8 21 3 21 3 16 16 3"></polygon></svg> <span>Refine</span>`, 'btn-secondary w-full md:w-auto refine-button'); 
            refineButton.title = "Refine this generated content";
            const copyButton = createButton(`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span>Copy Text</span>`, 'btn-secondary w-full md:w-auto'); 
            copyButton.title = "Copy the text content to your clipboard";
            copyButton.addEventListener('click', (e) => { const contentToCopy = container.id === 'inDepthModalFooter' ? document.getElementById('inDepthModalContent') : container.querySelector('.prose-content, .accordion'); copyElementTextToClipboard(contentToCopy, e.currentTarget) }); 
            if(container.id !== 'inDepthModalFooter') { const exploreButton = createButton('Explore in Depth', 'btn-primary w-full explore-button'); exploreButton.dataset.themeId = themeId; exploreButton.dataset.themeType = themeType; exploreButton.title="Get a more detailed plan in a new window"; buttonContainer.appendChild(exploreButton); } 
            buttonContainer.appendChild(refineButton); buttonContainer.appendChild(copyButton); container.appendChild(buttonContainer); 
        }

        async function loadDynamicPlaceholders() { if (!apiKey) return; try { const prompt = `Generate two short, creative, and distinct yoga class theme ideas to be used as placeholder text in an input field. Return the result as a JSON object with two keys, "theme1" and "theme2". Example: {"theme1": "Embracing the winds of change", "theme2": "Finding stillness in the storm"}`; const themes = await callGeminiAPI(prompt, true).then(JSON.parse); if (themes.theme1) document.getElementById('theme-prompt').placeholder = `e.g., '${themes.theme1}'`; if (themes.theme2) document.getElementById('gemini-prompt').placeholder = `e.g., '${themes.theme2}'`; } catch (error) { if (error.message === 'Invalid API Key') { handleInvalidApiKey(); } else { console.error("Could not load dynamic placeholders:", error); } } }
        function applyTheme(colors) { Object.keys(colors).forEach(key => { const cssVarName = '--color-' + key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`); root.style.setProperty(cssVarName, colors[key]); }); }
        
        function applyHeaderImage(imageUrl) {
            const headerBg = document.getElementById('header-bg-image');
            headerBg.style.opacity = 0;
            const img = new Image();
            img.onload = () => { headerBg.style.backgroundImage = `url('${imageUrl}')`; headerBg.style.opacity = 1; };
            img.src = imageUrl;
        }

        function showThemeLoading(isLoading) { document.getElementById('theme-loader-container').classList.toggle('hidden', !isLoading); document.getElementById('header-loader').classList.toggle('hidden', !isLoading); document.getElementById('header-loader').classList.toggle('flex', isLoading); document.getElementById('generate-theme-btn').disabled = isLoading; document.getElementById('generate-theme-btn').classList.toggle('opacity-50', isLoading); }
        function showThemeError(message) { const el = document.getElementById('theme-error-container'); el.textContent = message; el.classList.remove('hidden'); }
        function getIconForTheme(themeType, themeId) { const defaultIcon = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>`; const icons = { styles: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.5 16.5a2 2 0 100-4 2 2 0 000 4zM18.5 16.5a2 2 0 100-4 2 2 0 000 4zM2 10h2.5M19.5 10H22M12 2v2.5M12 19.5V22M4.5 4.5l2 2M17.5 4.5l-2 2M4.5 19.5l2-2M17.5 19.5l-2-2"></path>`, holidays: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>`, easternHolidays: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>`, astrology: `<path fill-rule="evenodd" clip-rule="evenodd" d="M12 21.5C17.2467 21.5 21.5 17.2467 21.5 12C21.5 6.75329 17.2467 2.5 12 2.5C6.75329 2.5 2.5 6.75329 2.5 12C2.5 17.2467 6.75329 21.5 12 21.5ZM12 23C18.0751 23 23 18.0751 23 12C23 5.92487 18.0751 1 12 1C5.92487 1 1 5.92487 1 12C1 18.0751 5.92487 23 12 23Z" fill="currentColor"/><path d="M12 6L14 10L18 12L14 14L12 18L10 14L6 12L10 10L12 6Z" fill="currentColor"/>` }; return `<svg class="themed-text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">${icons[themeType] || defaultIcon}</svg>`; }
        function getNextHolidayDate(holiday) {
             if (!holiday || !holiday.date || !/^\d{1,2}\/\d{1,2}$/.test(holiday.date)) {
                return new Date(8640000000000000); 
            }
            const now = new Date(); 
            const currentYear = now.getFullYear(); 
            const [month, day] = holiday.date.split('/').map(Number); 
            let holidayDate = new Date(currentYear, month - 1, day); 
            if (holidayDate < now) { holidayDate.setFullYear(currentYear + 1); } 
            return holidayDate; 
        }
        
        async function generateInitialExtraCategories() {
            const mainGrid = document.getElementById('main-grid');
            const loaderCard = document.createElement('div');
            loaderCard.id = 'new-category-loader';
            loaderCard.className = 'card md:col-span-2 p-8';
            loaderCard.innerHTML = getLoaderHTML('AI is generating initial yoga categories...');
            mainGrid.appendChild(loaderCard);

            // PROMPT MODIFIED: Request 15-20 styles per sub-category for initial load
            const prompt = `Generate a comprehensive JSON object of yoga categories beyond the basics. For each category, provide a "categoryTitle", a "categoryDescription", and a "styles" array. For each "styles" array, generate a list of 15 to 20 different styles. Each item in the "styles" array must be an object with an "id" (kebab-case), a "title", and a "description". The categories to generate are: "Therapeutic & Rehabilitative Yoga", "Spiritually-Oriented Yoga", "Yoga for Life Stages", "Yoga Blends & Fusions", "Historical & Traditional Lineages", and "Environment & Tool-Based Yoga". Return ONLY a valid, complete, and perfectly formatted JSON object where keys are camelCase versions of the category titles (e.g., "therapeuticRehabilitativeYoga"). Do not include any markdown formatting, comments, or incomplete structures. The final output must be parsable by a standard JSON parser.`;

            let jsonText;
            try {
                jsonText = await callGeminiAPI(prompt, true);
                
                if (typeof jsonText !== 'string' || jsonText.trim() === '') {
                    throw new Error("API returned an empty or invalid response.");
                }

                const newCategoriesData = JSON.parse(jsonText);
                loaderCard.remove();

                for (const [key, category] of Object.entries(newCategoriesData)) {
                    if (category && category.categoryTitle && category.categoryDescription && Array.isArray(category.styles)) {
                        allThemeData[key] = category.styles;
                        const card = document.createElement('div');
                        card.className = 'card md:col-span-2';
                        card.innerHTML = `<div class="p-8 card-content"><h2 class="text-2xl font-bold mb-2 themed-text-primary">${category.categoryTitle}</h2><p class="mb-6 themed-text-muted">${category.categoryDescription}</p><div id="${key}-selector-visual" class="w-full"></div><div id="${key}-details" class="details-container prose max-w-none"></div></div>`;
                        mainGrid.appendChild(card);
                        populateCardGridSelector(`${key}-selector-visual`, key);
                    } else {
                        console.warn("Skipping invalid category object from AI:", key, category);
                    }
                }
            } catch (error) {
                if (error.message === 'Invalid API Key') {
                    handleInvalidApiKey(loaderCard);
                } else {
                    console.error("Failed to generate or populate initial extra yoga categories:", error);
                    let errorMessage = `Sorry, could not load the AI-generated categories. ${error.message}`;
                    if (error instanceof SyntaxError && jsonText) {
                        errorMessage += `<br><br>The AI returned invalid data. This is often a temporary issue. Please try again.`;
                        const positionMatch = error.message.match(/position (\d+)/);
                        if (positionMatch) {
                            const position = parseInt(positionMatch[1], 10);
                            const context = jsonText.substring(Math.max(0, position - 40), position + 40);
                            errorMessage += `<br><br><b>Error details:</b> <code class="block bg-red-100 p-1 rounded text-xs whitespace-pre-wrap overflow-x-auto">...${context}...</code>`;
                        }
                    }
                    loaderCard.innerHTML = `<p class="text-red-500 p-2">${errorMessage}</p>`;
                }
            }
        }
        
        async function handleDiscoverMoreClick() {
            const button = document.getElementById('discover-more-button');
            const errorP = document.getElementById('discover-more-error');
            if (!checkApiKey(errorP)) return;

            button.disabled = true;
            button.querySelector('span').textContent = 'Generating...';
            errorP.textContent = '';
            
            const existingTitles = Array.from(document.querySelectorAll('#main-grid .card h2')).map(h2 => h2.textContent);
            // PROMPT MODIFIED: Request 15-20 styles for discover more category
            const prompt = `Generate a JSON object for one new, creative, and unique yoga-related category. The category's title must NOT be in the following list of existing titles: [${existingTitles.join(', ')}]. The JSON object should have a single root key, which must be a camelCase version of the new category's title (e.g., "yogaForAthletes"). The value for this key should be an object containing three properties: "categoryTitle" (string), "categoryDescription" (string), and a "styles" array. The "styles" array should contain 15 to 20 style objects, where each object has an "id" (kebab-case string), "title" (string), and "description" (string). Return ONLY the raw, valid JSON object with no other text or markdown.`;

            try {
                const jsonText = await callGeminiAPI(prompt, true);
                const newCategoriesData = JSON.parse(jsonText);
                
                for (const [key, category] of Object.entries(newCategoriesData)) {
                     if (category && category.categoryTitle && category.categoryDescription && Array.isArray(category.styles)) {
                        allThemeData[key] = category.styles;
                        const card = document.createElement('div');
                        card.className = 'card md:col-span-2';
                        card.innerHTML = `<div class="p-8 card-content"><h2 class="text-2xl font-bold mb-2 themed-text-primary">${category.categoryTitle}</h2><p class="mb-6 themed-text-muted">${category.categoryDescription}</p><div id="${key}-selector-visual" class="w-full"></div><div id="${key}-details" class="details-container prose max-w-none"></div></div>`;
                        document.getElementById('main-grid').appendChild(card);
                        populateCardGridSelector(`${key}-selector-visual`, key);
                    } else {
                        console.warn("Skipping invalid 'discover more' category:", key, category);
                    }
                }

            } catch(error) {
                if (error.message === 'Invalid API Key') {
                    handleInvalidApiKey(errorP);
                } else {
                    console.error('Failed to discover more categories:', error);
                    errorP.textContent = `Sorry, couldn't generate new topics. ${error.message}`;
                }
            } finally {
                button.disabled = false;
                button.querySelector('span').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v2.5"/><path d="M12 22v-2.5"/><path d="M21.5 12.5h-2.5"/><path d="M4.5 12.5h2.5"/><path d="M18.89 6.11l-1.77 1.77"/><path d="M6.88 18.88l-1.77 1.77"/></svg> Discover More Yoga Topics`;
            }
        }

        function handleTextSelection(e) {
            const popup = document.getElementById('search-gemini-popup');
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();

            // Ensure selection is not empty, not within an input/textarea, and not within certain interactive elements
            if (selectedText.length > 2 && !e.target.closest('input, textarea, button, .floating-action-button, .btn-secondary, .btn-primary')) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                popup.style.left = `${rect.left + window.scrollX}px`;
                popup.style.top = `${rect.bottom + window.scrollY + 8}px`;
                popup.classList.remove('hidden');
                
                const searchBtn = document.getElementById('search-gemini-btn');
                searchBtn.onclick = () => { // Ensure this re-assigns the click handler with the current text
                    performGeminiSearch(selectedText);
                    popup.classList.add('hidden');
                };
            } else {
                // Only hide the popup if there's no selection or if the click is not on the popup itself
                // This prevents accidental hiding when simply clicking away after a selection
                if (!popup.contains(e.target)) {
                     popup.classList.add('hidden');
                }
            }
        }
        
        async function performGeminiSearch(text) {
            const modal = document.getElementById('geminiSearchModal');
            const modalTitle = document.getElementById('geminiSearchModalTitle');
            const modalContent = document.getElementById('geminiSearchModalContent');
            if (!checkApiKey(modalContent)) return; // Check API key before proceeding

            modalTitle.textContent = `Gemini Explains: "${text}"`;
            modalContent.innerHTML = getLoaderHTML(`Searching for information about "${text}"...`);
            modal.classList.remove('hidden');
            const prompt = `Please provide a detailed, yet easy-to-understand explanation of the following concept, especially in the context of yoga, wellness, and spirituality: "${text}". Structure the response with a main heading using '###' for the title, followed by well-structured paragraphs. Use bold text for any subheadings.`;
            try {
                const resultText = await callGeminiAPI(prompt);
                modalContent.innerHTML = `<div class="prose max-w-none">${convertMarkdownToAccordion(resultText)}</div>`;
            } catch (error) {
                if (error.message === 'Invalid API Key') {
                    handleInvalidApiKey(modalContent);
                } else {
                    modalContent.innerHTML = `<p class="text-red-500 p-2">${generateErrorMessage(error, 'text')}</p>`;
                }
            }
        }
    </script>
</body>
</html>
