<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Yoga Class & Theme Generator v10.2</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter, Lato, Roboto Slab, Open Sans, Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* * ==============================================
         * CSS Custom Properties for Theming & Typography
         * ==============================================
        */
        :root {
            /* Color Theme */
            --color-bg: #f3e8ff;
            --color-text: #374151;
            --color-text-muted: #6b7280;
            --color-primary: #9333ea;
            --color-primary-dark: #7e22ce;
            --color-accent: #581c87;
            --color-card-bg: rgba(255, 255, 255, 0.9);
            --color-card-border: #e9d5ff;
            --color-input-bg: #f9fafb;
            --color-input-border: #d1d5db;
            --color-button-text: #ffffff;
            /* Typography Settings */
            --font-family: 'Arial', sans-serif;
            --font-size-base: 13px;
            --line-height-base: 1.15;
        }

        /* Applying the theme variables */
        body {
            font-family: var(--font-family);
            background-color: var(--color-bg);
            color: var(--color-text);
            font-size: var(--font-size-base);
            line-height: var(--line-height-base);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        .prose {
             font-size: inherit;
             line-height: inherit;
        }
        .prose p { margin-bottom: 1em; }
        .prose ul { margin-left: 1.5em; list-style-type: disc; }
        .card {
            background-color: var(--color-card-bg);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, background-color 0.5s ease, border-color 0.5s ease;
            border: 1px solid var(--color-card-border);
            display: flex;
            flex-direction: column;
        }
        .card:hover {
            transform: translateY(-5px) scale(1.02);
        }
        .card-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .btn-primary {
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text);
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 10px rgba(0, 0, 0, 0.15);
            filter: brightness(1.1);
        }

        .btn-secondary {
            background-color: var(--color-input-bg);
            color: var(--color-text-muted);
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid var(--color-input-border);
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-secondary:hover {
            background-color: #e5e7eb; /* gray-200 */
            color: var(--color-accent);
        }
        
        .btn-toggle {
            background-color: var(--color-input-bg);
            color: var(--color-text-muted);
            border: 1px solid var(--color-input-border);
            transition: all 0.2s ease;
        }
        .btn-toggle.active {
            background-color: var(--color-accent);
            color: var(--color-button-text);
            border-color: var(--color-primary-dark);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .floating-action-button {
            position: fixed;
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 40;
        }
        .floating-action-button:hover {
            transform: translateY(-3px) scale(1.05);
        }
        #new-plan-button { bottom: 2rem; right: 2rem; }
        #settings-button { bottom: 6.5rem; right: 2rem; }
        #ai-help-button { bottom: 11rem; right: 2rem; }
        #theme-changer-button { bottom: 15.5rem; right: 2rem; }
        
        #settings-panel {
            position: fixed;
            bottom: 11rem; 
            right: 2rem;
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-card-border);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 1rem;
            width: 280px;
            z-index: 40;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform-origin: bottom right;
        }

        .themed-text-primary { color: var(--color-primary); }
        .themed-text-accent { color: var(--color-accent); }
        .themed-text-muted { color: var(--color-text-muted); }
        .themed-input {
            background-color: var(--color-input-bg);
            border-color: var(--color-input-border);
            color: var(--color-text);
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        .themed-input::placeholder { color: var(--color-text-muted); opacity: 0.7; }
        .themed-input:focus { --tw-ring-color: var(--color-primary); }

        .loader { border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .themed-loader {
            border: 4px solid var(--color-card-border);
            border-top: 4px solid var(--color-primary);
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header-bg-image { 
            background-image: url('https://i.ibb.co/gFXPP4Gt/Image-fx-88.png'); 
            background-size: cover; 
            background-position: center;
            opacity: 1;
            transition: opacity 1.5s ease-in-out; /* Slower fade for header */
        }
        .header-loader-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: white; }

        /* Accordion Styles */
        .accordion-item { border-bottom: 1px solid var(--color-card-border); }
        .accordion-header {
            width: 100%; text-align: left; padding: 1rem; display: flex;
            justify-content: space-between; align-items: center; font-weight: 600;
            color: var(--color-text); background-color: transparent; border: none; cursor: pointer;
            transition: background-color 0.2s;
        }
        .accordion-header:hover { background-color: rgba(0,0,0,0.03); }
        .accordion-content { padding: 0 1rem 1rem 1rem; display: none; }
        .accordion-content.open { display: block; }
        .accordion-header .icon { transition: transform 0.3s ease; }
        .accordion-header.active .icon { transform: rotate(180deg); }

        .refine-container {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--color-card-border);
        }
        
        /* --- Visual Selector Styles --- */
        .visual-selector-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            margin-top: 1rem;
        }
        /* Chakra Styles */
        .chakra-selector {
            width: 3rem; height: 3rem; border-radius: 50%; cursor: pointer;
            transition: all 0.3s ease; border: 3px solid transparent;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .chakra-selector:hover { transform: scale(1.1); }
        .chakra-selector.active {
            border-color: var(--color-accent);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .chakra-tooltip {
            position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
            background-color: var(--color-accent); color: white; padding: 0.25rem 0.5rem;
            border-radius: 4px; font-size: 0.75rem; white-space: nowrap;
            opacity: 0; transition: opacity 0.2s; pointer-events: none;
        }
        .chakra-selector:hover .chakra-tooltip { opacity: 1; }
        
        /* Seasons Styles */
        .season-selector {
            cursor: pointer; transition: all 0.3s ease; padding: 0.5rem;
            border-radius: 50%; border: 3px solid transparent;
        }
        .season-selector:hover { transform: scale(1.1) rotate(5deg); }
        .season-selector.active {
            border-color: var(--color-primary);
            background-color: rgba(147, 51, 234, 0.1);
        }
        .season-selector svg { width: 4rem; height: 4rem; }
        
        /* Moon Phases Styles */
        .moon-phase-selector {
            cursor: pointer; transition: all 0.3s ease;
            padding: 0.5rem; border-radius: 8px; border: 2px solid transparent;
        }
        .moon-phase-selector:hover { background-color: rgba(0,0,0,0.05); }
        .moon-phase-selector.active { border-color: var(--color-accent); }
        .moon-phase-selector svg { width: 3rem; height: 3rem; }
        
        /* Card Grid Styles (Holidays, Styles, Meridians) */
        .card-grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding: 0.5rem;
            border-radius: 8px;
            background: rgba(0,0,0,0.02);
        }
        .grid-card-selector {
            background-color: white; border: 1px solid var(--color-card-border);
            border-radius: 8px; padding: 1rem; text-align: center;
            cursor: pointer; transition: all 0.2s ease;
            font-size: 0.875rem; font-weight: 500;
        }
        .grid-card-selector:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .grid-card-selector.active {
            background-color: var(--color-accent); color: white;
            border-color: var(--color-primary-dark);
        }
        .grid-card-selector .icon { margin-bottom: 0.5rem; }
        .grid-card-selector svg { width: 2.5rem; height: 2.5rem; margin: 0 auto; display: block; }

        .holiday-subheading {
            grid-column: 1 / -1; /* Span full width */
            color: var(--color-accent);
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 2px solid var(--color-card-border);
        }

    </style>
</head>
<body class="p-4 md:p-8">

    <!-- API Key Modal & In-Depth Modal -->
     <div id="apiKeyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Enter Your API Key</h2>
            <p class="mb-6 text-gray-600">To use the AI generators, please provide your API key. This key is used for both Gemini (text) and Imagen (image) generation and is only stored for your current session.</p>
            <form id="apiKeyForm">
                <input type="password" id="apiKeyInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Your API Key" required>
                <button type="submit" class="w-full btn-primary mt-6">Save Key and Start</button>
            </form>
        </div>
    </div>
    <div id="inDepthModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 id="inDepthModalTitle" class="text-2xl font-bold text-gray-800">In-Depth Exploration</h2>
                <button id="closeInDepthModal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="inDepthModalContent" class="p-6 overflow-y-auto prose max-w-none"></div>
            <div id="inDepthModalFooter" class="p-4 border-t border-gray-200 text-right"></div>
        </div>
    </div>
    
    <!-- NEW: Theme Generator Modal -->
    <div id="themeGeneratorModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg m-4 flex flex-col">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">AI Visual Theme Generator</h2>
                <button id="closeThemeGeneratorModal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6">
                <p class="mb-6 themed-text-muted">Describe a mood or concept to create a new color palette and header image for the app.</p>
                <textarea id="theme-prompt" rows="3" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'A quiet, misty forest at dawn'"></textarea>
                <button id="generate-theme-btn" class="btn-primary w-full mt-4">Generate Visuals</button>
                <div id="theme-loader-container" class="hidden mt-4 flex items-center space-x-3">
                    <div class="loader themed-loader" style="width:25px; height:25px;"></div>
                    <span class="themed-text-muted">AI is generating colors & image...</span>
                </div>
                <div id="theme-error-container" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>
            </div>
        </div>
    </div>


    <!-- Main Content -->
    <div class="container mx-auto">
        <header class="relative text-center mb-10 rounded-2xl overflow-hidden shadow-lg">
            <div id="header-loader" class="hidden absolute inset-0 bg-black bg-opacity-50 flex-col items-center justify-center z-20 transition-opacity duration-500">
                <div class="loader header-loader-spinner"></div>
                <p class="text-white mt-4 text-lg">Generating new header image...</p>
            </div>
            <div id="header-bg-image" class="absolute inset-0 header-bg-image"></div>
            <div class="absolute inset-0 bg-black opacity-40"></div>
            <div class="relative z-10 p-12 text-white">
                 <h1 class="text-4xl md:text-5xl font-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.6);">AI Yoga Class & Theme Generator</h1>
                <p class="text-lg text-purple-200 mt-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.6);">AI-powered inspiration and design for your practice.</p>
            </div>
            <div id="version-display" class="absolute bottom-2 right-4 text-white text-xs opacity-70">v10.2</div>
        </header>

        <main id="main-content" class="space-y-8">
            <div class="card">
                <div class="p-8 card-content">
                    <h2 class="text-2xl font-bold mb-2 themed-text-primary">Custom Yoga Plan Generator</h2>
                    <p class="mb-6 themed-text-muted">Feeling creative? Enter any keyword or concept, and let AI craft a unique class plan for you.</p>
                    <form id="gemini-form">
                        <input type="text" id="gemini-prompt" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'Courage & Heart Opening'">
                        <div class="my-4">
                            <label class="block text-sm font-medium themed-text-muted mb-2">Tailor Your Plan with AI-Powered Options:</label>
                            <div id="tailoring-buttons-container" class="flex flex-wrap gap-2"></div>
                        </div>
                        <button type="submit" class="btn-primary w-full mt-4">Generate AI Yoga Plan</button>
                    </form>
                    <div id="gemini-result-container" class="mt-6 text-gray-700"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="card"><div class="p-8 card-content"><h2 class="text-2xl font-bold mb-2 themed-text-primary">The Seven Chakras</h2><p class="mb-6 themed-text-muted">Align your practice with the body's seven primary energy centers. Select a chakra to focus on, and let the AI generate a corresponding theme and short description to guide your session.</p><div id="chakras-selector-visual" class="visual-selector-container mt-auto"></div><div id="chakras-details" class="details-container prose max-w-none"></div></div></div>
                <div class="card"><div class="p-8 card-content"><h2 class="text-2xl font-bold mb-2 themed-text-primary">The Four Seasons</h2><p class="mb-6 themed-text-muted">Align your practice with the natural cycles of the earth.</p><div id="seasons-selector-visual" class="visual-selector-container mt-auto"></div><div id="seasons-details" class="details-container prose max-w-none"></div></div></div>
                
                <div class="card md:col-span-2"><div class="p-8 card-content"><h2 class="text-2xl font-bold mb-2 themed-text-primary">The Twelve Meridians</h2><p class="mb-6 themed-text-muted">Explore the major meridians of Traditional Chinese Medicine.</p><div id="meridian-selector-visual" class="w-full"></div><div id="meridian-details" class="details-container prose max-w-none"></div></div></div>
                <div class="card md:col-span-2"><div class="p-8 card-content"><h2 class="text-2xl font-bold mb-2 themed-text-primary">Moon Phases</h2><p class="mb-6 themed-text-muted">Align your practice with the energy of the lunar cycle.</p><div id="moon-phases-selector-visual" class="visual-selector-container mt-auto"></div><div id="moon-phases-details" class="details-container prose max-w-none"></div></div></div>
                <div class="card md:col-span-2"><div class="p-8 card-content"><h2 class="text-2xl font-bold mb-2 themed-text-primary">Yoga Styles</h2><p class="mb-6 themed-text-muted">Base your class around the principles of a specific yoga style.</p><div id="styles-selector-visual" class="w-full"></div><div id="styles-details" class="details-container prose max-w-none"></div></div></div>
                <div class="card md:col-span-2"><div class="p-8 card-content"><h2 class="text-2xl font-bold mb-2 themed-text-primary">US Holidays</h2><p class="mb-6 themed-text-muted">Find themed yoga practices inspired by US holidays.</p><div id="holidays-selector-visual" class="w-full"></div><div id="holidays-details" class="details-container prose max-w-none"></div></div></div>
                <div class="card md:col-span-2"><div class="p-8 card-content"><h2 class="text-2xl font-bold mb-2 themed-text-primary">Eastern Holidays</h2><p class="mb-6 themed-text-muted">Explore themes from Hindu and Buddhist traditions.</p><div id="eastern-holidays-selector-visual" class="w-full"></div><div id="eastern-holidays-details" class="details-container prose max-w-none"></div></div></div>

            </div>
        </main>
    </div>

    <!-- Floating Action Buttons -->
    <button id="theme-changer-button" class="floating-action-button" title="Change Visual Theme">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l.34.34a8 8 0 0111.32 11.32l-.34.34a8 8 0 01-11.32-11.32l.34-.34z"/><path d="M16 12l-4.5 4.5-2.5-2.5"/><path d="M22 12s-4-8-10-8S2 12 2 12s4 8 10 8 10-8 10-8z"/></svg>
    </button>
    <button id="ai-help-button" class="floating-action-button" title="AI Help & Feedback">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l-3-3 3-3"/><path d="M15 6l3 3-3 3"/><path d="M12 19.52A10 10 0 1 0 12 4.48"/><path d="M12 2v2.5"/><path d="M12 22v-2.5"/><path d="M21.5 12.5h-2.5"/><path d="M4.5 12.5h2.5"/><path d="M18.89 6.11l-1.77 1.77"/><path d="M6.88 18.88l-1.77 1.77"/></svg>
    </button>
    <button id="settings-button" class="floating-action-button" title="Typography Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
    </button>
    <button id="new-plan-button" class="floating-action-button" title="New Plan">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
    </button>
    <div id="settings-panel" class="hidden"><h3 class="text-lg font-bold themed-text-accent mb-4">Display Settings</h3><div class="space-y-4"><div><label for="font-family-select" class="block text-sm font-medium themed-text-muted mb-1">Font Family</label><select id="font-family-select" class="w-full p-2 themed-input border rounded-lg"></select></div><div><label for="font-size-select" class="block text-sm font-medium themed-text-muted mb-1">Font Size</label><select id="font-size-select" class="w-full p-2 themed-input border rounded-lg"></select></div><div><label for="line-height-select" class="block text-sm font-medium themed-text-muted mb-1">Line Spacing</label><select id="line-height-select" class="w-full p-2 themed-input border rounded-lg"></select></div></div></div>


    <script type="module">
        // --- Global Variables ---
        let apiKey = "";
        const root = document.documentElement;
        const allThemeData = {
            chakras: getChakrasSeedData(), meridians: getMeridiansSeedData(), seasons: getSeasonsSeedData(), styles: getModalitiesSeedData(), holidays: getHolidaysSeedData(), moonPhases: getMoonPhasesSeedData(),
            // Combine Hindu and Buddhist holidays
            easternHolidays: [
                ...getHinduHolidaysSeedData().map(h => ({...h, tradition: 'Hindu'})),
                ...getBuddhistHolidaysSeedData().map(h => ({...h, tradition: 'Buddhist'}))
            ]
        };
        let originalGeneratedText = new Map();

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('apiKeyModal').classList.remove('hidden');
            setupEventListeners();
            populateTypographySettings();
        });

        // --- NEW: Function to clear the workspace ---
        function clearWorkspace() {
            // Clear result containers
            document.getElementById('gemini-result-container').innerHTML = '';
            document.querySelectorAll('.details-container').forEach(el => el.innerHTML = '');

            // Clear input fields
            document.getElementById('gemini-prompt').value = '';
            document.getElementById('theme-prompt').value = '';

            // Deactivate all toggle/selector buttons
            document.querySelectorAll('.btn-toggle.active, .visual-selector-container .active, .card-grid-container .active').forEach(el => {
                el.classList.remove('active');
            });
            
            // Clear search bars
            document.querySelectorAll('.search-bar').forEach(bar => {
                bar.value = '';
                // Trigger input event to re-render the full list
                bar.dispatchEvent(new Event('input'));
            });

            // Clear stored text
            originalGeneratedText.clear();

            // Optional: Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }


        // --- Visual Selectors ---
        function populateVisualSelectors() {
            populateChakraSelector();
            populateSeasonSelector();
            populateMoonPhaseSelector();
            // Card Grids
            populateCardGridSelector('styles-selector-visual', 'styles');
            populateCardGridSelector('meridian-selector-visual', 'meridians');
            populateCardGridSelector('holidays-selector-visual', 'holidays');
            populateCardGridSelector('eastern-holidays-selector-visual', 'easternHolidays');
        }

        function populateChakraSelector() {
            const container = document.getElementById('chakras-selector-visual');
            if(!container) return;
            const chakraColors = { muladhara: '#ff3b30', svadhisthana: '#ff9500', manipura: '#ffcc00', anahata: '#34c759', vishuddha: '#5ac8fa', ajna: '#5856d6', sahasrara: '#af52de' };
            const sortedChakras = [...allThemeData.chakras].sort((a,b) => a.title.localeCompare(b.title));
            container.innerHTML = sortedChakras.map(c => `
                <div class="chakra-selector" style="background-color:${chakraColors[c.id]};" data-theme-id="${c.id}" data-theme-type="chakras">
                    <div class="chakra-tooltip">${c.title.split(' ')[0]}</div>
                </div>
            `).join('');
            container.addEventListener('click', e => handleVisualSelect(e.target.closest('.chakra-selector')));
        }
        
        function populateSeasonSelector() {
            const container = document.getElementById('seasons-selector-visual');
            if(!container) return;
            const sortedSeasons = [...allThemeData.seasons].sort((a,b) => getNextHolidayDate(a) - getNextHolidayDate(b));
            const seasonIcons = {
                'spring-equinox': `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 2v2m-6.36 2.64L7.05 7.05M2 12h2m2.64 6.36L7.05 17m5-10a5 5 0 015 5h-5V7z" stroke="#34D399"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 12a5 5 0 01-5-5h5v5z" stroke="#6EE7B7"></path></svg>`,
                'summer-solstice': `<svg fill="none" stroke="#FBBF24" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 2v2m0 16v2m-6.36-2.64L7.05 17M17 7.05L18.36 5.64M2 12h2m16 0h2m-2.64-6.36L17 7.05M7.05 7.05L5.64 5.64M12 18a6 6 0 100-12 6 6 0 000 12z"></path></svg>`,
                'autumn-equinox': `<svg fill="none" stroke="#F97316" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 12H4M12 4v16m6-14l-4 4-4-4m8 10l-4-4-4 4"></path></svg>`,
                'winter-solstice': `<svg fill="none" stroke="#60A5FA" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 10l7-7 7 7M5 14l7 7 7-7"></path></svg>`
            };
            container.innerHTML = sortedSeasons.map(s => `
                <div class="season-selector" data-theme-id="${s.id}" data-theme-type="seasons" title="${s.title}">${seasonIcons[s.id]}</div>`).join('');
            container.addEventListener('click', e => handleVisualSelect(e.target.closest('.season-selector')));
        }

        function populateMoonPhaseSelector() {
            const container = document.getElementById('moon-phases-selector-visual');
            if(!container) return;
            const phaseOrder = ['new-moon', 'waxing-crescent', 'first-quarter', 'waxing-gibbous', 'full-moon', 'waning-gibbous', 'last-quarter', 'waning-crescent'];
            const sortedPhases = phaseOrder.map(id => allThemeData.moonPhases.find(p => p.id === id)).filter(Boolean);
            
            const moonIcons = {
                'waxing-crescent': 'M12 2a10 10 0 100 20V2z', 'first-quarter': 'M2 12a10 10 0 1020 0H2z', 'waxing-gibbous': 'M12 2a10 10 0 000 20V2z', 'full-moon': 'M12 2a10 10 0 110 20 10 10 0 010-20z', 'waning-gibbous': 'M12 2v20a10 10 0 000-20z', 'last-quarter': 'M22 12a10 10 0 01-20 0h20z', 'waning-crescent': 'M12 2v20a10 10 0 010-20z'
            };
            const transforms = { 'waxing-crescent': '', 'first-quarter': 'transform -rotate-90', 'waxing-gibbous': 'transform scale-x-[-1]', 'waning-gibbous': '', 'last-quarter': 'transform -rotate-90', 'waning-crescent': 'transform scale-x-[-1]'};
            
            container.innerHTML = sortedPhases.map(p => {
                if (p.id === 'new-moon') {
                    return `<div class="moon-phase-selector" data-theme-id="${p.id}" data-theme-type="moonPhases" title="${p.title}">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <circle cx="12" cy="12" r="10" />
                                </svg>
                            </div>`;
                }
                return `<div class="moon-phase-selector" data-theme-id="${p.id}" data-theme-type="moonPhases" title="${p.title}">
                            <svg viewBox="0 0 24 24" fill="currentColor" class="${transforms[p.id] || ''}">
                                 <path fill="#e5e7eb" d="M12 2a10 10 0 110 20 10 10 0 010-20z"></path>
                                 <path d="${moonIcons[p.id]}"></path>
                            </svg>
                        </div>`;
            }).join('');
            container.addEventListener('click', e => handleVisualSelect(e.target.closest('.moon-phase-selector')));
        }
        
        function populateCardGridSelector(containerId, themeType) {
            const container = document.getElementById(containerId);
            if(!container) return;
            container.innerHTML = `<input type="text" placeholder="Search..." class="themed-input w-full p-2 rounded-lg mb-2 search-bar" data-theme-type="${themeType}">
                                 <div class="card-grid-container"></div>`;
            const grid = container.querySelector('.card-grid-container');
            const searchBar = container.querySelector('.search-bar');
            
            const renderGrid = (filter = '') => {
                let data = [...allThemeData[themeType]];
                const holidayTypes = ['holidays', 'easternHolidays'];
                
                const createCardHtml = item => `
                    <div class="grid-card-selector" data-theme-id="${item.id}" data-theme-type="${themeType}">
                        <div class="icon">${getIconForTheme(themeType, item.id)}</div>
                        <span>${item.title}</span>
                    </div>`;

                if (themeType === 'easternHolidays') {
                    const hinduHolidays = data.filter(h => h.tradition === 'Hindu' && h.title.toLowerCase().includes(filter.toLowerCase())).sort((a,b) => getNextHolidayDate(a) - getNextHolidayDate(b));
                    const buddhistHolidays = data.filter(h => h.tradition === 'Buddhist' && h.title.toLowerCase().includes(filter.toLowerCase())).sort((a,b) => getNextHolidayDate(a) - getNextHolidayDate(b));
                    let html = '';
                    if (hinduHolidays.length > 0) {
                        html += '<h3 class="holiday-subheading">Hindu Holidays</h3>' + hinduHolidays.map(createCardHtml).join('');
                    }
                    if (buddhistHolidays.length > 0) {
                        html += '<h3 class="holiday-subheading">Buddhist Holidays</h3>' + buddhistHolidays.map(createCardHtml).join('');
                    }
                    grid.innerHTML = html;
                } else {
                     if (holidayTypes.includes(themeType)) {
                        data.sort((a,b) => getNextHolidayDate(a) - getNextHolidayDate(b));
                    } else {
                        data.sort((a,b) => a.title.localeCompare(b.title));
                    }
                    grid.innerHTML = data.filter(item => item.title.toLowerCase().includes(filter.toLowerCase())).map(createCardHtml).join('');
                }
            };

            renderGrid();
            searchBar.addEventListener('input', e => renderGrid(e.target.value));
            grid.addEventListener('click', e => handleVisualSelect(e.target.closest('.grid-card-selector')));
        }
        
        async function handleVisualSelect(target) {
            if (!target) return;
            const container = target.closest('.visual-selector-container, .card-grid-container');
            const detailsContainer = container.closest('.card-content').querySelector('.details-container');
            if(!checkApiKey(detailsContainer)) return;
            
            container.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
            target.classList.add('active');
            
            const { themeId, themeType } = target.dataset;
            const theme = allThemeData[themeType].find(t => t.id === themeId);
            
            detailsContainer.innerHTML = getLoaderHTML('Generating theme details...');
            const founderInfo = theme.founder ? `It was founded or popularized by ${theme.founder}.` : '';
            const description = theme.description || theme.explanation;
            let datePromptSection = '';
            const dateableThemes = ['seasons', 'holidays', 'easternHolidays'];
            if (dateableThemes.includes(themeType)) {
                datePromptSection = `The current year is ${new Date().getFullYear()}. First, state the next upcoming date for this event in the New York (EST) timezone for the current year, as a bolded line of text.\n\n`;
            }
            const prompt = `${datePromptSection}You are a creative yoga instructor. For a yoga class themed "${theme.title}" (which is about "${description}" ${founderInfo}), generate a short, engaging, and unique preview for a student. Feel free to structure it in any way you see fit using markdown.`;
            try {
                const markdownText = await callGeminiAPI(prompt);
                originalGeneratedText.set(detailsContainer, markdownText);
                detailsContainer.innerHTML = `<div class="prose-content">${robustMarkdownToHtml(markdownText)}</div>`;
                addPostGenerationButtons(detailsContainer, theme.id, themeType);
            } catch (error) {
                detailsContainer.innerHTML = `<p class="text-red-500 p-2">${generateErrorMessage(error, 'text')}</p>`;
            }
        }
        
        // --- Event Listeners and other functions ---
        function setupEventListeners() {
            document.getElementById('apiKeyForm').addEventListener('submit', handleApiKeySubmit);
            document.getElementById('generate-theme-btn').addEventListener('click', handleVisualThemeGeneration);
            document.getElementById('gemini-form').addEventListener('submit', handleGeminiSubmit);
            document.getElementById('font-family-select').addEventListener('change', (e) => root.style.setProperty('--font-family', e.target.value));
            document.getElementById('font-size-select').addEventListener('change', (e) => root.style.setProperty('--font-size-base', e.target.value));
            document.getElementById('line-height-select').addEventListener('change', (e) => root.style.setProperty('--line-height-base', e.target.value));
            document.addEventListener('click', (e) => {
                if (e.target.closest('#new-plan-button')) {
                    clearWorkspace();
                }
                if (e.target.closest('#theme-changer-button')) {
                    document.getElementById('themeGeneratorModal').classList.remove('hidden');
                }
                if (e.target.closest('#closeThemeGeneratorModal') || e.target.id === 'themeGeneratorModal') {
                    document.getElementById('themeGeneratorModal').classList.add('hidden');
                }

                const inDepthModal = document.getElementById('inDepthModal');
                if (e.target.id === 'inDepthModal' || e.target.closest('#closeInDepthModal')) { if (inDepthModal) inDepthModal.classList.add('hidden'); }
                const exploreBtn = e.target.closest('.explore-button');
                if (exploreBtn) handleExploreInDepth(exploreBtn.dataset.themeId, exploreBtn.dataset.themeType);
                const refineBtn = e.target.closest('.refine-button');
                if (refineBtn) toggleRefineUI(refineBtn.parentElement);
                const submitRefineBtn = e.target.closest('.submit-refinement-button');
                if(submitRefineBtn) handleRefineRequest(submitRefineBtn.parentElement);
                const header = e.target.closest('.accordion-header');
                if (header) { const content = header.nextElementSibling; header.classList.toggle('active'); content.classList.toggle('open'); }
                if (e.target.closest('#ai-help-button')) handleAIHelpRequest();
                const settingsPanel = document.getElementById('settings-panel');
                if (e.target.closest('#settings-button')) settingsPanel.classList.toggle('hidden');
                else if (!settingsPanel.contains(e.target) && !e.target.closest('#settings-button')) settingsPanel.classList.add('hidden');
            });
        }

        function populateTypographySettings() {
            const fontSelect = document.getElementById('font-family-select');
            const sizeSelect = document.getElementById('font-size-select');
            const heightSelect = document.getElementById('line-height-select');

            // Fonts
            const fonts = ['Arial, sans-serif', 'Verdana, sans-serif', 'Georgia, serif', 'Times New Roman, serif', 'Courier New, monospace', 'Inter, sans-serif', 'Lato, sans-serif', 'Roboto Slab, serif', 'Open Sans, sans-serif', 'Montserrat, sans-serif'];
            fontSelect.innerHTML = fonts.map(font => {
                const familyName = font.split(',')[0].replace(/'/g, '');
                const isSelected = familyName === 'Arial' ? 'selected' : '';
                return `<option value="${font}" ${isSelected}>${familyName}</option>`
            }).join('');

            // Font Sizes
            let sizeOptions = '';
            for (let i = 10; i <= 30; i += 2) {
                const isSelected = i === 12 ? 'selected' : ''; // Default is 13px, select the closest available (12)
                sizeOptions += `<option value="${i}px" ${isSelected}>${i}px</option>`;
            }
             sizeSelect.innerHTML = sizeOptions;
             sizeSelect.value = '13px'; // Set the default


            // Line Heights
            const lineHeights = { '1.0': 'Single', '1.15': 'Default', '1.5': '1.5x' };
            heightSelect.innerHTML = Object.entries(lineHeights).map(([val, text]) => {
                const isSelected = val === '1.15' ? 'selected' : '';
                return `<option value="${val}" ${isSelected}>${text}</option>`
            }).join('');
        }

        function handleApiKeySubmit(e) { e.preventDefault(); const input = document.getElementById('apiKeyInput'); if (input.value.trim()) { apiKey = input.value.trim(); document.getElementById('apiKeyModal').classList.add('hidden'); loadDynamicPlaceholders(); loadAITailoringOptions(); populateVisualSelectors(); } }
        
        async function handleGeminiSubmit(e) {
            e.preventDefault();
            const resultContainer = document.getElementById('gemini-result-container');
            if (!checkApiKey(resultContainer)) return;
            const userPrompt = document.getElementById('gemini-prompt').value.trim();
            if (!userPrompt) {
                resultContainer.innerHTML = `<p class="text-amber-600">Please enter a theme idea.</p>`;
                return;
            }

            const selectedOptions = Array.from(document.querySelectorAll('#tailoring-buttons-container .btn-toggle.active'))
                                             .map(btn => btn.dataset.option);

            resultContainer.innerHTML = getLoaderHTML('Crafting your base class plan...');
            const basePrompt = `You are a master yoga instructor creating a comprehensive and creative guide for a yoga class themed "${userPrompt}". Your guide should be exceptionally thorough and inspiring for another yoga teacher. Please organize your guide into several logical sections using '###' for each main heading. The content, titles, and number of sections are entirely up to you to best suit the theme.`;
            
            try {
                const baseText = await callGeminiAPI(basePrompt);
                originalGeneratedText.set(resultContainer, baseText);
                resultContainer.innerHTML = `<div class="prose-content p-4 border rounded-lg bg-white/50" style="border-color: var(--color-card-border);">${convertMarkdownToAccordion(baseText)}</div>`;
                addPostGenerationButtons(resultContainer, userPrompt, 'custom');
                
                if (selectedOptions.length > 0) {
                    const accordionContainer = resultContainer.querySelector('.prose-content .accordion');
                    
                    if (accordionContainer) { // Check if the accordion container exists
                        for (const option of selectedOptions) {
                            const loaderId = `loader-${option.replace(/\s+/g, '-')}`;
                            const componentLoader = document.createElement('div');
                            componentLoader.id = loaderId;
                            componentLoader.innerHTML = getLoaderHTML(`Generating section for ${option}...`);
                            accordionContainer.appendChild(componentLoader);

                            try {
                                const componentPrompt = `You are a yoga expert. Provide a detailed explanation and a practical guide for incorporating "${option}" into a yoga class. Structure the response with a '###' for the main heading (e.g., '### Incorporating ${option}'). Be creative and thorough.`;
                                const componentText = await callGeminiAPI(componentPrompt);
                                
                                const accordionHtml = convertMarkdownToAccordion(componentText, false);
                                const loaderElement = document.getElementById(loaderId);
                                if (loaderElement) {
                                    loaderElement.outerHTML = accordionHtml; // Replace loader with content
                                }


                                let currentText = originalGeneratedText.get(resultContainer) || "";
                                currentText += `\n\n${componentText}`;
                                originalGeneratedText.set(resultContainer, currentText);

                            } catch (componentError) {
                                const loaderElement = document.getElementById(loaderId);
                                if(loaderElement) {
                                   loaderElement.innerHTML = `<div class="p-4 text-red-500">Failed to generate section for <strong>${option}</strong>.</div>`;
                                }
                                console.error(`Error generating component for ${option}:`, componentError);
                            }
                        }
                    }
                }

            } catch (error) {
                resultContainer.innerHTML = `<p class="text-red-500 p-2">${generateErrorMessage(error, 'text')}</p>`;
            }
        }
        
        async function loadAITailoringOptions() {
            const container = document.getElementById('tailoring-buttons-container');
            if (!container || !checkApiKey(container)) return;
            container.innerHTML = getLoaderHTML('AI is generating tailoring options...');
            const fallbackOptions = ["Breathwork", "Essential Oils", "Chanting", "Poetry", "Props", "Meditation", "Mantra & Affirmations", "Partner Poses"];
            try {
                const prompt = `Generate a list of 20 unique yoga class components suitable for integration into a yoga app. The elements should enrich a user's practice, rather than being types of classes. Return ONLY a valid JSON array of strings, with no other text, explanation, or markdown formatting.`;
                const rawText = await callGeminiAPI(prompt);
                
                const match = rawText.match(/\[.*\]/s);
                if (!match) throw new Error("No JSON array found in the AI response.");
                const jsonString = match[0];

                const tailoringOptions = JSON.parse(jsonString);
                populateTailoringButtons(tailoringOptions);
            } catch (error) {
                console.error("Failed to load AI tailoring options, using fallback.", error);
                container.innerHTML = `<p class="text-amber-600 text-sm">Could not load AI options. Using defaults.</p>`;
                populateTailoringButtons(fallbackOptions);
            }
        }

        function populateTailoringButtons(options) { const container = document.getElementById('tailoring-buttons-container'); if (!container) return; container.innerHTML = ''; options.forEach(option => { const button = createButton(option, 'btn-toggle px-3 py-1.5 rounded-full text-sm'); button.dataset.option = option; button.addEventListener('click', (e) => { e.preventDefault(); button.classList.toggle('active'); }); container.appendChild(button); }); }
        
        // --- API Calls, UI Utilities, and other handlers ---
        async function callApi(apiUrl, payload) { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { const errorBody = await response.text(); console.error("API Error Response:", errorBody); throw new Error(`API request failed with status ${response.status}`); } return await response.json(); }
        async function callGeminiAPI(prompt) { const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, { contents: [{ parts: [{ text: prompt }] }] }); if (result.candidates?.[0]?.content?.parts?.[0]?.text) { return result.candidates[0].content.parts[0].text; } else if (result.candidates?.[0]?.finishReason === 'SAFETY') { throw new Error("Request blocked for safety reasons."); } throw new Error("Invalid response structure from Gemini API."); }
        async function callColorGenAPI(prompt) { const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } }); const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text; if (jsonText) return JSON.parse(jsonText.replace(/```json\n?|```/g, '').trim()); throw new Error("Could not parse a valid color theme from the AI's response."); }
        async function callImageGenAPI(prompt) { const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`, { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } }); const base64 = result.predictions?.[0]?.bytesBase64Encoded; if (base64) return `data:image/png;base64,${base64}`; throw new Error("Could not get a valid image from the AI's response."); }
        function checkApiKey(container) { if (!apiKey) { document.getElementById('apiKeyModal').classList.remove('hidden'); if(container) { container.innerHTML = `<p class="text-amber-600 p-2">Please enter your API key to continue.</p>`; } return false; } return true; }
        function getLoaderHTML(message) { return `<div class="flex justify-center items-center my-4"><div class="loader themed-loader"></div><p class="ml-4 themed-text-muted">${message}</p></div>`; }
        function createButton(text, className, type = 'button') { const button = document.createElement('button'); button.className = className; button.type = type; button.innerHTML = text; return button; }
        function robustMarkdownToHtml(text) { if (!text) return ''; let html = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); const paragraphs = html.split('\n').filter(p => p.trim() !== ''); html = ''; let inList = false; paragraphs.forEach(p => { const trimmed = p.trim(); if (trimmed.startsWith('- ') || trimmed.startsWith('* ')) { if (!inList) { html += '<ul>'; inList = true; } html += `<li>${trimmed.substring(2)}</li>`; } else { if (inList) { html += '</ul>'; inList = false; } html += `<p>${p}</p>`; } }); if(inList) { html += '</ul>'; } return html; }
        function convertMarkdownToAccordion(text, openFirst = true) { const sections = text.split(/^(?:###) /m).slice(1); if (sections.length === 0) return `<div class="accordion">${robustMarkdownToHtml(text)}</div>`; const accordionItems = sections.map((section, index) => { const parts = section.split('\n'); const title = parts[0].trim().replace(/\*+/g, ''); const content = parts.slice(1).join('\n'); const isOpen = openFirst && index === 0; return `<div class="accordion-item"><button class="accordion-header ${isOpen ? 'active' : ''}"><span>${title}</span><svg class="icon w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div class="accordion-content ${isOpen ? 'open' : ''}"><div class="prose max-w-none p-4">${robustMarkdownToHtml(content)}</div></div></div>`; }).join(''); return `<div class="accordion">${accordionItems}</div>`;}
        function generateErrorMessage(error, type = 'general') { console.error(`Error during ${type} generation:`, error); let message = `An unknown ${type} error occurred. Check the console for details.`; const errorMessage = error.message.toLowerCase(); if (errorMessage.includes('safety') || errorMessage.includes('blocked')) message = `The ${type} generation request was blocked for safety reasons. Please try a different prompt.`; else if (errorMessage.includes('400') && type === 'color') message = `The AI had trouble creating a color theme from that prompt. Try being more descriptive.`; else if (errorMessage.includes('api key not valid')) message = `Authentication failed. Your API Key is not valid. Please check it and try again.`; else if (errorMessage.includes('401') || errorMessage.includes('403')) message = `Authentication failed for ${type} generation. Check your API key.`; else if (errorMessage.includes('429')) message = `You have exceeded your request limit for ${type} generation. Please wait and try again.`; else if (errorMessage.includes('failed to fetch')) message = 'Network Error: Could not connect to the API.'; return `Sorry, something went wrong. ${message}`; }
        async function handleVisualThemeGeneration() { if (!checkApiKey()) return; const prompt = document.getElementById('theme-prompt').value.trim(); if (!prompt) { showThemeError("Please enter a description for your visual theme."); return; } showThemeLoading(true); const colorPrompt = `Based on the following text, generate a color palette that reflects its mood. I need a JSON object with keys: "bg", "text", "primary", "primaryDark", "accent", "cardBg", "cardBorder", "textMuted", "inputBg", "inputBorder", "buttonText". Ensure high contrast and accessibility. Return only the JSON. Text: "${prompt}"`; const imagePrompt = `A beautiful, artistic, abstract background image inspired by the concept of "${prompt}". The style should be suitable for a yoga and wellness website header. Serene, calming, and visually appealing. Wide aspect ratio, photographic, cinematic lighting.`; try { const [colorResult, imageResult] = await Promise.allSettled([callColorGenAPI(colorPrompt), callImageGenAPI(imagePrompt)]); if (colorResult.status === 'fulfilled') { applyTheme(colorResult.value); } else { showThemeError(generateErrorMessage(colorResult.reason, 'color')); } if (imageResult.status === 'fulfilled') { applyHeaderImage(imageResult.value); } else { showThemeError(generateErrorMessage(imageResult.reason, 'image')); } } catch (error) { showThemeError(generateErrorMessage(error, 'visual theme')); } finally { showThemeLoading(false); } }
        async function handleExploreInDepth(themeId, themeType) { const modal = document.getElementById('inDepthModal'); const modalContent = document.getElementById('inDepthModalContent'); if (!checkApiKey(modalContent)) return; const modalTitle = document.getElementById('inDepthModalTitle'); const modalFooter = document.getElementById('inDepthModalFooter'); const theme = (themeType === 'custom') ? { title: themeId, description: 'A custom user-generated theme.' } : allThemeData[themeType].find(t => t.id === themeId); modalTitle.textContent = `Exploring: ${theme.title}`; modalContent.innerHTML = getLoaderHTML('Generating your detailed guide...'); modalFooter.innerHTML = ''; modal.classList.remove('hidden'); const founderInfo = theme.founder ? `It was founded or popularized by ${theme.founder}.` : ''; const description = theme.description || theme.explanation; let datePromptSection = ''; const dateableThemes = ['seasons', 'holidays', 'easternHolidays', 'moonPhases']; if (dateableThemes.includes(themeType)) { datePromptSection = `The current year is ${new Date().getFullYear()}. First, as a standalone bolded line, state the next upcoming date for this event in the New York (EST) timezone for the current year.\n\n`; } const prompt = `${datePromptSection}You are a master yoga instructor creating a comprehensive and creative guide for a yoga class themed "${theme.title}", which is described as: "${description}". ${founderInfo}. Create a guide that is exceptionally thorough and inspiring for another yoga teacher. Please organize your guide into several logical sections using '###' for each main heading. The content, titles, and number of sections are entirely up to you to best suit the theme.`; try { const text = await callGeminiAPI(prompt); originalGeneratedText.set(modalContent, text); modalContent.innerHTML = `<div class="prose-content">${convertMarkdownToAccordion(text)}</div>`; addPostGenerationButtons(modalFooter, themeId, themeType); } catch (error) { modalContent.innerHTML = `<p class="text-red-500 p-2">${generateErrorMessage(error, 'text')}</p>`; } }
        async function handleAIHelpRequest() { const modal = document.getElementById('inDepthModal'); const modalContent = document.getElementById('inDepthModalContent'); if (!checkApiKey(modalContent)) return; const modalTitle = document.getElementById('inDepthModalTitle'); const modalFooter = document.getElementById('inDepthModalFooter'); modalTitle.textContent = "AI Help & Feedback"; modalContent.innerHTML = getLoaderHTML('Generating help and suggestions...'); modalFooter.innerHTML = ''; modal.classList.remove('hidden'); const pageStructure = document.getElementById('main-content').innerText; const prompt = `You are a helpful UI/UX assistant. Based on the text content and structure of the application provided below, please do two things: 1. **Explain How It Works:** Briefly describe the main features of this "AI Yoga Class & Theme Generator" application. 2. **Suggest Improvements:** Offer a few specific, actionable suggestions to improve the user interface (UI) and overall user experience (UX). Structure your response with two main sections using '###' markdown headings: '### How This App Works' and '### UI/UX Improvement Suggestions'. Here is the text content of the app:\n${pageStructure}`; try { const text = await callGeminiAPI(prompt); originalGeneratedText.set(modalContent, text); modalContent.innerHTML = `<div class="prose-content">${convertMarkdownToAccordion(text)}</div>`; const exportButton = createButton('Copy Text', 'btn-secondary'); exportButton.addEventListener('click', (e) => copyElementTextToClipboard(modalContent, e.currentTarget)); modalFooter.appendChild(exportButton); } catch (error) { modalContent.innerHTML = `<p class="text-red-500 p-2">${generateErrorMessage(error, 'text')}</p>`; } }
        
        function copyElementTextToClipboard(element, button) {
            if (!element) return;
            const textToCopy = element.innerText;
            
            // Create a temporary textarea element
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;

            // Make it invisible
            textArea.style.position = "fixed";
            textArea.style.top = 0;
            textArea.style.left = 0;
            textArea.style.width = "2em";
            textArea.style.height = "2em";
            textArea.style.padding = 0;
            textArea.style.border = "none";
            textArea.style.outline = "none";
            textArea.style.boxShadow = "none";
            textArea.style.background = "transparent";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful && button) {
                    const originalText = button.innerHTML;
                    button.innerHTML = '<span>Copied!</span>';
                    button.disabled = true;
                    setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 2000);
                } else if (!successful) {
                    console.error('Copy command was unsuccessful');
                }
            } catch (err) {
                console.error('Oops, unable to copy', err);
            }

            document.body.removeChild(textArea);
        }

        function addPostGenerationButtons(container, themeId, themeType) { 
            const buttonContainer = document.createElement('div'); 
            buttonContainer.className = 'button-actions-container flex flex-col md:flex-row gap-2 mt-6'; 
            const refineButton = createButton(`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="16 3 21 8 8 21 3 21 3 16 16 3"></polygon></svg> <span>Refine</span>`, 'btn-secondary w-full md:w-auto refine-button'); 
            const copyButton = createButton(`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span>Copy Text</span>`, 'btn-secondary w-full md:w-auto'); 
            copyButton.addEventListener('click', (e) => copyElementTextToClipboard(container.querySelector('.prose-content'), e.currentTarget)); 
            if(container.id !== 'inDepthModalFooter') { 
                const exploreButton = createButton('Explore in Depth', 'btn-primary w-full explore-button'); 
                exploreButton.dataset.themeId = themeId; 
                exploreButton.dataset.themeType = themeType; 
                buttonContainer.appendChild(exploreButton); 
            } 
            buttonContainer.appendChild(refineButton); 
            buttonContainer.appendChild(copyButton); 
            container.appendChild(buttonContainer); 
        }

        async function loadDynamicPlaceholders() { if (!apiKey) { return; } try { const prompt = `Generate two short, creative, and distinct yoga class theme ideas to be used as placeholder text in an input field. Return the result as a JSON object with two keys, "theme1" and "theme2". Example: {"theme1": "Embracing the winds of change", "theme2": "Finding stillness in the storm"}`; const jsonText = await callGeminiAPI(prompt); const themes = JSON.parse(jsonText.replace(/```json\n?|```/g, '').trim()); if (themes.theme1) document.getElementById('theme-prompt').placeholder = `e.g., '${themes.theme1}'`; if (themes.theme2) document.getElementById('gemini-prompt').placeholder = `e.g., '${themes.theme2}'`; } catch (error) { console.error("Could not load dynamic placeholders:", error); } }
        function applyTheme(colors) { Object.keys(colors).forEach(key => { const cssVarName = '--color-' + key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`); root.style.setProperty(cssVarName, colors[key]); }); }
        
        function applyHeaderImage(imageUrl) {
            const headerBg = document.getElementById('header-bg-image');
            headerBg.style.opacity = 0; // Fade out
            
            // Preload the image
            const img = new Image();
            img.onload = () => {
                // When loaded, set as background and fade in
                headerBg.style.backgroundImage = `url('${imageUrl}')`;
                headerBg.style.opacity = 1; // Fade in
            };
            img.src = imageUrl;
        }

        function showThemeLoading(isLoading) { document.getElementById('theme-loader-container').classList.toggle('hidden', !isLoading); document.getElementById('header-loader').classList.toggle('hidden', !isLoading); document.getElementById('header-loader').classList.toggle('flex', isLoading); document.getElementById('generate-theme-btn').disabled = isLoading; document.getElementById('generate-theme-btn').classList.toggle('opacity-50', isLoading); }
        function showThemeError(message) { const el = document.getElementById('theme-error-container'); el.textContent = message; el.classList.remove('hidden'); }
        function getIconForTheme(themeType, themeId) { /* A simple SVG icon system */ const defaultIcon = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>`; const icons = { styles: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.5 16.5a2 2 0 100-4 2 2 0 000 4zM18.5 16.5a2 2 0 100-4 2 2 0 000 4zM2 10h2.5M19.5 10H22M12 2v2.5M12 19.5V22M4.5 4.5l2 2M17.5 4.5l-2 2M4.5 19.5l2-2M17.5 19.5l-2-2"></path>`, holidays: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>`, easternHolidays: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>` }; return `<svg class="themed-text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">${icons[themeType] || defaultIcon}</svg>`; }
        function getNextHolidayDate(holiday) { const now = new Date(); const currentYear = now.getFullYear(); const [month, day] = holiday.date.split('/').map(Number); let holidayDate = new Date(currentYear, month - 1, day); if (holidayDate < now) { holidayDate.setFullYear(currentYear + 1); } return holidayDate; }

        // --- Data ---
        function getModalitiesSeedData() { const csvData = `Modality,Founder/Key Figure,Description\nBhakti Yoga,,"The path of devotion and love."\nJnana Yoga,,"The path of knowledge and wisdom."\nKarma Yoga,,"The path of selfless action."\nRaja Yoga,,"The ""royal path"" of meditation and self-control."\nHatha Yoga,,"A general term for a slower-paced, foundational yoga class."\nTantra Yoga,,"Weaving together the physical and spiritual realms."\nYoga Nidra,,"Yogic sleep for deep relaxation."\nAshtanga Vinyasa Yoga,Sri K. Pattabhi Jois,"A rigorous and physically demanding style."\nIyengar Yoga,B.K.S. Iyengar,"Emphasis on precise anatomical alignment and props."\nViniyoga,T.K.V. Desikachar,"A therapeutic and highly individualized approach."\nSivananda Yoga,Swami Sivananda,"A holistic system based on five principles."\nKripalu Yoga,Swami Kripalu,"A gentle and introspective practice."\nVinyasa Yoga,,"A dynamic and flowing style where movement is synchronized with the breath."\nPower Yoga,,"An athletic and vigorous style of Vinyasa yoga."\nBikram Yoga,,"A specific sequence of 26 postures in a heated room."\nHot Yoga,,"Any style of yoga practiced in a heated environment."\nYin Yoga,,"A slow-paced, passive style where poses are held for longer periods."\nRestorative Yoga,,"A gentle and therapeutic practice that uses props extensively."\nJivamukti Yoga,David Life & Sharon Gannon,"A physically vigorous and intellectually stimulating style."\nAnusara Yoga,John Friend,"Emphasizes ""Universal Principles of Alignment"" and a heart-oriented philosophy."\nKundalini Yoga,Yogi Bhajan,"A dynamic practice to awaken energy at the base of the spine."\nAcroYoga,,"A partner-based practice blending yoga and acrobatics."\nAerial Yoga,,"Uses a silk hammock to support the body in various postures."\nChair Yoga,,"A modified form of yoga practiced while sitting in a chair."\nPrenatal Yoga,,"A gentle style designed specifically for pregnant women."\nForrest Yoga,Ana T. Forrest,"An intensely physical and internally focused style."`; const lines = csvData.trim().split('\n').slice(1); return lines.map(line => { const [title, founder, description] = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(field => field.trim().replace(/^"|"$/g, '')); return { id: title.toLowerCase().replace(/[^a-z0-9]+/g, '-'), title: title, founder: founder, description: description }; }); }
        function getChakrasSeedData() { return [ { id: "muladhara", title: "Muladhara (Root)", explanation: "This class is designed to connect you to the earth, fostering a sense of security and stability." }, { id: "svadhisthana", title: "Svadhisthana (Sacral)", explanation: "Unleash your creative potential and embrace the flow of life." }, { id: "manipura", title: "Manipura (Solar Plexus)", explanation: "This empowering class is dedicated to activating the center of our personal power and self-esteem." }, { id: "anahata", title: "Anahata (Heart)", explanation: "Cultivate love, compassion, and connection in this heart-opening class." }, { id: "vishuddha", title: "Vishuddha (Throat)", explanation: "Find your voice and speak your truth in this class dedicated to the throat chakra." }, { id: "ajna", title: "Ajna (Third Eye)", explanation: "This introspective class is designed to awaken the center of intuition and inner wisdom." }, { id: "sahasrara", title: "Sahasrara (Crown)", explanation: "Experience a sense of unity and connection to something greater than yourself." } ]; }
        function getMeridiansSeedData() { return [ { id: "lung-large-intestine", title: "Lung & Large Intestine", explanation: "This class uses poses that open the chest, shoulders, and arms, along with twists, to process grief and cultivate release." }, { id: "stomach-spleen", title: "Stomach & Spleen", explanation: "This grounding class uses poses that stretch the front of the body and stabilize the core to aid digestion and nourishment." }, { id: "heart-small-intestine", title: "Heart & Small Intestine", explanation: "This class uses joyful, expansive heart-openers and poses that move through the arms and shoulders to cultivate joy." }, { id: "kidney-bladder", title: "Kidney & Bladder", explanation: "This deep, restorative class uses forward folds and gentle backbends to tap into our life force." }, { id: "pericardium-triple-burner", title: "Pericardium & Triple Burner", explanation: "This class focuses on creating healthy boundaries and balancing the body's systems." }, { id: "liver-gallbladder", title: "Liver & Gallbladder", explanation: "This dynamic class uses twists and side-body stretches to help with planning and decisiveness." } ]; }
        function getSeasonsSeedData() { return [ { id: "spring-equinox", title: "Spring Equinox", date: "03/20", explanation: "This class focuses on renewal, growth, and setting new intentions for the season of awakening." }, { id: "summer-solstice", title: "Summer Solstice", date: "06/20", explanation: "Celebrate the peak of the sun's energy with this vibrant and expansive yoga class." }, { id: "autumn-equinox", title: "Autumn Equinox", date: "09/22", explanation: "This class encourages introspection, balance, and the art of letting go of what no longer serves us." }, { id: "winter-solstice", title: "Winter Solstice", date: "12/21", explanation: "Honor the darkest day of the year with this deeply restorative and introspective yoga class." } ]; }
        function getHolidaysSeedData() { return [ { id: "new-years-day", title: "New Year's Day", date: "01/01", explanation: "A practice to set intentions, release the old, and welcome new beginnings." }, { id: "martin-luther-king-jr-day", title: "Martin Luther King, Jr. Day", date: "01/20", explanation: "A practice focused on equality, justice, and compassionate action." }, { id: "valentines-day", title: "Valentine's Day", date: "02/14", explanation: "A heart-opening practice to cultivate self-love and connection with others." }, { id: "presidents-day", title: "Presidents' Day", date: "02/17", explanation: "A practice to cultivate leadership qualities like integrity and clarity." }, { id: "st-patricks-day", title: "St. Patrick's Day", date: "03/17", explanation: "A playful practice focused on luck, abundance, and finding the pot of gold within." }, { id: "easter", title: "Easter", date: "04/20", explanation: "A practice themed around renewal, rebirth, and new possibilities." }, { id: "mothers-day", title: "Mother's Day", date: "05/11", explanation: "A nurturing practice to honor the divine feminine and motherly energy." }, { id: "memorial-day", title: "Memorial Day", date: "05/26", explanation: "A practice of remembrance, gratitude, and honoring sacrifice." }, { id: "juneteenth", title: "Juneteenth", date: "06/19", explanation: "A practice centered on freedom, liberation, and celebrating progress." }, { id: "fathers-day", title: "Father's Day", date: "06/15", explanation: "A practice to cultivate strength, stability, and supportive energy." }, { id: "independence-day", title: "Independence Day (4th of July)", date: "07/04", explanation: "A practice celebrating freedom, inner fire, and joyful expression." }, { id: "labor-day", title: "Labor Day", date: "09/01", explanation: "A practice to honor our work, find balance, and enjoy the fruits of our labor." }, { id: "halloween", title: "Halloween", date: "10/31", explanation: "A practice to play with shadows, embrace transformation, and reveal our true selves." }, { id: "veterans-day", title: "Veterans Day", date: "11/11", explanation: "A practice of gratitude and respect for those who have served." }, { id: "thanksgiving", title: "Thanksgiving", date: "11/27", explanation: "A practice overflowing with gratitude, abundance, and mindful consumption." }, { id: "christmas", title: "Christmas", date: "12/25", explanation: "A practice of peace, joy, and connecting to the light within." } ]; }
        function getHinduHolidaysSeedData() { return [ { id: "diwali", title: "Diwali", date: "10/20", explanation: "The festival of lights, celebrating the victory of light over darkness and good over evil." }, { id: "holi", title: "Holi", date: "03/14", explanation: "The festival of colors, celebrating spring, love, and new life." }, { id: "navaratri", title: "Navaratri", date: "09/22", explanation: "A nine-night festival dedicated to the worship of the goddess Durga." }, { id: "raksha-bandhan", title: "Raksha Bandhan", date: "08/19", explanation: "Celebrating the bond between brothers and sisters." }, { id: "ganesh-chaturthi", title: "Ganesh Chaturthi", date: "08/27", explanation: "Celebrating the birth of Lord Ganesha, the remover of obstacles." }, { id: "janmashtami", title: "Janmashtami", date: "08/26", explanation: "Celebrating the birth of Lord Krishna." }, { id: "maha-shivaratri", title: "Maha Shivaratri", date: "02/26", explanation: "The great night of Shiva, a day of introspection and meditation." } ]; }
        function getBuddhistHolidaysSeedData() { return [ { id: "vesak", title: "Vesak (Buddha Day)", date: "05/12", explanation: "Commemorating the birth, enlightenment, and death of Gautama Buddha." }, { id: "dharma-day", title: "Dharma Day (Asalha Puja)", date: "07/11", explanation: "Commemorates the Buddha's first sermon." }, { id: "sangha-day", title: "Sangha Day (Magha Puja)", date: "02/12", explanation: "Commemorates the first gathering of the Buddha's enlightened disciples." }, { id: "parinirvana-day", title: "Parinirvana Day", date: "02/15", explanation: "Observes the death of the Buddha and his attainment of final nirvana." }, { id: "bodhi-day", title: "Bodhi Day", date: "12/08", explanation: "Commemorating the day that the historical Buddha experienced enlightenment." } ]; }
        function getMoonPhasesSeedData() { return [ { id: "new-moon", title: "New Moon", explanation: "A time for setting intentions, new beginnings, and planting seeds for the future." }, { id: "waxing-crescent", title: "Waxing Crescent", explanation: "A time to build momentum, refine intentions, and take initial actions." }, { id: "first-quarter", title: "First Quarter", explanation: "A time for decision-making, meeting challenges, and pushing through resistance." }, { id: "waxing-gibbous", title: "Waxing Gibbous", explanation: "A time of refinement, adjustment, and building anticipation for fullness." }, { id: "full-moon", title: "Full Moon", explanation: "A time of peak energy, illumination, celebration, and releasing what no longer serves." }, { id: "waning-gibbous", title: "Waning Gibbous", explanation: "A time for gratitude, sharing wisdom, and beginning to let go." }, { id: "last-quarter", title: "Last Quarter", explanation: "A time for release, forgiveness, and cleansing before the new cycle." }, { id: "waning-crescent", title: "Waning Crescent", explanation: "A time for surrender, rest, and introspection before the new moon." } ]; }
    </script>
</body>
</html>
