<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yoga Class Themer v2.3</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            border: 1px solid #e9d5ff; /* Purple 200 */
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .card-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .btn-primary {
            background-color: #9333ea; /* Purple 600 */
            color: white;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #7e22ce; /* Purple 700 */
        }
        .theme-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="%23c084fc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>'); /* Purple 400 */
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
        .header-bg-image {
            background-image: url('https://i.ibb.co/gFXPP4Gt/Image-fx-88.png');
            background-size: cover;
            background-position: center;
        }
        /* Styles for generated prose content */
        .prose h1, .prose h2, .prose h3, .prose h4 {
            color: #581c87; /* Purple 900 */
        }
        .prose ul {
            padding-left: 1.5rem;
        }
        .prose li {
            margin-bottom: 0.5rem;
        }
        /* Styles for AI results tabs */
        .ai-tabs .tab-button {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #6b7280; /* Gray 500 */
            font-weight: 500;
        }
        .ai-tabs .tab-button.active {
            color: #9333ea; /* Purple 600 */
            border-color: #9333ea;
        }
        .ai-tabs .tab-content {
            display: none;
        }
        .ai-tabs .tab-content.active {
            display: block;
        }
        /* Accordion Styles */
        .accordion-item {
            border-bottom: 1px solid #e5e7eb; /* Gray 200 */
        }
        .accordion-item:last-child {
            border-bottom: none;
        }
        .accordion-header {
            width: 100%;
            text-align: left;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #374151; /* Gray 700 */
            background-color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .accordion-header:hover {
            background-color: #f9fafb; /* Gray 50 */
        }
        .accordion-content {
            padding: 0 1rem 1rem 1rem;
            display: none; /* Hidden by default */
            background-color: white;
        }
        .accordion-content.open {
            display: block;
        }
        .accordion-header .icon {
            transition: transform 0.3s ease;
            width: 1.25rem;
            height: 1.25rem;
        }
        .accordion-header.active .icon {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-purple-50 text-gray-800">

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Enter Your API Key</h2>
            <p class="mb-6 text-gray-600">To use the AI theme generator, please provide your Gemini API key. This key is only stored for your current session.</p>
            <form id="apiKeyForm">
                <input type="password" id="apiKeyInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Your Gemini API Key" required>
                <button type="submit" class="w-full btn-primary mt-6">Save Key and Start</button>
            </form>
        </div>
    </div>
    
    <!-- In-Depth Details Modal -->
    <div id="inDepthModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 id="inDepthModalTitle" class="text-2xl font-bold text-gray-800">In-Depth Exploration</h2>
                <button id="closeInDepthModal" class="text-gray-500 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="inDepthModalContent" class="p-6 overflow-y-auto prose max-w-none">
                <!-- AI generated content will go here -->
            </div>
        </div>
    </div>


    <!-- Main Content -->
    <div class="container mx-auto p-4 md:p-8">
        
        <!-- Header with Background Image -->
        <header class="relative text-center mb-10 rounded-2xl overflow-hidden shadow-lg">
            <div class="absolute inset-0 header-bg-image"></div>
            <div class="absolute inset-0 bg-purple-900 opacity-50"></div>
            <div class="relative z-10 p-12 text-white">
                 <h1 class="text-4xl md:text-5xl font-bold flex items-center justify-center gap-4" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                    <svg class="w-10 h-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 4.5l7.5 7.5-7.5 7.5m-6-15l7.5 7.5-7.5 7.5" />
                    </svg>
                    Yoga Class Theme Generator
                </h1>
                <p class="text-lg text-purple-200 mt-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Find inspiration for your next 1-hour yoga class.</p>
            </div>
            <div id="version-display" class="absolute bottom-2 right-4 text-white text-xs opacity-70">v2.3</div>
        </header>

        <!-- Rounded Canvas for Cards -->
        <main id="main-content" class="bg-white/50 backdrop-blur-md rounded-2xl p-6 md:p-10 shadow-xl border border-purple-100">
            <div class="space-y-8">
                <!-- Gemini AI Card (Full Width) -->
                <div class="card">
                    <div class="p-8 card-content">
                        <h2 class="text-2xl font-bold mb-2 text-purple-600">AI-Powered Theme Generator</h2>
                        <p class="mb-6 text-gray-600">Feeling creative? Enter a keyword or concept, and let Gemini craft a unique 1-hour class plan for you.</p>
                        
                        <form id="gemini-form">
                            <div class="mb-4">
                                <label for="gemini-prompt" class="block text-sm font-medium text-gray-700 mb-1">Enter a theme idea:</label>
                                <input type="text" id="gemini-prompt" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="e.g., 'Courage & Heart Opening'">
                            </div>
                            <button type="submit" class="btn-primary w-full">Generate AI Theme</button>
                        </form>
                        
                        <div id="gemini-result-container" class="mt-6 text-gray-700">
                             <!-- New AI results layout will appear here -->
                        </div>
                    </div>
                </div>

                <!-- Grid for Theme Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8">
                     <!-- Chakras Card -->
                    <div class="card">
                        <div class="p-8 card-content">
                            <h2 class="text-2xl font-bold mb-2 text-purple-600">The Seven Chakras</h2>
                            <p class="mb-6 text-gray-600">Balance and activate the seven primary energy centers in the body.</p>
                            
                            <div class="mb-6 mt-auto">
                                <label for="chakras-select" class="block text-sm font-medium text-gray-700 mb-1">Select a Chakra Theme:</label>
                                <select id="chakras-select" data-theme-type="chakras" class="theme-select w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">-- Choose a chakra --</option>
                                </select>
                            </div>

                            <div id="chakras-details" class="details-container prose max-w-none text-gray-700"></div>
                        </div>
                    </div>

                    <!-- Meridians Card -->
                    <div class="card">
                        <div class="p-8 card-content">
                            <h2 class="text-2xl font-bold mb-2 text-purple-600">The Twelve Meridians</h2>
                            <p class="mb-6 text-gray-600">Explore the major meridians of Traditional Chinese Medicine.</p>
                            
                            <div class="mb-6 mt-auto">
                                <label for="meridian-select" class="block text-sm font-medium text-gray-700 mb-1">Select a Meridian Theme:</label>
                                <select id="meridian-select" data-theme-type="meridians" class="theme-select w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">-- Choose a flow --</option>
                                </select>
                            </div>

                            <div id="meridian-details" class="details-container prose max-w-none text-gray-700"></div>
                        </div>
                    </div>

                    <!-- Seasons Card -->
                    <div class="card">
                        <div class="p-8 card-content">
                            <h2 class="text-2xl font-bold mb-2 text-purple-600">The Four Seasons</h2>
                            <p class="mb-6 text-gray-600">Align your practice with the natural cycles of the earth.</p>
                            
                            <div class="mb-6 mt-auto">
                                <label for="seasons-select" class="block text-sm font-medium text-gray-700 mb-1">Select a Season Theme:</label>
                                <select id="seasons-select" data-theme-type="seasons" class="theme-select w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">-- Choose a season --</option>
                                </select>
                            </div>

                            <div id="seasons-details" class="details-container prose max-w-none text-gray-700"></div>
                        </div>
                    </div>

                    <!-- Breathwork Card -->
                    <div class="card">
                        <div class="p-8 card-content">
                            <h2 class="text-2xl font-bold mb-2 text-purple-600">Breathwork Library</h2>
                            <p class="mb-6 text-gray-600">Explore powerful breathing techniques from various modalities to deepen your practice.</p>
                            <button id="generate-breathwork-btn" class="btn-primary w-full mt-auto">Generate Breathwork Techniques</button>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // --- App Version: 2.3 ---
        // Changelog:
        // v2.3: Modernized AI result UX with a tabbed interface. Added a "Breathwork" theme generator. Updated poem prompt to source from published spiritualists. Displayed version number. Enhanced in-depth modal with accordion layout and fixed rendering.
        // v2.2: Adjusted AI prompt and rendering function for better readability.
        // v2.1: Added Affirmations, Poem, and Quotations to the main AI theme generator.
        // v2.0: Added "Explore in Depth" feature with a dedicated modal for detailed AI generation.
    
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyA8jslbCV4JB1oIpg9yUbv_AwcyksObvf0",
            authDomain: "yoga-themes.firebaseapp.com",
            projectId: "yoga-themes",
            storageBucket: "yoga-themes.appspot.com",
            messagingSenderId: "62280816461",
            appId: "1:62280816461:web:9f137f448ebe8508dc4904",
            measurementId: "G-T8MBGPWSV4"
        };
        
        // --- Global Variables ---
        let db;
        let auth;
        let userId;
        let geminiApiKey = "";

        const allThemeData = {
            chakras: getChakrasSeedData(),
            meridians: getMeridiansSeedData(),
            seasons: getSeasonsSeedData()
        };

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            populateChakrasDropdown();
            populateMeridianDropdown();
            populateSeasonsDropdown();
            
            initializeFirebase();
            setupEventListeners();
        });

        function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        seedAllCollections();
                    } else {
                        signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
            }
        }
        
        async function seedAllCollections() {
            await Promise.all([
                seedCollection('public_themes/chakras/themes', allThemeData.chakras),
                seedCollection('public_themes/meridians/themes', allThemeData.meridians),
                seedCollection('public_themes/seasons/themes', allThemeData.seasons)
            ]);
        }

        async function seedCollection(path, seedData) {
            if (!db) return;
            const collectionRef = collection(db, path);
            try {
                const docSnap = await getDocs(collectionRef);
                if (docSnap.empty) {
                    const seedPromises = seedData.map(item => setDoc(doc(collectionRef, item.id), item));
                    await Promise.all(seedPromises);
                }
            } catch (error) {
                 console.error(`Error seeding collection ${path}:`, error);
            }
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            document.getElementById('apiKeyForm').addEventListener('submit', handleApiKeySubmit);
            document.getElementById('chakras-select').addEventListener('change', handleDropdownSelect);
            document.getElementById('meridian-select').addEventListener('change', handleDropdownSelect);
            document.getElementById('seasons-select').addEventListener('change', handleDropdownSelect);
            document.getElementById('gemini-form').addEventListener('submit', handleGeminiSubmit);
            document.getElementById('generate-breathwork-btn').addEventListener('click', handleBreathworkGenerate);
            
            const modal = document.getElementById('inDepthModal');
            modal.addEventListener('click', (e) => {
                // Close modal button
                if (e.target.closest('#closeInDepthModal')) {
                    modal.classList.add('hidden');
                }
                // Accordion header toggle
                const header = e.target.closest('.accordion-header');
                if (header) {
                    const content = header.nextElementSibling;
                    header.classList.toggle('active');
                    content.classList.toggle('open');
                }
            });

            document.getElementById('main-content').addEventListener('click', (e) => {
                if (e.target.classList.contains('explore-button')) {
                    const themeId = e.target.dataset.themeId;
                    const themeType = e.target.dataset.themeType;
                    handleExploreInDepth(themeId, themeType);
                }
            });

            // Event delegation for dynamically created tabs
            document.getElementById('gemini-result-container').addEventListener('click', (e) => {
                if (e.target.matches('.tab-button')) {
                    const tabContainer = e.target.closest('.ai-tabs');
                    tabContainer.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
                    e.target.classList.add('active');

                    tabContainer.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    const targetContentId = e.target.dataset.target;
                    document.getElementById(targetContentId).classList.add('active');
                }
            });
        }

        // --- Event Handlers ---
        function handleApiKeySubmit(e) {
            e.preventDefault();
            const input = document.getElementById('apiKeyInput');
            if (input.value.trim()) {
                geminiApiKey = input.value.trim();
                document.getElementById('apiKeyModal').classList.add('hidden');
            }
        }
        
        function handleDropdownSelect(e) {
            const themeId = e.target.value;
            const themeType = e.target.dataset.themeType;
            const theme = allThemeData[themeType].find(t => t.id === themeId);
            const container = e.target.parentElement.nextElementSibling;
            displayThemeDetails(theme, container, themeType);
        }

        async function handleGeminiSubmit(e) {
            e.preventDefault();
            if (!geminiApiKey) {
                document.getElementById('apiKeyModal').classList.remove('hidden');
                return;
            }
            const promptInput = document.getElementById('gemini-prompt');
            const resultContainer = document.getElementById('gemini-result-container');
            const userPrompt = promptInput.value.trim();
            if (!userPrompt) {
                 resultContainer.innerHTML = `<p class="text-amber-600">Please enter a theme idea.</p>`;
                return;
            }
            resultContainer.innerHTML = '<p class="text-center">Generating your class plan... ✨</p>';
            
            const fullPrompt = `
Generate a comprehensive yoga class theme based on the idea: "${userPrompt}".
Please provide the following, formatted using Markdown, with clear headings for each section.

## Other Ideas to Search for
Suggest 5 other ideas to search for that are similar to "${userPrompt}". Use a bulleted list.

## Creative Inspiration
### Affirmations
Suggest 5 powerful affirmations related to "${userPrompt}".

### Poem
Find a short, meaningful, published poem from a known spiritualist or poet (e.g., Rumi, Hafiz, Mary Oliver) that is inspired by "${userPrompt}". Credit the author.

### Quotations
Provide 5 insightful quotations that resonate with the theme of "${userPrompt}".

## Class Elements
### Asana
Suggest 15 poses (a mix of yin and yang). For each pose, provide its name in bold followed by a short description. Use a bulleted list.

### Essential Oils
Suggest 5 essential oils. For each oil, provide its name in bold followed by its benefits for this theme. Use a bulleted list.

### Music
Suggest 5 songs. For each song, list the **Title**, **Artist**, and **Genre**. Use a bulleted list.
`;
            
            try {
                const text = await callGeminiAPI(fullPrompt);
                renderAIGeneratedTabs(text, resultContainer);
            } catch (error) {
                console.error("Error calling Gemini API for main theme:", error);
                resultContainer.innerHTML = `<p class="text-red-500">Sorry, something went wrong. Check the console for details. Ensure your API key is correct and has the Gemini API enabled.</p>`;
            }
        }

        async function handleBreathworkGenerate() {
            if (!geminiApiKey) {
                document.getElementById('apiKeyModal').classList.remove('hidden');
                return;
            }
            const modal = document.getElementById('inDepthModal');
            const modalTitle = document.getElementById('inDepthModalTitle');
            const modalContent = document.getElementById('inDepthModalContent');

            modalTitle.textContent = `Breathwork Techniques`;
            modalContent.innerHTML = '<p class="text-center">Generating breathwork library... ✨</p>';
            modal.classList.remove('hidden');

            const prompt = `
Based on your comprehensive knowledge of breathwork, generate 5 distinct breathing techniques from various modalities. For each technique, please provide:
1.  **Name of the Technique:** The common name for the practice.
2.  **Modality of Origin:** Clearly state the modality it comes from (e.g., Pranayama, Holotropic Breathwork, Wim Hof Method, Buteyko, etc.).
3.  **Instructional Process:** Write a clear, step-by-step process for a yoga instructor to guide a student through this technique. Use simple, direct language.

Format the entire response in Markdown, with a clear heading for each of the 5 techniques.
`;
            try {
                const text = await callGeminiAPI(prompt);
                modalContent.innerHTML = convertMarkdownToAccordion(text, false);
            } catch (error) {
                console.error(`Error calling Gemini API for breathwork:`, error);
                modalContent.innerHTML = `<p class="text-red-500">Sorry, something went wrong generating the techniques. Please check the console for more information.</p>`;
            }
        }
        
        async function handleExploreInDepth(themeId, themeType) {
            if (!geminiApiKey) {
                document.getElementById('apiKeyModal').classList.remove('hidden');
                return;
            }
            
            const theme = allThemeData[themeType]?.find(t => t.id === themeId);
            if (!theme) {
                console.error("Theme not found for exploration:", themeId, themeType);
                return;
            }

            const modal = document.getElementById('inDepthModal');
            const modalTitle = document.getElementById('inDepthModalTitle');
            const modalContent = document.getElementById('inDepthModalContent');

            modalTitle.textContent = `Exploring: ${theme.title}`;
            
            let ideasHtml = '<ul class="list-disc list-inside space-y-1">';
            for (const [key, value] of Object.entries(theme.ideas)) {
                ideasHtml += `<li><strong>${key}:</strong> ${value}</li>`;
            }
            ideasHtml += '</ul>';

            const initialContentHtml = `
                <div class="p-4 mb-4 bg-purple-50 rounded-lg border border-purple-200">
                    <h3 class="text-xl font-bold mb-2 text-purple-600">Theme Summary</h3>
                    <p class="mb-3">${theme.explanation}</p>
                    <p class="mb-3"><strong>Suggested Oils:</strong> ${theme.oils}</p>
                    <h4 class="text-lg font-semibold mb-2 text-gray-800">Themed Ideas:</h4>
                    ${ideasHtml}
                </div>
                <div id="ai-generated-content">
                    <p class="text-center">Generating your detailed guide... ✨</p>
                </div>
            `;
            modalContent.innerHTML = initialContentHtml;
            modal.classList.remove('hidden');

            const prompt = `
You are a knowledgeable yoga instructor. Provide a detailed exploration of the yoga theme: "${theme.title}".
Your explanation should be comprehensive and suitable for a yoga teacher.
Please cover the following aspects in detail, using Markdown with ### headings for each section:

### Core Concepts
Explain its historical, philosophical, or energetic background.

### Thematic Connection to Yoga
Discuss the mind-body-spirit connection it emphasizes.

### Energetic & Emotional Landscape
What are the energetic qualities and emotional states associated with this theme?

### Asana (Pose) Application
Suggest 5 key poses. For each, explain in detail *why* it's a good fit.

### Pranayama & Meditation
Suggest a specific pranayama technique and a meditation focus that would deepen the experience.
`;

            try {
                const text = await callGeminiAPI(prompt);
                document.getElementById('ai-generated-content').innerHTML = convertMarkdownToAccordion(text);
            } catch (error) {
                console.error(`Error calling Gemini API for in-depth theme "${theme.title}":`, error);
                document.getElementById('ai-generated-content').innerHTML = `<p class="text-red-500">Sorry, something went wrong generating the detailed guide. Please check the console.</p>`;
            }
        }

        async function callGeminiAPI(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorBody = await response.json();
                console.error("API Error Response:", errorBody);
                throw new Error(`API request failed with status ${response.status}`);
            }
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text;
            } else {
               console.error("Invalid API Response Structure:", result);
               throw new Error("Invalid response structure from API.");
            }
        }

        // --- UI Population Functions ---
        function populateDropdown(selectId, data, placeholder) {
            const selectElement = document.getElementById(selectId);
            selectElement.innerHTML = `<option value="">-- ${placeholder} --</option>`;
            data.sort((a, b) => a.title.localeCompare(b.title));
            data.forEach(theme => {
                const option = document.createElement('option');
                option.value = theme.id;
                option.textContent = theme.title;
                selectElement.appendChild(option);
            });
        }
        function populateChakrasDropdown() { populateDropdown('chakras-select', allThemeData.chakras, 'Choose a chakra'); }
        function populateMeridianDropdown() { populateDropdown('meridian-select', allThemeData.meridians, 'Choose a flow'); }
        function populateSeasonsDropdown() { populateDropdown('seasons-select', allThemeData.seasons, 'Choose a season'); }

        function displayThemeDetails(theme, container, themeType) {
            if (!theme) {
                container.innerHTML = '';
                return;
            }
            let ideasHtml = '<ul class="space-y-2">';
            for (const [key, value] of Object.entries(theme.ideas)) {
                ideasHtml += `<li><strong class="text-gray-800">${key}:</strong> ${value}</li>`;
            }
            ideasHtml += '</ul>';
            container.innerHTML = `
                <h3 class="text-xl font-bold mt-4 mb-2 text-purple-500">${theme.title}</h3>
                <p class="mb-4">${theme.explanation}</p>
                <p class="mb-4"><strong>Suggested Oils:</strong> ${theme.oils}</p>
                <h4 class="text-lg font-semibold mb-2 text-gray-800">Themed Ideas:</h4>
                ${ideasHtml}
                <button class="btn-primary w-full mt-4 explore-button" data-theme-id="${theme.id}" data-theme-type="${themeType}">Explore in Depth with AI</button>
            `;
        }
        
        function renderAIGeneratedTabs(markdownText, container) {
            const sections = {};
            const chunks = markdownText.split(/^## /m);
            chunks.slice(1).forEach(chunk => {
                const parts = chunk.split(/\n/);
                const title = parts[0].trim();
                const content = parts.slice(1).join('\n');
                sections[title] = content;
            });
            
            const tabButtonsHtml = `
                <button class="tab-button active" data-target="tab-content-inspiration">Inspiration</button>
                <button class="tab-button" data-target="tab-content-class">Class Plan</button>
            `;

            const inspirationContent = `
                ## Creative Inspiration
                ${sections['Creative Inspiration'] || ''}
                ## Other Ideas to Search for
                ${sections['Other Ideas to Search for'] || ''}
            `;

            const classContent = `
                ## Class Elements
                ${sections['Class Elements'] || ''}
            `;
            
            const tabContentsHtml = `
                <div id="tab-content-inspiration" class="tab-content active p-4 border-t prose max-w-none">${robustMarkdownToHtml(inspirationContent)}</div>
                <div id="tab-content-class" class="tab-content p-4 border-t prose max-w-none">${robustMarkdownToHtml(classContent)}</div>
            `;
            
            container.innerHTML = `
                <div class="ai-tabs mt-4 border border-gray-200 rounded-lg">
                    <div class="flex border-b border-gray-200 bg-gray-50/50 rounded-t-lg">
                        ${tabButtonsHtml}
                    </div>
                    <div>
                        ${tabContentsHtml}
                    </div>
                </div>
            `;
        }

        // --- Utility Functions ---
        function convertMarkdownToAccordion(text, openFirst = true) {
            const sections = text.split(/^(?:##|###) /m).slice(1);
            if (sections.length === 0) return robustMarkdownToHtml(text);

            return sections.map((section, index) => {
                const parts = section.split('\n');
                const title = parts[0].trim();
                const content = parts.slice(1).join('\n');
                const isOpen = openFirst && index === 0;

                return `
                <div class="accordion-item">
                    <button class="accordion-header ${isOpen ? 'active' : ''}">
                        <span>${title}</span>
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="accordion-content ${isOpen ? 'open' : ''}">
                        ${robustMarkdownToHtml(content)}
                    </div>
                </div>
                `;
            }).join('');
        }

        function robustMarkdownToHtml(text) {
            if (!text) return '';
            let html = text.trim();

            // Headings
            html = html.replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mt-6 mb-3">$1</h2>');

            // Bold and Italic
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Lists - Process entire list blocks at once
            html = html.replace(/(\n?^\s*\*.*)+/g, (match) => {
                const listItems = match.trim().split('\n').map(item => {
                    return `<li>${item.replace(/^\s*\*\s*/, '')}</li>`;
                }).join('');
                return `<ul class="list-disc list-inside space-y-1 my-4">${listItems}</ul>`;
            });
            
            // Replace remaining newlines with paragraphs, avoiding those inside HTML tags
            html = html.split('\n').map(line => {
                const trimmed = line.trim();
                if (!trimmed) return '';
                if (trimmed.startsWith('<h') || trimmed.startsWith('<ul') || trimmed.startsWith('<li')) {
                    return line; // Don't wrap already-tagged lines
                }
                return `<p>${line}</p>`; // Wrap other lines in <p>
            }).join('');

            return html;
        }


        // --- Seed Data Functions ---
        function getChakrasSeedData() { return [ { id: "muladhara", title: "Muladhara (Root): Grounding and Stability", explanation: "This class is designed to connect you to the earth, fostering a sense of security and stability. We will focus on poses that strengthen the legs and connect the feet to the ground, cultivating a feeling of being rooted and supported. The gratitude theme centers on appreciating the foundational aspects of life: our bodies, our homes, and the earth that sustains us.", oils: "Cedarwood, Vetiver, Patchouli", ideas: { "Poses": "Mountain Pose, Warrior I & II, Tree Pose, Standing Forward Bend.", "Breathwork": "Deep, slow belly breathing.", "Meditation": "A guided meditation focused on visualizing roots growing from the feet into the earth.", "Mantra": "I am grounded, I am safe, I am grateful." } }, { id: "svadhisthana", title: "Svadhisthana (Sacral): Flowing with Creativity", explanation: "Unleash your creative potential and embrace the flow of life with this class centered on the sacral chakra. Through fluid movements and hip-opening postures, we will tap into our emotional intelligence and cultivate a sense of joy and abundance. The gratitude theme is for the gifts of creativity, pleasure, and emotional expression.", oils: "Orange, Ylang Ylang, Clary Sage", ideas: { "Poses": "Cat-Cow, Goddess Pose, Pigeon Pose, Bound Angle Pose.", "Breathwork": "Circular breathing to mimic the flow of water.", "Meditation": "A visualization of a flowing river, washing away creative blocks.", "Mantra": "I flow with creativity and grace. I am grateful for the sweetness of life." } }, { id: "manipura", title: "Manipura (Solar Plexus): Igniting Personal Power", explanation: "This empowering class is dedicated to activating the solar plexus chakra, the center of our personal power, self-esteem, and determination. Through core-strengthening poses and dynamic sequences, we will build inner fire and confidence. The gratitude theme focuses on acknowledging our inner strength, courage, and ability to manifest our intentions.", oils: "Lemon, Ginger, Peppermint", ideas: { "Poses": "Boat Pose, Plank Pose, Warrior III, Sun Salutations.", "Breathwork": "Breath of Fire (Kapalabhati).", "Meditation": "A meditation on the inner sun, radiating warmth and confidence.", "Mantra": "I am powerful, I am confident, I am grateful for my inner fire." } }, { id: "anahata", title: "Anahata (Heart): Opening to Love and Compassion", explanation: "Cultivate love, compassion, and connection in this heart-opening class focused on the Anahata chakra. Through chest-opening postures and practices of loving-kindness, we will dissolve emotional barriers and foster a sense of unity with all beings. The gratitude theme is for the love we give and receive, and the boundless compassion within us.", oils: "Rose, Geranium, Bergamot", ideas: { "Poses": "Camel Pose, Cobra Pose, Upward-Facing Dog, Bridge Pose.", "Breathwork": "Breathing into the heart space.", "Meditation": "A loving-kindness (Metta) meditation.", "Mantra": "My heart is open. I am grateful for the power of love." } }, { id: "vishuddha", title: "Vishuddha (Throat): Expressing Authentic Truth", explanation: "Find your voice and speak your truth in this class dedicated to the throat chakra. We will work with poses that open the neck and shoulders, encouraging clear communication and authentic self-expression. The gratitude theme is for the ability to communicate honestly, listen with compassion, and express our unique creativity.", oils: "Lavender, Eucalyptus, Roman Chamomile", ideas: { "Poses": "Fish Pose, Shoulder Stand, Plow Pose, Cat-Cow with neck movements.", "Breathwork": "Ujjayi breath (victorious breath).", "Meditation": "A meditation on finding and speaking one's truth.", "Mantra": "I speak my truth with clarity and grace. I am grateful for my authentic voice." } }, { id: "ajna", title: "Ajna (Third Eye): Cultivating Intuition", explanation: "This introspective class is designed to awaken the third eye chakra, the center of intuition, insight, and inner wisdom. Through focused gaze (drishti), meditation, and poses that stimulate the pineal gland, we will learn to trust our inner guidance. The gratitude theme is for the gift of intuition and the clarity it brings to our lives.", oils: "Frankincense, Sandalwood, Rosemary", ideas: { "Poses": "Child's Pose with forehead on the mat, Downward-Facing Dog, Seated Meditation.", "Breathwork": "Alternate Nostril Breathing (Nadi Shodhana).", "Meditation": "A third-eye meditation, focusing on the space between the eyebrows.", "Mantra": "I trust my intuition. I am grateful for my inner wisdom." } }, { id: "sahasrara", title: "Sahasrara (Crown): Connecting to Consciousness", explanation: "Experience a sense of unity and connection to something greater than yourself in this class focused on the crown chakra. Through meditation, inversions, and practices that quiet the ego, we will tap into a state of pure awareness and spiritual connection. The gratitude theme is for our connection to the divine and the infinite wisdom of the universe.", oils: "Frankincense, Myrrh, Neroli", ideas: { "Poses": "Headstand (or variations), Lotus Pose (or other meditative seats), Savasana.", "Breathwork": "Silent, mindful breathing.", "Meditation": "A meditation on universal consciousness and oneness.", "Mantra": "I am connected to all that is. I am grateful for this divine connection." } } ]; }
        function getMeridiansSeedData() { return [ { id: "lung-large-intestine", title: "Lung & Large Intestine: Embracing Grief & Letting Go", explanation: "In TCM, the Lung meridian (Yin) governs the intake of pure Qi and is associated with inspiration and the emotion of grief. Its partner, the Large Intestine meridian (Yang), is responsible for releasing waste. This class uses poses that open the chest, shoulders, and arms, along with twists, to process grief and cultivate release.", oils: "Eucalyptus, Cypress, Frankincense", ideas: { "Poses": "Cow Face Pose (arms), Humble Warrior, Fish Pose, Reclined Spinal Twist.", "Breathwork": "Deep diaphragmatic breathing with a focus on long, complete exhales.", "Gratitude Focus": "Gratitude for the breath and the freedom of releasing burdens." }}, { id: "stomach-spleen", title: "Stomach & Spleen: Nourishing Ourselves", explanation: "This pair is central to digestion and nourishment. The Stomach meridian (Yang) processes food and information, while the Spleen meridian (Yin) transforms it into usable energy (Qi). Imbalance can lead to worry. This grounding class uses poses that stretch the front of the body and stabilize the core.", oils: "Ginger, Fennel, Rosemary", ideas: { "Poses": "Hero's Pose, Saddle Pose (Yin), Low Lunge, and gentle core work like Cat-Cow.", "Breathwork": "Deep belly breathing to gently massage the digestive organs.", "Gratitude Focus": "Gratitude for the earth's bounty and our ability to digest life's experiences." }}, { id: "heart-small-intestine", title: "Heart & Small Intestine: Cultivating Joy & Clarity", explanation: "The Heart meridian (Yin) houses the 'Shen' or Spirit and is associated with joy and love. Its partner, the Small Intestine meridian (Yang), provides clarity by separating the pure from the impure. This class uses joyful, expansive heart-openers and poses that move through the arms and shoulders.", oils: "Rose, Bergamot, Neroli", ideas: { "Poses": "Wild Thing, Dancer's Pose, Camel Pose, Eagle Pose arms.", "Breathwork": "Breathing into the heart space; practicing loving-kindness (Metta) breath.", "Gratitude Focus": "Gratitude for connections that bring joy and inner wisdom." }}, { id: "kidney-bladder", title: "Kidney & Bladder: Accessing Willpower & Wisdom", explanation: "This pair relates to our fundamental life force. The Kidney meridian (Yin) stores our 'Jing' or life essence and governs willpower. The Bladder meridian (Yang) is the longest meridian, helping us manifest our potential. This deep, restorative class uses forward folds and gentle backbends.", oils: "Myrrh, Cedarwood, Juniper Berry", ideas: { "Poses": "Caterpillar (Yin), Seated Forward Bend, Sphinx and Seal Pose, Butterfly.", "Breathwork": "Slow, deep breathing into the low back (the area of the 'Ming Men').", "Gratitude Focus": "Gratitude for our endurance, inner strength, and the power of rest." }}, { id: "pericardium-triple-burner", title: "Pericardium & Triple Burner: Protecting the Heart", explanation: "The Pericardium (Yin) is the heart's protector, governing our intimate relationships. The Triple Burner (Yang) regulates temperature and the flow of Qi and fluids. This class focuses on creating healthy boundaries and balancing the body's systems.", oils: "Geranium, Spikenard, Vetiver", ideas: { "Poses": "Prayer Pose behind the back, Thread the Needle, and full-body flows like Sun Salutations.", "Breathwork": "Sama Vritti (Equal Ratio Breathing) to promote balance.", "Gratitude Focus": "Gratitude for healthy boundaries and our body's innate ability to maintain equilibrium." }}, { id: "liver-gallbladder", title: "Liver & Gallbladder: Finding Vision & Action", explanation: "This pair is the master planner and decision-maker. The Liver meridian (Yin) ensures the smooth flow of Qi and governs our ability to plan. The Gallbladder meridian (Yang) governs decisiveness and courage. This dynamic class uses twists and side-body stretches.", oils: "Lemon, Rosemary, Peppermint", ideas: { "Poses": "Gate Pose, Revolved Triangle, Side Angle Pose, Pigeon Pose, Lizard Lunge.", "Breathwork": "A cleansing breath like Breath of Fire (Kapalabhati), followed by smooth Ujjayi.", "Gratitude Focus": "Gratitude for our dreams and the personal power to move forward." }} ]; }
        function getSeasonsSeedData() { return [ { id: "spring-equinox", title: "Spring Equinox: Renewal and Rebirth", explanation: "As nature awakens from its winter slumber, this class focuses on renewal, growth, and setting new intentions. We will incorporate detoxifying twists, energizing flows, and heart-opening poses to welcome the fresh energy of spring.", oils: "Lemon (cleansing), Grapefruit (uplifting), Peppermint (energizing)", ideas: { "Poses": "Sun Salutations with twists, Revolved Chair Pose, Sprouting Seed (a creative flow from child's pose to upward salute).", "Breathwork": "Kapalabhati (Skull Shining Breath) for cleansing.", "Meditation": "A guided meditation on planting seeds of intention for the coming season.", "Gratitude Focus": "Gratitude for the return of light and the opportunity for a fresh start." }}, { id: "summer-solstice", title: "Summer Solstice: Radiance and Vitality", explanation: "Celebrate the peak of the sun's energy with this vibrant and expansive yoga class. We will embrace the fire element with dynamic sequences, heart-opening backbends, and playful balancing poses.", oils: "Bergamot (joyful), Ylang Ylang (euphoric), Jasmine (uplifting)", ideas: { "Poses": "Wild Thing, Dancer's Pose, Wheel Pose, Handstand variations.", "Breathwork": "Ujjayi breath to build internal heat.", "Meditation": "A meditation on the inner sun, radiating light and vitality.", "Gratitude Focus": "Gratitude for peak experiences, abundance, and the life-giving energy of the sun." }}, { id: "autumn-equinox", title: "Autumn Equinox: Balance and Letting Go", explanation: "As the days grow shorter, this class encourages introspection, balance, and the art of letting go. We will focus on grounding poses, mindful transitions, and forward folds to release what no longer serves us.", oils: "Cedarwood (grounding), Frankincense (introspective), Cypress (transitional)", ideas: { "Poses": "Standing Forward Bend, Seated Forward Bend, Eagle Pose, a 'Falling Leaves' flow with gentle, flowing movements.", "Breathwork": "Alternate Nostril Breathing (Nadi Shodhana) for balance.", "Meditation": "A guided meditation on releasing old patterns and embracing change.", "Gratitude Focus": "Gratitude for the abundance in our lives and the wisdom that comes from letting go." }}, { id: "winter-solstice", title: "Winter Solstice: Rest and Restoration", explanation: "Honor the darkest day of the year with this deeply restorative and introspective yoga class. We will embrace the stillness of winter with long-held yin poses, gentle stretches, and guided relaxation to replenish our energy reserves.", oils: "Lavender (calming), Sandalwood (meditative), Myrrh (restorative)", ideas: { "Poses": "Yin poses such as Sleeping Swan (Pigeon), Caterpillar (Seated Forward Bend), and Reclining Twist.", "Breathwork": "Deep, diaphragmatic breathing to calm the nervous system.", "Meditation": "Yoga Nidra (yogic sleep) for deep relaxation.", "Gratitude Focus": "Gratitude for the gift of rest, the opportunity for introspection, and the promise of returning light." }} ]; }
    </script>
</body>
</html>
