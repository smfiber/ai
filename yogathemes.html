<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yoga Class Themer v4.0.0 (AI-Powered)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3e8ff; /* A lighter, softer purple */
        }
        .card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 16px; /* Slightly more rounded */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            border: 1px solid #e9d5ff; /* Purple 200 */
        }
        .card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(147, 51, 234, 0.1), 0 10px 10px -5px rgba(147, 51, 234, 0.08);
        }
        .card-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .btn-primary {
            background: linear-gradient(to right, #9333ea, #7e22ce);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(147, 51, 234, 0.2);
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 10px rgba(147, 51, 234, 0.3);
        }
        .theme-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="%23a855f7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>'); /* Purple 500 */
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
        .header-bg-image {
            background-image: url('https://i.ibb.co/gFXPP4Gt/Image-fx-88.png');
            background-size: cover;
            background-position: center;
        }
        /* Styles for generated prose content */
        .prose h1, .prose h2, .prose h3, .prose h4 {
            color: #581c87; /* Purple 900 */
        }
        /* Accordion Styles */
        .accordion-item {
            border-bottom: 1px solid #e5e7eb; /* Gray 200 */
        }
        .accordion-header {
            width: 100%;
            text-align: left;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #374151; /* Gray 700 */
            background-color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .accordion-header:hover {
            background-color: #f9fafb; /* Gray 50 */
        }
        .accordion-content {
            padding: 0 1rem 1rem 1rem;
            display: none; /* Hidden by default */
        }
        .accordion-content.open { display: block; }
        .accordion-header .icon { transition: transform 0.3s ease; }
        .accordion-header.active .icon { transform: rotate(180deg); }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #9333ea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-purple-100 text-gray-800">

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Enter Your API Key</h2>
            <p class="mb-6 text-gray-600">To use the AI theme generator, please provide your Gemini API key. This key is only stored for your current session.</p>
            <form id="apiKeyForm">
                <input type="password" id="apiKeyInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Your Gemini API Key" required>
                <button type="submit" class="w-full btn-primary mt-6">Save Key and Start</button>
            </form>
        </div>
    </div>
    
    <!-- In-Depth Details Modal -->
    <div id="inDepthModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 id="inDepthModalTitle" class="text-2xl font-bold text-gray-800">In-Depth Exploration</h2>
                <button id="closeInDepthModal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="inDepthModalContent" class="p-6 overflow-y-auto prose max-w-none"></div>
        </div>
    </div>


    <!-- Main Content -->
    <div class="container mx-auto p-4 md:p-8">
        
        <header class="relative text-center mb-10 rounded-2xl overflow-hidden shadow-lg">
            <div class="absolute inset-0 header-bg-image"></div>
            <div class="absolute inset-0 bg-purple-900 opacity-50"></div>
            <div class="relative z-10 p-12 text-white">
                 <h1 class="text-4xl md:text-5xl font-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">Yoga Class Theme Generator</h1>
                <p class="text-lg text-purple-200 mt-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">AI-powered inspiration for your next yoga class.</p>
            </div>
            <div id="version-display" class="absolute bottom-2 right-4 text-white text-xs opacity-70">v4.0.0</div>
        </header>

        <main id="main-content" class="bg-white/50 backdrop-blur-md rounded-2xl p-6 md:p-10 shadow-xl border border-purple-100">
            <div class="space-y-8">
                <!-- AI Keyword Card -->
                <div class="card">
                    <div class="p-8 card-content">
                        <h2 class="text-2xl font-bold mb-2 text-purple-600">Custom Theme Generator</h2>
                        <p class="mb-6 text-gray-600">Feeling creative? Enter any keyword or concept, and let AI craft a unique class plan for you.</p>
                        <form id="gemini-form">
                            <input type="text" id="gemini-prompt" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="e.g., 'Courage & Heart Opening', 'Letting Go'">
                            <button type="submit" class="btn-primary w-full mt-4">Generate AI Theme</button>
                        </form>
                        <div id="gemini-result-container" class="mt-6 text-gray-700"></div>
                    </div>
                </div>

                <!-- Grid for Theme Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Themed cards will be dynamically handled by JavaScript -->
                    <div class="card theme-generator-card" data-theme-type="chakras">
                        <div class="p-8 card-content">
                            <h2 class="text-2xl font-bold mb-2 text-purple-600">The Seven Chakras</h2>
                            <p class="mb-6 text-gray-600">Generate themes to balance the seven primary energy centers in the body.</p>
                            <button class="btn-primary w-full mt-auto generate-options-button">Generate Chakra Ideas</button>
                            <div class="mt-6 w-full hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Select a Theme:</label>
                                <select class="theme-select w-full p-3 bg-gray-50 border border-gray-300 rounded-lg">
                                    <option value="">-- Generate ideas first --</option>
                                </select>
                            </div>
                            <div class="details-container prose max-w-none text-gray-700 mt-4"></div>
                        </div>
                    </div>

                    <div class="card theme-generator-card" data-theme-type="meridians">
                         <div class="p-8 card-content">
                            <h2 class="text-2xl font-bold mb-2 text-purple-600">The Twelve Meridians</h2>
                            <p class="mb-6 text-gray-600">Generate themes based on the major meridians of Traditional Chinese Medicine.</p>
                            <button class="btn-primary w-full mt-auto generate-options-button">Generate Meridian Ideas</button>
                             <div class="mt-6 w-full hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Select a Theme:</label>
                                <select class="theme-select w-full p-3 bg-gray-50 border border-gray-300 rounded-lg">
                                     <option value="">-- Generate ideas first --</option>
                                </select>
                            </div>
                            <div class="details-container prose max-w-none text-gray-700 mt-4"></div>
                        </div>
                    </div>

                    <div class="card theme-generator-card" data-theme-type="seasons">
                         <div class="p-8 card-content">
                            <h2 class="text-2xl font-bold mb-2 text-purple-600">The Four Seasons</h2>
                            <p class="mb-6 text-gray-600">Generate themes to align your practice with the natural cycles of the earth.</p>
                            <button class="btn-primary w-full mt-auto generate-options-button">Generate Seasonal Ideas</button>
                             <div class="mt-6 w-full hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Select a Theme:</label>
                                <select class="theme-select w-full p-3 bg-gray-50 border border-gray-300 rounded-lg">
                                     <option value="">-- Generate ideas first --</option>
                                </select>
                            </div>
                            <div class="details-container prose max-w-none text-gray-700 mt-4"></div>
                        </div>
                    </div>
                    
                    <div class="card theme-generator-card" data-theme-type="styles">
                         <div class="p-8 card-content">
                            <h2 class="text-2xl font-bold mb-2 text-purple-600">Yoga Styles</h2>
                            <p class="mb-6 text-gray-600">Generate themes based on the principles of a specific yoga style.</p>
                            <button class="btn-primary w-full mt-auto generate-options-button">Generate Style Ideas</button>
                             <div class="mt-6 w-full hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Select a Theme:</label>
                                <select class="theme-select w-full p-3 bg-gray-50 border border-gray-300 rounded-lg">
                                     <option value="">-- Generate ideas first --</option>
                                </select>
                            </div>
                            <div class="details-container prose max-w-none text-gray-700 mt-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // App Version: 4.0.0
        // Changelog:
        // v4.0.0: Overhauled to be fully AI-driven. All theme ideas, card content, and in-depth explorations
        //         are now generated by the Gemini API on-demand. Removed all static seed data.
        
        // --- Global Variables ---
        let geminiApiKey = "";
        const generatedThemes = {
            chakras: [],
            meridians: [],
            seasons: [],
            styles: []
        };

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
        });

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            // API Key Modal
            document.getElementById('apiKeyForm').addEventListener('submit', handleApiKeySubmit);
            
            // In-Depth Modal
            const inDepthModal = document.getElementById('inDepthModal');
            inDepthModal.addEventListener('click', (e) => {
                if (e.target.id === 'inDepthModal' || e.target.closest('#closeInDepthModal')) {
                    inDepthModal.classList.add('hidden');
                }
            });

            // Main Content Area Event Delegation
            document.getElementById('main-content').addEventListener('click', (e) => {
                const generateBtn = e.target.closest('.generate-options-button');
                const exploreBtn = e.target.closest('.explore-button');

                if (generateBtn) {
                    const card = generateBtn.closest('.theme-generator-card');
                    const themeType = card.dataset.themeType;
                    handleGenerateOptions(themeType, card);
                }
                
                if (exploreBtn) {
                    const themeTitle = exploreBtn.dataset.themeTitle;
                    const themeType = exploreBtn.dataset.themeType;
                    handleExploreInDepth(themeTitle, themeType);
                }
            });

            // Custom theme form
            document.getElementById('gemini-form').addEventListener('submit', handleGeminiSubmit);
            
            // Delegated listener for dropdown changes
            document.getElementById('main-content').addEventListener('change', (e) => {
                 if(e.target.classList.contains('theme-select')) {
                    const card = e.target.closest('.theme-generator-card');
                    const themeType = card.dataset.themeType;
                    const selectedTitle = e.target.value;
                    handleDropdownSelect(selectedTitle, themeType, card);
                 }
            });

            // Accordion listener for in-depth modal
             document.getElementById('inDepthModalContent').addEventListener('click', (e) => {
                const header = e.target.closest('.accordion-header');
                if (header) {
                    const content = header.nextElementSibling;
                    header.classList.toggle('active');
                    content.classList.toggle('open');
                    const icon = header.querySelector('.icon');
                    if (icon) icon.classList.toggle('rotate-180');
                }
            });
        }

        // --- API & Core Logic Handlers ---

        function handleApiKeySubmit(e) {
            e.preventDefault();
            const input = document.getElementById('apiKeyInput');
            if (input.value.trim()) {
                geminiApiKey = input.value.trim();
                document.getElementById('apiKeyModal').classList.add('hidden');
            }
        }

        async function handleGenerateOptions(themeType, card) {
            if (!checkApiKey()) return;
            
            const generateBtn = card.querySelector('.generate-options-button');
            const detailsContainer = card.querySelector('.details-container');
            generateBtn.disabled = true;
            generateBtn.innerHTML = 'Generating...';
            detailsContainer.innerHTML = '<div class="loader"></div>';

            const prompts = {
                chakras: "Generate a list of 7 creative yoga class themes based on the seven chakras. Return a JSON array of objects, where each object has a 'title' key with a unique, evocative theme name (e.g., 'Grounding Root Energy').",
                meridians: "Generate a list of 8 creative yoga class themes based on Traditional Chinese Medicine meridians. Return a JSON array of objects, where each object has a 'title' key with a unique, evocative theme name (e.g., 'Flowing with the Liver Meridian').",
                seasons: "Generate a list of 5 creative yoga class themes based on the seasons or solstices/equinoxes. Return a JSON array of objects, where each object has a 'title' key with a unique, evocative theme name (e.g., 'Embracing Winter's Stillness').",
                styles: "Generate a list of 10 creative yoga class themes based on popular yoga styles (like Vinyasa, Hatha, Yin, etc.). Return a JSON array of objects, where each object has a 'title' key with a unique, evocative theme name (e.g., 'Dynamic Power Vinyasa Flow')."
            };

            try {
                const text = await callGeminiAPI(prompts[themeType]);
                // The API might return markdown with ```json ... ```, so we need to clean it.
                const jsonString = text.replace(/```json\n?|```/g, '').trim();
                const themes = JSON.parse(jsonString);

                generatedThemes[themeType] = themes;
                populateDropdown(card, themes);
                
                const selectWrapper = card.querySelector('.mt-6');
                selectWrapper.classList.remove('hidden');
                generateBtn.classList.add('hidden');
                detailsContainer.innerHTML = '<p class="text-center text-gray-500">Select a theme above to see details.</p>';

            } catch (error) {
                console.error(`Error generating options for ${themeType}:`, error);
                detailsContainer.innerHTML = `<p class="text-red-500">${generateErrorMessage(error)}</p>`;
                generateBtn.disabled = false;
                generateBtn.innerHTML = `Try Again`;
            }
        }
        
        async function handleDropdownSelect(selectedTitle, themeType, card) {
            if (!selectedTitle) return;
            if (!checkApiKey()) return;

            const detailsContainer = card.querySelector('.details-container');
            detailsContainer.innerHTML = '<div class="loader"></div><p class="text-center">Generating theme details...</p>';

            const prompt = `
                For a yoga class with the theme "${selectedTitle}", generate the following content. Use markdown with ### headings.
                
                ### Explanation
                Provide a rich, inviting one-paragraph explanation of what a class with this theme would feel like and its primary benefits for a student.

                ### Themed Ideas
                - **Focus:** A one-sentence summary of the class's main intention.
                - **Poses:** List 5-7 key poses characteristic of this theme.
                - **Mantra:** Create a short, fitting mantra for the practice.
            `;

            try {
                const markdownText = await callGeminiAPI(prompt);
                const htmlContent = robustMarkdownToHtml(markdownText);
                detailsContainer.innerHTML = `
                    <div class="prose max-w-none">${htmlContent}</div>
                    <button class="btn-primary w-full mt-6 explore-button" data-theme-title="${selectedTitle}" data-theme-type="${themeType}">Explore in Depth with AI</button>
                `;
            } catch (error) {
                console.error(`Error generating details for ${selectedTitle}:`, error);
                detailsContainer.innerHTML = `<p class="text-red-500">${generateErrorMessage(error)}</p>`;
            }
        }

        async function handleExploreInDepth(themeTitle, themeType) {
            if (!checkApiKey()) return;
            
            const modal = document.getElementById('inDepthModal');
            const modalTitle = document.getElementById('inDepthModalTitle');
            const modalContent = document.getElementById('inDepthModalContent');

            modalTitle.textContent = `Exploring: ${themeTitle}`;
            modalContent.innerHTML = '<div class="loader"></div><p class="text-center">Generating your detailed guide... this may take a moment. ✨</p>';
            modal.classList.remove('hidden');

            const prompt = `
                You are a master yoga instructor creating a comprehensive guide for a yoga class themed "${themeTitle}".
                The theme category is "${themeType}".
                
                Your guide should be extremely thorough, providing a wealth of ideas for a yoga teacher.
                Generate content for ALL of the following sections, using Markdown with ### headings.
                
                ### Core Philosophy & Thematic Connection
                Delve into the core concept of "${themeTitle}". What is the main message or feeling? How does it connect to deeper yogic principles?
                
                ### Energetic & Emotional Landscape
                Describe the energetic qualities (e.g., grounding, uplifting) and the emotional states this theme aims to cultivate.

                ### Creative Inspiration
                - **Affirmations:** Provide 5 powerful affirmations related to the theme.
                - **Quotations:** Provide 3 insightful quotes that resonate with the theme.
                
                ### Class Elements
                - **Key Asanas:** Suggest 8-10 key poses (a mix of yin and yang where appropriate). For each, briefly explain *why* it fits the theme.
                - **Signature Sequence Idea:** Describe a creative 3-5 pose mini-flow that embodies the theme.
                - **Pranayama (Breathwork):** Suggest 1-2 specific pranayama techniques and explain their relevance.
                - **Meditation Focus:** Describe a specific meditation or visualization to use.
                - **Essential Oils:** Suggest 3 essential oils and their thematic benefits.
                - **Music Vibe:** Describe the genre or feeling of music that would fit (e.g., 'ambient soundscapes', 'upbeat folk', 'devotional chants'). Suggest 3 specific song examples (Title and Artist).
            `;

            try {
                const text = await callGeminiAPI(prompt);
                modalContent.innerHTML = convertMarkdownToAccordion(text);
            } catch (error) {
                console.error(`Error in handleExploreInDepth for "${themeTitle}":`, error);
                modalContent.innerHTML = `<p class="text-red-500">${generateErrorMessage(error)}</p>`;
            }
        }
        
        async function handleGeminiSubmit(e) {
            e.preventDefault();
            if (!checkApiKey()) return;

            const promptInput = document.getElementById('gemini-prompt');
            const userPrompt = promptInput.value.trim();
            const resultContainer = document.getElementById('gemini-result-container');
            
            if (!userPrompt) {
                 resultContainer.innerHTML = `<p class="text-amber-600">Please enter a theme idea.</p>`;
                return;
            }
            resultContainer.innerHTML = '<div class="loader"></div><p class="text-center">Crafting your custom class plan... ✨</p>';
            
            // Re-using the comprehensive 'Explore in Depth' prompt for the custom generator
            const fullPrompt = `
                You are a master yoga instructor creating a comprehensive guide for a yoga class themed "${userPrompt}".
                
                Your guide should be extremely thorough, providing a wealth of ideas for a yoga teacher.
                Generate content for ALL of the following sections, using Markdown with ### headings.
                
                ### Core Philosophy & Thematic Connection
                Delve into the core concept of "${userPrompt}". What is the main message or feeling? How does it connect to deeper yogic principles?
                
                ### Energetic & Emotional Landscape
                Describe the energetic qualities (e.g., grounding, uplifting) and the emotional states this theme aims to cultivate.

                ### Creative Inspiration
                - **Affirmations:** Provide 5 powerful affirmations related to the theme.
                - **Quotations:** Provide 3 insightful quotes that resonate with the theme.
                
                ### Class Elements
                - **Key Asanas:** Suggest 8-10 key poses (a mix of yin and yang where appropriate). For each, briefly explain *why* it fits the theme.
                - **Signature Sequence Idea:** Describe a creative 3-5 pose mini-flow that embodies the theme.
                - **Pranayama (Breathwork):** Suggest 1-2 specific pranayama techniques and explain their relevance.
                - **Meditation Focus:** Describe a specific meditation or visualization to use.
                - **Essential Oils:** Suggest 3 essential oils and their thematic benefits.
                - **Music Vibe:** Describe the genre or feeling of music that would fit. Suggest 3 specific song examples (Title and Artist).
            `;
            
            try {
                const text = await callGeminiAPI(fullPrompt);
                resultContainer.innerHTML = `<div class="p-4 border border-purple-200 rounded-lg bg-white">${convertMarkdownToAccordion(text)}</div>`;
            } catch (error) {
                console.error("Error calling Gemini API for main theme:", error);
                resultContainer.innerHTML = `<p class="text-red-500">${generateErrorMessage(error)}</p>`;
            }
        }

        async function callGeminiAPI(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiApiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                console.error("API Error Response:", response.status, errorBody);
                throw new Error(`API request failed with status ${response.status}`);
            }

            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text;
            } else {
               console.error("Invalid API Response Structure:", result);
               throw new Error("Invalid response structure from API.");
            }
        }

        // --- UI Population & Utility Functions ---

        function checkApiKey() {
            if (!geminiApiKey) {
                document.getElementById('apiKeyModal').classList.remove('hidden');
                return false;
            }
            return true;
        }

        function populateDropdown(card, themes) {
            const selectElement = card.querySelector('.theme-select');
            selectElement.innerHTML = `<option value="">-- Choose a theme --</option>`;
            themes.forEach(theme => {
                const option = document.createElement('option');
                option.value = theme.title;
                option.textContent = theme.title;
                selectElement.appendChild(option);
            });
        }

        function convertMarkdownToAccordion(text, openFirst = true) {
            const sections = text.split(/^(?:###) /m).slice(1);
            if (sections.length === 0) return robustMarkdownToHtml(text); // Fallback for simple text

            return '<div class="accordion">' + sections.map((section, index) => {
                const parts = section.split('\n');
                const title = parts[0].trim().replace(/\*+/g, ''); // Remove bolding from title
                const content = parts.slice(1).join('\n');
                const isOpen = openFirst && index === 0;

                return `
                <div class="accordion-item">
                    <button class="accordion-header ${isOpen ? 'active' : ''}">
                        <span>${title}</span>
                        <svg class="icon w-5 h-5 transition-transform ${isOpen ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="accordion-content ${isOpen ? 'open' : ''}">
                        <div class="prose max-w-none p-4">${robustMarkdownToHtml(content)}</div>
                    </div>
                </div>`;
            }).join('') + '</div>';
        }
        
        function robustMarkdownToHtml(text) {
            if (!text) return '';
            let html = text.trim();
            // General bolding
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // List items with potential bolding
            html = html.replace(/^\s*-\s+\*\*(.*?)\*\*(.*)/gm, '<li><strong>$1</strong>$2</li>');
            html = html.replace(/^\s*-\s+(.*)/gm, '<li>$1</li>');
            html = html.replace(/(\<li\>.*\<\/li\>)+/g, '<ul>$&</ul>');
            // Replace newlines with <br> for non-list/heading content
            html = html.split('\n').map(line => {
                if (line.startsWith('<ul>') || line.startsWith('<li>') || line.trim() === '') return line;
                return `<p>${line}</p>`;
            }).join('');
             // Clean up empty paragraphs and paragraphs around lists
            html = html.replace(/<p>\s*<ul>/g, '<ul>').replace(/<\/ul>\s*<\/p>/g, '</ul>');
            html = html.replace(/<p>\s*<\/p>/g, '');
            return html;
        }

        function generateErrorMessage(error) {
            let message = 'An unknown error occurred. Please check the console.';
            if (error.message.includes('400')) {
                message = 'API Error: Bad Request. The request was malformed. This might be due to a safety policy violation. Try a different prompt.';
            } else if (error.message.includes('401') || error.message.includes('403')) {
                message = 'API Error: Authentication failed. Please verify your API key is correct and has the Gemini API enabled.';
            } else if (error.message.includes('429')) {
                message = 'API Error: Rate limit exceeded. Please wait a moment and try again.';
            } else if (error.message.includes('500') || error.message.includes('503')) {
                message = 'API Error: The server is currently unavailable. Please try again later.';
            } else if (error.message.includes('Failed to fetch')) {
                message = 'Network Error: Could not connect to the API. Please check your internet connection.';
            } else if (error.message.includes('JSON.parse')) {
                message = 'Could not understand the AI response. It might not be valid JSON. Please try again.';
            }
            return `Sorry, something went wrong. ${message}`;
        }

    </script>
</body>
</html>
