<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yoga Nidra Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Adjusted scrollbar styles */
        textarea::-webkit-scrollbar, .custom-dropdown-content::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track, .custom-dropdown-content::-webkit-scrollbar-track { background: #1f2937; }
        textarea::-webkit-scrollbar-thumb, .custom-dropdown-content::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb:hover, .custom-dropdown-content::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .generated-script {
            background-image: linear-gradient(to right, #1e293b, #1a222f);
            padding: 1.5rem;
            border-radius: 0.75rem;
            white-space: pre-wrap;
            font-size: 1.1rem;
            line-height: 1.8;
            color: #d1d5db;
        }
        
        .system-message-paragraph, .error-message-paragraph {
            align-self: center;
            text-align: center;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            max-width: 80%;
            white-space: pre-wrap;
        }
        .system-message-paragraph { background-color: #374151; color: #a78bfa; }
        .error-message-paragraph { background-color: #dc2626; color: #fee2e2; }

        .dropdown-label { display: block; padding: 0.5rem 1rem; cursor: pointer; transition: background-color 0.2s; position: relative; }
        .dropdown-label:hover { background-color: #374151; }
        .dropdown-label input { margin-right: 0.75rem; }
        .custom-dropdown-content { max-height: 15rem; overflow-y: auto; }
        
        .script-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #e5e7eb; text-align: center; }

        .info-btn {
            background: none;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
            border-radius: 9999px;
            line-height: 1;
        }
        .info-btn:hover {
            background-color: #4b5563;
        }
        .modal-content-title {
            font-weight: bold;
            color: #a78b6fa;
            margin-top: 0.75rem;
            margin-bottom: 0.25rem;
        }

    </style>
</head>
<body class="bg-gray-900 text-white antialiased">
    <div class="w-full bg-gray-900 py-4 sm:py-6"> 
        <header class="max-w-4xl mx-auto flex flex-col w-full mb-4 pb-4 border-b border-gray-700 px-4 sm:px-0">
            <div class="flex flex-wrap justify-between items-start w-full mb-4 gap-y-4">
                 <div class="flex-shrink-0">
                    <h1 class="text-2xl font-bold text-white flex items-baseline gap-2">
                        Yoga Nidra Creator
                        <span id="version-number" class="text-xs font-mono bg-gray-700 px-2 py-1 rounded">1.28</span>
                        <button id="help-icon" title="How to Use">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-question-circle text-gray-400 hover:text-white" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg>
                        </button>
                         <button id="api-key-btn" title="Set API Key">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-key text-gray-400 hover:text-white" viewBox="0 0 16 16"><path d="M0 8a4 4 0 0 1 7.465-2H14a.5.5 0 0 1 .354.146l1.5 1.5a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0L13 9.207l-.646.647a.5.5 0 0 1-.708 0L11 9.207l-.646.647a.5.5 0 0 1-.708 0L9 9.207l-.646.647A.5.5 0 0 1 8 9.5a.5.5 0 0 1-.354-.146L7.293 9 6.95 9.343a.5.5 0 0 1-.707 0L6 9.207l-.646.647a.5.5 0 0 1-.708 0L4 9.207l-.646.647a.5.5 0 0 1-.708 0l-.646-.647a.5.5 0 0 1 0-.708l.647-.646a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0L7.465 6H8a4 4 0 1 1 0 4zM3.5 11.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                        </button>
                    </h1>
                     <p class="text-sm text-gray-400 mt-1 max-w-xs">Generate calming Yoga Nidra scripts.</p>
                </div>
                <div class="flex items-end gap-4">
                    <div class="w-72 relative">
                        <label for="style-dropdown-button" class="block mb-1 text-gray-400 text-sm">Style (Optional):</label>
                        <button id="style-dropdown-button" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-base text-left focus:ring-indigo-500 focus:border-indigo-500 flex justify-between items-center truncate">
                            <span>Select a Style (Optional)</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="style-dropdown-content" class="hidden absolute z-20 w-full mt-1 bg-gray-800 border border-gray-600 rounded-lg shadow-lg">
                            <div id="style-list-area" class="max-h-96 overflow-y-auto custom-dropdown-content"></div>
                        </div>
                    </div>
                    <div class="w-72 relative">
                        <label class="block mb-1 text-gray-400 text-sm">AI Persona (Optional):</label>
                        <button id="persona-dropdown-button" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-base text-left focus:ring-indigo-500 focus:border-indigo-500 flex justify-between items-center truncate">
                            <span>Select Persona</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="persona-dropdown-content" class="hidden absolute z-20 w-full mt-1 bg-gray-800 border border-gray-600 rounded-lg shadow-lg">
                           <div id="persona-list-area" class="max-h-96 overflow-y-auto custom-dropdown-content"></div>
                        </div>
                    </div>
                    <div class="w-72">
                        <label for="script-length-select" class="block mb-1 text-gray-400 text-sm">Length:</label>
                        <select id="script-length-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-base focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-700">
                <textarea id="prompt-input" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none transition resize-none" rows="3" placeholder="Enter your script intention here..."></textarea>
                <div class="flex justify-end items-center mt-2 gap-4">
                    <button id="generate-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg active:scale-95 flex items-center gap-2 disabled:bg-gray-500 disabled:cursor-not-allowed">
                        <span id="btn-text">Generate Script</span>
                        <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
            </div>
            <div class="flex items-center justify-end gap-2 mt-3 w-full">
                <button id="copy-script-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Copy Script</button>
                <button id="reset-app-btn" class="bg-red-700 hover:bg-red-600 text-white text-xs py-1 px-3 rounded-lg transition-colors">Clear</button>
            </div>
        </header>
    </div>

    <div id="app-container" class="min-h-dvh flex flex-col bg-gray-800 p-4 sm:p-6 max-w-4xl mx-auto shadow-lg rounded-lg my-8">
        <main id="script-display-area" class="w-full p-4 space-y-6 flex flex-col"></main>
    </div>
    
    <div id="disclaimer-footer" class="bg-gray-900 text-gray-500 text-xs text-center py-4 mt-8 w-full">
        <p>Disclaimer: This tool generates Yoga Nidra scripts using AI and is for informational and personal use only. It is not a substitute for professional medical or therapeutic advice. Always consult with a qualified healthcare professional before beginning any new practice, especially if you have underlying health conditions or concerns. The effectiveness of the generated scripts may vary. By using this tool, you agree to assume full responsibility for your use of the generated content.</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const scriptDisplayArea = document.getElementById('script-display-area');
            const promptInput = document.getElementById('prompt-input');
            const generateBtn = document.getElementById('generate-btn');
            const loadingSpinner = document.getElementById('loading-spinner');
            const scriptLengthSelect = document.getElementById('script-length-select');
            // Old scriptTypeSelect is now styleDropdownButton/Content/ListArea
            const styleDropdownButton = document.getElementById('style-dropdown-button');
            const styleDropdownContent = document.getElementById('style-dropdown-content');
            const styleListArea = document.getElementById('style-list-area');

            const resetAppBtn = document.getElementById('reset-app-btn');
            const copyScriptBtn = document.getElementById('copy-script-btn');
            const personaDropdownButton = document.getElementById('persona-dropdown-button');
            const personaDropdownContent = document.getElementById('persona-dropdown-content');
            const personaListArea = document.getElementById('persona-list-area');
            
            const helpIcon = document.getElementById('help-icon');
            const instructionsModal = document.getElementById('instructions-modal');
            const closeInstructionsModalBtn = document.getElementById('close-instructions-modal-btn');
            const apiKeyBtn = document.getElementById('api-key-btn');
            const apiKeyModal = document.getElementById('api-key-modal');
            const apiKeyInput = document.getElementById('api-key-input');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const closeApiKeyModalBtn = document.getElementById('close-api-key-modal-btn');
            const personaDetailModal = document.getElementById('persona-detail-modal');
            const personaModalTitle = document.getElementById('persona-modal-title');
            const personaModalContent = document.getElementById('persona-modal-content');
            const closePersonaModalBtn = document.getElementById('close-persona-modal-btn');


            // --- Application State ---
            let apiKey = '';
            let isGenerating = false;
            let currentGeneratedScript = '';
            let selectedPersonaIndex = null; // Use null for no selection
            let selectedStyleName = ""; // New state variable for custom style dropdown
            let yogaNidraStyles = []; 
            let personas = [];
            
            // --- Data Definitions ---

            const lengthOptions = [
                { name: "15 minutes", promptSuffix: "Make it a concise script, approximately 15 minutes long (around 300-500 words)." },
                { name: "30 minutes", promptSuffix: "Generate a moderately detailed script, approximately 30 minutes long (around 700-1000 words)." },
                { name: "1 hour", promptSuffix: "Produce a very detailed and expansive script, approximately 1 hour long (around 1200-1800 words)." }
            ];

            // --- Yoga Nidra Styles Data (formerly scriptTypesData) ---
            yogaNidraStyles = [
              {
                "style": "Classic Body Scan",
                "description": "Systematic awareness guided through each body part, promoting deep physical relaxation."
              },
              {
                "style": "Breath Awareness",
                "description": "Focuses on the natural rhythm and sensation of the breath to calm the nervous system."
              },
              {
                "style": "Sankalpa (Intention) Focused",
                "description": "Emphasizes the repetition and planting of a heartfelt resolve or intention into the subconscious."
              },
              {
                "style": "Journey Through the Koshas",
                "description": "Guides awareness through the five layers of being (physical, energetic, mental, wisdom, bliss) for holistic integration."
              },
              {
                "style": "Chakra Balancing",
                "description": "Focuses on cleansing, balancing, and awakening the seven main energy centers."
              },
              {
                "style": "Exploring the Five Elements",
                "description": "Connects the practitioner to the qualities of Earth, Water, Fire, Air, and Ether within themselves."
              },
              {
                "style": "Working with Opposites (Dvandvas)",
                "description": "Explores pairs of opposite sensations or emotions to cultivate equanimity."
              },
              {
                "style": "Enchanted Forest Journey",
                "description": "Imaginative journey through a magical forest with calming natural and symbolic imagery."
              },
              {
                "style": "Cosmic Journey and Stargazing",
                "description": "Visualizes floating in space, observing celestial bodies to expand consciousness."
              },
              {
                "style": "Oceanic Relaxation",
                "description": "Uses imagery and sounds of the ocean to cultivate cleansing, release, and profound calm."
              },
              {
                "style": "Inner Sanctuary/Safe Space",
                "description": "Guides creation of a detailed mental sanctuary for peace and solace."
              },
              {
                "style": "Meeting a Wise Guide",
                "description": "Facilitates a visualization to meet an inner guide for insight and reassurance."
              },
              {
                "style": "Cultivating Gratitude",
                "description": "Focuses on appreciating life's aspects to foster a positive mindset."
              },
              {
                "style": "Forgiveness and Letting Go",
                "description": "Guides the release of emotional burdens through self and other forgiveness."
              },
              {
                "style": "Unlocking Creativity",
                "description": "By tapping into the subconscious mind, this script aims to dissolve creative blocks and awaken inspiration through symbolic imagery and open-ended suggestions."
              },
              {
                "style": "Building Self-Compassion",
                "description": "Uses affirmations and heart-centered visualizations to nurture a sense of self-love, acceptance, and kindness."
              },
              {
                "style": "Yoga Nidra for a New Beginning",
                "description": "Releases the old and sets clear, positive intentions for renewal and purpose."
              },
              {
                "style": "Traditional Sanskrit Phrases",
                "description": "Incorporates classic Sanskrit terms and traditional yogic philosophy for deep connection to ancient roots."
              },
              {
                "style": "Nature's Embrace",
                "description": "Uses vivid imagery of natural landscapes (forests, oceans, mountains) for peace and expansion."
              },
              {
                "style": "Pre-Sleep Induction",
                "description": "Specifically designed to promote deep relaxation and ease the transition into restful sleep."
              },
              {
                "style": "Morning Awakening",
                "description": "Helps gently awaken the body and mind, setting a positive tone for the day."
              },
              {
                "style": "Stress Reduction",
                "description": "Targets common stress points and offers techniques for releasing tension and promoting calm."
              },
              {
                "style": "Anxiety Relief",
                "description": "Provides soothing language and guided imagery to alleviate anxiety and promote peace."
              },
              {
                "style": "Pain Management",
                "description": "Offers techniques for shifting focus away from pain and promoting comfort."
              },
              {
                "style": "Inner Child Healing",
                "description": "Focuses on connecting with and nurturing the inner child, addressing past wounds."
              },
              {
                "style": "Affirmation-Based",
                "description": "Uses positive affirmations and Sankalpa repetition to empower the subconscious."
              },
              {
                "style": "Dream State Induction",
                "description": "Guides into a liminal state between waking and dreaming, fostering creativity and insight."
              },
              {
                "style": "Sensory Immersion",
                "description": "Engages all five senses through imagined scenarios, enhancing vividness and immersion."
              },
              {
                "style": "Color Therapy",
                "description": "Invokes specific colors and their associated qualities to promote healing and balance."
              },
              {
                "style": "Animal Spirit Guide",
                "description": "Invites the presence of a symbolic animal for guidance, wisdom, and strength."
              },
              {
                "style": "Abstract Imagery",
                "description": "Uses non-representational concepts and feelings to guide the mind, allowing personal interpretation."
              },
              {
                "style": "Gentle Past Life Regression",
                "description": "Offers a gentle approach to exploring past life memories or ancestral patterns, focusing on healing."
              },
              {
                "style": "Future Pacing/Goal Manifestation",
                "description": "Visualizes future successes and desired outcomes to impress them upon the subconscious."
              },
              {
                "style": "Sound Healing Integration",
                "description": "Incorporates descriptions of specific sounds (e.g., singing bowls, chimes, nature sounds) for auditory relaxation."
              },
              {
                "style": "Self-Inquiry/Philosophical",
                "description": "Poses open-ended questions for introspection, encouraging deeper self-understanding."
              },
              {
                "style": "Release and Let Go",
                "description": "Focuses on identifying and releasing physical and emotional tension, promoting lightness."
              },
              {
                "style": "Energizing/Revitalizing",
                "description": "Aims to leave the practitioner feeling refreshed and re-energized while deeply relaxed."
              },
              {
                "style": "Grounding and Centering",
                "description": "Emphasizes connecting with the earth and finding a sense of stability and inner calm."
              },
              {
                "style": "Heart-Centered Compassion",
                "description": "Focuses on opening the heart space and cultivating compassion for oneself and others."
              },
              {
                "style": "Digital Detox",
                "description": "Guides the practitioner to release attachment to technology and reconnect with inner stillness."
              },
              {
                "style": "Traveler's Serenity",
                "description": "Designed for finding peace and calm amidst travel stress."
              },
              {
                "style": "Student Focus/Concentration",
                "description": "Aids in improving focus, memory, and reducing academic stress."
              },
              {
                "style": "Artist's Inspiration",
                "description": "Specifically crafted to spark imagination and artistic vision."
              },
              {
                "style": "Musician's Flow",
                "description": "Helps musicians connect with their inner rhythm and enhance performance."
              },
              {
                "style": "Writer's Clarity",
                "description": "Assists writers in finding mental clarity and overcoming writer's block."
              },
              {
                "style": "Athlete's Recovery",
                "description": "Promotes physical and mental recovery, enhancing performance and preventing burnout."
              },
              {
                "style": "Pre-Performance Nerves",
                "description": "Helps calm nerves and build confidence before public speaking or performances."
              },
              {
                "style": "Post-Workout Release",
                "description": "Aids in muscle relaxation and mental unwinding after physical exertion."
              },
              {
                "style": "Morning Intention Setting",
                "description": "Combines relaxation with setting clear intentions for the day ahead."
              },
              {
                "style": "Evening Reflection",
                "description": "Guides the practitioner through a gentle review of the day, releasing what no longer serves."
              }
            ];

            // --- Mainstream Yoga Nidra Personas ---
            personas = [
              {
                "name": "Default Yoga Nidra Guide",
                "description": "A neutral, clear, and calming guide for a general Yoga Nidra practice.",
                "vocal_quality": "A clear and calm voice.",
                "imagery": "Simple and accessible, focusing on breath and body sensations.",
                "theme": "General relaxation and stillness."
              },
              {
                "name": "The Calming Voice",
                "description": "A neutral, clear, and reassuring voice, focusing on general relaxation and a gentle presence.",
                "vocal_quality": "", "imagery": "", "theme": "" 
              },
              {
                "name": "The Serene Guide",
                "description": "A peaceful and soft voice that encourages deep tranquility and inner stillness.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Nurturing Presence",
                "description": "A warm and compassionate voice that offers comfort, safety, and a sense of being held.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Grounding Anchor",
                "description": "A steady and stable voice that helps the listener feel deeply connected to the earth and present moment.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Expansive Whisper",
                "description": "A light and airy voice that inspires a sense of spaciousness, freedom, and openness.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Mindful Observer",
                "description": "A detached yet kind voice that encourages non-judgmental awareness of thoughts and sensations.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Healing Touch",
                "description": "A gentle and empathetic voice that guides the listener towards self-healing and restoration.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Creative Muse",
                "description": "An inspiring and imaginative voice that sparks creativity and intuitive insight.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Sleep Inducer",
                "description": "A deeply soothing voice specifically designed to ease the transition into restful and restorative sleep.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Stress Reliever",
                "description": "A calming voice focused on releasing tension and melting away the burdens of stress and anxiety.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Inner Explorer",
                "description": "A curious and encouraging voice that invites exploration of inner landscapes and deeper consciousness.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Heart-Centered Friend",
                "description": "A voice filled with loving-kindness and compassion, fostering connection and self-acceptance.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Peaceful Warrior",
                "description": "A firm yet gentle voice that builds inner strength and resilience amidst calm.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Gentle Awakener",
                "description": "A soft and subtle voice designed to gently bring awareness back to the present, feeling refreshed.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Intuitive Guide",
                "description": "A voice that trusts inner wisdom and encourages the listener to connect with their own intuition.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Release Facilitator",
                "description": "A voice that aids in the conscious letting go of emotional and physical burdens.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Focused Mind",
                "description": "A clear and precise voice that helps cultivate concentration and mental clarity.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Restorative Presence",
                "description": "A voice that emphasizes deep rest and rejuvenation for both body and mind.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Symbolic Storyteller",
                "description": "A narrative voice that uses gentle metaphors and archetypal imagery for deeper insight.",
                "vocal_quality": "", "imagery": "", "theme": ""
              },
              {
                "name": "The Tranquil Breathwork Guide",
                "description": "A voice centered on the subtleties of breath, guiding through various calming breath techniques.",
                "vocal_quality": "", "imagery": "", "theme": ""
              }
            ];


            // This re-generates the systemPrompt for all personas on load,
            // which is necessary if the source JSON for 'personas' doesn't include it.
            // It ensures consistency in prompt generation regardless of persona data source.
            function initializePersonaSystemPrompts() {
                personas.forEach(p => {
                    if (!p.systemPrompt) {
                        p.systemPrompt = `You are an AI assistant creating a Yoga Nidra script. Adopt the persona of **${p.name}**.
                        **Detailed Persona Profile:**
                        - **Description:** ${p.description}
                        - **Vocal Quality:** ${p.vocal_quality || 'A calming voice.'}
                        - **Imagery Style:** ${p.imagery || 'General calming imagery.'}
                        - **Core Theme:** ${p.theme || 'Relaxation and inner peace.'}
                        
                        Your script must include traditional Yoga Nidra stages (inner stillness, sankalpa, rotation of consciousness, breath, sensations, visualization, final sankalpa, externalization).
                        Adapt the length based on user's preference.`;
                    }
                });
            }

            function initializeApp() {
                initializePersonaSystemPrompts(); 
                populateStyleSelect(); // Calls the new custom style dropdown population function
                populateScriptLengthSelect();
                populatePersonaSelect();
                addEventListeners();
                resetApp(); // Calls reset after all initializations
                checkAndPromptForKey();
            }
            
            // --- UI Population Functions ---

            function populateStyleSelect() { // NEW function for custom style dropdown
                styleListArea.innerHTML = ''; // Clear previous content

                // Add "None (Optional)" option
                const noneLabel = document.createElement('label');
                noneLabel.className = 'dropdown-label';
                noneLabel.innerHTML = `
                    <input type="radio" name="style" value="" class="accent-indigo-500">
                    <span>None (Optional)</span>
                `;
                noneLabel.title = "Select no specific style, allowing the AI to choose a general approach.";
                if (selectedStyleName === "") {
                    noneLabel.querySelector('input').checked = true;
                }
                noneLabel.querySelector('input').addEventListener('change', () => {
                    selectedStyleName = "";
                    updateStyleButton("");
                    styleDropdownContent.classList.add('hidden'); // Hide dropdown after selection
                });
                styleListArea.appendChild(noneLabel);

                // Populate other styles
                yogaNidraStyles.forEach(style => {
                    const label = document.createElement('label');
                    label.className = 'dropdown-label';
                    label.title = style.description; // Tooltip for style description
                    
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'style';
                    radio.value = style.style;
                    radio.className = 'accent-indigo-500';
                    if (selectedStyleName === style.style) {
                        radio.checked = true;
                    }

                    radio.addEventListener('change', () => {
                        selectedStyleName = radio.value;
                        updateStyleButton(selectedStyleName);
                        styleDropdownContent.classList.add('hidden'); // Hide dropdown after selection
                    });
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = style.style;
                    
                    label.appendChild(radio);
                    label.appendChild(nameSpan);
                    styleListArea.appendChild(label);
                });
            }

            function updateStyleButton(styleName) { // NEW helper for custom style dropdown button text
                const buttonSpan = styleDropdownButton.querySelector('span');
                buttonSpan.textContent = styleName || "Select a Style (Optional)";
            }

            function populatePersonaSelect() {
                personaListArea.innerHTML = '';
                // Add the "None (Default Guide)" option explicitly at the top
                const defaultPersona = personas[0]; 
                const noneLabel = document.createElement('label');
                noneLabel.className = 'dropdown-label flex justify-between items-center';
                noneLabel.innerHTML = `
                    <div>
                        <input type="radio" name="persona" value="0" class="accent-indigo-500">
                        <span>None (Default Guide)</span>
                    </div>
                `;
                noneLabel.title = defaultPersona.description; 

                if (selectedPersonaIndex === null || selectedPersonaIndex === 0) {
                    noneLabel.querySelector('input').checked = true;
                    selectedPersonaIndex = 0; 
                    updatePersonaButton(0);
                }
                noneLabel.querySelector('input').addEventListener('change', () => {
                    selectedPersonaIndex = 0; 
                    updatePersonaButton(0);
                    personaDropdownContent.classList.add('hidden');
                });
                personaListArea.appendChild(noneLabel);


                // Populate the rest of the personas (from index 1 onwards in the new array)
                for (let i = 1; i < personas.length; i++) {
                    const persona = personas[i];
                    const personaIndex = i; 
                    const label = document.createElement('label');
                    label.className = 'dropdown-label flex justify-between items-center';
                    label.title = persona.description; 
                    
                    const contentDiv = document.createElement('div');
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'persona';
                    radio.value = personaIndex;
                    radio.className = 'accent-indigo-500';
                     if (personaIndex === selectedPersonaIndex) {
                        radio.checked = true;
                    }

                    radio.addEventListener('change', () => {
                        selectedPersonaIndex = parseInt(radio.value);
                        updatePersonaButton(selectedPersonaIndex);
                        personaDropdownContent.classList.add('hidden');
                    });
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = persona.name;
                    
                    contentDiv.appendChild(radio);
                    contentDiv.appendChild(nameSpan);

                    const infoButton = document.createElement('button');
                    infoButton.className = 'info-btn';
                    infoButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle text-gray-400" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.45-.083a.25.25 0 0 1-.288-.469l.738-3.468a.25.25 0 0 1 .469-.288zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>`;
                    infoButton.dataset.index = personaIndex;

                    label.appendChild(contentDiv);
                    label.appendChild(infoButton);
                    personaListArea.appendChild(label);
                }
            }

            function showPersonaDetailModal(persona) {
                personaModalTitle.textContent = persona.name;
                // Safely access properties, providing fallback if they don't exist
                personaModalContent.innerHTML = `
                    <div class="modal-content-title">Description:</div><p>${persona.description || 'No description provided.'}</p>
                    <div class="modal-content-title">Vocal Quality:</div><p>${persona.vocal_quality || 'Not specified.'}</p>
                    <div class="modal-content-title">Imagery:</div><p>${persona.imagery || 'Not specified.'}</p>
                    <div class="modal-content-title">Theme:</div><p>${persona.theme || 'Not specified.'}</p>
                `;
                personaDetailModal.classList.remove('hidden');
            }


            function addEventListeners() {
                generateBtn.addEventListener('click', handleGenerateScript);
                promptInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleGenerateScript(); } });
                resetAppBtn.addEventListener('click', resetApp);
                copyScriptBtn.addEventListener('click', copyScriptToClipboard);
                helpIcon.addEventListener('click', () => instructionsModal.classList.remove('hidden'));
                closeInstructionsModalBtn.addEventListener('click', () => instructionsModal.classList.add('hidden'));
                apiKeyBtn.addEventListener('click', () => apiKeyModal.classList.remove('hidden'));
                closeApiKeyModalBtn.addEventListener('click', () => apiKeyModal.classList.add('hidden'));
                saveApiKeyBtn.addEventListener('click', saveApiKey);
                closePersonaModalBtn.addEventListener('click', () => personaDetailModal.classList.add('hidden'));

                // Style Dropdown Event Listeners (NEW)
                styleDropdownButton.addEventListener('click', () => styleDropdownContent.classList.toggle('hidden'));

                // Persona Dropdown Event Listeners (Existing)
                personaDropdownButton.addEventListener('click', () => personaDropdownContent.classList.toggle('hidden'));
                
                // Global click listener to close dropdowns when clicking outside
                document.addEventListener('click', (event) => { 
                    // Close Style dropdown if click is outside
                    if (!styleDropdownButton.contains(event.target) && !styleDropdownContent.contains(event.target)) {
                        styleDropdownContent.classList.add('hidden');
                    }
                    // Close Persona dropdown if click is outside
                    if (!personaDropdownButton.contains(event.target) && !personaDropdownContent.contains(event.target)) { 
                        personaDropdownContent.classList.add('hidden'); 
                    }
                });
                
                // Event delegation for persona info buttons
                personaListArea.addEventListener('click', (event) => {
                    const infoButton = event.target.closest('.info-btn');
                    if (infoButton) {
                        event.stopPropagation(); 
                        const personaIndex = parseInt(infoButton.dataset.index);
                        if (!isNaN(personaIndex) && personas[personaIndex]) {
                            showPersonaDetailModal(personas[personaIndex]);
                        }
                    }
                });
            }

            function resetApp() {
                scriptDisplayArea.innerHTML = '';
                promptInput.value = '';
                currentGeneratedScript = '';
                scriptLengthSelect.value = "15 minutes"; // Default length set to 15 minutes
                
                selectedStyleName = ""; // Reset custom style dropdown state
                updateStyleButton(""); // Update button text
                populateStyleSelect(); // Re-populate to reflect reset state

                selectedPersonaIndex = 0; 
                updatePersonaButton(0); 
                populatePersonaSelect(); 
                
                updateButtonStates();
                displaySystemMessage("Enter an intention, or select a style to begin.");
            }

            function checkAndPromptForKey() {
                if (!apiKey) {
                    apiKeyModal.classList.remove('hidden');
                }
            }

            function saveApiKey() {
                const key = apiKeyInput.value.trim();
                if (key) {
                    apiKey = key;
                    apiKeyInput.value = '';
                    apiKeyModal.classList.add('hidden');
                    displaySystemMessage("API Key saved. You can now generate a script.");
                } else {
                    alert("Please enter a valid API key.");
                }
            }
            
            function populateScriptLengthSelect() {
                scriptLengthSelect.innerHTML = '';
                lengthOptions.forEach((option) => {
                    const opt = document.createElement('option');
                    opt.value = option.name;
                    opt.textContent = option.name;
                    scriptLengthSelect.appendChild(opt);
                });
            }

            function updatePersonaButton(index) {
                if (personas[index]) {
                   personaDropdownButton.querySelector('span').textContent = personas[index].name;
                } else {
                   personaDropdownButton.querySelector('span').textContent = 'Select Persona (Optional)';
                }
            }
            
            async function handleGenerateScript() {
                if (!apiKey) {
                    displaySystemMessage("Please set your API key first by clicking the key icon.", 'error-message');
                    checkAndPromptForKey();
                    return;
                }
                const customIntention = promptInput.value.trim();
                // Get selected style name from the state variable, not a select element
                const currentSelectedStyleName = selectedStyleName; 

                if (!currentSelectedStyleName && !customIntention) {
                    displaySystemMessage("Please enter an intention, or select a style.", 'error-message');
                    return;
                }
                if (isGenerating) return;

                setLoading(true);
                scriptDisplayArea.innerHTML = '';
                displaySystemMessage("Generating your Yoga Nidra script...", 'system-message-paragraph');

                try {
                    const lengthInstruction = lengthOptions.find(opt => opt.name === scriptLengthSelect.value).promptSuffix;
                    const finalPersonaIndex = (selectedPersonaIndex !== null && selectedPersonaIndex < personas.length) ? selectedPersonaIndex : 0;
                    const personaInstruction = personas[finalPersonaIndex].systemPrompt;

                    let themeInstruction = '';
                    // Use currentSelectedStyleName from the state variable
                    const selectedStyle = yogaNidraStyles.find(style => style.style === currentSelectedStyleName); 
                    if (selectedStyle) {
                        themeInstruction = `The core theme is **${selectedStyle.style}**. Description: *${selectedStyle.description}*`;
                    }

                    let intentionInstruction = '';
                    if (customIntention) {
                        intentionInstruction = `Please weave in this specific user intention: **"${customIntention}"**.`;
                    }

                    // If no style selected but custom intention exists, use intention as theme
                    if (!selectedStyle && customIntention) { 
                        themeInstruction = `The core theme is the user's intention: **"${customIntention}"**.`;
                        intentionInstruction = '';
                    }

                    const scriptGenerationPrompt = `${personaInstruction}\n\n--- SCRIPT REQUIREMENTS ---\n${themeInstruction}\n${intentionInstruction}\n${lengthInstruction}`;
                    const aiResponseText = await getAIResponse(scriptGenerationPrompt);
                    currentGeneratedScript = aiResponseText;

                    const titlePrompt = `Based on the following Yoga Nidra script, provide a short, creative title. Respond with only the title text, no quotes.\nScript: ${aiResponseText}`;
                    const generatedTitle = await getAIResponse(titlePrompt);

                    // Pass currentSelectedStyleName to displayGeneratedScript
                    displayGeneratedScript(currentGeneratedScript, customIntention, generatedTitle, personas[finalPersonaIndex].name, currentSelectedStyleName); 
                } catch (error) {
                    console.error("Error generating script:", error);
                    displaySystemMessage(`Failed to generate script: ${error.message}. Please try again.`, 'error-message');
                    currentGeneratedScript = '';
                } finally {
                    setLoading(false);
                }
            }
            
            function displayGeneratedScript(scriptText, customIntention, aiTitle, personaName, scriptStyle) {
                scriptDisplayArea.innerHTML = '';
                const titleElement = document.createElement('h2');
                titleElement.classList.add('script-title');
                let promptHTML = '';
                if (scriptStyle) { 
                    promptHTML += `<div style="font-size: 1.2rem; color: #9ca3af;">Style: <span class="text-white">${scriptStyle}</span></div>`;
                }
                if (customIntention) {
                    promptHTML += `<div style="font-size: 1.2rem; color: #9ca3af;">Custom Intention: <span class="text-white">${customIntention}</span></div>`;
                }
                titleElement.innerHTML = `
                    ${promptHTML || `<div style="font-size: 1.2rem; color: #9ca3af;">Intention: General Relaxation</div>`}
                    <div style="font-size: 1.8rem; margin-top: 0.5rem; margin-bottom: 0.5rem;">${aiTitle}</div>
                    <div style="font-size: 1.2rem; color: #9ca3af;">Persona: <span class="text-white">${personaName}</span></div>
                `;
                scriptDisplayArea.appendChild(titleElement);
                const scriptParagraph = document.createElement('p');
                scriptParagraph.classList.add('generated-script');
                scriptParagraph.textContent = scriptText;
                scriptDisplayArea.appendChild(scriptParagraph);
                window.scrollTo(0, 0);
            }

            function displaySystemMessage(text, type = 'system-message-paragraph') {
                scriptDisplayArea.querySelectorAll('.system-message-paragraph, .error-message-paragraph').forEach(el => el.remove());
                const messageWrapper = document.createElement('div');
                messageWrapper.className = type;
                messageWrapper.innerHTML = text.replace(/\n/g, '<br>');
                scriptDisplayArea.appendChild(messageWrapper);
            }

            function copyScriptToClipboard() {
                if (currentGeneratedScript) {
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = currentGeneratedScript;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);
                    // Use a temporary message that doesn't clear the whole screen
                    const copyButton = document.getElementById('copy-script-btn');
                    const originalText = copyButton.textContent;
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => {
                        copyButton.textContent = originalText;
                    }, 2000);
                }
            }

            function updateButtonStates() {
                generateBtn.disabled = isGenerating;
                copyScriptBtn.disabled = isGenerating || !currentGeneratedScript;
                resetAppBtn.disabled = isGenerating;
                promptInput.disabled = isGenerating;
                promptInput.placeholder = isGenerating ? 'Generating...' : "Enter your script intention here...";
            }

            function setLoading(isLoading) {
                isGenerating = isLoading;
                loadingSpinner.classList.toggle('hidden', !isLoading);
                updateButtonStates();
            }

            async function getAIResponse(prompt) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        const errorData = JSON.parse(errorText || "{}");
                        throw new Error(errorData?.error?.message || `API request failed with status ${response.status}`);
                    }
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else if (result.candidates?.[0]?.finishReason === 'SAFETY') {
                        throw new Error("The response was blocked due to safety settings. Please modify your prompt and try again.");
                    } else {
                        throw new Error(`Unexpected API response format. Check console for details.`);
                    }
                } catch (error) {
                    console.error("Fetch error:", error);
                    throw new Error("Network error or failed API request. Please check your connection and API key.");
                }
            }
            
            // --- Initialization ---
            initializeApp();
        });
    </script>
</body>
</html>
