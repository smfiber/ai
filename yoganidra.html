<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yoga Nidra Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Adjusted scrollbar styles */
        textarea::-webkit-scrollbar, .custom-dropdown-content::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track, .custom-dropdown-content::-webkit-scrollbar-track { background: #1f2937; }
        textarea::-webkit-scrollbar-thumb, .custom-dropdown-content::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb:hover, .custom-dropdown-content::-webkit-dropdown-content::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .generated-script {
            background-image: linear-gradient(to right, #1e293b, #1a222f);
            padding: 1.5rem;
            border-radius: 0.75rem;
            white-space: pre-wrap;
            font-size: 1.1rem;
            line-height: 1.8;
            color: #d1d5db;
        }
        
        .system-message-paragraph, .error-message-paragraph {
            align-self: center;
            text-align: center;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            max-width: 80%;
            white-space: pre-wrap;
        }
        .system-message-paragraph { background-color: #374151; color: #a78bfa; }
        .error-message-paragraph { background-color: #dc2626; color: #fee2e2; }

        .dropdown-label { display: block; padding: 0.5rem 1rem; cursor: pointer; transition: background-color 0.2s; position: relative; }
        .dropdown-label:hover { background-color: #374151; }
        .dropdown-label input { margin-right: 0.75rem; }
        .custom-dropdown-content { max-height: 15rem; overflow-y: auto; }
        
        .script-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #e5e7eb; text-align: center; }

        .info-btn {
            background: none;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
            border-radius: 9999px;
            line-height: 1;
        }
        .info-btn:hover {
            background-color: #4b5563;
        }
        .modal-content-title {
            font-weight: bold;
            color: #a78b6fa;
            margin-top: 0.75rem;
            margin-bottom: 0.25rem;
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-container {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            color: #e5e7eb;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #9ca3af;
            cursor: pointer;
        }
        .modal-close-btn:hover {
            color: #ffffff;
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">
    <div class="w-full bg-gray-900 py-4 sm:py-6"> 
        <header class="max-w-4xl mx-auto flex flex-col w-full mb-4 pb-4 border-b border-gray-700 px-4 sm:px-0">
            <div class="flex flex-wrap justify-between items-start w-full mb-4 gap-y-4">
                 <div class="flex-shrink-0">
                    <h1 class="text-2xl font-bold text-white flex items-baseline gap-2">
                        Yoga Nidra Creator
                        <span id="version-number" class="text-xs font-mono bg-gray-700 px-2 py-1 rounded">1.28</span>
                        <button id="help-icon" title="How to Use">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-question-circle text-gray-400 hover:text-white" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg>
                        </button>
                         <button id="api-key-btn" title="Set API Key">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-key text-gray-400 hover:text-white" viewBox="0 0 16 16"><path d="M0 8a4 4 0 0 1 7.465-2H14a.5.5 0 0 1 .354.146l1.5 1.5a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0L13 9.207l-.646.647a.5.5 0 0 1-.708 0L11 9.207l-.646.647a.5.5 0 0 1-.708 0L9 9.207l-.646.647A.5.5 0 0 1 8 9.5a.5.5 0 0 1-.354-.146L7.293 9 6.95 9.343a.5.5 0 0 1-.707 0L6 9.207l-.646.647a.5.5 0 0 1-.708 0L4 9.207l-.646.647a.5.5 0 0 1-.708 0l-.646-.647a.5.5 0 0 1 0-.708l.647-.646a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0L7.465 6H8a4 4 0 1 1 0 4zM3.5 11.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                        </button>
                    </h1>
                     <p class="text-sm text-gray-400 mt-1 max-w-xs">Generate calming Yoga Nidra scripts.</p>
                </div>
                <div class="flex items-end gap-4">
                    <div class="w-72 relative">
                        <label for="style-dropdown-button" class="block mb-1 text-gray-400 text-sm">Style (Optional):</label>
                        <button id="style-dropdown-button" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-base text-left focus:ring-indigo-500 focus:border-indigo-500 flex justify-between items-center truncate">
                            <span>Select a Style (Optional)</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="style-dropdown-content" class="hidden absolute z-20 w-full mt-1 bg-gray-800 border border-gray-600 rounded-lg shadow-lg">
                            <div id="style-list-area" class="max-h-96 overflow-y-auto custom-dropdown-content"></div>
                        </div>
                    </div>
                    <div class="w-72 relative">
                        <label class="block mb-1 text-gray-400 text-sm">AI Persona (Optional):</label>
                        <button id="persona-dropdown-button" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-base text-left focus:ring-indigo-500 focus:border-indigo-500 flex justify-between items-center truncate">
                            <span>Select Persona</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="persona-dropdown-content" class="hidden absolute z-20 w-full mt-1 bg-gray-800 border border-gray-600 rounded-lg shadow-lg">
                           <div id="persona-list-area" class="max-h-96 overflow-y-auto custom-dropdown-content"></div>
                        </div>
                    </div>
                    <div class="w-72">
                        <label for="script-length-select" class="block mb-1 text-gray-400 text-sm">Length:</label>
                        <select id="script-length-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-base focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-700">
                <textarea id="prompt-input" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none transition resize-none" rows="3" placeholder="Enter your script intention here..."></textarea>
                <div class="flex justify-end items-center mt-2 gap-4">
                    <button id="generate-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg active:scale-95 flex items-center gap-2 disabled:bg-gray-500 disabled:cursor-not-allowed">
                        <span id="btn-text">Generate Script</span>
                        <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
            </div>
            <div class="flex items-center justify-end gap-2 mt-3 w-full">
                <button id="copy-script-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs py-1 px-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Copy Script</button>
                <button id="reset-app-btn" class="bg-red-700 hover:bg-red-600 text-white text-xs py-1 px-3 rounded-lg transition-colors">Clear</button>
            </div>
        </header>
    </div>

    <div id="app-container" class="min-h-dvh flex flex-col bg-gray-800 p-4 sm:p-6 max-w-4xl mx-auto shadow-lg rounded-lg my-8">
        <main id="script-display-area" class="w-full p-4 space-y-6 flex flex-col"></main>
    </div>
    
    <div id="disclaimer-footer" class="bg-gray-900 text-gray-500 text-xs text-center py-4 mt-8 w-full">
        <p>Disclaimer: This tool generates Yoga Nidra scripts using AI and is for informational and personal use only. It is not a substitute for professional medical or therapeutic advice. Always consult with a qualified healthcare professional before beginning any new practice, especially if you have underlying health conditions or concerns. The effectiveness of the generated scripts may vary. By using this tool, you agree to assume full responsibility for your use of the generated content.</p>
    </div>

    <!-- Instructions Modal -->
    <div id="instructions-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <button id="close-instructions-modal-btn" class="modal-close-btn">&times;</button>
            <h2 class="text-xl font-bold mb-4">How to Use Yoga Nidra Creator</h2>
            <div class="text-gray-300 space-y-3">
                <p>This tool helps you generate personalized Yoga Nidra scripts using AI.</p>
                <p><strong>1. Enter your Intention:</strong> Type what you want your Yoga Nidra session to focus on in the text box. This could be "deep sleep," "stress relief," "creative inspiration," or anything else you desire.</p>
                <p><strong>2. Select a Style (Optional):</strong> Choose a specific style of Yoga Nidra from the dropdown menu. This will guide the AI to generate a script with a particular focus or theme (e.g., "Chakra Nidra," "Nature Nidra"). If you leave this blank, the AI will use a general approach.</p>
                <p><strong>3. Select AI Persona (Optional):</strong> Choose an AI persona to guide your session. This will influence the tone, vocal quality, and imagery used in the script. If left blank, a "Default Guide" will be used.</p>
                <p><strong>4. Choose Length:</strong> Select the desired duration for your script (15 minutes, 30 minutes, or 1 hour).</p>
                <p><strong>5. Generate Script:</strong> Click the "Generate Script" button. The AI will create a unique Yoga Nidra script based on your inputs.</p>
                <p><strong>6. Copy and Use:</strong> Once generated, you can copy the script to your clipboard and use it for your personal practice.</p>
                <p><strong>7. Clear:</strong> Click "Clear" to reset all inputs and start a new script.</p>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="api-key-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <button id="close-api-key-modal-btn" class="modal-close-btn">&times;</button>
            <h2 class="text-xl font-bold mb-4">Enter Your Gemini API Key</h2>
            <p class="text-gray-300 mb-4">To use this tool, you need to provide your Google Gemini API key. You can get one from <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-400 hover:underline">Google AI Studio</a>.</p>
            <input type="password" id="api-key-input" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter your API key here...">
            <button id="save-api-key-btn" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Save API Key</button>
        </div>
    </div>

    <!-- Persona Detail Modal -->
    <div id="persona-detail-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <button id="close-persona-modal-btn" class="modal-close-btn">&times;</button>
            <h2 id="persona-modal-title" class="text-xl font-bold mb-2"></h2>
            <div id="persona-modal-content" class="text-gray-300 space-y-2">
                <!-- Persona details will be loaded here by JS -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References (initialized with let for later assignment) ---
            const scriptDisplayArea = document.getElementById('script-display-area');
            // Initializing these variables directly here to ensure they are not null when addEventListeners is called.
            let promptInput = document.getElementById('prompt-input'); 
            let generateBtn = document.getElementById('generate-btn'); 
            let loadingSpinner = document.getElementById('loading-spinner'); 
            const scriptLengthSelect = document.getElementById('script-length-select');
            const styleDropdownButton = document.getElementById('style-dropdown-button');
            const styleDropdownContent = document.getElementById('style-dropdown-content');
            const styleListArea = document.getElementById('style-list-area');

            const resetAppBtn = document.getElementById('reset-app-btn');
            const copyScriptBtn = document.getElementById('copy-script-btn');
            const personaDropdownButton = document.getElementById('persona-dropdown-button');
            const personaDropdownContent = document.getElementById('persona-dropdown-content');
            const personaListArea = document.getElementById('persona-list-area');
            
            const helpIcon = document.getElementById('help-icon');
            const instructionsModal = document.getElementById('instructions-modal');
            const closeInstructionsModalBtn = document.getElementById('close-instructions-modal-btn');
            const apiKeyBtn = document.getElementById('api-key-btn');
            const apiKeyModal = document.getElementById('api-key-modal');
            const apiKeyInput = document.getElementById('api-key-input');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const closeApiKeyModalBtn = document.getElementById('close-api-key-modal-btn');
            const personaDetailModal = document.getElementById('persona-detail-modal');
            const personaModalTitle = document.getElementById('persona-modal-title');
            const personaModalContent = document.getElementById('persona-modal-content');
            const closePersonaModalBtn = document.getElementById('close-persona-modal-btn');


            // --- Application State ---
            let apiKey = '';
            let isGenerating = false;
            let currentGeneratedScript = '';
            let selectedPersonaIndex = null; // Use null for no selection
            let selectedStyleName = ""; // New state variable for custom style dropdown
            let yogaNidraStyles = []; 
            let personas = [];
            
            // --- Data Definitions ---

            const lengthOptions = [
                { name: "15 minutes", promptSuffix: "Make it a concise script, approximately 15 minutes long (around 300-500 words)." },
                { name: "30 minutes", promptSuffix: "Generate a moderately detailed script, approximately 30 minutes long (around 700-1000 words)." },
                { name: "1 hour", promptSuffix: "Produce a very detailed and expansive script, approximately 1 hour long (around 1200-1800 words)." }
            ];

            // --- Yoga Nidra Styles Data ---
            yogaNidraStyles = [
              {
                "style": "Traditional Nidra",
                "description": "Classic rotation of consciousness through body parts, breath awareness, and opposing sensations."
              },
              {
                "style": "Chakra Nidra",
                "description": "Focus on each of the seven main chakras, visualizing their colors and attributes."
              },
              {
                "style": "Elemental Nidra",
                "description": "Journey through the five elements (earth, water, fire, air, ether) and their qualities."
              },
              {
                "style": "Nature Nidra",
                "description": "Immerse yourself in a natural landscape (forest, ocean, mountains), engaging all senses."
              },
              {
                "style": "Cosmic Nidra",
                "description": "Explore the vastness of space, stars, planets, and the universe."
              },
              {
                "style": "Color Nidra",
                "description": "Visualize different colors and experience their energetic effects throughout the body."
              },
              {
                "style": "Sound Nidra",
                "description": "Focus on internal and external sounds, moving from gross to subtle."
              },
              {
                "style": "Mantra Nidra",
                "description": "Repetition of a specific mantra or affirmation throughout the practice."
              },
              {
                "style": "Healing Nidra",
                "description": "Directing healing energy and intention to specific areas of the body or mind."
              },
              {
                "style": "Gratitude Nidra",
                "description": "Cultivating feelings of appreciation and thankfulness for various aspects of life."
              },
              {
                "style": "Forgiveness Nidra",
                "description": "Practicing self-forgiveness and forgiveness towards others."
              },
              {
                "style": "Inner Child Nidra",
                "description": "Connecting with and nurturing the younger self, addressing past experiences."
              },
              {
                "style": "Dream Nidra",
                "description": "Exploring the subconscious mind and enhancing dream recall or lucid dreaming."
              },
              {
                "style": "Goal Manifestation Nidra",
                "description": "Focusing on a specific goal and visualizing its successful achievement."
              },
              {
                "style": "Abundance Nidra",
                "description": "Cultivating a mindset of prosperity and attracting abundance in all forms."
              },
              {
                "style": "Creativity Nidra",
                "description": "Unlocking creative potential and fostering innovative ideas."
              },
              {
                "style": "Self-Love Nidra",
                "description": "Developing deeper self-acceptance, compassion, and love."
              },
              {
                "style": "Peace Nidra",
                "description": "Cultivating profound inner peace and tranquility."
              },
              {
                "style": "Joy Nidra",
                "description": "Invoking feelings of pure joy and lightheartedness."
              },
              {
                "style": "Courage Nidra",
                "description": "Building inner strength and overcoming fears."
              },
              {
                "style": "Confidence Nidra",
                "description": "Enhancing self-esteem and belief in one's abilities."
              },
              {
                "style": "Release Nidra",
                "description": "Letting go of tension, stress, negative emotions, and limiting beliefs."
              },
              {
                "style": "Grounding Nidra",
                "description": "Connecting with the earth's energy for stability and security."
              },
              {
                "style": "Energetic Balance Nidra",
                "description": "Harmonizing the body's energy centers and flows."
              },
              {
                "style": "Sleep Preparation Nidra",
                "description": "A soothing practice to prepare the mind and body for deep, restorative sleep."
              },
              {
                "style": "Morning Awakening Nidra",
                "description": "A gentle practice to ease into wakefulness and set a positive intention for the day."
              },
              {
                "style": "Breath Awareness Nidra",
                "description": "Deep focus on the natural rhythm and sensation of the breath."
              },
              {
                "style": "Body Scan Nidra",
                "description": "Systematic awareness of different parts of the body, releasing tension."
              },
              {
                "style": "Sensory Journey Nidra",
                "description": "Exploring the five senses individually and collectively."
              },
              {
                "style": "Yoga Nidra for Stress Relief",
                "description": "Specific techniques to calm the nervous system and reduce stress."
              },
              {
                "style": "Yoga Nidra for Anxiety Reduction",
                "description": "Practices designed to soothe anxious thoughts and feelings."
              },
              {
                "style": "Yoga Nidra for Pain Management",
                "description": "Focusing on sensation and detachment to alleviate physical discomfort."
              },
              {
                "style": "Yoga Nidra for Emotional Regulation",
                "description": "Learning to observe and manage emotions without being overwhelmed."
              },
              {
                "style": "Yoga Nidra for Focus & Concentration",
                "description": "Exercises to improve mental clarity and sustained attention."
              },
              {
                "style": "Yoga Nidra for Intuition Development",
                "description": "Tuning into inner wisdom and gut feelings."
              },
              {
                "style": "Yoga Nidra for Past Life Regression",
                "description": "Exploring potential past life memories or karmic patterns."
              },
              {
                "style": "Yoga Nidra for Future Self Visualization",
                "description": "Connecting with and embodying the highest future version of oneself."
              },
              {
                "style": "Yoga Nidra for Inner Wisdom",
                "description": "Accessing deeper insights and understanding from within."
              },
              {
                "style": "Yoga Nidra with Mudras",
                "description": "Incorporating specific hand gestures (mudras) for added energetic benefit."
              },
              {
                "style": "Yoga Nidra with Aromatherapy",
                "description": "Using essential oils to enhance the relaxation and focus."
              },
              {
                "style": "Yoga Nidra with Crystal Healing",
                "description": "Placing crystals on or around the body to support specific intentions."
              },
              {
                "style": "Narrative Journey Nidra",
                "description": "Following a guided story or imaginative scenario."
              },
              {
                "style": "Symbolic Visualization Nidra",
                "description": "Working with archetypes and symbols for personal growth."
              },
              {
                "style": "Quantum Nidra",
                "description": "Exploring the interconnectedness of all things and infinite possibilities."
              },
              {
                "style": "Metta (Loving-Kindness) Nidra",
                "description": "Cultivating feelings of goodwill and kindness towards self and others."
              },
              {
                "style": "Yoga Nidra for Grief Support",
                "description": "A gentle space to process loss and find comfort."
              },
              {
                "style": "Yoga Nidra for Performance Enhancement",
                "description": "Mental rehearsal for improved athletic, artistic, or professional performance."
              },
              {
                "style": "Yoga Nidra for Spiritual Connection",
                "description": "Deepening one's connection to a higher power or universal consciousness."
              },
              {
                "style": "Shadow Work Nidra",
                "description": "Safely exploring and integrating repressed or undesirable aspects of the self."
              },
              {
                "style": "Ecological Nidra",
                "description": "Connecting with the natural world and fostering environmental awareness."
              },
              {
                "style": "Ancestral Healing Nidra",
                "description": "Connecting with ancestral wisdom and healing generational patterns."
              },
              {
                "style": "Divine Feminine Nidra",
                "description": "Embracing and balancing feminine energies within."
              },
              {
                "style": "Divine Masculine Nidra",
                "description": "Embracing and balancing masculine energies within."
              },
              {
                "style": "Inner Sanctuary Nidra",
                "description": "Creating and retreating to a safe, peaceful inner space."
              },
              {
                "style": "Compassion Nidra",
                "description": "Extending empathy and understanding to self and others."
              },
              {
                "style": "Equanimity Nidra",
                "description": "Cultivating inner peace and stability amidst life's fluctuations."
              },
              {
                "style": "Non-Attachment Nidra",
                "description": "Practicing the art of letting go and trusting the flow of life."
              },
              {
                "style": "Boundaries Nidra",
                "description": "Strengthening personal boundaries and protecting one's energy."
              },
              {
                "style": "Discernment Nidra",
                "description": "Enhancing the ability to see clearly and make wise choices."
              },
              {
                "style": "Detox Nidra",
                "description": "Releasing physical, mental, and emotional toxins."
              },
              {
                "style": "Immune Boost Nidra",
                "description": "Visualizing and strengthening the body's natural defense system."
              },
              {
                "style": "Digestive Harmony Nidra",
                "description": "Promoting healthy digestion and gut well-being."
              },
              {
                "style": "Circulatory Flow Nidra",
                "description": "Visualizing healthy blood flow and cardiovascular wellness."
              },
              {
                "style": "Nervous System Reset Nidra",
                "description": "Calming and rebalancing the nervous system."
              },
              {
                "style": "Cellular Regeneration Nidra",
                "description": "Imagining healthy cell growth and repair throughout the body."
              },
              {
                "style": "Spinal Alignment Nidra",
                "description": "Visualizing a healthy and aligned spine, releasing tension."
              },
              {
                "style": "Joint Health Nidra",
                "description": "Focusing on flexibility and lubrication in the joints."
              },
              {
                "style": "Organ Health Nidra",
                "description": "Directing healing energy to specific organs for optimal function."
              },
              {
                "style": "Lymphatic Flow Nidra",
                "description": "Supporting the body's natural detoxification and immune system."
              },
              {
                "style": "Hormonal Balance Nidra",
                "description": "Visualizing harmony within the endocrine system."
              },
              {
                "style": "Reproductive Health Nidra",
                "description": "Promoting well-being and balance in the reproductive system."
              },
              {
                "style": "Skin Radiance Nidra",
                "description": "Visualizing healthy, glowing skin from within."
              },
              {
                "style": "Hair & Nail Strength Nidra",
                "description": "Focusing on vitality and growth of hair and nails."
              },
              {
                "style": "Eye Health Nidra",
                "description": "Relaxing eye muscles and promoting clear vision."
              },
              {
                "style": "Ear Health Nidra",
                "description": "Releasing tension in the jaw and ears, promoting clear hearing."
              },
              {
                "style": "Throat Chakra Expression Nidra",
                "description": "Opening the throat chakra for authentic communication."
              },
              {
                "style": "Third Eye Awakening Nidra",
                "description": "Activating the third eye for enhanced intuition and perception."
              },
              {
                "style": "Crown Chakra Connection Nidra",
                "description": "Deepening spiritual connection and universal consciousness."
              },
              {
                "style": "Root Chakra Stability Nidra",
                "description": "Grounding oneself and fostering feelings of security."
              },
              {
                "style": "Sacral Chakra Flow Nidra",
                "description": "Enhancing creativity, pleasure, and emotional balance."
              },
              {
                "style": "Solar Plexus Power Nidra",
                "description": "Strengthening personal power, willpower, and confidence."
              },
              {
                "style": "Heart Chakra Expansion Nidra",
                "description": "Opening to love, compassion, and connection."
              },
              {
                "style": "Akashic Records Nidra",
                "description": "Accessing the energetic record of all universal events and knowledge."
              },
              {
                "style": "Parallel Lives Nidra",
                "description": "Exploring the concept of simultaneous existences or dimensions."
              },
              {
                "style": "Spirit Guide Connection Nidra",
                "description": "Opening to communication with benevolent spirit guides."
              },
              {
                "style": "Angelic Realm Nidra",
                "description": "Connecting with angelic energies for guidance and support."
              },
              {
                "style": "Faerie Realm Nidra",
                "description": "Exploring the magic and whimsy of the elemental fae."
              },
              {
                "style": "Star Seed Nidra",
                "description": "Connecting with cosmic origins and higher dimensions for star seeds."
              },
              {
                "style": "Meridian Line Balancing Nidra",
                "description": "Harmonizing the energetic pathways in the body."
              },
              {
                "style": "Aura Cleansing Nidra",
                "description": "Clearing and strengthening the energetic field around the body."
              },
              {
                "style": "Past Trauma Release Nidra",
                "description": "Gently releasing energetic imprints of past difficult experiences."
              },
              {
                "style": "Future Planning Nidra",
                "description": "Visualizing and setting intentions for future events and endeavors."
              },
              {
                "style": "Inner Teacher Nidra",
                "description": "Connecting with the innate wisdom and guidance within."
              },
              {
                "style": "Archetype Integration Nidra",
                "description": "Working with archetypal energies for personal growth and understanding."
              },
              {
                "style": "Mirror Work Nidra",
                "description": "Reflecting on self-image and cultivating self-acceptance."
              },
              {
                "style": "Inner Critic Release Nidra",
                "description": "Softening and transforming the voice of self-judgment."
              },
              {
                "style": "Inner Advocate Nidra",
                "description": "Strengthening the voice of self-support and encouragement."
              },
              {
                "style": "Playfulness Nidra",
                "description": "Invoking a sense of lightheartedness, joy, and inner child freedom."
              },
              {
                "style": "Resilience Nidra",
                "description": "Building mental and emotional toughness to bounce back from adversity."
              },
              {
                "style": "Humor Nidra",
                "description": "Finding lightness and laughter within, even in challenging situations."
              },
              {
                "style": "Adventure Nidra",
                "description": "Embarking on imaginative journeys and exploring new possibilities."
              },
              {
                "style": "Silence Nidra",
                "description": "A deep dive into pure silence and stillness of mind."
              },
              {
                "style": "Void Nidra",
                "description": "Exploring the concept of emptiness and ultimate potential."
              },
              {
                "style": "Oneness Nidra",
                "description": "Experiencing the interconnectedness of all beings and the universe."
              },
              {
                "style": "Surrender Nidra",
                "description": "Practicing the art of letting go and trusting the flow of life."
              },
              {
                "style": "Acceptance Nidra",
                "description": "Cultivating radical acceptance of what is, without judgment."
              },
              {
                "style": "Presence Nidra",
                "description": "Deepening awareness of the present moment, fully embodied."
              },
              {
                "style": "Intention Setting Nidra",
                "description": "Clearly defining and imprinting conscious desires and goals."
              },
              {
                "style": "Sankalpa Refinement Nidra",
                "description": "Clarifying and strengthening one's deepest heartfelt desire or resolve."
              },
              {
                "style": "Energy Blockage Release Nidra",
                "description": "Identifying and dissolving stagnant energy within the body and mind."
              }
            ];

            personas = [
              {
                "name": "Default Guide",
                "description": "A calm, neutral, and reassuring guide, focusing on traditional Yoga Nidra principles.",
                "vocal_quality": "Smooth, even-toned, and gentle.",
                "imagery": "General calming imagery, like a peaceful meadow or still lake.",
                "theme": "Relaxation and inner peace."
              },
              {
                "name": "The Vinyasa Flow Enthusiast",
                "description": "Practices dynamic yoga and seeks deep relaxation to balance high-energy flows and recover muscles.",
                "vocal_quality": "Clear, steady, with an underlying sense of fluidity.",
                "imagery": "References to energy flow, spaciousness, releasing tension from active muscles.",
                "theme": "Recovery, balance, and dynamic stillness."
              },
              {
                "name": "The Yin Yoga Lover",
                "description": "Already appreciates stillness and seeks to deepen their meditative practice and release fascial tension through Yoga Nidra.",
                "vocal_quality": "Soft, slow, and deeply grounding.",
                "imagery": "Deep roots, melting sensations, release, gentle lengthening.",
                "theme": "Deep release, stillness, and inner exploration."
              },
              {
                "name": "The Aspiring Yogi/Yogini",
                "description": "New to yoga and seeking an accessible way to experience the mental benefits and deeper states of yoga.",
                "vocal_quality": "Encouraging, clear, and reassuring.",
                "imagery": "Simple, universal calming images like clouds drifting, a gentle breeze.",
                "theme": "Gentle introduction, curiosity, and foundational well-being."
              },
              {
                "name": "The Yoga Teacher",
                "description": "Constantly giving to others and needs a powerful tool for self-care, energetic replenishment, and to deepen their own practice.",
                "vocal_quality": "Supportive, empathetic, with a knowing calm.",
                "imagery": "Replenishing light, quiet sanctuary, open space for self-nurturing.",
                "theme": "Self-care, replenishment, and authentic presence."
              },
              {
                "name": "The Ashtanga Practitioner",
                "description": "Engaged in a rigorous practice and needs intense mental and physical recovery to support their discipline.",
                "vocal_quality": "Focused, disciplined yet deeply soothing.",
                "imagery": "Deep rest for muscles, quietening the active mind, restorative coolness.",
                "theme": "Profound recovery, mental stillness, and disciplined ease."
              },
              {
                "name": "The Restorative Yoga Seeker",
                "description": "Draws comfort from supported poses and wants to extend that deep relaxation and healing into Yoga Nidra.",
                "vocal_quality": "Gentle, compassionate, and deeply comforting.",
                "imagery": "Soft blankets, gentle support, warmth, melting into ease.",
                "theme": "Nurturing, healing, and absolute surrender."
              },
              {
                "name": "The Hatha Yogi",
                "description": "Practices foundational poses and seeks to integrate mental and emotional balance with their physical practice.",
                "vocal_quality": "Balanced, steady, and clear.",
                "imagery": "Harmony, equilibrium, calm within the body and mind.",
                "theme": "Balance, integration, and holistic well-being."
              },
              {
                "name": "The Meditator Seeking Deeper States",
                "description": "Has a meditation practice but wants to explore the unique profound relaxation and subconscious access offered by Yoga Nidra.",
                "vocal_quality": "Subtle, guiding, with an emphasis on inner landscape.",
                "imagery": "Deepening awareness, subtle energy, expanding consciousness.",
                "theme": "Inner exploration, subconscious access, and expanded awareness."
              },
              {
                "name": "The Kirtan & Bhakti Yogi",
                "description": "Loves devotional practices and wants to integrate the emotional and spiritual depth of Bhakti with conscious relaxation.",
                "vocal_quality": "Heart-centered, melodious, and full of devotion.",
                "imagery": "Opening the heart, divine love, sacred sounds, flowing devotion.",
                "theme": "Devotion, love, and spiritual connection through rest."
              },
              {
                "name": "The Pranayama Student",
                "description": "Dedicated to breathwork and seeks to deepen their understanding and control of prana through Yoga Nidra.",
                "vocal_quality": "Rhythmic, spacious, and breath-focused.",
                "imagery": "Flow of vital energy, expansion, lightness, subtle currents.",
                "theme": "Pranic awareness, energetic control, and vital life force."
              },
              {
                "name": "The Chakra Balancer",
                "description": "Focuses on energetic centers and wants to use Yoga Nidra to harmonize and activate their chakras.",
                "vocal_quality": "Clear, focused, with energetic precision.",
                "imagery": "Vibrant colors, spinning wheels of light, ascending and descending energy.",
                "theme": "Energetic alignment, balance, and activation."
              },
              {
                "name": "The Mudra Enthusiast",
                "description": "Integrates hand gestures into their practice and seeks to combine these with the deep relaxation of Nidra.",
                "vocal_quality": "Precise, intentional, with an emphasis on energetic seals.",
                "imagery": "Interlocking energies, symbolic forms, subtle currents through the hands.",
                "theme": "Symbolic connection, energetic sealing, and focused intention."
              },
              {
                "name": "The Mantra Chantist",
                "description": "Uses sound and repetition in their yoga and wants to experience the profound effects of mantra within Nidra.",
                "vocal_quality": "Resonant, vibrational, and rhythmic.",
                "imagery": "Echoing sounds, vibrating silence, sacred syllables.",
                "theme": "Internal resonance, sacred sound, and vibrational healing."
              },
              {
                "name": "The Yoga Therapist",
                "description": "Working with clients and seeking a powerful, accessible tool for emotional regulation and healing to integrate into their sessions.",
                "vocal_quality": "Calm, empathetic, and therapeutically grounded.",
                "imagery": "Safe harbor, gentle release, building inner resources.",
                "theme": "Healing, emotional well-being, and gentle transformation."
              },
              {
                "name": "The Yoga Retreat Participant",
                "description": "On a retreat and seeking to fully immerse themselves in the transformative potential of deep rest and introspection.",
                "vocal_quality": "Expansive, immersive, and serene.",
                "imagery": "Tranquil landscapes, open horizons, deep silence, spaciousness.",
                "theme": "Deep immersion, introspection, and retreat from the mundane."
              },
              {
                "name": "The Yogi with a Home Practice",
                "description": "Practices yoga independently and wants a structured, guided way to enhance their at-home relaxation and meditative experiences.",
                "vocal_quality": "Clear, self-contained, and encouraging of self-reliance.",
                "imagery": "Personal sanctuary, inner journey, cultivating self-awareness.",
                "theme": "Self-guidance, personal discipline, and intimate practice."
              },
              {
                "name": "The Yogi Seeking Spiritual Growth",
                "description": "Uses yoga as a path to self-discovery and seeks Yoga Nidra to access deeper layers of consciousness and inner wisdom.",
                "vocal_quality": "Mystical, inspiring, and profound.",
                "imagery": "Divine light, universal consciousness, ancient wisdom, inner guru.",
                "theme": "Spiritual evolution, self-realization, and wisdom."
              },
              {
                "name": "The Yogi with Physical Limitations",
                "description": "Has injuries or physical challenges that limit asana practice and finds solace and profound benefit in accessible Yoga Nidra.",
                "vocal_quality": "Gentle, adaptable, and deeply compassionate.",
                "imagery": "Weightlessness, floating, healing light, comfort, ease.",
                "theme": "Comfort, healing beyond the physical, and gentle acceptance."
              },
              {
                "name": "The Yoga Philosophy Student",
                "description": "Studies the philosophical aspects of yoga and wants to experience the practical application of concepts like pratyahara and dharana.",
                "vocal_quality": "Intellectual yet soothing, clear and precise.",
                "imagery": "Inner space, focusing the mind, withdrawal of senses, clarity of thought.",
                "theme": "Practical philosophy, mental discipline, and experiential understanding."
              },
              {
                "name": "The Yogi with Sleep Issues",
                "description": "Finds yoga helps with general well-being but still struggles with sleep, seeking Yoga Nidra specifically for insomnia.",
                "vocal_quality": "Extremely soothing, monotonous, and gentle.",
                "imagery": "Drifting, soft clouds, deep night, restorative darkness.",
                "theme": "Deep rest, peaceful sleep, and nervous system calm."
              },
              {
                "name": "The Yogi Battling Burnout",
                "description": "Feels depleted despite their yoga practice and needs the profound rest and nervous system reset that Yoga Nidra offers.",
                "vocal_quality": "Restorative, deeply calming, and replenishing.",
                "imagery": "Cool springs, gentle rain, energetic refill, quiet stillness.",
                "theme": "Restoration, energy renewal, and nervous system regulation."
              },
              {
                "name": "The Post-Class Relaxation Seeker",
                "description": "Loves Savasana and wants to extend and deepen that state of relaxation and integration beyond the regular class.",
                "vocal_quality": "Soft, lingering, and integrative.",
                "imagery": "Melting, dissolving, absorption, unified stillness.",
                "theme": "Deep integration, sustained relaxation, and afterglow."
              },
              {
                "name": "The Yogi Preparing for a Big Event",
                "description": "Needs to manage pre-event anxiety, enhance focus, and visualize success through guided relaxation.",
                "vocal_quality": "Calmly empowering, focused, and positive.",
                "imagery": "Clear path, bright light, successful outcome, inner strength.",
                "theme": "Confidence, clarity, and successful manifestation."
              },
              {
                "name": "The Yogi on a Cleansing Journey",
                "description": "Engaged in a detox or cleanse and seeks Yoga Nidra to support physical release and mental clarity.",
                "vocal_quality": "Clean, refreshing, and purifying.",
                "imagery": "Flowing water, clear light, release of burdens, renewed energy.",
                "theme": "Purification, release, and clarity."
              },
              {
                "name": "The Yogi Cultivating Self-Compassion",
                "description": "Uses yoga to foster self-love and wants to deepen this connection through the gentle, nurturing space of Nidra.",
                "vocal_quality": "Tender, unconditionally kind, and gentle.",
                "imagery": "Warm embrace, soft light around the heart, nurturing touch.",
                "theme": "Self-love, acceptance, and gentle kindness."
              },
              {
                "name": "The Yogi Exploring Samskaras",
                "description": "Interested in releasing deep-seated patterns and impressions (samskaras) through subconscious work in Nidra.",
                "vocal_quality": "Observational, non-judgmental, and insightful.",
                "imagery": "Fading footprints, dissolving shadows, seeds transforming into light.",
                "theme": "Pattern release, subconscious healing, and inner freedom."
              },
              {
                "name": "The Yogi Seeking Clarity",
                "description": "Feels clouded or overwhelmed and wants to use Nidra to gain insight and clear decision-making ability.",
                "vocal_quality": "Crisp, insightful, and illuminating.",
                "imagery": "Clearing fog, bright light, still waters reflecting truth, a clear path.",
                "theme": "Mental clarity, insight, and decisive action."
              },
              {
                "name": "The Yogi Embracing Ahimsa",
                "description": "Practices non-harming and wants to extend this principle to their inner world, fostering kindness to self.",
                "vocal_quality": "Gentle, peaceful, and compassionate.",
                "imagery": "Softness, tenderness, absence of struggle, loving presence.",
                "theme": "Inner non-harming, peace, and self-kindness."
              },
              {
                "name": "The Yogi Integrating Yamas & Niyamas",
                "description": "Working on the ethical principles of yoga and seeks a practice to embody qualities like contentment (santosha) and truthfulness (satya).",
                "vocal_quality": "Principled, steady, and embodying virtue.",
                "imagery": "Inner strength, solid foundation, clear reflections of truth, radiant contentment.",
                "theme": "Ethical living, inner virtue, and character development."
              },
              {
                "name": "The Yogi with Hormonal Imbalance",
                "description": "Seeking natural ways to balance hormones and reduce stress-related symptoms through deep relaxation.",
                "vocal_quality": "Balancing, soothing, and harmonizing.",
                "imagery": "Gentle flow, equilibrium, inner harmony, blossoming.",
                "theme": "Hormonal balance, inner calm, and well-being."
              },
              {
                "name": "The Yogi Preparing for Pregnancy/Birth",
                "description": "Looking for relaxation techniques to ease anxiety, connect with their body, and prepare for childbirth.",
                "vocal_quality": "Calm, nurturing, and empowering.",
                "imagery": "Gentle waves, blooming flower, safe haven, inner strength for birth.",
                "theme": "Connection, peace, and preparation for new life."
              },
              {
                "name": "The Yogi Post-Childbirth",
                "description": "A new parent needing profound rest, emotional support, and time for healing and integration.",
                "vocal_quality": "Deeply compassionate, restful, and supportive.",
                "imagery": "Warm cocoon, replenishing sleep, gentle healing light, unconditional love.",
                "theme": "Restoration, healing, and self-nurturing for new parents."
              },
              {
                "name": "The Yogi Seeking More Energy",
                "description": "Feels sluggish and wants to tap into deeper reserves of vitality through conscious relaxation and energy awareness.",
                "vocal_quality": "Invigorating yet relaxing, vibrant.",
                "imagery": "Rising sun, fresh breeze, sparkling light, inner dynamo.",
                "theme": "Vitality, energy cultivation, and radiant well-being."
              },
              {
                "name": "The Yogi with Joint Stiffness",
                "description": "Experiences discomfort in joints and seeks mental relaxation to complement physical flexibility work, potentially reducing perceived pain.",
                "vocal_quality": "Soothing, freeing, and easing.",
                "imagery": "Flowing water, lubrication, warmth, gentle expansion, ease of movement.",
                "theme": "Flexibility, comfort, and release of stiffness."
              },
              {
                "name": "The Yogi Exploring the Koshas",
                "description": "Interested in the layered dimensions of self (koshas) and wants to journey through them during Nidra.",
                "vocal_quality": "Layered, insightful, and progressively deepening.",
                "imagery": "Unveiling layers, subtle bodies, light permeating through dimensions.",
                "theme": "Holistic self-awareness, layered existence, and spiritual integration."
              },
              {
                "name": "The Yogi Cultivating Inner Peace",
                "description": "His or her ultimate goal in yoga is profound inner tranquility and seeks Nidra to achieve this state consistently.",
                "vocal_quality": "Profoundly peaceful, still, and unwavering.",
                "imagery": "Still lake, calm center, boundless blue sky, silent sanctuary.",
                "theme": "Ultimate tranquility, profound peace, and inner stillness."
              },
              {
                "name": "The Yogi Detaching from Outcomes",
                "description": "Practices Karma Yoga (action without attachment) and wants to apply this to their personal life through Nidra.",
                "vocal_quality": "Liberating, releasing, and non-attached.",
                "imagery": "Flowing river, open hands, clouds drifting by, lightness of being.",
                "theme": "Non-attachment, freedom, and inner liberation."
              },
              {
                "name": "The Yogi Seeking Presence",
                "description": "Struggles with being fully in the moment during daily life and uses Nidra to train their mind for greater presence.",
                "vocal_quality": "Grounding, immediate, and attentive.",
                "imagery": "Rooting down, sensory awareness, here and now, a single point of light.",
                "theme": "Mindful presence, awareness, and embodied being."
              },
              {
                "name": "The Yogi Visualizing Asana Improvement",
                "description": "Wants to enhance their physical yoga practice by mentally rehearsing poses and improving body awareness during Nidra.",
                "vocal_quality": "Directive, supportive, and precise in visualization.",
                "imagery": "Perfect alignment, effortless movement, strong foundation, flexible grace.",
                "theme": "Physical enhancement, mental rehearsal, and peak performance."
              },
              {
                "name": "The Yogi Managing Chronic Illness",
                "description": "Living with a long-term health condition and using Nidra for symptomatic relief, stress reduction, and emotional support.",
                "vocal_quality": "Empathetic, soothing, and gently empowering.",
                "imagery": "Healing light, comfort, gentle acceptance, inner resilience.",
                "theme": "Symptom management, emotional support, and inner strength."
              },
              {
                "name": "The Yogi on a Solo Journey",
                "description": "Enjoys individual exploration and wants a guided yet deeply personal experience of inner discovery.",
                "vocal_quality": "Intimate, reflective, and spacious.",
                "imagery": "Personal pathway, inner landscape, solitary mountain peak, deep well of wisdom.",
                "theme": "Self-discovery, introspection, and personal pilgrimage."
              },
              {
                "name": "The Yogi Embracing Shadow Work",
                "description": "Ready to explore deeper subconscious patterns and integrate less conscious aspects of themselves for wholeness.",
                "vocal_quality": "Brave, accepting, and transformative.",
                "imagery": "Illuminating shadows, embracing all parts of self, inner alchemy, integration.",
                "theme": "Wholeness, integration, and courageous self-acceptance."
              },
              {
                "name": "The Yogi Seeking Unconditional Love",
                "description": "Wants to cultivate deeper love for themselves and others, opening the heart through guided relaxation.",
                "vocal_quality": "Heart-opening, compassionate, and expansive.",
                "imagery": "Warm light from the heart, infinite compassion, overflowing love, universal connection.",
                "theme": "Unconditional love, heart expansion, and universal connection."
              },
              {
                "name": "The Yogi Releasing Trapped Emotions",
                "description": "Holds tension in the body from unexpressed emotions and seeks a safe space to release them.",
                "vocal_quality": "Safe, gentle, and releasing.",
                "imagery": "Flowing tears (metaphorical), melting ice, birds flying free, light dissipating darkness.",
                "theme": "Emotional release, freedom, and lightness of being."
              },
              {
                "name": "The Yogi Cultivating Resilience",
                "description": "Aims to bounce back from life's challenges with greater ease and seeks Nidra to build inner strength.",
                "vocal_quality": "Steadfast, empowering, and strengthening.",
                "imagery": "Deep roots, flexible branches, unshakeable core, rising sun.",
                "theme": "Inner strength, adaptability, and emotional fortitude."
              },
              {
                "name": "The Yogi Exploring Dream States",
                "description": "Intrigued by dreams and wants to use Nidra to enhance dream recall or lucid dreaming experiences.",
                "vocal_quality": "Mysterious, fluid, and suggestive.",
                "imagery": "Veil between worlds, swirling colors, symbolic landscapes, dream characters.",
                "theme": "Dream exploration, subconscious insights, and lucid awareness."
              },
              {
                "name": "The Yogi Seeking Anandamaya Kosha Experience",
                "description": "Aims to touch the bliss body through deeper states of consciousness and relaxation.",
                "vocal_quality": "Blissful, transcendent, and expansive.",
                "imagery": "Pure light, infinite joy, boundless peace, cosmic embrace.",
                "theme": "Bliss, transcendence, and ultimate peace."
              },
              {
                "name": "The Yogi Working with Samyama",
                "description": "Practicing concentration, meditation, and absorption (Dharana, Dhyana, Samadhi) and seeks Nidra as a path.",
                "vocal_quality": "Focused, profound, and deeply guiding.",
                "imagery": "Single point of light, vast emptiness, merging with awareness, infinite silence.",
                "theme": "Deep concentration, meditative absorption, and ultimate union."
              },
              {
                "name": "The Yogi Integrating Yoga Beyond the Mat",
                "description": "Wants to bring the peace and insights gained on the yoga mat into their daily life.",
                "vocal_quality": "Practical, relatable, and grounding the spiritual.",
                "imagery": "Radiant presence in daily tasks, calm amidst chaos, flowing with life's rhythm.",
                "theme": "Embodied presence, mindful living, and practical integration."
              },
              {
                "name": "The Yogi Seeking Deeper Intuition",
                "description": "Aims to strengthen their inner knowing and trust their gut feelings through quiet contemplation.",
                "vocal_quality": "Subtle, perceptive, and trust-inspiring.",
                "imagery": "Still inner voice, clear vision, knowing glance, quiet wisdom.",
                "theme": "Intuitive wisdom, inner guidance, and trusting oneself."
              }
            ];


            // This re-generates the systemPrompt for all personas on load,
            // which is necessary if the source JSON for 'personas' doesn't include it.
            // It ensures consistency in prompt generation regardless of persona data source.
            function initializePersonaSystemPrompts() {
                personas.forEach(p => {
                    // Map 'Persona' to 'name' and 'short_description' to 'description' if they exist
                    if (p.Persona && !p.name) {
                        p.name = p.Persona;
                    }
                    if (p.short_description && !p.description) {
                        p.description = p.short_description;
                    }

                    if (!p.systemPrompt) {
                        p.systemPrompt = `You are an AI assistant creating a Yoga Nidra script. Adopt the persona of **${p.name}**.
                        **Detailed Persona Profile:**
                        - **Description:** ${p.description || 'No description provided.'}
                        - **Vocal Quality:** ${p.vocal_quality || 'A calming voice.'}
                        - **Imagery Style:** ${p.imagery || 'General calming imagery.'}
                        - **Core Theme:** ${p.theme || 'Relaxation and inner peace.'}
                        
                        Your script must include traditional Yoga Nidra stages (inner stillness, sankalpa, rotation of consciousness, breath, sensations, visualization, final sankalpa, externalization).
                        Adapt the length based on user's preference.`;
                    }
                });
            }

            function initializeApp() {
                initializePersonaSystemPrompts(); 
                populateStyleSelect(); 
                populateScriptLengthSelect();
                populatePersonaSelect();
                addEventListeners(); 
                resetApp(); 
                checkAndPromptForKey();
            }
            
            // --- UI Population Functions ---

            function populateStyleSelect() { 
                styleListArea.innerHTML = ''; 

                // Add "None (Optional)" option
                const noneLabel = document.createElement('label');
                noneLabel.className = 'dropdown-label';
                noneLabel.innerHTML = `
                    <input type="radio" name="style" value="" class="accent-indigo-500">
                    <span>None (Optional)</span>
                `;
                noneLabel.title = "Select no specific style, allowing the AI to choose a general approach.";
                if (selectedStyleName === "") {
                    noneLabel.querySelector('input').checked = true;
                }
                noneLabel.querySelector('input').addEventListener('change', () => {
                    selectedStyleName = "";
                    updateStyleButton("");
                    styleDropdownContent.classList.add('hidden'); 
                });
                styleListArea.appendChild(noneLabel);

                // Sort yogaNidraStyles alphabetically by 'style' name
                const sortedStyles = [...yogaNidraStyles].sort((a, b) => a.style.localeCompare(b.style));

                // Populate other styles
                sortedStyles.forEach(style => {
                    const label = document.createElement('label');
                    label.className = 'dropdown-label';
                    label.title = style.description; 
                    
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'style';
                    radio.value = style.style;
                    radio.className = 'accent-indigo-500';
                    if (selectedStyleName === style.style) {
                        radio.checked = true;
                    }

                    radio.addEventListener('change', () => {
                        selectedStyleName = radio.value;
                        updateStyleButton(selectedStyleName);
                        styleDropdownContent.classList.add('hidden'); 
                    });
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = style.style;
                    
                    label.appendChild(radio);
                    label.appendChild(nameSpan);
                    styleListArea.appendChild(label);
                });
            }

            function updateStyleButton(styleName) { 
                const buttonSpan = styleDropdownButton.querySelector('span');
                buttonSpan.textContent = styleName || "Select a Style (Optional)";
            }

            function populatePersonaSelect() {
                personaListArea.innerHTML = '';
                
                // Separate default persona and other personas
                const defaultPersona = personas[0];
                const otherPersonas = personas.slice(1);

                // Sort other personas alphabetically by 'name'
                const sortedOtherPersonas = [...otherPersonas].sort((a, b) => a.name.localeCompare(b.name));

                // Add the "None (Default Guide)" option explicitly at the top
                const noneLabel = document.createElement('label');
                noneLabel.className = 'dropdown-label flex justify-between items-center';
                noneLabel.innerHTML = `
                    <div>
                        <input type="radio" name="persona" value="0" class="accent-indigo-500">
                        <span>None (Default Guide)</span>
                    </div>
                `;
                noneLabel.title = defaultPersona.description; 

                if (selectedPersonaIndex === null || selectedPersonaIndex === 0) {
                    noneLabel.querySelector('input').checked = true;
                    selectedPersonaIndex = 0; 
                    updatePersonaButton(0);
                }
                noneLabel.querySelector('input').addEventListener('change', () => {
                    selectedPersonaIndex = 0; 
                    updatePersonaButton(0);
                    personaDropdownContent.classList.add('hidden');
                });
                personaListArea.appendChild(noneLabel);


                // Populate the rest of the personas (from index 1 onwards in the new array)
                sortedOtherPersonas.forEach((persona, index) => {
                    // Adjust index for value to be unique and consistent with original array if needed,
                    // but for display purposes, just use the sorted order.
                    // The actual value will be the original index if we want to retrieve the full persona object easily.
                    // For now, let's keep it simple and use the sorted index + 1 (since 0 is default)
                    const originalIndex = personas.indexOf(persona); // Find original index for data retrieval
                    const label = document.createElement('label');
                    label.className = 'dropdown-label flex justify-between items-center';
                    label.title = persona.description; 
                    
                    const contentDiv = document.createElement('div');
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'persona';
                    radio.value = originalIndex; // Use original index as value
                    radio.className = 'accent-indigo-500';
                     if (originalIndex === selectedPersonaIndex) { // Check against original index
                        radio.checked = true;
                    }

                    radio.addEventListener('change', () => {
                        selectedPersonaIndex = parseInt(radio.value);
                        updatePersonaButton(selectedPersonaIndex);
                        personaDropdownContent.classList.add('hidden');
                    });
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = persona.name;
                    
                    contentDiv.appendChild(radio);
                    contentDiv.appendChild(nameSpan);

                    const infoButton = document.createElement('button');
                    infoButton.className = 'info-btn';
                    infoButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle text-gray-400" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.45-.083a.25.25 0 0 1-.288-.469l.738-3.468a.25.25 0 0 1 .469-.288zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>`;
                    infoButton.dataset.index = originalIndex; // Use original index for detail lookup

                    label.appendChild(contentDiv);
                    label.appendChild(infoButton);
                    personaListArea.appendChild(label);
                });
            }

            function showPersonaDetailModal(persona) {
                personaModalTitle.textContent = persona.name;
                // Safely access properties, providing fallback if they don't exist
                personaModalContent.innerHTML = `
                    <div class="modal-content-title">Description:</div><p>${persona.description || 'No description provided.'}</p>
                    <div class="modal-content-title">Vocal Quality:</div><p>${persona.vocal_quality || 'Not specified.'}</p>
                    <div class="modal-content-title">Imagery:</div><p>${persona.imagery || 'Not specified.'}</p>
                    <div class="modal-content-title">Theme:</div><p>${persona.theme || 'Not specified.'}</p>
                `;
                personaDetailModal.classList.remove('hidden');
            }


            function addEventListeners() {
                generateBtn.addEventListener('click', handleGenerateScript);
                promptInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleGenerateScript(); } });
                resetAppBtn.addEventListener('click', resetApp);
                copyScriptBtn.addEventListener('click', copyScriptToClipboard);
                helpIcon.addEventListener('click', () => instructionsModal.classList.remove('hidden'));
                closeInstructionsModalBtn.addEventListener('click', () => instructionsModal.classList.add('hidden'));
                apiKeyBtn.addEventListener('click', () => apiKeyModal.classList.remove('hidden'));
                closeApiKeyModalBtn.addEventListener('click', () => apiKeyModal.classList.add('hidden'));
                saveApiKeyBtn.addEventListener('click', saveApiKey);
                closePersonaModalBtn.addEventListener('click', () => personaDetailModal.classList.add('hidden'));

                // Style Dropdown Event Listeners - CORRECTED
                styleDropdownButton.addEventListener('click', (event) => { // Attach to the button
                    event.stopPropagation(); 
                    styleDropdownContent.classList.toggle('hidden');
                });

                // Persona Dropdown Event Listeners - CORRECTED
                personaDropdownButton.addEventListener('click', (event) => { // Attach to the button
                    event.stopPropagation(); 
                    personaDropdownContent.classList.toggle('hidden');
                });
                
                // Global click listener to close dropdowns when clicking outside
                document.addEventListener('click', (event) => { 
                    // Close Style dropdown if click is outside
                    if (!styleDropdownButton.contains(event.target) && !styleDropdownContent.contains(event.target)) {
                        styleDropdownContent.classList.add('hidden');
                    }
                    // Close Persona dropdown if click is outside
                    if (!personaDropdownButton.contains(event.target) && !personaDropdownContent.contains(event.target)) { 
                        personaDropdownContent.classList.add('hidden'); 
                    }
                });
                
                // Event delegation for persona info buttons
                personaListArea.addEventListener('click', (event) => {
                    const infoButton = event.target.closest('.info-btn');
                    if (infoButton) {
                        event.stopPropagation(); 
                        const personaIndex = parseInt(infoButton.dataset.index);
                        if (!isNaN(personaIndex) && personas[personaIndex]) {
                            showPersonaDetailModal(personas[personaIndex]);
                        }
                    }
                });
            }

            function resetApp() {
                scriptDisplayArea.innerHTML = '';
                promptInput.value = '';
                currentGeneratedScript = '';
                scriptLengthSelect.value = "15 minutes"; // Default length set to 15 minutes
                
                selectedStyleName = ""; // Reset custom style dropdown state
                updateStyleButton(""); // Update button text
                populateStyleSelect(); // Re-populate to reflect reset state

                selectedPersonaIndex = 0; 
                updatePersonaButton(0); 
                populatePersonaSelect(); 
                
                updateButtonStates();
                displaySystemMessage("Enter an intention, or select a style to begin.");
            }

            function checkAndPromptForKey() {
                if (!apiKey) {
                    apiKeyModal.classList.remove('hidden');
                }
            }

            function saveApiKey() {
                const key = apiKeyInput.value.trim();
                if (key) {
                    apiKey = key;
                    apiKeyInput.value = '';
                    apiKeyModal.classList.add('hidden');
                    displaySystemMessage("API Key saved. You can now generate a script.");
                } else {
                    alert("Please enter a valid API key.");
                }
            }
            
            function populateScriptLengthSelect() {
                scriptLengthSelect.innerHTML = '';
                lengthOptions.forEach((option) => {
                    const opt = document.createElement('option');
                    opt.value = option.name;
                    opt.textContent = option.name;
                    scriptLengthSelect.appendChild(opt);
                });
            }

            function updatePersonaButton(index) {
                if (personas[index]) {
                   personaDropdownButton.querySelector('span').textContent = personas[index].name;
                } else {
                   personaDropdownButton.querySelector('span').textContent = 'Select Persona (Optional)';
                }
            }
            
            async function handleGenerateScript() {
                if (!apiKey) {
                    displaySystemMessage("Please set your API key first by clicking the key icon.", 'error-message');
                    checkAndPromptForKey();
                    return;
                }
                const customIntention = promptInput.value.trim();
                // Get selected style name from the state variable, not a select element
                const currentSelectedStyleName = selectedStyleName; 

                if (!currentSelectedStyleName && !customIntention) {
                    displaySystemMessage("Please enter an intention, or select a style.", 'error-message');
                    return;
                }
                if (isGenerating) return;

                setLoading(true);
                scriptDisplayArea.innerHTML = '';
                displaySystemMessage("Generating your Yoga Nidra script...", 'system-message-paragraph');

                try {
                    const lengthInstruction = lengthOptions.find(opt => opt.name === scriptLengthSelect.value).promptSuffix;
                    const finalPersonaIndex = (selectedPersonaIndex !== null && selectedPersonaIndex < personas.length) ? selectedPersonaIndex : 0;
                    const personaInstruction = personas[finalPersonaIndex].systemPrompt;

                    let themeInstruction = '';
                    // Use currentSelectedStyleName from the state variable
                    const selectedStyle = yogaNidraStyles.find(style => style.style === currentSelectedStyleName); 
                    if (selectedStyle) {
                        themeInstruction = `The core theme is **${selectedStyle.style}**. Description: *${selectedStyle.description}*`;
                    }

                    let intentionInstruction = '';
                    if (customIntention) {
                        intentionInstruction = `Please weave in this specific user intention: **"${customIntention}"**.`;
                    }

                    // If no style selected but custom intention exists, use intention as theme
                    if (!selectedStyle && customIntention) { 
                        themeInstruction = `The core theme is the user's intention: **"${customIntention}"**.`;
                        intentionInstruction = '';
                    }

                    const scriptGenerationPrompt = `${personaInstruction}\n\n--- SCRIPT REQUIREMENTS ---\n${themeInstruction}\n${intentionInstruction}\n${lengthInstruction}`;
                    const aiResponseText = await getAIResponse(scriptGenerationPrompt);
                    currentGeneratedScript = aiResponseText;

                    const titlePrompt = `Based on the following Yoga Nidra script, provide a short, creative title. Respond with only the title text, no quotes.\nScript: ${aiResponseText}`;
                    const generatedTitle = await getAIResponse(titlePrompt);

                    // Pass currentSelectedStyleName to displayGeneratedScript
                    displayGeneratedScript(currentGeneratedScript, customIntention, generatedTitle, personas[finalPersonaIndex].name, currentSelectedStyleName); 
                } catch (error) {
                    console.error("Error generating script:", error);
                    displaySystemMessage(`Failed to generate script: ${error.message}. Please try again.`, 'error-message');
                    currentGeneratedScript = '';
                } finally {
                    setLoading(false);
                }
            }
            
            function displayGeneratedScript(scriptText, customIntention, aiTitle, personaName, scriptStyle) {
                scriptDisplayArea.innerHTML = '';
                const titleElement = document.createElement('h2');
                titleElement.classList.add('script-title');
                let promptHTML = '';
                if (scriptStyle) { 
                    promptHTML += `<div style="font-size: 1.2rem; color: #9ca3af;">Style: <span class="text-white">${scriptStyle}</span></div>`;
                }
                if (customIntention) {
                    promptHTML += `<div style="font-size: 1.2rem; color: #9ca3af;">Custom Intention: <span class="text-white">${customIntention}</span></div>`;
                }
                titleElement.innerHTML = `
                    ${promptHTML || `<div style="font-size: 1.2rem; color: #9ca3af;">Intention: General Relaxation</div>`}
                    <div style="font-size: 1.8rem; margin-top: 0.5rem; margin-bottom: 0.5rem;">${aiTitle}</div>
                    <div style="font-size: 1.2rem; color: #9ca3af;">Persona: <span class="text-white">${personaName}</span></div>
                `;
                scriptDisplayArea.appendChild(titleElement);
                const scriptParagraph = document.createElement('p');
                scriptParagraph.classList.add('generated-script');
                scriptParagraph.textContent = scriptText;
                scriptDisplayArea.appendChild(scriptParagraph);
                window.scrollTo(0, 0);
            }

            function displaySystemMessage(text, type = 'system-message-paragraph') {
                scriptDisplayArea.querySelectorAll('.system-message-paragraph, .error-message-paragraph').forEach(el => el.remove());
                const messageWrapper = document.createElement('div');
                messageWrapper.className = type;
                messageWrapper.innerHTML = text.replace(/\n/g, '<br>');
                scriptDisplayArea.appendChild(messageWrapper);
            }

            function copyScriptToClipboard() {
                if (currentGeneratedScript) {
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = currentGeneratedScript;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);
                    // Use a temporary message that doesn't clear the whole screen
                    const copyButton = document.getElementById('copy-script-btn');
                    const originalText = copyButton.textContent;
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => {
                        copyButton.textContent = originalText;
                    }, 2000);
                }
            }

            function updateButtonStates() {
                generateBtn.disabled = isGenerating;
                copyScriptBtn.disabled = isGenerating || !currentGeneratedScript;
                resetAppBtn.disabled = isGenerating;
                promptInput.disabled = isGenerating;
                promptInput.placeholder = isGenerating ? 'Generating...' : "Enter your script intention here...";
            }

            function setLoading(isLoading) {
                isGenerating = isLoading;
                loadingSpinner.classList.toggle('hidden', !isLoading);
                updateButtonStates();
            }

            async function getAIResponse(prompt) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        const errorData = JSON.parse(errorText || "{}");
                        throw new Error(errorData?.error?.message || `API request failed with status ${response.status}`);
                    }
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else if (result.candidates?.[0]?.finishReason === 'SAFETY') {
                        throw new Error("The response was blocked due to safety settings. Please modify your prompt and try again.");
                    } else {
                        throw new Error(`Unexpected API response format. Check console for details.`);
                    }
                } catch (error) {
                    console.error("Fetch error:", error);
                    throw new Error("Network error or failed API request. Please check your connection and API key.");
                }
            }
            
            // --- Initialization ---
            initializeApp();
        });
    </script>
</body>
</html>
