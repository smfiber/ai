<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Infographic Creator v9.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Roboto+Slab:wght@700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .font-serif { font-family: 'Roboto Slab', serif; }
        [contentEditable=true]:empty:before { content: attr(placeholder); color: #9ca3af; pointer-events: none; }
        .control-panel-section { border-bottom-width: 1px; }

        /* Layout Styles */
        .timeline-container { position: relative; padding: 2rem 0; }
        .timeline-container::before { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 4px; height: 100%; background-color: var(--timeline-accent-color, #3b82f6); border-radius: 2px; }
        .timeline-item { position: relative; width: 50%; padding: 1rem 2.5rem; box-sizing: border-box; }
        .timeline-item:nth-child(odd) { left: 0; padding-right: 4rem; text-align: right; }
        .timeline-item:nth-child(even) { left: 50%; padding-left: 4rem; text-align: left; }
        .timeline-item-content { display: flex; flex-direction: column; align-items: inherit; }
        .timeline-item::after { content: ''; position: absolute; width: 20px; height: 20px; border-radius: 50%; background-color: white; border: 4px solid var(--timeline-accent-color, #3b82f6); top: 50%; transform: translateY(-50%); z-index: 1; }
        .timeline-item:nth-child(odd)::after { right: -10px; }
        .timeline-item:nth-child(even)::after { left: -10px; }
        .masonry-container { column-count: 3; column-gap: 1.5rem; }
        .masonry-item { display: inline-block; width: 100%; margin-bottom: 1.5rem; }
        @media (max-width: 1024px) { .masonry-container { column-count: 2; } }
        @media (max-width: 640px) { .masonry-container { column-count: 1; } }

        /* UI enhancements */
        .group:hover .regenerate-icon-btn { opacity: 1; }
        .brand-color-swatch:hover { transform: scale(1.1); box-shadow: 0 0 0 2px white; }
        .interactive-element { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .interactive-element:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .is-exporting .export-hidden { display: none !important; }
        .template-card { transition: all 0.2s ease-in-out; }
        .template-card:hover { transform: scale(1.05); border-color: #3b82f6; }

    </style>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        // Gemini AI Infographic Creator - Version 9.0
        // Phase 4: Templating System
        // - Added a template library with pre-designed, editable infographics.
        // - Application now starts with a template selection screen.
        // - Selecting a template populates the entire canvas with content, layout, and theme.

        // --- ICONS ---
        const SparklesIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>);
        const EyeIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></svg>);
        const ImageIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>);
        const ChevronDownIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>);
        const RefreshCwIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M3 21a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 16" /><path d="M3 16v5h5" /></svg>);
        const ChartBarIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>);
        const LinkIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>);
        const FilePlusIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="12" x2="12" y1="18" y2="12"/><line x1="9" x2="15" y1="15" y2="15"/></svg>);
        const Spinner = ({ size = 'h-8 w-8' }) => <div className={`animate-spin rounded-full ${size} border-b-2 border-white`}></div>;

        // --- Data ---
        const PREDEFINED_LAYOUTS = [
            { name: 'Vertical List', layout: { containerStyle: { display: 'flex', flexDirection: 'column', gap: '2rem', alignItems: 'center' }, cardStyle: { width: '80%', maxWidth: '600px' }}},
            { name: '2-Column Grid', layout: { containerStyle: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '2rem' }, cardStyle: {}}},
            { name: '3-Column Grid', layout: { containerStyle: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '2rem' }, cardStyle: {}}},
            { name: 'Staggered Grid (Masonry)', layout: { containerStyle: { }, cardStyle: {}}},
            { name: 'Alternating Timeline', layout: { containerStyle: { }, cardStyle: { }}},
            { name: 'Hub and Spoke', layout: { containerStyle: { display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2rem' }, cardStyle: {}}},
        ];
        
        const TEMPLATES = [
            {
                name: "Quarterly Business Review",
                description: "A professional template to showcase key metrics and achievements.",
                mainTitle: "Quarterly Business Review: Q2",
                layout: PREDEFINED_LAYOUTS[1], // 2-Column Grid
                theme: { backgroundColor: '#f3f4f6', cardColor: '#ffffff', textColor: '#111827', accentColor: '#3b82f6', fontFamily: 'font-sans', borderColor: '#e5e7eb', shadowStyle: 'shadow-md' },
                tasks: [
                    { title: "Revenue Growth", description: "Achieved a 15% increase in quarterly revenue compared to Q1." },
                    { title: "Customer Acquisition", description: "Onboarded 250 new enterprise clients." },
                    { title: "Productivity", description: "Team productivity up by 10% with new workflow automation." },
                    { title: "Market Expansion", description: "Successfully launched in the European market." },
                ],
                elements: [
                    { id: 'chart-qbr', type: 'chart', chartType: 'bar', link: '', data: { labels: ['Q1', 'Q2', 'Q3', 'Q4'], datasets: [{ label: 'Revenue (in M)', data: [1.2, 1.5, 1.8, 2.1], backgroundColor: ['#3b82f6', '#10b981', '#f97316', '#ef4444']}] }, options: { responsive: true, plugins: { legend: { display: true }, title: { display: true, text: 'Quarterly Revenue Growth', color: '#111827'}}}}
                ]
            },
            {
                name: "Social Media Milestones",
                description: "A vibrant, engaging template to celebrate your social media success.",
                mainTitle: "We've Reached 100k Followers!",
                layout: PREDEFINED_LAYOUTS[2], // 3-Column Grid
                theme: { backgroundColor: '#18181b', cardColor: '#27272a', textColor: '#e4e4e7', accentColor: '#a855f7', fontFamily: 'font-sans', borderColor: '#3f3f46', shadowStyle: 'shadow-lg shadow-purple-500/10' },
                tasks: [
                    { title: "Follower Growth", description: "From 10k to 100k in just 6 months!" },
                    { title: "Top Post", description: "Our 'Behind the Scenes' video reached 1M views." },
                    { title: "Engagement Rate", description: "Increased average engagement by 25%." },
                    { title: "Community Love", description: "Over 50,000 positive comments and messages." },
                    { title: "New Platforms", description: "Successfully launched on TikTok and Threads." },
                    { title: "Thank You!", description: "We couldn't have done it without our amazing community." },
                ],
                elements: []
            }
        ];

        // --- Main Application ---
        function App() {
            const { useState, useRef, useEffect } = React;

            const [apiKey, setApiKey] = useState("");
            const [tempApiKey, setTempApiKey] = useState("");
            const [isProjectStarted, setIsProjectStarted] = useState(false);
            const [isContentGenerated, setIsContentGenerated] = useState(false);
            const [tasks, setTasks] = useState([]);
            const [mainTitle, setMainTitle] = useState("AI Infographic Creator");
            const [selectedLayout, setSelectedLayout] = useState(PREDEFINED_LAYOUTS[0]);
            const [designTheme, setDesignTheme] = useState({ backgroundColor: '#111827', cardColor: '#1f2937', textColor: '#f3f4f6', accentColor: '#3b82f6', fontFamily: 'font-sans', borderColor: '#374151', shadowStyle: 'shadow-lg' });
            const [backgroundImage, setBackgroundImage] = useState(null);
            
            const [isLoading, setIsLoading] = useState({ content: false, singleIcon: null, aiChart: false, export: false });
            const [error, setError] = useState(null);
            
            const [brandingKit, setBrandingKit] = useState({ logo: null, colors: [] });
            const [elements, setElements] = useState([]); 

            const [showChartModal, setShowChartModal] = useState(null);
            const [showPreviewModal, setShowPreviewModal] = useState(false);
            const [previewData, setPreviewData] = useState(null);
            const [exportFormat, setExportFormat] = useState('PNG');

            const infographicRef = useRef(null);
            const fileInputRef = useRef(null);
            const logoFileInputRef = useRef(null);

            useEffect(() => {
                const storedKey = localStorage.getItem("gemini_api_key");
                if (storedKey) setApiKey(storedKey);
            }, []);
            
            // --- API Logic ---
            const callGeminiAPI = async (prompt, schema = null, isTextOnly = false) => {
                if (!apiKey) throw new Error("API Key is not set.");
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                if (!isTextOnly) {
                    payload.generationConfig = { responseMimeType: "application/json" };
                    if (schema) payload.generationConfig.responseSchema = schema;
                }
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
                const result = await response.json();
                const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!rawText) throw new Error("API returned no content.");
                
                if (isTextOnly) return rawText.trim();

                try {
                    const jsonString = rawText.substring(rawText.indexOf('{'), rawText.lastIndexOf('}') + 1);
                    return JSON.parse(jsonString);
                } catch (e) {
                    throw new Error(`JSON Parsing Error.`);
                }
            };

            const handleGenerateContent = async () => {
                setIsLoading(p => ({...p, content: true}));
                setError(null);
                setTasks([]);
                try {
                    const prompt = `Create JSON for an infographic about "${mainTitle}". The JSON must have a "mainTitle" (string) and "points" (an array of objects, each with "title" and "description").`;
                    const schema = { type: "OBJECT", properties: { mainTitle: {type: "STRING"}, points: { type: "ARRAY", items: {type: "OBJECT", properties: {title: {type:"STRING"}, description: {type:"STRING"}}, required: ["title", "description"]}}}, required: ["mainTitle", "points"] };
                    const { mainTitle: newTitle, points } = await callGeminiAPI(prompt, schema);
                    setMainTitle(newTitle);
                    const initialTasks = points.map((p, i) => ({ id: Date.now() + i, ...p, iconUrl: null, isIconLoading: true, link: '' }));
                    setTasks(initialTasks);
                    setIsContentGenerated(true);
                    initialTasks.forEach(task => regenerateIcon(task.id, task.title, false));
                } catch(e) { setError(e.message) } finally { setIsLoading(p => ({...p, content: false})); }
            };

            const regenerateIcon = async (taskId, prompt, isSingle = true) => {
                 if(isSingle) setIsLoading(p => ({ ...p, singleIcon: taskId }));
                 try {
                     const payload = { instances: [{ prompt: `A minimalist, flat icon for '${prompt}'` }], parameters: { "sampleCount": 1 } }; 
                     const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                     if (res.ok) {
                         const result = await res.json();
                         if (result.predictions?.[0]?.bytesBase64Encoded) {
                             const url = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                             setTasks(prev => prev.map(t => t.id === taskId ? { ...t, iconUrl: url, isIconLoading: false } : t));
                         }
                     } else { throw new Error(`Icon generation failed: ${res.status}`); }
                 } catch (e) {
                     setTasks(prev => prev.map(t => t.id === taskId ? { ...t, isIconLoading: false } : t));
                 } finally {
                     if(isSingle) setIsLoading(p => ({ ...p, singleIcon: null }));
                 }
            };
            
            // --- Handlers ---
            const handleApiKeySubmit = () => { if (tempApiKey.trim()) { setApiKey(tempApiKey.trim()); localStorage.setItem("gemini_api_key", tempApiKey.trim()); }};
            const handleTitleChange = (e) => { setMainTitle(e.currentTarget.textContent); };
            const handleTaskContentChange = (id, field, value) => setTasks(tasks.map(task => task.id === id ? { ...task, [field]: value } : task));
            const handleImageUpload = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => setBackgroundImage(reader.result); reader.readAsDataURL(file); }};
            
            // --- Branding ---
            const handleLogoUpload = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => setBrandingKit(prev => ({...prev, logo: reader.result})); reader.readAsDataURL(file); }};
            const addBrandColor = (color) => { if (color && !brandingKit.colors.includes(color)) setBrandingKit(prev => ({...prev, colors: [...prev.colors, color]})); };
            const removeBrandColor = (color) => setBrandingKit(prev => ({...prev, colors: prev.colors.filter(c => c !== color)}));

            // --- Elements ---
            const addChart = () => {
                const newChart = { id: `chart-${Date.now()}`, type: 'chart', chartType: 'bar', link: '', data: { labels: ['Jan', 'Feb', 'Mar'], datasets: [{ label: 'Sample Data', data: [65, 59, 80], backgroundColor: ['#ff6384', '#36a2eb', '#ffce56'] }] }, options: { responsive: true, plugins: { legend: { display: false }, title: { display: true, text: 'Sample Chart', color: designTheme.textColor, font: { size: 16 } }}}};
                setElements(prev => [...prev, newChart]);
            };
            const updateElement = (id, updatedData) => setElements(elements.map(el => (el.id === id ? { ...el, ...updatedData } : el)));
            
            const handleAiChartSuggestion = async (chart) => {
                setIsLoading(p => ({ ...p, aiChart: true }));
                try {
                    const dataSummary = `Data labels are [${chart.data.labels.join(', ')}] and data points are [${chart.data.datasets[0].data.join(', ')}].`;
                    const prompt = `Given this dataset: ${dataSummary}. What is the best chart type to visualize it? Respond with only one of the following options: bar, line, pie, doughnut, polarArea, radar.`;
                    const suggestedType = await callGeminiAPI(prompt, null, true);
                    const validTypes = ['bar', 'line', 'pie', 'doughnut', 'polarArea', 'radar'];
                    if (validTypes.includes(suggestedType)) {
                        updateElement(chart.id, { chartType: suggestedType });
                    } else {
                        throw new Error(`AI suggested an invalid chart type: ${suggestedType}`);
                    }
                } catch (e) {
                    setError(e.message);
                } finally {
                    setIsLoading(p => ({ ...p, aiChart: false }));
                }
            };
            
            // --- Export Handler ---
            const handlePreview = async () => {
                setIsLoading(p => ({ ...p, export: true }));
                infographicRef.current.classList.add('is-exporting');
                await new Promise(resolve => setTimeout(resolve, 100)); 

                try {
                    const canvas = await html2canvas(infographicRef.current, { backgroundColor: designTheme.backgroundColor, useCORS: true, scale: 2 });
                    
                    if (exportFormat === 'PDF') {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jspdf.jsPDF({ orientation: canvas.width > canvas.height ? 'l' : 'p', unit: 'px', format: [canvas.width, canvas.height] });
                        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                        pdf.save(`${mainTitle.replace(/ /g, '_')}.pdf`);
                    } else { 
                         const imgData = canvas.toDataURL('image/png');
                         setPreviewData({ type: 'PNG', image: imgData });
                         setShowPreviewModal(true);
                    }
                } catch (e) {
                    setError(e.message);
                } finally {
                    infographicRef.current.classList.remove('is-exporting');
                    setIsLoading(p => ({ ...p, export: false }));
                }
            };

            // --- Template Handler ---
            const applyTemplate = (template) => {
                setMainTitle(template.mainTitle);
                setSelectedLayout(template.layout);
                setDesignTheme(template.theme);
                const loadedTasks = template.tasks.map((t, i) => ({ ...t, id: Date.now() + i, iconUrl: null, isIconLoading: true, link: '' }));
                setTasks(loadedTasks);
                setElements(template.elements || []);
                setIsContentGenerated(true);
                setIsProjectStarted(true);
                loadedTasks.forEach(task => regenerateIcon(task.id, task.title, false));
            };

            if (!apiKey) return <ApiKeyModal value={tempApiKey} onChange={setTempApiKey} onSubmit={handleApiKeySubmit} />;
            if (!isProjectStarted) return <TemplateSelectionScreen onSelectTemplate={applyTemplate} onStartBlank={() => setIsProjectStarted(true)} />;
            
            const mainContainerStyle = { backgroundColor: designTheme.backgroundColor, color: designTheme.textColor, backgroundImage: backgroundImage ? `url(${backgroundImage})` : 'none', backgroundSize: 'cover', backgroundPosition: 'center', '--timeline-accent-color': designTheme.accentColor };

            return (
                <div className="flex h-screen bg-gray-800 text-white">
                    <ControlPanel
                        mainTitle={mainTitle} onTitleChange={setMainTitle}
                        isContentGenerated={isContentGenerated}
                        handleGenerateContent={handleGenerateContent} isLoading={isLoading}
                        selectedLayout={selectedLayout} setSelectedLayout={setSelectedLayout}
                        designTheme={designTheme} setDesignTheme={setDesignTheme}
                        brandingKit={brandingKit} addBrandColor={addBrandColor} removeBrandColor={removeBrandColor} logoFileInputRef={logoFileInputRef} handleLogoUpload={handleLogoUpload}
                        addChart={addChart}
                        exportFormat={exportFormat} setExportFormat={setExportFormat} handlePreview={handlePreview}
                        error={error}
                    />
                    <main className="flex-1 p-8 overflow-y-auto">
                        <div ref={infographicRef} className="p-12 rounded-2xl min-h-full transition-all duration-500" style={mainContainerStyle}>
                           {brandingKit.logo && <img src={brandingKit.logo} alt="Brand Logo" className="max-h-20 absolute top-8 right-8"/>}
                            <h1 contentEditable={isContentGenerated} onBlur={handleTitleChange} suppressContentEditableWarning={true} className="text-5xl font-bold text-center mb-16 outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" style={{textShadow: '2px 2px 8px rgba(0,0,0,0.5)'}}> {mainTitle} </h1>
                            {isLoading.content && <div className="flex justify-center items-center"><Spinner size="h-16 w-16" /></div>}
                            <DynamicLayout
                                definition={selectedLayout} tasks={tasks} designTheme={designTheme}
                                handleTaskContentChange={handleTaskContentChange} regenerateIcon={regenerateIcon} isLoading={isLoading}
                                elements={elements} setShowChartModal={setShowChartModal}
                            />
                        </div>
                    </main>

                    {showChartModal && <ChartModal chart={showChartModal} onSave={(id, data) => {updateElement(id, data); setShowChartModal(null);}} onClose={() => setShowChartModal(null)} onAiSuggest={handleAiChartSuggestion} isLoading={isLoading.aiChart} />}
                    {showPreviewModal && <PreviewModal data={previewData} onClose={() => setShowPreviewModal(false)} />}
                </div>
            );
        }

        // --- UI Components ---
        const CollapsibleSection = ({ title, children, defaultOpen = true }) => {
            const { useState } = React;
            const [isOpen, setIsOpen] = useState(defaultOpen);
            return (
                <div className="control-panel-section border-gray-700 py-4">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex justify-between items-center text-lg font-bold">
                        <span>{title}</span>
                        <ChevronDownIcon className={`w-6 h-6 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
                    </button>
                    {isOpen && <div className="mt-4 space-y-4">{children}</div>}
                </div>
            )
        };
        
        const ControlPanel = (props) => {
            const { mainTitle, onTitleChange, isContentGenerated, handleGenerateContent, isLoading,
                    selectedLayout, setSelectedLayout, designTheme, setDesignTheme,
                    brandingKit, addBrandColor, removeBrandColor, logoFileInputRef, handleLogoUpload,
                    addChart, exportFormat, setExportFormat, handlePreview,
                    error } = props;
            
            const handleThemeChange = (prop, value) => setDesignTheme(prev => ({ ...prev, [prop]: value }));

            const ColorPicker = ({ label, value, onChange, brandColors, onSwatchSelect }) => (
                <div>
                    <label className="text-sm font-medium">{label}</label>
                    {brandColors.length > 0 && <div className="flex items-center space-x-2 mt-1 mb-2">
                        {brandColors.map(color => <div key={color} onClick={() => onSwatchSelect(color)} style={{ backgroundColor: color }} className="w-6 h-6 rounded-full cursor-pointer transition-transform brand-color-swatch border-2 border-gray-600"></div>)}
                    </div>}
                    <input type="color" value={value} onChange={e => onChange(e.target.value)} className="w-full h-10 mt-1 p-1 bg-gray-800 border border-gray-600 rounded-lg cursor-pointer" />
                </div>
            );

            return (
                <div className="w-96 h-full bg-gray-900/70 backdrop-blur-sm p-4 overflow-y-auto">
                    <div className="flex justify-between items-center pb-4 mb-4 border-b border-gray-700">
                         <h1 className="text-xl font-bold">Creator Studio</h1>
                         <span className="text-xs font-mono opacity-50">v9.0</span>
                    </div>

                    <CollapsibleSection title="Content" defaultOpen={true}>
                        <textarea value={mainTitle} onChange={(e) => onTitleChange(e.target.value)} className="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg" rows="2" placeholder="Enter a topic..."></textarea>
                        <button onClick={handleGenerateContent} disabled={isLoading.content} className="w-full mt-2 flex items-center justify-center bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 disabled:opacity-50">
                            <SparklesIcon className="mr-2 w-5 h-5" />
                            {isLoading.content ? 'Creating...' : 'Generate Points'}
                        </button>
                    </CollapsibleSection>
                    
                    <CollapsibleSection title="Elements" defaultOpen={true}>
                         <fieldset disabled={!isContentGenerated}>
                            <button onClick={addChart} className="w-full flex items-center justify-center bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">
                                <ChartBarIcon className="mr-2 w-5 h-5" /> Add Chart
                            </button>
                         </fieldset>
                     </CollapsibleSection>

                     <CollapsibleSection title="Layout" defaultOpen={false}>
                         <fieldset disabled={!isContentGenerated}>
                             <label className="text-sm font-medium">Layout Style</label>
                             <select value={selectedLayout.name} onChange={e => setSelectedLayout(PREDEFINED_LAYOUTS.find(opt => opt.name === e.target.value))} className="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg">
                                 {PREDEFINED_LAYOUTS.map((opt) => <option key={opt.name} value={opt.name}>{opt.name}</option>)}
                             </select>
                         </fieldset>
                     </CollapsibleSection>

                    <CollapsibleSection title="Branding" defaultOpen={false}>
                         <fieldset disabled={!isContentGenerated} className="space-y-4">
                            <button onClick={() => logoFileInputRef.current.click()} className="w-full flex items-center justify-center bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">
                                <ImageIcon className="mr-2 w-5 h-5" /> Upload Logo
                            </button>
                            <input type="file" ref={logoFileInputRef} onChange={handleLogoUpload} accept="image/*" className="hidden" />
                            <div>
                                <label className="text-sm font-medium">Brand Colors</label>
                                <div className="flex items-center space-x-2 mt-2">
                                    {brandingKit.colors.map(c => <div key={c} onClick={() => removeBrandColor(c)} style={{backgroundColor: c}} title={`Click to remove ${c}`} className="w-8 h-8 rounded-full cursor-pointer border-2 border-gray-500"></div>)}
                                    <input type="color" onBlur={e => addBrandColor(e.target.value)} className="w-8 h-8 p-1 bg-gray-800 border-gray-600 rounded-full cursor-pointer" />
                                </div>
                            </div>
                         </fieldset>
                    </CollapsibleSection>

                    <CollapsibleSection title="Theme & Style" defaultOpen={false}>
                        <fieldset disabled={!isContentGenerated} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <ColorPicker label="Background" value={designTheme.backgroundColor} onChange={v => handleThemeChange('backgroundColor', v)} brandColors={brandingKit.colors} onSwatchSelect={c => handleThemeChange('backgroundColor', c)} />
                                <ColorPicker label="Card" value={designTheme.cardColor} onChange={v => handleThemeChange('cardColor', v)} brandColors={brandingKit.colors} onSwatchSelect={c => handleThemeChange('cardColor', c)} />
                                <ColorPicker label="Text" value={designTheme.textColor} onChange={v => handleThemeChange('textColor', v)} brandColors={brandingKit.colors} onSwatchSelect={c => handleThemeChange('textColor', c)} />
                                <ColorPicker label="Accent" value={designTheme.accentColor} onChange={v => handleThemeChange('accentColor', v)} brandColors={brandingKit.colors} onSwatchSelect={c => handleThemeChange('accentColor', c)} />
                            </div>
                        </fieldset>
                    </CollapsibleSection>
                    
                     <CollapsibleSection title="Export" defaultOpen={true}>
                         <fieldset disabled={!isContentGenerated} className="space-y-2">
                             <label className="text-sm font-medium">Format</label>
                             <select value={exportFormat} onChange={e => setExportFormat(e.target.value)} className="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg">
                                 <option value="PNG">PNG Image</option>
                                 <option value="PDF">PDF Document</option>
                             </select>
                             <button onClick={handlePreview} disabled={isLoading.export} className="w-full mt-2 flex items-center justify-center bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:opacity-50">
                                 <EyeIcon className="mr-2 w-5 h-5" />
                                 {isLoading.export ? 'Exporting...' : 'Preview & Export'}
                             </button>
                         </fieldset>
                     </CollapsibleSection>

                    {error && <p className="text-red-400 text-sm mt-4 bg-red-500/20 p-2 rounded-lg">{error}</p>}
                </div>
            );
        };

        // --- Layout and Element Components ---
        const DynamicLayout = ({ definition, tasks, designTheme, handleTaskContentChange, regenerateIcon, isLoading, elements, setShowChartModal }) => {
             const renderableElements = [...tasks, ...elements];

             const renderElement = (el, customClasses = "", customStyles = {}) => {
                const Wrapper = el.link ? 'a' : 'div';
                const wrapperProps = el.link ? { href: el.link, target: "_blank", rel: "noopener noreferrer" } : {};

                const elementContent = el.type === 'chart' 
                    ? <ChartComponent element={el} onClick={() => setShowChartModal(el)} />
                    : <Card task={el} designTheme={designTheme} cardStyle={{...definition.layout.cardStyle, ...customStyles}} className={customClasses} handleTaskContentChange={handleTaskContentChange} regenerateIcon={regenerateIcon} isLoading={isLoading.singleIcon === el.id} />;
                
                return <Wrapper key={el.id} {...wrapperProps}>{elementContent}</Wrapper>
             };

            if (definition.name === 'Alternating Timeline') return <div className="timeline-container">{renderableElements.map(el => <div key={el.id} className="timeline-item"><div className="timeline-item-content">{renderElement(el)}</div></div>)}</div>;
            if (definition.name === 'Staggered Grid (Masonry)') return <div className="masonry-container">{renderableElements.map(el => <div key={el.id} className="masonry-item">{renderElement(el)}</div>)}</div>;
            
            if (definition.name === 'Hub and Spoke') {
                if(tasks.length === 0) return null;
                const hub = tasks[0];
                const spokes = tasks.slice(1);
                return (
                    <div style={definition.layout.containerStyle}>
                        {renderElement(hub, "", { transform: 'scale(1.1)', marginBottom: '3rem' })}
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '2rem', width: '100%' }}>
                            {spokes.map(el => renderElement(el))}
                        </div>
                    </div>
                );
            }

            return <div className="relative" style={{...definition.layout.containerStyle, display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '2rem'}}>{renderableElements.map(el => renderElement(el))}</div>;
        };
        
        const Card = ({ task, designTheme, cardStyle, className, handleTaskContentChange, regenerateIcon, isLoading }) => {
            const combinedCardStyle = { ...cardStyle, backgroundColor: designTheme.cardColor, borderWidth: '1px', borderStyle: 'solid', borderColor: designTheme.borderColor };
            const cardClassName = `infographic-card group relative backdrop-blur-sm p-6 rounded-xl flex flex-col items-center text-center h-full ${designTheme.shadowStyle} ${className} ${task.link ? 'interactive-element' : ''}`;

            return (
                <div className={cardClassName} style={combinedCardStyle}>
                    <div className="relative w-24 h-24 mb-5">
                         <div className="w-full h-full shadow-lg rounded-full flex items-center justify-center overflow-hidden" style={{ backgroundColor: designTheme.accentColor }}>
                            {task.isIconLoading || isLoading ? <Spinner /> : task.iconUrl ? <img src={task.iconUrl} alt={task.title} className="w-full h-full object-cover" /> : <div className="w-full h-full bg-gray-500"></div>}
                        </div>
                        <button onClick={(e) => { e.preventDefault(); e.stopPropagation(); regenerateIcon(task.id, task.title);}} disabled={isLoading} className="regenerate-icon-btn absolute top-0 right-0 bg-black bg-opacity-50 text-white rounded-full p-1.5 opacity-0 transition-opacity">
                            <RefreshCwIcon className="w-4 h-4" />
                        </button>
                    </div>
                    <h3 contentEditable={!isLoading} onBlur={(e) => handleTaskContentChange(task.id, 'title', e.currentTarget.textContent)} suppressContentEditableWarning={true} className="text-xl font-bold break-words outline-none focus:ring-1 focus:ring-blue-400 rounded-md px-1">{task.title}</h3>
                    <p contentEditable={!isLoading} onBlur={(e) => handleTaskContentChange(task.id, 'description', e.currentTarget.textContent)} suppressContentEditableWarning={true} className="text-base break-words mt-2 outline-none focus:ring-1 focus:ring-blue-400 rounded-md px-1">{task.description}</p>
                    <div className="export-hidden mt-auto pt-4 w-full">
                        <div className="flex items-center space-x-2 w-full">
                           <LinkIcon className="w-5 h-5 text-gray-400" />
                           <input type="text" value={task.link} onChange={(e) => handleTaskContentChange(task.id, 'link', e.target.value)} placeholder="Add a link..." onClick={e => e.stopPropagation()} className="w-full text-sm bg-transparent border-b border-gray-600 focus:border-blue-500 outline-none"/>
                        </div>
                    </div>
                </div>
            );
        };
        
        const ChartComponent = ({ element, onClick }) => {
            const { useRef, useEffect } = React;
            const chartRef = useRef(null);
            const chartInstanceRef = useRef(null);

            useEffect(() => {
                if (chartRef.current) {
                    if (chartInstanceRef.current) chartInstanceRef.current.destroy();
                    const ctx = chartRef.current.getContext('2d');
                    chartInstanceRef.current = new Chart(ctx, { type: element.chartType, data: element.data, options: element.options });
                }
                return () => chartInstanceRef.current?.destroy();
            }, [element]);

            return (
                <div onClick={onClick} className={`p-4 rounded-xl cursor-pointer h-full ${element.link ? 'interactive-element' : ''}`} style={{ backgroundColor: '#ffffff' }}>
                    <canvas ref={chartRef}></canvas>
                </div>
            );
        };

        // --- Modal Components ---
        const TemplateSelectionScreen = ({ onSelectTemplate, onStartBlank }) => {
            return (
                <div className="w-full h-screen bg-gray-800 text-white p-8 overflow-y-auto">
                    <h1 className="text-4xl font-bold text-center mb-2">Start a New Project</h1>
                    <p className="text-lg text-gray-400 text-center mb-12">Choose a template or start from scratch.</p>
                    <div className="max-w-4xl mx-auto">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            <div onClick={onStartBlank} className="template-card flex flex-col items-center justify-center p-6 bg-gray-700 rounded-lg border-2 border-gray-600 cursor-pointer text-center h-64">
                                <FilePlusIcon className="w-16 h-16 mb-4 text-blue-400" />
                                <h3 className="text-xl font-bold">Blank Canvas</h3>
                                <p className="text-gray-400">Start with an empty project.</p>
                            </div>
                            {TEMPLATES.map((template, index) => (
                                <div key={index} onClick={() => onSelectTemplate(template)} className="template-card p-6 bg-gray-700 rounded-lg border-2 border-gray-600 cursor-pointer h-64 flex flex-col">
                                    <h3 className="text-xl font-bold mb-2">{template.name}</h3>
                                    <p className="text-gray-400 flex-grow">{template.description}</p>
                                    <div className="flex justify-end mt-4">
                                        <button className="py-2 px-4 bg-blue-600 rounded-lg">Use Template</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ChartModal = ({ chart, onSave, onClose, onAiSuggest, isLoading }) => {
            const {useState} = React;
            const [data, setData] = useState(JSON.stringify(chart.data.datasets[0].data, null, 2));
            const [labels, setLabels] = useState(JSON.stringify(chart.data.labels, null, 2));
            const [title, setTitle] = useState(chart.options.plugins.title.text);
            const [link, setLink] = useState(chart.link || '');

            const handleSave = () => {
                try {
                    const parsedData = JSON.parse(data);
                    const parsedLabels = JSON.parse(labels);
                    const updatedChart = {
                        data: { ...chart.data, labels: parsedLabels, datasets: [{...chart.data.datasets[0], data: parsedData}] },
                        options: { ...chart.options, plugins: {...chart.options.plugins, title: {...chart.options.plugins.title, text: title}}},
                        link: link,
                    };
                    onSave(chart.id, updatedChart);
                } catch(e){ alert("Invalid JSON format in data or labels."); }
            };
            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-800 text-white p-6 rounded-lg shadow-2xl w-full max-w-lg">
                        <div className="flex justify-between items-center mb-4">
                             <h2 className="text-2xl font-bold">Edit Chart</h2>
                             <button onClick={() => onAiSuggest(chart)} disabled={isLoading} className="flex items-center space-x-2 py-2 px-4 bg-purple-600 rounded-lg hover:bg-purple-500 disabled:bg-purple-400">
                                {isLoading ? <Spinner size="h-5 w-5"/> : <SparklesIcon className="w-5 h-5"/>}
                                <span>AI Suggest</span>
                             </button>
                        </div>
                        <div className="space-y-4">
                             <div><label className="text-sm font-medium">Chart Title</label><input type="text" value={title} onChange={e => setTitle(e.target.value)} className="w-full mt-1 p-2 bg-gray-700 border border-gray-600 rounded-lg"/></div>
                             <div><label className="text-sm font-medium">Link</label><input type="text" value={link} onChange={e => setLink(e.target.value)} className="w-full mt-1 p-2 bg-gray-700 border border-gray-600 rounded-lg"/></div>
                            <div><label className="text-sm font-medium">Labels (JSON Array)</label><textarea value={labels} onChange={e => setLabels(e.target.value)} rows="3" className="w-full mt-1 p-2 bg-gray-700 border border-gray-600 rounded-lg font-mono text-sm"></textarea></div>
                             <div><label className="text-sm font-medium">Data (JSON Array)</label><textarea value={data} onChange={e => setData(e.target.value)} rows="5" className="w-full mt-1 p-2 bg-gray-700 border border-gray-600 rounded-lg font-mono text-sm"></textarea></div>
                        </div>
                         <div className="flex justify-end space-x-4 mt-6">
                            <button onClick={onClose} className="py-2 px-4 bg-gray-600 rounded-lg hover:bg-gray-500">Cancel</button>
                            <button onClick={handleSave} className="py-2 px-4 bg-blue-600 rounded-lg hover:bg-blue-500">Save Changes</button>
                        </div>
                    </div>
                </div>
            )
        }
        
        const PreviewModal = ({ data, onClose }) => { 
            const handleDownload = () => { 
                const link = document.createElement('a');
                link.download = `infographic.png`;
                link.href = data.image;
                link.click();
            };
            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-800 text-white p-6 rounded-lg shadow-2xl w-full max-w-4xl flex flex-col">
                        <h3 className="text-2xl font-bold mb-4">Export Preview</h3>
                        <div className="bg-gray-900 p-4 rounded-lg overflow-auto">
                           <img src={data.image} className="rounded-lg w-full" />
                        </div>
                        <div className="flex justify-end space-x-4 mt-6">
                            <button onClick={onClose} className="py-2 px-4 bg-gray-600 rounded-lg hover:bg-gray-500">Close</button>
                            <button onClick={handleDownload} className="py-2 px-4 bg-blue-600 rounded-lg hover:bg-blue-500">Download PNG</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ApiKeyModal = ({ value, onChange, onSubmit }) => ( <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4"><div className="bg-white text-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-md"><h2 className="text-2xl font-bold mb-4">API Key Required</h2><p className="text-gray-600 mb-6">Please provide your Google AI Studio API key to use the generative features.</p><input type="password" value={value} onChange={e => onChange(e.target.value)} placeholder="Enter your API key" className="w-full p-2 border border-gray-300 rounded-lg mb-4"/><button onClick={onSubmit} className="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Save and Continue</button></div></div> );
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);

    </script>
</body>
</html>
