<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerShell ScriptSmith AI</title>
    
    <script src="https://cdn.tailwindcss.com/"></script>
    <script>
      tailwind.config = { plugins: [require('@tailwindcss/typography')] }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/powershell.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/markdown.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link 
href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif;
background-color: #111827; 
        }
        ::-webkit-scrollbar { 
            width: 8px;
}
        ::-webkit-scrollbar-track { 
            background: #1f2937;
}
        ::-webkit-scrollbar-thumb { 
            background: #4b5563;
border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: #6b7280;
}
        .code-font { 
            font-family: 'Fira Code', monospace;
}
        .modal { 
            display: none;
}
        .modal.active { 
            display: flex;
}
        .modal-close-button { 
            font-size: 2rem;
line-height: 1; 
            font-weight: bold;
        }
        /* V6.2 specific styles retained */
        #output-panel .tab-content, .modal { display: none;
}
        #output-panel .tab-content.active, .modal.active { display: flex;
}
        #output-panel pre { flex-grow: 1; margin: 0;
}
    </style>
</head>
<body class="text-gray-200">

    <div id="config-modal" class="modal active fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
            <h2 class="text-2xl font-bold text-white mb-4">Initial Configuration</h2>
            <p class="text-gray-400 mb-6">Please provide your API keys and configuration to use the application.</p>
            <form id="config-form">
             
   <div>
                    <label for="gemini-key-input" class="block text-sm font-medium text-gray-300">Gemini API Key</label>
                    <input type="password" id="gemini-key-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-1" placeholder="Your Google AI API Key">
                </div>
                <div 
class="mt-4">
                    <label for="google-client-id-input" class="block text-sm font-medium text-gray-300">Google Client ID</label>
                    <input type="text" id="google-client-id-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-1" placeholder="your-client-id.apps.googleusercontent.com">
                </div>
                <div class="mt-4">
       
             <label for="firebase-config-input" class="block text-sm font-medium text-gray-300">Firebase Config</label>
                    <textarea id="firebase-config-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-1 code-font" rows="6" placeholder="{ 
  apiKey: '...',
  authDomain: '...',
  projectId: '...',
  storageBucket: '...',
  messagingSenderId: '...',
  appId: '...'
}"></textarea>
                </div>
            
    <button type="submit" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200">Save and Initialize</button>
            </form>
        </div>
    </div>
    
    <div id="prompts-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-3xl relative max-h-[80vh] flex flex-col">
            <button id="close-prompts-modal" class="modal-close-button absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button>
    
        <h2 class="text-2xl font-bold text-white mb-4 flex-shrink-0">System Prompts</h2>
            <div class="overflow-y-auto pr-4 space-y-4">
                <div>
                    <h3 class="text-lg font-semibold text-blue-400 mb-2">Base Meta Prompt</h3>
                    <pre class="bg-gray-900 p-3 rounded-lg text-gray-300 text-sm whitespace-pre-wrap code-font" id="modal-base-prompt"></pre>
 
               </div>
                <div>
                    <h3 class="text-lg font-semibold text-blue-400 mb-2">Environment Context</h3>
                    <p class="text-gray-400 text-sm mb-2">This text is added to instruct the AI on compatibility.
`{{targetEnvironment}}` is replaced with your selection.</p>
                    <pre class="bg-gray-900 p-3 rounded-lg text-gray-300 text-sm whitespace-pre-wrap code-font" id="modal-env-context"></pre>
                </div>
                 <div>
                    <h3 class="text-lg font-semibold text-blue-400 mb-2">Task-Specific Prompts</h3>
         
           <p class="text-gray-400 text-sm mb-2">Depending on the mode, one of the following instructions is used.
Placeholders like `{{userPrompt}}` are replaced with your input.</p>
                    <div class="space-y-3">
                         <details class="bg-gray-900 p-3 rounded-lg">
                            <summary class="font-semibold text-gray-200 cursor-pointer">Generate New Script</summary>
           
                 <pre class="mt-2 text-gray-300 text-sm whitespace-pre-wrap code-font" id="modal-generate-prompt"></pre>
                         </details>
                         <details class="bg-gray-900 p-3 rounded-lg">
                        
    <summary class="font-semibold text-gray-200 cursor-pointer">Refactor Existing Script</summary>
                             <pre class="mt-2 text-gray-300 text-sm whitespace-pre-wrap code-font" id="modal-refactor-prompt"></pre>
                         </details>
                    </div>
           
     </div>
            </div>
        </div>
    </div>
    <div id="explain-app-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-4xl relative max-h-[80vh] flex flex-col">
            <button id="close-explain-app-modal" class="modal-close-button absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button>
            <h2 class="text-2xl font-bold text-white mb-4 flex-shrink-0">How This App Works 
(AI-Generated)</h2>
            <div id="explain-app-content" class="prose prose-invert max-w-none prose-pre:bg-gray-900 overflow-y-auto pr-4">
                </div>
        </div>
    </div>
    
    <div id="suggest-improvements-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50"></div>

    <div id="app" class="flex flex-col h-screen">
        <header class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 p-4 flex items-center justify-between shadow-lg z-20">
          
  <div class="flex items-center space-x-3">
                <svg class="w-8 h-8 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 13.5h3.86a2.25 2.25 0 0 1 2.012 1.244l.256.512a2.25 2.25 0 0 0 2.013 1.244h3.218a2.25 2.25 0 0 0 2.013-1.244l.256-.512a2.25 2.25 0 0 1 2.013-1.244h3.859m-19.5.338V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 0 0-2.12-1.588H6.88a2.25 2.25 0 0 0-2.12 1.588L2.35 13.177a2.25 2.25 0 0 0-.1.661Z" /></svg>
              
  <h1 class="text-xl font-bold text-white">PowerShell ScriptSmith AI <span id="app-version" class="text-xs font-mono text-blue-400/80 ml-2"></span></h1>
            </div>
            <div class="flex items-center space-x-2">
                <button id="suggest-improvements-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold p-2 rounded-full" title="Suggest Improvements (AI-Generated)"></button>
                
                <button id="explain-app-button" 
class="bg-gray-700 hover:bg-gray-600 text-white font-semibold p-2 rounded-full" title="How This App Works (AI-Generated)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 
000-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button id="view-prompts-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg text-sm">View Prompts</button>
                <button id="auth-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg" disabled>Login with 
Google</button>
            </div>
        </header>

        <main class="flex-grow flex flex-col md:flex-row overflow-hidden">
            <div class="w-full md:w-1/3 flex flex-col bg-gray-900 border-r border-gray-700">
                <div class="p-4 border-b border-gray-700 space-y-4">
                    <div>
        
                <label class="text-lg font-semibold">Mode</label>
                        <div class="mt-2 flex bg-gray-800 rounded-lg p-1">
                            <button id="mode-generate" class="w-full py-2 text-sm font-medium rounded-md">Generate New</button>
                  
          <button id="mode-refactor" class="w-full py-2 text-sm font-medium rounded-md">Refactor Existing</button>
                        </div>
                    </div>
                    <div>
                   
     <label for="target-env" class="text-lg font-semibold">Target Environment</label>
                        <select id="target-env" class="mt-2 w-full p-2 bg-gray-800 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option>PowerShell 7 (Cross-Platform)</option><option>Windows PowerShell 5.1</option><option>Azure Automation</option><option>Windows Server 2022</option><option>Windows Server 2019</option>
                   
     </select>
                    </div>
                </div>
                <div id="chat-history" class="flex-grow p-4 overflow-y-auto space-y-4"></div>
                <div class="p-4 border-t border-gray-700 bg-gray-900">
                  
  <form id="prompt-form" class="flex items-center space-x-2">
                        <textarea id="prompt-input" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-500" rows="2"></textarea>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-lg transition-colors duration-200 flex-shrink-0 self-end">
                      
      <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.105 2.289a.75.75 0 0 0-.826.95l1.414 4.925A1.5 1.5 0 0 0 5.135 9.25h6.115a.75.75 0 0 1 0 1.5H5.135a1.5 1.5 0 0 0-1.442 1.086L2.279 16.76a.75.75 0 0 0 .95.826l16-5.333a.75.75 0 0 0 0-1.418l-16-5.333Z" /></svg>
                        </button>
                    </form>
          
      </div>
            </div>

            <div id="output-panel" class="w-full md:w-2/3 flex flex-col bg-gray-800/50 overflow-y-auto relative">
                <div class="border-b border-gray-700 sticky top-0 bg-gray-800/80 backdrop-blur-sm z-10">
                   <nav id="tabs" class="flex space-x-1 p-1"></nav>
                
</div>
                <div id="output-container" class="flex-grow relative">
                    <div id="initial-message" class="flex flex-col items-center justify-center h-full text-center text-gray-500 p-6">
                        <svg class="w-16 h-16 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m6.75 7.5 3 2.25-3 2.25m4.5 0h3m-9.75 6.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6.75a1.5 1.5 0 
0 0-1.5-1.5H3.75a1.5 1.5 0 0 0-1.5 1.5v10.5a1.5 1.5 0 0 0 1.5 1.5Z" /></svg>
                        <h3 class="text-xl font-semibold text-gray-400">Your generated script will appear here</h3>
                        <p class="mt-2 max-w-md">Select a mode, describe your needs or paste a script, and send.</p>
                  
  </div>
                </div>
            </div>
        </main>
    </div>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        // --- Global Scope for API Callbacks & State (V6.2.2 & V6.2) ---
        let gapiInited = false;
let gisInited = false;
        let tokenClient;
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
// --- Service Initialization Functions (V6.2.2) ---
        function gapiLoaded() {
            // Load the client library and set the flag
            gapi.load('client', () => {
                gapiInited = true;
            });
}

        function gisLoaded() {
            // Set the GIS flag
            gisInited = true;
}
        
        async function initializeGapiDrive() {
            if (!gapiInited) { 
                console.error("GAPI not loaded yet.");
return; 
            }
            try {
                // Initialize GAPI client with Drive API discovery doc
                // Note: We initialize without the API key here, as Google Drive operations typically
                // rely on the access token provided by the OAuth flow.
await gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
console.log("Google Drive Client Initialized.");
            } catch (error) {
                console.error("GAPI Drive Init Error:", error);
alert("Failed to initialize Google Drive client.");
            }
        }

        function initializeTokenClient(clientId) {
            if (!gisInited) { 
                console.error("GSI not loaded yet.");
return; 
            }
            try {
                 // Initialize the token client for Google Sign-In
                 tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: clientId,
                    scope: SCOPES,
 
                   callback: (tokenResponse) => {
                       if (tokenResponse && tokenResponse.access_token) {
                            document.getElementById('auth-button').textContent = 'Logout';
                     
   }
                    },
                });
document.getElementById('auth-button').disabled = false;
                console.log("Google Token Client Initialized.");
            } catch(error) {
                console.error("Token Client Init Error:", error);
alert("Failed to initialize Google Sign-In. Check your Client ID.");
            }
        }

        function initializeFirebase(config) {
             try {
                // Initialize Firebase only if it hasn't been initialized already
                if (firebase.apps.length === 0) {
              
      firebase.initializeApp(config);
                    console.log("Firebase Initialized.");
                }
            } catch (error) {
                console.error("Firebase Init Error:", error);
alert("Failed to initialize Firebase. Check your configuration object.");
            }
        }

        // --- Main App Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const APP_VERSION = '6.5.0'; // Updated version number

            // --- Element References (Combined V6.2.2 and V6.2) ---
            const configModal = document.getElementById('config-modal');
      
      const configForm = document.getElementById('config-form');
            const geminiKeyInput = document.getElementById('gemini-key-input');
            const googleClientIdInput = document.getElementById('google-client-id-input');
            const firebaseConfigInput = document.getElementById('firebase-config-input');
            const authButton = document.getElementById('auth-button');
            const promptsModal = document.getElementById('prompts-modal');
            const closePromptsModal = document.getElementById('close-prompts-modal');
 
           const explainAppModal = document.getElementById('explain-app-modal');
            const closeExplainAppModal = document.getElementById('close-explain-app-modal');
const explainAppButton = document.getElementById('explain-app-button');
            const explainAppContent = document.getElementById('explain-app-content');
            const viewPromptsButton = document.getElementById('view-prompts-button');
// V6.2 specific UI elements
            const promptForm = document.getElementById('prompt-form');
const promptInput = document.getElementById('prompt-input');
            const chatHistoryContainer = document.getElementById('chat-history');
            const modeGenerateBtn = document.getElementById('mode-generate');
            const modeRefactorBtn = document.getElementById('mode-refactor');
            const targetEnvSelect = document.getElementById('target-env');
const tabsContainer = document.getElementById('tabs');
            const initialMessage = document.getElementById('initial-message');
            const outputContainer = document.getElementById('output-container');
// --- State Variables (Combined V6.2.2 and V6.2) ---
            let geminiApiKey = '';
let googleClientId = '';
            let firebaseConfig = null;
            let conversationHistory = [];
            let currentScript = '';
            let currentMode = 'generate';
let appExplanation = '';
            const FOLDER_NAME = 'PowerShell Scriptsmith AI';
            const baseMetaPrompt = `You are an expert PowerShell scripting assistant...`;
// Placeholder, actual prompt likely longer

            // --- Config Modal Logic (V6.2.2) ---
            configForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const geminiKey = geminiKeyInput.value.trim();
                const clientId = googleClientIdInput.value.trim();
        
        const fbConfigString = firebaseConfigInput.value.trim();

                // Validation (V6.2.2)
                if (!geminiKey || !clientId || !fbConfigString) {
                    alert('Please fill out all configuration fields.');
                    return;
    
            }

                try {
                    const parsedConfig = JSON.parse(fbConfigString);
                    firebaseConfig = parsedConfig;
                } catch (error) {
       
             alert('The Firebase Config is not a valid JSON object. Please check your syntax.');
                    return;
                }

                geminiApiKey = geminiKey;
googleClientId = clientId;

                // Initialize Firebase first (V6.2.2)
                initializeFirebase(firebaseConfig);
// Now initialize Google APIs, waiting if necessary

                await Promise.all([
                    new Promise(resolve => {
                        if (gapiInited) resolve();
                        else {
                            const checkGAPI = setInterval(() => {
                                if (gapiInited) {
                                    clearInterval(checkGAPI);
                                    resolve();
                                }
                            }, 100);
                        }
                    }),
                    new Promise(resolve => {
                        if (gisInited) resolve();
                        else {
                            const checkGIS = setInterval(() => {
                                if (gisInited) {
                                    clearInterval(checkGIS);
                                    resolve();
                                }
                            }, 100);
                        }
                    })
                ]);
                
                // Initialize Google Drive client (gapi.client)
                initializeGapiDrive();
// Initialize Google Sign-In (gis)
                initializeTokenClient(googleClientId);
configModal.classList.remove('active');
            });
            
            // --- Google Auth Button Logic (V6.2.2) ---
            authButton.addEventListener('click', () => {
                if (!tokenClient) {
                    alert("Google Sign-In is not initialized. Please provide your configuration first.");
                    return;
         
       }
                // Check if a token exists; request access if not, or clear token if it does
                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
   
                 gapi.client.setToken(null);
                    authButton.textContent = 'Login with Google';
                }
                updateActionButtons(); // Assuming this function exists to update UI state
            });
// --- Modal Controls (V6.2) ---
            const setupModal = (modal, openBtn, closeBtn) => {
                if (openBtn) openBtn.addEventListener('click', () => modal.classList.add('active'));
if (closeBtn) closeBtn.addEventListener('click', () => modal.classList.remove('active'));
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.classList.remove('active');
                });
};
            
            setupModal(promptsModal, viewPromptsButton, closePromptsModal);
            setupModal(explainAppModal, null, closeExplainAppModal); // Open is handled manually
            
            // --- "How It Works" Modal Logic (V6.2) ---
            const handleAppExplanation = async () => {
                explainAppModal.classList.add('active');
if (appExplanation) {
                    explainAppContent.innerHTML = appExplanation;
return;
                }

                // Ensure Gemini API Key is available before attempting generation
                if (!geminiApiKey) {
                    explainAppContent.innerHTML = `<p class="text-red-400">Please enter your API key first to generate this explanation.</p>`;
return;
                }

                explainAppContent.innerHTML = `<div class="flex items-center justify-center h-full"><p>Generating explanation with Gemini... this may take a moment.</p></div>`;
try {
                    const selfAnalysisPrompt = `You are an expert web developer.
Analyze the following single-file HTML application code and explain how it works in its entirety.
Describe the key components: the HTML structure, the CSS styling (including Tailwind and custom styles), and the JavaScript logic (including state management, Google API integrations, event handling, and dynamic UI updates).
Present the explanation in clear, well-formatted markdown.`;
                    const appSourceCode = document.documentElement.outerHTML;
const payload = { contents: [{ parts: [{ text: `${selfAnalysisPrompt}\n\n\`\`\`html\n${appSourceCode}\n\`\`\`` }] }] };
// Use geminiApiKey for the Gemini API call
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`;
const response = await fetch(apiUrl, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
             
       });
                    
                    if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts) {
                        const rawText = result.candidates[0].content.parts[0].text;
const htmlContent = marked.parse(rawText);
                        appExplanation = htmlContent;
                        explainAppContent.innerHTML = appExplanation;
} else {
                        if (result.promptFeedback && result.promptFeedback.blockReason) throw new Error(`Request blocked for safety reasons: ${result.promptFeedback.blockReason}`);
throw new Error('No content received from API for app explanation.');
}
                } catch (error) {
                    console.error('Error generating app explanation:', error);
explainAppContent.innerHTML = `<p class="text-red-400"><strong>Error:</strong> ${error.message}</p>`;
                }
            };
            
            explainAppButton.addEventListener('click', handleAppExplanation);
// --- V6.2 Functions (Retained Core Application Logic) ---
            
            // Note: The following functions (updateModeUI, handleFormSubmit, renderScript, etc.) 
            // are essential for the script generation functionality and should be included here.
// Since they were not provided in the V6.2 source, they are represented by placeholders 
            // but are necessary for the application to function correctly.
const updateModeUI = () => {
                // Logic to update the UI based on currentMode (generate/refactor)
                // This typically involves changing button styles and potentially input field visibility/placeholders.
if (currentMode === 'generate') {
                    modeGenerateBtn.classList.add('bg-blue-600', 'text-white');
modeRefactorBtn.classList.remove('bg-blue-600', 'text-white');
                } else {
                    modeRefactorBtn.classList.add('bg-blue-600', 'text-white');
modeGenerateBtn.classList.remove('bg-blue-600', 'text-white');
                }
            };
// Event listeners for mode selection
            modeGenerateBtn.addEventListener('click', () => {
                currentMode = 'generate';
                updateModeUI();
            });
modeRefactorBtn.addEventListener('click', () => {
                currentMode = 'refactor';
                updateModeUI();
            });
// Placeholder for script rendering and history
            const renderScript = (scriptContent) => {
                // Logic to display generated script in the output panel and handle highlighting
                // Example: Create a new tab and display the script content.
initialMessage.style.display = 'none'; // Hide the initial message once output is generated
                // ... implementation details for adding tabs and code blocks ...
            };
const addMessageToHistory = (sender, message) => {
                // Logic to add user and AI messages to the chat history container
                // ... implementation details ...
            };
const handleFormSubmit = async (e) => {
                e.preventDefault();
const userPrompt = promptInput.value.trim();
                if (!userPrompt || !geminiApiKey) return;

                // Add user message to history
                addMessageToHistory('user', userPrompt);
// Clear input
                promptInput.value = '';
// Generate script or refactor (Placeholder for AI interaction logic)
                // This is where the application would interact with the Gemini API using the prompt and the configured environment.
try {
                    // Placeholder for API call and response processing
                    const generatedScript = `# Generated PowerShell Script based on: ${userPrompt}\n# ... (Simulated output)`;
currentScript = generatedScript;
                    addMessageToHistory('ai', generatedScript);
                    renderScript(generatedScript);
                } catch (error) {
                    console.error('Error during generation:', error);
addMessageToHistory('error', 'Failed to generate script. Check console for details.');
                }
            };
promptForm.addEventListener('submit', handleFormSubmit);

            const populatePromptsModal = () => {
                // Logic to populate the prompts modal with the base, environment, and task-specific prompts.
document.getElementById('modal-base-prompt').textContent = baseMetaPrompt;
                // ... populate other prompt fields ...
            };
// --- Initial UI setup ---
            document.getElementById('app-version').textContent = `v${APP_VERSION}`;
updateModeUI();
            populatePromptsModal();
        });
    </script>
</body>
</html>
