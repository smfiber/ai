<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerShell ScriptSmith AI</title>
    
    <script src="https://cdn.tailwindcss.com/"></script>
    <script>
      tailwind.config = { 
        theme: {
            extend: {
                keyframes: {
                    spin: {
                        '0%': { transform: 'rotate(0deg)' },
                        '100%': { transform: 'rotate(360deg)' },
                    },
                },
                animation: {
                    spin: 'spin 1s linear infinite',
                },
            }
        }
      }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.11/dist/purify.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/powershell.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        window.initializeApp = initializeApp;
    </script>
    <script type="module">
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        window.getAuth = getAuth; window.onAuthStateChanged = onAuthStateChanged; window.GoogleAuthProvider = GoogleAuthProvider; window.signInWithPopup = signInWithPopup; window.signOut = signOut;
    </script>
    <script type="module">
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, serverTimestamp, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        window.getFirestore = getFirestore; window.collection = collection; window.addDoc = addDoc; window.getDocs = getDocs; window.doc = doc; window.deleteDoc = deleteDoc; window.serverTimestamp = serverTimestamp; window.query = query; window.where = where; window.orderBy = orderBy;
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .code-font { font-family: 'Fira Code', monospace; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .profile-dropdown { display: none; }
        .profile-dropdown.active { display: block; }
        .workflow-btn-active { background-color: #2563eb; color: #ffffff; }
        .tab-btn { background-color: transparent; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #3b82f6; color: #ffffff; }
        .output-content { display: none; }
        .output-content.active { display: block; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    </style>
</head>
<body class="text-gray-200">

    <div id="config-modal" class="modal active fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
            <h2 class="text-2xl font-bold text-white mb-4">Initial Configuration</h2>
            <p class="text-gray-400 mb-6">Provide your API keys to use the application.</p>
            <form id="config-form">
                <div>
                    <label for="gemini-key-input" class="block text-sm font-medium text-gray-300">Gemini API Key</label>
                    <input type="password" id="gemini-key-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-1" placeholder="Your Google AI API Key">
                </div>
                <div class="mt-4">
                    <label for="firebase-config-input" class="block text-sm font-medium text-gray-300">Firebase Config</label>
                    <textarea id="firebase-config-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-1 code-font" rows="6" placeholder="Enter your Firebase project configuration JSON here."></textarea>
                </div>
                <button type="submit" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200">Save and Initialize</button>
            </form>
        </div>
    </div>
    
    <div id="paste-script-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-[80vh] flex flex-col">
            <h2 class="text-2xl font-bold text-white mb-4">Paste Script to Refactor</h2>
            <p class="text-gray-400 mb-6">Paste your existing PowerShell script below to load it into the app for conversational refinement.</p>
            <textarea id="paste-input" class="w-full flex-grow p-3 bg-gray-900 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 code-font" placeholder="... your script here ..."></textarea>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="cancel-paste-script" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button type="button" id="load-pasted-script" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Load Script</button>
            </div>
        </div>
    </div>

    <div id="refine-script-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-4xl max-h-[80vh] flex flex-col">
            <h2 class="text-2xl font-bold text-white mb-4">Refine Script</h2>
            <div class="flex-grow grid grid-cols-2 gap-4 overflow-hidden">
                <div class="flex flex-col">
                    <label class="text-sm font-medium text-gray-300 mb-2">Current Script (Read-only)</label>
                    <div class="flex-grow bg-gray-900 rounded-md p-1 overflow-auto border border-gray-600">
                        <pre><code id="refine-script-preview" class="language-powershell"></code></pre>
                    </div>
                </div>
                <div class="flex flex-col">
                     <label for="refine-instructions-input" class="text-sm font-medium text-gray-300 mb-2">Your Instructions</label>
                    <textarea id="refine-instructions-input" class="w-full flex-grow p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 code-font" placeholder="e.g., Add a transcript log to this script.&#10;e.g., Change the output to a CSV file."></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="cancel-refine-script" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button type="submit" form="refine-form" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Submit Refinement</button>
            </div>
            <form id="refine-form"></form>
        </div>
    </div>

    <div id="save-script-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold text-white mb-4">Save Script to Cloud</h2>
            <form id="save-script-form">
                <div>
                    <label for="script-name-input" class="block text-sm font-medium text-gray-300">Script Name</label>
                    <input type="text" id="script-name-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-1" placeholder="e.g., 'Get All AD Users'" required>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-save-script" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="load-script-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Load Script from Cloud</h2>
                <button id="close-load-script-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="saved-scripts-list" class="overflow-y-auto space-y-3 pr-2"></div>
        </div>
    </div>

    <div id="view-prompts-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-4xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Prompts Viewer</h2>
                <button id="close-prompts-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="overflow-y-auto space-y-4 pr-2 text-sm">
                <div>
                    <h3 class="text-lg font-semibold text-blue-400 mb-2">Last Used Generation Prompt</h3>
                    <pre id="last-generation-prompt" class="bg-gray-900 p-3 rounded-md whitespace-pre-wrap code-font text-gray-300"></pre>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-blue-400 mb-2">Last Used Validation/Refinement Prompt</h3>
                    <pre id="last-validation-prompt" class="bg-gray-900 p-3 rounded-md whitespace-pre-wrap code-font text-gray-300"></pre>
                </div>
                <div class="border-t border-gray-700 pt-4">
                     <button class="accordion-toggle text-lg font-semibold text-gray-300 w-full text-left">View Prompt Templates & Rules ▼</button>
                     <div class="accordion-content mt-2 space-y-4">
                        <div>
                            <h3 class="text-lg font-semibold text-blue-400 mb-2">Base Meta-Prompt</h3>
                            <pre id="base-prompt-content" class="bg-gray-900 p-3 rounded-md whitespace-pre-wrap code-font text-gray-300"></pre>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-blue-400 mb-2">Validation Meta-Prompt</h3>
                            <pre id="validation-prompt-content" class="bg-gray-900 p-3 rounded-md whitespace-pre-wrap code-font text-gray-300"></pre>
                        </div>
                         <div>
                            <h3 class="text-lg font-semibold text-blue-400 mb-2">Environment Rules</h3>
                            <pre id="rules-content" class="bg-gray-900 p-3 rounded-md whitespace-pre-wrap code-font text-gray-300"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="flex flex-col h-screen">
        <header class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 p-4 flex items-center justify-between shadow-lg z-20">
            <div class="flex items-center space-x-3">
                <svg class="w-8 h-8 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m6.75 7.5 3 2.25-3 2.25m4.5 0h3m-9.75 6.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6.75a1.5 1.5 0 0 0-1.5-1.5H3.75a1.5 1.5 0 0 0-1.5 1.5v10.5a1.5 1.5 0 0 0 1.5 1.5Z" /></svg>
                <h1 class="text-xl font-bold text-white">PowerShell ScriptSmith AI <span id="app-version" class="text-xs font-mono text-blue-400/80 ml-2"></span></h1>
            </div>
             <div class="flex items-center space-x-4">
                <button id="load-from-cloud-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg text-sm" disabled>Load from Cloud</button>
                <button id="view-prompts-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg text-sm">View Prompts</button>
                <div id="auth-container" class="relative">
                    <button id="auth-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Login with Google</button>
                    <div id="user-profile-area" class="hidden items-center space-x-3 cursor-pointer">
                        <img id="user-photo" class="w-10 h-10 rounded-full" src="" alt="User Photo">
                        <span id="user-name" class="font-semibold"></span>
                    </div>
                    <div id="profile-dropdown-menu" class="profile-dropdown absolute right-0 mt-2 w-48 bg-gray-700 rounded-md shadow-lg z-30">
                        <button id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow flex flex-col md:flex-row overflow-hidden">
            <div class="w-full md:w-1/3 flex flex-col bg-gray-900 border-r border-gray-700">
                <div class="p-4 border-b border-gray-700 space-y-4">
                    <div>
                        <label class="text-lg font-semibold">Workflow</label>
                        <div class="mt-2 grid grid-cols-2 gap-2">
                            <button id="workflow-generate" class="workflow-btn w-full py-2 text-sm font-medium rounded-md workflow-btn-active">Generate New</button>
                            <button id="workflow-refactor" class="workflow-btn bg-gray-700 hover:bg-gray-600 w-full py-2 text-sm font-medium rounded-md">Paste & Refine</button>
                        </div>
                    </div>
                    <div>
                        <label for="target-env" class="text-lg font-semibold">Target Environment</label>
                        <select id="target-env" class="mt-2 w-full p-2 bg-gray-800 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option>Active Directory</option>
                            <option>Azure (Az Module)</option>
                            <option>MS Graph (SDK)</option>
                            <option>MS365 / Entra ID</option>
                            <option>MS365 / Exchange Online</option>
                            <option>MS365 / SharePoint PnP</option>
                            <option>MS365 / Teams</option>
                            <option>PowerCLI (VMware)</option>
                            <option>Windows Desktop (10/11)</option>
                            <option>Windows Server</option>
                        </select>
                    </div>
                </div>
                <div id="chat-history" class="flex-grow p-4 overflow-y-auto space-y-4"></div>
                <div id="generate-prompt-area" class="p-4 border-t border-gray-700 bg-gray-900">
                    <form id="prompt-form" class="flex items-center space-x-2">
                        <textarea id="prompt-input" placeholder="Enter your script request..." class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
                        <button type="submit" id="submit-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-lg flex-shrink-0 self-end">
                            <svg id="submit-icon" class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.105 2.289a.75.75 0 0 0-.826.95l1.414 4.925A1.5 1.5 0 0 0 5.135 9.25h6.115a.75.75 0 0 1 0 1.5H5.135a1.5 1.5 0 0 0-1.442 1.086L2.279 16.76a.75.75 0 0 0 .95.826l16-5.333a.75.75 0 0 0 0-1.418l-16-5.333Z" /></svg>
                            <svg id="loading-spinner" class="w-6 h-6 animate-spin hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </button>
                    </form>
                </div>
            </div>

            <div id="output-panel" class="w-full md:w-2/3 flex flex-col bg-gray-800/50 overflow-y-auto relative">
                 <div class="border-b border-gray-700 sticky top-0 bg-gray-800/80 backdrop-blur-sm z-10">
                   <nav id="tabs" class="flex space-x-1 p-2 px-4"></nav>
                   <div id="output-actions" class="p-2 flex justify-end space-x-2 border-t border-gray-700 hidden">
                        <button id="copy-script-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-1 px-3 rounded-md text-sm">Copy</button>
                        <button id="download-script-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-1 px-3 rounded-md text-sm">Download</button>
                        <button id="save-to-cloud-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-1 px-3 rounded-md text-sm" disabled>Save to Cloud</button>
                        <button id="refine-script-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-md text-sm">Refine</button>
                        <button id="explain-script-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded-md text-sm">Explain</button>
                   </div>
                </div>
                <div id="output-container" class="flex-grow relative p-4">
                    <div id="initial-message" class="flex flex-col items-center justify-center h-full text-center text-gray-500 p-6">
                        <svg class="w-16 h-16 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m6.75 7.5 3 2.25-3 2.25m4.5 0h3m-9.75 6.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6.75a1.5 1.5 0 0 0-1.5-1.5H3.75a1.5 1.5 0 0 0-1.5 1.5v10.5a1.5 1.5 0 0 0 1.5 1.5Z" /></svg>
                        <h3 class="text-xl font-semibold text-gray-400">Your generated script will appear here</h3>
                        <p class="mt-2 max-w-md">Login to save and load scripts from the cloud.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            const appState = {
                version: '8.3.0',
                geminiApiKey: null,
                firebaseConfig: null,
                currentScript: '',
                currentTabs: {},
                lastGenerationPrompt: '',
                lastValidationPrompt: '',
                db: null,
                auth: null,
                user: null,
            };

            // --- Element References ---
            const configModal = document.getElementById('config-modal');
            const configForm = document.getElementById('config-form');
            const geminiKeyInput = document.getElementById('gemini-key-input');
            const firebaseConfigInput = document.getElementById('firebase-config-input');
            const authButton = document.getElementById('auth-button');
            const userProfileArea = document.getElementById('user-profile-area');
            const userPhoto = document.getElementById('user-photo');
            const userName = document.getElementById('user-name');
            const profileDropdownMenu = document.getElementById('profile-dropdown-menu');
            const logoutButton = document.getElementById('logout-button');
            const saveToCloudButton = document.getElementById('save-to-cloud-button');
            const loadFromCloudButton = document.getElementById('load-from-cloud-button');
            const saveScriptModal = document.getElementById('save-script-modal');
            const saveScriptForm = document.getElementById('save-script-form');
            const scriptNameInput = document.getElementById('script-name-input');
            const cancelSaveScript = document.getElementById('cancel-save-script');
            const loadScriptModal = document.getElementById('load-script-modal');
            const closeLoadScriptModal = document.getElementById('close-load-script-modal');
            const savedScriptsList = document.getElementById('saved-scripts-list');
            const promptInput = document.getElementById('prompt-input');
            const targetEnvSelect = document.getElementById('target-env');
            const chatHistoryContainer = document.getElementById('chat-history');
            const outputActions = document.getElementById('output-actions');
            const outputContainer = document.getElementById('output-container');
            const initialMessage = document.getElementById('initial-message');
            const promptForm = document.getElementById('prompt-form');
            const submitButton = document.getElementById('submit-button');
            const submitIcon = document.getElementById('submit-icon');
            const loadingSpinner = document.getElementById('loading-spinner');
            const viewPromptsBtn = document.getElementById('view-prompts-button');
            const promptsModal = document.getElementById('view-prompts-modal');
            const closePromptsModal = document.getElementById('close-prompts-modal');
            const tabsContainer = document.getElementById('tabs');
            const pasteScriptModal = document.getElementById('paste-script-modal');
            const pasteInput = document.getElementById('paste-input');
            const cancelPasteScript = document.getElementById('cancel-paste-script');
            const loadPastedScript = document.getElementById('load-pasted-script');
            const refineScriptModal = document.getElementById('refine-script-modal');
            const refineScriptPreview = document.getElementById('refine-script-preview');
            const refineInstructionsInput = document.getElementById('refine-instructions-input');
            const cancelRefineScript = document.getElementById('cancel-refine-script');
            const refineForm = document.getElementById('refine-form');
            const workflowGenerateBtn = document.getElementById('workflow-generate');
            const workflowRefactorBtn = document.getElementById('workflow-refactor');

            // --- Prompts & Rules ---
            const baseMetaPrompt = `You are an expert PowerShell scripting assistant. Your goal is to generate a robust, clean, and efficient PowerShell script based on the user's request.
- The script MUST be fully functional and stand-alone.
- The script MUST follow PowerShell best practices.
- Use full cmdlet names, not aliases.
- Use clear variable names.
- Add comments where the logic is complex.
- The script MUST start with a comment block containing a title, a brief description of what it does, and the target environment.
- **Action-Based Warning:** If the script performs any action that modifies, creates, or deletes system objects (e.g., using verbs like Set, New, Remove, Disable, Stop, Add, etc.), it MUST include a prominent warning block at the top, advising the user to understand the script and test it in a safe environment first.
- Format the final output inside a single \`\`\`powershell code block. Do not include any other explanatory text outside of the code block.`;

            const environmentRules = {
                'Active Directory': `- **Best Practices:** Scripts MUST use efficient filters (\`-Filter\` or \`-LDAPFilter\`) on cmdlets like \`Get-ADUser\` or \`Get-ADComputer\`. DO NOT pipe a full \`Get-*\` command to \`Where-Object\` as it is highly inefficient for large directories. Assume the script is run from a domain-joined machine with RSAT installed.`,
                'Azure (Az Module)': `- **Authentication:** MUST use \`Connect-AzAccount\`. When possible, show \`Connect-AzAccount -Identity\` for use in automation environments like Azure Automation. \n- **Context:** Before running commands, scripts should check the current subscription context with \`Get-AzContext\`. \n- **Cmdlets:** Use specific cmdlets (\`Get-AzVM\`, \`Get-AzResourceGroup\`, etc.) with resource names and resource groups for efficiency.`,
                'MS Graph (SDK)': `- **Authentication:** MUST use \`Connect-MgGraph\`. The \`-Scopes\` parameter IS REQUIRED. \n- **Permissions:** The script MUST identify and request the **least-privilege** permissions required for the task. \n- **Pagination:** For commands that may return many items, the script MUST use the \`-All\` parameter to handle pagination correctly.`,
                'MS365 / Entra ID': `- **Modern Standard:** This environment exclusively uses the **Microsoft Graph SDK**. Scripts MUST NOT use legacy \`MSOnline\` or \`AzureAD\` modules. \n- **Guidance:** All rules from the 'MS Graph (SDK)' environment apply here, including the mandatory use of \`Connect-MgGraph\` with least-privilege scopes and handling pagination with \`-All\`.`,
                'MS365 / Exchange Online': `- **Best Practices:** Scripts MUST leverage server-side filtering using the \`-Filter\` parameter on cmdlets like \`Get-Mailbox\` and \`Get-Recipient\` for maximum performance. \n- **Authentication:** Must use \`Connect-ExchangeOnline\`, preferably with the \`-UserPrincipalName\` parameter specified.`,
                'MS365 / SharePoint PnP': `- **Authentication:** For interactive use, MUST show \`Connect-PnPOnline -Url <SiteURL> -Interactive\`. For automation, scripts should demonstrate **app-based authentication** using \`-ClientId\` and \`-ClientSecret\` or \`-CertificateThumbprint\`. \n- **Cmdlets:** Use modern \`PnP.PowerShell\` cmdlets like \`Get-PnPList\`, \`Get-PnPListItem\`, etc.`,
                'MS365 / Teams': `- **Dual Approach:** Use the \`MicrosoftTeams\` module for basic connection and team/user management. For advanced automation (managing channels, messages, tabs), the script should prefer the **Microsoft Graph SDK** (\`Connect-MgGraph\` with scopes like \`Team.ReadWrite.All\`, \`ChannelMessage.Send\`).`,
                'PowerCLI (VMware)': `- **Best Practices:** Scripts MUST connect using \`Connect-VIServer\` and properly disconnect at the end using \`Disconnect-VIServer -Confirm:$false\`. \n- **Efficiency:** Use the \`Get-View\` cmdlet for high-performance queries on large vSphere environments. When using \`Get-VM\`, filter by location (e.g., \`-Datacenter\`, \`-Cluster\`) when possible.`,
                'Windows Desktop (10/11)': `- **Best Practices:** For system information, use \`Get-ComputerInfo\`. For installed software, query registry keys (\`HKLM:\\...\\Uninstall\`) with \`Get-ItemProperty\`. For services/processes, use \`Get-Service\`/\`Get-Process\`. For modern management tasks, prefer CIM cmdlets (\`Get-CimInstance\`) over legacy WMI (\`Get-WmiObject\`).`,
                'Windows Server': `- **Best Practices:** For Roles/Features, scripts MUST use \`Get-WindowsFeature\`/\`Install-WindowsFeature\`. For event logs, \`Get-WinEvent\` with \`-FilterHashtable\` is required for performance. For other tasks, follow the 'Windows Desktop' guidance (CIM over WMI, etc.). Assume scripts are run with administrative privileges.`,
            };
            
            const validationMetaPrompt = `You are an expert PowerShell script validator. Your task is to analyze the provided script and refine it based on the specified environment rules.
- **Goal:** Ensure the script is correct, follows best practices, and adheres strictly to the environment rules.
- **Action:** Review the script against the rules. If it's valid, return it as is. If it has errors (e.g., uses wrong cmdlets, misses an authentication step), fix them and return the corrected script.
- **Output:** The response MUST ONLY contain the final, corrected PowerShell script inside a single \`\`\`powershell code block. Do not add any extra text or explanation.`;

            const refinementMetaPrompt = `You are an expert PowerShell script assistant. The user has provided an existing script and a request to refine it. Your task is to return a new version of the script that incorporates the user's changes.
- Adhere strictly to the user's instructions for refinement.
- Maintain the original functionality of the script unless asked to change it.
- Ensure the refined script still follows the provided environment rules and PowerShell best practices.
- The response MUST ONLY contain the final, corrected PowerShell script inside a single \`\`\`powershell code block. Do not add any extra text or explanation.`;

            // --- UI & Core Functions ---
            const setLoadingState = (isLoading) => {
                const buttons = [submitButton, document.querySelector('#refine-form button[type="submit"]')];
                buttons.forEach(button => {
                    if (!button) return;
                    const icon = button.querySelector('svg:not(.animate-spin)');
                    const spinner = button.querySelector('svg.animate-spin');
                    if (isLoading) {
                        if(icon) icon.classList.add('hidden');
                        if(spinner) spinner.classList.remove('hidden');
                        button.disabled = true;
                    } else {
                        if(icon) icon.classList.remove('hidden');
                        if(spinner) spinner.classList.add('hidden');
                        button.disabled = false;
                    }
                });
            };
            
            const displayMessage = (message, title = "Error") => { alert(`[${title}] ${message}`); };

            async function callGeminiAPI(prompt) {
                if (!appState.geminiApiKey) throw new Error("Gemini API key is not configured.");
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${appState.geminiApiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
                const result = await response.json();
                if (result.promptFeedback && result.promptFeedback.blockReason) throw new Error(`Request blocked: ${result.promptFeedback.blockReason}`);
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts) {
                    return result.candidates[0].content.parts[0].text || '';
                } else { console.warn("API returned no valid content.", result); return ''; }
            }
            
            // --- Firebase & Auth ---
            function initializeFirebase(config) {
                try {
                    const app = window.initializeApp(config);
                    appState.auth = window.getAuth(app);
                    appState.db = window.getFirestore(app);
                    setupAuthObserver();
                } catch (error) { console.error("Firebase Init Error:", error); displayMessage("Failed to initialize Firebase. Check your configuration.", "Error"); }
            }
            function setupAuthObserver() {
                window.onAuthStateChanged(appState.auth, user => {
                    if (user) {
                        appState.user = { uid: user.uid, displayName: user.displayName, photoURL: user.photoURL };
                        userProfileArea.classList.remove('hidden'); userProfileArea.classList.add('flex');
                        authButton.classList.add('hidden');
                        userPhoto.src = user.photoURL; userName.textContent = user.displayName;
                        saveToCloudButton.disabled = false; loadFromCloudButton.disabled = false;
                    } else {
                        appState.user = null;
                        userProfileArea.classList.add('hidden'); userProfileArea.classList.remove('flex');
                        authButton.classList.remove('hidden');
                        saveToCloudButton.disabled = true; loadFromCloudButton.disabled = true;
                        profileDropdownMenu.classList.remove('active');
                    }
                });
            }
            async function signInWithGoogle() {
                const provider = new window.GoogleAuthProvider();
                try { await window.signInWithPopup(appState.auth, provider); } catch (error) { console.error("Google Sign-In Error:", error); displayMessage(`Could not sign in: ${error.message}`); }
            }
            async function signOutUser() { try { await window.signOut(appState.auth); } catch (error) { console.error("Sign Out Error:", error); } }
            
            // --- Firestore Functions ---
            async function saveScriptToFirestore(name, content, environment) {
                if (!appState.user) { displayMessage("You must be logged in to save scripts."); return; }
                try {
                    await window.addDoc(window.collection(appState.db, 'scripts'), { uid: appState.user.uid, name: name, content: content, environment: environment, createdAt: window.serverTimestamp() });
                    displayMessage("Script saved successfully!", "Success");
                    saveScriptModal.classList.remove('active');
                } catch (error) { console.error("Error saving script:", error); displayMessage(`Failed to save script: ${error.message}`); }
            }
            async function loadScriptsFromFirestore() {
                if (!appState.user) { displayMessage("You must be logged in to load scripts."); return; }
                loadScriptModal.classList.add('active');
                savedScriptsList.innerHTML = '<p class="text-gray-400">Loading scripts...</p>';
                try {
                    const q = window.query(window.collection(appState.db, "scripts"), window.where("uid", "==", appState.user.uid), window.orderBy("createdAt", "desc"));
                    const querySnapshot = await window.getDocs(q);
                    if (querySnapshot.empty) { savedScriptsList.innerHTML = '<p class="text-gray-400">No saved scripts found.</p>'; return; }
                    savedScriptsList.innerHTML = '';
                    querySnapshot.forEach(doc => {
                        const script = doc.data();
                        const scriptEl = document.createElement('div');
                        scriptEl.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                        scriptEl.innerHTML = `<div><h4 class="font-bold text-white">${script.name}</h4><p class="text-sm text-gray-400">${script.environment}</p></div><div><button data-id="${doc.id}" class="load-btn bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded-md text-sm">Load</button><button data-id="${doc.id}" class="delete-btn bg-red-600 hover:bg-red-700 text-white py-1 px-3 rounded-md text-sm ml-2">Delete</button></div>`;
                        scriptEl.dataset.content = script.content; scriptEl.dataset.env = script.environment;
                        savedScriptsList.appendChild(scriptEl);
                    });
                } catch (error) { console.error("Error loading scripts:", error); savedScriptsList.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`; }
            }
            async function deleteScriptFromFirestore(id) {
                if (!confirm("Are you sure you want to delete this script?")) return;
                try {
                    await window.deleteDoc(window.doc(appState.db, 'scripts', id));
                    displayMessage("Script deleted successfully.", "Success");
                    loadScriptsFromFirestore();
                } catch (error) { console.error("Error deleting script:", error); displayMessage(`Failed to delete script: ${error.message}`); }
            }

            // --- Script Display & Generation Logic ---
            const setActiveTab = (tabId) => {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.output-content').forEach(content => content.classList.remove('active'));
                const tabButton = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
                const tabContent = document.getElementById(tabId);
                if (tabButton) tabButton.classList.add('active');
                if (tabContent) tabContent.classList.add('active');
            };
            const createTab = (tabId, title, isActive = false) => {
                if (document.querySelector(`.tab-btn[data-tab="${tabId}"]`)) return;
                const button = document.createElement('button');
                button.className = `tab-btn text-gray-400 hover:text-white px-3 py-2 text-sm font-medium ${isActive ? 'active' : ''}`;
                button.dataset.tab = tabId; button.textContent = title;
                tabsContainer.appendChild(button);
            };
            const renderContent = (tabId, title, content, isHtml = false) => {
                initialMessage.classList.add('hidden');
                outputActions.classList.remove('hidden');
                if (document.getElementById(tabId)) document.getElementById(tabId).remove();
                createTab(tabId, title);
                const contentWrapper = document.createElement('div');
                contentWrapper.id = tabId; contentWrapper.className = 'output-content p-4';
                if (isHtml) {
                    contentWrapper.innerHTML = `<div class="prose prose-invert max-w-none">${DOMPurify.sanitize(marked.parse(content))}</div>`;
                } else {
                    const pre = document.createElement('pre');
                    const code = document.createElement('code');
                    code.className = 'language-powershell'; code.textContent = content;
                    pre.appendChild(code); contentWrapper.appendChild(pre);
                    hljs.highlightElement(code);
                }
                outputContainer.appendChild(contentWrapper); setActiveTab(tabId);
            };
            const addMessageToHistory = (sender, message) => {
                const msgDiv = document.createElement('div');
                const cleanMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                msgDiv.className = sender === 'user' ? 'bg-gray-800 p-3 rounded-lg self-end' : 'bg-blue-900/50 p-3 rounded-lg self-start';
                msgDiv.innerHTML = `<p class="text-white">${cleanMessage}</p>`;
                chatHistoryContainer.appendChild(msgDiv); chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
            };

            const handleGenerationSubmit = async (e) => {
                e.preventDefault();
                const userPrompt = promptInput.value.trim();
                if (!userPrompt) return;
                addMessageToHistory('user', userPrompt);
                promptInput.value = '';
                setLoadingState(true);
                tabsContainer.innerHTML = ''; outputContainer.innerHTML = '';
                initialMessage.classList.remove('hidden'); outputActions.classList.add('hidden');
                addMessageToHistory('ai', 'Generating script...');
                try {
                    const targetEnvironment = targetEnvSelect.value;
                    const rules = environmentRules[targetEnvironment];
                    const finalPrompt = `${baseMetaPrompt}\n\n**ENVIRONMENT RULES:**\n${rules}\n\n**TASK:**\nGenerate a script for the following request:\n\`\`\`\n${userPrompt}\n\`\`\``;
                    appState.lastGenerationPrompt = finalPrompt;
                    
                    const generatedScript = await callGeminiAPI(finalPrompt);
                    addMessageToHistory('ai', 'Initial script generated. Now validating...');
                    
                    const validationPrompt = `${validationMetaPrompt}\n\n**ENVIRONMENT RULES:**\n${rules}\n\n**SCRIPT TO VALIDATE:**\n${generatedScript}`;
                    appState.lastValidationPrompt = validationPrompt;
                    const refinedScript = await callGeminiAPI(validationPrompt);
                    
                    const finalCode = refinedScript.match(/```powershell\s*([\s\S]*?)\s*```/)?.[1] || refinedScript;
                    appState.currentScript = finalCode;
                    appState.currentTabs = { 'script-content': finalCode };
                    addMessageToHistory('ai', 'Script validated and refined successfully.');
                    renderContent('script-content', 'Script', finalCode);
                } catch (error) {
                    console.error("Error during script generation:", error);
                    addMessageToHistory('ai', `**Error:** ${error.message}`);
                    displayMessage(error.message, "Generation Error");
                } finally {
                    setLoadingState(false);
                }
            };

            const handleRefinementSubmit = async (e) => {
                e.preventDefault();
                const instructions = refineInstructionsInput.value.trim();
                if (!instructions || !appState.currentScript) return;
                setLoadingState(true);
                refineScriptModal.classList.remove('active');
                addMessageToHistory('user', `Refinement request: ${instructions}`);
                refineInstructionsInput.value = '';
                try {
                    addMessageToHistory('ai', 'Refining script...');
                    const rules = environmentRules[targetEnvSelect.value];
                    const prompt = `${refinementMetaPrompt}\n\n**ENVIRONMENT RULES:**\n${rules}\n\n**EXISTING SCRIPT:**\n\`\`\`powershell\n${appState.currentScript}\n\`\`\`\n\n**USER'S REFINEMENT REQUEST:**\n${instructions}`;
                    appState.lastGenerationPrompt = prompt; // Store this as the main prompt for viewing
                    
                    const refinedScript = await callGeminiAPI(prompt);
                    addMessageToHistory('ai', 'Validation pass...');

                    const validationPrompt = `${validationMetaPrompt}\n\n**ENVIRONMENT RULES:**\n${rules}\n\n**SCRIPT TO VALIDATE:**\n${refinedScript}`;
                    appState.lastValidationPrompt = validationPrompt;
                    const finalScript = await callGeminiAPI(validationPrompt);

                    const finalCode = finalScript.match(/```powershell\s*([\s\S]*?)\s*```/)?.[1] || finalScript;
                    appState.currentScript = finalCode;
                    appState.currentTabs = { 'script-content': finalCode };
                    renderContent('script-content', 'Script', finalCode);
                    addMessageToHistory('ai', 'Script refined successfully.');
                } catch (error) {
                    console.error("Error during script refinement:", error);
                    addMessageToHistory('ai', `**Error:** ${error.message}`);
                    displayMessage(error.message, "Refinement Error");
                } finally {
                    setLoadingState(false);
                }
            };

            // --- Event Listeners ---
            configForm.addEventListener('submit', (e) => { e.preventDefault(); appState.geminiApiKey = geminiKeyInput.value.trim(); try { const configText = firebaseConfigInput.value.trim(); if (!appState.geminiApiKey || !configText) { displayMessage("Please fill out all fields."); return; } appState.firebaseConfig = JSON.parse(configText); initializeFirebase(appState.firebaseConfig); configModal.classList.remove('active'); } catch (error) { displayMessage("Firebase config is not valid JSON."); } });
            authButton.addEventListener('click', signInWithGoogle);
            logoutButton.addEventListener('click', signOutUser);
            userProfileArea.addEventListener('click', () => profileDropdownMenu.classList.toggle('active'));

            workflowGenerateBtn.addEventListener('click', () => {
                workflowGenerateBtn.classList.add('workflow-btn-active');
                workflowRefactorBtn.classList.remove('workflow-btn-active');
            });
            workflowRefactorBtn.addEventListener('click', () => {
                workflowRefactorBtn.classList.add('workflow-btn-active');
                workflowGenerateBtn.classList.remove('workflow-btn-active');
                pasteScriptModal.classList.add('active');
                pasteInput.value = '';
                pasteInput.focus();
            });

            cancelPasteScript.addEventListener('click', () => pasteScriptModal.classList.remove('active'));
            loadPastedScript.addEventListener('click', () => {
                const scriptContent = pasteInput.value.trim();
                if (!scriptContent) { displayMessage("No script was pasted."); return; }
                appState.currentScript = scriptContent;
                appState.currentTabs = { 'script-content': scriptContent };
                tabsContainer.innerHTML = ''; outputContainer.innerHTML = '';
                renderContent('script-content', 'Script', scriptContent);
                pasteScriptModal.classList.remove('active');
                addMessageToHistory('ai', 'Script loaded. Use "Refine" to make changes.');
            });

            outputActions.addEventListener('click', async (e) => {
                const targetId = e.target.id;
                if(targetId === 'refine-script-button'){
                    if (!appState.currentScript) return;
                    refineScriptPreview.textContent = appState.currentScript;
                    hljs.highlightElement(refineScriptPreview);
                    refineScriptModal.classList.add('active');
                    refineInstructionsInput.focus();
                }
                if(targetId === 'explain-script-button'){
                    setLoadingState(true);
                    try {
                        addMessageToHistory('ai', 'Generating explanation...');
                        const explainPrompt = `Explain the following PowerShell script in a clear, concise way. Describe its purpose, how it works, and any important cmdlets it uses. Format the output as Markdown.\n\n\`\`\`powershell\n${appState.currentScript}\n\`\`\``;
                        const explanation = await callGeminiAPI(explainPrompt);
                        appState.currentTabs['explanation-content'] = explanation;
                        renderContent('explanation-content', 'Explanation', explanation, true);
                    } catch(error) { displayMessage(`Explanation failed: ${error.message}`); } 
                    finally { setLoadingState(false); }
                }
                if (targetId === 'copy-script-button') {
                    const activeContent = appState.currentTabs[document.querySelector('.output-content.active')?.id];
                    if(activeContent) navigator.clipboard.writeText(activeContent).then(() => displayMessage("Copied to clipboard!", "Success"));
                }
                if (targetId === 'download-script-button') {
                    const activeContent = appState.currentTabs[document.querySelector('.output-content.active')?.id];
                    if(activeContent){
                        const blob = new Blob([activeContent], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url; a.download = 'script.ps1';
                        a.click(); URL.revokeObjectURL(url);
                    }
                }
            });

            cancelRefineScript.addEventListener('click', () => refineScriptModal.classList.remove('active'));
            refineForm.addEventListener('submit', handleRefinementSubmit);

            saveToCloudButton.addEventListener('click', () => { if (!appState.currentScript) { displayMessage("No script to save."); return; } saveScriptModal.classList.add('active'); scriptNameInput.value = ''; scriptNameInput.focus(); });
            cancelSaveScript.addEventListener('click', () => saveScriptModal.classList.remove('active'));
            saveScriptForm.addEventListener('submit', (e) => { e.preventDefault(); const scriptName = scriptNameInput.value.trim(); saveScriptToFirestore(scriptName, appState.currentScript, targetEnvSelect.value); });
            
            loadFromCloudButton.addEventListener('click', loadScriptsFromFirestore);
            closeLoadScriptModal.addEventListener('click', () => loadScriptModal.classList.remove('active'));
            savedScriptsList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('load-btn')) {
                    const parent = e.target.closest('.bg-gray-700');
                    appState.currentScript = parent.dataset.content;
                    appState.currentTabs = { 'script-content': parent.dataset.content };
                    targetEnvSelect.value = parent.dataset.env;
                    tabsContainer.innerHTML = ''; outputContainer.innerHTML = '';
                    renderContent('script-content', 'Script', appState.currentScript);
                    loadScriptModal.classList.remove('active');
                    addMessageToHistory('ai', 'Script loaded from cloud.');
                }
                if (e.target.classList.contains('delete-btn')) {
                    deleteScriptFromFirestore(e.target.dataset.id);
                }
            });

            tabsContainer.addEventListener('click', (e) => { if(e.target.classList.contains('tab-btn')) setActiveTab(e.target.dataset.tab); });
            
            viewPromptsBtn.addEventListener('click', () => {
                document.getElementById('last-generation-prompt').textContent = appState.lastGenerationPrompt || 'No script generated in this session yet.';
                document.getElementById('last-validation-prompt').textContent = appState.lastValidationPrompt || 'No script generated in this session yet.';
                document.getElementById('base-prompt-content').textContent = baseMetaPrompt;
                document.getElementById('validation-prompt-content').textContent = validationMetaPrompt;
                document.getElementById('rules-content').textContent = JSON.stringify(environmentRules, null, 2);
                promptsModal.classList.add('active');
            });
            closePromptsModal.addEventListener('click', () => promptsModal.classList.remove('active'));
            promptsModal.addEventListener('click', e => {
                if (e.target.classList.contains('accordion-toggle')) {
                    const content = e.target.nextElementSibling;
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        e.target.textContent = e.target.textContent.replace('▲', '▼');
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                        e.target.textContent = e.target.textContent.replace('▼', '▲');
                    }
                }
            });
            
            promptForm.addEventListener('submit', handleGenerationSubmit);

            // --- Initial UI Setup ---
            document.getElementById('app-version').textContent = `v${appState.version}`;
        });
    </script>
</body>
</html>
