<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerShell ScriptSmith AI</title>
    
    <script src="https://cdn.tailwindcss.com/"></script>
    <script>
      tailwind.config = { plugins: [] }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/powershell.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/markdown.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link 
href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #111827; 
        }
        ::-webkit-scrollbar { 
            width: 8px;
        }
        ::-webkit-scrollbar-track { 
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb { 
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: #6b7280;
        }
        .code-font { 
            font-family: 'Fira Code', monospace;
        }
        .modal { 
            display: none;
        }
        .modal.active { 
            display: flex;
        }
        .modal-close-button { 
            font-size: 2rem;
            line-height: 1; 
            font-weight: bold;
        }
        /* V6.2 specific styles retained */
        #output-panel .tab-content, .modal { display: none;
        }
        #output-panel .tab-content.active, .modal.active { display: flex;
        }
        #output-panel pre { flex-grow: 1; margin: 0;
        }
    </style>
</head>
<body class="text-gray-200">

    <div id="config-modal" class="modal active fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
            <h2 class="text-2xl font-bold text-white mb-4">Initial Configuration</h2>
            <p class="text-gray-400 mb-6">Please provide your API keys and configuration to use the application.</p>
            <form id="config-form">
             
                <div>
                    <label for="gemini-key-input" class="block text-sm font-medium text-gray-300">Gemini API Key</label>
                    <input type="password" id="gemini-key-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-1" placeholder="Your Google AI API Key">
                </div>
                <div 
class="mt-4">
                    <label for="google-client-id-input" class="block text-sm font-medium text-gray-300">Google Client ID</label>
                    <input type="text" id="google-client-id-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-1" placeholder="your-client-id.apps.googleusercontent.com">
                </div>
                <div class="mt-4">
       
                    <label for="firebase-config-input" class="block text-sm font-medium text-gray-300">Firebase Config</label>
                    <textarea id="firebase-config-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-1 code-font" rows="6" placeholder="{ 
  apiKey: '...',
  authDomain: '...',
  projectId: '...',
  storageBucket: '...',
  messagingSenderId: '...',
  appId: '...'
}"></textarea>
                </div>
            
                <button type="submit" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200">Save and Initialize</button>
            </form>
        </div>
    </div>
    
    <div id="prompts-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-3xl relative max-h-[80vh] flex flex-col">
            <button id="close-prompts-modal" class="modal-close-button absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button>
    
            <h2 class="text-2xl font-bold text-white mb-4 flex-shrink-0">System Prompts</h2>
            <div class="overflow-y-auto pr-4 space-y-4">
                <div>
                    <h3 class="text-lg font-semibold text-blue-400 mb-2">Base Meta Prompt</h3>
                    <pre class="bg-gray-900 p-3 rounded-lg text-gray-300 text-sm whitespace-pre-wrap code-font" id="modal-base-prompt"></pre>
 
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-blue-400 mb-2">Environment Context</h3>
                    <p class="text-gray-400 text-sm mb-2">This text is added to instruct the AI on compatibility.
`{{targetEnvironment}}` is replaced with your selection.</p>
                    <pre class="bg-gray-900 p-3 rounded-lg text-gray-300 text-sm whitespace-pre-wrap code-font" id="modal-env-context"></pre>
                </div>
                 <div>
                    <h3 class="text-lg font-semibold text-blue-400 mb-2">Task-Specific Prompts</h3>
         
                    <p class="text-gray-400 text-sm mb-2">Depending on the mode, one of the following instructions is used.
Placeholders like `{{userPrompt}}` are replaced with your input.</p>
                    <div class="space-y-3">
                         <details class="bg-gray-900 p-3 rounded-lg">
                            <summary class="font-semibold text-gray-200 cursor-pointer">Generate New Script</summary>
           
                            <pre class="mt-2 text-gray-300 text-sm whitespace-pre-wrap code-font" id="modal-generate-prompt"></pre>
                         </details>
                         <details class="bg-gray-900 p-3 rounded-lg">
                        
                            <summary class="font-semibold text-gray-200 cursor-pointer">Refactor Existing Script</summary>
                             <pre class="mt-2 text-gray-300 text-sm whitespace-pre-wrap code-font" id="modal-refactor-prompt"></pre>
                         </details>
                    </div>
           
                </div>
            </div>
        </div>
    </div>
    <div id="explain-script-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-4xl relative max-h-[80vh] flex flex-col">
            <button id="close-explain-script-modal" class="modal-close-button absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button>
            <h2 class="text-2xl font-bold text-white mb-4 flex-shrink-0">Script Explanation (AI-Generated)</h2>
            <div id="explain-script-content" class="prose prose-invert max-w-none prose-pre:bg-gray-900 overflow-y-auto pr-4">
                <p>Explanation generating...</p>
            </div>
        </div>
    </div>
    
    <div id="explain-app-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-4xl relative max-h-[80vh] flex flex-col">
            <button id="close-explain-app-modal" class="modal-close-button absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button>
            <h2 class="text-2xl font-bold text-white mb-4 flex-shrink-0">How This App Works 
(AI-Generated)</h2>
            <div id="explain-app-content" class="prose prose-invert max-w-none prose-pre:bg-gray-900 overflow-y-auto pr-4">
                </div>
        </div>
    </div>
    
    <div id="suggest-improvements-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50"></div>

    <div id="app" class="flex flex-col h-screen">
        <header class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 p-4 flex items-center justify-between shadow-lg z-20">
          
            <div class="flex items-center space-x-3">
                <svg class="w-8 h-8 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m6.75 7.5 3 2.25-3 2.25m4.5 0h3m-9.75 6.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6.75a1.5 1.5 0 0 0-1.5-1.5H3.75a1.5 1.5 0 0 0-1.5 1.5v10.5a1.5 1.5 0 0 0 1.5 1.5Z" /></svg>
              
                <h1 class="text-xl font-bold text-white">PowerShell ScriptSmith AI <span id="app-version" class="text-xs font-mono text-blue-400/80 ml-2"></span></h1>
            </div>
            <div class="flex items-center space-x-2">
                <button id="suggest-improvements-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold p-2 rounded-full" title="Suggest Improvements (AI-Generated)"></button>
                
                <button id="explain-app-button" 
class="bg-gray-700 hover:bg-gray-600 text-white font-semibold p-2 rounded-full" title="How This App Works (AI-Generated)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 
000-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button id="view-prompts-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg text-sm">View Prompts</button>
                <button id="auth-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg" disabled>Login with 
Google</button>
            </div>
        </header>

        <main class="flex-grow flex flex-col md:flex-row overflow-hidden">
            <div class="w-full md:w-1/3 flex flex-col bg-gray-900 border-r border-gray-700">
                <div class="p-4 border-b border-gray-700 space-y-4">
                    <div>
        
                        <label class="text-lg font-semibold">Mode</label>
                        <div class="mt-2 flex bg-gray-800 rounded-lg p-1">
                            <button id="mode-generate" class="w-full py-2 text-sm font-medium rounded-md">Generate New</button>
                  
                            <button id="mode-refactor" class="w-full py-2 text-sm font-medium rounded-md">Refactor Existing</button>
                        </div>
                    </div>
                    <div>
                   
                        <label for="target-env" class="text-lg font-semibold">Target Environment</label>
                        <select id="target-env" class="mt-2 w-full p-2 bg-gray-800 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option>PowerShell 7 (Cross-Platform)</option><option>Windows PowerShell 5.1</option><option>Azure Automation</option><option>Windows Server 2022</option><option>Windows Server 2019</option>
                   
                        </select>
                    </div>
                </div>
                <div id="chat-history" class="flex-grow p-4 overflow-y-auto space-y-4"></div>
                <div class="p-4 border-t border-gray-700 bg-gray-900">
                  
                    <form id="prompt-form" class="flex items-center space-x-2">
                        <textarea id="prompt-input" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-500" rows="2"></textarea>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-lg transition-colors duration-200 flex-shrink-0 self-end">
                      
                            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.105 2.289a.75.75 0 0 0-.826.95l1.414 4.925A1.5 1.5 0 0 0 5.135 9.25h6.115a.75.75 0 0 1 0 1.5H5.135a1.5 1.5 0 0 0-1.442 1.086L2.279 16.76a.75.75 0 0 0 .95.826l16-5.333a.75.75 0 0 0 0-1.418l-16-5.333Z" /></svg>
                        </button>
                    </form>
          
                </div>
            </div>

            <div id="output-panel" class="w-full md:w-2/3 flex flex-col bg-gray-800/50 overflow-y-auto relative">
                <div class="border-b border-gray-700 sticky top-0 bg-gray-800/80 backdrop-blur-sm z-10">
                   <nav id="tabs" class="flex space-x-1 p-1"></nav>
                   <div id="output-actions" class="p-2 flex justify-end space-x-2 border-t border-gray-700 hidden">
                        <button id="copy-script-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-1 px-3 rounded-md text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v2a2 2 0 01-2 2h-2m-6 0H6a2 2 0 00-2 2v2a2 2 0 002 2h2" />
                            </svg>
                            Copy
                        </button>
                        <button id="download-script-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-1 px-3 rounded-md text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Download (.ps1)
                        </button>
                        <button id="explain-script-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded-md text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Explain Script
                        </button>
                   </div>
                </div>
                <div id="output-container" class="flex-grow relative">
                    <div id="initial-message" class="flex flex-col items-center justify-center h-full text-center text-gray-500 p-6">
                        <svg class="w-16 h-16 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m6.75 7.5 3 2.25-3 2.25m4.5 0h3m-9.75 6.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6.75a1.5 1.5 0 0 0-1.5-1.5H3.75a1.5 1.5 0 0 0-1.5 1.5v10.5a1.5 1.5 0 0 0 1.5 1.5Z" /></svg>
                        <h3 class="text-xl font-semibold text-gray-400">Your generated script will appear here</h3>
                        <p class="mt-2 max-w-md">Select a mode, describe your needs or paste a script, and send.</p>
                  
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- --- Global Scope for API Callbacks & State --- -->
    <script>
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // --- Service Initialization Functions (Global Scope) ---
        function gapiLoaded() {
            // Load the client library and set the flag
            gapi.load('client', () => {
                gapiInited = true;
            });
        }

        function gisLoaded() {
            // Set the GIS flag
            gisInited = true;
        }
    </script>
    <!-- Moved these scripts after the global functions are defined -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        async function initializeGapiDrive(clientId) {
            if (!gapiInited) { 
                console.error("GAPI not loaded yet.");
                return; 
            }
            try {
                // Initialize GAPI client with Drive API discovery doc
                // Note: We initialize without the API key here, as Google Drive operations typically
                // rely on the access token provided by the OAuth flow.
                await gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                    client_id: clientId // Added client_id for explicit configuration
                });
                console.log("Google Drive Client Initialized.");
            } catch (error) {
                console.error("GAPI Drive Init Error:", error);
                // Using a custom modal/message box instead of alert()
                displayMessageModal("Failed to initialize Google Drive client. Check console for details.", "Error");
            }
        }

        function initializeTokenClient(clientId) {
            if (!gisInited) { 
                console.error("GSI not loaded yet.");
                return; 
            }
            try {
                 // Initialize the token client for Google Sign-In
                 tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: clientId,
                    scope: SCOPES,
 
                    callback: (tokenResponse) => {
                       if (tokenResponse && tokenResponse.access_token) {
                            document.getElementById('auth-button').textContent = 'Logout';
                     
                        }
                    },
                });
                document.getElementById('auth-button').disabled = false;
                console.log("Google Token Client Initialized.");
            } catch(error) {
                console.error("Token Client Init Error:", error);
                // Using a custom modal/message box instead of alert()
                displayMessageModal("Failed to initialize Google Sign-In. Check your Client ID.", "Error");
            }
        }

        function initializeFirebase(config) {
             try {
                // Initialize Firebase only if it hasn't been initialized already
                if (firebase.apps.length === 0) {
              
                    firebase.initializeApp(config);
                    console.log("Firebase Initialized.");
                }
            } catch (error) {
                console.error("Firebase Init Error:", error);
                // Using a custom modal/message box instead of alert()
                displayMessageModal("Failed to initialize Firebase. Check your configuration object.", "Error");
            }
        }

        // --- Custom Message Modal (replacement for alert) ---
        function displayMessageModal(message, title = "Message") {
            const modalId = 'custom-message-modal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-sm relative">
                        <h2 class="text-xl font-bold text-white mb-4" id="custom-message-modal-title"></h2>
                        <p class="text-gray-400 mb-6" id="custom-message-modal-content"></p>
                        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200" id="custom-message-modal-close">OK</button>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('custom-message-modal-close').addEventListener('click', () => {
                    modal.classList.remove('active');
                });
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.classList.remove('active');
                });
            }
            document.getElementById('custom-message-modal-title').textContent = title;
            document.getElementById('custom-message-modal-content').textContent = message;
            modal.classList.add('active');
        }

        // --- Main App Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const APP_VERSION = '6.11.0'; // Updated version number

            // --- Element References (Combined V6.2.2 and V6.2) ---
            const configModal = document.getElementById('config-modal');
            const configForm = document.getElementById('config-form');
            const geminiKeyInput = document.getElementById('gemini-key-input');
            const googleClientIdInput = document.getElementById('google-client-id-input');
            const firebaseConfigInput = document.getElementById('firebase-config-input');
            const authButton = document.getElementById('auth-button');
            const promptsModal = document.getElementById('prompts-modal');
            const closePromptsModal = document.getElementById('close-prompts-modal');
 
            const explainAppModal = document.getElementById('explain-app-modal');
            const closeExplainAppModal = document.getElementById('close-explain-app-modal');
            const explainScriptModal = document.getElementById('explain-script-modal');
            const closeExplainScriptModal = document.getElementById('close-explain-script-modal');
            const explainScriptContent = document.getElementById('explain-script-content');

            const explainAppButton = document.getElementById('explain-app-button');
            const explainAppContent = document.getElementById('explain-app-content');
            const viewPromptsButton = document.getElementById('view-prompts-button');
            // V6.2 specific UI elements
            const promptForm = document.getElementById('prompt-form');
            const promptInput = document.getElementById('prompt-input');
            const chatHistoryContainer = document.getElementById('chat-history');
            const modeGenerateBtn = document.getElementById('mode-generate');
            const modeRefactorBtn = document.getElementById('mode-refactor');
            const targetEnvSelect = document.getElementById('target-env');
            const tabsContainer = document.getElementById('tabs');
            const initialMessage = document.getElementById('initial-message');
            const outputContainer = document.getElementById('output-container');
            const outputActions = document.getElementById('output-actions');
            const copyScriptButton = document.getElementById('copy-script-button');
            const downloadScriptButton = document.getElementById('download-script-button');
            const explainScriptButton = document.getElementById('explain-script-button');

            // --- State Variables (Combined V6.2.2 and V6.2) ---
            let geminiApiKey = '';
            let googleClientId = '';
            let firebaseConfig = null;
            let conversationHistory = [];
            let currentScript = '';
            let currentMode = 'generate';
            let appExplanation = '';
            const FOLDER_NAME = 'PowerShell Scriptsmith AI';
            
            // Updated Base Meta Prompt incorporating PowerShell best practices and dependency instructions
            // Changed to template literal (backticks) to fix SyntaxError
            const baseMetaPrompt = `You are an expert PowerShell scripting assistant. When generating scripts, adhere strictly to the following best practices for professional, robust, and readable code:

1. Structure and Readability ðŸ“–
An excellent script is easy to read and understand. This is achieved through consistent formatting and logical organization.
	â€¢ Consistent Naming Convention: Use approved verbs for functions (e.g., Get-, Set-, New-, Remove-) and a singular noun for the subject (e.g., Get-Process, not Get-Processes). For variables, use a consistent style like PascalCase ($WebService) or camelCase ($webService).
	â€¢ Commenting and Documentation:
		â—‹ Comment-Based Help: Every script and function should have a comment-based help block. This allows anyone to understand its purpose, parameters, and examples by running Get-Help .\YourScript.ps1 -Full.
		â—‹ Inline Comments: Use comments (#) to explain complex or non-obvious parts of your code. Don't over-comment simple lines.
	â€¢ Code Layout: Use consistent indentation and spacing to visually structure the code. Group related commands and use blank lines to separate logical blocks.

2. Advanced Functions and Parameters âš™ï¸
Instead of simple scripts, expert scripters build advanced functions. This makes the code modular, reusable, and professional.
	â€¢ [CmdletBinding()]: This attribute turns a simple function into an advanced function, giving it access to common parameters like -Verbose, -Debug, and -ErrorAction for free.
	â€¢ Parameter Validation: Always validate your parameters.
		â—‹ [Parameter(Mandatory=$true)]: Ensures a parameter must be provided.
		â—‹ Type Constraints: Strongly type your parameters (e.g., [string]$ComputerName, [int]$RetryCount).
		â—‹ Validation Attributes: Use attributes like [ValidateSet('Value1', 'Value2')], [ValidateRange(0, 100)], and [ValidatePattern('[a-zA-Z]')] to enforce specific input.
	â€¢ Verbose and Debug Output: Use Write-Verbose and Write-Debug instead of Write-Host. Write-Host should generally be avoided.

3. Robust Error Handling ðŸ›¡ï¸
Robust error handling is crucial.
	â€¢ $ErrorActionPreference = 'Stop': Set this at the beginning of your script to ensure non-terminating errors become terminating ones.
	â€¢ Try...Catch...Finally Blocks: Use these for modern error handling.
		â—‹ Try: Enclose the code that might cause an error.
		â—‹ Catch: Handle terminating errors. The $_ variable contains the error record.
		â—‹ Finally: Runs regardless of errors for cleanup tasks.
	â€¢ Specific Exception Handling: Catch specific types of exceptions (e.g., [System.Net.WebException]) for granular control.

4. Pipeline Support ("Thinking in PowerShell") â›“ï¸
An expert script works with the pipeline.
	â€¢ Accepts Pipeline Input: Use ValueFromPipeline or ValueFromPipelineByPropertyName in [Parameter()] attributes.
	â€¢ Begin, Process, End Blocks: Use these blocks when a function processes pipeline input.
		â—‹ Begin: Setup tasks (runs once).
		â—‹ Process: Main logic (runs for each item).
		â—‹ End: Cleanup and returning summary data (runs once).
	â€¢ Output Objects, Not Text: Create custom PowerShell objects ([PSCustomObject]) and output them instead of just formatted text.

5. Performance and Efficiency âš¡
An excellent script is also efficient.
	â€¢ Filter Left, Format Right: Filter data as early as possible (Where-Object) and format (Format-Table, Format-List) as the very last step.
	â€¢ Avoid Loops When Possible: Use the pipeline instead of foreach loops for better memory efficiency.
	â€¢ Use Efficient Cmdlets: Use modern cmdlets like Get-CimInstance instead of older ones like Get-WmiObject.

6. Security Considerations ðŸ”’
A script must be secure.
	â€¢ Avoid Hardcoding Credentials: Never store plain-text passwords. Use PSCredential objects or secure methods.
	â€¢ Code Signing: Scripts should be digitally signed in enterprise environments.
	â€¢ Principle of Least Privilege: The script should only have the permissions it needs.

7. Modularity and Reusability â™»ï¸
Write code that can be reused.
	â€¢ Create Modules: Package related functions into a PowerShell module (.psm1 file) with a module manifest (.psd1 file).
	â€¢ Generalize Functions: Write functions that solve general problems and use parameters for flexibility.

8. Dependency Management ðŸ“¦
	â€¢ If the generated script requires non-standard PowerShell modules (e.g., Az, ActiveDirectory, PnP.PowerShell), include a commented-out section at the beginning of the script to \`Install-Module\` for those dependencies.

By adhering to these principles, the generated PowerShell scripts will be reliable, efficient, and professional automation tools.`;

            // --- Config Modal Logic (V6.2.2) ---
            configForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const geminiKey = geminiKeyInput.value.trim();
                const clientId = googleClientIdInput.value.trim();
       
                const fbConfigString = firebaseConfigInput.value.trim();

                // Validation (V6.2.2)
                if (!geminiKey || !clientId || !fbConfigString) {
                    displayMessageModal('Please fill out all configuration fields.', 'Validation Error');
                    return;
   
                }

                try {
                    const parsedConfig = JSON.parse(fbConfigString);
                    firebaseConfig = parsedConfig;
                } catch (error) {
      
                    displayMessageModal('The Firebase Config is not a valid JSON object. Please check your syntax.', 'Configuration Error');
                    return;
                }

                geminiApiKey = geminiKey;
                googleClientId = clientId;

                // Initialize Firebase first (V6.2.2)
                initializeFirebase(firebaseConfig);
                // Now initialize Google APIs, waiting if necessary

                await Promise.all([
                    new Promise(resolve => {
                        if (gapiInited) resolve();
                        else {
  
                            const checkGAPI = setInterval(() => {
                                if (gapiInited) {
                                   
                                    clearInterval(checkGAPI);
                                    resolve();
                                }
                            }, 100);
  
                        }
                    }),
                    new Promise(resolve => {
                        if (gisInited) resolve();
         
                        else {
                            const checkGIS = setInterval(() => {
                                if (gisInited) {
                 
                                    clearInterval(checkGIS);
                                    resolve();
                                }
             
                            }, 100);
                        }
                    })
                ]);
                // Initialize Google Drive client (gapi.client)
                initializeGapiDrive(googleClientId); // Pass the clientId
                // Initialize Google Sign-In (gis)
                initializeTokenClient(googleClientId);
                configModal.classList.remove('active');
            });
            
            // --- Google Auth Button Logic (V6.2.2) ---
            authButton.addEventListener('click', () => {
                if (!tokenClient) {
                    displayMessageModal("Google Sign-In is not initialized. Please provide your configuration first.", "Authentication Error");
                    return;
         
                }
                // Check if a token exists; request access if not, or clear token if it does
                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
   
                    gapi.client.setToken(null);
                    authButton.textContent = 'Login with Google';
                }
                updateActionButtons(); 
            });

            // Define updateActionButtons to resolve ReferenceError
            const updateActionButtons = () => {
                // Placeholder for updating UI state based on authentication status
                console.log("Auth state updated.");
            };
            
            // --- Modal Controls (V6.2) ---
            const setupModal = (modal, openBtn, closeBtn) => {
                if (openBtn) openBtn.addEventListener('click', () => modal.classList.add('active'));
                if (closeBtn) closeBtn.addEventListener('click', () => modal.classList.remove('active'));
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.classList.remove('active');
                });
            };
            
            setupModal(promptsModal, viewPromptsButton, closePromptsModal);
            setupModal(explainAppModal, null, closeExplainAppModal); // Open is handled manually
            setupModal(explainScriptModal, null, closeExplainScriptModal); // Open handled by explainScript()

            // --- Output Action Functions ---

            const copyScript = async () => {
                try {
                    await navigator.clipboard.writeText(currentScript);
                    displayMessageModal('Script copied to clipboard!', 'Success');
                } catch (err) {
                    console.error('Failed to copy script: ', err);
                    displayMessageModal('Failed to copy script.', 'Error');
                }
            };

            const downloadScript = () => {
                const blob = new Blob([currentScript], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'generated_script.ps1';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const explainScript = async () => {
                if (!currentScript) return;
                
                explainScriptModal.classList.add('active');
                explainScriptContent.innerHTML = `<div class="flex items-center justify-center h-full"><p>Generating explanation with Gemini... this may take a moment.</p></div>`;

                try {
                    if (!geminiApiKey) {
                        explainScriptContent.innerHTML = `<p class="text-red-400">Please enter your API key first to generate this explanation.</p>`;
                        return;
                    }

                    const explanationPrompt = `You are an expert PowerShell scripting assistant. Analyze the following PowerShell script and provide a detailed, line-by-line explanation of how it works. Structure your explanation clearly using markdown.

\`\`\`powershell
${currentScript}
\`\`\``;

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`;
                    const payload = { contents: [{ parts: [{ text: explanationPrompt }] }] };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts) {
                        const rawText = result.candidates[0].content.parts[0].text;
                        // Use marked.js to convert markdown explanation to HTML
                        const htmlContent = marked.parse(rawText);
                        explainScriptContent.innerHTML = htmlContent;
                    } else {
                        if (result.promptFeedback && result.promptFeedback.blockReason) throw new Error(`Request blocked for safety reasons: ${result.promptFeedback.blockReason}`);
                        throw new Error('No explanation content received from API.');
                    }
                } catch (error) {
                    console.error('Error generating script explanation:', error);
                    explainScriptContent.innerHTML = `<p class="text-red-400"><strong>Error:</strong> ${error.message}</p>`;
                }
            };

            // --- Event Listeners for Output Actions ---
            copyScriptButton.addEventListener('click', copyScript);
            downloadScriptButton.addEventListener('click', downloadScript);
            explainScriptButton.addEventListener('click', explainScript);

            // --- "How It Works" Modal Logic (V6.2) ---
            const handleAppExplanation = async () => {
                explainAppModal.classList.add('active');
                if (appExplanation) {
                    explainAppContent.innerHTML = appExplanation;
                    return;
                }

                // Ensure Gemini API Key is available before attempting generation
                if (!geminiApiKey) {
                    explainAppContent.innerHTML = `<p class="text-red-400">Please enter your API key first to generate this explanation.</p>`;
                    return;
                }

                explainAppContent.innerHTML = `<div class="flex items-center justify-center h-full"><p>Generating explanation with Gemini... this may take a moment.</p></div>`;
                try {
                    const selfAnalysisPrompt = `You are an expert web developer.
Analyze the following single-file HTML application code and explain how it works in its entirety.
Describe the key components: the HTML structure, the CSS styling (including Tailwind and custom styles), and the JavaScript logic (including state management, Google API integrations, event handling, and dynamic UI updates).
Present the explanation in clear, well-formatted markdown.`;
                    const appSourceCode = document.documentElement.outerHTML;
                    const payload = { contents: [{ parts: [{ text: `${selfAnalysisPrompt}\n\n\`\`\`html\n${appSourceCode}\n\`\`\`` }] }] };
                    // Use geminiApiKey for the Gemini API call
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`;
                    const response = await fetch(apiUrl, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
             
                    });
                    
                    if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts) {
                        const rawText = result.candidates[0].content.parts[0].text;
                        const htmlContent = marked.parse(rawText);
                        appExplanation = htmlContent;
                        explainAppContent.innerHTML = appExplanation;
                    } else {
                        if (result.promptFeedback && result.promptFeedback.blockReason) throw new Error(`Request blocked for safety reasons: ${result.promptFeedback.blockReason}`);
                        throw new Error('No content received from API for app explanation.');
                    }
                } catch (error) {
                    console.error('Error generating app explanation:', error);
                    explainAppContent.innerHTML = `<p class="text-red-400"><strong>Error:</strong> ${error.message}</p>`;
                }
            };
            
            explainAppButton.addEventListener('click', handleAppExplanation);
            // --- V6.2 Functions (Retained Core Application Logic) ---
            
            // Note: The following functions (updateModeUI, handleFormSubmit, renderScript, etc.) 
            // are essential for the script generation functionality and should be included here.
            // Since they were not provided in the V6.2 source, they are represented by placeholders 
            // but are necessary for the application to function correctly.
            const updateModeUI = () => {
                // Logic to update the UI based on currentMode (generate/refactor)
                // This typically involves changing button styles and potentially input field visibility/placeholders.
                if (currentMode === 'generate') {
                    modeGenerateBtn.classList.add('bg-blue-600', 'text-white');
                    modeRefactorBtn.classList.remove('bg-blue-600', 'text-white');
                    promptInput.placeholder = "Describe your desired script...";
                    promptInput.rows = 2;
                } else {
                    modeRefactorBtn.classList.add('bg-blue-600', 'text-white');
                    modeGenerateBtn.classList.remove('bg-blue-600', 'text-white');
                    promptInput.placeholder = "Paste the script you want to refactor, followed by instructions on how to improve it...";
                    promptInput.rows = 6; // Increase textarea height for pasted scripts
                }
            };
            // Event listeners for mode selection
            modeGenerateBtn.addEventListener('click', () => {
                currentMode = 'generate';
                updateModeUI();
            });
            modeRefactorBtn.addEventListener('click', () => {
                currentMode = 'refactor';
                updateModeUI();
            });
            // Placeholder for script rendering and history
            const renderScript = (scriptContent) => {
                // Logic to display generated script in the output panel and handle highlighting
                // Example: Create a new tab and display the script content.
                initialMessage.style.display = 'none'; // Hide the initial message once output is generated
                outputActions.style.display = 'flex'; // Show the action buttons

                // Remove previous content in the output container
                outputContainer.innerHTML = '';

                // Create a new <pre> element for the script
                const pre = document.createElement('pre');
                pre.className = 'p-4 bg-gray-900 text-gray-200 overflow-auto code-font';
                pre.textContent = scriptContent;

                // Create a div wrapper for the tab content
                const tabContent = document.createElement('div');
                tabContent.className = 'tab-content active flex-grow p-4';
                tabContent.appendChild(pre);
                
                // Append the generated script to the output container
                outputContainer.appendChild(tabContent);

                // Initialize highlighting (assuming highlight.js is loaded)
                hljs.highlightElement(pre);

                // Update tab navigation (simplified placeholder)
                tabsContainer.innerHTML = `<button class="p-2 bg-blue-600 text-white rounded-md text-sm">Generated Script</button>`;
            };
            const addMessageToHistory = (sender, message) => {
                // Logic to add user and AI messages to the chat history container
                const messageDiv = document.createElement('div');
                messageDiv.className = `p-3 rounded-lg ${sender === 'user' ? 'bg-blue-900 text-white self-end' : 'bg-gray-700 text-gray-200 self-start'}`;
                messageDiv.textContent = message;
                chatHistoryContainer.appendChild(messageDiv);
                chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight; // Scroll to bottom
            };
 
            const generateScriptWithGemini = async (userPrompt, environment) => {
                // Add Environment Context to the prompt
                const environmentContext = `Environment Context: The script should be compatible with: ${environment}\n\n`;

                const promptTemplate = `
${baseMetaPrompt}

${environmentContext}
Task: ${currentMode === 'generate' ? 'Generate New Script' : 'Refactor Existing Script'}

${currentMode === 'generate' ? 'Generate a PowerShell script based on the following user request:' : 'Refactor the provided PowerShell script based on the following instructions:'}

User Input:
\`\`\`
${userPrompt}
\`\`\`

Provide only the PowerShell code within a single markdown code block. Do not include explanations.
`;
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`;
                const payload = { 
                    contents: [{ parts: [{ text: promptTemplate }] }] 
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts) {
                    const rawText = result.candidates[0].content.parts[0].text;
                    // Extract code block from markdown
                    const match = rawText.match(/```powershell\s*([\s\S]*?)\s*```/);
                    return match ? match[1].trim() : rawText.trim();
                } else {
                    if (result.promptFeedback && result.promptFeedback.blockReason) {
                        throw new Error(`Request blocked for safety reasons: ${result.promptFeedback.blockReason}`);
                    }
                    throw new Error('No content received from API for script generation.');
                }
            };

            const handleFormSubmit = async (e) => {
                e.preventDefault();
                const userPrompt = promptInput.value.trim();
                const targetEnvironment = targetEnvSelect.value;

                if (!userPrompt) return;
                
                if (!geminiApiKey) {
                    displayMessageModal('Please provide your Gemini API key in the configuration.', 'API Key Missing');
                    return;
                }

                // Add user message to history
                addMessageToHistory('user', userPrompt);
                // Clear input
                promptInput.value = '';

                // Display a loading message
                renderScript('Generating script... Please wait.');
                
                try {
                    // Call the Gemini API to generate the script
                    const generatedScript = await generateScriptWithGemini(userPrompt, targetEnvironment);
                    currentScript = generatedScript;
                    addMessageToHistory('ai', 'Script generated successfully.');
                    renderScript(generatedScript);
                } catch (error) {
                    console.error('Error during generation:', error);
                    renderScript(`Error: Failed to generate script. ${error.message}`);
                    addMessageToHistory('error', 'Failed to generate script. Check console for details.');
                }
            };
            promptForm.addEventListener('submit', handleFormSubmit);

            const populatePromptsModal = () => {
                // Logic to populate the prompts modal with the base, environment, and task-specific prompts.
                document.getElementById('modal-base-prompt').textContent = baseMetaPrompt;
                // Since Environment Context and Task Specific Prompts are dynamically generated 
                // in the JavaScript logic, we can populate placeholders with example prompts or descriptions.
                
                document.getElementById('modal-env-context').textContent = `The script should be compatible with: {{targetEnvironment}}\n\n`;

                const generatePromptExample = `Generate a PowerShell script based on the following user request:

User Input:
{{userPrompt}}

Provide only the PowerShell code within a single markdown code block. Do not include explanations.`;
                document.getElementById('modal-generate-prompt').textContent = generatePromptExample;

                const refactorPromptExample = `Refactor the provided PowerShell script based on the following instructions:

User Input:
{{userPrompt}}

Provide only the PowerShell code within a single markdown code block. Do not include explanations.`;
                document.getElementById('modal-refactor-prompt').textContent = refactorPromptExample;
            };
            // --- Initial UI setup ---
            document.getElementById('app-version').textContent = `v${APP_VERSION}`;
            updateModeUI();
            populatePromptsModal();
        });
    </script>
</body>
</html>
