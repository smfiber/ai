<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerShell ScriptSmith AI</title>
    
    <script src="https://cdn.tailwindcss.com/"></script>
    <script>
      tailwind.config = { 
        theme: {
            extend: {
                keyframes: {
                    spin: {
                        '0%': { transform: 'rotate(0deg)' },
                        '100%': { transform: 'rotate(360deg)' },
                    },
                },
                animation: {
                    spin: 'spin 1s linear infinite',
                },
            }
        }
      }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.11/dist/purify.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/powershell.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        window.initializeApp = initializeApp;
    </script>
    <script type="module">
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        window.getAuth = getAuth;
        window.onAuthStateChanged = onAuthStateChanged;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.signOut = signOut;
    </script>
    <script type="module">
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, serverTimestamp, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.deleteDoc = deleteDoc;
        window.serverTimestamp = serverTimestamp;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .code-font { font-family: 'Fira Code', monospace; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .profile-dropdown { display: none; }
        .profile-dropdown.active { display: block; }
        .mode-btn-active { background-color: #2563eb; color: #ffffff; }
        .tab-btn { background-color: transparent; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #3b82f6; color: #ffffff; }
        .output-content { display: none; }
        .output-content.active { display: block; }
    </style>
</head>
<body class="text-gray-200">

    <div id="config-modal" class="modal active fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
            <h2 class="text-2xl font-bold text-white mb-4">Initial Configuration</h2>
            <p class="text-gray-400 mb-6">Provide your API keys to use the application. Firebase is now pre-configured.</p>
            <form id="config-form">
                <div>
                    <label for="gemini-key-input" class="block text-sm font-medium text-gray-300">Gemini API Key</label>
                    <input type="password" id="gemini-key-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-1" placeholder="Your Google AI API Key">
                </div>
                <div class="mt-4">
                    <label for="firebase-config-input" class="block text-sm font-medium text-gray-300">Firebase Config</label>
                    <textarea id="firebase-config-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-1 code-font" rows="6" placeholder="Enter your Firebase project configuration JSON here."></textarea>
                </div>
                <button type="submit" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200">Save and Initialize</button>
            </form>
        </div>
    </div>

    <div id="save-script-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold text-white mb-4">Save Script to Cloud</h2>
            <form id="save-script-form">
                <div>
                    <label for="script-name-input" class="block text-sm font-medium text-gray-300">Script Name</label>
                    <input type="text" id="script-name-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-1" placeholder="e.g., 'Get All AD Users'" required>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-save-script" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="load-script-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Load Script from Cloud</h2>
                <button id="close-load-script-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="saved-scripts-list" class="overflow-y-auto space-y-3 pr-2">
                <p class="text-gray-400">Loading scripts...</p>
            </div>
        </div>
    </div>

    <div id="view-prompts-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-3xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">System Prompts Viewer</h2>
                <button id="close-prompts-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="overflow-y-auto space-y-4 pr-2 text-sm">
                <div>
                    <h3 class="text-lg font-semibold text-blue-400 mb-2">Base Meta-Prompt</h3>
                    <pre id="base-prompt-content" class="bg-gray-900 p-3 rounded-md whitespace-pre-wrap code-font text-gray-300"></pre>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-blue-400 mb-2">Validation Meta-Prompt</h3>
                    <pre id="validation-prompt-content" class="bg-gray-900 p-3 rounded-md whitespace-pre-wrap code-font text-gray-300"></pre>
                </div>
                 <div>
                    <h3 class="text-lg font-semibold text-blue-400 mb-2">Environment Rules</h3>
                    <pre id="rules-content" class="bg-gray-900 p-3 rounded-md whitespace-pre-wrap code-font text-gray-300"></pre>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="flex flex-col h-screen">
        <header class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 p-4 flex items-center justify-between shadow-lg z-20">
            <div class="flex items-center space-x-3">
                <svg class="w-8 h-8 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m6.75 7.5 3 2.25-3 2.25m4.5 0h3m-9.75 6.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6.75a1.5 1.5 0 0 0-1.5-1.5H3.75a1.5 1.5 0 0 0-1.5 1.5v10.5a1.5 1.5 0 0 0 1.5 1.5Z" /></svg>
                <h1 class="text-xl font-bold text-white">PowerShell ScriptSmith AI <span id="app-version" class="text-xs font-mono text-blue-400/80 ml-2"></span></h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="load-from-cloud-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg text-sm" disabled>Load from Cloud</button>
                <button id="view-prompts-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg text-sm">View Prompts</button>
                <div id="auth-container" class="relative">
                    <button id="auth-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Login with Google</button>
                    <div id="user-profile-area" class="hidden items-center space-x-3 cursor-pointer">
                        <img id="user-photo" class="w-10 h-10 rounded-full" src="" alt="User Photo">
                        <span id="user-name" class="font-semibold"></span>
                    </div>
                    <div id="profile-dropdown-menu" class="profile-dropdown absolute right-0 mt-2 w-48 bg-gray-700 rounded-md shadow-lg z-30">
                        <button id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow flex flex-col md:flex-row overflow-hidden">
            <div class="w-full md:w-1/3 flex flex-col bg-gray-900 border-r border-gray-700">
                <div class="p-4 border-b border-gray-700 space-y-4">
                    <div>
                        <label class="text-lg font-semibold">Mode</label>
                        <div class="mt-2 flex bg-gray-800 rounded-lg p-1">
                            <button id="mode-generate" class="mode-btn w-full py-2 text-sm font-medium rounded-md">Generate New</button>
                            <button id="mode-refactor" class="mode-btn w-full py-2 text-sm font-medium rounded-md">Refactor Existing</button>
                        </div>
                    </div>
                    <div>
                        <label for="target-env" class="text-lg font-semibold">Target Environment</label>
                        <select id="target-env" class="mt-2 w-full p-2 bg-gray-800 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option>Active Directory</option>
                            <option>Azure (Az Module)</option>
                            <option>MS Graph (SDK)</option>
                            <option>MS365 / Entra ID</option>
                            <option>MS365 / Exchange Online</option>
                            <option>MS365 / SharePoint PnP</option>
                            <option>MS365 / Teams</option>
                            <option>PowerCLI (VMware)</option>
                            <option>Windows Desktop (10/11)</option>
                            <option>Windows Server</option>
                        </select>
                    </div>
                </div>
                <div id="chat-history" class="flex-grow p-4 overflow-y-auto space-y-4"></div>
                <div class="p-4 border-t border-gray-700 bg-gray-900">
                    <form id="prompt-form" class="flex items-center space-x-2">
                        <textarea id="prompt-input" placeholder="Enter your script request..." class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
                        <button type="submit" id="submit-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-lg flex-shrink-0 self-end">
                            <svg id="submit-icon" class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.105 2.289a.75.75 0 0 0-.826.95l1.414 4.925A1.5 1.5 0 0 0 5.135 9.25h6.115a.75.75 0 0 1 0 1.5H5.135a1.5 1.5 0 0 0-1.442 1.086L2.279 16.76a.75.75 0 0 0 .95.826l16-5.333a.75.75 0 0 0 0-1.418l-16-5.333Z" /></svg>
                            <svg id="loading-spinner" class="w-6 h-6 animate-spin hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </button>
                    </form>
                </div>
            </div>

            <div id="output-panel" class="w-full md:w-2/3 flex flex-col bg-gray-800/50 overflow-y-auto relative">
                 <div class="border-b border-gray-700 sticky top-0 bg-gray-800/80 backdrop-blur-sm z-10">
                   <nav id="tabs" class="flex space-x-1 p-2 px-4"></nav>
                   <div id="output-actions" class="p-2 flex justify-end space-x-2 border-t border-gray-700 hidden">
                        <button id="copy-script-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-1 px-3 rounded-md text-sm">Copy</button>
                        <button id="download-script-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-1 px-3 rounded-md text-sm">Download</button>
                        <button id="save-to-cloud-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-1 px-3 rounded-md text-sm" disabled>Save to Cloud</button>
                        <button id="save-to-drive-button" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-1 px-3 rounded-md text-sm" title="Google Drive integration coming soon" disabled>Save to Drive</button>
                        <button id="explain-script-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded-md text-sm">Explain</button>
                   </div>
                </div>
                <div id="output-container" class="flex-grow relative p-4">
                    <div id="initial-message" class="flex flex-col items-center justify-center h-full text-center text-gray-500 p-6">
                        <svg class="w-16 h-16 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m6.75 7.5 3 2.25-3 2.25m4.5 0h3m-9.75 6.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6.75a1.5 1.5 0 0 0-1.5-1.5H3.75a1.5 1.5 0 0 0-1.5 1.5v10.5a1.5 1.5 0 0 0 1.5 1.5Z" /></svg>
                        <h3 class="text-xl font-semibold text-gray-400">Your generated script will appear here</h3>
                        <p class="mt-2 max-w-md">Login to save and load scripts from the cloud.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            const appState = {
                version: '8.1.0',
                geminiApiKey: null,
                firebaseConfig: null,
                currentMode: 'generate', // 'generate' or 'refactor'
                currentScript: '',
                currentTabs: {}, // To hold content for tabs
                db: null,
                auth: null,
                user: null,
            };

            // --- Element References ---
            const configModal = document.getElementById('config-modal');
            const configForm = document.getElementById('config-form');
            const geminiKeyInput = document.getElementById('gemini-key-input');
            const firebaseConfigInput = document.getElementById('firebase-config-input');
            const authContainer = document.getElementById('auth-container');
            const authButton = document.getElementById('auth-button');
            const userProfileArea = document.getElementById('user-profile-area');
            const userPhoto = document.getElementById('user-photo');
            const userName = document.getElementById('user-name');
            const profileDropdownMenu = document.getElementById('profile-dropdown-menu');
            const logoutButton = document.getElementById('logout-button');
            const saveToCloudButton = document.getElementById('save-to-cloud-button');
            const loadFromCloudButton = document.getElementById('load-from-cloud-button');
            const saveScriptModal = document.getElementById('save-script-modal');
            const saveScriptForm = document.getElementById('save-script-form');
            const scriptNameInput = document.getElementById('script-name-input');
            const cancelSaveScript = document.getElementById('cancel-save-script');
            const loadScriptModal = document.getElementById('load-script-modal');
            const closeLoadScriptModal = document.getElementById('close-load-script-modal');
            const savedScriptsList = document.getElementById('saved-scripts-list');
            const promptInput = document.getElementById('prompt-input');
            const targetEnvSelect = document.getElementById('target-env');
            const chatHistoryContainer = document.getElementById('chat-history');
            const modeGenerateBtn = document.getElementById('mode-generate');
            const modeRefactorBtn = document.getElementById('mode-refactor');
            const outputActions = document.getElementById('output-actions');
            const outputContainer = document.getElementById('output-container');
            const initialMessage = document.getElementById('initial-message');
            const promptForm = document.getElementById('prompt-form');
            const submitButton = document.getElementById('submit-button');
            const submitIcon = document.getElementById('submit-icon');
            const loadingSpinner = document.getElementById('loading-spinner');
            const viewPromptsBtn = document.getElementById('view-prompts-button');
            const promptsModal = document.getElementById('view-prompts-modal');
            const closePromptsModal = document.getElementById('close-prompts-modal');
            const tabsContainer = document.getElementById('tabs');

            // --- Prompts & Rules ---
            const baseMetaPrompt = `You are an expert PowerShell scripting assistant. Your goal is to generate a robust, clean, and efficient PowerShell script based on the user's request.
- The script MUST be fully functional and stand-alone.
- The script MUST follow PowerShell best practices.
- Use full cmdlet names, not aliases.
- Use clear variable names.
- Add comments where the logic is complex.
- The script MUST start with a comment block containing a title, a brief description of what it does, and the target environment.
- Format the final output inside a single \`\`\`powershell code block. Do not include any other explanatory text outside of the code block.`;
            const environmentRules = {
                'Active Directory': `- **Module:** ActiveDirectory. Assumes the module is installed and the user is running the script from a domain-joined machine with the necessary permissions.`,
                'Azure (Az Module)': `- **Module:** The 'Az' module (e.g., Az.Accounts, Az.Resources). - **Authentication:** MUST include \`Connect-AzAccount\` for login.`,
                'MS Graph (SDK)': `- **Module:** Microsoft.Graph. - **Authentication:** MUST include \`Connect-MgGraph\`. Specify required permissions in the -Scopes parameter.`,
                'MS365 / Entra ID': `- **Module:** Microsoft.Graph. - **Note:** DO NOT use 'MSOnline' or 'AzureAD' as they are being deprecated. Use the Microsoft Graph SDK.`,
                'MS365 / Exchange Online': `- **Module:** ExchangeOnlineManagement. - **Authentication:** MUST include \`Connect-ExchangeOnline\`.`,
                'MS365 / SharePoint PnP': `- **Module:** PnP.PowerShell. - **Authentication:** MUST include \`Connect-PnPOnline -Url <YourSharePointSite> -Interactive\`.`,
                'MS365 / Teams': `- **Module:** MicrosoftTeams. - **Authentication:** MUST include \`Connect-MicrosoftTeams\`.`,
                'PowerCLI (VMware)': `- **Module:** VMware.PowerCLI. - **Authentication:** MUST include \`Connect-VIServer -Server <YourVCenterServer>\`.`,
                'Windows Desktop (10/11)': `- **Environment:** General Windows 10/11. - **Forbidden Cmdlets:** DO NOT use server-only cmdlets like \`Get-WindowsFeature\`.`,
                'Windows Server': `- **Environment:** General Windows Server. - **Key Cmdlets:** Can use server-specific cmdlets like \`Get-WindowsFeature\` for roles/features.`,
            };
            const validationMetaPrompt = `You are an expert PowerShell script validator. Your task is to analyze the provided script and refine it based on the specified environment rules.
- **Goal:** Ensure the script is correct, follows best practices, and adheres strictly to the environment rules.
- **Action:** Review the script against the rules. If it's valid, return it as is. If it has errors (e.g., uses wrong cmdlets, misses an authentication step), fix them and return the corrected script.
- **Output:** The response MUST ONLY contain the final, corrected PowerShell script inside a single \`\`\`powershell code block. Do not add any extra text or explanation.`;

            // --- UI & State Functions ---
            const setLoadingState = (isLoading) => {
                if (isLoading) {
                    submitIcon.classList.add('hidden');
                    loadingSpinner.classList.remove('hidden');
                    submitButton.disabled = true;
                } else {
                    submitIcon.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                    submitButton.disabled = false;
                }
            };
            
            const displayMessage = (message, title = "Error") => {
                alert(`[${title}] ${message}`); // Simple alert for now
            };

            const updateModeButtons = () => {
                if (appState.currentMode === 'generate') {
                    modeGenerateBtn.classList.add('mode-btn-active');
                    modeRefactorBtn.classList.remove('mode-btn-active');
                    promptInput.placeholder = "Enter your script request... (e.g., 'get all enabled AD users')";
                } else {
                    modeRefactorBtn.classList.add('mode-btn-active');
                    modeGenerateBtn.classList.remove('mode-btn-active');
                    promptInput.placeholder = "Describe the changes you want, then paste the existing script below your instructions.";
                }
            };

            // --- API & Core Functions ---
            async function callGeminiAPI(prompt) {
                if (!appState.geminiApiKey) throw new Error("Gemini API key is not configured.");
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${appState.geminiApiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
                const result = await response.json();
                if (result.promptFeedback && result.promptFeedback.blockReason) throw new Error(`Request blocked: ${result.promptFeedback.blockReason}`);
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts) {
                    return result.candidates[0].content.parts[0].text || '';
                } else {
                    console.warn("API returned no valid content.", result);
                    return '';
                }
            }
            
            // --- Firebase & Auth ---
            function initializeFirebase(config) {
                try {
                    const app = window.initializeApp(config);
                    appState.auth = window.getAuth(app);
                    appState.db = window.getFirestore(app);
                    setupAuthObserver();
                    console.log("Firebase Initialized.");
                } catch (error) {
                    console.error("Firebase Init Error:", error);
                    displayMessage("Failed to initialize Firebase. Check your configuration.", "Error");
                }
            }

            function setupAuthObserver() {
                window.onAuthStateChanged(appState.auth, user => {
                    if (user) {
                        appState.user = user;
                        userProfileArea.classList.remove('hidden');
                        userProfileArea.classList.add('flex');
                        authButton.classList.add('hidden');
                        userPhoto.src = user.photoURL;
                        userName.textContent = user.displayName;
                        saveToCloudButton.disabled = false;
                        loadFromCloudButton.disabled = false;
                    } else {
                        appState.user = null;
                        userProfileArea.add('hidden');
                        userProfileArea.classList.remove('flex');
                        authButton.classList.remove('hidden');
                        saveToCloudButton.disabled = true;
                        loadFromCloudButton.disabled = true;
                        profileDropdownMenu.classList.remove('active');
                    }
                });
            }

            async function signInWithGoogle() {
                const provider = new window.GoogleAuthProvider();
                try {
                    await window.signInWithPopup(appState.auth, provider);
                } catch (error) {
                    console.error("Google Sign-In Error:", error);
                    displayMessage(`Could not sign in: ${error.message}`);
                }
            }

            async function signOutUser() {
                try {
                    await window.signOut(appState.auth);
                } catch (error) {
                    console.error("Sign Out Error:", error);
                }
            }
            
            // --- Firestore Functions ---
            async function saveScriptToFirestore(name, content, environment) {
                if (!appState.user) {
                    displayMessage("You must be logged in to save scripts.");
                    return;
                }
                try {
                    await window.addDoc(window.collection(appState.db, 'scripts'), {
                        uid: appState.user.uid,
                        name: name,
                        content: content,
                        environment: environment,
                        createdAt: window.serverTimestamp()
                    });
                    displayMessage("Script saved successfully!", "Success");
                    saveScriptModal.classList.remove('active');
                } catch (error) {
                    console.error("Error saving script:", error);
                    displayMessage(`Failed to save script: ${error.message}`);
                }
            }

            async function loadScriptsFromFirestore() {
                if (!appState.user) {
                    displayMessage("You must be logged in to load scripts.");
                    return;
                }
                loadScriptModal.classList.add('active');
                savedScriptsList.innerHTML = '<p class="text-gray-400">Loading scripts...</p>';
                try {
                    const q = window.query(
                        window.collection(appState.db, "scripts"),
                        window.where("uid", "==", appState.user.uid),
                        window.orderBy("createdAt", "desc")
                    );
                    const querySnapshot = await window.getDocs(q);
                    if (querySnapshot.empty) {
                        savedScriptsList.innerHTML = '<p class="text-gray-400">No saved scripts found.</p>';
                        return;
                    }
                    savedScriptsList.innerHTML = '';
                    querySnapshot.forEach(doc => {
                        const script = doc.data();
                        const scriptEl = document.createElement('div');
                        scriptEl.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                        scriptEl.innerHTML = `
                            <div>
                                <h4 class="font-bold text-white">${script.name}</h4>
                                <p class="text-sm text-gray-400">${script.environment}</p>
                            </div>
                            <div>
                                <button data-id="${doc.id}" class="load-btn bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded-md text-sm">Load</button>
                                <button data-id="${doc.id}" class="delete-btn bg-red-600 hover:bg-red-700 text-white py-1 px-3 rounded-md text-sm ml-2">Delete</button>
                            </div>
                        `;
                        scriptEl.dataset.content = script.content;
                        scriptEl.dataset.env = script.environment;
                        savedScriptsList.appendChild(scriptEl);
                    });
                } catch (error) {
                    console.error("Error loading scripts:", error);
                    savedScriptsList.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
                }
            }
            
            async function deleteScriptFromFirestore(id) {
                if (!confirm("Are you sure you want to delete this script?")) return;
                try {
                    await window.deleteDoc(window.doc(appState.db, 'scripts', id));
                    displayMessage("Script deleted successfully.", "Success");
                    loadScriptsFromFirestore(); // Refresh list
                } catch (error) {
                    console.error("Error deleting script:", error);
                    displayMessage(`Failed to delete script: ${error.message}`);
                }
            }

            // --- Script Generation & Display Logic ---
            const setActiveTab = (tabId) => {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.output-content').forEach(content => content.classList.remove('active'));

                const tabButton = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
                const tabContent = document.getElementById(tabId);

                if (tabButton) tabButton.classList.add('active');
                if (tabContent) tabContent.classList.add('active');
            };

            const createTab = (tabId, title, isActive = false) => {
                const existingTab = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
                if (existingTab) return; // Don't create if it exists

                const button = document.createElement('button');
                button.className = `tab-btn text-gray-400 hover:text-white px-3 py-2 text-sm font-medium ${isActive ? 'active' : ''}`;
                button.dataset.tab = tabId;
                button.textContent = title;
                tabsContainer.appendChild(button);
            };

            const renderContent = (tabId, title, content, isHtml = false) => {
                initialMessage.classList.add('hidden');
                outputActions.classList.remove('hidden');

                // Clear existing content for this tab if it exists
                const existingContent = document.getElementById(tabId);
                if (existingContent) existingContent.remove();

                createTab(tabId, title);

                const contentWrapper = document.createElement('div');
                contentWrapper.id = tabId;
                contentWrapper.className = 'output-content p-4';
                
                if (isHtml) {
                    const sanitized = DOMPurify.sanitize(marked.parse(content));
                    contentWrapper.innerHTML = `<div class="prose prose-invert max-w-none">${sanitized}</div>`;
                } else {
                    const pre = document.createElement('pre');
                    const code = document.createElement('code');
                    code.className = 'language-powershell';
                    code.textContent = content;
                    pre.appendChild(code);
                    contentWrapper.appendChild(pre);
                    hljs.highlightElement(code);
                }
                outputContainer.appendChild(contentWrapper);
                setActiveTab(tabId);
            };

            const addMessageToHistory = (sender, message) => {
                const msgDiv = document.createElement('div');
                const cleanMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                if (sender === 'user') {
                    msgDiv.className = 'bg-gray-800 p-3 rounded-lg self-end';
                    msgDiv.innerHTML = `<p class="text-white">${cleanMessage}</p>`;
                } else {
                    msgDiv.className = 'bg-blue-900/50 p-3 rounded-lg self-start';
                    msgDiv.innerHTML = `<p class="text-blue-200">${cleanMessage}</p>`;
                }
                chatHistoryContainer.appendChild(msgDiv);
                chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
            };

            const handleFormSubmit = async (e) => {
                e.preventDefault();
                const userPrompt = promptInput.value.trim();
                const targetEnvironment = targetEnvSelect.value;
                if (!userPrompt) return;

                addMessageToHistory('user', userPrompt);
                promptInput.value = '';
                setLoadingState(true);

                // Clear previous output
                tabsContainer.innerHTML = '';
                outputContainer.innerHTML = '';
                initialMessage.classList.remove('hidden');
                outputActions.classList.add('hidden');

                addMessageToHistory('ai', 'Generating script...');

                try {
                    const rules = environmentRules[targetEnvironment];
                    const promptBuilder = {
                        'generate': `${baseMetaPrompt}\n\n**ENVIRONMENT RULES:**\n${rules}\n\n**TASK:**\nGenerate a script for the following request:\n\`\`\`\n${userPrompt}\n\`\`\``,
                        'refactor': `${baseMetaPrompt}\n\n**ENVIRONMENT RULES:**\n${rules}\n\n**TASK:**\nRefactor the following script based on the user's instructions.\n\n**USER'S INSTRUCTIONS AND SCRIPT:**\n\`\`\`\n${userPrompt}\n\`\`\``
                    };
                    const finalPrompt = promptBuilder[appState.currentMode];
                    
                    const generatedScript = await callGeminiAPI(finalPrompt);
                    addMessageToHistory('ai', 'Initial script generated. Now validating...');
                    
                    const validationPrompt = `${validationMetaPrompt}\n\n**ENVIRONMENT RULES:**\n${rules}\n\n**SCRIPT TO VALIDATE:**\n${generatedScript}`;
                    const refinedScript = await callGeminiAPI(validationPrompt);
                    
                    if (typeof refinedScript !== 'string') {
                        throw new Error("The validation service returned an invalid response.");
                    }

                    const finalCode = refinedScript.match(/```powershell\s*([\s\S]*?)\s*```/)?.[1] || refinedScript;
                    
                    appState.currentScript = finalCode;
                    appState.currentTabs['script-content'] = finalCode;
                    addMessageToHistory('ai', 'Script validated and refined successfully.');
                    renderContent('script-content', 'Script', finalCode);

                } catch (error) {
                    console.error("Error during script generation:", error);
                    addMessageToHistory('ai', `**Error:** ${error.message}`);
                    displayMessage(error.message, "Generation Error");
                } finally {
                    setLoadingState(false);
                }
            };
            
            // --- Event Listeners ---
            configForm.addEventListener('submit', (e) => {
                e.preventDefault();
                appState.geminiApiKey = geminiKeyInput.value.trim();
                try {
                    const configText = firebaseConfigInput.value.trim();
                    if (!appState.geminiApiKey || !configText) {
                        displayMessage("Please fill out all fields.", "Validation Error");
                        return;
                    }
                    appState.firebaseConfig = JSON.parse(configText);
                    initializeFirebase(appState.firebaseConfig);
                    configModal.classList.remove('active');
                } catch (error) {
                    displayMessage("Firebase config is not valid JSON.", "Error");
                }
            });
            
            authButton.addEventListener('click', signInWithGoogle);
            logoutButton.addEventListener('click', signOutUser);
            userProfileArea.addEventListener('click', () => profileDropdownMenu.classList.toggle('active'));
            
            modeGenerateBtn.addEventListener('click', () => {
                appState.currentMode = 'generate';
                updateModeButtons();
            });
            modeRefactorBtn.addEventListener('click', () => {
                appState.currentMode = 'refactor';
                updateModeButtons();
            });

            saveToCloudButton.addEventListener('click', () => {
                if (!appState.currentScript) {
                    displayMessage("No script to save.", "Info");
                    return;
                }
                saveScriptModal.classList.add('active');
                scriptNameInput.value = '';
                scriptNameInput.focus();
            });
            cancelSaveScript.addEventListener('click', () => saveScriptModal.classList.remove('active'));
            saveScriptForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const scriptName = scriptNameInput.value.trim();
                saveScriptToFirestore(scriptName, appState.currentScript, targetEnvSelect.value);
            });

            loadFromCloudButton.addEventListener('click', loadScriptsFromFirestore);
            closeLoadScriptModal.addEventListener('click', () => loadScriptModal.classList.remove('active'));
            savedScriptsList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('load-btn')) {
                    const parent = e.target.closest('.bg-gray-700');
                    const scriptContent = parent.dataset.content;
                    const scriptEnv = parent.dataset.env;
                    
                    appState.currentScript = scriptContent;
                    appState.currentTabs = { 'script-content': scriptContent };
                    targetEnvSelect.value = scriptEnv;

                    tabsContainer.innerHTML = '';
                    outputContainer.innerHTML = '';
                    renderContent('script-content', 'Script', scriptContent);
                    loadScriptModal.classList.remove('active');
                    addMessageToHistory('ai', 'Script loaded from cloud.');
                }
                if (e.target.classList.contains('delete-btn')) {
                    const id = e.target.dataset.id;
                    deleteScriptFromFirestore(id);
                }
            });

            viewPromptsBtn.addEventListener('click', () => {
                document.getElementById('base-prompt-content').textContent = baseMetaPrompt;
                document.getElementById('validation-prompt-content').textContent = validationMetaPrompt;
                document.getElementById('rules-content').textContent = JSON.stringify(environmentRules, null, 2);
                promptsModal.classList.add('active');
            });
            closePromptsModal.addEventListener('click', () => promptsModal.classList.remove('active'));

            tabsContainer.addEventListener('click', (e) => {
                if(e.target.classList.contains('tab-btn')) {
                    setActiveTab(e.target.dataset.tab);
                }
            });

            outputActions.addEventListener('click', async (e) => {
                const activeContent = appState.currentTabs[document.querySelector('.output-content.active')?.id];
                if (!activeContent) return;

                if (e.target.id === 'copy-script-button') {
                    navigator.clipboard.writeText(activeContent).then(() => displayMessage("Copied to clipboard!", "Success"));
                }
                if (e.target.id === 'download-script-button') {
                    const blob = new Blob([activeContent], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'script.ps1';
                    a.click();
                    URL.revokeObjectURL(url);
                }
                if (e.target.id === 'explain-script-button') {
                    setLoadingState(true);
                    try {
                        addMessageToHistory('ai', 'Generating explanation...');
                        const explainPrompt = `Explain the following PowerShell script in a clear, concise way. Describe its purpose, how it works, and any important cmdlets it uses. Format the output as Markdown.\n\n\`\`\`powershell\n${appState.currentScript}\n\`\`\``;
                        const explanation = await callGeminiAPI(explainPrompt);
                        appState.currentTabs['explanation-content'] = explanation;
                        renderContent('explanation-content', 'Explanation', explanation, true);
                    } catch(error) {
                        displayMessage(`Explanation failed: ${error.message}`);
                    } finally {
                        setLoadingState(false);
                    }
                }
            });

            promptForm.addEventListener('submit', handleFormSubmit);

            // --- Initial UI Setup ---
            document.getElementById('app-version').textContent = `v${appState.version}`;
            updateModeButtons();
        });
    </script>
</body>
</html>
