<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerShell ScriptSmith AI</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/powershell.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/markdown.min.js"></script>

    <!-- Google Fonts: Inter for UI, Fira Code for code -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        .code-font {
            font-family: 'Fira Code', monospace;
        }
        #output-panel .tab-content {
            display: none;
        }
        #output-panel .tab-content.active {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        #output-panel pre {
            flex-grow: 1;
            margin: 0;
        }
        .modal {
            display: flex;
        }
    </style>
</head>
<body class="text-gray-200">

    <!-- API Key Modal -->
    <div id="api-key-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold text-white mb-4">Enter Gemini API Key</h2>
            <p class="text-gray-400 mb-6">Please provide your Gemini API key to use the application. Your key is not stored.</p>
            <form id="api-key-form">
                <input type="password" id="api-key-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-500" placeholder="Your Gemini API Key">
                <button type="submit" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200">Save and Continue</button>
            </form>
        </div>
    </div>

    <div id="app" class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 p-4 flex items-center justify-between shadow-lg z-20">
            <div class="flex items-center space-x-3">
                <svg class="w-8 h-8 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 13.5h3.86a2.25 2.25 0 0 1 2.012 1.244l.256.512a2.25 2.25 0 0 0 2.013 1.244h3.218a2.25 2.25 0 0 0 2.013-1.244l.256-.512a2.25 2.25 0 0 1 2.013-1.244h3.859m-19.5.338V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 0 0-2.12-1.588H6.88a2.25 2.25 0 0 0-2.12 1.588L2.35 13.177a2.25 2.25 0 0 0-.1.661Z" /></svg>
                <h1 class="text-xl font-bold text-white">PowerShell ScriptSmith AI</h1>
            </div>
            <div>
                <button id="auth-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>Login with Google</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow flex flex-col md:flex-row overflow-hidden">
            <div class="w-full md:w-1/3 flex flex-col bg-gray-900 border-r border-gray-700">
                 <div class="p-4 border-b border-gray-700 space-y-4">
                    <div>
                        <label class="text-lg font-semibold">Mode</label>
                        <div class="mt-2 flex bg-gray-800 rounded-lg p-1">
                            <button id="mode-generate" class="w-full py-2 text-sm font-medium rounded-md">Generate New</button>
                            <button id="mode-refactor" class="w-full py-2 text-sm font-medium rounded-md">Refactor Existing</button>
                        </div>
                    </div>
                    <div>
                        <label for="target-env" class="text-lg font-semibold">Target Environment</label>
                        <select id="target-env" class="mt-2 w-full p-2 bg-gray-800 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option>PowerShell 7 (Cross-Platform)</option><option>Windows PowerShell 5.1</option><option>Azure Automation</option><option>Windows Server 2022</option><option>Windows Server 2019</option>
                        </select>
                    </div>
                </div>
                <div id="chat-history" class="flex-grow p-4 overflow-y-auto space-y-4"></div>
                <div class="p-4 border-t border-gray-700 bg-gray-900">
                    <form id="prompt-form" class="flex items-center space-x-2">
                        <textarea id="prompt-input" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-500" rows="2"></textarea>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-lg transition-colors duration-200 flex-shrink-0 self-end">
                            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.105 2.289a.75.75 0 0 0-.826.95l1.414 4.925A1.5 1.5 0 0 0 5.135 9.25h6.115a.75.75 0 0 1 0 1.5H5.135a1.5 1.5 0 0 0-1.442 1.086L2.279 16.76a.75.75 0 0 0 .95.826l16-5.333a.75.75 0 0 0 0-1.418l-16-5.333Z" /></svg>
                        </button>
                    </form>
                </div>
            </div>

            <div id="output-panel" class="w-full md:w-2/3 flex flex-col bg-gray-800/50 overflow-y-auto relative">
                <div class="border-b border-gray-700 sticky top-0 bg-gray-800/80 backdrop-blur-sm z-10">
                    <nav id="tabs" class="flex space-x-1 p-1"></nav>
                </div>
                <div id="output-container" class="flex-grow relative">
                    <div id="initial-message" class="flex flex-col items-center justify-center h-full text-center text-gray-500 p-6">
                        <svg class="w-16 h-16 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m6.75 7.5 3 2.25-3 2.25m4.5 0h3m-9.75 6.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6.75a1.5 1.5 0 0 0-1.5-1.5H3.75a1.5 1.5 0 0 0-1.5 1.5v10.5a1.5 1.5 0 0 0 1.5 1.5Z" /></svg>
                        <h3 class="text-xl font-semibold text-gray-400">Your generated script will appear here</h3>
                        <p class="mt-2 max-w-md">Select a mode, describe your needs or paste a script, and send.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Google API & Identity Services Scripts -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        // --- Global Scope for Google API Callbacks ---
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        
        // IMPORTANT: Replace with your own Google Cloud project's credentials
        const GOOGLE_API_KEY = 'YOUR_GOOGLE_API_KEY'; // For Google Drive API
        const GOOGLE_CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: GOOGLE_API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            });
            gapiInited = true;
            maybeEnableAuthButton();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    // This callback now handles the token response
                     if (tokenResponse && tokenResponse.access_token) {
                        const authButton = document.getElementById('auth-button');
                        authButton.textContent = 'Logout';
                        // The token is now managed by gapi.client, no need to set it manually here.
                    }
                },
            });
            gisInited = true;
            maybeEnableAuthButton();
        }

        function maybeEnableAuthButton() {
            const authButton = document.getElementById('auth-button');
            if (gapiInited && gisInited && authButton) {
                authButton.disabled = false;
            }
        }

        // --- Main App Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element References ---
            const apiKeyModal = document.getElementById('api-key-modal');
            const apiKeyForm = document.getElementById('api-key-form');
            const apiKeyInput = document.getElementById('api-key-input');
            const authButton = document.getElementById('auth-button');
            const promptForm = document.getElementById('prompt-form');
            const promptInput = document.getElementById('prompt-input');
            const outputContainer = document.getElementById('output-container');
            const chatHistoryContainer = document.getElementById('chat-history');
            const modeGenerateBtn = document.getElementById('mode-generate');
            const modeRefactorBtn = document.getElementById('mode-refactor');
            const targetEnvSelect = document.getElementById('target-env');
            const tabsContainer = document.getElementById('tabs');
            const initialMessage = document.getElementById('initial-message');
            
            // --- State Variables ---
            let geminiApiKey = '';
            let conversationHistory = [];
            let currentScript = '';
            let currentMode = 'generate';
            const FOLDER_NAME = 'PowerShell Scriptsmith AI';

            const baseMetaPrompt = `You are an expert PowerShell scripting assistant...`; // Same as previous version

            // --- API Key Modal Logic ---
            apiKeyForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const key = apiKeyInput.value.trim();
                if (key) {
                    geminiApiKey = key;
                    apiKeyModal.style.display = 'none';
                } else {
                    alert('Please enter a valid API key.');
                }
            });

            // --- Google Auth Button Logic ---
            authButton.addEventListener('click', () => {
                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    gapi.client.setToken(null);
                    authButton.textContent = 'Login with Google';
                }
                updateActionButtons();
            });

            const updateModeUI = () => {
                if (currentMode === 'generate') {
                    modeGenerateBtn.classList.add('bg-blue-600', 'text-white');
                    modeGenerateBtn.classList.remove('bg-gray-800', 'text-gray-300');
                    modeRefactorBtn.classList.remove('bg-blue-600', 'text-white');
                    modeRefactorBtn.classList.add('bg-gray-800', 'text-gray-300');
                    promptInput.placeholder = 'Describe the script you want to create...';
                } else {
                    modeRefactorBtn.classList.add('bg-blue-600', 'text-white');
                    modeRefactorBtn.classList.remove('bg-gray-800', 'text-gray-300');
                    modeGenerateBtn.classList.remove('bg-blue-600', 'text-white');
                    modeGenerateBtn.classList.add('bg-gray-800', 'text-gray-300');
                    promptInput.placeholder = 'Paste your existing PowerShell script here to refactor it...';
                }
            };
            
            modeGenerateBtn.addEventListener('click', () => { currentMode = 'generate'; updateModeUI(); });
            modeRefactorBtn.addEventListener('click', () => { currentMode = 'refactor'; updateModeUI(); });
            
            const handleFormSubmit = async (userPrompt, requestType = 'script') => {
                if (!geminiApiKey) {
                    alert('Please set your Gemini API key first.');
                    apiKeyModal.style.display = 'flex';
                    return;
                }
                if (!userPrompt) return;

                if (requestType === 'script') {
                    addMessageToChat('user', userPrompt);
                    promptInput.value = '';
                    promptInput.style.height = 'auto';
                }

                setLoadingState(true, requestType);

                try {
                    let finalMetaPrompt;
                    const targetEnvironment = targetEnvSelect.value;
                    const envContext = `The script MUST be compatible with the following target environment: **${targetEnvironment}**. Pay close attention to cmdlet availability and syntax for this version. For example, prefer Get-CimInstance over Get-WmiObject for modern Windows environments, but use Get-WmiObject if targeting PowerShell 5.1 or older servers.`;

                    // [The switch statement for finalMetaPrompt remains the same as previous version]
                    switch (requestType) {
                        case 'explanation':
                            finalMetaPrompt = `Please explain the following PowerShell script... The script is:\n\n\`\`\`powershell\n${userPrompt}\n\`\`\``;
                            break;
                        case 'pester':
                            finalMetaPrompt = `You are a Pester test generation expert... The script to test is:\n\n\`\`\`powershell\n${userPrompt}\n\`\`\``;
                            break;
                        default: // 'script'
                             if (currentMode === 'generate') {
                                finalMetaPrompt = `Your task is to generate a new PowerShell script. ${envContext}\n\n${baseMetaPrompt}\n\nUser Request: "${userPrompt}"`;
                            } else { // refactor mode
                                finalMetaPrompt = `Your task is to refactor an existing PowerShell script. ${envContext}\n\n${baseMetaPrompt}\n\nThe user's script is:\n\n\`\`\`powershell\n${userPrompt}\n\`\`\``;
                            }
                    }

                    conversationHistory.push({ role: "user", parts: [{ text: finalMetaPrompt }] });
                    const payload = { contents: conversationHistory };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0) {
                        const rawText = result.candidates[0].content.parts[0].text;
                        conversationHistory.push({ role: "model", parts: [{ text: rawText }] });
                        
                        switch (requestType) {
                            case 'explanation': renderExplanation(rawText); break;
                            case 'pester': renderPester(rawText); break;
                            default: renderScript(rawText); break;
                        }
                    } else {
                        throw new Error('No content received from API.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    renderError(error.message);
                } finally {
                    setLoadingState(false);
                }
            };
            
            promptForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleFormSubmit(promptInput.value.trim(), 'script');
            });
            
            const renderScript = (rawText) => {
                if(initialMessage) initialMessage.style.display = 'none';
                if (tabsContainer.innerHTML === '') setupTabs();

                const scriptContent = document.getElementById('script-content');
                const htmlContent = marked.parse(rawText);
                currentScript = rawText.replace(/```powershell\n|```/g, '').trim();

                scriptContent.innerHTML = `
                    <div id="script-actions" class="absolute top-14 right-4 flex space-x-2 z-10">
                        <button id="save-drive-button" class="hidden bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 items-center text-sm">Save to Drive</button>
                        <button id="explain-button" class="bg-gray-700 hover:bg-gray-600 text-gray-300 font-semibold py-2 px-4 rounded-lg transition-colors duration-200 flex items-center text-sm">Explain</button>
                        <button id="copy-button" class="bg-gray-700 hover:bg-gray-600 text-gray-300 font-semibold py-2 px-4 rounded-lg transition-colors duration-200 flex items-center text-sm">Copy</button>
                    </div>
                    ${htmlContent}
                `;
                const codeBlock = scriptContent.querySelector('pre code.language-powershell');
                if (codeBlock) {
                    codeBlock.classList.add('code-font');
                    hljs.highlightElement(codeBlock);
                }
                updateActionButtons();
                parseParametersAndGenerateForm(currentScript);
                document.querySelector('[data-tab="script"]').click();
            };
            
            const updateActionButtons = () => {
                const saveButton = document.getElementById('save-drive-button');
                const explainButton = document.getElementById('explain-button');
                const copyButton = document.getElementById('copy-button');

                if (copyButton) copyButton.addEventListener('click', () => { /* ... copy logic ... */ });
                if (explainButton) explainButton.addEventListener('click', () => handleFormSubmit(currentScript, 'explanation'));
                
                if (saveButton) {
                    if (gapi.client.getToken() !== null && currentScript) {
                        saveButton.style.display = 'flex';
                        saveButton.onclick = saveToDrive; // Re-assign onclick
                    } else {
                        saveButton.style.display = 'none';
                    }
                }
                 const pesterButton = document.querySelector('[data-tab="pester"]');
                if(pesterButton) pesterButton.onclick = () => {
                    const pesterContent = document.getElementById('pester-content');
                    if(pesterContent.innerHTML.trim() === '') {
                        handleFormSubmit(currentScript, 'pester');
                    }
                };
            };

            async function saveToDrive() {
                // [This function remains the same as previous version]
            }
            async function findOrCreateFolder() {
                // [This function remains the same as previous version]
            }
            
            // [All other helper functions like addMessageToChat, setupTabs, renderPester, etc., remain the same]

            // Initial UI setup
            updateModeUI();
            // Call maybeEnableAuthButton in case gapi/gis loaded before the DOM did
            maybeEnableAuthButton();
        });
    </script>
</body>
</html>
