import React, { useState, useEffect } from 'react';

// Helper function to load a script dynamically
const loadScript = (src) => {
  return new Promise((resolve, reject) => {
    // Check if the script is already on the page
    if (document.querySelector(`script[src="${src}"]`)) {
      resolve();
      return;
    }
    const script = document.createElement('script');
    script.src = src;
    script.onload = () => resolve();
    script.onerror = () => reject(new Error(`Script load error for ${src}`));
    document.head.appendChild(script);
  });
};

// Main App Component
export default function App() {
  const [markdown, setMarkdown] = useState('# Hello, World!\n\nThis is a **Markdown** to **PDF** converter.\n\n- Upload a `.md` file.\n- See the preview.\n- Download the PDF.');
  const [fileName, setFileName] = useState('sample.md');
  const [isProcessing, setIsProcessing] = useState(false);
  const [notification, setNotification] = useState(null);

  // Load necessary scripts on component mount
  useEffect(() => {
    Promise.all([
      loadScript('https://cdn.tailwindcss.com'),
      loadScript('https://cdn.jsdelivr.net/npm/marked/marked.min.js'),
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'),
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js')
    ]).catch(error => {
        console.error("Failed to load critical scripts:", error);
        showNotification('error', 'Failed to load necessary scripts. Please refresh the page.');
    });
  }, []);

  // --- Handlers ---

  /**
   * Shows a notification message to the user.
   * @param {string} type - The type of notification ('success', 'error').
   * @param {string} message - The message to display.
   */
  const showNotification = (type, message) => {
      setNotification({ type, message });
      setTimeout(() => {
          setNotification(null);
      }, 3000);
  };

  /**
   * Handles the file input change event.
   * Reads the selected markdown file and updates the state.
   */
  const handleFileChange = (event) => {
    const file = event.target.files[0];
    if (file && (file.name.endsWith('.md') || file.name.endsWith('.markdown'))) {
      const reader = new FileReader();
      reader.onload = (e) => {
        setMarkdown(e.target.result);
        setFileName(file.name);
        showNotification('success', `${file.name} loaded successfully!`);
      };
      reader.readAsText(file);
    } else {
        showNotification('error', 'Please select a valid Markdown file (.md)');
    }
  };

  /**
   * Converts the markdown content to HTML using the 'marked' library.
   * @returns {string} The resulting HTML string.
   */
  const getHtmlContent = () => {
    // The 'marked' library is loaded via script tag and attached to the window object.
    if (window.marked) {
        return window.marked.parse(markdown);
    }
    return "<p>Loading Markdown parser...</p>";
  };

  /**
   * Generates and downloads a PDF from the rendered HTML preview.
   */
  const handleDownloadPdf = async () => {
    const pdfPreview = document.getElementById('pdf-preview');
    // Check if libraries from script tags are loaded
    if (!pdfPreview || !window.jspdf || !window.html2canvas) {
        console.error("Required libraries or elements are not available.");
        showNotification('error', 'PDF generation library not ready. Please wait or refresh.');
        return;
    }

    setIsProcessing(true);

    try {
        const canvas = await window.html2canvas(pdfPreview, {
            scale: 2, // Increase scale for better quality
            useCORS: true,
            logging: false,
        });

        const imgData = canvas.toDataURL('image/png');
        // Access jsPDF from the window object
        const pdf = new window.jspdf.jsPDF({
            orientation: 'p',
            unit: 'mm',
            format: 'a4',
        });

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        const ratio = canvasWidth / canvasHeight;
        const imgWidth = pdfWidth - 20; // with margin
        const imgHeight = imgWidth / ratio;

        let heightLeft = imgHeight;
        let position = 10; // top margin

        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= (pdfHeight - 20);

        // Handle content that spans multiple pages
        while (heightLeft > 0) {
            position = heightLeft - imgHeight + 10; // reset position
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= (pdfHeight - 20);
        }
        
        const pdfFileName = fileName.replace(/\.md$/, '.pdf').replace(/\.markdown$/, '.pdf');
        pdf.save(pdfFileName);

    } catch (error) {
        console.error("Error generating PDF:", error);
        showNotification('error', 'An error occurred while generating the PDF.');
    } finally {
        setIsProcessing(false);
    }
  };

  // --- Render ---

  return (
    <div className="bg-gray-100 min-h-screen font-sans antialiased">
      
      {/* Notification Popup */}
      {notification && (
        <div className={`fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white z-50 transition-opacity duration-300 ${notification.type === 'error' ? 'bg-red-500' : 'bg-green-500'}`}>
          {notification.message}
        </div>
      )}

      <div className="container mx-auto p-4 sm:p-6 lg:p-8">
        
        {/* Header */}
        <header className="bg-white rounded-lg shadow-md p-6 mb-8">
          <div className="flex flex-col sm:flex-row justify-between items-center">
            <div>
              <h1 className="text-3xl font-bold text-gray-800">Markdown to PDF</h1>
              <p className="text-gray-500 mt-1">Upload, Preview, and Download</p>
            </div>
            <div className="mt-4 sm:mt-0 flex items-center space-x-4">
              <label htmlFor="file-upload" className="cursor-pointer bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 shadow-sm">
                Upload .md File
              </label>
              <input id="file-upload" type="file" accept=".md,.markdown" className="hidden" onChange={handleFileChange} />
              <button 
                onClick={handleDownloadPdf} 
                disabled={isProcessing}
                className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 shadow-sm disabled:bg-gray-400 disabled:cursor-wait"
              >
                {isProcessing ? 'Processing...' : 'Download PDF'}
              </button>
            </div>
          </div>
        </header>

        {/* Main Content */}
        <main className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          
          {/* Markdown Editor */}
          <div className="bg-white rounded-lg shadow-md">
            <div className="p-4 border-b border-gray-200 flex justify-between items-center">
              <h2 className="text-xl font-semibold text-gray-700">Markdown Input</h2>
              <span className="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded">{fileName}</span>
            </div>
            <textarea
              value={markdown}
              onChange={(e) => setMarkdown(e.target.value)}
              className="w-full h-[60vh] p-4 text-gray-800 bg-gray-50 border-0 focus:ring-2 focus:ring-blue-300 resize-none"
              placeholder="Enter your Markdown here..."
            />
          </div>

          {/* HTML Preview */}
          <div className="bg-white rounded-lg shadow-md overflow-hidden">
            <div className="p-4 border-b border-gray-200">
              <h2 className="text-xl font-semibold text-gray-700">Live Preview</h2>
            </div>
            <div 
              id="pdf-preview" 
              className="prose max-w-none p-6 h-[60vh] overflow-y-auto"
              dangerouslySetInnerHTML={{ __html: getHtmlContent() }}
            />
          </div>

        </main>
        
        {/* Footer */}
        <footer className="text-center mt-8 text-gray-500 text-sm">
            <p>Powered by React, Marked.js, and jsPDF</p>
        </footer>
      </div>
    </div>
  );
}
