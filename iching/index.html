<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Oracle with Gemini & Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hex-line { height: 12px; margin: 8px auto; position: relative; display: flex; justify-content: center; align-items: center; width: 120px; }
        .solid-line { background-color: #334155; width: 100px; border-radius: 4px; height: 12px; }
        .broken-line { width: 100px; display: flex; justify-content: space-between; }
        .broken-line-part { background-color: #334155; width: 45%; height: 12px; border-radius: 4px; }
        .changing-marker { width: 10px; height: 10px; background-color: #ca8a04; border-radius: 50%; position: absolute; left: calc(50% + 55px); }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <!-- Config Modal (no changes) -->
    <div id="configModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl">
            <h2 class="text-2xl font-bold mb-2">Configuration Profile</h2>
            <p class="mb-6 text-slate-600">Save and load credential profiles to switch between different projects.</p>
            
            <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                 <label for="profileSelector" class="block text-sm font-medium text-slate-700">Load Existing Profile</label>
                 <div class="flex items-center space-x-2 mt-1">
                    <select id="profileSelector" class="block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500">
                        <option value="">-- Select a Profile --</option>
                    </select>
                    <button id="loadProfileButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Load</button>
                    <button id="deleteProfileButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Delete</button>
                 </div>
            </div>
    
            <h3 class="text-lg font-semibold mb-3">Create or Update a Profile</h3>
            <div class="space-y-4">
                <div>
                    <label for="profileNameInput" class="block text-sm font-medium text-slate-700">Profile Name</label>
                    <input type="text" id="profileNameInput" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500" placeholder="e.g., My Personal Project">
                </div>
                <div>
                    <label for="geminiApiKeyInput" class="block text-sm font-medium text-slate-700">Gemini API Key</label>
                    <input type="password" id="geminiApiKeyInput" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500" placeholder="Enter your Gemini API Key">
                </div>
                <div>
                    <label for="firebaseConfigInput" class="block text-sm font-medium text-slate-700">Firebase Config Object</label>
                    <textarea id="firebaseConfigInput" class="w-full h-40 p-2 border rounded-md font-mono text-sm mt-1" placeholder="Paste your entire Firebase config object here..."></textarea>
                </div>
            </div>
    
            <button id="saveConfigButton" class="mt-6 w-full bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-4 rounded-lg">Save and Initialize Profile</button>
        </div>
    </div>

    <div id="app" class="w-full max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 hidden">

        <header class="flex justify-between items-start mb-6">
            <div class="text-left">
                <h1 class="text-3xl font-bold text-slate-700">AI I Ching Oracle</h1>
                <p class="text-slate-500 mt-1">Enter your coin toss results for an interpretation.</p>
            </div>
            <div id="authContainer" class="text-right flex items-center space-x-3"></div>
        </header>

        <main id="mainContent">
            <div id="controls" class="mb-6">
                <h3 class="text-lg font-semibold text-center mb-4 text-slate-700">Enter Your Coin Toss Results (6, 7, 8, or 9)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 items-start">
                    <div id="line-entry-container" class="space-y-3"></div>
                    <div id="hexagram-visualizer" class="bg-slate-50 rounded-lg p-4 flex flex-col-reverse justify-center items-center h-full min-h-[220px]">
                        <p class="text-slate-400">Your hexagram will appear here</p>
                    </div>
                </div>
                <div class="text-center mt-6">
                    <button id="interpretButton" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-slate-400 disabled:cursor-not-allowed">
                        Interpret Hexagram
                    </button>
                </div>
            </div>

            <div id="interpretationContainer" class="hidden fade-in space-y-6">
                <div id="mediaContainer" class="p-4 bg-slate-50 rounded-lg border">
                    <h3 class="text-xl font-bold text-slate-700 mb-4">Evocation</h3>
                    <div id="imageContainer" class="mb-4 bg-black rounded-md flex items-center justify-center min-h-[256px]"></div>
                </div>
                <div id="resultsContainer" class="p-4 bg-slate-50 rounded-lg border">
                    <h3 class="text-xl font-bold text-slate-700 mb-4">Interpretation</h3>
                    <div id="textInterpretation"></div>
                </div>
                <div id="journalContainer" class="p-4 bg-slate-50 rounded-lg border">
                    <h3 class="text-xl font-bold text-slate-700 mb-4">Reflection</h3>
                    <div id="journalPrompts" class="prose max-w-none prose-p:my-2 prose-ul:my-2"></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // NEW: Import Functions SDK
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // --- App State ---
        let db, auth, functions; // NEW: Add functions
        let geminiApiKey, firebaseConfig;
        let currentUser = null;
        let currentProfileName = null;

        // --- DOM Elements ---
        const configModal = document.getElementById('configModal');
        const saveConfigButton = document.getElementById('saveConfigButton');
        const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
        const firebaseConfigInput = document.getElementById('firebaseConfigInput');
        const profileNameInput = document.getElementById('profileNameInput');
        const profileSelector = document.getElementById('profileSelector');
        const loadProfileButton = document.getElementById('loadProfileButton');
        const deleteProfileButton = document.getElementById('deleteProfileButton');
        
        const appDiv = document.getElementById('app');
        const authContainer = document.getElementById('authContainer');
        const interpretButton = document.getElementById('interpretButton');
        const lineEntryContainer = document.getElementById('line-entry-container');
        const hexagramVisualizer = document.getElementById('hexagram-visualizer');
        
        const interpretationContainer = document.getElementById('interpretationContainer');
        const imageContainer = document.getElementById('imageContainer');
        const textInterpretation = document.getElementById('textInterpretation');
        const journalPrompts = document.getElementById('journalPrompts');
        
        // --- Profile & Config Management ---
        // NOTE: This section is simplified for brevity. Use your existing profile management code.
        function loadConfigAndInit() {
            // Your existing profile management logic here...
            // For now, let's assume config is loaded and valid.
            // In a real scenario, this would show the modal if no valid profile is found.
            const storedFirebaseConfig = localStorage.getItem('firebaseConfig'); // Simplified
            const storedGeminiKey = localStorage.getItem('geminiApiKey'); // Simplified

            if (storedFirebaseConfig && storedGeminiKey) {
                firebaseConfig = JSON.parse(storedFirebaseConfig);
                geminiApiKey = storedGeminiKey;
                initializeAppAndAuth();
            } else {
                configModal.classList.remove('hidden');
            }
        }

        function saveConfig() {
            // Your existing save config logic here...
            const geminiKey = geminiApiKeyInput.value.trim();
            let fbConfigStr = firebaseConfigInput.value.trim();
            
            try {
                // Basic validation and parsing
                const parsedConfig = JSON.parse(fbConfigStr);
                localStorage.setItem('geminiApiKey', geminiKey);
                localStorage.setItem('firebaseConfig', JSON.stringify(parsedConfig));
                configModal.classList.add('hidden');
                loadConfigAndInit();
            } catch (e) {
                alert("Invalid Firebase Config JSON.");
            }
        }

        function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                functions = getFunctions(app, 'us-central1'); // NEW: Initialize Functions

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    updateUIForAuthState(user);
                });

                appDiv.classList.remove('hidden');
                appDiv.classList.add('fade-in');
                setupLineInputs();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                configModal.classList.remove('hidden');
            }
        }

        // --- UI & Auth (Simplified for brevity) ---
        function setupLineInputs() { /* Your existing code */ }
        function updateHexagramVisualizer() { /* Your existing code */ }
        function updateUIForAuthState(user) { /* Your existing code */ }
        async function handleSignIn() { /* Your existing code */ }
        async function handleSignOut() { /* Your existing code */ }

        // --- Main AI Interaction Logic ---
        async function interpretHexagram() {
            if (!currentUser) {
                alert("Please log in to get a reading.");
                return;
            }

            const lineValues = [];
            document.querySelectorAll('.line-input').forEach(input => {
                lineValues.push(parseInt(input.value) || 0);
            });

            if (lineValues.some(v => v < 6 || v > 9)) {
                alert("Please enter a valid number (6, 7, 8, or 9) for all 6 lines.");
                return;
            }

            interpretButton.disabled = true;
            interpretButton.innerHTML = '<div class="spinner !w-6 !h-6 mx-auto"></div>';

            interpretationContainer.classList.remove('hidden');
            textInterpretation.innerHTML = '<div class="spinner"></div><p class="text-center text-slate-500">The oracle is contemplating...</p>';
            imageContainer.innerHTML = '<div class="spinner"></div><p class="text-center text-slate-500">Evoking a vision...</p>';
            journalPrompts.innerHTML = '<div class="spinner"></div><p class="text-center text-slate-500">Preparing questions...</p>';

            try {
                // NEW: Updated prompt to remove soundscape
                const prompt = `
You are an expert in the I Ching (Wilhelm/Baynes). The user's lines are: ${JSON.stringify(lineValues)}.
Return a JSON object with this structure (no other text):
{
  "interpretationText": "A complete HTML string interpretation: Primary Hexagram, Judgment, Image, Changing Lines, Relating Hexagram, and Synthesis. Use <strong> and <br>.",
  "imagePrompt": "A detailed, artistic prompt for an AI image generator capturing the primary hexagram's essence and style.",
  "journalPrompts": ["A unique journal question.", "A second, different question.", "A third question connecting the hexagrams."]
}`;

                const geminiResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!geminiResponse.ok) throw new Error('Failed to get interpretation from Gemini.');
                
                const geminiData = await geminiResponse.json();
                const rawText = geminiData.candidates[0].content.parts[0].text;
                const aiResponse = JSON.parse(rawText.replace(/```json|```/g, ''));

                textInterpretation.innerHTML = `<div class="prose max-w-none">${aiResponse.interpretationText}</div>`;
                journalPrompts.innerHTML = '<ul>' + aiResponse.journalPrompts.map(p => `<li>${p}</li>`).join('') + '</ul>';

                // NEW: Call the Cloud Function
                const generateImage = httpsCallable(functions, 'generateImageWithImagen');
                const imageResult = await generateImage({ prompt: aiResponse.imagePrompt });
                
                const imageUrl = imageResult.data.imageData;
                imageContainer.innerHTML = `<img src="${imageUrl}" alt="AI generated image for the reading" class="rounded-md w-full h-full object-cover">`;

                // Save the full result
                await addDoc(collection(db, "users", currentUser.uid, "readings"), {
                    lines: lineValues,
                    answer: JSON.stringify(aiResponse), // Save the full object
                    imageUrl: imageUrl, // Save the generated image URL
                    createdAt: serverTimestamp()
                });

            } catch (error) {
                console.error("AI Interaction Error:", error);
                textInterpretation.innerHTML = `<p class="text-red-500">An error occurred: ${error.message}</p>`;
                imageContainer.innerHTML = `<p class="text-red-500">Image generation failed.</p>`;
                journalPrompts.innerHTML = '';
            } finally {
                interpretButton.disabled = false;
                interpretButton.textContent = 'Interpret Hexagram';
            }
        }

        // --- Event Listeners ---
        window.addEventListener('load', loadConfigAndInit);
        saveConfigButton.addEventListener('click', saveConfig);
        interpretButton.addEventListener('click', interpretHexagram);

    </script>
</body>
</html>
