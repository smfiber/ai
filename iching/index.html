<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Oracle with Gemini & Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hex-line { height: 12px; margin: 8px auto; position: relative; display: flex; justify-content: center; align-items: center; width: 120px; }
        .solid-line { background-color: #334155; width: 100px; border-radius: 4px; height: 12px; }
        .broken-line { width: 100px; display: flex; justify-content: space-between; }
        .broken-line-part { background-color: #334155; width: 45%; height: 12px; border-radius: 4px; }
        .changing-marker { width: 10px; height: 10px; background-color: #ca8a04; border-radius: 50%; position: absolute; left: calc(50% + 55px); }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <!-- API Keys & Config Modal -->
    <div id="configModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl">
            <h2 class="text-2xl font-bold mb-4">Initial Configuration</h2>
            <p class="mb-6 text-slate-600">Please provide your API keys and configuration to start the application. These will be stored in your browser's local storage.</p>
            
            <div class="space-y-4">
                <div>
                    <label for="geminiApiKeyInput" class="block text-sm font-medium text-slate-700">Gemini API Key</label>
                    <input type="password" id="geminiApiKeyInput" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500" placeholder="Enter your Gemini API Key">
                </div>
                <div>
                    <label for="googleClientIdInput" class="block text-sm font-medium text-slate-700">Google Cloud OAuth Client ID</label>
                    <input type="text" id="googleClientIdInput" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500" placeholder="Enter your Google Cloud Client ID">
                </div>
                <div>
                    <label for="firebaseConfigInput" class="block text-sm font-medium text-slate-700">Firebase Config Object</label>
                    <textarea id="firebaseConfigInput" class="w-full h-40 p-2 border rounded-md font-mono text-sm mt-1" placeholder="Paste your entire Firebase config object here..."></textarea>
                </div>
            </div>

            <button id="saveConfigButton" class="mt-6 w-full bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-4 rounded-lg">Save and Initialize</button>
        </div>
    </div>

    <div id="app" class="w-full max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 hidden">
        
        <header class="flex justify-between items-start mb-6">
            <div class="text-left">
                <h1 class="text-3xl font-bold text-slate-700">AI I Ching Oracle</h1>
                <p class="text-slate-500 mt-1">Enter your coin toss results for an interpretation.</p>
            </div>
            <div id="authContainer" class="text-right flex items-center space-x-3">
                <!-- Auth UI will be injected here -->
            </div>
        </header>

        <div id="mainContent">
            <div id="controls" class="mb-6">
                <h3 class="text-lg font-semibold text-center mb-4 text-slate-700">Enter Your Coin Toss Results (6, 7, 8, or 9)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 items-start">
                    <!-- Line Entry Inputs -->
                    <div id="line-entry-container" class="space-y-3">
                        <!-- Inputs will be generated by JS -->
                    </div>
                    <!-- Hexagram Visualizer -->
                    <div id="hexagram-visualizer" class="bg-slate-50 rounded-lg p-4 flex flex-col-reverse justify-center items-center h-full min-h-[220px]">
                        <p class="text-slate-400">Your hexagram will appear here</p>
                    </div>
                </div>
                <div class="text-center mt-6">
                    <button id="interpretButton" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-slate-400 disabled:cursor-not-allowed">
                        Interpret Hexagram
                    </button>
                </div>
            </div>

            <div id="resultsContainer" class="hidden fade-in p-6 bg-slate-50 rounded-lg border">
                <!-- Gemini's response will be shown here -->
            </div>
        </div>

        <div id="pastReadings" class="mt-12 border-t pt-6 hidden">
            <h2 class="text-2xl font-bold text-center text-slate-700 mb-4">Your Past Readings</h2>
            <div id="readingsList" class="space-y-4">
                <!-- Past readings will be injected here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App State ---
        let db, auth;
        let geminiApiKey, googleClientId, firebaseConfig;
        let currentUser = null;

        // --- DOM Elements ---
        const configModal = document.getElementById('configModal');
        const saveConfigButton = document.getElementById('saveConfigButton');
        const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
        const googleClientIdInput = document.getElementById('googleClientIdInput');
        const firebaseConfigInput = document.getElementById('firebaseConfigInput');
        
        const appDiv = document.getElementById('app');
        const authContainer = document.getElementById('authContainer');
        const interpretButton = document.getElementById('interpretButton');
        const resultsContainer = document.getElementById('resultsContainer');
        const pastReadingsDiv = document.getElementById('pastReadings');
        const readingsListDiv = document.getElementById('readingsList');
        const lineEntryContainer = document.getElementById('line-entry-container');
        const hexagramVisualizer = document.getElementById('hexagram-visualizer');

        // --- Configuration & Initialization ---

        function loadConfigAndInit() {
            geminiApiKey = localStorage.getItem('geminiApiKey');
            googleClientId = localStorage.getItem('googleClientId');
            const storedFirebaseConfig = localStorage.getItem('firebaseConfig');

            if (!geminiApiKey || !googleClientId || !storedFirebaseConfig) {
                configModal.classList.remove('hidden');
            } else {
                try {
                    firebaseConfig = JSON.parse(storedFirebaseConfig);
                    initializeAppAndAuth();
                } catch (e) {
                    console.error("Failed to parse Firebase config from localStorage", e);
                    localStorage.clear(); // Clear corrupted config
                    configModal.classList.remove('hidden');
                }
            }
        }

        function saveConfig() {
            const geminiKey = geminiApiKeyInput.value.trim();
            const clientId = googleClientIdInput.value.trim();
            const fbConfigStr = firebaseConfigInput.value.trim();

            if (!geminiKey || !clientId || !fbConfigStr) {
                alert("Please fill out all fields.");
                return;
            }

            try {
                JSON.parse(fbConfigStr);
                localStorage.setItem('geminiApiKey', geminiKey);
                localStorage.setItem('googleClientId', clientId);
                localStorage.setItem('firebaseConfig', fbConfigStr);
                configModal.classList.add('hidden');
                loadConfigAndInit();
            } catch (e) {
                alert("The Firebase config is not valid JSON. Please check and paste it again.");
            }
        }

        function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    updateUIForAuthState(user);
                    if (user) {
                        loadPastReadings(user.uid);
                    }
                });

                appDiv.classList.remove('hidden');
                appDiv.classList.add('fade-in');
                setupLineInputs();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                alert("Firebase initialization failed. Please check your config.");
                localStorage.clear();
                configModal.classList.remove('hidden');
            }
        }

        // --- UI Setup ---
        function setupLineInputs() {
            lineEntryContainer.innerHTML = '';
            for (let i = 1; i <= 6; i++) {
                const inputDiv = document.createElement('div');
                inputDiv.className = 'flex items-center space-x-3';
                inputDiv.innerHTML = `
                    <label for="line-${i}" class="w-16 text-sm font-medium text-slate-600">Line ${i}:</label>
                    <input type="number" id="line-${i}" min="6" max="9" class="line-input w-full p-2 border rounded-md focus:ring-2 focus:ring-sky-500" placeholder="6-9">
                `;
                lineEntryContainer.appendChild(inputDiv);
            }
            document.querySelectorAll('.line-input').forEach(input => {
                input.addEventListener('input', updateHexagramVisualizer);
            });
            updateHexagramVisualizer();
        }
        
        function updateHexagramVisualizer() {
            hexagramVisualizer.innerHTML = '';
            const lineInputs = document.querySelectorAll('.line-input');
            let hasContent = false;
            lineInputs.forEach(input => {
                const value = parseInt(input.value);
                if (value >= 6 && value <= 9) {
                    hexagramVisualizer.innerHTML += drawLine(value);
                    hasContent = true;
                } else {
                    // Add a placeholder for empty lines to maintain structure
                    hexagramVisualizer.innerHTML += '<div class="hex-line h-[28px]"></div>';
                }
            });

            if(!hasContent) {
                 hexagramVisualizer.innerHTML = '<p class="text-slate-400">Your hexagram will appear here</p>';
            }
        }

        function drawLine(value) {
            const isChanging = value === 6 || value === 9;
            const isSolid = value === 7 || value === 9;
            
            const lineClass = isSolid ? 'solid-line' : 'broken-line';
            const lineContent = isSolid ? '' : '<div class="broken-line-part"></div><div class="broken-line-part"></div>';
            const changingMarker = isChanging ? '<div class="changing-marker"></div>' : '';

            return `<div class="hex-line"><div class="${lineClass}">${lineContent}</div>${changingMarker}</div>`;
        }


        // --- Authentication ---

        function updateUIForAuthState(user) {
            authContainer.innerHTML = '';
            if (user) {
                authContainer.innerHTML = `
                    <div class="text-right">
                        <p class="text-sm font-medium">${user.displayName}</p>
                        <p class="text-xs text-slate-500">${user.email}</p>
                    </div>
                    <img src="${user.photoURL}" alt="User photo" class="w-10 h-10 rounded-full">
                    <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Logout</button>
                `;
                document.getElementById('logoutButton').addEventListener('click', handleSignOut);
                interpretButton.disabled = false;
            } else {
                authContainer.innerHTML = `
                    <button id="loginButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Login with Google</button>
                `;
                document.getElementById('loginButton').addEventListener('click', handleSignIn);
                interpretButton.disabled = true;
                pastReadingsDiv.classList.add('hidden');
            }
        }

        async function handleSignIn() {
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ 'client_id': googleClientId });
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In Error", error);
                alert(`Could not sign in with Google. Error: ${error.message}`);
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                readingsListDiv.innerHTML = '';
            } catch (error) {
                console.error("Sign Out Error", error);
            }
        }

        // --- Gemini API Interaction ---

        async function interpretHexagram() {
            const lineValues = [];
            const lineInputs = document.querySelectorAll('.line-input');
            for (const input of lineInputs) {
                const value = parseInt(input.value);
                if (isNaN(value) || value < 6 || value > 9) {
                    alert("Please enter a valid number (6, 7, 8, or 9) for all 6 lines.");
                    return;
                }
                lineValues.push(value);
            }

            interpretButton.disabled = true;
            interpretButton.innerHTML = '<div class="spinner !w-6 !h-6 mx-auto"></div>';
            resultsContainer.classList.remove('hidden');
            resultsContainer.innerHTML = '<div class="spinner"></div><p class="text-center text-slate-500">The oracle is contemplating...</p>';

            try {
                const prompt = `
You are an expert in the I Ching, the ancient Chinese Book of Changes. A user has performed a divination by tossing coins and has generated a hexagram. Your task is to provide a complete and insightful interpretation.

The user's results for the six lines, from bottom (Line 1) to top (Line 6), are: ${JSON.stringify(lineValues)}

For your reference, the line values mean:
- 7: A stable Yang line (solid).
- 8: A stable Yin line (broken).
- 9: A changing Yang line (solid, will change to broken).
- 6: A changing Yin line (broken, will change to solid).

Based on these lines, please provide the following in your response:
1.  **Primary Hexagram:** Identify its number and name.
2.  **Judgment & Image:** Provide the classic Judgment and Image text for the Primary Hexagram.
3.  **Changing Lines:** If there are any changing lines (6 or 9), list each one (e.g., "Line 3 (Nine in the third place):") and provide its specific line text and meaning.
4.  **Relating Hexagram:** If there are changing lines, describe the hexagram that results from the changes. Give its number and name.
5.  **Synthesized Interpretation:** Provide a final, holistic interpretation that combines all these elements into clear guidance for the user.

Please structure your response clearly.`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `API request failed with status ${response.status}`);
                }

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                let formattedText = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');

                resultsContainer.innerHTML = `<div class="prose max-w-none">${formattedText}</div>`;
                await saveReading(lineValues, text);

            } catch (error) {
                console.error("Gemini API Error:", error);
                resultsContainer.innerHTML = `<p class="text-red-500">An error occurred: ${error.message}</p>`;
            } finally {
                interpretButton.disabled = false;
                interpretButton.textContent = 'Interpret Hexagram';
            }
        }

        // --- Firestore Data Persistence ---

        async function saveReading(lines, answer) {
            if (!currentUser) return;
            try {
                await addDoc(collection(db, "users", currentUser.uid, "readings"), {
                    lines: lines,
                    answer: answer,
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Error saving reading to Firestore: ", error);
            }
        }

        function loadPastReadings(uid) {
            const readingsCol = collection(db, "users", uid, "readings");
            const q = query(readingsCol, where("lines", "!=", null));

            onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    pastReadingsDiv.classList.add('hidden');
                    return;
                }
                
                readingsListDiv.innerHTML = '';
                const readings = [];
                querySnapshot.forEach((doc) => readings.push({ id: doc.id, ...doc.data() }));
                
                readings.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

                readings.forEach(data => {
                    const date = data.createdAt ? data.createdAt.toDate().toLocaleString() : 'Just now';
                    const readingEl = document.createElement('div');
                    readingEl.className = 'bg-white p-4 rounded-lg border border-slate-200';
                    readingEl.innerHTML = `
                        <p class="text-xs text-slate-400 mb-2">${date}</p>
                        <p class="font-semibold text-slate-700">Lines: [${data.lines.join(', ')}]</p>
                        <p class="text-sm text-slate-600 mt-2 truncate">${data.answer}</p>
                    `;
                    readingsListDiv.appendChild(readingEl);
                });
                pastReadingsDiv.classList.remove('hidden');
            }, (error) => {
                console.error("Error loading past readings:", error);
            });
        }

        // --- Event Listeners ---
        window.addEventListener('load', loadConfigAndInit);
        saveConfigButton.addEventListener('click', saveConfig);
        interpretButton.addEventListener('click', interpretHexagram);

    </script>
</body>
</html>
