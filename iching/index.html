<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Oracle with Gemini & Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none; }
        /* Simple spinner for loading states */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <!-- API Keys & Config Modal -->
    <div id="configModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl">
            <h2 class="text-2xl font-bold mb-4">Initial Configuration</h2>
            <p class="mb-6 text-slate-600">Please provide your API keys and configuration to start the application. These will be stored in your browser's local storage.</p>
            
            <div class="space-y-4">
                <div>
                    <label for="geminiApiKeyInput" class="block text-sm font-medium text-slate-700">Gemini API Key</label>
                    <input type="password" id="geminiApiKeyInput" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500" placeholder="Enter your Gemini API Key">
                </div>
                <div>
                    <label for="googleClientIdInput" class="block text-sm font-medium text-slate-700">Google Cloud OAuth Client ID</label>
                    <input type="text" id="googleClientIdInput" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500" placeholder="Enter your Google Cloud Client ID">
                </div>
                <div>
                    <label for="firebaseConfigInput" class="block text-sm font-medium text-slate-700">Firebase Config Object</label>
                    <textarea id="firebaseConfigInput" class="w-full h-40 p-2 border rounded-md font-mono text-sm mt-1" placeholder="Paste your entire Firebase config object here..."></textarea>
                </div>
            </div>

            <button id="saveConfigButton" class="mt-6 w-full bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-4 rounded-lg">Save and Initialize</button>
        </div>
    </div>

    <div id="app" class="w-full max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 hidden">
        
        <header class="flex justify-between items-start mb-6">
            <div class="text-left">
                <h1 class="text-3xl font-bold text-slate-700">AI Oracle</h1>
                <p class="text-slate-500 mt-1">Ask a question to receive insight.</p>
            </div>
            <div id="authContainer" class="text-right flex items-center space-x-3">
                <!-- Auth UI will be injected here -->
            </div>
        </header>

        <div id="mainContent">
            <div id="controls" class="text-center mb-6">
                <textarea id="questionInput" class="w-full p-3 border rounded-md mb-4 focus:ring-2 focus:ring-sky-500" rows="3" placeholder="Enter a question for the oracle..."></textarea>
                <button id="askButton" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-slate-400 disabled:cursor-not-allowed">
                    Ask Gemini
                </button>
            </div>

            <div id="resultsContainer" class="hidden fade-in p-6 bg-slate-50 rounded-lg border">
                <!-- Gemini's response will be shown here -->
            </div>
        </div>

        <div id="pastReadings" class="mt-12 border-t pt-6 hidden">
            <h2 class="text-2xl font-bold text-center text-slate-700 mb-4">Your Past Questions</h2>
            <div id="readingsList" class="space-y-4">
                <!-- Past readings will be injected here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App State ---
        let db, auth;
        let geminiApiKey, googleClientId, firebaseConfig;
        let currentUser = null;

        // --- DOM Elements ---
        const configModal = document.getElementById('configModal');
        const saveConfigButton = document.getElementById('saveConfigButton');
        const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
        const googleClientIdInput = document.getElementById('googleClientIdInput');
        const firebaseConfigInput = document.getElementById('firebaseConfigInput');
        
        const appDiv = document.getElementById('app');
        const authContainer = document.getElementById('authContainer');
        const questionInput = document.getElementById('questionInput');
        const askButton = document.getElementById('askButton');
        const resultsContainer = document.getElementById('resultsContainer');
        const pastReadingsDiv = document.getElementById('pastReadings');
        const readingsListDiv = document.getElementById('readingsList');

        // --- Configuration & Initialization ---

        function loadConfigAndInit() {
            geminiApiKey = localStorage.getItem('geminiApiKey');
            googleClientId = localStorage.getItem('googleClientId');
            const storedFirebaseConfig = localStorage.getItem('firebaseConfig');

            if (!geminiApiKey || !googleClientId || !storedFirebaseConfig) {
                configModal.classList.remove('hidden');
            } else {
                try {
                    firebaseConfig = JSON.parse(storedFirebaseConfig);
                    initializeAppAndAuth();
                } catch (e) {
                    console.error("Failed to parse Firebase config from localStorage", e);
                    localStorage.clear(); // Clear corrupted config
                    configModal.classList.remove('hidden');
                }
            }
        }

        function saveConfig() {
            const geminiKey = geminiApiKeyInput.value.trim();
            const clientId = googleClientIdInput.value.trim();
            const fbConfigStr = firebaseConfigInput.value.trim();

            if (!geminiKey || !clientId || !fbConfigStr) {
                alert("Please fill out all fields.");
                return;
            }

            try {
                // Test parsing the config before saving
                JSON.parse(fbConfigStr);
                localStorage.setItem('geminiApiKey', geminiKey);
                localStorage.setItem('googleClientId', clientId);
                localStorage.setItem('firebaseConfig', fbConfigStr);
                configModal.classList.add('hidden');
                loadConfigAndInit();
            } catch (e) {
                alert("The Firebase config is not valid JSON. Please check and paste it again.");
            }
        }

        function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    updateUIForAuthState(user);
                    if (user) {
                        loadPastReadings(user.uid);
                    }
                });

                appDiv.classList.remove('hidden');
                appDiv.classList.add('fade-in');

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                alert("Firebase initialization failed. Please check your config.");
                localStorage.clear();
                configModal.classList.remove('hidden');
            }
        }

        // --- Authentication ---

        function updateUIForAuthState(user) {
            authContainer.innerHTML = '';
            if (user) {
                authContainer.innerHTML = `
                    <div class="text-right">
                        <p class="text-sm font-medium">${user.displayName}</p>
                        <p class="text-xs text-slate-500">${user.email}</p>
                    </div>
                    <img src="${user.photoURL}" alt="User photo" class="w-10 h-10 rounded-full">
                    <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Logout</button>
                `;
                document.getElementById('logoutButton').addEventListener('click', handleSignOut);
                askButton.disabled = false;
            } else {
                authContainer.innerHTML = `
                    <button id="loginButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Login with Google</button>
                `;
                document.getElementById('loginButton').addEventListener('click', handleSignIn);
                askButton.disabled = true;
                pastReadingsDiv.classList.add('hidden');
            }
        }

        async function handleSignIn() {
            const provider = new GoogleAuthProvider();
            // Important: Set the custom OAuth client ID
            provider.setCustomParameters({
                'client_id': googleClientId
            });
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In Error", error);
                alert(`Could not sign in with Google. Error: ${error.message}`);
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                readingsListDiv.innerHTML = ''; // Clear readings on logout
            } catch (error) {
                console.error("Sign Out Error", error);
            }
        }

        // --- Gemini API Interaction ---

        async function askGemini() {
            const question = questionInput.value.trim();
            if (!question) {
                alert("Please enter a question.");
                return;
            }

            askButton.disabled = true;
            askButton.innerHTML = '<div class="spinner !w-6 !h-6 mx-auto"></div>';
            resultsContainer.classList.remove('hidden');
            resultsContainer.innerHTML = '<div class="spinner"></div><p class="text-center text-slate-500">The oracle is contemplating...</p>';

            try {
                const prompt = `You are a wise and ancient oracle. A person has come to you with a question. Provide a thoughtful, insightful, and slightly mystical response. The question is: "${question}"`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `API request failed with status ${response.status}`);
                }

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                // Simple markdown-to-HTML
                let formattedText = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');

                resultsContainer.innerHTML = `<p>${formattedText}</p>`;
                await saveReading(question, text);

            } catch (error) {
                console.error("Gemini API Error:", error);
                resultsContainer.innerHTML = `<p class="text-red-500">An error occurred: ${error.message}</p>`;
            } finally {
                askButton.disabled = false;
                askButton.textContent = 'Ask Gemini';
            }
        }

        // --- Firestore Data Persistence ---

        async function saveReading(question, answer) {
            if (!currentUser) return;
            try {
                await addDoc(collection(db, "users", currentUser.uid, "readings"), {
                    question: question,
                    answer: answer,
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Error saving reading to Firestore: ", error);
            }
        }

        function loadPastReadings(uid) {
            const readingsCol = collection(db, "users", uid, "readings");
            const q = query(readingsCol, where("question", "!=", "")); // Basic query, can be ordered by timestamp

            onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    pastReadingsDiv.classList.add('hidden');
                    return;
                }
                
                readingsListDiv.innerHTML = '';
                const readings = [];
                querySnapshot.forEach((doc) => {
                    readings.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by date client-side to avoid composite index requirement
                readings.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

                readings.forEach(data => {
                    const date = data.createdAt ? data.createdAt.toDate().toLocaleString() : 'Just now';
                    const readingEl = document.createElement('div');
                    readingEl.className = 'bg-white p-4 rounded-lg border border-slate-200';
                    readingEl.innerHTML = `
                        <p class="text-xs text-slate-400 mb-2">${date}</p>
                        <p class="font-semibold text-slate-700">${data.question}</p>
                        <p class="text-sm text-slate-600 mt-2 truncate">${data.answer}</p>
                    `;
                    readingsListDiv.appendChild(readingEl);
                });
                pastReadingsDiv.classList.remove('hidden');
            }, (error) => {
                console.error("Error loading past readings:", error);
            });
        }

        // --- Event Listeners ---
        window.addEventListener('load', loadConfigAndInit);
        saveConfigButton.addEventListener('click', saveConfig);
        askButton.addEventListener('click', askGemini);

    </script>
</body>
</html>
