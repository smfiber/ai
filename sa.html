<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Administration Hub</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter, Lato, Roboto Slab, Open Sans, Montserrat, Poppins, Nunito Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Nunito+Sans:wght@400;700&family=Open+Sans:wght@400;700&family=Poppins:wght@400;500;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* * ==============================================
         * CSS Custom Properties for Theming & Typography
         * ==============================================
        */
        :root {
            --color-bg: #f3e8ff;
            --color-text: #374151;
            --color-text-muted: #6b7280;
            --color-primary: #9333ea;
            --color-primary-dark: #7e22ce;
            --color-accent: #581c87;
            --color-card-bg: rgba(255, 255, 255, 0.9);
            --color-card-border: #e9d5ff;
            --color-input-bg: #f9fafb;
            --color-input-border: #d1d5db;
            --color-button-text: #ffffff;
            --code-bg: #282c34;
            --code-text: #abb2bf;
        }

        /* Applying the theme variables */
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family, 'Inter', sans-serif);
            background-color: var(--color-bg);
            color: var(--color-text);
            font-size: var(--font-size-base, '16px');
            line-height: var(--line-height-base, 1.5);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        
        /* General Prose styling for AI-generated content */
        .prose { font-size: inherit; line-height: 1.6; }
        .prose p { margin-bottom: 1rem; }
        .prose ul, .prose ol { 
            margin-bottom: 1rem;
            padding-left: 1.75rem;
        }
        .prose ul { list-style-type: disc; }
        .prose ol { list-style-type: decimal; }
        .prose li { margin-bottom: 0.5rem; padding-left: 0.25rem; }
        .prose li > p { margin-bottom: 0.25rem; }
        .prose li > ul, .prose li > ol { margin-top: 0.5rem; }
        .prose strong { font-weight: 600; color: var(--color-text); }
        .prose a { color: var(--color-primary); text-decoration: none; border-bottom: 1px solid var(--color-primary); }
        .prose a:hover { color: var(--color-primary-dark); border-bottom-color: var(--color-primary-dark); }
        .prose h3 {
             font-size: 1.25rem;
             font-weight: 600;
             color: var(--color-accent);
             margin-top: 1.5em;
             margin-bottom: 0.5em;
        }
        
        .screenshot-placeholder {
            border: 2px dashed var(--color-card-border);
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
            background-color: var(--color-input-bg);
            text-align: center;
            color: var(--color-text-muted);
            font-style: italic;
        }
        .screenshot-placeholder::before {
            content: 'ðŸ“·';
            display: block;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        /* Code Block Styling */
        .code-block-container {
            background-color: var(--code-bg);
            border-radius: 8px;
            margin: 1.5rem 0;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            color: #d1d5db;
            font-size: 0.875rem;
            font-family: 'Inter', sans-serif;
        }
        .copy-code-button {
            background-color: rgba(255,255,255,0.1);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }
        .copy-code-button:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .prose pre {
            background-color: transparent !important;
            margin: 0;
            padding: 1rem;
            color: var(--code-text);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .prose code {
             font-family: 'Menlo', 'Consolas', monospace;
             font-size: 0.9em;
        }


        .card {
            background-color: var(--color-card-bg);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, background-color 0.5s ease, border-color 0.5s ease;
            border: 1px solid var(--color-card-border);
            display: flex; flex-direction: column;
        }
        .card:hover { box-shadow: 0 10px 20px -5px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .card-content { flex-grow: 1; display: flex; flex-direction: column; }

        .btn-primary {
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text);
            font-weight: 600; padding: 12px 24px; border-radius: 8px;
            transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none; cursor: pointer;
        }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 7px 10px rgba(0, 0, 0, 0.15); filter: brightness(1.1); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-secondary {
            background-color: var(--color-input-bg); color: var(--color-text-muted);
            font-weight: 600; padding: 10px 20px; border-radius: 8px;
            border: 1px solid var(--color-input-border); cursor: pointer;
            transition: all 0.2s ease; display: inline-flex;
            align-items: center; justify-content: center; gap: 8px;
        }
        .btn-secondary:hover:not(:disabled) { background-color: #e5e7eb; color: var(--color-accent); }
        .btn-secondary:disabled { opacity: 0.7; cursor: not-allowed;}
        
        .btn-toggle {
            background-color: var(--color-input-bg); color: var(--color-text-muted);
            border: 1px solid var(--color-input-border); transition: all 0.2s ease;
        }
        .btn-toggle.active {
            background-color: var(--color-accent); color: var(--color-button-text);
            border-color: var(--color-primary-dark); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .jump-to-button {
            background-color: var(--color-card-bg); color: var(--color-text-muted);
            border: 1px solid var(--color-card-border); transition: all 0.2s ease;
            padding: 8px 16px; border-radius: 9999px; font-size: 0.875rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .jump-to-button:hover { background-color: var(--color-primary); color: var(--color-button-text); border-color: var(--color-primary-dark); transform: translateY(-1px); }

        .floating-action-button {
            position: fixed; background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text); width: 56px; height: 56px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.1);
            cursor: pointer; transition: all 0.3s ease; z-index: 40;
        }
        .floating-action-button:hover { transform: translateY(-3px) scale(1.05); }
        #new-plan-button { bottom: 2rem; right: 2rem; }
        #settings-button { bottom: 6.5rem; right: 2rem; }
        #ai-help-button { bottom: 11rem; right: 2rem; }
        #theme-changer-button { bottom: 15.5rem; right: 2rem; }
        #scroll-to-top-button { bottom: 2rem; left: 2rem; }
        
        #settings-panel {
            position: fixed; bottom: 11rem; right: 2rem;
            background-color: var(--color-card-bg); border: 1px solid var(--color-card-border);
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 1rem; width: 280px; z-index: 40;
            transition: opacity 0.3s ease, transform 0.3s ease; transform-origin: bottom right;
        }

        .themed-text-primary { color: var(--color-primary); }
        .themed-text-accent { color: var(--color-accent); }
        .themed-text-muted { color: var(--color-text-muted); }
        .themed-input {
            background-color: var(--color-input-bg); border-color: var(--color-input-border);
            color: var(--color-text); transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        .themed-input::placeholder { color: var(--color-text-muted); opacity: 0.7; }
        .themed-input:focus { --tw-ring-color: var(--color-primary); }

        .loader { border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .themed-loader { border: 4px solid var(--color-card-border); border-top: 4px solid var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header-bg-image { 
            background-image: url('https://i.ibb.co/Kjs2bJvq/Image-fx-31.png'); 
            background-size: cover; background-position: center; opacity: 1;
            transition: opacity 1.5s ease-in-out;
        }
        .header-loader-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: white; }

        .accordion-item { border-bottom: 1px solid var(--color-card-border); }
        .accordion-item:last-child { border-bottom: none; }
        .accordion-header {
            width: 100%; text-align: left; padding: 1rem; display: flex; justify-content: space-between; align-items: center; font-weight: 600;
            color: var(--color-text); background-color: transparent; border: none; cursor: pointer; transition: background-color 0.2s;
        }
        .accordion-header:hover { background-color: rgba(0,0,0,0.03); }
        .accordion-content { padding: 1rem; display: none; }
        .accordion-content.open { display: block; }
        .accordion-header .icon { transition: transform 0.3s ease; }
        .accordion-header.active .icon { transform: rotate(180deg); }

        .refine-container { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-card-border); }
        
        .card-grid-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem; margin-top: 1rem; padding: 0.5rem; border-radius: 8px;
            background: rgba(0,0,0,0.02);
        }
        .grid-card-selector {
            background-color: white; border: 1px solid var(--color-card-border);
            border-radius: 8px; padding: 1rem; text-align: center;
            cursor: pointer; transition: all 0.2s ease; font-size: 0.875rem; font-weight: 500;
            display: flex; flex-direction: column; justify-content: space-between; height: 100%;
        }
        .grid-card-selector:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .grid-card-selector.active {
            background-color: var(--color-accent); color: var(--color-button-text); border-color: var(--color-primary-dark);
        }
        .grid-card-selector .icon { margin-bottom: 0.5rem; }
        .grid-card-selector svg { width: 2.5rem; height: 2.5rem; margin: 0 auto; display: block; }
        .grid-card-selector.active small { color: rgba(255, 255, 255, 0.8); }

    </style>
</head>
<body class="p-4 md:p-8">
    
    <!-- All Modals -->
     <div id="apiKeyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="card p-8 w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4 themed-text-primary">Enter Your API Key</h2>
            <p class="mb-6 themed-text-muted">To use the AI generators, please provide your API key. This key is stored only in your browser for this session. You can click the "AI Help" button to learn more without a key.</p>
            <form id="apiKeyForm">
                <input type="password" id="apiKeyInput" class="w-full px-4 py-2 themed-input border rounded-lg focus:ring-2" placeholder="Your API Key" required>
                <button type="submit" class="w-full btn-primary mt-6">Save Key and Start</button>
            </form>
        </div>
    </div>
    <div id="loadingStateModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="card p-8 w-full max-w-md m-4 text-center">
            <h2 class="text-2xl font-bold mb-4 themed-text-primary">Waking up the AI...</h2>
            <div class="flex justify-center my-4"><div class="loader themed-loader"></div></div>
            <p id="loading-message" class="mb-6 themed-text-muted">The AI is generating the initial content and guides. This may take a few moments.</p>
            <button id="closeLoadingStateModal" class="btn-secondary">Close</button>
        </div>
    </div>
    <div id="inDepthModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-3xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 id="inDepthModalTitle" class="text-2xl font-bold themed-text-primary">In-Depth Guide</h2>
                <button id="closeInDepthModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="inDepthModalContent" class="p-6 overflow-y-auto prose max-w-none"></div>
            <div id="inDepthModalFooter" class="p-4 border-t flex flex-wrap gap-2" style="border-color: var(--color-card-border);"></div>
        </div>
    </div>
    <div id="themeGeneratorModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-lg m-4 flex flex-col">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 class="text-2xl font-bold themed-text-primary">AI Visual Theme Generator</h2>
                <button id="closeThemeGeneratorModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div class="p-6">
                <p class="mb-6 themed-text-muted">Describe a mood or concept to create a new color palette and header image for the app.</p>
                <textarea id="theme-prompt" rows="3" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'Modern data center at dusk'"></textarea>
                <button id="generate-theme-btn" class="btn-primary w-full mt-4" title="Generate new app visuals based on your text">Generate Visuals</button>
                <div id="theme-loader-container" class="hidden mt-4 flex items-center space-x-3">
                    <div class="loader themed-loader" style="width:25px; height:25px;"></div>
                    <span class="themed-text-muted">AI is generating colors & image...</span>
                </div>
                <div id="theme-error-container" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>
            </div>
        </div>
    </div>
    <div id="geminiSearchModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-3xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 id="geminiSearchModalTitle" class="text-2xl font-bold themed-text-primary">Gemini Search Results</h2>
                <button id="closeGeminiSearchModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="geminiSearchModalContent" class="p-6 overflow-y-auto prose max-w-none"></div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto">
        <header class="relative text-center mb-10 rounded-2xl overflow-hidden shadow-lg">
            <div id="header-loader" class="hidden absolute inset-0 bg-black bg-opacity-50 flex-col items-center justify-center z-20 transition-opacity duration-500">
                <div class="loader header-loader-spinner"></div>
                <p class="text-white mt-4 text-lg">Generating new header image...</p>
            </div>
            <div id="header-bg-image" class="absolute inset-0 header-bg-image"></div>
            <div class="absolute inset-0 bg-black opacity-40"></div>
            <div class="relative z-10 py-24 px-12 text-white">
                 <h1 class="text-4xl md:text-5xl font-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.6);">IT Administration Hub</h1>
                <p class="text-lg text-purple-200 mt-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.6);">AI-powered guides and task generation for IT professionals.</p>
            </div>
            <!-- DEV NOTE: Remember to increment the version number with each significant change. -->
            <div id="version-display" class="absolute bottom-2 right-4 text-white text-xs opacity-70">v1.7</div>
        </header>

        <nav id="jump-to-nav-container" class="hidden text-center mb-8"></nav>

        <main id="main-content" class="space-y-8">
            
            <div id="custom-plan-card" class="card">
                <div class="p-8 card-content">
                    <h2 class="text-2xl font-bold mb-2 themed-text-primary">Custom Task Generator</h2>
                    <p class="mb-6 themed-text-muted">Need a guide for a specific task? Enter any keyword or concept, and let AI craft a step-by-step plan for you.</p>
                    <form id="gemini-form">
                        <input type="text" id="gemini-prompt" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'Configure a new firewall rule'">
                        
                        <div class="my-4 border rounded-lg" style="border-color: var(--color-card-border);">
                            <div class="accordion-item">
                                <button type="button" class="accordion-header" title="Click to see more options">
                                    <span>Tailor Your Guide:</span>
                                    <svg class="icon w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div class="accordion-content">
                                    <div id="tailoring-buttons-container" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary w-full mt-4" title="Generate a custom guide based on your text">Generate AI Guide</button>
                    </form>
                    <div id="gemini-result-container" class="mt-6"></div>
                </div>
            </div>

            <div id="main-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- All cards below will be generated by AI -->
            </div>
            
            <div id="discover-more-container" class="text-center py-8">
                 <button id="discover-more-button" class="btn-primary px-8 py-4 text-lg" title="Generate a new random IT category">
                    <span class="flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v2.5"/><path d="M12 22v-2.5"/><path d="M21.5 12.5h-2.5"/><path d="M4.5 12.5h2.5"/><path d="M18.89 6.11l-1.77 1.77"/><path d="M6.88 18.88l-1.77 1.77"/></svg>
                        Discover More IT Topics
                    </span>
                </button>
                <p id="discover-more-error" class="text-red-500 mt-2"></p>
            </div>
        </main>
    </div>

    <!-- Floating Action Buttons -->
    <button id="theme-changer-button" class="floating-action-button" title="Change Visual Theme">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l.34.34a8 8 0 0111.32 11.32l-.34.34a8 8 0 01-11.32-11.32l.34-.34z"/><path d="M16 12l-4.5 4.5-2.5-2.5"/><path d="M22 12s-4-8-10-8S2 12 2 12s4 8 10 8 10-8 10-8z"/></svg>
    </button>
    <button id="ai-help-button" class="floating-action-button" title="AI Help & Feedback">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"/><path d="M12 22A10 10 0 1 0 12 2a10 10 0 0 0 0 20z"/></svg>
    </button>
    <button id="settings-button" class="floating-action-button" title="Typography Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
    </button>
    <button id="new-plan-button" class="floating-action-button" title="New Session (Reload)">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
    </button>
    <button id="scroll-to-top-button" class="floating-action-button hidden" title="Scroll to top">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
    </button>
    <div id="settings-panel" class="hidden"><h3 class="text-lg font-bold themed-text-accent mb-4">Display Settings</h3><div class="space-y-4"><div><label for="font-family-select" class="block text-sm font-medium themed-text-muted mb-1">Font Family</label><select id="font-family-select" class="w-full p-2 themed-input border rounded-lg"></select></div><div><label for="font-size-select" class="block text-sm font-medium themed-text-muted mb-1">Font Size (px)</label><select id="font-size-select" class="w-full p-2 themed-input border rounded-lg"></select></div><div><label for="line-height-select" class="block text-sm font-medium themed-text-muted mb-1">Line Spacing</label><select id="line-height-select" class="w-full p-2 themed-input border rounded-lg"></select></div></div></div>

    <footer class="mt-16 py-8 text-center border-t" style="border-color: var(--color-card-border);">
        <div class="max-w-4xl mx-auto px-4">
            <p class="themed-text-muted font-semibold">Disclaimer</p>
            <p class="themed-text-muted text-sm mt-2">
                This application and its content are for informational and educational purposes only. The administrative guides and suggestions generated by AI are not a substitute for professional IT advice, vendor documentation, or certified training. Always test procedures in a non-production environment before applying them to live systems. Never disregard official documentation or professional advice because of something you have read on this application. The creators of this application are not responsible for any data loss, system downtime, or damages that may result from the use of these guides.
            </p>
        </div>
    </footer>


    <script type="module">
        // --- Global State & Configuration ---
        let apiKey = "";
        const root = document.documentElement;
        const allThemeData = {};
        const fullPrompts = {}; 
        let originalGeneratedText = new Map();
        
        // --- App Initialization & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('apiKeyModal').classList.remove('hidden');
            setupEventListeners();
            populateTypographySettings();
        });

        function setupEventListeners() {
            // Main Actions
            document.getElementById('apiKeyForm').addEventListener('submit', handleApiKeySubmit);
            document.getElementById('gemini-form').addEventListener('submit', handleGeminiSubmit);
            document.getElementById('generate-theme-btn').addEventListener('click', handleCustomVisualThemeGeneration);
            document.getElementById('discover-more-button').addEventListener('click', handleDiscoverMoreClick);

            // Floating Action Buttons & Panels
            document.getElementById('new-plan-button').addEventListener('click', () => location.reload());
            document.getElementById('theme-changer-button').addEventListener('click', () => {
                if(!apiKey) {
                    alert('Please enter your API key to use the theme generator.');
                    return;
                }
                document.getElementById('themeGeneratorModal').classList.remove('hidden');
            });
            document.getElementById('ai-help-button').addEventListener('click', handleAIHelpRequest);
            document.getElementById('scroll-to-top-button').addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

            // Settings Panel
            const settingsPanel = document.getElementById('settings-panel');
            document.getElementById('settings-button').addEventListener('click', (e) => {
                e.stopPropagation();
                settingsPanel.classList.toggle('hidden');
            });

            // Typography Selects
            document.getElementById('font-family-select').addEventListener('change', (e) => root.style.setProperty('--font-family', e.target.value));
            document.getElementById('font-size-select').addEventListener('change', (e) => root.style.setProperty('--font-size-base', e.target.value));
            document.getElementById('line-height-select').addEventListener('change', (e) => root.style.setProperty('--line-height-base', e.target.value));
            
            // Modal Closing Listeners
            ['themeGeneratorModal', 'inDepthModal', 'geminiSearchModal', 'loadingStateModal'].forEach(id => {
                 document.getElementById(id).addEventListener('click', (e) => {
                     if (e.target.id === id || e.target.closest('[id^="close"]')) {
                         document.getElementById(id).classList.add('hidden');
                     }
                 });
            });

            // Global Clicks for dynamic content and closing panels
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('copy-code-button')) {
                    const codeBlock = e.target.closest('.code-block-container').querySelector('code');
                    copyElementTextToClipboard(codeBlock, e.target);
                    return;
                }

                const tailorBtn = e.target.closest('#tailoring-buttons-container .btn-toggle');
                if (tailorBtn) {
                    tailorBtn.classList.toggle('active');
                    return;
                }

                const gridSelector = e.target.closest('.grid-card-selector');
                if (gridSelector) {
                    const container = gridSelector.closest('.card-grid-container').parentElement;
                    const currentlyActive = container.querySelector('.grid-card-selector.active');
                    if(currentlyActive) currentlyActive.classList.remove('active');
                    gridSelector.classList.add('active');
                    handleGridSelect(gridSelector);
                    return;
                }

                const exploreBtn = e.target.closest('.explore-button');
                if (exploreBtn) {
                    handleExploreInDepth(exploreBtn.dataset.themeId, exploreBtn.dataset.themeType);
                    return;
                }
                
                const refineBtn = e.target.closest('.refine-button');
                if (refineBtn) {
                    toggleRefineUI(refineBtn.parentElement);
                    return;
                }

                const modalRefineBtn = e.target.closest('.modal-refine-button');
                 if (modalRefineBtn) {
                    toggleRefineUI(modalRefineBtn.parentElement, true);
                    return;
                }
                
                const submitRefineBtn = e.target.closest('.submit-refinement-button');
                if(submitRefineBtn) {
                    handleRefineRequest(submitRefineBtn.closest('.refine-container'));
                    return;
                }
                
                const showAllBtn = e.target.closest('.show-all-button');
                if (showAllBtn) {
                    handleShowAllClick(showAllBtn);
                    return;
                }

                const accordionHeader = e.target.closest('.accordion-header');
                if (accordionHeader) { 
                    accordionHeader.classList.toggle('active'); 
                    accordionHeader.nextElementSibling.classList.toggle('open'); 
                    return;
                }
                
                const jumpToBtn = e.target.closest('.jump-to-button');
                if (jumpToBtn) {
                    const targetCard = document.getElementById(jumpToBtn.dataset.targetId);
                    if (targetCard) {
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'start'});
                        targetCard.style.boxShadow = '0 0 0 4px var(--color-primary)';
                        setTimeout(() => targetCard.style.boxShadow = '', 2000);
                    }
                    return;
                }

                if (!settingsPanel.classList.contains('hidden') && !settingsPanel.contains(e.target) && !e.target.closest('#settings-button')) {
                    settingsPanel.classList.add('hidden');
                }
            });
            
            window.addEventListener('scroll', () => {
                const scrollTopButton = document.getElementById('scroll-to-top-button');
                if (window.scrollY > 300) {
                    scrollTopButton.classList.remove('hidden');
                } else {
                    scrollTopButton.classList.add('hidden');
                }
            });
        }
        
        async function handleApiKeySubmit(e) {
             e.preventDefault();
             const input = document.getElementById('apiKeyInput');
             if (!input.value.trim()) return;
             apiKey = input.value.trim();
             document.getElementById('apiKeyModal').classList.add('hidden');

             const loadingModal = document.getElementById('loadingStateModal');
             const loadingMessageEl = document.getElementById('loading-message');
             loadingMessageEl.textContent = "The AI is generating the initial content and guides. This may take a few moments.";
             loadingModal.classList.remove('hidden');

             const modalMessage = document.querySelector('#apiKeyModal p');
             modalMessage.textContent = 'To use the AI generators, please provide your API key...';
             modalMessage.classList.remove('text-red-600', 'font-bold');
             document.getElementById('main-grid').innerHTML = '';
             document.getElementById('jump-to-nav-container').innerHTML = '';
             document.getElementById('gemini-result-container').innerHTML = '';
             document.getElementById('discover-more-error').innerHTML = '';

             try {
                 await generateAndApplyDefaultTheme();
                 await loadAppContent(loadingMessageEl);
             } catch (error) {
                 console.error("A critical error occurred during app initialization:", error.message);
                if (document.getElementById('apiKeyModal').classList.contains('hidden')) {
                    modalMessage.textContent = 'An error occurred during setup. Some content may have failed to load. Please check your API key and connection.';
                    modalMessage.classList.add('text-red-600', 'font-bold');
                    document.getElementById('apiKeyModal').classList.remove('hidden');
                }
             } finally {
                 loadingModal.classList.add('hidden');
             }
        }

        async function loadAppContent(loadingMessageEl) {
            try {
                const categoriesToGenerate = [
                    { 
                        key: 'vmwareEsxi', 
                        title: 'VMware ESXi Administration', 
                        description: "Guides and best practices for managing VMware ESXi environments.", 
                        initialPrompt: `Generate 10 common administrative tasks for VMware ESXi. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for VMware ESXi. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'windowsServer', 
                        title: 'Windows Server Administration', 
                        description: "Essential tasks for managing Windows Server instances.", 
                        initialPrompt: `Generate 10 common administrative tasks for Windows Server. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for Windows Server. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'm365Admin', 
                        title: 'Microsoft 365 Administration', 
                        description: "Administering users, services, and security in Microsoft 365.", 
                        initialPrompt: `Generate 10 common administrative tasks for Microsoft 365. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for Microsoft 365. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'citrixAdmin', 
                        title: 'Citrix Administration', 
                        description: "Managing Citrix Virtual Apps and Desktops environments.", 
                        initialPrompt: `Generate 10 common administrative tasks for Citrix. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for Citrix. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    }
                ];

                await Promise.allSettled([loadAITailoringOptions(), loadDynamicPlaceholders()]);
                
                const generationPromises = categoriesToGenerate.map(cat => {
                    if (loadingMessageEl) loadingMessageEl.textContent = `Generating guides for: ${cat.title}...`;
                    return generateAndPopulateAICategory(cat).catch(e => {
                        console.error(`Failed to load category: ${cat.title}`, e);
                        return { key: cat.key, error: e };
                    });
                });

                const results = await Promise.all(generationPromises);
                const firstFailure = results.find(r => r && r.error);
                if(firstFailure){
                   throw new Error(`One or more AI content categories failed to load, starting with ${firstFailure.key}. The process has been stopped.`);
                }
                
                if (loadingMessageEl) loadingMessageEl.textContent = `Building navigation...`;
                await generateJumpToButtons();

            } catch (error) {
                console.error("An error occurred while loading app content:", error.message);
                throw error;
            }
        }
        
        async function generateAndPopulateAICategory({key, title, description, initialPrompt, fullPrompt}) {
            const mainGrid = document.getElementById('main-grid');
            const card = document.createElement('div');
            card.className = 'card md:col-span-2';
            card.id = `${key}-card`;
            const selectorId = `${key}-selector-visual`;
            card.innerHTML = `<div class="p-8 card-content"><h2 class="text-2xl font-bold mb-2 themed-text-primary">${title}</h2><p class="mb-6 themed-text-muted">${description}</p><div id="${selectorId}" class="w-full">${getLoaderHTML(`AI is generating guides for ${title}...`)}</div><div id="${key}-details" class="details-container prose max-w-none mt-4"></div></div>`;
            mainGrid.appendChild(card);
            
            fullPrompts[key] = fullPrompt;

            try {
                const jsonText = await callGeminiAPI(initialPrompt, true);
                if (!jsonText) throw new Error(`API returned empty content for ${title}.`);
                
                const data = parseJsonWithCorrections(jsonText);
                allThemeData[key] = data;
                populateCardGridSelector(selectorId, key);
            } catch (error) {
                handleApiError(error, document.getElementById(selectorId), title, card);
                throw error;
            }
        }
        
        function populateCardGridSelector(containerId, themeType) {
            const container = document.getElementById(containerId);
            const data = allThemeData[themeType];
            if (!container || !data || !Array.isArray(data)) {
                if (container) container.innerHTML = `<p class="themed-text-muted">No items to display.</p>`;
                return;
            }

            const gridClass = 'card-grid-container';

            const itemsHtml = data.map(item => {
                return `
                <div class="grid-card-selector" data-theme-id="${item.id}" data-theme-type="${themeType}" title="${item.description || ''}">
                    <div class="icon">${getIconForTheme(themeType, item.id)}</div>
                    <div class="mt-2">
                        <strong class="text-sm leading-tight block">${item.title}</strong>
                    </div>
                </div>`;
            }).join('');
            
            const fullPrompt = fullPrompts[themeType];
            let showAllButtonHtml = '';
            
            if (fullPrompt && data.length < 35 && data.length > 0) {
                 showAllButtonHtml = `
                    <div class="col-span-full text-center mt-4">
                        <button class="show-all-button btn-secondary" data-container-id="${containerId}" data-theme-type="${themeType}">
                            Show All (${data.length} of ~50 shown)
                        </button>
                    </div>`;
            }

            container.innerHTML = `<div class="${gridClass}">${itemsHtml}</div>${showAllButtonHtml}`;
        }
        
        async function handleShowAllClick(button) {
            const { containerId, themeType } = button.dataset;
            const container = document.getElementById(containerId);
            const fullPrompt = fullPrompts[themeType];

            if (!container || !fullPrompt) return;

            button.disabled = true;
            button.innerHTML = `<span class="flex items-center justify-center gap-2"><div class="loader themed-loader" style="width:20px; height:20px; border-width: 2px;"></div>Loading all...</span>`;

            try {
                const jsonText = await callGeminiAPI(fullPrompt, true);
                if (!jsonText) throw new Error(`API returned empty content for ${themeType} (full list).`);
                allThemeData[themeType] = parseJsonWithCorrections(jsonText);
                populateCardGridSelector(containerId, themeType);
                document.getElementById(`${themeType}-details`).innerHTML = '';
            } catch (error) {
                button.disabled = false;
                button.classList.add('bg-red-100', 'text-red-700');
                button.textContent = "Error. Try again.";
                console.error(`Error loading full list for ${themeType}:`, error);
            }
        }

        async function handleGridSelect(target) {
            const { themeId, themeType } = target.dataset;
            const item = allThemeData[themeType]?.find(d => String(d.id) == String(themeId));
            if (!item) {
                console.error("Could not find theme item for:", {themeId, themeType});
                return;
            }
            
            const prompt = `Generate a very brief, condensed summary for an IT administration guide on the topic: "${item.title}". For each section (Objective, Pre-requisites, Key Steps, Verification, Helpful Resources), provide a single descriptive sentence. Return the response as a simple markdown string where each section is a bullet point, starting with '*'.`;
            
            const resultContainer = document.getElementById(`${themeType}-details`);
            resultContainer.innerHTML = getLoaderHTML(`Generating summary for ${item.title}...`);

            try {
                const resultText = await callGeminiAPI(prompt);
                originalGeneratedText.set(themeId, resultText); 
                resultContainer.innerHTML = robustMarkdownToHtml(resultText, true);
                addPostGenerationButtons(resultContainer, themeId, themeType);
            } catch (error) {
                handleApiError(error, resultContainer, `guide for ${item.title}`);
            }
        }

        async function handleGeminiSubmit(e) {
            e.preventDefault();
            const promptInput = document.getElementById('gemini-prompt');
            let userPrompt = promptInput.value.trim();
            if (!userPrompt) return;

            const selectedOptions = Array.from(document.querySelectorAll('#tailoring-buttons-container .btn-toggle.active'))
                                         .map(btn => btn.textContent.trim())
                                         .join(', ');

            const prompt = getEnhancedPrompt(userPrompt, selectedOptions);

            const resultContainer = document.getElementById('gemini-result-container');
            resultContainer.innerHTML = getLoaderHTML('Generating your custom AI guide...');

            try {
                const resultText = await callGeminiAPI(prompt);
                
                originalGeneratedText.set('custom-plan', resultText);
                createAccordionFromMarkdown(resultText, resultContainer);
                addPostGenerationButtons(resultContainer, 'custom-plan', 'custom');

            } catch(error) {
                handleApiError(error, resultContainer, 'custom IT guide');
            }
        }

        function parseJsonWithCorrections(jsonString) {
            if (!jsonString || typeof jsonString !== 'string') {
                throw new Error("Invalid input: not a string.");
            }
            let cleanedString = jsonString.replace(/```(json|markdown)?\n?/g, '').replace(/```/g, '').trim();
            cleanedString = cleanedString.replace(/,\s*(}|])/g, '$1');

            try {
                return JSON.parse(cleanedString);
            } catch (error) {
                console.error("Failed to parse JSON even after cleaning:", error);
                console.error("Original string:", jsonString);
                console.error("Cleaned string:", cleanedString);
                throw new Error(`JSON Parse Error: ${error.message}. Check console for the problematic string.`);
            }
        }

        async function callApi(apiUrl, payload) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000);

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    let errorBody;
                    try { errorBody = await response.json(); } catch { errorBody = await response.text(); }
                    console.error("API Error Response:", errorBody);
                    const errorMsg = errorBody?.error?.message || response.statusText;
                    throw new Error(`API request failed with status ${response.status}. Message: ${errorMsg}`);
                }
                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') throw new Error('The AI service request timed out. Please try again.');
                throw error;
            }
        }

        async function callGeminiAPI(prompt, isJson = false) {
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            if (isJson) {
                payload.generationConfig = { responseMimeType: "application/json", maxOutputTokens: 8192 };
            }
            const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, payload);
            return result?.candidates?.[0]?.content?.parts?.[0]?.text || null;
        }

        async function callImageGenAPI(prompt) {
             const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
             const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`, payload);
             const base64 = result?.predictions?.[0]?.bytesBase64Encoded;
             return base64 ? `data:image/png;base64,${base64}` : null;
        }
        
        async function callColorGenAPI(prompt) {
             const fullPrompt = `Based on the theme "${prompt}", generate a color palette. I need a JSON object with keys: "bg", "text", "primary", "primaryDark", "accent", "cardBg", "cardBorder", "textMuted", "inputBg", "inputBorder", "buttonText". Determine if the "primary" color is light or dark to set the "buttonText" appropriately (#FFFFFF for dark, #111827 for light). Return only the complete, valid JSON.`;
             const jsonText = await callGeminiAPI(fullPrompt, true);
             if (jsonText) return parseJsonWithCorrections(jsonText);
             throw new Error("Could not parse a valid color theme from API response.");
        }

        function handleApiError(error, container, contentType = 'content') {
            console.error(`Error generating ${contentType}:`, error);
            const errorMessage = generateErrorMessage(error, contentType);
            if (container) {
                container.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">${errorMessage}</div>`;
            }
        }
        
        async function generateAndApplyDefaultTheme() {
            showThemeLoading(true);
            const themePrompt = "Modern Data Center";
            const imagePrompt = `Artistic, abstract background image inspired by "${themePrompt}". Suitable for an IT administration website. Professional, clean. Wide aspect ratio, photographic, cinematic lighting.`;
            try {
                const [colorResult, imageResult] = await Promise.allSettled([callColorGenAPI(themePrompt), callImageGenAPI(imagePrompt)]);
                
                if (colorResult.status === 'fulfilled' && colorResult.value) applyTheme(colorResult.value);
                else throw colorResult.reason || new Error("Failed to generate color theme.");

                if (imageResult.status === 'fulfilled' && imageResult.value) applyHeaderImage(imageResult.value);
                else throw imageResult.reason || new Error("Failed to generate header image.");

            } catch (error) {
                 handleApiError(null, null, 'default theme');
                 throw error;
            } finally {
                showThemeLoading(false);
            }
        }
        
        async function loadAITailoringOptions() {
            const container = document.getElementById('tailoring-buttons-container');
            container.innerHTML = getLoaderHTML('Loading options...');
            try {
                const hardcodedOptions = ["Security Hardening", "Performance Tuning", "Automation Script", "Backup & Recovery", "User Management", "Monitoring", "Troubleshooting", "For Beginners", "PowerShell", "Command Line", "GUI Steps"];
                populateTailoringButtons(hardcodedOptions);
            } catch (error) {
                handleApiError(error, container, 'tailoring options');
            }
        }

        function populateTailoringButtons(options) {
            const container = document.getElementById('tailoring-buttons-container');
            container.innerHTML = options.map(option =>
                `<button type="button" class="btn-toggle text-sm px-3 py-1 rounded-full">${option}</button>`
            ).join('');
        }
        
        async function loadDynamicPlaceholders() {
            const promptInput = document.getElementById('gemini-prompt');
            const prompt = `Generate a JSON array of 3 creative IT administration task ideas for input placeholders. Examples: "Onboard a new employee", "Decommission a legacy server". Return ONLY the valid JSON array of strings.`;
            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if(!jsonText) return;
                const placeholders = parseJsonWithCorrections(jsonText);
                if (placeholders && placeholders.length > 0) {
                    let i = 0;
                    promptInput.placeholder = `e.g., '${placeholders[i]}'`;
                    setInterval(() => {
                        i = (i + 1) % placeholders.length;
                        promptInput.placeholder = `e.g., '${placeholders[i]}'`;
                    }, 3000);
                }
            } catch(error) {
                console.error("Could not load dynamic placeholders", error);
            }
        }

        function applyTheme(colors) {
            Object.entries(colors).forEach(([key, value]) => {
                const cssVar = `--color-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                root.style.setProperty(cssVar, value);
            });
        }
        
        function applyHeaderImage(imageUrl) {
            const bgImageDiv = document.getElementById('header-bg-image');
            bgImageDiv.style.backgroundImage = `url('${imageUrl}')`;
        }

        function showThemeLoading(isLoading) {
            const loader = document.getElementById('header-loader');
            loader.classList.toggle('hidden', !isLoading);
            loader.classList.toggle('flex', isLoading);
        }
        
        // DEV NOTE: This function defines the master prompt for generating detailed guides.
        // It's designed to be flexible for both new content and user-requested refinements.
        function getEnhancedPrompt(task, options = '', originalText = '') {
            const optionsText = options ? `With a special focus on these elements: ${options}.` : '';
            
            // This logic block handles refinements of existing text.
            if (originalText) {
                return `You are an expert senior IT administrator AI. A user has provided an IT guide and a request to refine it. Your task is to rewrite the entire guide to incorporate the user's request, structuring the new guide into the most logical sections possible.

**ORIGINAL IT GUIDE:**
---
${originalText}
---

**USER'S REFINEMENT REQUEST:**
"${task}"

**Instructions for rewriting:**
1.  **Structure:** Do not use the old section headers unless they are still the most logical choice. Instead, create new, clear, and descriptive section headers using '###' markdown syntax based on the refined content.
2.  **Integrate:** Seamlessly integrate the user's request into the guide.
3.  **Quality Standards:** The entire rewritten guide must still meet these requirements for the specific technology being discussed:
    * **Authoritative Links:** Embed hyperlinks to official vendor documentation, relevant articles, or other authoritative sources.
    * **Code Blocks:** When providing code examples, wrap them in markdown code fences with the language specified (e.g., \`\`\`powershell\`).
    * **Screenshot Placeholders:** Include placeholders for screenshots where visual context is beneficial, using the format: [Screenshot: A clear description of what the screenshot should show].
    * **Practicality:** Ensure all advice, steps, and examples are practical and reflect real-world scenarios.
    * **Helpful Resources:** Ensure there is a final section with a bulleted list of high-quality, relevant links.

Return only the new, complete, and rewritten markdown guide.`;
            }

            // This is the prompt for generating new content from scratch.
            return `You are an expert senior IT administrator AI. Generate a comprehensive and practical guide for the task: "${task}". ${optionsText}

Your task is to structure this guide into the most logical and helpful sections. For each section, create a clear and descriptive header using '###' markdown syntax. The content within each section should be detailed and practical.

When generating the guide, ensure the guide as a whole meets the following requirements for the specific technology being discussed:

1.  **Authoritative Links:** Throughout the guide, embed hyperlinks to official vendor documentation, relevant articles, or other authoritative sources.
2.  **Code Blocks:** When providing code examples (like PowerShell), wrap them in markdown code fences with the language specified, like \`\`\`powershell... \`\`\`.
3.  **Prerequisites:** Create a dedicated "Prerequisites" section that details relevant administrative roles, permissions, and any specific licensing requirements.
4.  **Verification:** Include a section on how to verify the task was successful, mentioning practical, real-world details (e.g., specific logs to check).
5.  **Troubleshooting:** Include a section covering common problems that administrators face.
6.  **Helpful Resources:** Include a final section with a bulleted list of high-quality, relevant links to official documentation, tutorials, or tools.
7.  **Screenshot Placeholders:** In the 'Step-by-Step Guide' or equivalent section, include placeholders for screenshots where visual context would be beneficial. Use the format: [Screenshot: A clear description of what the screenshot should show].

Return only the complete markdown guide.`;
        }

        function robustMarkdownToHtml(text, isCondensed = false) {
            if (!text) return '<p class="themed-text-muted">No content received from AI. Please try a different prompt.</p>';
            
            // First, handle and extract fenced code blocks
            const codeBlocks = [];
            let cleanText = text.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
                const placeholder = `__CODEBLOCK_${codeBlocks.length}__`;
                codeBlocks.push({ lang: lang || 'text', code: code.trim() });
                return placeholder;
            });

            // Process the rest of the markdown
            if (isCondensed) {
                 let listItems = cleanText
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line.startsWith('*'))
                    .map(line => {
                        line = line.substring(1).trim()
                                   .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                   .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
                                   .replace(/\*(.*?)\*/g, '<em>$1</em>');
                        return `<li>${line}</li>`;
                    }).join('');
                return `<ul>${listItems}</ul>`;
            }

            let html = cleanText
                .replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\[Screenshot: (.*?)\]/g, '<div class="screenshot-placeholder">$1</div>')
                .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
                .replace(/^\s*\n/gm, '<br>');
            
            const lines = html.split('<br>');
            let resultHtml = '';
            let inList = false;
            let listTag = '';

            lines.forEach(line => {
                line = line.trim();
                const isOl = line.match(/^\d+\. /);
                const isUl = line.startsWith('* ');

                if (isOl || isUl) {
                    const currentListTag = isOl ? 'ol' : 'ul';
                    if (!inList || listTag !== currentListTag) {
                        if (inList) resultHtml += `</${listTag}>`;
                        inList = true;
                        listTag = currentListTag;
                        resultHtml += `<${listTag}>`;
                    }
                    const itemContent = line.replace(/^\d+\. |^\* /, '');
                    resultHtml += `<li>${itemContent}</li>`;
                } else {
                    if (inList) {
                        resultHtml += `</${listTag}>`;
                        inList = false;
                    }
                     if (line.startsWith('<h3') || line.startsWith('<div')) {
                        resultHtml += line;
                    } else if (line) {
                         resultHtml += `<p>${line}</p>`;
                    }
                }
            });
            if (inList) resultHtml += `</${listTag}>`;

            // Re-insert the formatted code blocks
            codeBlocks.forEach((block, index) => {
                const codeHtml = `<div class="code-block-container">
                    <div class="code-block-header">
                        <span>${block.lang}</span>
                        <button class="copy-code-button">Copy</button>
                    </div>
                    <pre><code class="language-${block.lang}">${block.code.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code></pre>
                </div>`;
                resultHtml = resultHtml.replace(`__CODEBLOCK_${index}__`, codeHtml);
            });
            
            return resultHtml.replace(/<p><h3>/g, '<h3>').replace(/<\/h3><\/p>/g, '</h3>')
                           .replace(/<p><div class="code-block-container">/g, '<div class="code-block-container">')
                           .replace(/<\/div><\/p>/g, '</div>');
        }

        function addPostGenerationButtons(container, themeId, themeType) {
            let buttonBar = container.querySelector('.button-bar');
            if (buttonBar) buttonBar.remove();

            buttonBar = document.createElement('div');
            buttonBar.className = 'button-bar flex flex-wrap gap-2 mt-4 pt-4 border-t';
            buttonBar.style.borderColor = 'var(--color-card-border)';
            buttonBar.innerHTML = `
                <button class="btn-secondary text-sm refine-button">Refine with AI</button>
                <button class="btn-secondary text-sm copy-button">Copy Text</button>
                <button class="btn-secondary text-sm explore-button" data-theme-id="${themeId}" data-theme-type="${themeType}">Explore In-Depth</button>
            `;
            container.appendChild(buttonBar);
            buttonBar.querySelector('.copy-button').addEventListener('click', e => {
                 const contentToCopy = e.target.closest('.details-container, #gemini-result-container');
                 if(contentToCopy) copyElementTextToClipboard(contentToCopy, e.target);
            });
        }

        async function handleDiscoverMoreClick() {
            const button = document.getElementById('discover-more-button');
            const errorP = document.getElementById('discover-more-error');
            errorP.textContent = '';
            button.disabled = true;

            const existingTitles = Array.from(document.querySelectorAll('#main-grid h2')).map(h2 => h2.textContent);
            const prompt = `Generate 1 new, useful IT administration category NOT on this list: ${existingTitles.join(', ')}. Provide a "key" (camelCase, unique), "title", "description", an "initialPrompt" (for 10 items), and a "fullPrompt" (for 40-50). Prompts must request a JSON array of objects, each with id, title, and description. Return ONLY a valid JSON object.`;

            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if (!jsonText) throw new Error("AI did not return a new category.");
                const newCategory = parseJsonWithCorrections(jsonText);
                await generateAndPopulateAICategory(newCategory);
                await generateJumpToButtons();
            } catch (error) {
                console.error("Failed to discover more topics:", error);
                errorP.textContent = "Sorry, couldn't generate a new topic right now.";
            } finally {
                button.disabled = false;
            }
        }
        
        async function handleCustomVisualThemeGeneration() {
            const prompt = document.getElementById('theme-prompt').value;
            if(!prompt) return;

            const loader = document.getElementById('theme-loader-container');
            const errorContainer = document.getElementById('theme-error-container');
            const generateBtn = document.getElementById('generate-theme-btn');
            
            loader.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            generateBtn.disabled = true;

            try {
                const imagePrompt = `Artistic, abstract background image inspired by "${prompt}". Suitable for an IT website. Professional, clean. Wide aspect ratio, photographic, cinematic lighting.`;
                const [colorResult, imageResult] = await Promise.allSettled([callColorGenAPI(prompt), callImageGenAPI(imagePrompt)]);
                
                if (colorResult.status === 'fulfilled' && colorResult.value) applyTheme(colorResult.value);
                else throw colorResult.reason || new Error("Failed to generate color theme.");

                if (imageResult.status === 'fulfilled' && imageResult.value) applyHeaderImage(imageResult.value);
                else throw imageResult.reason || new Error("Failed to generate header image.");
                
                document.getElementById('themeGeneratorModal').classList.add('hidden');
            } catch (error) {
                showThemeError(error.message);
            } finally {
                loader.classList.add('hidden');
                generateBtn.disabled = false;
            }
        }
        
        function showThemeError(message) {
            const errorContainer = document.getElementById('theme-error-container');
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        async function generateJumpToButtons() {
            const container = document.getElementById('jump-to-nav-container');
            const cards = Array.from(document.querySelectorAll('#custom-plan-card, #main-grid .card'));
            if (cards.length <= 1) return;

            const cardData = cards.map(card => ({
                id: card.id,
                title: card.querySelector('h2')?.textContent
            })).filter(c => c.id && c.title);
            
            if (cardData.length === 0) return;
        
            const prompt = `For the following IT category titles, generate a very short, engaging label (1-2 words). Return a valid JSON object where keys are the original titles and values are the short labels. Titles: ${JSON.stringify(cardData.map(c => c.title))}`;
            
            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if (!jsonText) throw new Error("AI returned empty data for jump-to buttons.");
                
                const labels = parseJsonWithCorrections(jsonText);
                const buttonsHtml = cardData.map(card => {
                    const label = labels[card.title] || card.title.split(' ')[0];
                    return `<button class="jump-to-button" data-target-id="${card.id}">${label}</button>`;
                }).join('');

                container.innerHTML = `<div class="flex flex-wrap gap-2 justify-center">${buttonsHtml}</div>`;
                container.classList.remove('hidden');
            } catch (error) {
                console.error("Failed to generate jump-to buttons:", error);
                container.innerHTML = '';
                container.classList.add('hidden'); 
            }
        }

        function populateTypographySettings() {
            const fontSelect = document.getElementById('font-family-select');
            const sizeSelect = document.getElementById('font-size-select');
            const lineHeightSelect = document.getElementById('line-height-select');
            
            const fonts = { 'Default (Inter)': "'Inter', sans-serif", 'Lato': "'Lato', sans-serif", 'Montserrat': "'Montserrat', sans-serif", 'Nunito Sans': "'Nunito Sans', sans-serif", 'Open Sans': "'Open Sans', sans-serif", 'Poppins': "'Poppins', sans-serif", 'Roboto Slab': "'Roboto Slab', serif" };
            const sizes = { '14': '14px', '15': '15px', '16 (Default)': '16px', '17': '17px', '18': '18px' };
            const lineHeights = { '1.4': '1.4', '1.5 (Default)': '1.5', '1.6': '1.6', '1.7': '1.7', '1.8': '1.8' };

            Object.entries(fonts).forEach(([name, value]) => fontSelect.add(new Option(name, value)));
            Object.entries(sizes).forEach(([name, value]) => sizeSelect.add(new Option(name, value)));
            Object.entries(lineHeights).forEach(([name, value]) => lineHeightSelect.add(new Option(name, value)));

            fontSelect.value = fonts['Default (Inter)'];
            sizeSelect.value = '16px';
            lineHeightSelect.value = '1.5';
            
            root.style.setProperty('--font-family', fontSelect.value);
            root.style.setProperty('--font-size-base', sizeSelect.value);
            root.style.setProperty('--line-height-base', lineHeightSelect.value);
        }

        function copyElementTextToClipboard(element, button) {
            const textToCopy = element.innerText;
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed'; 
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => { button.textContent = originalText; }, 2000);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textarea);
        }

        function createAccordionFromMarkdown(markdownText, containerElement) {
            containerElement.innerHTML = ''; 
            if (!markdownText) {
                containerElement.innerHTML = robustMarkdownToHtml(null);
                return;
            }
            const sections = markdownText.split(/(?=###)/);

            sections.forEach((sectionText, index) => {
                if (!sectionText.trim()) return;
                
                const firstLineEnd = sectionText.indexOf('\n');
                let title = sectionText.replace(/### /g, '').trim();
                let content = '';

                if (firstLineEnd !== -1) {
                    title = sectionText.substring(0, firstLineEnd).replace(/### /g, '').trim();
                    content = sectionText.substring(firstLineEnd + 1).trim();
                }

                const accordionItem = document.createElement('div');
                accordionItem.className = 'accordion-item';
                
                const contentHtml = robustMarkdownToHtml(content);

                accordionItem.innerHTML = `
                    <button type="button" class="accordion-header">
                        <span class="text-left">${title}</span>
                        <svg class="icon w-5 h-5 transition-transform shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="accordion-content">${contentHtml}</div>
                `;
                containerElement.appendChild(accordionItem);

                if (index === 0) {
                    accordionItem.querySelector('.accordion-header').classList.add('active');
                    accordionItem.querySelector('.accordion-content').classList.add('open');
                }
            });
        }
        
        function handleAIHelpRequest() {
            const modal = document.getElementById('inDepthModal');
            const titleEl = document.getElementById('inDepthModalTitle');
            const contentEl = document.getElementById('inDepthModalContent');
            const footerEl = document.getElementById('inDepthModalFooter');

            titleEl.textContent = "AI Help & Feedback";
            footerEl.innerHTML = '';
            modal.classList.remove('hidden');

            const tutorialMarkdown = `
### Custom Guide Generator
This is the heart of the app! Enter any IT task, technology, or problem into the main text box (e.g., "Set up a new VLAN" or "Troubleshoot Active Directory replication"). The AI will then craft a complete, step-by-step guide for you from scratch.

### AI-Powered Options
Just below the main prompt box, you'll find "Tailor Your Guide" buttons. Click the dropdown to reveal options like "Security Hardening," "For Beginners," or "PowerShell Script." You can select multiple options to give the AI more specific instructions for your custom guide.

### Pre-Built Categories
Scroll down to explore a wide range of pre-built, AI-generated categories for major platforms like VMware, Windows Server, and Microsoft 365. Click on any item within a category to get a quick summary guide.

### Visual Theme Generator
Want to change the app's look and feel? Click the floating button with the eye icon. This opens the AI Visual Theme Generator. Type in a descriptive phrase like "Blue server room" or "Cloud infrastructure," and the AI will generate a brand new color palette and header image for the entire app.

### In-Depth Exploration
When you see a summary guide that you like, click the "Explore In-Depth" button. This will open a new view where the AI generates a much more detailed, descriptive version of the guide, perfect for complex tasks.

### Refining Content
After any guide is generated, you'll see a "Refine with AI" button. Click this to open a text box where you can give the AI further instructions. For example, you could type "Make it for a junior admin," "Add PowerShell examples," or "Include troubleshooting steps for error code X." The AI will then rewrite the guide based on your feedback.
`;
            createAccordionFromMarkdown(tutorialMarkdown, contentEl);
        }
        
        async function handleExploreInDepth(themeId, themeType) {
            const item = allThemeData[themeType]?.find(d => String(d.id) === String(themeId));
            if (!item) {
                console.error("Could not find item for in-depth view", {themeId, themeType});
                return;
            }

            const modal = document.getElementById('inDepthModal');
            const titleEl = document.getElementById('inDepthModalTitle');
            const contentEl = document.getElementById('inDepthModalContent');
            const footerEl = document.getElementById('inDepthModalFooter');
            
            titleEl.textContent = `In-Depth: ${item.title}`;
            contentEl.innerHTML = getLoaderHTML(`Generating detailed guide for ${item.title}...`);
            footerEl.innerHTML = '';
            footerEl.dataset.themeId = themeId;
            footerEl.dataset.themeType = themeType;

            modal.classList.remove('hidden');
            
            const prompt = getEnhancedPrompt(item.title);

            try {
                const resultText = await callGeminiAPI(prompt);
                originalGeneratedText.set(themeId + '-full', resultText); 
                
                createAccordionFromMarkdown(resultText, contentEl);

                footerEl.innerHTML = `
                    <button class="btn-secondary text-sm modal-refine-button">Refine with AI</button>
                    <button class="btn-secondary text-sm modal-copy-button">Copy Text</button>
                `;
                footerEl.querySelector('.modal-copy-button').addEventListener('click', (e) => copyElementTextToClipboard(contentEl, e.currentTarget));

            } catch (error) {
                handleApiError(error, contentEl, 'in-depth content');
            }
        }
        
        function toggleRefineUI(buttonContainer, isModal = false) {
            let refineContainer = buttonContainer.nextElementSibling;
            if (refineContainer && refineContainer.classList.contains('refine-container')) {
                refineContainer.remove();
                return;
            }

            refineContainer = document.createElement('div');
            refineContainer.className = 'refine-container w-full';
            refineContainer.innerHTML = `
                <textarea class="w-full p-2 themed-input border rounded-lg" rows="2" placeholder="e.g., 'Make it for a junior admin' or 'Add PowerShell examples'"></textarea>
                <button class="btn-primary text-sm mt-2 submit-refinement-button" data-is-modal="${isModal}">Submit Refinement</button>
            `;
            buttonContainer.insertAdjacentElement('afterend', refineContainer);
            refineContainer.querySelector('textarea').focus();
        }

        async function handleRefineRequest(refineContainer) {
            const refinementRequest = refineContainer.querySelector('textarea').value;
            if (!refinementRequest) return;

            const isModal = refineContainer.querySelector('.submit-refinement-button').dataset.isModal === 'true';
            
            const contentArea = isModal ? document.getElementById('inDepthModalContent') : refineContainer.closest('.details-container, #gemini-result-container');
            const footerEl = document.getElementById('inDepthModalFooter');
            
            const themeId = isModal ? footerEl.dataset.themeId : contentArea.querySelector('.explore-button')?.dataset.themeId || 'custom-plan';
            const textKey = isModal ? themeId + '-full' : themeId;

            const originalText = originalGeneratedText.get(textKey);

            if (!originalText) {
                handleApiError({message: "Could not find the original text to refine. Please generate the content again first."}, contentArea, "refinement");
                return;
            }
            
            contentArea.innerHTML = getLoaderHTML(`Refining guide based on your request...`);
            
            const prompt = getEnhancedPrompt(refinementRequest, '', originalText);
            
            try {
                const newText = await callGeminiAPI(prompt);
                if (!newText || newText.trim() === '') {
                    handleApiError({ message: "The AI returned an empty response. Please try refining with a different request." }, contentArea, 'refinement');
                    return;
                }

                originalGeneratedText.set(textKey, newText);
                
                if (isModal) {
                    const contentEl = document.getElementById('inDepthModalContent');
                    createAccordionFromMarkdown(newText, contentEl);
                    footerEl.innerHTML = `
                        <button class="btn-secondary text-sm modal-refine-button">Refine with AI</button>
                        <button class="btn-secondary text-sm modal-copy-button">Copy Text</button>
                    `;
                    footerEl.querySelector('.modal-copy-button').addEventListener('click', (e) => copyElementTextToClipboard(contentEl, e.currentTarget));
                    if (refineContainer) refineContainer.remove();
                } else {
                    createAccordionFromMarkdown(newText, contentArea);
                    addPostGenerationButtons(contentArea, themeId, 'custom');
                }

            } catch(error) {
                handleApiError(error, contentArea, 'refinement');
            }
        }
        
        function getIconForTheme(themeType, themeId) { 
            const icons = {
                vmwareEsxi: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 12h14M12 5l7 7-7 7"></path></svg>`,
                windowsServer: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>`,
                m365Admin: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path></svg>`,
                citrixAdmin: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2.17-4.24a.5.5 0 10-.7.7l4.5 4.5a.5.5 0 00.7-.7l-4.5-4.5zm-5.66 0a.5.5 0 11-.7.7l4.5 4.5a.5.5 0 01.7-.7l-4.5-4.5zM12 3a9 9 0 100 18 9 9 0 000-18z"></path></svg>`,
                default: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`
            }
            return icons[themeType] || icons.default;
        }
        
        function getLoaderHTML(message) { return `<div class="flex justify-center items-center my-4"><div class="loader themed-loader"></div><p class="ml-4 themed-text-muted">${message}</p></div>`; }
        
        function generateErrorMessage(error, type = 'general') { console.error(`Error during ${type} generation:`, error); let message = `An unknown error occurred. ${error.message}`; const errText = error.message.toLowerCase(); if (errText.includes('safety') || errText.includes('blocked')) message = `Request blocked for safety reasons. Please try a different prompt.`; else if (errText.includes('api key not valid')) message = `Authentication failed. Your API Key is not valid.`; else if (errText.includes('429')) message = `Request limit exceeded. Please try again later.`; else if (errText.includes('timed out')) message = `The request timed out. Please check your connection and try again.`; return `Sorry, a critical error occurred: ${message}`; }

    </script>
</body>
</html>
