<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Administration Hub</title>
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown to HTML conversion -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Google Fonts: Inter, Lato, Roboto Slab, Open Sans, Montserrat, Poppins, Nunito Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Nunito+Sans:wght@400;700&family=Open+Sans:wght@400;700&family=Poppins:wght@400;500;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* * ==============================================
         * CSS Custom Properties for Theming & Typography
         * ==============================================
        */
        :root {
            --color-bg: #f3e8ff;
            --color-text: #374151;
            --color-text-muted: #6b7280;
            --color-primary: #9333ea;
            --color-primary-dark: #7e22ce;
            --color-accent: #581c87;
            --color-card-bg: rgba(255, 255, 255, 0.9);
            --color-card-border: #e9d5ff;
            --color-input-bg: #f9fafb;
            --color-input-border: #d1d5db;
            --color-button-text: #ffffff;
            --code-bg: #282c34;
            --code-text: #abb2bf;
        }

        /* Applying the theme variables */
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family, 'Inter', sans-serif);
            background-color: var(--color-bg);
            color: var(--color-text);
            font-size: var(--font-size-base, '16px');
            line-height: var(--line-height-base, 1.5);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        
        /* General Prose styling for AI-generated content */
        .prose { font-size: inherit; line-height: 1.6; }
        .prose p { margin-bottom: 1rem; }
        .prose ul, .prose ol { 
            margin-bottom: 1rem;
            padding-left: 1.75rem;
        }
        .prose ul { list-style-type: disc; }
        .prose ol { list-style-type: decimal; }
        .prose li { margin-bottom: 0.5rem; padding-left: 0.25rem; }
        .prose li > p { margin-bottom: 0.25rem; }
        .prose li > ul, .prose li > ol { margin-top: 0.5rem; }
        .prose strong { font-weight: 600; color: var(--color-text); }
        .prose a { color: var(--color-primary); text-decoration: none; border-bottom: 1px solid var(--color-primary); }
        .prose a:hover { color: var(--color-primary-dark); border-bottom-color: var(--color-primary-dark); }
        .prose h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-accent);
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        
        .screenshot-placeholder, .image-generation-container {
            border: 2px dashed var(--color-card-border);
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
            background-color: var(--color-input-bg);
            text-align: center;
            color: var(--color-text-muted);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .screenshot-placeholder::before {
            content: 'üñºÔ∏è';
            display: block;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .image-generation-container img {
            max-width: 100%;
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* Code Block Styling */
        .code-block-container {
            background-color: var(--code-bg);
            border-radius: 8px;
            margin: 1.5rem 0;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            color: #d1d5db;
            font-size: 0.875rem;
            font-family: 'Inter', sans-serif;
        }
        .copy-code-button {
            background-color: rgba(255,255,255,0.1);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }
        .copy-code-button:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .prose pre {
            background-color: transparent !important;
            margin: 0;
            padding: 1rem;
            color: var(--code-text);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .prose code {
            font-family: 'Menlo', 'Consolas', monospace;
            font-size: 0.9em;
        }


        .card {
            background-color: var(--color-card-bg);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, background-color 0.5s ease, border-color 0.5s ease;
            border: 1px solid var(--color-card-border);
            display: flex; flex-direction: column;
        }
        .card:hover { box-shadow: 0 10px 20px -5px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .card-content { flex-grow: 1; display: flex; flex-direction: column; }

        .btn-primary {
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text);
            font-weight: 600; padding: 12px 24px; border-radius: 8px;
            transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none; cursor: pointer;
        }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 7px 10px rgba(0, 0, 0, 0.15); filter: brightness(1.1); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-secondary {
            background-color: var(--color-input-bg); color: var(--color-text-muted);
            font-weight: 600; padding: 10px 20px; border-radius: 8px;
            border: 1px solid var(--color-input-border); cursor: pointer;
            transition: all 0.2s ease; display: inline-flex;
            align-items: center; justify-content: center; gap: 8px;
        }
        .btn-secondary:hover:not(:disabled) { background-color: #e5e7eb; color: var(--color-accent); }
        .btn-secondary:disabled { opacity: 0.7; cursor: not-allowed;}
        
        .btn-toggle {
            background-color: var(--color-input-bg); color: var(--color-text-muted);
            border: 1px solid var(--color-input-border); transition: all 0.2s ease;
        }
        .btn-toggle.active {
            background-color: var(--color-accent); color: var(--color-button-text);
            border-color: var(--color-primary-dark); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .jump-to-button {
            background-color: var(--color-card-bg); color: var(--color-text-muted);
            border: 1px solid var(--color-card-border); transition: all 0.2s ease;
            padding: 8px 16px; border-radius: 9999px; font-size: 0.875rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .jump-to-button:hover { background-color: var(--color-primary); color: var(--color-button-text); border-color: var(--color-primary-dark); transform: translateY(-1px); }

        .floating-action-button {
            position: fixed; background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text); width: 56px; height: 56px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.1);
            cursor: pointer; transition: all 0.3s ease; z-index: 50;
        }
        .floating-action-button:hover { transform: translateY(-3px) scale(1.05); }
        #new-plan-button { bottom: 2rem; right: 2rem; }
        #settings-button { bottom: 6.5rem; right: 2rem; }
        #ai-help-button { bottom: 11rem; right: 2rem; }
        #theme-changer-button { bottom: 15.5rem; right: 2rem; }
        #prompts-button { bottom: 20rem; right: 2rem; }
        #scroll-to-top-button { bottom: 2rem; left: 2rem; }
        
        #settings-panel {
            position: fixed; bottom: 11rem; right: 2rem;
            background-color: var(--color-card-bg); border: 1px solid var(--color-card-border);
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 1rem; width: 280px; z-index: 40;
            transition: opacity 0.3s ease, transform 0.3s ease; transform-origin: bottom right;
        }

        .themed-text-primary { color: var(--color-primary); }
        .themed-text-accent { color: var(--color-accent); }
        .themed-text-muted { color: var(--color-text-muted); }
        .themed-input {
            background-color: var(--color-input-bg); border-color: var(--color-input-border);
            color: var(--color-text); transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        .themed-input::placeholder { color: var(--color-text-muted); opacity: 0.7; }
        .themed-input:focus { --tw-ring-color: var(--color-primary); }

        .loader { border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .themed-loader { border: 4px solid var(--color-card-border); border-top: 4px solid var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header-bg-image { 
            background-image: url('https://i.ibb.co/Kjs2bJvq/Image-fx-31.png'); 
            background-size: cover; background-position: center; opacity: 1;
            transition: opacity 1.5s ease-in-out;
        }
        .header-loader-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: white; }

        .accordion-item { border-bottom: 1px solid var(--color-card-border); }
        .accordion-item:last-child { border-bottom: none; }
        .accordion-header {
            width: 100%; text-align: left; padding: 1rem; display: flex; justify-content: space-between; align-items: center; font-weight: 600;
            color: var(--color-text); background-color: transparent; border: none; cursor: pointer; transition: background-color 0.2s;
        }
        .accordion-header:hover { background-color: rgba(0,0,0,0.03); }
        .accordion-content { padding: 1rem; display: none; }
        .accordion-content.open { display: block; }
        .accordion-header .icon { transition: transform 0.3s ease; }
        .accordion-header.active .icon { transform: rotate(180deg); }

        .refine-container { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-card-border); }
        
        .card-grid-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem; margin-top: 1rem; padding: 0.5rem; border-radius: 8px;
            background: rgba(0,0,0,0.02);
        }
        .grid-card-selector {
            background-color: white; border: 1px solid var(--color-card-border);
            border-radius: 8px; padding: 1rem; text-align: center;
            cursor: pointer; transition: all 0.2s ease; font-size: 0.875rem; font-weight: 500;
            display: flex; flex-direction: column; justify-content: space-between; height: 100%;
        }
        .grid-card-selector:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .grid-card-selector.active {
            background-color: var(--color-accent); color: var(--color-button-text); border-color: var(--color-primary-dark);
        }
        .grid-card-selector .icon { margin-bottom: 0.5rem; }
        .grid-card-selector svg { width: 2.5rem; height: 2.5rem; margin: 0 auto; display: block; }
        .grid-card-selector.active small { color: rgba(255, 255, 255, 0.8); }

    </style>
</head>
<body>
    
    <!-- All Modals -->
    <div id="apiKeyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="card p-8 w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4 themed-text-primary">Enter Your API Keys</h2>
            <p class="mb-2 themed-text-muted">Provide your Google Cloud API Key to enable AI content generation and optional Google Drive features.</p>
            <form id="apiKeyForm">
                <label for="apiKeyInput" class="block text-sm font-medium themed-text-muted">Google Cloud API Key</label>
                <input type="password" id="apiKeyInput" class="w-full mt-1 px-4 py-2 themed-input border rounded-lg focus:ring-2" placeholder="Your Google Cloud API Key" required>
                
                <h3 class="text-xl font-semibold mb-2 mt-6 themed-text-accent">Google Drive Integration (Optional)</h3>
                <p class="mb-4 themed-text-muted">To save/load guides from Google Drive, also provide your Google Cloud Client ID.</p>
                <label for="googleClientIdInput" class="block text-sm font-medium themed-text-muted mt-4">Google Client ID</label>
                <input type="password" id="googleClientIdInput" class="w-full mt-1 px-4 py-2 themed-input border rounded-lg focus:ring-2" placeholder="Your Google Cloud Client ID">
                
                <button type="submit" class="w-full btn-primary mt-6">Save Keys and Start</button>
            </form>
        </div>
    </div>
    <div id="loadingStateModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="card p-8 w-full max-w-md m-4 text-center">
            <h2 class="text-2xl font-bold mb-4 themed-text-primary">Waking up the AI...</h2>
            <div class="flex justify-center my-4"><div class="loader themed-loader"></div></div>
            <p id="loading-message" class="mb-6 themed-text-muted">The AI is generating the initial content and guides. This may take a few moments.</p>
            <button id="closeLoadingStateModal" class="btn-secondary">Close</button>
        </div>
    </div>
    <div id="inDepthModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-3xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 id="inDepthModalTitle" class="text-2xl font-bold themed-text-primary">In-Depth Guide</h2>
                <button id="closeInDepthModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="inDepthModalContent" class="p-6 overflow-y-auto prose max-w-none"></div>
            <div id="inDepthModalFooter" class="p-4 border-t flex flex-wrap items-center gap-2" style="border-color: var(--color-card-border);">
                 <div id="google-drive-controls" class="flex flex-wrap gap-2">
                    <button id="auth-button" class="btn-secondary text-sm">Connect to Google Drive</button>
                    <button id="save-to-drive-btn" class="btn-secondary text-sm hidden">Save to Drive</button>
                    <button id="load-from-drive-btn" class="btn-secondary text-sm hidden">Load from Drive</button>
                 </div>
                 <p id="drive-status" class="text-xs themed-text-muted ml-auto"></p>
            </div>
        </div>
    </div>
    <div id="themeGeneratorModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-lg m-4 flex flex-col">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 class="text-2xl font-bold themed-text-primary">AI Visual Theme Generator</h2>
                <button id="closeThemeGeneratorModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div class="p-6">
                <p class="mb-6 themed-text-muted">Describe a mood or concept to create a new color palette and header image for the app.</p>
                <textarea id="theme-prompt" rows="3" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'Modern data center at dusk'"></textarea>
                <button id="generate-theme-btn" class="btn-primary w-full mt-4" title="Generate new app visuals based on your text">Generate Visuals</button>
                <div id="theme-loader-container" class="hidden mt-4 flex items-center space-x-3">
                    <div class="loader themed-loader" style="width:25px; height:25px;"></div>
                    <span class="themed-text-muted">AI is generating colors & image...</span>
                </div>
                <div id="theme-error-container" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>
            </div>
        </div>
    </div>
    <div id="promptsModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-4xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 class="text-2xl font-bold themed-text-primary">Application AI Prompts</h2>
                <button id="closePromptsModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="promptsModalContent" class="p-6 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <header class="relative text-center mb-10 rounded-2xl overflow-hidden shadow-lg">
            <div id="header-loader" class="hidden absolute inset-0 bg-black bg-opacity-50 flex-col items-center justify-center z-20 transition-opacity duration-500">
                <div class="loader header-loader-spinner"></div>
                <p class="text-white mt-4 text-lg">Generating new header image...</p>
            </div>
            <div id="header-bg-image" class="absolute inset-0 header-bg-image"></div>
            <div class="absolute inset-0 bg-black opacity-40"></div>
            <div class="relative z-10 py-24 px-12 text-white">
                <h1 class="text-4xl md:text-5xl font-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.6);">IT Administration Hub</h1>
                <p class="text-lg text-purple-200 mt-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.6);">AI-powered guides and task generation for IT professionals.</p>
            </div>
            <div id="version-display" class="absolute bottom-2 right-4 text-white text-xs opacity-70">v4.4</div>
        </header>

        <nav id="jump-to-nav-container" class="hidden text-center mb-8"></nav>

        <main id="main-content" class="space-y-8">
            <div id="loaded-guides-container" class="space-y-8"></div>
            
            <div id="custom-plan-card" class="card">
                <div class="p-8 card-content">
                    <h2 class="text-2xl font-bold mb-2 themed-text-primary">Custom Task Generator</h2>
                    <p class="mb-6 themed-text-muted">Need a guide for a specific task? Enter any keyword or concept, and let AI craft a step-by-step plan for you.</p>
                    <form id="gemini-form">
                        <input type="text" id="gemini-prompt" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'Configure a new firewall rule'">
                        
                        <div class="my-4 border rounded-lg" style="border-color: var(--color-card-border);">
                            <div class="accordion-item">
                                <button type="button" class="accordion-header" title="Click to see more options">
                                    <span>Tailor Your Guide:</span>
                                    <svg class="icon w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div class="accordion-content">
                                    <div id="tailoring-buttons-container" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary w-full mt-4" title="Generate a custom guide based on your text">Generate AI Guide</button>
                    </form>
                    <div id="gemini-result-container" class="mt-6"></div>
                </div>
            </div>

            <div id="main-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- All cards below will be generated by AI -->
            </div>
            
            <div id="discover-more-container" class="text-center py-8">
                <button id="discover-more-button" class="btn-primary px-8 py-4 text-lg" title="Generate a new random IT category">
                    <span class="flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v2.5"/><path d="M12 22v-2.5"/><path d="M21.5 12.5h-2.5"/><path d="M4.5 12.5h2.5"/><path d="M18.89 6.11l-1.77 1.77"/><path d="M6.88 18.88l-1.77 1.77"/></svg>
                        Discover More IT Topics
                    </span>
                </button>
                <p id="discover-more-error" class="text-red-500 mt-2"></p>
            </div>
        </main>
    </div>

    <!-- Floating Action Buttons -->
    <button id="prompts-button" class="floating-action-button" title="View AI Prompts">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 16 4-4-4-4"/><path d="m6 8-4 4 4 4"/><path d="m14.5 4-5 16"/></svg>
    </button>
    <button id="theme-changer-button" class="floating-action-button" title="Change Visual Theme">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l.34.34a8 8 0 0111.32 11.32l-.34.34a8 8 0 01-11.32-11.32l.34-.34z"/><path d="M16 12l-4.5 4.5-2.5-2.5"/><path d="M22 12s-4-8-10-8S2 12 2 12s4 8 10 8 10-8 10-8z"/></svg>
    </button>
    <button id="ai-help-button" class="floating-action-button" title="AI Help & Feedback">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"/><path d="M12 22A10 10 0 1 0 12 2a10 10 0 0 0 0 20z"/></svg>
    </button>
    <button id="settings-button" class="floating-action-button" title="Typography Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
    </button>
    <button id="new-plan-button" class="floating-action-button" title="New Session (Reload)">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
    </button>
    <button id="scroll-to-top-button" class="floating-action-button hidden" title="Scroll to top">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
    </button>
    <div id="settings-panel" class="hidden"><h3 class="text-lg font-bold themed-text-accent mb-4">Display Settings</h3><div class="space-y-4"><div><label for="font-family-select" class="block text-sm font-medium themed-text-muted mb-1">Font Family</label><select id="font-family-select" class="w-full p-2 themed-input border rounded-lg"></select></div><div><label for="font-size-select" class="block text-sm font-medium themed-text-muted mb-1">Font Size (px)</label><select id="font-size-select" class="w-full p-2 themed-input border rounded-lg"></select></div><div><label for="line-height-select" class="block text-sm font-medium themed-text-muted mb-1">Line Spacing</label><select id="line-height-select" class="w-full p-2 themed-input border rounded-lg"></select></div></div></div>

    <footer class="mt-16 py-8 text-center border-t" style="border-color: var(--color-card-border);">
        <div class="max-w-4xl mx-auto px-4">
            <p class="themed-text-muted font-semibold">Disclaimer</p>
            <p class="themed-text-muted text-sm mt-2">
                This application and its content are for informational and educational purposes only. The administrative guides and suggestions generated by AI are not a substitute for professional IT advice, vendor documentation, or certified training. Always test procedures in a non-production environment before applying them to live systems. Never disregard official documentation or professional advice because of something you have read on this application. The creators of this application are not responsible for any data loss, system downtime, or damages that may result from the use of these guides.
            </p>
        </div>
    </footer>


    <script type="module">
        // --- Global State & Configuration ---
        let apiKey = "";
        const root = document.documentElement;
        const allThemeData = {};
        const fullPrompts = {}; 
        let originalGeneratedText = new Map();

        // --- Google Drive Integration State & Config ---
        let gapiInited = false;
        let pickerInited = false;
        let googleAuth;
        let GOOGLE_API_KEY = '';
        let GOOGLE_CLIENT_ID = '';
        const SCOPES = 'https://www.googleapis.com/auth/drive';
        let driveFolderId = null;
        
        // --- App Initialization & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('apiKeyModal').classList.remove('hidden');
            setupEventListeners();
            populateTypographySettings();
            marked.setOptions({
                renderer: new marked.Renderer(),
                highlight: (code, lang) => code,
                langPrefix: 'language-',
                gfm: true,
                breaks: true,
            });
        });

        function setupEventListeners() {
            // Main Actions
            document.getElementById('apiKeyForm').addEventListener('submit', handleApiKeySubmit);
            document.getElementById('gemini-form').addEventListener('submit', handleGeminiSubmit);
            document.getElementById('generate-theme-btn').addEventListener('click', handleCustomVisualThemeGeneration);
            document.getElementById('discover-more-button').addEventListener('click', handleDiscoverMoreClick);

            // Google Drive Actions
            document.getElementById('auth-button').addEventListener('click', handleAuthClick);
            document.getElementById('save-to-drive-btn').addEventListener('click', saveCurrentGuideToDrive);
            document.getElementById('load-from-drive-btn').addEventListener('click', createPicker);

            // Floating Action Buttons & Panels
            document.getElementById('new-plan-button').addEventListener('click', () => location.reload());
            document.getElementById('prompts-button').addEventListener('click', displayPromptsInModal);
            document.getElementById('theme-changer-button').addEventListener('click', () => {
                if(!apiKey) {
                    alert('Please enter your API key to use the theme generator.');
                    return;
                }
                document.getElementById('themeGeneratorModal').classList.remove('hidden');
            });
            document.getElementById('ai-help-button').addEventListener('click', handleAIHelpRequest);
            document.getElementById('scroll-to-top-button').addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
             // Settings Panel
            const settingsPanel = document.getElementById('settings-panel');
            document.getElementById('settings-button').addEventListener('click', (e) => {
                e.stopPropagation();
                settingsPanel.classList.toggle('hidden');
            });

            // Typography Selects
            document.getElementById('font-family-select').addEventListener('change', (e) => root.style.setProperty('--font-family', e.target.value));
            document.getElementById('font-size-select').addEventListener('change', (e) => root.style.setProperty('--font-size-base', e.target.value));
            document.getElementById('line-height-select').addEventListener('change', (e) => root.style.setProperty('--line-height-base', e.target.value));
            
            // Modal Closing Listeners
            ['themeGeneratorModal', 'inDepthModal', 'promptsModal', 'loadingStateModal'].forEach(id => {
                document.getElementById(id).addEventListener('click', (e) => {
                    if (e.target.id === id || e.target.closest('[id^="close"]')) {
                        document.getElementById(id).classList.add('hidden');
                    }
                });
            });

            // Global Clicks for dynamic content and closing panels
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('copy-code-button')) {
                    const codeBlock = e.target.closest('.code-block-container').querySelector('code, pre');
                    copyElementTextToClipboard(codeBlock, e.target);
                    return;
                }

                const tailorBtn = e.target.closest('#tailoring-buttons-container .btn-toggle');
                if (tailorBtn) {
                    tailorBtn.classList.toggle('active');
                    return;
                }

                const gridSelector = e.target.closest('.grid-card-selector');
                if (gridSelector) {
                    const container = gridSelector.closest('.card-grid-container').parentElement;
                    const currentlyActive = container.querySelector('.grid-card-selector.active');
                    if(currentlyActive) currentlyActive.classList.remove('active');
                    gridSelector.classList.add('active');
                    handleGridSelect(gridSelector);
                    return;
                }

                const exploreBtn = e.target.closest('.explore-button');
                if (exploreBtn) {
                    handleExploreInDepth(exploreBtn.dataset.themeId, exploreBtn.dataset.themeType);
                    return;
                }
                
                const refineBtn = e.target.closest('.refine-button');
                if (refineBtn) {
                    toggleRefineUI(refineBtn.parentElement);
                    return;
                }

                const modalRefineBtn = e.target.closest('.modal-refine-button');
                if (modalRefineBtn) {
                    toggleRefineUI(modalRefineBtn.parentElement, true);
                    return;
                }
                
                const submitRefineBtn = e.target.closest('.submit-refinement-button');
                if(submitRefineBtn) {
                    handleRefineRequest(submitRefineBtn.closest('.refine-container'));
                    return;
                }
                
                const showAllBtn = e.target.closest('.show-all-button');
                if (showAllBtn) {
                    handleShowAllClick(showAllBtn);
                    return;
                }

                const accordionHeader = e.target.closest('.accordion-header');
                if (accordionHeader) { 
                    accordionHeader.classList.toggle('active'); 
                    accordionHeader.nextElementSibling.classList.toggle('open'); 
                    return;
                }
                
                const jumpToBtn = e.target.closest('.jump-to-button');
                if (jumpToBtn) {
                    const targetCard = document.getElementById(jumpToBtn.dataset.targetId);
                    if (targetCard) {
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'start'});
                        targetCard.style.boxShadow = '0 0 0 4px var(--color-primary)';
                        setTimeout(() => targetCard.style.boxShadow = '', 2000);
                    }
                    return;
                }

                if (!settingsPanel.classList.contains('hidden') && !settingsPanel.contains(e.target) && !e.target.closest('#settings-button')) {
                    settingsPanel.classList.add('hidden');
                }
            });
            
            window.addEventListener('scroll', () => {
                const scrollTopButton = document.getElementById('scroll-to-top-button');
                if (window.scrollY > 300) {
                    scrollTopButton.classList.remove('hidden');
                } else {
                    scrollTopButton.classList.add('hidden');
                }
            });
        }
        
        async function handleApiKeySubmit(e) {
            e.preventDefault();
            const apiKeyInput = document.getElementById('apiKeyInput');
            if (!apiKeyInput.value.trim()) return;
            
            apiKey = apiKeyInput.value.trim();
            GOOGLE_API_KEY = apiKey; // Use the same key for Google APIs
            GOOGLE_CLIENT_ID = document.getElementById('googleClientIdInput').value.trim();

            document.getElementById('apiKeyModal').classList.add('hidden');

            if(GOOGLE_API_KEY && GOOGLE_CLIENT_ID) {
                gapi.load('client:picker', initializeGapiClient);
            }

            const loadingModal = document.getElementById('loadingStateModal');
            const loadingMessageEl = document.getElementById('loading-message');
            loadingMessageEl.textContent = "The AI is generating the initial content and guides. This may take a few moments.";
            loadingModal.classList.remove('hidden');

            document.getElementById('main-grid').innerHTML = '';
            document.getElementById('jump-to-nav-container').innerHTML = '';
            document.getElementById('gemini-result-container').innerHTML = '';
            document.getElementById('discover-more-error').innerHTML = '';

            try {
                await generateAndApplyDefaultTheme();
                await loadAppContent(loadingMessageEl);
            } catch (error) {
                console.error("A critical error occurred during app initialization:", error.message);
                const modalMessage = document.querySelector('#apiKeyModal p');
                if (document.getElementById('apiKeyModal').classList.contains('hidden')) {
                    modalMessage.textContent = 'An error occurred during setup. Some content may have failed to load. Please check your API key and connection.';
                    modalMessage.classList.add('text-red-600', 'font-bold');
                    document.getElementById('apiKeyModal').classList.remove('hidden');
                }
            } finally {
                loadingModal.classList.add('hidden');
            }
        }

        // --- Google Drive Integration Functions ---
        
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: GOOGLE_API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
                gapiInited = true;
                
                googleAuth = gapi.auth2.init({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: SCOPES,
                });

                googleAuth.isSignedIn.listen(updateSigninStatus);
                updateSigninStatus(googleAuth.isSignedIn.get());
            } catch(error) {
                console.error("Error initializing Google API Client", error);
                document.getElementById('drive-status').textContent = 'Google API init failed. Check keys.';
            }
        }

        function handleAuthClick() {
            if (googleAuth.isSignedIn.get()) {
                googleAuth.signOut();
            } else {
                googleAuth.signIn();
            }
        }
        
        function updateSigninStatus(isSignedIn) {
            const authButton = document.getElementById('auth-button');
            const saveBtn = document.getElementById('save-to-drive-btn');
            const loadBtn = document.getElementById('load-from-drive-btn');
            const statusEl = document.getElementById('drive-status');

            if (isSignedIn) {
                authButton.textContent = 'Sign Out';
                saveBtn.classList.remove('hidden');
                loadBtn.classList.remove('hidden');
                statusEl.textContent = 'Connected to Google Drive.';
                getDriveFolderId(); 
            } else {
                authButton.textContent = 'Connect to Google Drive';
                saveBtn.classList.add('hidden');
                loadBtn.classList.add('hidden');
                statusEl.textContent = 'Not connected.';
                driveFolderId = null;
            }
        }

        async function getDriveFolderId() {
            if (driveFolderId) return driveFolderId;
            const driveStatusEl = document.getElementById('drive-status');
            driveStatusEl.textContent = 'Searching for app folder...';
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: "mimeType='application/vnd.google-apps.folder' and name='IT Administration Hub' and trashed=false",
                    fields: 'files(id, name)',
                });

                if (response.result.files && response.result.files.length > 0) {
                    driveFolderId = response.result.files[0].id;
                } else {
                    driveStatusEl.textContent = 'Creating app folder...';
                    const folderResponse = await gapi.client.drive.files.create({
                        resource: { 'name': 'IT Administration Hub', 'mimeType': 'application/vnd.google-apps.folder' },
                        fields: 'id'
                    });
                    driveFolderId = folderResponse.result.id;
                }
                driveStatusEl.textContent = 'Connected to Google Drive.';
                return driveFolderId;
            } catch (error) {
                console.error("Error finding/creating Drive folder:", error);
                driveStatusEl.textContent = 'Error with Drive folder.';
                return null;
            }
        }

        async function saveCurrentGuideToDrive() {
            const driveStatusEl = document.getElementById('drive-status');
            if (!googleAuth.isSignedIn.get()) {
                driveStatusEl.textContent = 'Please connect to Google Drive first.';
                return;
            }

            const folderId = await getDriveFolderId();
            if (!folderId) {
                driveStatusEl.textContent = 'Could not find or create Drive folder.';
                return;
            }

            const title = document.getElementById('inDepthModalTitle').textContent.replace('In-Depth: ', '');
            const themeId = document.getElementById('inDepthModalFooter').dataset.themeId;
            const content = originalGeneratedText.get(themeId + '-full');
            
            if (!content) {
                driveStatusEl.textContent = 'No content to save.';
                return;
            }

            const fileName = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.md`;
            const fileMetadata = { name: fileName, parents: [folderId] };
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";
            const multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(fileMetadata) + delimiter + 'Content-Type: text/markdown\r\n\r\n' + content + close_delim;
            
            driveStatusEl.textContent = 'Saving file to Drive...';
            try {
                await gapi.client.request({
                    'path': '/upload/drive/v3/files',
                    'method': 'POST',
                    'params': {'uploadType': 'multipart'},
                    'headers': {'Content-Type': 'multipart/related; boundary="' + boundary + '"'},
                    'body': multipartRequestBody
                });
                driveStatusEl.textContent = `File '${fileName}' saved successfully!`;
                 setTimeout(()=> driveStatusEl.textContent = 'Connected to Google Drive.', 3000);
            } catch (error) {
                console.error('Error saving file:', error);
                driveStatusEl.textContent = 'Error saving file.';
            }
        }

        function createPicker() {
            if (!gapiInited) {
                 console.error("GAPI not ready for picker.");
                 document.getElementById('drive-status').textContent = 'Google API not ready.';
                 return;
            }
             const view = new google.picker.View(google.picker.ViewId.DOCS);
             view.setMimeTypes("text/markdown,text/plain");

             const picker = new google.picker.PickerBuilder()
                .addView(view)
                .setOAuthToken(gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token)
                .setDeveloperKey(GOOGLE_API_KEY)
                .setCallback(pickerCallback)
                .build();
             picker.setVisible(true);
        }

        async function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                const fileId = data.docs[0].id;
                try {
                    const response = await gapi.client.drive.files.get({ fileId, alt: 'media' });
                    const fileContent = response.body;
                    const fileName = data.docs[0].name;
                    
                    addLoadedGuideToPage(fileName, fileContent);
                    document.getElementById('inDepthModal').classList.add('hidden');

                } catch (error) {
                    console.error("Error loading file content:", error);
                    alert('Error loading file content from Google Drive.');
                }
            }
        }
        
        function addLoadedGuideToPage(fileName, markdownContent) {
            const container = document.getElementById('loaded-guides-container');
            const cardId = `loaded-${fileName.replace(/[^a-zA-Z0-9]/g, '')}-${Date.now()}`;
            
            const card = document.createElement('div');
            card.className = 'card md:col-span-2';
            card.id = cardId;
            
            const cardContent = document.createElement('div');
            cardContent.className = 'p-8 card-content';
            
            cardContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-2 themed-text-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                    Loaded from Drive: ${fileName}
                </h2>
                <div class="prose max-w-none mt-4"></div>
            `;
            
            const renderTarget = cardContent.querySelector('.prose');
            renderAccordionFromMarkdown(markdownContent, renderTarget, false); // No images for loaded files

            card.appendChild(cardContent);
            container.prepend(card); // Add to the top of the loaded guides section

            card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // --- Core Application Functions (Modified and existing) ---

        async function loadAppContent(loadingMessageEl) {
            try {
                const categoriesToGenerate = [
                    { 
                        key: 'activeDirectory', 
                        title: 'Active Directory Management', 
                        description: "Tasks for managing users, groups, GPOs, and other AD objects.", 
                        initialPrompt: `Generate 10 common administrative tasks for Active Directory Management. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for Active Directory Management. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'aiProgramming', 
                        title: 'Artificial Intelligence (AI) Programming', 
                        description: "Concepts and guides for getting started with AI development and programming.", 
                        initialPrompt: `Generate 10 common topics for an introduction to AI Programming. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 topics for learning AI Programming, from beginner to advanced. For each, give a unique "id", "title", and a detailed "description" of the topic. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'citrixAdmin', 
                        title: 'Citrix Administration', 
                        description: "Managing Citrix Virtual Apps and Desktops environments.", 
                        initialPrompt: `Generate 10 common administrative tasks for Citrix. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for Citrix. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'dataCenterPractices', 
                        title: 'Data Center Best Practices', 
                        description: "Guides on data center operations, cooling, power, and security.", 
                        initialPrompt: `Generate 10 best practices for data center management. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 best practices for modern data center management. For each, give a unique "id", "title", and a detailed "description" of the practice. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'webDesignBestPractices', 
                        title: 'Designing Web Pages Best Practices', 
                        description: "Best practices for UI/UX, accessibility, and performance in web design.", 
                        initialPrompt: `Generate 10 best practices for designing web pages. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 detailed best practices for designing modern web pages. For each, give a unique "id", "title", and a detailed "description" of the practice. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'webDesignGemini', 
                        title: 'Designing Web Pages with Gemini AI', 
                        description: "Using Gemini AI to assist in the design and development of web pages.", 
                        initialPrompt: `Generate 10 ways to use Gemini AI for web design. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 detailed methods for using Gemini AI in web design and development. For each, give a unique "id", "title", and a detailed "description" of the method. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'dosCommands', 
                        title: 'DOS Commands for Administrators', 
                        description: "A reference for essential DOS and Command Prompt commands for system admins.", 
                        initialPrompt: `Generate 10 essential DOS commands for administrators. For each, give a unique "id", "title" (the command itself), and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 essential and advanced DOS/CMD commands for administrators. For each, give a unique "id", "title" (the command itself), and a detailed "description" of its use and parameters. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'hpeProLiant', 
                        title: 'HPE ProLiant Server Management', 
                        description: "Managing and troubleshooting HPE ProLiant servers with iLO and other tools.", 
                        initialPrompt: `Generate 10 common administrative tasks for HPE ProLiant Server Management. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for HPE ProLiant Server Management. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'javascriptForHtml', 
                        title: 'JavaScript for HTML', 
                        description: "Core JavaScript concepts for manipulating HTML DOM and creating interactive web pages.", 
                        initialPrompt: `Generate 10 fundamental JavaScript concepts for HTML manipulation. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 essential JavaScript concepts and techniques for HTML web development. For each, give a unique "id", "title", and a detailed "description" of the concept. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'm365Admin', 
                        title: 'Microsoft 365 Administration', 
                        description: "Administering users, services, and security in Microsoft 365.", 
                        initialPrompt: `Generate 10 common administrative tasks for Microsoft 365. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for Microsoft 365. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'msGraphScripting', 
                        title: 'MS Graph scripting', 
                        description: "Automating M365 tasks using the Microsoft Graph API.", 
                        initialPrompt: `Generate 10 common tasks to automate with MS Graph scripting. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced tasks to automate with Microsoft Graph scripting. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'powershellM365', 
                        title: 'PowerShell for M365 Administration', 
                        description: "Using PowerShell to manage Microsoft 365 services like Exchange Online and SharePoint.", 
                        initialPrompt: `Generate 10 common PowerShell tasks for M365 Administration. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced PowerShell tasks for M365 Administration. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'powershellWindowsServer', 
                        title: 'PowerShell for Windows Server Administration', 
                        description: "Automating Windows Server management with PowerShell scripts and cmdlets.", 
                        initialPrompt: `Generate 10 common PowerShell tasks for Windows Server Administration. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced PowerShell tasks for Windows Server Administration. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'powershellScripts', 
                        title: 'PowerShell Scripts', 
                        description: "A collection of useful PowerShell scripts for various administrative tasks.", 
                        initialPrompt: `Generate 10 useful PowerShell script ideas for administrators. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 useful and practical PowerShell script ideas for administrators. For each, give a unique "id", "title", and a detailed "description" of the script's purpose. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'usefulApis', 
                        title: 'Useful APIs for Web Development', 
                        description: "A curated list of public APIs that are useful for web development projects.", 
                        initialPrompt: `Generate a list of 10 useful public APIs for web developers. For each, give a unique "id", "title" (API name), and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate a list of 40-50 useful public APIs for web developers across different categories. For each, give a unique "id", "title" (API name), and a detailed "description" of what it offers. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'vmwareEsxi', 
                        title: 'VMware ESXi Administration', 
                        description: "Guides and best practices for managing VMware ESXi environments.", 
                        initialPrompt: `Generate 10 common administrative tasks for VMware ESXi. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for VMware ESXi. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'vmwarePowerCli', 
                        title: 'VMware PowerCLI', 
                        description: "Automating VMware vSphere administration using PowerCLI.", 
                        initialPrompt: `Generate 10 common VMware PowerCLI commands for administrators. For each, give a unique "id", "title" (the command/task), and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced tasks using VMware PowerCLI. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'windowsServer2019', 
                        title: 'Windows Server 2019 Administration', 
                        description: "Key tasks and features for administering Windows Server 2019.", 
                        initialPrompt: `Generate 10 key administrative tasks for Windows Server 2019. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 administrative tasks specific to Windows Server 2019. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'windowsServer2022', 
                        title: 'Windows Server 2022 Administration', 
                        description: "Key tasks and new features for administering Windows Server 2022.", 
                        initialPrompt: `Generate 10 key administrative tasks for Windows Server 2022. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 administrative tasks specific to Windows Server 2022, including new features. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'windowsServer', 
                        title: 'Windows Server Administration', 
                        description: "Essential tasks for managing Windows Server instances.", 
                        initialPrompt: `Generate 10 common administrative tasks for Windows Server. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for Windows Server. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    }
                ];

                await Promise.allSettled([loadAITailoringOptions(), loadDynamicPlaceholders()]);
                
                const generationPromises = categoriesToGenerate.map(cat => {
                    if (loadingMessageEl) loadingMessageEl.textContent = `Generating guides for: ${cat.title}...`;
                    return generateAndPopulateAICategory(cat).catch(e => {
                        console.error(`Failed to load category: ${cat.title}`, e);
                        return { key: cat.key, error: e };
                    });
                });

                const results = await Promise.all(generationPromises);
                const firstFailure = results.find(r => r && r.error);
                if(firstFailure){
                    throw new Error(`One or more AI content categories failed to load, starting with ${firstFailure.key}. The process has been stopped.`);
                }
                
                if (loadingMessageEl) loadingMessageEl.textContent = `Building navigation...`;
                await generateJumpToButtons();

            } catch (error) {
                console.error("An error occurred while loading app content:", error.message);
                throw error;
            }
        }
        
        async function generateAndPopulateAICategory({key, title, description, initialPrompt, fullPrompt}) {
            const mainGrid = document.getElementById('main-grid');
            const card = document.createElement('div');
            card.className = 'card md:col-span-2';
            card.id = `${key}-card`;
            const selectorId = `${key}-selector-visual`;
            card.innerHTML = `<div class="p-8 card-content"><h2 class="text-2xl font-bold mb-2 themed-text-primary">${title}</h2><p class="mb-6 themed-text-muted">${description}</p><div id="${selectorId}" class="w-full">${getLoaderHTML(`AI is generating guides for ${title}...`)}</div><div id="${key}-details" class="details-container prose max-w-none mt-4"></div></div>`;
            mainGrid.appendChild(card);
            
            fullPrompts[key] = fullPrompt;

            try {
                const jsonText = await callGeminiAPI(initialPrompt, true);
                if (!jsonText) throw new Error(`API returned empty content for ${title}.`);
                
                const data = parseJsonWithCorrections(jsonText);
                allThemeData[key] = data;
                populateCardGridSelector(selectorId, key);
            } catch (error) {
                handleApiError(error, document.getElementById(selectorId), title, card);
                throw error;
            }
        }
        
        function populateCardGridSelector(containerId, themeType) {
            const container = document.getElementById(containerId);
            const data = allThemeData[themeType];
            if (!container || !data || !Array.isArray(data)) {
                if (container) container.innerHTML = `<p class="themed-text-muted">No items to display.</p>`;
                return;
            }

            const gridClass = 'card-grid-container';

            const itemsHtml = data.map(item => {
                return `
                <div class="grid-card-selector" data-theme-id="${item.id}" data-theme-type="${themeType}" title="${item.description || ''}">
                    <div class="icon">${getIconForTheme(themeType, item.id)}</div>
                    <div class="mt-2">
                        <div class="text-sm font-normal leading-tight block">${item.title}</div>
                    </div>
                </div>`;
            }).join('');
            
            const fullPrompt = fullPrompts[themeType];
            let showAllButtonHtml = '';
            
            if (fullPrompt && data.length < 35 && data.length > 0) {
                showAllButtonHtml = `
                    <div class="col-span-full text-center mt-4">
                        <button class="show-all-button btn-secondary" data-container-id="${containerId}" data-theme-type="${themeType}">
                            Show All (${data.length} of ~50 shown)
                        </button>
                    </div>`;
            }

            container.innerHTML = `<div class="${gridClass}">${itemsHtml}</div>${showAllButtonHtml}`;
        }
        
        async function handleShowAllClick(button) {
            const { containerId, themeType } = button.dataset;
            const container = document.getElementById(containerId);
            const fullPrompt = fullPrompts[themeType];

            if (!container || !fullPrompt) return;

            button.disabled = true;
            button.innerHTML = `<span class="flex items-center justify-center gap-2"><div class="loader themed-loader" style="width:20px; height:20px; border-width: 2px;"></div>Loading all...</span>`;

            try {
                const jsonText = await callGeminiAPI(fullPrompt, true);
                if (!jsonText) throw new Error(`API returned empty content for ${themeType} (full list).`);
                allThemeData[themeType] = parseJsonWithCorrections(jsonText);
                populateCardGridSelector(containerId, themeType);
                document.getElementById(`${themeType}-details`).innerHTML = '';
            } catch (error) {
                button.disabled = false;
                button.classList.add('bg-red-100', 'text-red-700');
                button.textContent = "Error. Try again.";
                console.error(`Error loading full list for ${themeType}:`, error);
            }
        }

        async function handleGridSelect(target) {
            const { themeId, themeType } = target.dataset;
            const item = allThemeData[themeType]?.find(d => String(d.id) == String(themeId));
            if (!item) {
                console.error("Could not find theme item for:", {themeId, themeType});
                return;
            }
            
            const prompt = `Generate a very brief, condensed summary for an IT administration guide on the topic: "${item.title}". For each section (Objective, Pre-requisites, Key Steps, Verification, Helpful Resources), provide a single descriptive sentence. Return the response as a simple markdown string where each section is a bullet point, starting with '*'.`;
            
            const resultContainer = document.getElementById(`${themeType}-details`);
            resultContainer.innerHTML = getLoaderHTML(`Generating summary for ${item.title}...`);

            try {
                const resultText = await callGeminiAPI(prompt);
                originalGeneratedText.set(themeId, resultText); 
                resultContainer.innerHTML = convertMarkdownToHtml(resultText);
                addPostGenerationButtons(resultContainer, themeId, themeType);
            } catch (error) {
                handleApiError(error, resultContainer, `guide for ${item.title}`);
            }
        }

        async function handleGeminiSubmit(e) {
            e.preventDefault();
            const promptInput = document.getElementById('gemini-prompt');
            let userPrompt = promptInput.value.trim();
            if (!userPrompt) return;

            const selectedOptions = Array.from(document.querySelectorAll('#tailoring-buttons-container .btn-toggle.active'))
                                        .map(btn => btn.textContent.trim())
                                        .join(', ');

            const prompt = getEnhancedPrompt(userPrompt, selectedOptions);

            const resultContainer = document.getElementById('gemini-result-container');
            resultContainer.innerHTML = getLoaderHTML('Generating your custom AI guide...');

            try {
                const resultText = await callGeminiAPI(prompt);
                
                originalGeneratedText.set('custom-plan', resultText);
                renderAccordionFromMarkdown(resultText, resultContainer);
                addPostGenerationButtons(resultContainer, 'custom-plan', 'custom');
                generateAndInjectImages(resultContainer);


            } catch(error) {
                handleApiError(error, resultContainer, 'custom IT guide');
            }
        }

        function parseJsonWithCorrections(jsonString) {
            if (!jsonString || typeof jsonString !== 'string') {
                throw new Error("Invalid input: not a string.");
            }
            let cleanedString = jsonString.replace(/```(json|markdown)?\n?/g, '').replace(/```/g, '').trim();
            cleanedString = cleanedString.replace(/,\s*(}|])/g, '$1');

            try {
                return JSON.parse(cleanedString);
            } catch (error) {
                console.error("Failed to parse JSON even after cleaning:", error);
                console.error("Original string:", jsonString);
                console.error("Cleaned string:", cleanedString);
                throw new Error(`JSON Parse Error: ${error.message}. Check console for the problematic string.`);
            }
        }

        async function callApi(apiUrl, payload) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000);

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    let errorBody;
                    try { errorBody = await response.json(); } catch { errorBody = await response.text(); }
                    console.error("API Error Response:", errorBody);
                    const errorMsg = errorBody?.error?.message || response.statusText;
                    throw new Error(`API request failed with status ${response.status}. Message: ${errorMsg}`);
                }
                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') throw new Error('The AI service request timed out. Please try again.');
                throw error;
            }
        }

        async function callGeminiAPI(prompt, isJson = false) {
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            if (isJson) {
                payload.generationConfig = { responseMimeType: "application/json", maxOutputTokens: 8192 };
            }
            const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, payload);
            return result?.candidates?.[0]?.content?.parts?.[0]?.text || null;
        }

        async function callImageGenAPI(prompt) {
            const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
            const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`, payload);
            const base64 = result?.predictions?.[0]?.bytesBase64Encoded;
            return base64 ? `data:image/png;base64,${base64}` : null;
        }
        
        async function callColorGenAPI(prompt) {
            const fullPrompt = `Based on the theme "${prompt}", generate a color palette. I need a JSON object with keys: "bg", "text", "primary", "primaryDark", "accent", "cardBg", "cardBorder", "textMuted", "inputBg", "inputBorder", "buttonText". Determine if the "primary" color is light or dark to set the "buttonText" appropriately (#FFFFFF for dark, #111827 for light). Return only the complete, valid JSON.`;
            const jsonText = await callGeminiAPI(fullPrompt, true);
            if (jsonText) return parseJsonWithCorrections(jsonText);
            throw new Error("Could not parse a valid color theme from API response.");
        }

        function handleApiError(error, container, contentType = 'content') {
            console.error(`Error generating ${contentType}:`, error);
            const errorMessage = generateErrorMessage(error, contentType);
            if (container) {
                container.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">${errorMessage}</div>`;
            }
        }
        
        async function generateAndApplyDefaultTheme() {
            showThemeLoading(true);
            const themePrompt = "Modern Data Center";
            const imagePrompt = `Artistic, abstract background image inspired by "${themePrompt}". Suitable for an IT administration website. Professional, clean. Wide aspect ratio, photographic, cinematic lighting.`;
            try {
                const [colorResult, imageResult] = await Promise.allSettled([callColorGenAPI(themePrompt), callImageGenAPI(imagePrompt)]);
                
                if (colorResult.status === 'fulfilled' && colorResult.value) applyTheme(colorResult.value);
                else throw colorResult.reason || new Error("Failed to generate color theme.");

                if (imageResult.status === 'fulfilled' && imageResult.value) applyHeaderImage(imageResult.value);
                else throw imageResult.reason || new Error("Failed to generate header image.");

            } catch (error) {
                handleApiError(null, null, 'default theme');
                throw error;
            } finally {
                showThemeLoading(false);
            }
        }
        
        async function loadAITailoringOptions() {
            const container = document.getElementById('tailoring-buttons-container');
            container.innerHTML = getLoaderHTML('Loading AI options...');
            try {
                const prompt = `Generate a comprehensive list of 40-50 diverse keywords and concepts for tailoring IT administration guides. The list should cover a wide range of topics including security, performance, automation, specific technologies (like PowerShell, Ansible), methodologies (like IaC), and user levels (like 'for beginners', 'for experts'). Return ONLY a valid JSON array of strings.`;
                const jsonText = await callGeminiAPI(prompt, true);
                if (!jsonText) {
                    throw new Error("AI did not return any tailoring options.");
                }
                const options = parseJsonWithCorrections(jsonText);
                populateTailoringButtons(options);
            } catch (error) {
                handleApiError(error, container, 'tailoring options');
                // Fallback to a small, hardcoded list on error
                const fallbackOptions = ["Security Hardening", "Performance Tuning", "Automation Script", "For Beginners"];
                populateTailoringButtons(fallbackOptions);
            }
        }


        function populateTailoringButtons(options) {
            const container = document.getElementById('tailoring-buttons-container');
            container.innerHTML = options.map(option =>
                `<button type="button" class="btn-toggle text-sm px-3 py-1 rounded-full">${option}</button>`
            ).join('');
        }
        
        async function loadDynamicPlaceholders() {
            const promptInput = document.getElementById('gemini-prompt');
            const prompt = `Generate a JSON array of 3 creative IT administration task ideas for input placeholders. Examples: "Onboard a new employee", "Decommission a legacy server". Return ONLY the valid JSON array of strings.`;
            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if(!jsonText) return;
                const placeholders = parseJsonWithCorrections(jsonText);
                if (placeholders && placeholders.length > 0) {
                    let i = 0;
                    promptInput.placeholder = `e.g., '${placeholders[i]}'`;
                    setInterval(() => {
                        i = (i + 1) % placeholders.length;
                        promptInput.placeholder = `e.g., '${placeholders[i]}'`;
                    }, 3000);
                }
            } catch(error) {
                console.error("Could not load dynamic placeholders", error);
            }
        }

        function applyTheme(colors) {
            Object.entries(colors).forEach(([key, value]) => {
                const cssVar = `--color-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                root.style.setProperty(cssVar, value);
            });
        }
        
        function applyHeaderImage(imageUrl) {
            const bgImageDiv = document.getElementById('header-bg-image');
            bgImageDiv.style.backgroundImage = `url('${imageUrl}')`;
        }

        function showThemeLoading(isLoading) {
            const loader = document.getElementById('header-loader');
            loader.classList.toggle('hidden', !isLoading);
            loader.classList.toggle('flex', isLoading);
        }
        
        function getAppPrompts() {
            return {
                "Generate Detailed Guide": getEnhancedPrompt("{task}", "{options}"),
                "Refine Existing Guide": getEnhancedPrompt("{refinement_request}", "", "{original_text}"),
                "Generate In-Depth Guide": getEnhancedPrompt("{item_title}"),
                "Generate Summary": `Generate a very brief, condensed summary for an IT administration guide on the topic: "{item.title}". For each section (Objective, Pre-requisites, Key Steps, Verification, Helpful Resources), provide a single descriptive sentence. Return the response as a simple markdown string where each section is a bullet point, starting with '*'.`,
                "Generate UI Screenshot": `UI Screenshot for an IT Administration guide showing: {description}. Clean, professional, minimal.`,
                "Generate Color Theme": `Based on the theme "{prompt}", generate a color palette. I need a JSON object with keys: "bg", "text", "primary", "primaryDark", "accent", "cardBg", "cardBorder", "textMuted", "inputBg", "inputBorder", "buttonText". Determine if the "primary" color is light or dark to set the "buttonText" appropriately (#FFFFFF for dark, #111827 for light). Return only the complete, valid JSON.`,
                "Discover New Topic": `Generate 1 new, useful IT administration category NOT on this list: {existing_titles}. Provide a "key" (camelCase, unique), "title", "description", an "initialPrompt" (for 10 items), and a "fullPrompt" (for 40-50). Prompts must request a JSON array of objects, each with id, title, and description. Return ONLY a valid JSON object.`,
            };
        }
        
        function displayPromptsInModal() {
            const modal = document.getElementById('promptsModal');
            const contentEl = document.getElementById('promptsModalContent');
            contentEl.innerHTML = ''; 

            const prompts = getAppPrompts();

            for (const [title, promptText] of Object.entries(prompts)) {
                const promptContainer = document.createElement('div');
                promptContainer.className = 'mb-6';
                
                const promptTitle = document.createElement('h3');
                promptTitle.className = 'text-lg font-semibold themed-text-accent mb-2';
                promptTitle.textContent = title;
                promptContainer.appendChild(promptTitle);

                const codeBlockContainer = document.createElement('div');
                codeBlockContainer.className = 'code-block-container !mt-0';
                
                const header = document.createElement('div');
                header.className = 'code-block-header';
                header.innerHTML = `<span>Prompt</span><button class="copy-code-button">Copy</button>`;
                codeBlockContainer.appendChild(header);

                const pre = document.createElement('pre');
                pre.className = 'text-sm';
                pre.textContent = promptText;
                codeBlockContainer.appendChild(pre);
                
                promptContainer.appendChild(codeBlockContainer);
                contentEl.appendChild(promptContainer);
            }

            modal.classList.remove('hidden');
        }


        // DEV NOTE: This function defines the master prompt for generating detailed guides.
        // It's designed to be flexible for both new content and user-requested refinements.
        function getEnhancedPrompt(task, options = '', originalText = '') {
            const optionsText = options ? `With a special focus on these elements: ${options}.` : '';
            
            // This logic block handles refinements of existing text.
            if (originalText) {
                return `You are an expert senior IT administrator AI. A user has provided an IT guide and a request to refine it. Your task is to rewrite the entire guide to incorporate the user's request, structuring the new guide into the most logical sections possible.

**ORIGINAL IT GUIDE:**
---
${originalText}
---

**USER'S REFINEMENT REQUEST:**
"${task}"

**Instructions for rewriting:**
1.  **Structure:** Do not use the old section headers unless they are still the most logical choice. Instead, create new, clear, and descriptive section headers using '###' markdown syntax based on the refined content.
2.  **Integrate:** Seamlessly integrate the user's request into the guide.
3.  **Quality Standards:** The entire rewritten guide must still meet these requirements for the specific technology being discussed:
    * **Authoritative Links:** Embed hyperlinks to official vendor documentation, relevant articles, or other authoritative sources.
    * **Code Blocks:** When providing code examples, wrap them in markdown code fences with the language specified (e.g., \`\`\`powershell\`).
    * **Screenshot Placeholders:** Include placeholders for screenshots where visual context is beneficial. Use the format: [Screenshot: A clear, concise description for an AI image generator to create a UI screenshot].
    * **Practicality:** Ensure all advice, steps, and examples are practical and reflect real-world scenarios.
    * **Helpful Resources:** Ensure there is a final section with a bulleted list of high-quality, relevant links.

Return only the new, complete, and rewritten markdown guide.`;
            }

            // This is the prompt for generating new content from scratch.
            return `You are an expert senior IT administrator AI. Generate a comprehensive and practical guide for the task: "${task}". ${optionsText}

Your task is to structure this guide into the most logical and helpful sections. For each section, create a clear and descriptive header using '###' markdown syntax. The content within each section should be detailed and practical.

When generating the guide, ensure the guide as a whole meets the following requirements for the specific technology being discussed:

1.  **Authoritative Links:** Throughout the guide, embed hyperlinks to official vendor documentation, relevant articles, or other authoritative sources.
2.  **Code Blocks:** When providing code examples (like PowerShell), wrap them in markdown code fences with the language specified, like \`\`\`powershell... \`\`\`.
3.  **Prerequisites:** Create a dedicated "Prerequisites" section that details relevant administrative roles, permissions, and any specific licensing requirements.
4.  **Verification:** Include a section on how to verify the task was successful, mentioning practical, real-world details (e.g., specific logs to check).
5.  **Troubleshooting:** Include a section covering common problems that administrators face.
6.  **Helpful Resources:** Include a final section with a bulleted list of high-quality, relevant links to official documentation, tutorials, or tools.
7.  **Screenshot Placeholders:** In the 'Step-by-Step Guide' or equivalent section, include placeholders for screenshots where visual context would be beneficial. Use the format: [Screenshot: A clear, concise description for an AI image generator to create a UI screenshot].

Return only the complete markdown guide.`;
        }
        
        /**
         * Converts a markdown string to sanitized HTML using marked.js,
         * and prepares special placeholders for screenshots and code blocks.
         */
        function convertMarkdownToHtml(text, generateImages = true) {
            if (!text) return '<p class="themed-text-muted">No content received from AI. Please try a different prompt.</p>';

            let processedText;
            if (generateImages) {
                // First, process our custom placeholders before passing to marked.js
                processedText = text.replace(/\[Screenshot: (.*?)\]/g, (match, description) => {
                    const placeholderId = `image-placeholder-${Date.now()}-${Math.random()}`;
                    return `<div id="${placeholderId}" class="image-generation-container" data-prompt="${description.replace(/"/g, '&quot;')}">
                                <div class="loader themed-loader"></div>
                                <p class="mt-2 text-sm italic">${description}</p>
                            </div>`;
                });
            } else {
                // If not generating images, simply remove the screenshot tags from the markdown text.
                processedText = text.replace(/\[Screenshot: (.*?)\]/g, '');
            }


            // Convert markdown to HTML using the marked library
            let html = marked.parse(processedText);

            // Post-processing to add copy buttons to code blocks
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            tempDiv.querySelectorAll('pre code').forEach(codeBlock => {
                const pre = codeBlock.parentElement;
                const lang = Array.from(codeBlock.classList).find(c => c.startsWith('language-'))?.replace('language-', '') || 'text';
                
                const container = document.createElement('div');
                container.className = 'code-block-container';
                
                const header = document.createElement('div');
                header.className = 'code-block-header';
                header.innerHTML = `
                    <span>${lang}</span>
                    <button class="copy-code-button">Copy</button>
                `;

                container.appendChild(header);
                pre.parentNode.insertBefore(container, pre);
                container.appendChild(pre);
            });

            return tempDiv.innerHTML;
        }

        async function generateAndInjectImages(container) {
            const placeholders = container.querySelectorAll('.image-generation-container');
            if (placeholders.length === 0) return;

            placeholders.forEach(async (placeholder) => {
                const prompt = placeholder.dataset.prompt;
                const imagePrompt = `UI Screenshot for an IT Administration guide showing: ${prompt}. Clean, professional, minimal.`;
                try {
                    const imageUrl = await callImageGenAPI(imagePrompt);
                    if (imageUrl) {
                        placeholder.innerHTML = `<img src="${imageUrl}" alt="${prompt}">`;
                    } else {
                        throw new Error('API returned no image.');
                    }
                } catch (error) {
                    console.error(`Failed to generate image for prompt: "${prompt}"`, error);
                    placeholder.innerHTML = `<p class="text-red-500 text-sm">Image generation failed.</p><p class="text-xs">${prompt}</p>`;
                }
            });
        }


        function addPostGenerationButtons(container, themeId, themeType) {
            let buttonBar = container.querySelector('.button-bar');
            if (buttonBar) buttonBar.remove();

            buttonBar = document.createElement('div');
            buttonBar.className = 'button-bar flex flex-wrap gap-2 mt-4 pt-4 border-t';
            buttonBar.style.borderColor = 'var(--color-card-border)';
            buttonBar.innerHTML = `
                <button class="btn-secondary text-sm refine-button">Refine with AI</button>
                <button class="btn-secondary text-sm copy-button">Copy Text</button>
                <button class="btn-secondary text-sm explore-button" data-theme-id="${themeId}" data-theme-type="${themeType}">Explore In-Depth</button>
            `;
            container.appendChild(buttonBar);
            buttonBar.querySelector('.copy-button').addEventListener('click', e => {
                const contentToCopy = e.target.closest('.details-container, #gemini-result-container');
                if(contentToCopy) copyElementTextToClipboard(contentToCopy, e.target);
            });
        }

        async function handleDiscoverMoreClick() {
            const button = document.getElementById('discover-more-button');
            const errorP = document.getElementById('discover-more-error');
            errorP.textContent = '';
            button.disabled = true;

            const existingTitles = Array.from(document.querySelectorAll('#main-grid h2')).map(h2 => h2.textContent);
            const prompt = `Generate 1 new, useful IT administration category NOT on this list: ${existingTitles.join(', ')}. Provide a "key" (camelCase, unique), "title", "description", an "initialPrompt" (for 10 items), and a "fullPrompt" (for 40-50). Prompts must request a JSON array of objects, each with id, title, and description. Return ONLY a valid JSON object.`;

            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if (!jsonText) throw new Error("AI did not return a new category.");
                const newCategory = parseJsonWithCorrections(jsonText);
                await generateAndPopulateAICategory(newCategory);
                await generateJumpToButtons();
            } catch (error) {
                console.error("Failed to discover more topics:", error);
                errorP.textContent = "Sorry, couldn't generate a new topic right now.";
            } finally {
                button.disabled = false;
            }
        }
        
        async function handleCustomVisualThemeGeneration() {
            const prompt = document.getElementById('theme-prompt').value;
            if(!prompt) return;

            const loader = document.getElementById('theme-loader-container');
            const errorContainer = document.getElementById('theme-error-container');
            const generateBtn = document.getElementById('generate-theme-btn');
            
            loader.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            generateBtn.disabled = true;

            try {
                const imagePrompt = `Artistic, abstract background image inspired by "${prompt}". Suitable for an IT website. Professional, clean. Wide aspect ratio, photographic, cinematic lighting.`;
                const [colorResult, imageResult] = await Promise.allSettled([callColorGenAPI(prompt), callImageGenAPI(imagePrompt)]);
                
                if (colorResult.status === 'fulfilled' && colorResult.value) applyTheme(colorResult.value);
                else throw colorResult.reason || new Error("Failed to generate color theme.");

                if (imageResult.status === 'fulfilled' && imageResult.value) applyHeaderImage(imageResult.value);
                else throw imageResult.reason || new Error("Failed to generate header image.");
                
                document.getElementById('themeGeneratorModal').classList.add('hidden');
            } catch (error) {
                showThemeError(error.message);
            } finally {
                loader.classList.add('hidden');
                generateBtn.disabled = false;
            }
        }
        
        function showThemeError(message) {
            const errorContainer = document.getElementById('theme-error-container');
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        async function generateJumpToButtons() {
            const container = document.getElementById('jump-to-nav-container');
            const cards = Array.from(document.querySelectorAll('#custom-plan-card, #main-grid .card'));
            if (cards.length <= 1) return;

            const cardData = cards.map(card => ({
                id: card.id,
                title: card.querySelector('h2')?.textContent
            })).filter(c => c.id && c.title);
            
            if (cardData.length === 0) return;
        
            const prompt = `For the following IT category titles, generate a very short, engaging label (1-2 words). Return a valid JSON object where keys are the original titles and values are the short labels. Titles: ${JSON.stringify(cardData.map(c => c.title))}`;
            
            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if (!jsonText) throw new Error("AI returned empty data for jump-to buttons.");
                
                const labels = parseJsonWithCorrections(jsonText);
                const buttonsHtml = cardData.map(card => {
                    const label = labels[card.title] || card.title.split(' ')[0];
                    return `<button class="jump-to-button" data-target-id="${card.id}">${label}</button>`;
                }).join('');

                container.innerHTML = `<div class="flex flex-wrap gap-2 justify-center">${buttonsHtml}</div>`;
                container.classList.remove('hidden');
            } catch (error) {
                console.error("Failed to generate jump-to buttons:", error);
                container.innerHTML = '';
                container.classList.add('hidden'); 
            }
        }

        function populateTypographySettings() {
            const fontSelect = document.getElementById('font-family-select');
            const sizeSelect = document.getElementById('font-size-select');
            const lineHeightSelect = document.getElementById('line-height-select');
            
            const fonts = { 'Default (Inter)': "'Inter', sans-serif", 'Lato': "'Lato', sans-serif", 'Montserrat': "'Montserrat', sans-serif", 'Nunito Sans': "'Nunito Sans', sans-serif", 'Open Sans': "'Open Sans', sans-serif", 'Poppins': "'Poppins', sans-serif", 'Roboto Slab': "'Roboto Slab', serif" };
            const sizes = { '14': '14px', '15': '15px', '16 (Default)': '16px', '17': '17px', '18': '18px' };
            const lineHeights = { '1.4': '1.4', '1.5 (Default)': '1.5', '1.6': '1.6', '1.7': '1.7', '1.8': '1.8' };

            Object.entries(fonts).forEach(([name, value]) => fontSelect.add(new Option(name, value)));
            Object.entries(sizes).forEach(([name, value]) => sizeSelect.add(new Option(name, value)));
            Object.entries(lineHeights).forEach(([name, value]) => lineHeightSelect.add(new Option(name, value)));

            fontSelect.value = fonts['Default (Inter)'];
            sizeSelect.value = '16px';
            lineHeightSelect.value = '1.5';
            
            root.style.setProperty('--font-family', fontSelect.value);
            root.style.setProperty('--font-size-base', sizeSelect.value);
            root.style.setProperty('--line-height-base', lineHeightSelect.value);
        }

        function copyElementTextToClipboard(element, button) {
            const textToCopy = element.innerText;
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed'; 
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => { button.textContent = originalText; }, 2000);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textarea);
        }

        /**
         * Renders markdown into an accordion structure inside a container.
         * It uses marked.js to convert markdown to HTML first, then builds the accordion.
         */
        function renderAccordionFromMarkdown(markdownText, containerElement, generateImages = true) {
            containerElement.innerHTML = ''; 
            if (!markdownText || !markdownText.trim()) {
                containerElement.innerHTML = convertMarkdownToHtml(null, false);
                return;
            }

            // Convert the entire markdown to HTML first.
            const fullHtml = convertMarkdownToHtml(markdownText, generateImages);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = fullHtml;

            const nodes = Array.from(tempDiv.childNodes);
            let currentAccordionItem = null;
            let introContent = document.createElement('div');
            introContent.className = 'accordion-intro mb-4';

            let firstHeaderFound = false;

            nodes.forEach(node => {
                // Collect any content before the first H3 as an introduction.
                if (!firstHeaderFound && node.tagName !== 'H3') {
                    introContent.appendChild(node.cloneNode(true));
                    return;
                }
                
                // When an H3 is found, it starts a new accordion item.
                if (node.tagName === 'H3') {
                    firstHeaderFound = true;
                    if (introContent.hasChildNodes()) {
                        containerElement.appendChild(introContent);
                        introContent = document.createElement('div'); // Reset for next potential non-accordion content
                    }

                    currentAccordionItem = document.createElement('div');
                    currentAccordionItem.className = 'accordion-item';

                    const title = node.textContent;
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'accordion-content';

                    currentAccordionItem.innerHTML = `
                        <button type="button" class="accordion-header">
                            <span class="text-left">${title}</span>
                            <svg class="icon w-5 h-5 transition-transform shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    `;
                    currentAccordionItem.appendChild(contentDiv);
                    containerElement.appendChild(currentAccordionItem);
                } else if (currentAccordionItem) {
                    // Add any subsequent nodes to the content of the current accordion item.
                    const contentDiv = currentAccordionItem.querySelector('.accordion-content');
                    contentDiv.appendChild(node.cloneNode(true));
                }
            });
            
            // If no H3s were found, render the whole content directly.
            if (!firstHeaderFound) {
                 containerElement.innerHTML = fullHtml;
                 return;
            }

            // Append any remaining intro content if it exists.
            if (introContent.hasChildNodes()) {
                containerElement.appendChild(introContent);
            }

            // Open the first accordion item by default.
            const firstItem = containerElement.querySelector('.accordion-item');
            if (firstItem) {
                firstItem.querySelector('.accordion-header').classList.add('active');
                firstItem.querySelector('.accordion-content').classList.add('open');
            }
        }
        
        async function handleAIHelpRequest() {
            const modal = document.getElementById('inDepthModal');
            const titleEl = document.getElementById('inDepthModalTitle');
            const contentEl = document.getElementById('inDepthModalContent');
            const footerEl = document.getElementById('inDepthModalFooter');

            titleEl.textContent = "AI Help & Feedback";
            contentEl.innerHTML = getLoaderHTML('Generating help guide...');
            modal.classList.remove('hidden');
            // Hide drive controls for this specific modal use
            document.getElementById('google-drive-controls').classList.add('hidden');


            const prompt = `
                Generate a user-friendly help guide for this "IT Administration Hub" application. Explain the key features in separate sections.
                The features are: 
                1. Custom Task Generator: User enters a task, AI creates a guide.
                2. Tailoring Options: Buttons to refine the custom guide (e.g., 'Security', 'For Beginners').
                3. Pre-Built Categories: AI-generated topics like VMware, Windows Server, etc.
                4. Visual Theme Generator: User describes a mood, AI creates a new color theme and header image.
                5. In-Depth Exploration: Expanding a summary to see a full, detailed guide, now with AI-generated images for screenshots.
                6. Refining Content: Taking an existing guide and giving the AI further instructions to rewrite it.
                Format the output as a markdown document with '###' for each section title.
            `;
            
            try {
                const resultText = await callGeminiAPI(prompt);
                renderAccordionFromMarkdown(resultText, contentEl, false);
            } catch (error) {
                handleApiError(error, contentEl, 'AI help content');
            }
        }
        
        async function handleExploreInDepth(themeId, themeType) {
            const item = allThemeData[themeType]?.find(d => String(d.id) === String(themeId));
            if (!item) {
                console.error("Could not find item for in-depth view", {themeId, themeType});
                return;
            }

            const modal = document.getElementById('inDepthModal');
            const titleEl = document.getElementById('inDepthModalTitle');
            const contentEl = document.getElementById('inDepthModalContent');
            const footerEl = document.getElementById('inDepthModalFooter');

            // Show drive controls when exploring a guide
            document.getElementById('google-drive-controls').classList.remove('hidden');
            
            titleEl.textContent = `In-Depth: ${item.title}`;
            contentEl.innerHTML = getLoaderHTML(`Generating detailed guide for ${item.title}...`);
            footerEl.dataset.themeId = themeId;
            footerEl.dataset.themeType = themeType;

            modal.classList.remove('hidden');
            
            const prompt = getEnhancedPrompt(item.title);

            try {
                const resultText = await callGeminiAPI(prompt);
                originalGeneratedText.set(themeId + '-full', resultText); 
                
                renderAccordionFromMarkdown(resultText, contentEl, false); // No images in modal

            } catch (error) {
                handleApiError(error, contentEl, 'in-depth content');
            }
        }
        
        function toggleRefineUI(buttonContainer, isModal = false) {
            let refineContainer = buttonContainer.nextElementSibling;
            if (refineContainer && refineContainer.classList.contains('refine-container')) {
                refineContainer.remove();
                return;
            }

            refineContainer = document.createElement('div');
            refineContainer.className = 'refine-container w-full';
            refineContainer.innerHTML = `
                <textarea class="w-full p-2 themed-input border rounded-lg" rows="2" placeholder="e.g., 'Make it for a junior admin' or 'Add PowerShell examples'"></textarea>
                <button class="btn-primary text-sm mt-2 submit-refinement-button" data-is-modal="${isModal}">Submit Refinement</button>
            `;
            buttonContainer.insertAdjacentElement('afterend', refineContainer);
            refineContainer.querySelector('textarea').focus();
        }

        async function handleRefineRequest(refineContainer) {
            const refinementRequest = refineContainer.querySelector('textarea').value;
            if (!refinementRequest) return;

            const isModal = refineContainer.querySelector('.submit-refinement-button').dataset.isModal === 'true';
            
            const contentArea = isModal ? document.getElementById('inDepthModalContent') : refineContainer.closest('.details-container, #gemini-result-container');
            const footerEl = document.getElementById('inDepthModalFooter');
            
            const themeId = isModal ? footerEl.dataset.themeId : contentArea.querySelector('.explore-button')?.dataset.themeId || 'custom-plan';
            const textKey = isModal ? themeId + '-full' : themeId;

            const originalText = originalGeneratedText.get(textKey);

            if (!originalText) {
                handleApiError({message: "Could not find the original text to refine. Please generate the content again first."}, contentArea, "refinement");
                return;
            }
            
            contentArea.innerHTML = getLoaderHTML(`Refining guide based on your request...`);
            
            const prompt = getEnhancedPrompt(refinementRequest, '', originalText);
            
            try {
                const newText = await callGeminiAPI(prompt);
                if (!newText || newText.trim() === '') {
                    handleApiError({ message: "The AI returned an empty response. Please try refining with a different request." }, contentArea, 'refinement');
                    return;
                }

                originalGeneratedText.set(textKey, newText);
                
                if (isModal) {
                    const contentEl = document.getElementById('inDepthModalContent');
                    renderAccordionFromMarkdown(newText, contentEl, false); // No images in modal
                    if (refineContainer) refineContainer.remove();
                } else {
                    renderAccordionFromMarkdown(newText, contentArea);
                    addPostGenerationButtons(contentArea, themeId, 'custom');
                    generateAndInjectImages(contentArea);
                }

            } catch(error) {
                handleApiError(error, contentArea, 'refinement');
            }
        }
        
        function getIconForTheme(themeType, themeId) { 
            const icons = {
                vmwareEsxi: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 12h14M12 5l7 7-7 7"></path></svg>`,
                windowsServer: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>`,
                m365Admin: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path></svg>`,
                citrixAdmin: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2.17-4.24a.5.5 0 10-.7.7l4.5 4.5a.5.5 0 00.7-.7l-4.5-4.5zm-5.66 0a.5.5 0 11-.7.7l4.5 4.5a.5.5 0 01.7-.7l-4.5-4.5zM12 3a9 9 0 100 18 9 9 0 000-18z"></path></svg>`,
                default: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`
            }
            return icons[themeType] || icons.default;
        }
        
        function getLoaderHTML(message) { return `<div class="flex justify-center items-center my-4"><div class="loader themed-loader"></div><p class="ml-4 themed-text-muted">${message}</p></div>`; }
        
        function generateErrorMessage(error, type = 'general') { console.error(`Error during ${type} generation:`, error); let message = `An unknown error occurred. ${error.message}`; const errText = error.message.toLowerCase(); if (errText.includes('safety') || errText.includes('blocked')) message = `Request blocked for safety reasons. Please try a different prompt.`; else if (errText.includes('api key not valid')) message = `Authentication failed. Your API Key is not valid.`; else if (errText.includes('429')) message = `Request limit exceeded. Please try again later.`; else if (errText.includes('timed out')) message = `The request timed out. Please check your connection and try again.`; return `Sorry, a critical error occurred: ${message}`; }

    </script>
</body>
</html>
", could we a new floating button "Generative AI" that opens a modal, then displays the current prompts that this app is using to retrieve its generative AI. I would like to be able to copy these prompts for editing the code in the futu
