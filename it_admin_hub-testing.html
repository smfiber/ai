<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Administration Hub</title>
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Nunito+Sans:wght@400;700&family=Open+Sans:wght@400;700&family=Poppins:wght@400;500;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* * ==============================================
         * CSS Custom Properties for Theming & Typography
         * ==============================================
        */
        :root {
            --color-bg: #f3e8ff;
            --color-text: #374151;
            --color-text-muted: #6b7280;
            --color-primary: #9333ea;
            --color-primary-dark: #7e22ce;
            --color-accent: #581c87;
            --color-card-bg: rgba(255, 255, 255, 0.9);
            --color-card-border: #e9d5ff;
            --color-input-bg: #f9fafb;
            --color-input-border: #d1d5db;
            --color-button-text: #ffffff;
            --code-bg: #282c34;
            --code-text: #abb2bf;
        }

        /* Applying the theme variables */
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family, 'Inter', sans-serif);
            background-color: var(--color-bg);
            color: var(--color-text);
            font-size: var(--font-size-base, '16px');
            line-height: var(--line-height-base, 1.5);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        
        /* General Prose styling for AI-generated content */
        .prose { font-size: inherit; line-height: 1.6; }
        .prose p { margin-bottom: 1rem; }
        .prose ul, .prose ol { 
            margin-bottom: 1rem;
            padding-left: 1.75rem;
        }
        .prose ul { list-style-type: disc; }
        .prose ol { list-style-type: decimal; }
        .prose li { margin-bottom: 0.5rem; padding-left: 0.25rem; }
        .prose li > p { margin-bottom: 0.25rem; }
        .prose li > ul, .prose li > ol { margin-top: 0.5rem; }
        .prose strong { font-weight: 600; color: var(--color-text); }
        .prose a { color: var(--color-primary); text-decoration: none; border-bottom: 1px solid var(--color-primary); }
        .prose a:hover { color: var(--color-primary-dark); border-bottom-color: var(--color-primary-dark); }
        .prose h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-accent);
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        
        .screenshot-placeholder, .image-generation-container {
            border: 2px dashed var(--color-card-border);
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
            background-color: var(--color-input-bg);
            text-align: center;
            color: var(--color-text-muted);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .screenshot-placeholder::before {
            content: 'üñºÔ∏è';
            display: block;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .image-generation-container img {
            max-width: 100%;
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* Code Block Styling */
        .code-block-container {
            background-color: var(--code-bg);
            border-radius: 8px;
            margin: 1.5rem 0;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            color: #d1d5db;
            font-size: 0.875rem;
            font-family: 'Inter', sans-serif;
        }
        .copy-code-button {
            background-color: rgba(255,255,255,0.1);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }
        .copy-code-button:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .code-block-container pre {
            background-color: transparent !important;
            margin: 0;
            padding: 1rem;
            color: var(--code-text);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .prose code, .code-block-container code {
            font-family: 'Menlo', 'Consolas', monospace;
            font-size: 0.9em;
        }


        .card {
            background-color: var(--color-card-bg);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, background-color 0.5s ease, border-color 0.5s ease, opacity 0.3s ease;
            border: 1px solid var(--color-card-border);
            display: flex; flex-direction: column;
        }
        .card:hover { box-shadow: 0 10px 20px -5px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .card-content { flex-grow: 1; display: flex; flex-direction: column; }

        .btn-primary {
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text);
            font-weight: 600; padding: 12px 24px; border-radius: 8px;
            transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none; cursor: pointer;
        }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 7px 10px rgba(0, 0, 0, 0.15); filter: brightness(1.1); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-secondary {
            background-color: var(--color-input-bg); color: var(--color-text-muted);
            font-weight: 600; padding: 10px 20px; border-radius: 8px;
            border: 1px solid var(--color-input-border); cursor: pointer;
            transition: all 0.2s ease; display: inline-flex;
            align-items: center; justify-content: center; gap: 8px;
        }
        .btn-secondary:hover:not(:disabled) { background-color: #e5e7eb; color: var(--color-accent); }
        .btn-secondary:disabled { opacity: 0.7; cursor: not-allowed;}
        
        .btn-toggle {
            background-color: var(--color-input-bg); color: var(--color-text-muted);
            border: 1px solid var(--color-input-border); transition: all 0.2s ease;
        }
        .btn-toggle.active {
            background-color: var(--color-accent); color: var(--color-button-text);
            border-color: var(--color-primary-dark); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .jump-to-button {
            background-color: var(--color-card-bg); color: var(--color-text-muted);
            border: 1px solid var(--color-card-border); transition: all 0.2s ease;
            padding: 8px 16px; border-radius: 9999px; font-size: 0.875rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .jump-to-button:hover { background-color: var(--color-primary); color: var(--color-button-text); border-color: var(--color-primary-dark); transform: translateY(-1px); }

        .floating-action-button {
            position: fixed; background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text); width: 56px; height: 56px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.1);
            cursor: pointer; transition: all 0.3s ease; z-index: 50;
        }
        .floating-action-button:hover { transform: translateY(-3px) scale(1.05); }
        #new-plan-button { bottom: 2rem; right: 2rem; }
        #settings-button { bottom: 6.5rem; right: 2rem; }
        #ai-help-button { bottom: 11rem; right: 2rem; }
        #theme-changer-button { bottom: 15.5rem; right: 2rem; }
        #prompts-button { bottom: 20rem; right: 2rem; }
        #scroll-to-top-button { bottom: 2rem; left: 2rem; }
        
        #settings-panel {
            position: fixed; bottom: 11rem; right: 2rem;
            background-color: var(--color-card-bg); border: 1px solid var(--color-card-border);
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 1rem; width: 280px; z-index: 40;
            transition: opacity 0.3s ease, transform 0.3s ease; transform-origin: bottom right;
        }

        .themed-text-primary { color: var(--color-primary); }
        .themed-text-accent { color: var(--color-accent); }
        .themed-text-muted { color: var(--color-text-muted); }
        .themed-input {
            background-color: var(--color-input-bg); border-color: var(--color-input-border);
            color: var(--color-text); transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        .themed-input::placeholder { color: var(--color-text-muted); opacity: 0.7; }
        .themed-input:focus { --tw-ring-color: var(--color-primary); }

        .loader { border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .themed-loader { border: 4px solid var(--color-card-border); border-top: 4px solid var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header-bg-image { 
            background-image: url('https://i.ibb.co/Kjs2bJvq/Image-fx-31.png'); 
            background-size: cover; background-position: center; opacity: 1;
            transition: opacity 1.5s ease-in-out;
        }
        .header-loader-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: white; }

        .accordion-item { border-bottom: 1px solid var(--color-card-border); }
        .accordion-item:last-child { border-bottom: none; }
        .accordion-header {
            width: 100%; text-align: left; padding: 1rem; display: flex; justify-content: space-between; align-items: center; font-weight: 600;
            color: var(--color-text); background-color: transparent; border: none; cursor: pointer; transition: background-color 0.2s;
        }
        .accordion-header:hover { background-color: rgba(0,0,0,0.03); }
        .accordion-content { padding: 1rem; display: none; }
        .accordion-content.open { display: block; }
        .accordion-header .icon { transition: transform 0.3s ease; }
        .accordion-header.active .icon { transform: rotate(180deg); }

        .refine-container { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-card-border); }
        
        .card-grid-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem; margin-top: 1rem; padding: 0.5rem; border-radius: 8px;
            background: rgba(0,0,0,0.02);
        }
        .grid-card-selector {
            position: relative; /* Positioning context for the checkmark */
            background-color: white; border: 1px solid var(--color-card-border);
            border-radius: 8px; padding: 1rem; text-align: center;
            cursor: pointer; transition: all 0.2s ease; font-size: 0.875rem; font-weight: 500;
            display: flex; flex-direction: column; justify-content: space-between; height: 100%;
        }
        .grid-card-selector:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .grid-card-selector.active {
            background-color: var(--color-accent); color: var(--color-button-text); border-color: var(--color-primary-dark);
        }
        .grid-card-selector .icon { margin-bottom: 0.5rem; }
        .grid-card-selector svg { width: 2.5rem; height: 2.5rem; margin: 0 auto; display: block; }
        .grid-card-selector.active small { color: rgba(255, 255, 255, 0.8); }

        /* NEW: Visual indicator for viewed items */
        .viewed-indicator {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 1.25rem;
            height: 1.25rem;
            background-color: #ef4444; /* red-500 */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .viewed-indicator svg {
            width: 0.75rem;
            height: 0.75rem;
        }

        /* Style for newly generated items */
        .new-item-highlight {
            border: 2px solid var(--color-primary);
            box-shadow: 0 0 10px var(--color-primary);
        }

    </style>
</head>
<body>
    
    <div id="apiKeyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="card p-8 w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4 themed-text-primary">Enter Your API Keys</h2>
            <p class="mb-4 themed-text-muted">Please provide the necessary API keys to use the application's features.</p>
            <form id="apiKeyForm">
                <div class="mb-4">
                    <label for="geminiApiKeyInput" class="block text-sm font-medium themed-text-muted">Gemini API Key (Required)</label>
                    <input type="password" id="geminiApiKeyInput" class="w-full mt-1 px-4 py-2 themed-input border rounded-lg focus:ring-2" placeholder="Your Gemini API Key" required>
                </div>

                <div class="mb-4">
                    <label for="firebaseConfigInput" class="block text-sm font-medium themed-text-muted">Firebase Config Object (Required)</label>
                    <textarea id="firebaseConfigInput" class="w-full mt-1 px-3 py-2 themed-input border rounded-lg focus:ring-2 font-mono text-xs" rows="6" placeholder="Paste your Firebase config snippet here."></textarea>
                     <p class="text-xs themed-text-muted mt-1">Find this in your Firebase project settings. You can paste the entire snippet.</p>
                </div>

                <h3 class="text-xl font-semibold mb-2 mt-6 themed-text-accent">Cloud Integrations (Optional)</h3>
                <p class="mb-2 themed-text-muted text-sm">To save/load guides from Google Drive, also provide your Client ID.</p>
                
                <div class="mb-4">
                    <label for="googleClientIdInput" class="block text-sm font-medium themed-text-muted">Google Cloud Client ID</label>
                    <input type="password" id="googleClientIdInput" class="w-full mt-1 px-4 py-2 themed-input border rounded-lg focus:ring-2" placeholder="For Google Drive integration">
                </div>
                
                <button type="submit" class="w-full btn-primary mt-6">Save Keys and Start</button>
            </form>
        </div>
    </div>
    <div id="loadingStateModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="card p-8 w-full max-w-md m-4 text-center">
            <h2 class="text-2xl font-bold mb-4 themed-text-primary">Waking up the AI...</h2>
            <div class="flex justify-center my-4"><div class="loader themed-loader"></div></div>
            <p id="loading-message" class="mb-6 themed-text-muted">The AI is generating the initial content and guides. This may take a few moments.</p>
            <button id="closeLoadingStateModal" class="btn-secondary">Close</button>
        </div>
    </div>
    <div id="inDepthModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-3xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 id="inDepthModalTitle" class="text-2xl font-bold themed-text-primary">In-Depth Guide</h2>
                <button id="closeInDepthModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="inDepthModalContent" class="p-6 overflow-y-auto"></div>
            <div id="inDepthModalFooter" class="p-4 border-t" style="border-color: var(--color-card-border);">
                 <div id="inDepthModalButtons" class="flex flex-wrap justify-center gap-2"></div>
                <p id="modal-status-message" class="text-xs text-center themed-text-muted mt-2"></p>
            </div>
        </div>
    </div>
    <div id="themeGeneratorModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-lg m-4 flex flex-col">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 class="text-2xl font-bold themed-text-primary">AI Visual Theme Generator</h2>
                <button id="closeThemeGeneratorModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div class="p-6">
                <p class="mb-6 themed-text-muted">Describe a mood or concept to create a new color palette and header image for the app.</p>
                <textarea id="theme-prompt" rows="3" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'Modern data center at dusk'"></textarea>
                <button id="generate-theme-btn" class="btn-primary w-full mt-4" title="Generate new app visuals based on your text">Generate Visuals</button>
                <div id="theme-loader-container" class="hidden mt-4 flex items-center space-x-3">
                    <div class="loader themed-loader" style="width:25px; height:25px;"></div>
                    <span class="themed-text-muted">AI is generating colors & image...</span>
                </div>
                <div id="theme-error-container" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>
            </div>
        </div>
    </div>
    <div id="promptsModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-4xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 class="text-2xl font-bold themed-text-primary">Application AI Prompts</h2>
                <button id="closePromptsModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="promptsModalContent" class="p-6 overflow-y-auto"></div>
        </div>
    </div>

    <div id="app-container" class="container mx-auto px-4 sm:px-6 lg:px-8 hidden">
        <header class="relative text-center mb-10 rounded-2xl overflow-hidden shadow-lg">
            <div id="header-loader" class="hidden absolute inset-0 bg-black bg-opacity-50 flex-col items-center justify-center z-20 transition-opacity duration-500">
                <div class="loader header-loader-spinner"></div>
                <p class="text-white mt-4 text-lg">Generating new header image...</p>
            </div>
            <div id="header-bg-image" class="absolute inset-0 header-bg-image"></div>
            <div class="absolute inset-0 bg-black opacity-40"></div>
            <div class="relative z-10 py-24 px-12 text-white">
                <h1 class="text-4xl md:text-5xl font-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.6);">IT Administration Hub</h1>
                <p class="text-lg text-purple-200 mt-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.6);">AI-powered guides and task generation for IT professionals.</p>
            </div>
            <div id="auth-status" class="absolute top-4 right-4"></div>
            <div id="version-display" class="absolute bottom-2 right-4 text-white text-xs opacity-70">v4.35</div>
        </header>

        <nav id="jump-to-nav-container" class="hidden text-center mb-8"></nav>

        <main id="main-content" class="space-y-8">
            <div id="imported-guides-section" class="hidden">
                 <h2 class="text-3xl font-bold text-center mb-4 themed-text-accent">Imported Guides</h2>
                 <div id="imported-guides-container" class="space-y-8"></div>
            </div>
            
            <div id="cloud-storage-card" class="card p-6 hidden">
                 <h2 class="text-xl font-bold themed-text-primary flex items-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.32-10.9A5 5 0 1 1 22 17Z"></path></svg>
                     Cloud Storage
                 </h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                     <div id="google-drive-section" class="hidden">
                          <h3 class="font-semibold themed-text-accent mb-2">Google Drive</h3>
                          <p id="drive-status" class="text-sm themed-text-muted mt-1 mb-3">Connect to load/save guides.</p>
                          <div class="flex gap-2">
                             <button id="auth-button" class="btn-secondary">Connect</button>
                             <button id="load-from-drive-btn" class="btn-secondary hidden">Import from Drive</button>
                         </div>
                     </div>
                     <div id="onedrive-section" class="hidden">
                          <h3 class="font-semibold themed-text-accent mb-2">Microsoft OneDrive</h3>
                          <p id="onedrive-status" class="text-sm themed-text-muted mt-1 mb-3">Connect to save guides.</p>
                          <div class="flex gap-2">
                             <button id="msal-auth-button" class="btn-secondary">Connect</button>
                         </div>
                     </div>
                 </div>
            </div>

            <div id="generative-ai-prompt-card" class="card">
                <div class="p-8 card-content">
                    <h2 class="text-2xl font-bold mb-2 themed-text-primary">Generative AI Prompt</h2>
                    <p class="mb-6 themed-text-muted">Need a guide for a specific task? Enter any keyword or concept, and let AI craft a step-by-step plan for you.</p>
                    <form id="gemini-form">
                        <input type="text" id="gemini-prompt" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'Configure a new firewall rule'">
                        
                        <div class="my-4 border rounded-lg" style="border-color: var(--color-card-border);">
                            <div class="accordion-item">
                                <button type="button" class="accordion-header" title="Click to see more options">
                                    <span>Tailor Your Guide:</span>
                                    <svg class="icon w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div class="accordion-content">
                                    <div id="tailoring-buttons-container" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary w-full mt-4" title="Generate a custom guide based on your text">Generate AI Guide</button>
                    </form>
                    <!-- This container is no longer used for custom guides, but kept for potential future use or other content -->
                    <div id="gemini-result-container" class="mt-6"></div>
                </div>
            </div>

            <div id="main-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                </div>
            
            <div id="discover-more-container" class="text-center py-8">
                <button id="discover-more-button" class="btn-primary px-8 py-4 text-lg" title="Generate a new random IT category">
                    <span class="flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v2.5"/><path d="M12 22v-2.5"/><path d="M21.5 12.5h-2.5"/><path d="M4.5 12.5h2.5"/><path d="M18.89 6.11l-1.77 1.77"/><path d="M6.88 18.88l-1.77 1.77"/></svg>
                        Discover More IT Topics
                    </span>
                </button>
                <p id="discover-more-error" class="text-red-500 mt-2"></p>
            </div>
        </main>
    </div>

    <button id="prompts-button" class="floating-action-button" title="View AI Prompts">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 16 4-4-4-4"/><path d="m6 8-4 4 4 4"/><path d="m14.5 4-5 16"/></svg>
    </button>
    <button id="theme-changer-button" class="floating-action-button" title="Change Visual Theme">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l.34.34a8 8 0 0111.32 11.32l-.34.34a8 8 0 01-11.32-11.32l.34-.34z"/><path d="M16 12l-4.5 4.5-2.5-2.5"/><path d="M22 12s-4-8-10-8S2 12 2 12s4 8 10 8 10-8 10-8z"/></svg>
    </button>
    <button id="ai-help-button" class="floating-action-button" title="AI Help & Feedback">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"/><path d="M12 22A10 10 0 1 0 12 2a10 10 0 0 0 0 20z"/></svg>
    </button>
    <button id="settings-button" class="floating-action-button" title="Typography Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
    </button>
    <button id="new-plan-button" class="floating-action-button" title="New Session (Reload)">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
    </button>
    <button id="scroll-to-top-button" class="floating-action-button hidden" title="Scroll to top">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
    </button>
    <div id="settings-panel" class="hidden"><h3 class="text-lg font-bold themed-text-accent mb-4">Display Settings</h3><div class="space-y-4"><div><label for="font-family-select" class="block text-sm font-medium themed-text-muted mb-1">Font Family</label><select id="font-family-select" class="w-full p-2 themed-input border rounded-lg"></select></div><div><label for="font-size-select" class="block text-sm font-medium themed-text-muted mb-1">Font Size (px)</label><select id="font-size-select" class="w-full p-2 themed-input border rounded-lg"></select></div><div><label for="line-height-select" class="block text-sm font-medium themed-text-muted mb-1">Line Spacing</label><select id="line-height-select" class="w-full p-2 themed-input border rounded-lg"></select></div></div></div>

    <footer class="mt-16 py-8 text-center border-t" style="border-color: var(--color-card-border);">
        <div class="max-w-4xl mx-auto px-4">
            <p class="themed-text-muted font-semibold">Disclaimer</p>
            <p class="themed-text-muted text-sm mt-2">
                This application and its content are for informational and educational purposes only. The administrative guides and suggestions generated by AI are not a substitute for professional IT advice, vendor documentation, or certified training. Always test procedures in a non-production environment before applying them to live systems. Never disregard official documentation or professional advice because of something you have read on this application. The creators of this application are not responsible for any data loss, system downtime, or damages that may result from the use of these guides.
            </p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, Timestamp, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase State ---
        let db;
        let auth;
        let userId;
        let viewedItemsCollectionRef;
        const viewedItemIds = new Set();
        let firebaseConfig = null;
        let appIsInitialized = false;
        
        // --- Global State & Configuration ---
        let geminiApiKey = "";
        const root = document.documentElement;
        const allThemeData = {};
        const fullPrompts = {}; 
        let originalGeneratedText = new Map();

        // --- Google Drive Integration State & Config ---
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let GOOGLE_CLIENT_ID = '';
        const G_SCOPES = 'https://www.googleapis.com/auth/drive.file';
        let driveFolderId = null;

        // --- Microsoft OneDrive Integration State & Config ---
        let msalInstance = null;
        let MSAL_CLIENT_ID = ''; 
        const MSAL_SCOPES = { scopes: ["User.Read", "Files.ReadWrite.AppFolder"] };
        let msalAccount = null;
        
        // --- App Initialization & Event Listeners ---
        function initializeApplication() {
            setupEventListeners();
            populateTypographySettings();
            marked.setOptions({
                renderer: new marked.Renderer(),
                highlight: (code, lang) => code,
                langPrefix: 'language-',
                gfm: true,
                breaks: true,
            });

            // Load credentials. If successful, initialize Firebase.
            // GAPI/MSAL initialization is now deferred until after successful Firebase auth.
            if (loadConfigFromStorage()) {
                initializeFirebase();
            } else {
                document.getElementById('apiKeyModal').classList.remove('hidden');
            }
        }
        
        document.addEventListener('DOMContentLoaded', initializeApplication);

        function loadConfigFromStorage() {
            geminiApiKey = localStorage.getItem('geminiApiKey');
            const firebaseConfigString = localStorage.getItem('firebaseConfig');
            GOOGLE_CLIENT_ID = localStorage.getItem('googleClientId');

            if (firebaseConfigString) {
                try {
                    firebaseConfig = JSON.parse(firebaseConfigString);
                } catch (e) {
                    console.error("Failed to parse Firebase config from localStorage", e);
                    localStorage.clear();
                    return false;
                }
            }

            if (geminiApiKey && firebaseConfig) {
                document.getElementById('geminiApiKeyInput').value = geminiApiKey;
                document.getElementById('firebaseConfigInput').value = JSON.stringify(firebaseConfig, null, 2);
                if (GOOGLE_CLIENT_ID) {
                    document.getElementById('googleClientIdInput').value = GOOGLE_CLIENT_ID;
                }
                return true;
            }
            return false;
        }
        
        function setupAuthUI(user) {
            const authStatusEl = document.getElementById('auth-status');
            const appContainer = document.getElementById('app-container');
            const apiKeyModal = document.getElementById('apiKeyModal');

            if (user) {
                appContainer.classList.remove('hidden');
                apiKeyModal.classList.add('hidden');
                
                authStatusEl.innerHTML = `
                    <div class="bg-white/20 backdrop-blur-sm rounded-full p-1 flex items-center gap-2 text-white text-sm">
                        <img src="${user.photoURL}" alt="User photo" class="w-8 h-8 rounded-full">
                        <span class="font-medium pr-2">${user.displayName}</span>
                        <button id="sign-out-button" class="bg-white/20 hover:bg-white/40 text-white font-bold h-8 w-8 rounded-full flex items-center justify-center" title="Sign Out">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        </button>
                    </div>
                `;
                document.getElementById('sign-out-button').addEventListener('click', () => signOut(auth));
                
                if (!appIsInitialized) {
                    initializeAppContent();
                }

            } else {
                appContainer.classList.add('hidden');
            }
        }
        
        async function initializeAppContent() {
            appIsInitialized = true;
            const loadingModal = document.getElementById('loadingStateModal');
            const loadingMessageEl = document.getElementById('loading-message');
            loadingMessageEl.textContent = "The AI is generating the initial content and guides. This may take a few moments.";
            loadingModal.classList.remove('hidden');

            document.getElementById('main-grid').innerHTML = '';
            document.getElementById('jump-to-nav-container').innerHTML = '';
            document.getElementById('gemini-result-container').innerHTML = '';
            document.getElementById('discover-more-error').innerHTML = '';

            try {
                await generateAndApplyDefaultTheme();
                await loadAppContent(loadingMessageEl);
            } catch (error) {
                console.error("A critical error occurred during app initialization:", error.message);
                localStorage.clear();
                document.getElementById('apiKeyModal').classList.remove('hidden');
                const form = document.getElementById('apiKeyForm');
                let errorP = form.querySelector('.error-message');
                if (!errorP) {
                    errorP = document.createElement('p');
                    errorP.className = 'error-message text-red-500 text-sm mt-4 text-center';
                    form.appendChild(errorP);
                }
                errorP.textContent = `Setup failed: ${error.message}. Your keys have been cleared. Please check and re-enter them.`;
            } finally {
                loadingModal.classList.add('hidden');
            }
        }

        function initializeFirebase() {
             if (!firebaseConfig) {
                console.warn("Firebase config is missing. Firebase initialization skipped.");
                return;
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                getRedirectResult(auth)
                    .then((result) => {
                        if (result) {
                            console.log("Successfully handled sign-in redirect.", result.user);
                        }
                    }).catch((error) => {
                        console.error("Error processing sign-in redirect:", error);
                        alert(`Sign-in failed: ${error.message}`);
                    });

                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        const appId = firebaseConfig.appId || 'it-admin-hub-global'; 
                        viewedItemsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/viewedItems`);
                        listenForViewedItems();
                        
                        // --- LOGIN FIX ---
                        // Defer GAPI/MSAL initialization until after Firebase auth state is confirmed.
                        // This prevents race conditions between Firebase's redirect handling and GAPI's initialization.
                        if (GOOGLE_CLIENT_ID && !gapiInited && !gisInited) {
                            document.getElementById('google-drive-section').classList.remove('hidden');
                            gapi.load('client:picker', () => {
                                gisInited = true;
                                initializeGapiClient();
                            });
                        }
                        // You can add a similar check for MSAL if needed.

                    } else {
                        userId = null;
                        viewedItemsCollectionRef = null;
                    }
                    setupAuthUI(user);
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                const form = document.getElementById('apiKeyForm');
                let errorP = form.querySelector('.error-message');
                 if (!errorP) {
                    errorP = document.createElement('p');
                    errorP.className = 'error-message text-red-500 text-sm mt-4 text-center';
                    form.appendChild(errorP);
                }
                errorP.textContent = `Firebase Error: ${error.message}. Please check your config object.`;
                document.getElementById('apiKeyModal').classList.remove('hidden');
            }
        }
        
        function listenForViewedItems() {
            if (!viewedItemsCollectionRef) return;
            onSnapshot(viewedItemsCollectionRef, (snapshot) => {
                const newViewedIds = new Set();
                snapshot.forEach(doc => {
                    newViewedIds.add(doc.id);
                });
                
                if (newViewedIds.size !== viewedItemIds.size) {
                    viewedItemIds.clear();
                    newViewedIds.forEach(id => viewedItemIds.add(id));
                    
                    document.querySelectorAll('.card-grid-container').forEach(container => {
                        const containerId = container.parentElement.id;
                        const themeType = container.parentElement.dataset.themeType;
                        if(containerId && themeType && allThemeData[themeType]) {
                           populateCardGridSelector(containerId, themeType);
                        }
                    });
                }
            }, (error) => {
                console.error("Error listening to viewed items:", error);
            });
        }


        function setupEventListeners() {
            document.getElementById('apiKeyForm').addEventListener('submit', handleApiKeySubmit);
            document.getElementById('gemini-form').addEventListener('submit', handleGeminiSubmit);
            document.getElementById('generate-theme-btn').addEventListener('click', handleCustomVisualThemeGeneration);
            document.getElementById('discover-more-button').addEventListener('click', handleDiscoverMoreClick);

            document.getElementById('auth-button').addEventListener('click', handleAuthClick);
            document.getElementById('load-from-drive-btn').addEventListener('click', async () => {
                const folderId = await getDriveFolderId();
                createPicker('open', folderId);
            });
            document.getElementById('msal-auth-button').addEventListener('click', handleMsalAuthClick);

            document.getElementById('new-plan-button').addEventListener('click', () => location.reload());
            document.getElementById('prompts-button').addEventListener('click', displayPromptsInModal);
            document.getElementById('theme-changer-button').addEventListener('click', () => {
                if(!geminiApiKey) {
                    document.getElementById('apiKeyModal').classList.remove('hidden');
                    return;
                }
                document.getElementById('themeGeneratorModal').classList.remove('hidden');
            });
            document.getElementById('ai-help-button').addEventListener('click', handleAIHelpRequest);
            document.getElementById('scroll-to-top-button').addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
            
            const settingsPanel = document.getElementById('settings-panel');
            document.getElementById('settings-button').addEventListener('click', (e) => {
                e.stopPropagation();
                settingsPanel.classList.toggle('hidden');
            });

            document.getElementById('font-family-select').addEventListener('change', (e) => root.style.setProperty('--font-family', e.target.value));
            document.getElementById('font-size-select').addEventListener('change', (e) => root.style.setProperty('--font-size-base', e.target.value));
            document.getElementById('line-height-select').addEventListener('change', (e) => root.style.setProperty('--line-height-base', e.target.value));
            
            ['themeGeneratorModal', 'inDepthModal', 'promptsModal', 'loadingStateModal'].forEach(id => {
                const modal = document.getElementById(id);
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target.id === id || e.target.closest('[id^="close"]')) {
                            modal.classList.add('hidden');
                        }
                    });
                }
            });

            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('copy-code-button')) {
                    const codeBlock = e.target.closest('.code-block-container').querySelector('code, pre');
                    copyElementTextToClipboard(codeBlock, e.target);
                    return;
                }
                
                if (e.target.id === 'save-to-drive-btn') {
                     handleSaveToDriveClick(e.target);
                     return;
                }

                if (e.target.id === 'save-to-onedrive-btn') {
                    handleSaveToOneDriveClick(e.target);
                    return;
                }

                const tailorBtn = e.target.closest('#tailoring-buttons-container .btn-toggle');
                if (tailorBtn) {
                    tailorBtn.classList.toggle('active');
                    return;
                }

                const gridSelector = e.target.closest('.grid-card-selector');
                if (gridSelector) {
                    const container = gridSelector.closest('.card-grid-container').parentElement;
                    const currentlyActive = container.querySelector('.grid-card-selector.active');
                    if(currentlyActive) currentlyActive.classList.remove('active');
                    gridSelector.classList.add('active');
                    handleGridSelect(gridSelector);
                    return;
                }

                const exploreBtn = e.target.closest('.explore-button');
                if (exploreBtn) {
                    const cardName = exploreBtn.closest('.card').querySelector('h2').textContent;
                    handleExploreInDepth(exploreBtn.dataset.themeId, exploreBtn.dataset.themeType, cardName);
                    return;
                }
                
                const refineBtn = e.target.closest('.refine-button');
                if (refineBtn) {
                    toggleRefineUI(refineBtn.parentElement);
                    return;
                }

                const modalRefineBtn = e.target.closest('.modal-refine-button');
                if (modalRefineBtn) {
                    toggleRefineUI(modalRefineBtn.parentElement, true);
                    return;
                }
                
                const submitRefineBtn = e.target.closest('.submit-refinement-button');
                if(submitRefineBtn) {
                    handleRefineRequest(submitRefineBtn.closest('.refine-container'));
                    return;
                }
                
                const showAllBtn = e.target.closest('.show-all-button');
                if (showAllBtn) {
                    handleShowAllClick(showAllBtn);
                    return;
                }

                const generateMoreBtn = e.target.closest('.generate-more-button');
                if (generateMoreBtn) {
                    handleGenerateMoreClick(generateMoreBtn);
                    return;
                }

                const accordionHeader = e.target.closest('.accordion-header');
                if (accordionHeader) { 
                    accordionHeader.classList.toggle('active');
                    const icon = accordionHeader.querySelector('.icon');
                    if(icon) {
                       icon.style.transform = accordionHeader.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0deg)';
                    }
                    accordionHeader.nextElementSibling.classList.toggle('open'); 
                    return;
                }
                
                const jumpToBtn = e.target.closest('.jump-to-button');
                if (jumpToBtn) {
                    const targetCard = document.getElementById(jumpToBtn.dataset.targetId);
                    if (targetCard) {
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'start'});
                        targetCard.style.boxShadow = '0 0 0 4px var(--color-primary)';
                        setTimeout(() => targetCard.style.boxShadow = '', 2000);
                    }
                    return;
                }

                if (!settingsPanel.classList.contains('hidden') && !settingsPanel.contains(e.target) && !e.target.closest('#settings-button')) {
                    settingsPanel.classList.add('hidden');
                }
            });
            
            window.addEventListener('scroll', () => {
                const scrollTopButton = document.getElementById('scroll-to-top-button');
                if (window.scrollY > 300) {
                    scrollTopButton.classList.remove('hidden');
                } else {
                    scrollTopButton.classList.add('hidden');
                }
            });
        }
        
        async function handleApiKeySubmit(e) {
            e.preventDefault();
            const tempGeminiKey = document.getElementById('geminiApiKeyInput').value.trim();
            const tempFirebaseConfigText = document.getElementById('firebaseConfigInput').value.trim();
            const tempGoogleClientId = document.getElementById('googleClientIdInput').value.trim();
            let tempFirebaseConfig;

            const form = document.getElementById('apiKeyForm');
            let errorP = form.querySelector('.error-message');
            if (!errorP) {
                errorP = document.createElement('p');
                errorP.className = 'error-message text-red-500 text-sm mt-4 text-center';
                form.appendChild(errorP);
            }
            errorP.textContent = ''; 

            if (!tempGeminiKey || !tempFirebaseConfigText) {
                errorP.textContent = "Gemini API Key and Firebase Config are required.";
                return;
            }
            
            // *** MODIFIED: Use a more robust parsing method for the Firebase config ***
            try {
                const match = tempFirebaseConfigText.match(/\{[\s\S]*\}/);
                if (!match) {
                    throw new Error("Could not find a config object starting with '{' and ending with '}'.");
                }
                const configString = match[0];
                
                // Use new Function() to safely parse the config as a JavaScript object,
                // which is more robust than JSON.parse for user-pasted snippets from Firebase.
                const configFactory = new Function(`return ${configString}`);
                tempFirebaseConfig = configFactory();

                if (!tempFirebaseConfig || typeof tempFirebaseConfig !== 'object' || !tempFirebaseConfig.apiKey || !tempFirebaseConfig.projectId) {
                    throw new Error("The parsed Firebase config is invalid or missing required properties like 'apiKey' or 'projectId'.");
                }
            } catch (err) {
                errorP.textContent = `Invalid Firebase Config: ${err.message}. Please ensure you've pasted the complete snippet from your Firebase project settings.`;
                return;
            }
            
            localStorage.setItem('geminiApiKey', tempGeminiKey);
            localStorage.setItem('firebaseConfig', JSON.stringify(tempFirebaseConfig));
            localStorage.setItem('googleClientId', tempGoogleClientId);
            
            loadConfigFromStorage();
            initializeFirebase();
            
            try {
                const provider = new GoogleAuthProvider();
                await signInWithRedirect(auth, provider);
            } catch (error) {
                console.error("Google Sign-In Redirect failed:", error);
                errorP.textContent = `Google Sign-In Failed: ${error.message}`;
            }
        }

        // --- Google Drive & Firebase Functions ---
        
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: geminiApiKey,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
                gapiInited = true;
                initializeTokenClient();

            } catch(error) {
                console.error("Error initializing GAPI Client", error);
                document.getElementById('drive-status').textContent = 'Google API init failed. Check keys.';
            }
        }

        function initializeTokenClient() {
            if (!GOOGLE_CLIENT_ID) {
                console.error("Google Client ID is missing.");
                return;
            }
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: G_SCOPES,
                callback: (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        gapi.client.setToken(tokenResponse);
                        updateSigninStatus(true);
                    } else {
                        console.error('Provided token response was invalid.', tokenResponse);
                        updateSigninStatus(false);
                    }
                },
            });
            tokenClient.requestAccessToken({prompt: 'none'});
        }


        function handleAuthClick() {
             if (!gapiInited || !gisInited || !tokenClient) {
                console.error('Google services are not initialized yet.');
                document.getElementById('drive-status').textContent = 'Services initializing, please wait...';
                return;
            }

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                const token = gapi.client.getToken();
                if (token) {
                    google.accounts.oauth2.revoke(token.access_token, () => {
                        gapi.client.setToken(null);
                        updateSigninStatus(false);
                    });
                }
            }
        }
        
        function updateSigninStatus(isSignedIn) {
            const authButton = document.getElementById('auth-button');
            const loadBtn = document.getElementById('load-from-drive-btn');
            const statusEl = document.getElementById('drive-status');
            
            if (isSignedIn) {
                authButton.textContent = 'Sign Out';
                loadBtn.classList.remove('hidden');
                statusEl.textContent = 'Connected to Google Drive.';
                getDriveFolderId(); 
            } else {
                authButton.textContent = 'Connect';
                loadBtn.classList.add('hidden');
                statusEl.textContent = 'Connect to load/save guides.';
                driveFolderId = null;
            }
        }

        async function getDriveFolderId() {
            if (driveFolderId) return driveFolderId;
            const driveStatusEl = document.getElementById('drive-status');
            driveStatusEl.textContent = 'Searching for app folder...';
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: "mimeType='application/vnd.google-apps.folder' and name='IT Administration Hub' and trashed=false",
                    fields: 'files(id, name)',
                });

                if (response.result.files && response.result.files.length > 0) {
                    driveFolderId = response.result.files[0].id;
                } else {
                    driveStatusEl.textContent = 'Creating app folder...';
                    const folderResponse = await gapi.client.drive.files.create({
                        resource: { 'name': 'IT Administration Hub', 'mimeType': 'application/vnd.google-apps.folder' },
                        fields: 'id'
                    });
                    driveFolderId = folderResponse.result.id;
                }
                updateSigninStatus(true);
                return driveFolderId;
            } catch (error) {
                console.error("Error finding/creating Drive folder:", error);
                driveStatusEl.textContent = 'Error with Drive folder access.';
                return null;
            }
        }
        
        async function handleSaveToDriveClick(button) {
             const modalFooter = button.closest('#inDepthModalFooter');
             const { cardName, fullTitle } = modalFooter.dataset;
             
             const rawMarkdown = originalGeneratedText.get(fullTitle);
             if (!rawMarkdown) {
                console.error("Could not find markdown to save for:", fullTitle);
                return;
             }

             const fileName = `${cardName} - ${document.getElementById('inDepthModalTitle').textContent}.md`.replace(/In-Depth: |Custom Guide: /g, '');
             const statusEl = document.getElementById('modal-status-message');
             
             await saveContentToDrive(rawMarkdown, fileName, statusEl);
        }

        async function saveContentToDrive(content, fileName, statusElement) {
            if (gapi.client.getToken() === null) {
                statusElement.textContent = 'Please connect to Google Drive first.';
                return;
            }

            statusElement.textContent = 'Saving to Google Drive...';
            const folderId = await getDriveFolderId();
            if (!folderId) {
                statusElement.textContent = 'Could not find or create the app folder in Drive.';
                return;
            }
           
            const fileMetadata = { name: fileName, parents: [folderId] };
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";
            const multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(fileMetadata) + delimiter + 'Content-Type: text/markdown\r\n\r\n' + content + close_delim;
            
            try {
                await gapi.client.request({
                    'path': '/upload/drive/v3/files',
                    'method': 'POST',
                    'params': {'uploadType': 'multipart'},
                    'headers': {'Content-Type': 'multipart/related; boundary="' + boundary + '"'},
                    'body': multipartRequestBody
                });
                statusElement.textContent = `File '${fileName}' saved to Drive!`;
                 setTimeout(()=> statusElement.textContent = '', 4000);
            } catch (error) {
                console.error('Error saving file to Drive:', error);
                statusElement.textContent = 'Error saving file. Check console.';
            }
        }


        function createPicker(mode, startInFolderId = null) { 
            if (!gisInited) {
                 console.error("Google services not ready for picker.");
                 (document.getElementById('drive-status') || document.getElementById('modal-status-message')).textContent = 'Google API not ready.';
                 return;
             }
            
             const token = gapi.client.getToken()?.access_token;
             if (!token) {
                 (document.getElementById('drive-status') || document.getElementById('modal-status-message')).textContent = 'You are not signed in.';
                 return;
             }
             const builder = new google.picker.PickerBuilder()
                .setOAuthToken(token);

             if (mode === 'open') {
                const view = new google.picker.View(google.picker.ViewId.DOCS);
                view.setMimeTypes("text/markdown,text/plain,.md");
                if (startInFolderId) {
                    view.setParent(startInFolderId);
                }
                builder.addView(view).setCallback(pickerCallbackOpen);
             } 

             const picker = builder.build();
             picker.setVisible(true);
        }

        async function pickerCallbackOpen(data) {
            if (data.action === google.picker.Action.PICKED) {
                const fileId = data.docs[0].id;
                const statusEl = document.getElementById('drive-status');
                statusEl.textContent = 'Loading selected file...';
                try {
                    const response = await gapi.client.drive.files.get({ fileId, alt: 'media' });
                    const fileContent = response.body;
                    const fileName = data.docs[0].name;
                    
                    displayImportedGuide(fileName, fileContent);
                    statusEl.textContent = 'File loaded successfully.';
                    setTimeout(() => updateSigninStatus(true), 3000);

                } catch (error) {
                    console.error("Error loading file content:", error);
                    statusEl.textContent = 'Error loading file from Google Drive.';
                }
            }
        }
        
        // --- Microsoft OneDrive Functions ---
        
        function initializeMsal() {
            if (!MSAL_CLIENT_ID) return;
            const config = { auth: { clientId: MSAL_CLIENT_ID, authority: "https://login.microsoftonline.com/common" } };
            msalInstance = new msal.PublicClientApplication(config);
            msalInstance.handleRedirectPromise().then(resp => {
                if (resp !== null) {
                    msalAccount = resp.account;
                    updateMsalSigninStatus(true);
                } else {
                    const currentAccounts = msalInstance.getAllAccounts();
                    if (currentAccounts.length > 0) {
                        msalAccount = currentAccounts[0];
                        updateMsalSigninStatus(true);
                    }
                }
            }).catch(err => console.error(err));
        }
        
        function handleMsalAuthClick() {
            if (!msalInstance) return;
            if (msalAccount) {
                msalInstance.logoutRedirect({ account: msalAccount });
            } else {
                msalInstance.loginRedirect(MSAL_SCOPES);
            }
        }
        
        function updateMsalSigninStatus(isSignedIn) {
            const authButton = document.getElementById('msal-auth-button');
            const statusEl = document.getElementById('onedrive-status');
            if(isSignedIn) {
                authButton.textContent = 'Sign Out';
                statusEl.textContent = `Connected as ${msalAccount.username}.`;
            } else {
                authButton.textContent = 'Connect';
                statusEl.textContent = 'Connect to save guides.';
            }
        }

        async function handleSaveToOneDriveClick(button) {
            const modalFooter = button.closest('#inDepthModalFooter');
            const { cardName, fullTitle } = modalFooter.dataset;
            
            const rawMarkdown = originalGeneratedText.get(fullTitle);
            if (!rawMarkdown) {
                console.error("Could not find markdown to save for:", fullTitle);
                return;
            }

            const fileName = `${cardName} - ${document.getElementById('inDepthModalTitle').textContent}.md`.replace(/In-Depth: |Custom Guide: /g, '');
            const statusEl = document.getElementById('modal-status-message');
            
            if (!msalAccount) {
                statusEl.textContent = 'Please connect to OneDrive first.';
                return;
            }

            statusEl.textContent = 'Saving to OneDrive...';
            
            try {
                const tokenResponse = await msalInstance.acquireTokenSilent({ ...MSAL_SCOPES, account: msalAccount });
                
                const filePath = `special/approot:/IT Administration Hub/${fileName}:/content`;
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${tokenResponse.accessToken}`,
                        'Content-Type': 'text/plain'
                    },
                    body: rawMarkdown
                });

                if (response.ok) {
                    statusEl.textContent = `File '${fileName}' saved to OneDrive!`;
                    setTimeout(() => statusEl.textContent = '', 4000);
                } else {
                    const error = await response.json();
                    if (error.error.code === 'itemNotFound') {
                         statusEl.textContent = 'Folder not found. Trying to create... Please try again.';
                    } else {
                        throw new Error(`Graph API Error: ${error.error.message}`);
                    }
                }
            } catch(error) {
                console.error("Error saving to OneDrive:", error);
                 if (error.errorCode === 'consent_required' || error.errorCode === 'interaction_required') {
                    statusEl.textContent = 'Permissions required. Please try signing in again.';
                    msalInstance.acquireTokenPopup(MSAL_SCOPES).catch(err => console.error(err));
                } else {
                    statusEl.textContent = `Error: ${error.message}`;
                }
            }
        }

        function displayImportedGuide(fileName, markdownContent) {
            const section = document.getElementById('imported-guides-section');
            const container = document.getElementById('imported-guides-container');
            section.classList.remove('hidden');

            const cardId = `imported-${fileName.replace(/[^a-zA-Z0-9]/g, '')}-${Date.now()}`;
            
            const card = document.createElement('div');
            card.className = 'card md:col-span-2';
            card.id = cardId;
            
            const cardContent = document.createElement('div');
            cardContent.className = 'p-8 card-content';
            
            cardContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-2 themed-text-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                    Imported: ${fileName}
                </h2>
                <div class="prose max-w-none mt-4"></div>
            `;
            
            const renderTarget = cardContent.querySelector('.prose');
            renderAccordionFromMarkdown(markdownContent, renderTarget, false);

            card.appendChild(cardContent);
            container.prepend(card);

            card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // --- Core Application Functions ---

        async function loadAppContent(loadingMessageEl) {
            try {
                const categoriesToGenerate = [
                    { 
                        key: 'activeDirectory', 
                        title: 'Active Directory Management', 
                        description: "Tasks for managing users, groups, GPOs, and other AD objects.", 
                        initialPrompt: `Generate 10 common administrative tasks for Active Directory Management. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for Active Directory Management. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'aiProgramming', 
                        title: 'Artificial Intelligence (AI) Programming', 
                        description: "Concepts and guides for getting started with AI development and programming.", 
                        initialPrompt: `Generate 10 common topics for an introduction to AI Programming. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 topics for learning AI Programming, from beginner to advanced. For each, give a unique "id", "title", and a detailed "description" of the topic. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'citrixAdmin', 
                        title: 'Citrix Administration', 
                        description: "Managing Citrix Virtual Apps and Desktops environments.", 
                        initialPrompt: `Generate 10 common administrative tasks for Citrix. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for Citrix. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'dataCenterPractices', 
                        title: 'Data Center Best Practices', 
                        description: "Guides on data center operations, cooling, power, and security.", 
                        initialPrompt: `Generate 10 best practices for data center management. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 best practices for modern data center management. For each, give a unique "id", "title", and a detailed "description" of the practice. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'webDesignBestPractices', 
                        title: 'Designing Web Pages Best Practices', 
                        description: "Best practices for UI/UX, accessibility, and performance in web design.", 
                        initialPrompt: `Generate 10 best practices for designing web pages. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 detailed best practices for designing modern web pages. For each, give a unique "id", "title", and a detailed "description" of the practice. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'webDesignGemini', 
                        title: 'Designing Web Pages with Gemini AI', 
                        description: "Using Gemini AI to assist in the design and development of web pages.", 
                        initialPrompt: `Generate 10 ways to use Gemini AI for web design. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 detailed methods for using Gemini AI in web design and development. For each, give a unique "id", "title", and a detailed "description" of the method. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'dosCommands', 
                        title: 'DOS Commands for Administrators', 
                        description: "A reference for essential DOS and Command Prompt commands for system admins.", 
                        initialPrompt: `Generate 10 essential DOS commands for administrators. For each, give a unique "id", "title" (the command itself), and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 essential and advanced DOS/CMD commands for administrators. For each, give a unique "id", "title" (the command itself), and a detailed "description" of its use and parameters. Return ONLY a valid JSON array.` 
                    },
                     { 
                        key: 'geminiCliGuide', 
                        title: 'A Guide to Using the Gemini CLI', 
                        description: "Learn how to use the Gemini Command Line Interface for various tasks.", 
                        initialPrompt: `Generate 10 common use cases for the Gemini CLI. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced use cases and commands for the Gemini CLI. For each, give a unique "id", "title", and a detailed "description" of the use case. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'hpeProLiant', 
                        title: 'HPE ProLiant Server Management', 
                        description: "Managing and troubleshooting HPE ProLiant servers with iLO and other tools.", 
                        initialPrompt: `Generate 10 common administrative tasks for HPE ProLiant Server Management. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for HPE ProLiant Server Management. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'javascriptForHtml', 
                        title: 'JavaScript for HTML', 
                        description: "Core JavaScript concepts for manipulating HTML DOM and creating interactive web pages.", 
                        initialPrompt: `Generate 10 fundamental JavaScript concepts for HTML manipulation. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 essential JavaScript concepts and techniques for HTML web development. For each, give a unique "id", "title", and a detailed "description" of the concept. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'm365Admin', 
                        title: 'Microsoft 365 Administration', 
                        description: "Administering users, services, and security in Microsoft 365.", 
                        initialPrompt: `Generate 10 common administrative tasks for Microsoft 365. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for Microsoft 365. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'msGraphScripting', 
                        title: 'MS Graph scripting', 
                        description: "Automating M365 tasks using the Microsoft Graph API.", 
                        initialPrompt: `Generate 10 common tasks to automate with MS Graph scripting. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced tasks to automate with Microsoft Graph scripting. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'powershellM365', 
                        title: 'PowerShell for M365 Administration', 
                        description: "Using PowerShell to manage Microsoft 365 services like Exchange Online and SharePoint.", 
                        initialPrompt: `Generate 10 common PowerShell tasks for M365 Administration. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced PowerShell tasks for M365 Administration. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'powershellWindowsServer', 
                        title: 'PowerShell for Windows Server Administration', 
                        description: "Automating Windows Server management with PowerShell scripts and cmdlets.", 
                        initialPrompt: `Generate 10 common PowerShell tasks for Windows Server Administration. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced PowerShell tasks for Windows Server Administration. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'powershellScripts', 
                        title: 'PowerShell Scripts', 
                        description: "A collection of useful PowerShell scripts for various administrative tasks.", 
                        initialPrompt: `Generate 10 useful PowerShell script ideas for administrators. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 useful and practical PowerShell script ideas for administrators. For each, give a unique "id", "title", and a detailed "description" of the script's purpose. Return ONLY a valid JSON array.` 
                    },
                    {
                        key: 'serviceNowAdmin',
                        title: 'ServiceNow Platform Administration',
                        description: 'Guides for administering the ServiceNow cloud platform for IT service management (ITSM) and digital workflows.',
                        initialPrompt: `Generate 10 common administrative tasks for the ServiceNow platform (servicenow.com). Focus on ITSM, user management, and workflow administration. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`,
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for the ServiceNow platform (servicenow.com). Cover topics like ITSM, CMDB, user roles, UI policies, business rules, and integrations. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.`
                    },
                    { 
                        key: 'usefulApis', 
                        title: 'Useful APIs for Web Development', 
                        description: "A curated list of public APIs that are useful for web development projects.", 
                        initialPrompt: `Generate a list of 10 useful public APIs for web developers. For each, give a unique "id", "title" (API name), and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate a list of 40-50 useful public APIs for web developers across different categories. For each, give a unique "id", "title" (API name), and a detailed "description" of what it offers. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'vmwareEsxi', 
                        title: 'VMware ESXi Administration', 
                        description: "Guides and best practices for managing VMware ESXi environments.", 
                        initialPrompt: `Generate 10 common administrative tasks for VMware ESXi. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for VMware ESXi. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'vmwarePowerCli', 
                        title: 'VMware PowerCLI', 
                        description: "Automating VMware vSphere administration using PowerCLI.", 
                        initialPrompt: `Generate 10 common VMware PowerCLI commands for administrators. For each, give a unique "id", "title" (the command/task), and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced tasks using VMware PowerCLI. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'windowsServer2019', 
                        title: 'Windows Server 2019 Administration', 
                        description: "Key tasks and features for administering Windows Server 2019.", 
                        initialPrompt: `Generate 10 key administrative tasks for Windows Server 2019. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 administrative tasks specific to Windows Server 2019. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'windowsServer2022', 
                        title: 'Windows Server 2022 Administration', 
                        description: "Key tasks and new features for administering Windows Server 2022.", 
                        initialPrompt: `Generate 10 key administrative tasks for Windows Server 2022. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 administrative tasks specific to Windows Server 2022, including new features. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    },
                    { 
                        key: 'windowsServer', 
                        title: 'Windows Server Administration', 
                        description: "Essential tasks for managing Windows Server instances.", 
                        initialPrompt: `Generate 10 common administrative tasks for Windows Server. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`, 
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for Windows Server. For each, give a unique "id", "title", and a detailed "description" of the task. Return ONLY a valid JSON array.` 
                    }
                ];

                const jsonInstruction = ' IMPORTANT: Ensure that any double quotes inside JSON string values are properly escaped (e.g., \\"example\\"). Return ONLY a valid JSON array.';
                const jsonObjectInstruction = ' IMPORTANT: Ensure that any double quotes inside JSON string values are properly escaped (e.g., \\"example\\"). Return ONLY a valid JSON object.';

                categoriesToGenerate.forEach(cat => {
                    if (cat.initialPrompt) cat.initialPrompt = cat.initialPrompt.replace('Return ONLY a valid JSON array.', jsonInstruction);
                    if (cat.fullPrompt) cat.fullPrompt = cat.fullPrompt.replace('Return ONLY a valid JSON array.', jsonInstruction);
                });
                
                categoriesToGenerate.sort((a, b) => a.title.localeCompare(b.title));

                await Promise.allSettled([loadAITailoringOptions(), loadDynamicPlaceholders()]);
                
                const generationPromises = categoriesToGenerate.map(cat => {
                    if (loadingMessageEl) loadingMessageEl.textContent = `Generating guides for: ${cat.title}...`;
                    return generateAndPopulateAICategory(cat).catch(e => {
                        console.error(`Failed to load category: ${cat.title}`, e);
                        return { key: cat.key, error: e };
                    });
                });

                const results = await Promise.all(generationPromises);
                const firstFailure = results.find(r => r && r.error);
                if(firstFailure){
                    throw new Error(`One or more AI content categories failed to load, starting with ${firstFailure.key}. The process has been stopped.`);
                }
                
                if (loadingMessageEl) loadingMessageEl.textContent = `Building navigation...`;
                await generateJumpToButtons();

            } catch (error) {
                console.error("An error occurred while loading app content:", error.message);
                throw error;
            }
        }
        
        async function generateAndPopulateAICategory({key, title, description, initialPrompt, fullPrompt}) {
            const mainGrid = document.getElementById('main-grid');
            const card = document.createElement('div');
            card.className = 'card md:col-span-2';
            card.id = `${key}-card`;
            const selectorId = `${key}-selector-visual`;
            card.innerHTML = `<div class="p-8 card-content"><h2 class="text-2xl font-bold mb-2 themed-text-primary">${title}</h2><p class="mb-6 themed-text-muted">${description}</p><div id="${selectorId}" data-theme-type="${key}" class="w-full">${getLoaderHTML(`AI is generating guides for ${title}...`)}</div><div id="${key}-details" class="details-container mt-4"></div></div>`;
            mainGrid.appendChild(card);
            
            fullPrompts[key] = fullPrompt;

            try {
                const jsonText = await callGeminiAPI(initialPrompt, true);
                if (!jsonText) throw new Error(`API returned empty content for ${title}.`);
                
                const data = parseJsonWithCorrections(jsonText);
                data.sort((a, b) => a.title.localeCompare(b.title));
                allThemeData[key] = data;
                populateCardGridSelector(selectorId, key);
            } catch (error) {
                handleApiError(error, document.getElementById(selectorId), title, card);
                throw error;
            }
        }
        
        function populateCardGridSelector(containerId, themeType, newItemsIds = new Set()) {
            const container = document.getElementById(containerId);
            const data = allThemeData[themeType];
            if (!container || !data || !Array.isArray(data)) {
                if (container) container.innerHTML = `<p class="themed-text-muted">No items to display.</p>`;
                return;
            }

            const gridClass = 'card-grid-container';
            const cardTitle = container.closest('.card').querySelector('h2').textContent;

            const itemsHtml = data.map(item => {
                const compositeKey = `${cardTitle} - ${item.title}`;
                const cleanTitle = sanitizeTitle(item.title);
                const isViewed = viewedItemIds.has(compositeKey);
                const isNew = newItemsIds.has(item.id);
                
                const viewedIndicatorHtml = isViewed ? `
                    <div class="viewed-indicator" title="Viewed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </div>
                ` : '';

                const newClass = isNew ? 'new-item-highlight' : '';
                const truncatedTitle = truncateText(cleanTitle, 50);

                return `
                <div class="grid-card-selector ${newClass}" data-theme-id="${item.id}" data-theme-type="${themeType}" title="${item.description || cleanTitle}">
                    ${viewedIndicatorHtml}
                    <div class="icon">${getIconForTheme(themeType, item.id)}</div>
                    <div class="mt-2 overflow-hidden">
                        <div class="text-sm font-normal leading-tight block">${truncatedTitle}</div>
                    </div>
                </div>`;
            }).join('');
            
            const fullPrompt = fullPrompts[themeType];
            let actionButtonsHtml = '';

            if (fullPrompt && data.length < 35 && data.length > 0) {
                actionButtonsHtml = `
                    <div class="col-span-full text-center mt-4">
                        <button class="show-all-button btn-secondary" data-container-id="${containerId}" data-theme-type="${themeType}">
                            Show All (${data.length} of ~50 shown)
                        </button>
                    </div>`;
            } 
            else if (fullPrompt && data.length >= 35) {
                actionButtonsHtml = `
                    <div class="col-span-full text-center mt-4">
                        <button class="generate-more-button btn-secondary" data-container-id="${containerId}" data-theme-type="${themeType}" title="Use AI to generate more topics for this category">
                            <span class="flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                Generate 10 More
                            </span>
                        </button>
                    </div>`;
            }

            container.innerHTML = `<div class="${gridClass}">${itemsHtml}</div>${actionButtonsHtml}`;
        }

        async function handleGenerateMoreClick(button) {
            const { containerId, themeType } = button.dataset;
            const container = document.getElementById(containerId);
            if (!container || !themeType || !allThemeData[themeType]) return;

            button.disabled = true;
            button.innerHTML = `<span class="flex items-center justify-center gap-2"><div class="loader themed-loader" style="width:20px; height:20px; border-width: 2px;"></div>Generating...</span>`;

            const card = container.closest('.card');
            const categoryTitle = card.querySelector('h2').textContent;
            const existingTitles = allThemeData[themeType].map(item => item.title);
            
            const prompt = `Generate 10 new and unique administrative task ideas for the IT category "${categoryTitle}". These tasks must be different from the ones in the following list.
            
            Existing Task List:
            - ${existingTitles.join('\n- ')}

            For each new task, provide a unique "id", a "title", and a short "description". IMPORTANT: Ensure that any double quotes inside the description are properly escaped (e.g., \\"example\\"). Return ONLY a valid JSON array of the 10 new items.`;

            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if (!jsonText) throw new Error("AI did not return any new items.");

                const newItems = parseJsonWithCorrections(jsonText);
                const newItemIds = new Set(newItems.map(item => item.id));
                
                newItems.forEach(newItem => {
                    if (!allThemeData[themeType].some(existing => existing.id === newItem.id || existing.title === newItem.title)) {
                        allThemeData[themeType].push(newItem);
                    }
                });
                
                allThemeData[themeType].sort((a, b) => a.title.localeCompare(b.title));
                populateCardGridSelector(containerId, themeType, newItemIds);
                document.getElementById(`${themeType}-details`).innerHTML = '';

            } catch (error) {
                console.error(`Error generating more items for ${themeType}:`, error);
                const originalButtonContent = `<span class="flex items-center justify-center gap-2">...</span>`;
                button.disabled = false;
                button.innerHTML = originalButtonContent.replace('...', 'Error. Try Again.');
                button.classList.add('bg-red-100', 'text-red-700');
                 setTimeout(() => {
                    button.classList.remove('bg-red-100', 'text-red-700');
                    button.innerHTML = originalButtonContent.replace('...', `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Generate 10 More`);
                }, 3000);
            } 
        }
        
        async function handleShowAllClick(button) {
            const { containerId, themeType } = button.dataset;
            const container = document.getElementById(containerId);
            const fullPrompt = fullPrompts[themeType];

            if (!container || !fullPrompt) return;

            button.disabled = true;
            button.innerHTML = `<span class="flex items-center justify-center gap-2"><div class="loader themed-loader" style="width:20px; height:20px; border-width: 2px;"></div>Loading all...</span>`;

            try {
                const jsonText = await callGeminiAPI(fullPrompt, true);
                if (!jsonText) throw new Error(`API returned empty content for ${themeType} (full list).`);
                const fullData = parseJsonWithCorrections(jsonText);
                fullData.sort((a, b) => a.title.localeCompare(b.title));
                allThemeData[themeType] = fullData;
                populateCardGridSelector(containerId, themeType);
                document.getElementById(`${themeType}-details`).innerHTML = '';
            } catch (error) {
                button.disabled = false;
                button.classList.add('bg-red-100', 'text-red-700');
                button.textContent = "Error. Try again.";
                console.error(`Error loading full list for ${themeType}:`, error);
            }
        }

        async function handleGridSelect(target) {
            const { themeId, themeType } = target.dataset;
            const item = allThemeData[themeType]?.find(d => String(d.id) == String(themeId));
            if (!item) {
                console.error("Could not find theme item for:", {themeId, themeType});
                return;
            }
            
            const card = target.closest('.card');
            const cardTitle = card.querySelector('h2').textContent;
            const cardDescription = card.querySelector('p').textContent;

            await markItemAsViewed(cardTitle, item.title);

            const prompt = `
                You are creating a summary for an IT administration guide.
                The overall category is: "${cardTitle}"
                The category description is: "${cardDescription}"
                The specific topic is: "${item.title}"

                Based on this context, generate a very brief, condensed summary for the guide on "${item.title}".
                For each section (Objective, Pre-requisites, Key Steps, Verification, Helpful Resources), provide a single descriptive sentence.
                Return the response as a simple markdown string where each section is a bullet point, starting with '*'.
            `;
            
            const resultContainer = document.getElementById(`${themeType}-details`);
            resultContainer.innerHTML = getLoaderHTML(`Generating summary for ${item.title}...`);

            try {
                let resultText = await callGeminiAPI(prompt);
                resultText = resultText ? resultText.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : '';
                originalGeneratedText.set(themeId, resultText); 
                
                const resultHtml = marked.parse(resultText || '');
                resultContainer.innerHTML = `<div class="prose max-w-none">${resultHtml}</div>`;

                addPostGenerationButtons(resultContainer, themeId, themeType);
            } catch (error) {
                handleApiError(error, resultContainer, `guide for ${item.title}`);
            }
        }
        
        async function markItemAsViewed(cardTitle, buttonTitle) {
            if (!viewedItemsCollectionRef) return;

            const compositeKey = `${cardTitle} - ${buttonTitle}`;
            
            try {
                const docRef = doc(viewedItemsCollectionRef, compositeKey);
                await setDoc(docRef, { 
                    viewedAt: Timestamp.fromDate(new Date()) 
                });
            } catch (error) {
                console.error("Error marking item as viewed:", error);
            }
        }

        async function handleGeminiSubmit(e) {
            e.preventDefault();
            const promptInput = document.getElementById('gemini-prompt');
            const userPrompt = promptInput.value.trim();
            if (!userPrompt) return;

            const modal = document.getElementById('inDepthModal');
            const titleEl = document.getElementById('inDepthModalTitle');
            const contentEl = document.getElementById('inDepthModalContent');
            const footerEl = document.getElementById('inDepthModalFooter');
            const buttonContainer = document.getElementById('inDepthModalButtons');

            const fullTitle = `Custom Guide: ${userPrompt}`;
            titleEl.textContent = truncateText(fullTitle, 40);
            contentEl.innerHTML = getLoaderHTML(`Generating your custom guide for "${userPrompt}"...`);
            buttonContainer.innerHTML = '';
            document.getElementById('modal-status-message').textContent = '';
            
            footerEl.dataset.fullTitle = fullTitle;
            footerEl.dataset.cardName = "Custom Task"; 
            
            modal.classList.remove('hidden');
            
            const selectedOptions = Array.from(document.querySelectorAll('#tailoring-buttons-container .btn-toggle.active'))
                                        .map(btn => btn.textContent.trim())
                                        .join(', ');

            const prompt = getEnhancedPrompt(userPrompt, selectedOptions);

            try {
                let resultText = await callGeminiAPI(prompt);
                resultText = resultText ? resultText.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : '';
                
                originalGeneratedText.set(fullTitle, resultText);
                
                contentEl.innerHTML = '';
                renderAccordionFromMarkdown(resultText, contentEl, false);

                if (gapi.client.getToken() !== null) {
                    const saveDriveBtn = document.createElement('button');
                    saveDriveBtn.id = 'save-to-drive-btn';
                    saveDriveBtn.className = 'btn-secondary';
                    saveDriveBtn.textContent = 'Save to Google Drive';
                    buttonContainer.appendChild(saveDriveBtn);
                }
                if (msalAccount) {
                     const saveOneDriveBtn = document.createElement('button');
                     saveOneDriveBtn.id = 'save-to-onedrive-btn';
                     saveOneDriveBtn.className = 'btn-secondary';
                     saveOneDriveBtn.textContent = 'Save to OneDrive';
                     buttonContainer.appendChild(saveOneDriveBtn);
                }

            } catch(error) {
                handleApiError(error, contentEl, 'custom IT guide');
            } finally {
                promptInput.value = '';
            }
        }

        function parseJsonWithCorrections(jsonString) {
            if (!jsonString || typeof jsonString !== 'string') {
                throw new Error("Invalid input: not a string.");
            }
            let cleanedString = jsonString.replace(/```(json|markdown)?\n?/g, '').replace(/```/g, '').trim();
            
            // Attempt to fix common JSON errors from the API
            // 1. Remove trailing commas before closing curly braces or brackets
            cleanedString = cleanedString.replace(/,\s*(}|])/g, '$1');
            // 2. Fix improperly escaped single quotes which are invalid in JSON
            cleanedString = cleanedString.replace(/\\'/g, "'");
            // 3. Fix unescaped backslashes (common in file paths) that are not part of a valid escape sequence.
            // This looks for a backslash that is NOT followed by a double quote, another backslash, or any of the other valid escape characters.
            cleanedString = cleanedString.replace(/\\(?!["\\/bfnrtu])/g, '\\\\');

            try {
                return JSON.parse(cleanedString);
            } catch (error) {
                console.error("Failed to parse JSON even after cleaning:", error);
                console.error("Original string:", jsonString);
                console.error("Cleaned string:", cleanedString);
                throw new Error(`JSON Parse Error: ${error.message}. Check console for the problematic string.`);
            }
        }

        async function callApi(apiUrl, payload) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000);

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    let errorBody;
                    try { errorBody = await response.json(); } catch { errorBody = await response.text(); }
                    console.error("API Error Response:", errorBody);
                    const errorMsg = errorBody?.error?.message || response.statusText;
                    throw new Error(`API request failed with status ${response.status}. Message: ${errorMsg}`);
                }
                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') throw new Error('The AI service request timed out. Please try again.');
                throw error;
            }
        }

        async function callGeminiAPI(prompt, isJson = false) {
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            if (isJson) {
                payload.generationConfig = { responseMimeType: "application/json", maxOutputTokens: 8192 };
            }
            const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`, payload);
            return result?.candidates?.[0]?.content?.parts?.[0]?.text || null;
        }

        async function callImageGenAPI(prompt) {
            const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
            const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${geminiApiKey}`, payload);
            const base64 = result?.predictions?.[0]?.bytesBase64Encoded;
            return base64 ? `data:image/png;base64,${base64}` : null;
        }
        
        async function callColorGenAPI(prompt) {
            const fullPrompt = `Based on the theme "${prompt}", generate a color palette. I need a JSON object with keys: "bg", "text", "primary", "primaryDark", "accent", "cardBg", "cardBorder", "textMuted", "inputBg", "inputBorder", "buttonText". Determine if the "primary" color is light or dark to set the "buttonText" appropriately (#FFFFFF for dark, #111827 for light). Return only the complete, valid JSON object.`;
            const jsonText = await callGeminiAPI(fullPrompt, true);
            if (jsonText) return parseJsonWithCorrections(jsonText);
            throw new Error("Could not parse a valid color theme from API response.");
        }

        function handleApiError(error, container, contentType = 'content') {
            console.error(`Error generating ${contentType}:`, error);
            const errorMessage = generateErrorMessage(error, contentType);
            if (container) {
                container.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">${errorMessage}</div>`;
            }
        }
        
        async function generateAndApplyDefaultTheme() {
            showThemeLoading(true);
            const themePrompt = "Modern Data Center";
            const imagePrompt = `Artistic, abstract background image inspired by "${themePrompt}". Suitable for an IT administration website. Professional, clean. Wide aspect ratio, photographic, cinematic lighting.`;
            try {
                const [colorResult, imageResult] = await Promise.allSettled([callColorGenAPI(themePrompt), callImageGenAPI(imagePrompt)]);
                
                if (colorResult.status === 'fulfilled' && colorResult.value) applyTheme(colorResult.value);
                else throw colorResult.reason || new Error("Failed to generate color theme.");

                if (imageResult.status === 'fulfilled' && imageResult.value) applyHeaderImage(imageResult.value);
                else throw imageResult.reason || new Error("Failed to generate header image.");

            } catch (error) {
                handleApiError(null, null, 'default theme');
                throw error;
            } finally {
                showThemeLoading(false);
            }
        }
        
        async function loadAITailoringOptions() {
            const container = document.getElementById('tailoring-buttons-container');
            container.innerHTML = getLoaderHTML('Loading AI options...');
            try {
                const prompt = `Generate a comprehensive list of 40-50 diverse keywords and concepts for tailoring IT administration guides. The list should cover a wide range of topics including security, performance, automation, specific technologies (like PowerShell, Ansible), methodologies (like IaC), and user levels (like 'for beginners', 'for experts'). Return ONLY a valid JSON array of strings. IMPORTANT: Ensure any double quotes inside the strings are properly escaped.`;
                const jsonText = await callGeminiAPI(prompt, true);
                if (!jsonText) {
                    throw new Error("AI did not return any tailoring options.");
                }
                const options = parseJsonWithCorrections(jsonText);
                populateTailoringButtons(options);
            } catch (error) {
                handleApiError(error, container, 'tailoring options');
                const fallbackOptions = ["Security Hardening", "Performance Tuning", "Automation Script", "For Beginners"];
                populateTailoringButtons(fallbackOptions);
            }
        }


        function populateTailoringButtons(options) {
            const container = document.getElementById('tailoring-buttons-container');
            container.innerHTML = options.map(option =>
                `<button type="button" class="btn-toggle text-sm px-3 py-1 rounded-full">${option}</button>`
            ).join('');
        }
        
        async function loadDynamicPlaceholders() {
            const promptInput = document.getElementById('gemini-prompt');
            const prompt = `Generate a JSON array of 3 creative IT administration task ideas for input placeholders. Examples: "Onboard a new employee", "Decommission a legacy server". Return ONLY the valid JSON array of strings, ensuring any double quotes inside the strings are properly escaped (e.g., \\"like this\\").`;
            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if(!jsonText) return;
                const placeholders = parseJsonWithCorrections(jsonText);
                if (placeholders && placeholders.length > 0) {
                    let i = 0;
                    promptInput.placeholder = `e.g., '${placeholders[i]}'`;
                    setInterval(() => {
                        i = (i + 1) % placeholders.length;
                        promptInput.placeholder = `e.g., '${placeholders[i]}'`;
                    }, 3000);
                }
            } catch(error) {
                console.error("Could not load dynamic placeholders", error);
            }
        }

        function applyTheme(colors) {
            Object.entries(colors).forEach(([key, value]) => {
                const cssVar = `--color-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                root.style.setProperty(cssVar, value);
            });
        }
        
        function applyHeaderImage(imageUrl) {
            const bgImageDiv = document.getElementById('header-bg-image');
            bgImageDiv.style.backgroundImage = `url('${imageUrl}')`;
        }

        function showThemeLoading(isLoading) {
            const loader = document.getElementById('header-loader');
            loader.classList.toggle('hidden', !isLoading);
            loader.classList.toggle('flex', isLoading);
        }
        
        function getAppPrompts() {
            return {
                "Generate Detailed Guide": getEnhancedPrompt("{task}", "", "", { cardTitle: "{cardTitle}", cardDescription: "{cardDescription}" }),
                "Refine Existing Guide": getEnhancedPrompt("{refinement_request}", "", "{original_text}"),
                "Generate In-Depth Guide": getEnhancedPrompt("{item_title}"),
                "Generate Summary": `Generate a very brief, condensed summary for an IT administration guide on the topic: "{item.title}". For each section (Objective, Pre-requisites, Key Steps, Verification, Helpful Resources), provide a single descriptive sentence. Return the response as a simple markdown string where each section is a bullet point, starting with '*'.`,
                "Generate UI Screenshot": `UI Screenshot for an IT Administration guide showing: {description}. Clean, professional, minimal.`,
                "Generate Color Theme": `Based on the theme "{prompt}", generate a color palette. I need a JSON object with keys: "bg", "text", "primary", "primaryDark", "accent", "cardBg", "cardBorder", "textMuted", "inputBg", "inputBorder", "buttonText". Determine if the "primary" color is light or dark to set the "buttonText" appropriately (#FFFFFF for dark, #111827 for light). Return only the complete, valid JSON.`,
                "Discover New Topic": `Generate 1 new, useful IT administration category NOT on this list: {existing_titles}. Provide a "key" (camelCase, unique), "title", "description", an "initialPrompt" (for 10 items), and a "fullPrompt" (for 40-50). Prompts must request a JSON array of objects, each with id, title, and description. Return ONLY a valid JSON object.`,
                "Gemini CLI Guide": `Generate 10 common use cases for the Gemini CLI. For each, give a unique "id", "title", and a short "description". Return ONLY a valid JSON array.`
            };
        }
        
        function displayPromptsInModal() {
            const modal = document.getElementById('promptsModal');
            const contentEl = document.getElementById('promptsModalContent');
            contentEl.innerHTML = ''; 

            const prompts = getAppPrompts();

            for (const [title, promptText] of Object.entries(prompts)) {
                const promptContainer = document.createElement('div');
                promptContainer.className = 'mb-6';
                
                const promptTitle = document.createElement('h3');
                promptTitle.className = 'text-lg font-semibold themed-text-accent mb-2';
                promptTitle.textContent = title;
                promptContainer.appendChild(promptTitle);

                const codeBlockContainer = document.createElement('div');
                codeBlockContainer.className = 'code-block-container !mt-0';
                
                const header = document.createElement('div');
                header.className = 'code-block-header';
                header.innerHTML = `<span>Prompt</span><button class="copy-code-button">Copy</button>`;
                codeBlockContainer.appendChild(header);

                const pre = document.createElement('pre');
                pre.className = 'text-sm';
                pre.style.color = 'var(--code-text)';
                pre.textContent = promptText;
                codeBlockContainer.appendChild(pre);
                
                promptContainer.appendChild(codeBlockContainer);
                contentEl.appendChild(promptContainer);
            }

            modal.classList.remove('hidden');
        }


        function getEnhancedPrompt(task, options = '', originalText = '', context = {}) {
            const optionsText = options ? `With a special focus on these elements: ${options}.` : '';
            
            if (originalText) {
                // Refinement Prompt
                return `You are an expert senior IT administrator AI. A user has provided an IT guide and a request to refine it. Your task is to rewrite the entire guide to incorporate the user's request, structuring the new guide into the most logical sections possible.

**ORIGINAL IT GUIDE:**
---
${originalText}
---

**USER'S REFINEMENT REQUEST:**
"${task}"

**Instructions for rewriting:**
1.  **Structure:** Do not use the old section headers unless they are still the most logical choice. Instead, create new, clear, and descriptive section headers using '###' markdown syntax based on the refined content.
2.  **Integrate:** Seamlessly integrate the user's request into the guide.
3.  **Quality Standards:** The entire rewritten guide must still meet these requirements for the specific technology being discussed:
    * **Authoritative Links:** Embed hyperlinks to official vendor documentation, relevant articles, or other authoritative sources.
    * **Code Blocks:** When providing code examples, wrap them in markdown code fences with the language specified (e.g., \`\`\`powershell\`).
    * **Screenshot Placeholders:** Include placeholders for screenshots where visual context is beneficial. Use the format: [Screenshot: A clear, concise description for an AI image generator to create a UI screenshot].
    * **Practicality:** Ensure all advice, steps, and examples are practical and reflect real-world scenarios.
    * **Helpful Resources:** Ensure there is a final section with a bulleted list of high-quality, relevant links.

Return only the new, complete, and rewritten markdown guide.`;
            }

            // In-depth and Custom Guide Generation Prompt
            let contextText = `for the task: "${task}"`;
            if (context.cardTitle) {
                contextText = `for the following topic.
- **Category:** "${context.cardTitle}"
- **Topic Description:** "${context.cardDescription}"
- **Specific Task:** "${task}"`;
            }

            return `You are an expert senior IT administrator AI. Generate a comprehensive and practical guide ${contextText}. ${optionsText}

Your task is to structure this guide into the most logical and helpful sections. For each section, create a clear and descriptive header using '###' markdown syntax. The content within each section should be detailed and practical.

When generating the guide, ensure the guide as a whole meets the following requirements for the specific technology being discussed:

1.  **Authoritative Links:** Throughout the guide, embed hyperlinks to official vendor documentation, relevant articles, or other authoritative sources.
2.  **Code Blocks:** When providing code examples (like PowerShell), wrap them in markdown code fences with the language specified, like \`\`\`powershell... \`\`\`.
3.  **Prerequisites:** Create a dedicated "Prerequisites" section that details relevant administrative roles, permissions, and any specific licensing requirements.
4.  **Verification:** Include a section on how to verify the task was successful, mentioning practical, real-world details (e.g., specific logs to check).
5.  **Troubleshooting:** Include a section covering common problems that administrators face.
6.  **Helpful Resources:** Include a final section with a bulleted list of high-quality, relevant links to official documentation, tutorials, or tools.
7.  **Screenshot Placeholders:** In the 'Step-by-Step Guide' or equivalent section, include placeholders for screenshots where visual context would be beneficial. Use the format: [Screenshot: A clear, concise description for an AI image generator to create a UI screenshot].

Return only the complete markdown guide.`;
        }
        
        function convertMarkdownToHtml(text, generateImages = true) {
            if (!text) return '<p class="themed-text-muted">No content received from AI. Please try a different prompt.</p>';

            let processedText;
            if (generateImages) {
                processedText = text.replace(/\[Screenshot: (.*?)\]/g, (match, description) => {
                    const placeholderId = `image-placeholder-${Date.now()}-${Math.random()}`;
                    return `<div id="${placeholderId}" class="image-generation-container" data-prompt="${description.replace(/"/g, '&quot;')}">
                                <div class="loader themed-loader"></div>
                                <p class="mt-2 text-sm italic">${description}</p>
                            </div>`;
                });
            } else {
                processedText = text.replace(/\[Screenshot: (.*?)\]/g, '');
            }


            let html = marked.parse(processedText);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            tempDiv.querySelectorAll('pre').forEach(preBlock => {
                if (preBlock.parentElement.classList.contains('code-block-container')) return;

                const codeBlock = preBlock.querySelector('code');
                const lang = codeBlock ? (Array.from(codeBlock.classList).find(c => c.startsWith('language-'))?.replace('language-', '') || 'text') : 'text';
                
                const container = document.createElement('div');
                container.className = 'code-block-container';
                
                const header = document.createElement('div');
                header.className = 'code-block-header';
                header.innerHTML = `
                    <span>${lang}</span>
                    <button class="copy-code-button">Copy</button>
                `;

                container.appendChild(header);
                preBlock.parentNode.insertBefore(container, preBlock);
                container.appendChild(preBlock);
            });

            return tempDiv.innerHTML;
        }

        async function generateAndInjectImages(container) {
            const placeholders = container.querySelectorAll('.image-generation-container');
            if (placeholders.length === 0) return;

            placeholders.forEach(async (placeholder) => {
                const prompt = placeholder.dataset.prompt;
                const imagePrompt = `UI Screenshot for an IT Administration guide showing: ${prompt}. Clean, professional, minimal.`;
                try {
                    const imageUrl = await callImageGenAPI(imagePrompt);
                    if (imageUrl) {
                        placeholder.innerHTML = `<img src="${imageUrl}" alt="${prompt}">`;
                    } else {
                        throw new Error('API returned no image.');
                    }
                } catch (error) {
                    console.error(`Failed to generate image for prompt: "${prompt}"`, error);
                    placeholder.innerHTML = `<p class="text-red-500 text-sm">Image generation failed.</p><p class="text-xs">${prompt}</p>`;
                }
            });
        }


        function addPostGenerationButtons(container, themeId, themeType) {
            let buttonBar = container.querySelector('.button-bar');
            if (buttonBar) buttonBar.remove();

            buttonBar = document.createElement('div');
            buttonBar.className = 'button-bar flex flex-wrap gap-2 mt-4 pt-4 border-t';
            buttonBar.style.borderColor = 'var(--color-card-border)';
            buttonBar.innerHTML = `
                <button class="btn-secondary text-sm refine-button">Refine with AI</button>
                <button class="btn-secondary text-sm copy-button">Copy Text</button>
                <button class="btn-secondary text-sm explore-button" data-theme-id="${themeId}" data-theme-type="${themeType}">Explore In-Depth</button>
            `;
            container.appendChild(buttonBar);
            buttonBar.querySelector('.copy-button').addEventListener('click', e => {
                const contentToCopy = e.target.closest('.details-container, #gemini-result-container');
                if(contentToCopy) copyElementTextToClipboard(contentToCopy, e.target);
            });
        }

        async function handleDiscoverMoreClick() {
            const button = document.getElementById('discover-more-button');
            const errorP = document.getElementById('discover-more-error');
            errorP.textContent = '';
            button.disabled = true;

            const existingTitles = Array.from(document.querySelectorAll('#main-grid h2')).map(h2 => h2.textContent);
            const prompt = `Generate 1 new, useful IT administration category NOT on this list: ${existingTitles.join(', ')}. Provide a "key" (camelCase, unique), "title", "description", an "initialPrompt" (for 10 items), and a "fullPrompt" (for 40-50). Prompts must request a JSON array of objects, each with id, title, and description. IMPORTANT: Ensure any double quotes in string values are properly escaped (e.g., \\"like this\\"). Return ONLY a valid JSON object.`;

            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if (!jsonText) throw new Error("AI did not return a new category.");
                const newCategory = parseJsonWithCorrections(jsonText);
                await generateAndPopulateAICategory(newCategory);
                await generateJumpToButtons();
            } catch (error) {
                console.error("Failed to discover more topics:", error);
                errorP.textContent = "Sorry, couldn't generate a new topic right now.";
            } finally {
                button.disabled = false;
            }
        }
        
        async function handleCustomVisualThemeGeneration() {
            const prompt = document.getElementById('theme-prompt').value;
            if(!prompt) return;

            const loader = document.getElementById('theme-loader-container');
            const errorContainer = document.getElementById('theme-error-container');
            const generateBtn = document.getElementById('generate-theme-btn');
            
            loader.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            generateBtn.disabled = true;

            try {
                const imagePrompt = `Artistic, abstract background image inspired by "${prompt}". Suitable for an IT website. Professional, clean. Wide aspect ratio, photographic, cinematic lighting.`;
                const [colorResult, imageResult] = await Promise.allSettled([callColorGenAPI(prompt), callImageGenAPI(imagePrompt)]);
                
                if (colorResult.status === 'fulfilled' && colorResult.value) applyTheme(colorResult.value);
                else throw colorResult.reason || new Error("Failed to generate color theme.");

                if (imageResult.status === 'fulfilled' && imageResult.value) applyHeaderImage(imageResult.value);
                else throw imageResult.reason || new Error("Failed to generate header image.");
                
                document.getElementById('themeGeneratorModal').classList.add('hidden');
            } catch (error) {
                showThemeError(error.message);
            } finally {
                loader.classList.add('hidden');
                generateBtn.disabled = false;
            }
        }
        
        function showThemeError(message) {
            const errorContainer = document.getElementById('theme-error-container');
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        async function generateJumpToButtons() {
            const container = document.getElementById('jump-to-nav-container');
            const cards = Array.from(document.querySelectorAll('#custom-plan-card, #main-grid .card'));
            if (cards.length <= 1) return;

            const cardData = cards.map(card => ({
                id: card.id,
                title: card.querySelector('h2')?.textContent
            })).filter(c => c.id && c.title);
            
            if (cardData.length === 0) return;
        
            const prompt = `For the following IT category titles, generate a very short, engaging label (1-2 words). Return a valid JSON object where keys are the original titles and values are the short labels. Titles: ${JSON.stringify(cardData.map(c => c.title))}. IMPORTANT: Ensure any double quotes in string values are properly escaped.`;
            
            try {
                const jsonText = await callGeminiAPI(prompt, true);
                if (!jsonText) throw new Error("AI returned empty data for jump-to buttons.");
                
                const labels = parseJsonWithCorrections(jsonText);
                const buttonsHtml = cardData.map(card => {
                    const label = labels[card.title] || card.title.split(' ')[0];
                    return `<button class="jump-to-button" data-target-id="${card.id}">${label}</button>`;
                }).join('');

                container.innerHTML = `<div class="flex flex-wrap gap-2 justify-center">${buttonsHtml}</div>`;
                container.classList.remove('hidden');
            } catch (error) {
                console.error("Failed to generate jump-to buttons:", error);
                container.innerHTML = '';
                container.classList.add('hidden'); 
            }
        }

        function populateTypographySettings() {
            const fontSelect = document.getElementById('font-family-select');
            const sizeSelect = document.getElementById('font-size-select');
            const lineHeightSelect = document.getElementById('line-height-select');
            
            const fonts = { 'Default (Inter)': "'Inter', sans-serif", 'Lato': "'Lato', sans-serif", 'Montserrat': "'Montserrat', sans-serif", 'Nunito Sans': "'Nunito Sans', sans-serif", 'Open Sans': "'Open Sans', sans-serif", 'Poppins': "'Poppins', sans-serif", 'Roboto Slab': "'Roboto Slab', serif" };
            const sizes = { '14': '14px', '15': '15px', '16 (Default)': '16px', '17': '17px', '18': '18px' };
            const lineHeights = { '1.4': '1.4', '1.5 (Default)': '1.5', '1.6': '1.6', '1.7': '1.7', '1.8': '1.8' };

            Object.entries(fonts).forEach(([name, value]) => fontSelect.add(new Option(name, value)));
            Object.entries(sizes).forEach(([name, value]) => sizeSelect.add(new Option(name, value)));
            Object.entries(lineHeights).forEach(([name, value]) => lineHeightSelect.add(new Option(name, value)));

            fontSelect.value = fonts['Default (Inter)'];
            sizeSelect.value = '16px';
            lineHeightSelect.value = '1.5';
            
            root.style.setProperty('--font-family', fontSelect.value);
            root.style.setProperty('--font-size-base', sizeSelect.value);
            root.style.setProperty('--line-height-base', lineHeightSelect.value);
        }

        function copyElementTextToClipboard(element, button) {
            const textToCopy = element.innerText;
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed'; 
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => { button.textContent = originalText; }, 2000);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textarea);
        }

        function renderAccordionFromMarkdown(markdownText, containerElement, generateImages = true) {
            containerElement.innerHTML = ''; 
            if (!markdownText || !markdownText.trim()) {
                containerElement.innerHTML = convertMarkdownToHtml(null, false);
                return;
            }

            const fullHtml = convertMarkdownToHtml(markdownText, generateImages);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = fullHtml;

            const nodes = Array.from(tempDiv.childNodes);
            let currentAccordionItem = null;
            let introContent = document.createElement('div');
            introContent.className = 'accordion-intro mb-4 prose max-w-none';

            let firstHeaderFound = false;

            nodes.forEach(node => {
                if (!firstHeaderFound && node.tagName !== 'H3') {
                    introContent.appendChild(node.cloneNode(true));
                    return;
                }
                
                if (node.tagName === 'H3') {
                    firstHeaderFound = true;
                    if (introContent.hasChildNodes()) {
                        containerElement.appendChild(introContent);
                        introContent = document.createElement('div'); 
                        introContent.className = 'accordion-intro mb-4 prose max-w-none';
                    }

                    currentAccordionItem = document.createElement('div');
                    currentAccordionItem.className = 'accordion-item';

                    const title = node.textContent;
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'accordion-content prose max-w-none';

                    currentAccordionItem.innerHTML = `
                        <button type="button" class="accordion-header">
                            <span class="text-left">${title}</span>
                            <svg class="icon w-5 h-5 transition-transform shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    `;
                    currentAccordionItem.appendChild(contentDiv);
                    containerElement.appendChild(currentAccordionItem);
                } else if (currentAccordionItem) {
                    const contentDiv = currentAccordionItem.querySelector('.accordion-content');
                    contentDiv.appendChild(node.cloneNode(true));
                }
            });
            
            if (!firstHeaderFound) {
                 const contentDiv = document.createElement('div');
                 contentDiv.className = 'prose max-w-none';
                 contentDiv.innerHTML = fullHtml;
                 containerElement.appendChild(contentDiv);
                 return;
            }

            if (introContent.hasChildNodes()) {
                containerElement.appendChild(introContent);
            }

            const firstItem = containerElement.querySelector('.accordion-item');
            if (firstItem) {
                const header = firstItem.querySelector('.accordion-header');
                header.classList.add('active');
                header.querySelector('.icon').style.transform = 'rotate(180deg)';
                firstItem.querySelector('.accordion-content').classList.add('open');
            }
        }
        
        async function handleAIHelpRequest() {
            const modal = document.getElementById('inDepthModal');
            const titleEl = document.getElementById('inDepthModalTitle');
            const contentEl = document.getElementById('inDepthModalContent');
            
            titleEl.textContent = "AI Help & Feedback";
            contentEl.innerHTML = getLoaderHTML('Generating help guide and AI feedback...');
            document.getElementById('inDepthModalButtons').innerHTML = '';
            document.getElementById('modal-status-message').innerHTML = '';
            modal.classList.remove('hidden');

            const helpPrompt = `
                Generate a user-friendly help guide for this "IT Administration Hub" application. Explain the key features in separate sections.
                The features are: 
                1.  **Cloud Storage Integration**: A dedicated card on the main screen allows you to connect to Google Drive and/or Microsoft OneDrive. Once connected, you can save guides. Google Drive also supports importing guides.
                2.  **Saving Guides**: Inside the guide modal, buttons will appear to save the guide to your connected cloud services. The file is saved to an "IT Administration Hub" folder with a descriptive name.
                3.  **Custom Task Generator**: User enters any IT task, and the AI creates a detailed, step-by-step guide inside a pop-up modal.
                4.  **Tailoring Options**: Buttons to refine the custom guide (e.g., 'for Security', 'for Beginners').
                5.  **Pre-Built Categories**: AI-generated topics like VMware, Windows Server, etc., for quick access to common subjects.
                6.  **Visual Theme Generator**: A floating button allows you to describe a mood (e.g., 'ocean sunset'), and the AI creates a new color theme and header image for the application.
                7.  **In-Depth Exploration & Refinement**: You can expand a summary to see a full guide or ask the AI to rewrite and refine any generated content with further instructions.
                8.  **Important Note on Images**: Image generation for screenshot placeholders has been disabled in the pop-up modal views to improve readability and focus on the text content. Images are still generated on the main page.
                Format the output as a clean markdown document using '###' for each section title.`;

            const feedbackPrompt = `
                You are an AI expert in user experience (UX) and IT administration tools. You are reviewing this "IT Administration Hub" application. 
                Based on the feature descriptions below, provide constructive feedback. What is intuitive? What could be improved? What features might be missing for a senior IT administrator?

                **Application Features:**
                1.  **Cloud Storage Integration**: Connect to Google Drive/OneDrive to save/load guides.
                2.  **Custom Task Generator**: Enter any IT task for a step-by-step AI-generated guide.
                3.  **Tailoring Options**: Buttons to refine guides (e.g., 'for Security', 'for Beginners').
                4.  **Pre-Built Categories**: AI-generated topics like VMware, Windows Server, etc.
                5.  **Visual Theme Generator**: Floating button to generate a new color theme and header image from a text prompt.
                6.  **In-Depth Exploration & Refinement**: Expand summaries to full guides or ask AI to rewrite content.

                Format your feedback as a clean markdown document. Use '###' for section titles like "Strengths", "Areas for Improvement", and "Suggested Features".`;
            
            try {
                const [helpResult, feedbackResult] = await Promise.all([
                    callGeminiAPI(helpPrompt),
                    callGeminiAPI(feedbackPrompt)
                ]);

                const helpText = helpResult ? helpResult.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : '';
                const feedbackText = feedbackResult ? feedbackResult.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : '';
                
                contentEl.innerHTML = `
                    <div class="accordion-item">
                        <button type="button" class="accordion-header active">
                            <span class="text-left font-semibold">Application Help Guide</span>
                            <svg class="icon w-5 h-5 transition-transform shrink-0" style="transform: rotate(180deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content open prose max-w-none">
                            ${marked.parse(helpText || '<p class="themed-text-muted">Could not load help content.</p>')}
                        </div>
                    </div>
                    <div class="accordion-item">
                        <button type="button" class="accordion-header">
                            <span class="text-left font-semibold">AI-Generated Feedback</span>
                            <svg class="icon w-5 h-5 transition-transform shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content prose max-w-none">
                            ${marked.parse(feedbackText || '<p class="themed-text-muted">Could not load feedback.</p>')}
                        </div>
                    </div>
                `;

                contentEl.querySelectorAll('pre:not(code-block-container pre)').forEach(preBlock => {
                    const codeBlock = preBlock.querySelector('code');
                    const lang = codeBlock ? (Array.from(codeBlock.classList).find(c => c.startsWith('language-'))?.replace('language-', '') || 'text') : 'text';
                    
                    const container = document.createElement('div');
                    container.className = 'code-block-container';
                    
                    const header = document.createElement('div');
                    header.className = 'code-block-header';
                    header.innerHTML = `<span>${lang}</span><button class="copy-code-button">Copy</button>`;

                    container.appendChild(header);
                    preBlock.parentNode.insertBefore(container, preBlock);
                    container.appendChild(preBlock);
                });

            } catch (error) {
                handleApiError(error, contentEl, 'AI help content');
            }
        }
        
        async function handleExploreInDepth(themeId, themeType, cardName) {
            const item = allThemeData[themeType]?.find(d => String(d.id) === String(themeId));
            if (!item) {
                console.error("Could not find item for in-depth view", {themeId, themeType});
                return;
            }

            const modal = document.getElementById('inDepthModal');
            const titleEl = document.getElementById('inDepthModalTitle');
            const contentEl = document.getElementById('inDepthModalContent');
            const footerEl = document.getElementById('inDepthModalFooter');
            
            const fullTitle = `In-Depth: ${item.title}`;
            titleEl.textContent = fullTitle;
            contentEl.innerHTML = getLoaderHTML(`Generating detailed guide for ${item.title}...`);
            document.getElementById('modal-status-message').textContent = '';
            
            const buttonContainer = document.getElementById('inDepthModalButtons');
            buttonContainer.innerHTML = '';

            footerEl.dataset.themeId = themeId;
            footerEl.dataset.themeType = themeType;
            footerEl.dataset.fullTitle = fullTitle;
            footerEl.dataset.cardName = cardName;

            modal.classList.remove('hidden');
            
            const context = { cardTitle: cardName, cardDescription: item.description };
            const prompt = getEnhancedPrompt(item.title, '', '', context);

            try {
                let resultText = await callGeminiAPI(prompt);
                resultText = resultText ? resultText.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : '';
                
                originalGeneratedText.set(fullTitle, resultText); // Save original text for refinement
                
                const summaryHeader = `### ${item.title} - A Comprehensive Guide`;
                const summaryParagraph = `This guide provides a detailed walkthrough for "${item.title}". It covers prerequisites, step-by-step instructions, verification methods, troubleshooting common issues, and helpful resources to assist you in successfully completing this task within the broader context of "${cardName}".`;
                const finalMarkdownForDisplay = `${summaryHeader}\n\n${summaryParagraph}\n\n${resultText}`;

                contentEl.innerHTML = '';
                renderAccordionFromMarkdown(finalMarkdownForDisplay, contentEl, false);
                
                if (gapi.client.getToken() !== null) {
                    const saveDriveBtn = document.createElement('button');
                    saveDriveBtn.id = 'save-to-drive-btn';
                    saveDriveBtn.className = 'btn-secondary';
                    saveDriveBtn.textContent = 'Save to Google Drive';
                    buttonContainer.appendChild(saveDriveBtn);
                }
                if (msalAccount) {
                     const saveOneDriveBtn = document.createElement('button');
                     saveOneDriveBtn.id = 'save-to-onedrive-btn';
                     saveOneDriveBtn.className = 'btn-secondary';
                     saveOneDriveBtn.textContent = 'Save to OneDrive';
                     buttonContainer.appendChild(saveOneDriveBtn);
                }


            } catch (error) {
                handleApiError(error, contentEl, 'in-depth content');
            }
        }
        
        function toggleRefineUI(buttonContainer, isModal = false) {
            let refineContainer = buttonContainer.nextElementSibling;
            if (refineContainer && refineContainer.classList.contains('refine-container')) {
                refineContainer.remove();
                return;
            }

            refineContainer = document.createElement('div');
            refineContainer.className = 'refine-container w-full';
            refineContainer.innerHTML = `
                <textarea class="w-full p-2 themed-input border rounded-lg" rows="2" placeholder="e.g., 'Make it for a junior admin' or 'Add PowerShell examples'"></textarea>
                <button class="btn-primary text-sm mt-2 submit-refinement-button" data-is-modal="${isModal}">Submit Refinement</button>
            `;
            buttonContainer.insertAdjacentElement('afterend', refineContainer);
            refineContainer.querySelector('textarea').focus();
        }

        async function handleRefineRequest(refineContainer) {
            const refinementRequest = refineContainer.querySelector('textarea').value;
            if (!refinementRequest) return;

            const isModal = refineContainer.querySelector('.submit-refinement-button').dataset.isModal === 'true';
            
            const contentArea = isModal ? document.getElementById('inDepthModalContent') : refineContainer.closest('.details-container, #gemini-result-container');
            
            let themeId, themeType, textKey;
            if (isModal) {
                const footerEl = document.getElementById('inDepthModalFooter');
                themeId = footerEl.dataset.themeId;
                themeType = footerEl.dataset.themeType;
                textKey = footerEl.dataset.fullTitle;
            } else {
                const exploreButton = contentArea.querySelector('.explore-button');
                themeId = exploreButton?.dataset.themeId || 'custom-plan';
                themeType = exploreButton?.dataset.themeType || 'custom';
                textKey = themeId;
            }
            
            const originalText = originalGeneratedText.get(textKey);

            if (!originalText) {
                handleApiError({message: "Could not find the original text to refine. Please generate the content again first."}, contentArea, "refinement");
                return;
            }
            
            contentArea.innerHTML = getLoaderHTML(`Refining guide based on your request...`);
            
            const prompt = getEnhancedPrompt(refinementRequest, '', originalText);
            
            try {
                let newText = await callGeminiAPI(prompt);
                newText = newText ? newText.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : '';
                
                originalGeneratedText.set(textKey, newText);
                
                if (isModal) {
                    renderAccordionFromMarkdown(newText, contentArea, false);
                } else {
                    renderAccordionFromMarkdown(newText, contentArea);
                    addPostGenerationButtons(contentArea, themeId, themeType);
                    generateAndInjectImages(contentArea);
                }

            } catch(error) {
                handleApiError(error, contentArea, 'refinement');
            }
        }
        
        function getIconForTheme(themeType, themeId) { 
            const icons = {
                serviceNowAdmin: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`,
                windowsServer: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>`,
                m365Admin: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path></svg>`,
                default: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`
            }
            return icons[themeType] || icons.default;
        }
        
        function getLoaderHTML(message) { return `<div class="flex justify-center items-center my-4"><div class="loader themed-loader"></div><p class="ml-4 themed-text-muted">${message}</p></div>`; }

        function sanitizeTitle(title) {
            if (typeof title !== 'string') return '';
            // Removes leading/trailing quotes, asterisks, hyphens, and whitespace.
            return title.replace(/^["*-\s]+|["*-\s]+$/g, '').trim();
        }
        
        function truncateText(text, maxLength = 50) {
            if (typeof text !== 'string' || text.length <= maxLength) {
                return text;
            }
            return text.substring(0, maxLength) + '...';
        }

        function generateErrorMessage(error, type = 'general') { console.error(`Error during ${type} generation:`, error); let message = `An unknown error occurred. ${error.message}`; const errText = error.message.toLowerCase(); if (errText.includes('safety') || errText.includes('blocked')) message = `Request blocked for safety reasons. Please try a different prompt.`; else if (errText.includes('api key not valid')) message = `Authentication failed. Your API Key is not valid.`; else if (errText.includes('429')) message = `Request limit exceeded. Please try again later.`; else if (errText.includes('timed out')) message = `The request timed out. Please check your connection and try again.`; return `Sorry, a critical error occurred: ${message}`; }

    </script>
</body>
</html>
