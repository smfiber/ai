<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Administration Hub</title>
    <!-- Google Platform Libraries -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Other Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Nunito+Sans:wght@400;700&family=Open+Sans:wght@400;700&family=Poppins:wght@400;500;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* * ==============================================
         * CSS Custom Properties for Theming & Typography
         * ==============================================
        */
        :root {
            --color-bg: #f3e8ff;
            --color-text: #374151;
            --color-text-muted: #6b7280;
            --color-primary: #9333ea;
            --color-primary-dark: #7e22ce;
            --color-accent: #581c87;
            --color-card-bg: rgba(255, 255, 255, 0.9);
            --color-card-border: #e9d5ff;
            --color-input-bg: #f9fafb;
            --color-input-border: #d1d5db;
            --color-button-text: #ffffff;
            --code-bg: #282c34;
            --code-text: #abb2bf;
        }

        /* Applying the theme variables */
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family, 'Inter', sans-serif);
            background-color: var(--color-bg);
            color: var(--color-text);
            font-size: var(--font-size-base, '16px');
            line-height: var(--line-height-base, 1.5);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        
        /* General Prose styling for AI-generated content */
        .prose { font-size: inherit; line-height: 1.6; }
        .prose p { margin-bottom: 1rem; }
        .prose ul, .prose ol { 
            margin-bottom: 1rem;
            padding-left: 1.75rem;
        }
        .prose ul { list-style-type: disc; }
        .prose ol { list-style-type: decimal; }
        .prose li { margin-bottom: 0.5rem; padding-left: 0.25rem; }
        .prose li > p { margin-bottom: 0.25rem; }
        .prose li > ul, .prose li > ol { margin-top: 0.5rem; }
        .prose strong { font-weight: 600; color: var(--color-text); }
        .prose a { color: var(--color-primary); text-decoration: none; border-bottom: 1px solid var(--color-primary); }
        .prose a:hover { color: var(--color-primary-dark); border-bottom-color: var(--color-primary-dark); }
        .prose h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-accent);
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        
        .screenshot-placeholder, .image-generation-container {
            border: 2px dashed var(--color-card-border);
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
            background-color: var(--color-input-bg);
            text-align: center;
            color: var(--color-text-muted);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .screenshot-placeholder::before {
            content: 'üñºÔ∏è';
            display: block;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .image-generation-container img {
            max-width: 100%;
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* Code Block Styling */
        .code-block-container {
            background-color: var(--code-bg);
            border-radius: 8px;
            margin: 1.5rem 0;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            color: #d1d5db;
            font-size: 0.875rem;
            font-family: 'Inter', sans-serif;
        }
        .copy-code-button {
            background-color: rgba(255,255,255,0.1);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }
        .copy-code-button:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .code-block-container pre {
            background-color: transparent !important;
            margin: 0;
            padding: 1rem;
            color: var(--code-text);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .prose code, .code-block-container code {
            font-family: 'Menlo', 'Consolas', monospace;
            font-size: 0.9em;
        }


        .card {
            background-color: var(--color-card-bg);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, background-color 0.5s ease, border-color 0.5s ease, opacity 0.3s ease;
            border: 1px solid var(--color-card-border);
            display: flex; flex-direction: column;
        }
        .card:hover { box-shadow: 0 10px 20px -5px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .card-content { flex-grow: 1; display: flex; flex-direction: column; }

        .btn-primary {
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text);
            font-weight: 600; padding: 12px 24px; border-radius: 8px;
            transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none; cursor: pointer;
        }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 7px 10px rgba(0, 0, 0, 0.15); filter: brightness(1.1); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-secondary {
            background-color: var(--color-input-bg); color: var(--color-text-muted);
            font-weight: 600; padding: 10px 20px; border-radius: 8px;
            border: 1px solid var(--color-input-border); cursor: pointer;
            transition: all 0.2s ease; display: inline-flex;
            align-items: center; justify-content: center; gap: 8px;
        }
        .btn-secondary:hover:not(:disabled) { background-color: #e5e7eb; color: var(--color-accent); }
        .btn-secondary:disabled { opacity: 0.7; cursor: not-allowed;}
        
        .btn-toggle {
            background-color: var(--color-input-bg); color: var(--color-text-muted);
            border: 1px solid var(--color-input-border); transition: all 0.2s ease;
        }
        .btn-toggle.active {
            background-color: var(--color-accent); color: var(--color-button-text);
            border-color: var(--color-primary-dark); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Dropdown Menu Styles */
        .topics-menu-item {
            color: var(--color-text);
            display: block;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            text-decoration: none;
            transition: background-color 0.2s, color 0.2s;
            cursor: pointer;
        }
        .topics-menu-item:hover {
            background-color: var(--color-primary);
            color: var(--color-button-text);
        }

        .floating-action-button {
            position: fixed; background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text); width: 56px; height: 56px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.1);
            cursor: pointer; transition: all 0.3s ease; z-index: 50;
        }
        .floating-action-button:hover { transform: translateY(-3px) scale(1.05); }
        #new-plan-button { bottom: 2rem; right: 2rem; }
        #settings-button { bottom: 6.5rem; right: 2rem; }
        #ai-help-button { bottom: 11rem; right: 2rem; }
        #theme-changer-button { bottom: 15.5rem; right: 2rem; }
        #prompts-button { bottom: 20rem; right: 2rem; }
        #firebase-tools-button { bottom: 24.5rem; right: 2rem; }
        #real-time-log-button { bottom: 29rem; right: 2rem; } /* NEW */
        #scroll-to-top-button { bottom: 2rem; left: 2rem; }
        
        #settings-panel {
            position: fixed; bottom: 11rem; right: 2rem;
            background-color: var(--color-card-bg); border: 1px solid var(--color-card-border);
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 1rem; width: 280px; z-index: 40;
            transition: opacity 0.3s ease, transform 0.3s ease; transform-origin: bottom right;
        }

        .themed-text-primary { color: var(--color-primary); }
        .themed-text-accent { color: var(--color-accent); }
        .themed-text-muted { color: var(--color-text-muted); }
        .themed-input {
            background-color: var(--color-input-bg); border-color: var(--color-input-border);
            color: var(--color-text); transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        .themed-input::placeholder { color: var(--color-text-muted); opacity: 0.7; }
        .themed-input:focus { --tw-ring-color: var(--color-primary); }

        .loader { border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .themed-loader { border: 4px solid var(--color-card-border); border-top: 4px solid var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header-bg-image { 
            background-image: url('https://i.ibb.co/Kjs2bJvq/Image-fx-31.png'); 
            background-size: cover; background-position: center; opacity: 1;
            transition: opacity 1.5s ease-in-out;
        }
        .header-loader-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: white; }

        .accordion-item { border-bottom: 1px solid var(--color-card-border); }
        .accordion-item:last-child { border-bottom: none; }
        .accordion-header {
            width: 100%; text-align: left; padding: 1rem; display: flex; justify-content: space-between; align-items: center; font-weight: 600;
            color: var(--color-text); background-color: transparent; border: none; cursor: pointer; transition: background-color 0.2s;
        }
        .accordion-header:hover { background-color: rgba(0,0,0,0.03); }
        .accordion-content { padding: 1rem; display: none; }
        .accordion-content.open { display: block; }
        .accordion-header .icon { transition: transform 0.3s ease; }
        .accordion-header.active .icon { transform: rotate(180deg); }

        .refine-container { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-card-border); }
        
        .card-grid-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem; margin-top: 1rem; padding: 0.5rem; border-radius: 8px;
            background: rgba(0,0,0,0.02);
        }
        .grid-card-selector {
            position: relative; /* Positioning context for the checkmark */
            background-color: white; border: 1px solid var(--color-card-border);
            border-radius: 8px; padding: 1rem; text-align: center;
            cursor: pointer; transition: all 0.2s ease; font-size: 0.875rem; font-weight: 500;
            display: flex; flex-direction: column; justify-content: space-between; height: 100%;
        }
        .grid-card-selector:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .grid-card-selector.active {
            background-color: var(--color-accent); color: var(--color-button-text); border-color: var(--color-primary-dark);
        }
        .grid-card-selector .icon { margin-bottom: 0.5rem; }
        .grid-card-selector svg { width: 2.5rem; height: 2.5rem; margin: 0 auto; display: block; }
        .grid-card-selector.active small { color: rgba(255, 255, 255, 0.8); }

        /* Indicator Styles */
        .indicator {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .indicator svg { width: 0.75rem; height: 0.75rem; }
        .viewed-indicator { background-color: #ef4444; /* red-500 */ }
        .sticky-indicator { background-color: #3b82f6; /* blue-500 */ } /* NEW */

        .new-item-highlight {
            border: 2px solid var(--color-primary);
            box-shadow: 0 0 10px var(--color-primary);
        }
        
        .add-topic-container {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--color-card-border);
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        
        /* Docked Search Gemini Button */
        #search-gemini-button {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1000;
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-button-text);
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        #search-gemini-button:hover {
            filter: brightness(1.1);
            transform: scale(1.05);
        }
        
        /* Rules for managing modal layers */
        body.modal-open .modal {
            visibility: hidden;
        }
        body.inDepthModal-open #inDepthModal,
        body.inDepthDetailedModal-open #inDepthDetailedModal,
        body.searchGeminiModal-open #searchGeminiModal,
        body.stickyTopicsModal-open #stickyTopicsModal,
        body.promptsModal-open #promptsModal,
        body.themeGeneratorModal-open #themeGeneratorModal,
        body.apiKeyModal-open #apiKeyModal,
        body.aiLogModal-open #aiLogModal,
        body.loadingStateModal-open #loadingStateModal {
             visibility: visible;
        }
        
    </style>
</head>
<body>
    
    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden modal">
        <div class="card p-8 w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4 themed-text-primary">Enter Your API Keys</h2>
            <p class="mb-4 themed-text-muted">Please provide the necessary API keys to use the application's features.</p>
            <form id="apiKeyForm">
                <div class="mb-4">
                    <label for="geminiApiKeyInput" class="block text-sm font-medium themed-text-muted">Gemini API Key (Required)</label>
                    <input type="password" id="geminiApiKeyInput" name="geminiApiKeyInput" class="w-full mt-1 px-4 py-2 themed-input border rounded-lg focus:ring-2" placeholder="Your Gemini API Key" required>
                </div>

                <div class="mb-4">
                    <label for="firebaseConfigInput" class="block text-sm font-medium themed-text-muted">Firebase Config Object (Required)</label>
                    <textarea id="firebaseConfigInput" name="firebaseConfigInput" class="w-full mt-1 px-3 py-2 themed-input border rounded-lg focus:ring-2 font-mono text-xs" rows="6" placeholder="Paste your Firebase config snippet here."></textarea>
                     <p class="text-xs themed-text-muted mt-1">Find this in your Firebase project settings. You can paste the entire snippet.</p>
                </div>

                <h3 class="text-xl font-semibold mb-2 mt-6 themed-text-accent">Cloud Integrations (Optional)</h3>
                <p class="mb-2 themed-text-muted text-sm">To save/load guides from Google Drive, also provide your Client ID. This is also required for AI Image Generation.</p>
                
                <div class="mb-4">
                    <label for="googleClientIdInput" class="block text-sm font-medium themed-text-muted">Google Cloud Client ID</label>
                    <input type="password" id="googleClientIdInput" name="googleClientIdInput" class="w-full mt-1 px-4 py-2 themed-input border rounded-lg focus:ring-2" placeholder="For Google Drive & Image Generation">
                </div>
                
                <button type="submit" class="w-full btn-primary mt-6">Save Keys and Start</button>
                <p id="api-key-error" class="text-red-500 text-sm mt-4 text-center"></p>
            </form>
        </div>
    </div>
    
    <!-- Loading State Modal -->
    <div id="loadingStateModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden modal">
        <div class="card p-8 w-full max-w-md m-4 text-center">
            <h2 class="text-2xl font-bold mb-4 themed-text-primary">Waking up the AI...</h2>
            <div class="flex justify-center my-4"><div class="loader themed-loader"></div></div>
            <p id="loading-message" class="mb-6 themed-text-muted">The AI is generating the initial content and guides. This may take a few moments.</p>
            <button id="closeLoadingStateModal" class="btn-secondary">Close</button>
        </div>
    </div>

    <!-- In-Depth Guide Modal (Level 1) -->
    <div id="inDepthModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 modal">
        <div class="card w-full max-w-3xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 id="inDepthModalTitle" class="text-2xl font-bold themed-text-primary">In-Depth Guide</h2>
                <button id="closeInDepthModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="inDepthModalContent" class="p-6 overflow-y-auto"></div>
            <div id="inDepthModalFooter" class="p-4 border-t" style="border-color: var(--color-card-border);">
                 <div id="inDepthModalButtons" class="flex flex-wrap justify-center gap-2"></div>
                <p id="modal-status-message" class="text-xs text-center themed-text-muted mt-2"></p>
            </div>
        </div>
    </div>

    <!-- Detailed Guide Modal (Level 2) -->
    <div id="inDepthDetailedModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 modal" style="z-index: 60;">
        <div class="card w-full max-w-3xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 id="inDepthDetailedModalTitle" class="text-2xl font-bold themed-text-primary"></h2>
                <button id="closeInDepthDetailedModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="inDepthDetailedModalContent" class="p-6 overflow-y-auto"></div>
            <div id="inDepthDetailedModalFooter" class="p-4 border-t" style="border-color: var(--color-card-border);">
                 <div id="inDepthDetailedModalButtons" class="flex flex-wrap justify-center gap-2"></div>
                <p id="detailed-modal-status-message" class="text-xs text-center themed-text-muted mt-2"></p>
            </div>
        </div>
    </div>
    
    <!-- Search Gemini Modal -->
    <div id="searchGeminiModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-85 flex items-center justify-center p-4 modal" style="z-index: 70;">
        <div class="card w-full max-w-2xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 class="text-2xl font-bold themed-text-primary">Search Gemini</h2>
                <button id="closeSearchGeminiModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="searchGeminiModalContent" class="p-6 overflow-y-auto">
                <div class="mb-4">
                    <label for="searchGeminiQueryText" class="block text-sm font-medium themed-text-muted mb-2">You asked about:</label>
                    <textarea id="searchGeminiQueryText" name="searchGeminiQueryText" readonly class="w-full p-3 themed-input bg-gray-100 border rounded-lg text-sm text-gray-700 max-h-32 overflow-y-auto"></textarea>
                </div>
                <div id="searchGeminiResult" class="prose max-w-none"></div>
            </div>
            <div id="searchGeminiModalFooter" class="p-4 border-t" style="border-color: var(--color-card-border);">
                 <div id="searchGeminiModalButtons" class="flex flex-wrap justify-center gap-2"></div>
                <p id="search-modal-status-message" class="text-xs text-center themed-text-muted mt-2"></p>
            </div>
        </div>
    </div>

    <!-- Theme Generator Modal -->
    <div id="themeGeneratorModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 modal">
        <div class="card w-full max-w-lg m-4 flex flex-col">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 class="text-2xl font-bold themed-text-primary">AI Visual Theme Generator</h2>
                <button id="closeThemeGeneratorModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div class="p-6">
                <p class="mb-6 themed-text-muted">Describe a mood or concept to create a new color palette and header image for the app.</p>
                <textarea id="theme-prompt" name="theme-prompt" rows="3" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'Modern data center at dusk'"></textarea>
                <button id="generate-theme-btn" class="btn-primary w-full mt-4" title="Generate new app visuals based on your text">Generate Visuals</button>
                <div id="theme-loader-container" class="hidden mt-4 flex items-center space-x-3">
                    <div class="loader themed-loader" style="width:25px; height:25px;"></div>
                    <span class="themed-text-muted">AI is generating colors & image...</span>
                </div>
                <div id="theme-error-container" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>
            </div>
        </div>
    </div>

    <!-- Prompts Modal -->
    <div id="promptsModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 modal">
        <div class="card w-full max-w-4xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 class="text-2xl font-bold themed-text-primary">Application AI Prompts</h2>
                <button id="closePromptsModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="promptsModalContent" class="p-6 overflow-y-auto"></div>
        </div>
    </div>
    
    <!-- Sticky Topics Modal -->
    <div id="stickyTopicsModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 modal">
        <div class="card w-full max-w-xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 class="text-2xl font-bold themed-text-primary">Manage Sticky Topics</h2>
                <button id="closeStickyTopicsModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="mb-4">
                    <label for="sticky-topic-category-select" class="block text-sm font-medium themed-text-muted mb-1">Select a Category to Manage</label>
                    <select id="sticky-topic-category-select" name="sticky-topic-category-select" class="w-full p-2 themed-input border rounded-lg"></select>
                </div>
                <div id="sticky-topics-list" class="space-y-2 mb-4">
                    <!-- Sticky topics will be listed here -->
                </div>
                <div class="add-topic-container !border-t-0 !pt-0">
                    <input type="text" id="new-sticky-topic-input" placeholder="Enter a new sticky topic..." class="themed-input w-full p-2 rounded-lg text-sm">
                    <button id="add-sticky-topic-button" class="btn-secondary !px-4 !py-2">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: AI Log Modal -->
    <div id="aiLogModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 modal">
        <div class="card w-full max-w-4xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 class="text-2xl font-bold themed-text-primary">Real-Time AI Log</h2>
                <button id="closeAiLogModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="aiLogModalContent" class="p-6 overflow-y-auto">
                <!-- AI log entries will be injected here -->
            </div>
        </div>
    </div>
    
    <!-- Floating button for Search Gemini -->
    <button id="search-gemini-button" class="hidden">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"/><path d="M12 22A10 10 0 1 0 12 2a10 10 0 0 0 0 20z"/></svg>
      <span>Search Selection</span>
    </button>

    <!-- Main Application Container -->
    <div id="app-container" class="container mx-auto px-4 sm:px-6 lg:px-8 hidden">
        <header class="relative text-center mb-10 rounded-2xl overflow-hidden shadow-lg">
            <div id="header-loader" class="hidden absolute inset-0 bg-black bg-opacity-50 flex-col items-center justify-center z-20 transition-opacity duration-500">
                <div class="loader header-loader-spinner"></div>
                <p class="text-white mt-4 text-lg">Generating new header image...</p>
            </div>
            <div id="header-bg-image" class="absolute inset-0 header-bg-image"></div>
            <div class="absolute inset-0 bg-black opacity-40"></div>
            <div class="relative z-10 py-24 px-12 text-white">
                <h1 class="text-4xl md:text-5xl font-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.6);">IT Administration Hub</h1>
                <p class="text-lg text-purple-200 mt-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.6);">AI-powered guides and task generation for IT professionals.</p>
            </div>
            <div id="auth-status" class="absolute top-4 right-4 z-20"></div>
            <div id="version-display" class="absolute bottom-2 right-4 text-white text-xs opacity-70">v4.6.14</div>
        </header>
        
        <!-- Topics Dropdown Menu -->
        <div class="flex justify-center mb-8">
            <div id="topics-menu-container" class="relative inline-block text-left hidden">
                <div>
                    <button type="button" id="topics-menu-button" class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-indigo-500" aria-haspopup="true" aria-expanded="true">
                        Topics Menu
                        <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div id="topics-menu-items" class="origin-top-right absolute right-0 mt-2 w-72 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-30" role="menu" aria-orientation="vertical" aria-labelledby="topics-menu-button">
                    <div class="py-1" role="none" style="max-height: 400px; overflow-y: auto;">
                        <!-- Menu items will be injected here -->
                    </div>
                </div>
            </div>
        </div>


        <main id="main-content" class="space-y-8">
            <div id="imported-guides-section" class="hidden">
                 <h2 class="text-3xl font-bold text-center mb-4 themed-text-accent">Imported Guides</h2>
                 <div id="imported-guides-container" class="space-y-8"></div>
            </div>
            
            <div id="cloud-storage-card" class="card p-6 hidden">
                 <h2 class="text-xl font-bold themed-text-primary flex items-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.32-10.9A5 5 0 1 1 22 17Z"></path></svg>
                     Cloud Storage
                 </h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                     <div id="google-drive-section" class="hidden">
                          <h3 class="font-semibold themed-text-accent mb-2">Google Drive</h3>
                          <p id="drive-status" class="text-sm themed-text-muted mt-1 mb-3">Connect to load/save guides and enable AI image generation.</p>
                          <div class="flex gap-2">
                             <button id="auth-button" class="btn-secondary">Connect</button>
                             <button id="load-from-drive-btn" class="btn-secondary hidden">Import from Drive</button>
                         </div>
                     </div>
                 </div>
            </div>

            <div id="generative-ai-prompt-card" class="card">
                <div class="p-8 card-content">
                    <h2 class="text-2xl font-bold mb-2 themed-text-primary">Generative AI Prompt</h2>
                    <p class="mb-6 themed-text-muted">Need a guide for a specific task? Enter any keyword or concept, and let AI craft a step-by-step plan for you.</p>
                    <form id="gemini-form">
                        <input type="text" id="gemini-prompt" name="gemini-prompt" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'Configure a new firewall rule'">
                        
                        <div class="my-4 border rounded-lg" style="border-color: var(--color-card-border);">
                            <div class="accordion-item">
                                <button type="button" class="accordion-header" title="Click to see more options">
                                    <span>Tailor Your Guide:</span>
                                    <svg class="icon w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div class="accordion-content">
                                    <div id="tailoring-buttons-container" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary w-full mt-4" title="Generate a custom guide based on your text">Generate AI Guide</button>
                    </form>
                    <div id="gemini-result-container" class="mt-6"></div>
                </div>
            </div>

            <div id="main-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8">
            </div>
            
            <div id="discover-more-container" class="text-center py-8">
                <button id="discover-more-button" class="btn-primary px-8 py-4 text-lg" title="Generate a new random IT category">
                    <span class="flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v2.5"/><path d="M12 22v-2.5"/><path d="M21.5 12.5h-2.5"/><path d="M4.5 12.5h2.5"/><path d="M18.89 6.11l-1.77 1.77"/><path d="M6.88 18.88l-1.77 1.77"/></svg>
                        Discover More IT Topics
                    </span>
                </button>
                <p id="discover-more-error" class="text-red-500 mt-2"></p>
            </div>
        </main>
        
        <!-- Floating Action Buttons -->
        <button id="real-time-log-button" class="floating-action-button" title="Real-Time AI Log">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/><path d="m15 5 3 3"/></svg>
        </button>
        <button id="firebase-tools-button" class="floating-action-button" title="Manage Sticky Topics">
             <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.8 3.2C18.1 2.5 17.1 2 16 2s-2.1.5-2.8 1.2L2 14.4V20h5.6l11.2-11.2zM12.5 6.5l5 5"/></svg>
        </button>
        <button id="prompts-button" class="floating-action-button" title="View AI Prompts">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 16 4-4-4-4"/><path d="m6 8-4 4 4 4"/><path d="m14.5 4-5 16"/></svg>
        </button>
        <button id="theme-changer-button" class="floating-action-button" title="Change Visual Theme">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l.34.34a8 8 0 0111.32 11.32l-.34.34a8 8 0 01-11.32-11.32l.34-.34z"/><path d="M16 12l-4.5 4.5-2.5-2.5"/><path d="M22 12s-4-8-10-8S2 12 2 12s4 8 10 8 10-8 10-8z"/></svg>
        </button>
        <button id="ai-help-button" class="floating-action-button" title="AI Help & Feedback">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"/><path d="M12 22A10 10 0 1 0 12 2a10 10 0 0 0 0 20z"/></svg>
        </button>
        <button id="settings-button" class="floating-action-button" title="Typography Settings">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
        </button>
        <button id="new-plan-button" class="floating-action-button" title="New Session (Reload)">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
        </button>
        <button id="scroll-to-top-button" class="floating-action-button hidden" title="Scroll to top">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
        </button>
        
        <!-- Settings Panel -->
        <div id="settings-panel" class="hidden"><h3 class="text-lg font-bold themed-text-accent mb-4">Display Settings</h3><div class="space-y-4"><div><label for="font-family-select" class="block text-sm font-medium themed-text-muted mb-1">Font Family</label><select id="font-family-select" name="font-family-select" class="w-full p-2 themed-input border rounded-lg"></select></div><div><label for="font-size-select" class="block text-sm font-medium themed-text-muted mb-1">Font Size (px)</label><select id="font-size-select" name="font-size-select" class="w-full p-2 themed-input border rounded-lg"></select></div><div><label for="line-height-select" class="block text-sm font-medium themed-text-muted mb-1">Line Spacing</label><select id="line-height-select" name="line-height-select" class="w-full p-2 themed-input border rounded-lg"></select></div></div></div>

        <footer class="mt-16 py-8 text-center border-t" style="border-color: var(--color-card-border);">
            <div class="max-w-4xl mx-auto px-4">
                <p class="themed-text-muted font-semibold">Disclaimer</p>
                <p class="themed-text-muted text-sm mt-2">
                    This application and its content are for informational and educational purposes only. The administrative guides and suggestions generated by AI are not a substitute for professional IT advice, vendor documentation, or certified training. Always test procedures in a non-production environment before applying them to live systems. Never disregard official documentation or professional advice because of something you have read on this application. The creators of this application are not responsible for any data loss, system downtime, or damages that may result from the use of these guides.
                </p>
            </div>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, Timestamp, doc, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase State ---
        let db;
        let auth;
        let userId;
        let viewedItemsCollectionRef;
        const viewedItemIds = new Set();
        let stickyTopicsUnsubscribe = null;
        let stickyTopics = {}; // Holds sticky topics per category
        let firebaseConfig = null;
        let appIsInitialized = false;

        const jsonInstruction = ` IMPORTANT: Ensure your response is ONLY a valid JSON object. All strings must be enclosed in double quotes. Any double quotes or backslashes within a string value must be properly escaped (e.g., "This is a \\"sample\\" description." or "C:\\\\Users\\\\Admin"). Do not wrap the JSON in markdown code fences.`;
        
        // --- Prompt Engineering Constants ---
        const linkVerificationAndGenerationMandate = `
* **Helpful Resources Link Generation Mandate:** A critical requirement is the accuracy and validity of all external hyperlinks in the "Helpful Resources" section. You MUST follow this procedure:
    1.  **Initial Generation:** First, generate the content for the guide, including the "Helpful Resources" section. In this initial step, you can use placeholder titles for the resources (e.g., "Official Kubernetes Documentation").
    2.  **Identify Search Topics:** From the list of helpful resources you just generated, identify the specific, core topics that need a URL. For example, from "Official Kubernetes Documentation", the topic is "Kubernetes official documentation".
    3.  **Perform Search:** For each topic, perform a web search to find the most authoritative and direct URL. Prioritize official vendor documentation, stable product pages, or primary source articles.
    4.  **Verification & Selection:** From the search results, select the single best URL that leads directly to the relevant, stable content and is highly unlikely to result in a 404 error.
    5.  **Final Output Construction:** In the final output you provide, replace the placeholder titles in the "Helpful Resources" section with a correctly formatted Markdown link, like: \`* [Official Kubernetes Documentation](https://kubernetes.io/docs/home/)\`. Do not include notes like "(This requires a valid link...)". The final output must contain only the verified, working hyperlinks.`;
            
        const powershellStandard = `
* **PowerShell Scripting Standards:** If you provide any PowerShell code or scripts, you MUST adhere to these strict rules to ensure functionality, security, and robustness:
    * **Internal Validation First:** Before outputting, internally validate the script for syntax and logical errors. Ensure it is a complete, runnable script.
    * **Use Correct Cmdlets and Properties:** Always use modern, official cmdlets (e.g., \`Get-CimInstance\` over the obsolete \`Get-WmiObject\`). Critically, you must use the correct, official property names from the objects returned by cmdlets. For example, the event ID from \`Get-WinEvent\` is \`$_.Id\`, not \`$_.EventId\`. The disk size from \`Win32_LogicalDisk\` is \`Size\`, not \`TotalSize\`. Verify these properties.
    * **Filter on the Server ("Filter Right"):** This is non-negotiable for performance. For cmdlets that retrieve data (\`Get-WinEvent\`, \`Get-ADUser\`, \`Get-CimInstance\`, etc.), you MUST use the built-in filtering parameters like \`-FilterHashtable\`, \`-Filter\`, or a relevant query language. DO NOT pipe the entire output of a command to \`Where-Object\` for the initial filtering of the dataset.
    * **Comprehensive Error Handling:** All logic must be wrapped in a \`try { ... } catch { ... }\` block. Any cmdlet that could potentially terminate the script must include \`-ErrorAction Stop\` to ensure the \`catch\` block is triggered. Furthermore, include proactive logical error checks, such as verifying a variable is not zero before using it as a denominator to prevent "division by zero" errors.
    * **Self-Contained Code:** Do not call or pipe to functions or cmdlets that are not built-in to a standard PowerShell installation (e.g., \`Format-Bytes\`). If a helper function is needed for a task like formatting, you must define that function within the script itself.
    * **Clarity and Best Practices:** Use clear variable names, include comments for complex logic, and maintain consistent formatting.`;
        
        const powerCLIStandard = `
* **PowerCLI Scripting Standards:** For any VMware PowerCLI code, you MUST adhere to these strict rules:
    * **Assume Connection:** Assume a connection to a vCenter Server or ESXi host is already established via \`Connect-VIServer\`. Do not include the connection command unless the guide is specifically about connecting.
    * **Use Correct Cmdlets and Properties:** Always use current, official PowerCLI cmdlets. Critically, verify the property names from the objects returned by cmdlets (e.g., the memory size for a VM from \`Get-VM\` is \`MemoryGB\`, not \`Memory\`).
    * **Filter Efficiently ("Filter Right"):** For performance, use server-side filtering parameters on cmdlets like \`Get-VM\`, \`Get-Datastore\`, etc., whenever possible. Avoid retrieving large collections and then filtering with \`Where-Object\` as the primary method.
    * **Comprehensive Error Handling:** All logic must be wrapped in a \`try { ... } catch { ... }\` block. Any cmdlet that could potentially terminate the script must include \`-ErrorAction Stop\` to ensure the \`catch\` block is triggered.
    * **Clarity and Best Practices:** Use clear variable names (e.g., \`$vm\`, \`$datastore\`), include comments for complex logic, and maintain consistent formatting. Always include a disconnect command (\`Disconnect-VIServer -Confirm:$false\`) at the end of a script example.`;
        
        // --- Content Generation Categories ---
        const categoriesToGenerate = [
            { key: 'activeDirectory', title: 'Active Directory Management', description: "Tasks for managing users, groups, GPOs, and other AD objects.", initialPrompt: `Generate 10 common administrative tasks for Active Directory Management. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced administrative tasks for Active Directory Management. For each, give a unique "id", "title", and a detailed "description" of the task. Provide the output as a valid JSON array.` },
            { key: 'azureActiveDirectory', title: 'Azure Active Directory Administration', description: "Managing users, groups, devices, and enterprise applications in Azure AD.", initialPrompt: `Generate 10 common administrative tasks for Azure Active Directory. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced administrative tasks for Azure Active Directory. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'aiProgramming', title: 'Artificial Intelligence Programming', description: "Concepts and guides for getting started with AI development and programming.", initialPrompt: `Generate 10 common topics for an introduction to AI Programming. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 topics for learning AI Programming, from beginner to advanced. For each, give a unique "id", "title", and a detailed "description" of the topic. Provide the output as a valid JSON array.` },
            { key: 'citrixAdmin', title: 'Citrix Administration', description: "Managing Citrix Virtual Apps and Desktops environments.", initialPrompt: `Generate 10 common administrative tasks for Citrix. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced administrative tasks for Citrix. For each, give a unique "id", "title", and a detailed "description" of the task. Provide the output as a valid JSON array.` },
            { key: 'geminiInfographics', title: 'Create Infographics in Gemini', description: "Leverage Gemini to conceptualize, structure, and generate content for infographics.", initialPrompt: `Generate 10 ideas for creating infographics using Gemini's capabilities. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 detailed ideas and processes for using Gemini to create infographics. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'geminiLinkedIn', title: 'Create LinkedIn Posts using Gemini', description: "Use Gemini to draft engaging and professional posts for LinkedIn.", initialPrompt: `Generate 10 types of professional content to create for LinkedIn using Gemini. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 detailed strategies and post formats for LinkedIn using Gemini. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'dataCenterPractices', title: 'Data Center Best Practices', description: "Guides on data center operations, cooling, power, and security.", initialPrompt: `Generate 10 best practices for data center management. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 best practices for modern data center management. For each, give a unique "id", "title", and a detailed "description" of the practice. Provide the output as a valid JSON array.` },
            { key: 'webDesignBestPractices', title: 'Designing Web Pages Best Practices', description: "Best practices for UI/UX, accessibility, and performance in web design.", initialPrompt: `Generate 10 best practices for designing web pages. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 detailed best practices for designing modern web pages. For each, give a unique "id", "title", and a detailed "description" of the practice. Provide the output as a valid JSON array.` },
            { key: 'webDesignGemini', title: 'Designing Web Pages with Gemini AI', description: "Using Gemini AI to assist in the design and development of web pages.", initialPrompt: `Generate 10 ways to use Gemini AI for web design. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 detailed methods for using Gemini AI in web design and development. For each, give a unique "id", "title", and a detailed "description" of the method. Provide the output as a valid JSON array.` },
            { key: 'dosCommands', title: 'DOS Commands for Administrators', description: "A reference for essential DOS and Command Prompt commands for system admins.", initialPrompt: `Generate 10 essential DOS commands for administrators. For each, give a unique "id", "title" (the command itself), and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 essential and advanced DOS/CMD commands for administrators. For each, give a unique "id", "title" (the command itself), and a detailed "description" of its use and parameters. Provide the output as a valid JSON array.` },
            { key: 'geminiCliGuide', title: 'A Guide to Using the Gemini CLI', description: "Learn how to use the Gemini Command Line Interface for various tasks.", initialPrompt: `Generate 10 common use cases for the Gemini CLI. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced use cases and commands for the Gemini CLI. For each, give a unique "id", "title", and a detailed "description" of the use case. Provide the output as a valid JSON array.` },
            { key: 'hpeProLiant', title: 'HPE ProLiant Server Management', description: "Managing and troubleshooting HPE ProLiant servers with iLO and other tools.", initialPrompt: `Generate 10 common administrative tasks for HPE ProLiant Server Management. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced administrative tasks for HPE ProLiant Server Management. For each, give a unique "id", "title", and a detailed "description" of the task. Provide the output as a valid JSON array.` },
            { key: 'javascriptForHtml', title: 'JavaScript for HTML', description: "Core JavaScript concepts for manipulating HTML DOM and creating interactive web pages.", initialPrompt: `Generate 10 fundamental JavaScript concepts for HTML manipulation. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 essential JavaScript concepts and techniques for HTML web development. For each, give a unique "id", "title", and a detailed "description" of the concept. Provide the output as a valid JSON array.` },
            { key: 'linuxCliAdmin', title: 'Linux CLI for Administration', description: "A reference for essential Linux commands for system administrators.", initialPrompt: `Generate 10 essential Linux CLI commands for administrators. For each, give a unique "id", "title" (the command itself), and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 essential and advanced Linux commands for system administration. For each, give a unique "id", "title" (the command), and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'm365Admin', title: 'Microsoft 365 Administration', description: "Administering users, services, and security in Microsoft 365.", initialPrompt: `Generate 10 common administrative tasks for Microsoft 365. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced administrative tasks for Microsoft 365. For each, give a unique "id", "title", and a detailed "description" of the task. Provide the output as a valid JSON array.` },
            { key: 'm365ConditionalAccess', title: 'M365: Conditional Access Policies', description: "Enforce access controls based on user location, device health, and risk level.", initialPrompt: `Generate 10 common scenarios for using M365 Conditional Access Policies. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 scenarios and configurations for M365 Conditional Access Policies. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'm365Dlp', title: 'M365: Data Loss Prevention (DLP)', description: "Create policies to prevent sensitive information from being shared inappropriately.", initialPrompt: `Generate 10 common Data Loss Prevention (DLP) policy ideas for M365. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 policy ideas and configurations for M365 Data Loss Prevention (DLP). For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'm365ExchangeAdmin', title: 'M365: Exchange Admin Center', description: "Manage all aspects of your organization's email, including mailboxes, distribution groups, mail flow rules, and anti-spam policies.", initialPrompt: `Generate 10 common tasks for the M365 Exchange Admin Center. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 tasks and procedures for the M365 Exchange Admin Center. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'm365AdminCenter', title: 'M365: Microsoft 365 Admin Center', description: "Your primary portal for managing your Microsoft 365 subscription, serving as a launching point to more specialized admin centers.", initialPrompt: `Generate 10 key tasks and features of the main Microsoft 365 Admin Center. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 tasks, features, and navigation guides for the main Microsoft 365 Admin Center. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'm365DefenderEndpoint', title: 'M365: Microsoft Defender for Endpoint', description: "Manage endpoint security, vulnerability assessments, and response actions for devices.", initialPrompt: `Generate 10 common tasks in Microsoft Defender for Endpoint. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 administrative tasks and security operations in Microsoft Defender for Endpoint. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'm365DefenderIdentity', title: 'M365: Microsoft Defender for Identity', description: "Monitor and protect against identity-based threats and compromised user accounts.", initialPrompt: `Generate 10 key features of Microsoft Defender for Identity. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 features, alerts, and investigation guides for Microsoft Defender for Identity. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'm365DefenderXdr', title: 'M365: Microsoft Defender XDR Portal', description: "A unified portal to manage and respond to security threats across your Microsoft 365 environment.", initialPrompt: `Generate 10 key areas of the Microsoft Defender XDR portal. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 features, investigation workflows, and administrative tasks within the Microsoft Defender XDR portal. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'm365Mfa', title: 'M365: Multi-Factor Authentication (MFA)', description: "Configure and manage MFA settings to enhance security.", initialPrompt: `Generate 10 key aspects of configuring MFA in M365. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 aspects of configuring and managing MFA in M365, including policies and user enrollment. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'm365Pim', title: 'M365: Privileged Identity Management (PIM)', description: "Provide just-in-time privileged access to resources.", initialPrompt: `Generate 10 concepts of using Privileged Identity Management (PIM) in M365. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 concepts and procedures for using Privileged Identity Management (PIM) in M365. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'm365PowerPlatformAdmin', title: 'M365: Power Platform Admin Center', description: "Manage environments, data policies, and integrations for Power Apps, Power Automate, and Power BI.", initialPrompt: `Generate 10 common tasks for the Power Platform Admin Center. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 administrative tasks and governance policies for the Power Platform Admin Center. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'm365SharepointAdmin', title: 'M365: SharePoint Admin Center', description: "Control your organization's SharePoint sites and OneDrive settings. Manage site collections, sharing policies, and storage limits.", initialPrompt: `Generate 10 common tasks for the SharePoint Admin Center. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 administrative tasks and settings in the SharePoint Admin Center. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'm365Sso', title: 'M365: Single Sign-On (SSO)', description: "Manage SSO for thousands of pre-integrated SaaS applications.", initialPrompt: `Generate 10 concepts for configuring SSO in M365. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 concepts and procedures for configuring SSO for apps in M365. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'm365TeamsAdmin', title: 'M365: Teams Admin Center', description: "Manage all aspects of Microsoft Teams, including user policies, meeting settings, app integrations, and call quality.", initialPrompt: `Generate 10 common tasks for the Teams Admin Center. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 policies, settings, and management tasks for the Teams Admin Center. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'm365UserGroupMgmt', title: 'M365: User and Group Management', description: "Advanced management of user accounts, security groups, and distribution lists.", initialPrompt: `Generate 10 advanced user and group management tasks in M365. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 advanced user and group management tasks and scenarios in M365. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'msGraphScripting', title: 'MS Graph scripting', description: "Automating M365 tasks using the Microsoft Graph API.", initialPrompt: `Generate 10 common tasks to automate with MS Graph scripting. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced tasks to automate with Microsoft Graph scripting. For each, give a unique "id", "title", and a detailed "description" of the task. Provide the output as a valid JSON array.` },
            { key: 'psForM365AdminCenter', title: 'PowerShell for Microsoft 365 Admin Center', description: "Using PowerShell to manage core M365 settings, licenses, and users.", initialPrompt: `Generate 10 common PowerShell tasks for the main M365 Admin Center. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced PowerShell tasks for the main M365 Admin Center. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'psForM365Entra', title: 'PowerShell for Microsoft Entra', description: "Using PowerShell to manage users, groups, devices, and applications in Microsoft Entra ID.", initialPrompt: `Generate 10 common PowerShell tasks for Microsoft Entra. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced PowerShell tasks for Microsoft Entra. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'psForM365Exchange', title: 'PowerShell for Microsoft Exchange Online', description: "Using PowerShell to manage mailboxes, transport rules, and other Exchange Online features.", initialPrompt: `Generate 10 common PowerShell tasks for Exchange Online. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced PowerShell tasks for Exchange Online. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'psForM365Sharepoint', title: 'PowerShell for Microsoft SharePoint Online', description: "Using PowerShell to manage SharePoint sites, lists, permissions, and settings.", initialPrompt: `Generate 10 common PowerShell tasks for SharePoint Online. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced PowerShell tasks for SharePoint Online. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'psForM365Teams', title: 'PowerShell for Microsoft Teams', description: "Using PowerShell to manage Teams, channels, policies, and users in Microsoft Teams.", initialPrompt: `Generate 10 common PowerShell tasks for Microsoft Teams. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 policies, settings, and management tasks for the Teams Admin Center. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'powershellWindowsServer', title: 'PowerShell for Windows Server Administration', description: "Automating Windows Server management with PowerShell scripts and cmdlets.", initialPrompt: `Generate 10 common PowerShell tasks for Windows Server Administration. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced PowerShell tasks for Windows Server Administration. For each, give a unique "id", "title", and a detailed "description" of the task. Provide the output as a valid JSON array.` },
            { key: 'powershellScripts', title: 'PowerShell Scripts', description: "A collection of useful PowerShell scripts for various administrative tasks.", initialPrompt: `Generate 10 useful PowerShell script ideas for administrators. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 useful and practical PowerShell script ideas for administrators. For each, give a unique "id", "title", and a detailed "description" of the script's purpose. Provide the output as a valid JSON array.` },
            { key: 'scomAdmin', title: 'SCOM Administration', description: 'Guides for administering Microsoft System Center Operations Manager (SCOM).', initialPrompt: `Generate 10 common administrative tasks for SCOM. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced administrative tasks for SCOM. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'serviceNowAdmin', title: 'ServiceNow Platform Administration', description: 'Guides for administering the ServiceNow cloud platform for IT service management (ITSM) and digital workflows.', initialPrompt: `Generate 10 common administrative tasks for the ServiceNow platform. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced administrative tasks for the ServiceNow platform. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'usefulApis', title: 'Useful APIs for Web Development', description: "A curated list of public APIs that are useful for web development projects.", initialPrompt: `Generate a list of 10 useful public APIs for web developers. For each, give a unique "id", "title" (API name), and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate a list of 40-50 useful public APIs for web developers. For each, give a unique "id", "title" (API name), and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'vmwareEsxi', title: 'VMware ESXi Administration', description: "Guides and best practices for managing VMware ESXi environments.", initialPrompt: `Generate 10 common administrative tasks for VMware ESXi. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced administrative tasks for VMware ESXi. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'vmwarePowerCli', title: 'VMware PowerCLI', description: "Automating VMware vSphere administration using PowerCLI.", initialPrompt: `Generate 10 common VMware PowerCLI commands for administrators. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced tasks using VMware PowerCLI. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'windows11Admin', title: 'Windows 11 Administration', description: "Key tasks and features for administering Windows 11 in an enterprise.", initialPrompt: `Generate 10 key administrative tasks for Windows 11. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 administrative tasks specific to Windows 11. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'windows12Features', title: 'Windows 12 - New Features', description: "Exploring the announced and anticipated new features of Windows 12.", initialPrompt: `Generate 10 anticipated new features for Windows 12. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 anticipated new features and changes for Windows 12. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'windowsServer', title: 'Windows Server Administration', description: "Essential tasks for managing Windows Server instances.", initialPrompt: `Generate 10 common administrative tasks for Windows Server. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 common and advanced administrative tasks for Windows Server. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'windowsServer2019', title: 'Windows Server 2019 Administration', description: "Key tasks and features for administering Windows Server 2019.", initialPrompt: `Generate 10 key administrative tasks for Windows Server 2019. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 administrative tasks specific to Windows Server 2019. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'windowsServer2022', title: 'Windows Server 2022 Administration', description: "Key tasks and new features for administering Windows Server 2022.", initialPrompt: `Generate 10 key administrative tasks for Windows Server 2022. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 administrative tasks specific to Windows Server 2022. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'windowsServer2025', title: 'Windows Server 2025', description: "Exploring the new features and administration changes in Windows Server 2025.", initialPrompt: `Generate 10 key new features in Windows Server 2025. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 new features and administrative tasks for Windows Server 2025. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` },
            { key: 'windowsServer2025Azure', title: 'Windows Server 2025 Datacenter: Azure Edition', description: "Exploring features specific to the Azure Edition of Windows Server 2025, like Hotpatching and SMB over QUIC.", initialPrompt: `Generate 10 key features of Windows Server 2025 Azure Edition. For each, give a unique "id", "title", and a short "description". Provide the output as a valid JSON array.`, fullPrompt: `Generate 40-50 features and management tasks specific to Windows Server 2025 Azure Edition. For each, give a unique "id", "title", and a detailed "description". Provide the output as a valid JSON array.` }
        ];
        
        // --- Global State & Configuration ---
        let geminiApiKey = "";
        const root = document.documentElement;
        const allThemeData = {};
        const fullPrompts = {}; 
        let originalGeneratedText = new Map();
        let aiLog = []; // NEW: For logging AI interactions

        // --- Google Drive Integration State & Config ---
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let GOOGLE_CLIENT_ID = '';
        const G_SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/cloud-platform';
        let driveFolderId = null;

        
        // --- App Initialization & Event Listeners ---
        function initializeApplication() {
            setupEventListeners();
            populateTypographySettings();
            marked.setOptions({
                renderer: new marked.Renderer(),
                highlight: (code, lang) => code,
                langPrefix: 'language-',
                gfm: true,
                breaks: true,
            });

            if (loadConfigFromStorage()) {
                initializeFirebase();
                initializeGoogleClients(); 
            } else {
                openModal('apiKeyModal');
            }
        }
        
        document.addEventListener('DOMContentLoaded', initializeApplication);

        function loadConfigFromStorage() {
            geminiApiKey = localStorage.getItem('geminiApiKey');
            const firebaseConfigString = localStorage.getItem('firebaseConfig');
            GOOGLE_CLIENT_ID = localStorage.getItem('googleClientId');

            if (firebaseConfigString) {
                try {
                    firebaseConfig = JSON.parse(firebaseConfigString);
                } catch (e) {
                    console.error("Failed to parse Firebase config from localStorage", e);
                    localStorage.clear();
                    return false;
                }
            }

            if (geminiApiKey && firebaseConfig) {
                document.getElementById('geminiApiKeyInput').value = geminiApiKey;
                document.getElementById('firebaseConfigInput').value = JSON.stringify(firebaseConfig, null, 2);
                if (GOOGLE_CLIENT_ID) {
                    document.getElementById('googleClientIdInput').value = GOOGLE_CLIENT_ID;
                }
                return true;
            }
            return false;
        }
        
        // --- Login/Logout UI and Handlers ---
        function setupAuthUI(user) {
            const authStatusEl = document.getElementById('auth-status');
            const appContainer = document.getElementById('app-container');

            if (user) {
                // User is LOGGED IN
                appContainer.classList.remove('hidden');
                closeModal('apiKeyModal');
                
                authStatusEl.innerHTML = `
                    <div class="bg-white/20 backdrop-blur-sm rounded-full p-1 flex items-center gap-2 text-white text-sm">
                        <img src="${user.photoURL}" alt="User photo" class="w-8 h-8 rounded-full">
                        <span class="font-medium pr-2">${user.displayName}</span>
                        <button id="logout-button" class="bg-white/20 hover:bg-white/40 text-white font-semibold py-1 px-3 rounded-full flex items-center justify-center gap-2" title="Sign Out">
                            <span>Logout</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        </button>
                    </div>
                `;
                document.getElementById('logout-button').addEventListener('click', handleLogout);
                
                if (!appIsInitialized) {
                    initializeAppContent();
                }

            } else {
                // User is LOGGED OUT
                 authStatusEl.innerHTML = `
                     <button id="login-button" class="bg-white/20 backdrop-blur-sm hover:bg-white/30 text-white font-semibold py-2 px-4 rounded-full flex items-center justify-center gap-2" title="Sign In with Google">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48" fill="none"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="m6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.599-1.521 12.643-4.001L30.27 34.138C28.714 36.548 26.521 38 24 38c-5.223 0-9.657-3.341-11.303-7.918l-6.573 4.818C9.656 39.663 16.318 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H24v8h11.303c-.792 2.237-2.231 4.16-4.082 5.571l5.657 5.657C41.389 36.197 44 30.669 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                        <span>Login with Google</span>
                    </button>
                `;
                document.getElementById('login-button').addEventListener('click', handleLogin);
                
                appContainer.classList.add('hidden');
                // Only show API key modal if the user is logged out AND there are no keys saved
                if (!localStorage.getItem('geminiApiKey')) {
                     openModal('apiKeyModal');
                }
            }
        }

        async function handleLogin() {
            const provider = new GoogleAuthProvider();
            provider.addScope('https://www.googleapis.com/auth/cloud-platform');
            try {
                const result = await signInWithPopup(auth, provider);
                console.log("Popup sign-in successful for:", result.user.displayName);
            } catch (error) {
                console.error("Google Sign-In Popup failed:", error);
                const errorEl = document.getElementById('api-key-error');
                if (errorEl) {
                   // Provide more specific error feedback for the user.
                   let userMessage = `Login failed: ${error.code}.`;
                   if (error.code === 'auth/popup-closed-by-user') {
                       userMessage += ' You closed the login window before completing sign-in.';
                   } else if (error.code === 'auth/cancelled-popup-request') {
                       userMessage += ' Multiple login windows were opened. Please try again.';
                   } else {
                       userMessage += ' This can be caused by browser pop-up blockers or security settings. Please check your browser settings and try again.';
                   }
                   errorEl.textContent = userMessage;
                }
            }
        }

        function handleLogout() {
            const driveToken = gapi?.client?.getToken();
            if (driveToken) {
                google.accounts.oauth2.revoke(driveToken.access_token, () => {
                     console.log('Google Drive token revoked.');
                });
            }
            signOut(auth).then(() => {
                updateSigninStatus(false);
                localStorage.removeItem('geminiApiKey');
                localStorage.removeItem('firebaseConfig');
                localStorage.removeItem('googleClientId');
                console.log('User signed out and local storage cleared.');
                location.reload();
            }).catch(error => {
                console.error("Sign out failed:", error);
                const authStatusEl = document.getElementById('auth-status');
                if(authStatusEl) authStatusEl.innerHTML = `<p class="text-red-300">Sign out failed.</p>`;
            });
        }
        
        async function initializeAppContent() {
            appIsInitialized = true;
            const loadingMessageEl = document.getElementById('loading-message');
            loadingMessageEl.textContent = "The AI is generating the initial content and guides. This may take a few moments.";
            openModal('loadingStateModal');

            document.getElementById('main-grid').innerHTML = '';
            
            document.getElementById('gemini-result-container').innerHTML = '';
            document.getElementById('discover-more-error').innerHTML = '';

            try {
                await generateAndApplyDefaultTheme();
                await loadAppContent(loadingMessageEl);
            } catch (error) {
                const errorMessage = error ? error.message : "An unknown error occurred.";
                console.error("A critical error occurred during app initialization:", errorMessage);
                localStorage.clear();
                openModal('apiKeyModal');
                const errorEl = document.getElementById('api-key-error');
                if(errorEl) {
                    errorEl.textContent = `Setup failed: ${errorMessage}. Your keys have been cleared. Please check and re-enter them.`;
                }
            } finally {
                closeModal('loadingStateModal');
            }
        }
        
        /**
         * Initializes both GAPI (for Drive/Picker) and GSI (for auth token client).
         * This is called once after config is loaded.
         */
        function initializeGoogleClients() {
            if (!GOOGLE_CLIENT_ID) {
                console.warn("Google Client ID is not provided. Cloud features will be disabled.");
                return;
            }

            document.getElementById('cloud-storage-card').classList.remove('hidden');
            document.getElementById('google-drive-section').classList.remove('hidden');
            
            // Wait for the gapi script to load.
            const gapiInterval = setInterval(() => {
                if (window.gapi && window.gapi.load) {
                    clearInterval(gapiInterval);
                    gapi.load('client:picker', () => {
                        gapiInited = true;
                        initializeGapiClient();
                    });
                }
            }, 100);

            // Wait for the GSI script to load.
            const gsiInterval = setInterval(() => {
                if (window.google && window.google.accounts) {
                    clearInterval(gsiInterval);
                    google.accounts.id.initialize({
                        client_id: GOOGLE_CLIENT_ID,
                        callback: () => {}, // Callback is handled by the token client flow
                    });
                    gisInited = true;
                }
            }, 100);
        }

        function initializeFirebase() {
             if (!firebaseConfig) {
                console.warn("Firebase config is missing. Firebase initialization skipped.");
                return;
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        const appId = firebaseConfig.appId || 'it-admin-hub-global'; 
                        viewedItemsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/viewedItems`);
                        listenForViewedItems();
                    } else {
                        userId = null;
                        viewedItemsCollectionRef = null;
                    }
                    setupAuthUI(user);
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                openModal('apiKeyModal');
                const errorEl = document.getElementById('api-key-error');
                if(errorEl) {
                    errorEl.textContent = `Firebase Error: ${error.message}. Please check your config object.`;
                }
            }
        }
        
        function listenForViewedItems() {
            if (!viewedItemsCollectionRef) return;
            onSnapshot(viewedItemsCollectionRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        viewedItemIds.add(change.doc.id);
                    }
                });
            }, (error) => {
                console.error("Error listening to viewed items:", error);
            });
        }


        function setupEventListeners() {
            document.getElementById('apiKeyForm').addEventListener('submit', handleApiKeySubmit);
            document.getElementById('gemini-form').addEventListener('submit', handleGeminiSubmit);
            document.getElementById('generate-theme-btn').addEventListener('click', handleCustomVisualThemeGeneration);
            document.getElementById('discover-more-button').addEventListener('click', handleDiscoverMoreClick);

            document.getElementById('auth-button').addEventListener('click', handleAuthClick);
            document.getElementById('load-from-drive-btn').addEventListener('click', async () => {
                const folderId = await getDriveFolderId();
                createPicker('open', folderId);
            });

            document.getElementById('new-plan-button').addEventListener('click', () => location.reload());
            document.getElementById('prompts-button').addEventListener('click', displayPromptsInModal);
            document.getElementById('real-time-log-button').addEventListener('click', displayAiLog); // NEW
            document.getElementById('theme-changer-button').addEventListener('click', () => {
                if(!geminiApiKey) {
                    openModal('apiKeyModal');
                    return;
                }
                openModal('themeGeneratorModal');
            });
            document.getElementById('ai-help-button').addEventListener('click', handleAIHelpRequest);
            document.getElementById('scroll-to-top-button').addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
            
            const settingsPanel = document.getElementById('settings-panel');
            document.getElementById('settings-button').addEventListener('click', (e) => {
                e.stopPropagation();
                settingsPanel.classList.toggle('hidden');
            });

            document.getElementById('font-family-select').addEventListener('change', (e) => root.style.setProperty('--font-family', e.target.value));
            document.getElementById('font-size-select').addEventListener('change', (e) => root.style.setProperty('--font-size-base', e.target.value));
            document.getElementById('line-height-select').addEventListener('change', (e) => root.style.setProperty('--line-height-base', e.target.value));
            
            // General modal close listener
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal || e.target.closest('[id^="close"]')) {
                        closeModal(modal.id);
                    }
                });
            });
            
            document.getElementById('search-gemini-button').addEventListener('click', handleSearchGemini);

            document.addEventListener('mouseup', handleTextSelection);
            document.addEventListener('mousedown', (e) => {
                 const searchButton = document.getElementById('search-gemini-button');
                 // Hide search button if clicking anywhere other than on the button itself while it's visible.
                 if (!searchButton.classList.contains('hidden') && !searchButton.contains(e.target)) {
                    searchButton.classList.add('hidden');
                 }
            });

            // Topics dropdown menu listeners
            const topicsMenuButton = document.getElementById('topics-menu-button');
            const topicsMenuItems = document.getElementById('topics-menu-items');

            topicsMenuButton.addEventListener('click', (e) => {
                e.stopPropagation();
                topicsMenuItems.classList.toggle('hidden');
            });

            document.addEventListener('click', (e) => {
                // Hide topics menu if click is outside
                if (!topicsMenuButton.contains(e.target) && !topicsMenuItems.contains(e.target)) {
                    topicsMenuItems.classList.add('hidden');
                }

                const menuItem = e.target.closest('.topics-menu-item');
                if (menuItem) {
                    e.preventDefault(); 
                    const targetCard = document.getElementById(menuItem.dataset.targetId);
                    if (targetCard) {
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'start'});
                        targetCard.style.boxShadow = '0 0 0 4px var(--color-primary)';
                        setTimeout(() => targetCard.style.boxShadow = '', 2000);
                    }
                    topicsMenuItems.classList.add('hidden');
                    return;
                }

                if (e.target.classList.contains('copy-code-button')) {
                    const codeBlock = e.target.closest('.code-block-container').querySelector('code, pre');
                    copyElementTextToClipboard(codeBlock, e.target);
                    return;
                }
                
                if (e.target.id === 'save-to-drive-btn') {
                     handleSaveToDriveClick(e.target);
                     return;
                }
                
                const addTopicBtn = e.target.closest('.add-topic-button');
                if(addTopicBtn) {
                    handleAddNewTopic(addTopicBtn);
                    return;
                }
                
                const tailorBtn = e.target.closest('#tailoring-buttons-container .btn-toggle');
                if (tailorBtn) {
                    tailorBtn.classList.toggle('active');
                    return;
                }

                const gridSelector = e.target.closest('.grid-card-selector');
                if (gridSelector) {
                    handleGridSelect(gridSelector);
                    return;
                }

                const exploreBtn = e.target.closest('.explore-button');
                if (exploreBtn) {
                    const cardName = exploreBtn.closest('.card').querySelector('h2').textContent;
                    handleExploreInDepth(exploreBtn.dataset.themeId, exploreBtn.dataset.themeType, cardName);
                    return;
                }
                
                const refineBtn = e.target.closest('.refine-button');
                if (refineBtn) {
                    toggleRefineUI(refineBtn.parentElement);
                    return;
                }

                const modalRefineBtn = e.target.closest('.modal-refine-button');
                if (modalRefineBtn) {
                    const modal = e.target.closest('.card');
                    const targetModalId = modal.parentElement.id;
                    if(targetModalId) {
                         toggleRefineUI(modalRefineBtn.parentElement, true, targetModalId);
                    }
                    return;
                }
                
                const submitRefineBtn = e.target.closest('.submit-refinement-button');
                if(submitRefineBtn) {
                    const targetModalId = submitRefineBtn.dataset.targetModalId;
                    handleRefineRequest(submitRefineBtn.closest('.refine-container'), targetModalId);
                    return;
                }

                const showAllBtn = e.target.closest('.show-all-button');
                if (showAllBtn) {
                    handleShowAllClick(showAllBtn);
                    return;
                }

                const generateMoreBtn = e.target.closest('.generate-more-button');
                if (generateMoreBtn) {
                    handleGenerateMoreClick(generateMoreBtn);
                    return;
                }

                const accordionHeader = e.target.closest('.accordion-header');
                if (accordionHeader) { 
                    accordionHeader.classList.toggle('active');
                    const icon = accordionHeader.querySelector('.icon');
                    if(icon) {
                       icon.style.transform = accordionHeader.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0deg)';
                    }
                    accordionHeader.nextElementSibling.classList.toggle('open'); 
                    return;
                }

                if (!settingsPanel.classList.contains('hidden') && !settingsPanel.contains(e.target) && !e.target.closest('#settings-button')) {
                    settingsPanel.classList.add('hidden');
                }

                const generateDetailedStepsBtn = e.target.closest('#generate-detailed-steps-btn');
                if (generateDetailedStepsBtn) {
                    generateFullDetailedGuide(generateDetailedStepsBtn);
                    return;
                }
            });
            
            window.addEventListener('scroll', () => {
                const scrollTopButton = document.getElementById('scroll-to-top-button');
                if (window.scrollY > 300) {
                    scrollTopButton.classList.remove('hidden');
                } else {
                    scrollTopButton.classList.add('hidden');
                }
            });

            // Sticky Topics Modal Listeners
            document.getElementById('firebase-tools-button').addEventListener('click', openStickyTopicsModal);
            document.getElementById('sticky-topic-category-select').addEventListener('change', (e) => listenForStickyTopics(e.target.value));
            document.getElementById('add-sticky-topic-button').addEventListener('click', handleAddStickyTopic);
        }
        
        async function handleApiKeySubmit(e) {
            e.preventDefault();
            const tempGeminiKey = document.getElementById('geminiApiKeyInput').value.trim();
            const tempFirebaseConfigText = document.getElementById('firebaseConfigInput').value.trim();
            const tempGoogleClientId = document.getElementById('googleClientIdInput').value.trim();
            let tempFirebaseConfig;

            const errorEl = document.getElementById('api-key-error');
            errorEl.textContent = ''; 

            if (!tempGeminiKey || !tempFirebaseConfigText) {
                errorEl.textContent = "Gemini API Key and Firebase Config are required.";
                return;
            }
            
            try {
                const match = tempFirebaseConfigText.match(/\{[\s\S]*\}/);
                if (!match) {
                    throw new Error("Could not find a config object starting with '{' and ending with '}'.");
                }
                const configString = match[0];
                
                const configFactory = new Function(`return ${configString}`);
                tempFirebaseConfig = configFactory();

                if (!tempFirebaseConfig || typeof tempFirebaseConfig !== 'object' || !tempFirebaseConfig.apiKey || !tempFirebaseConfig.projectId) {
                    throw new Error("The parsed Firebase config is invalid or missing required properties like 'apiKey' or 'projectId'.");
                }
            } catch (err) {
                errorEl.textContent = `Invalid Firebase Config: ${err.message}. Please ensure you've pasted the complete snippet from your Firebase project settings.`;
                return;
            }
            
            localStorage.setItem('geminiApiKey', tempGeminiKey);
            localStorage.setItem('firebaseConfig', JSON.stringify(tempFirebaseConfig));
            localStorage.setItem('googleClientId', tempGoogleClientId);
            
            if (loadConfigFromStorage()) {
                initializeFirebase();
                initializeGoogleClients();
                handleLogin();
            }
        }

        // --- Google Drive & Firebase Functions ---
        
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
                gapiInited = true;
                initializeTokenClient();

            } catch(error) {
                console.error("Error initializing GAPI Client", error);
                document.getElementById('drive-status').textContent = 'Google API init failed. Check keys.';
            }
        }

        function initializeTokenClient() {
            if (!gisInited || !GOOGLE_CLIENT_ID) {
                console.error("Google GSI client or Client ID is missing. Cannot initialize token client.");
                return;
            }
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: G_SCOPES,
                    callback: (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            gapi.client.setToken(tokenResponse);
                            updateSigninStatus(true);
                        } else {
                            console.error('User denied access or token response was invalid.', tokenResponse);
                            updateSigninStatus(false);
                        }
                    },
                    popup_closed_callback: () => {
                        console.log('User closed the Google auth popup.');
                        const statusEl = document.getElementById('drive-status');
                        if (statusEl.textContent.includes('Connecting')) {
                            statusEl.textContent = 'Connection cancelled.';
                            setTimeout(() => updateSigninStatus(false), 2000);
                        }
                    }
                });
                tokenClient.requestAccessToken({prompt: 'none'});
            } catch(err) {
                 console.error("Failed to initialize Google token client:", err);
            }
        }

        function handleAuthClick() {
             if (!gapiInited || !gisInited || !tokenClient) {
                console.error('Google services are not initialized yet.');
                document.getElementById('drive-status').textContent = 'Services initializing, please wait...';
                return;
            }

            if (gapi.client.getToken() === null) {
                document.getElementById('drive-status').textContent = 'Connecting to Google Drive...';
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                const token = gapi.client.getToken();
                if (token) {
                    google.accounts.oauth2.revoke(token.access_token, () => {
                        gapi.client.setToken(null);
                        updateSigninStatus(false);
                    });
                }
            }
        }
        
        function updateSigninStatus(isSignedIn) {
            const authButton = document.getElementById('auth-button');
            const loadBtn = document.getElementById('load-from-drive-btn');
            const statusEl = document.getElementById('drive-status');
            
            if (isSignedIn) {
                authButton.textContent = 'Disconnect';
                authButton.title = 'Disconnect your Google Account';
                loadBtn.classList.remove('hidden');
                statusEl.textContent = 'Connected to Google Drive.';
                getDriveFolderId(); 
            } else {
                authButton.textContent = 'Connect';
                authButton.title = 'Connect your Google Account';
                loadBtn.classList.add('hidden');
                statusEl.textContent = 'Connect to load/save guides and enable AI image generation.';
                driveFolderId = null;
            }

            // Refresh buttons in any open modals
            if (document.body.classList.contains('inDepthModal-open')) {
                const isInitial = !!document.getElementById('generate-detailed-steps-btn');
                addModalActionButtons(document.getElementById('inDepthModalButtons'), isInitial);
            }
            if (document.body.classList.contains('inDepthDetailedModal-open')) {
                addDetailedModalActionButtons(document.getElementById('inDepthDetailedModalButtons'));
            }
            if (document.body.classList.contains('searchGeminiModal-open')) {
                addSearchModalActionButtons(document.getElementById('searchGeminiModalButtons'));
            }
        }

        async function getDriveFolderId() {
            if (driveFolderId) return driveFolderId;
            const driveStatusEl = document.getElementById('drive-status');
            driveStatusEl.textContent = 'Searching for app folder...';
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: "mimeType='application/vnd.google-apps.folder' and name='IT Administration Hub' and trashed=false",
                    fields: 'files(id, name)',
                });

                if (response.result.files && response.result.files.length > 0) {
                    driveFolderId = response.result.files[0].id;
                } else {
                    driveStatusEl.textContent = 'Creating app folder...';
                    const folderResponse = await gapi.client.drive.files.create({
                        resource: { 'name': 'IT Administration Hub', 'mimeType': 'application/vnd.google-apps.folder' },
                        fields: 'id'
                    });
                    driveFolderId = folderResponse.result.id;
                }
                driveStatusEl.textContent = 'Connected to Google Drive.';
                return driveFolderId;
            } catch (error) {
                console.error("Error finding/creating Drive folder:", error);
                driveStatusEl.textContent = 'Error with Drive folder access.';
                return null;
            }
        }
        
        async function handleSaveToDriveClick(button) {
             const modal = button.closest('.card');
             if (!modal) return;
             
             let contentToSave;
             let statusEl;
             let cardName;
             let topicTitle;

            if (modal.parentElement.id === 'searchGeminiModal') {
                contentToSave = document.getElementById('searchGeminiResult').innerText;
                cardName = "Gemini Search";
                topicTitle = document.getElementById('searchGeminiQueryText').value;
                statusEl = document.getElementById('search-modal-status-message');
            } else {
                const modalFooter = button.closest('[id$="ModalFooter"]');
                const fullTitle = modalFooter.dataset.fullTitle;
                cardName = modalFooter.dataset.cardName || "Guide";
                contentToSave = originalGeneratedText.get(fullTitle);
                topicTitle = fullTitle.replace(/In-Depth: |Custom Guide: |Complete Guide: /g, '');
                statusEl = modalFooter.querySelector('p[id$="status-message"]');
            }
             
             if (!contentToSave) {
                console.error("Could not find content to save for:", topicTitle);
                if (statusEl) statusEl.textContent = "Error: Content not found.";
                return;
             }

             const fileName = `${cardName} - ${topicTitle}.md`.replace(/[/\\?%*:|"<>]/g, '-'); // Sanitize filename
             await saveContentToDrive(contentToSave, fileName, statusEl);
        }

        async function saveContentToDrive(content, fileName, statusElement) {
            if (gapi.client.getToken() === null) {
                statusElement.textContent = 'Please connect to Google Drive first.';
                return;
            }

            statusElement.textContent = 'Saving to Google Drive...';
            const folderId = await getDriveFolderId();
            if (!folderId) {
                statusElement.textContent = 'Could not find or create the app folder in Drive.';
                return;
            }

            try {
                // Check if file already exists
                const searchResponse = await gapi.client.drive.files.list({
                    q: `name='${fileName.replace(/'/g, "\\'")}' and '${folderId}' in parents and trashed=false`,
                    fields: 'files(id)',
                    spaces: 'drive'
                });

                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";

                const contentType = 'text/markdown';
                const metadata = { name: fileName };
                if (!searchResponse.result.files || searchResponse.result.files.length === 0) {
                     metadata.parents = [folderId];
                }
                
                const multipartRequestBody =
                    delimiter + `Content-Type: application/json; charset=UTF-8\r\n\r\n` + JSON.stringify(metadata) +
                    delimiter + `Content-Type: ${contentType}\r\n\r\n` + content +
                    close_delim;
                
                const fileExists = searchResponse.result.files && searchResponse.result.files.length > 0;
                const fileId = fileExists ? searchResponse.result.files[0].id : null;
                
                await gapi.client.request({
                    path: `/upload/drive/v3/files${fileExists ? '/' + fileId : ''}`,
                    method: fileExists ? 'PATCH' : 'POST',
                    params: { uploadType: 'multipart' },
                    headers: {'Content-Type': `multipart/related; boundary="${boundary}"`},
                    body: multipartRequestBody
                });

                statusElement.textContent = `File '${fileName}' ${fileExists ? 'updated' : 'saved'} in Drive!`;
                setTimeout(()=> statusElement.textContent = '', 4000);
            } catch (error) {
                console.error('Error saving file to Drive:', error);
                statusElement.textContent = 'Error saving file. Check console.';
            }
        }


        function createPicker(mode, startInFolderId = null) { 
            if (!gisInited || !gapiInited) {
                 console.error("Google services not ready for picker.");
                 (document.getElementById('drive-status') || document.getElementById('modal-status-message')).textContent = 'Google API not ready.';
                 return;
             }
            
             const token = gapi.client.getToken()?.access_token;
             if (!token) {
                 (document.getElementById('drive-status') || document.getElementById('modal-status-message')).textContent = 'You are not signed in.';
                 return;
             }
             const builder = new google.picker.PickerBuilder()
                .setOAuthToken(token)
                .setDeveloperKey(geminiApiKey);

             if (mode === 'open') {
                const view = new google.picker.View(google.picker.ViewId.DOCS);
                view.setMimeTypes("text/markdown,text/plain,.md");
                if (startInFolderId) {
                    view.setParent(startInFolderId);
                }
                builder.addView(view).setCallback(pickerCallbackOpen);
             } 

             const picker = builder.build();
             picker.setVisible(true);
        }

        async function pickerCallbackOpen(data) {
            if (data.action === google.picker.Action.PICKED) {
                const fileId = data.docs[0].id;
                const statusEl = document.getElementById('drive-status');
                statusEl.textContent = 'Loading selected file...';
                try {
                    const response = await gapi.client.drive.files.get({ fileId, alt: 'media' });
                    const fileContent = response.body;
                    const fileName = data.docs[0].name;
                    
                    displayImportedGuide(fileName, fileContent);
                    statusEl.textContent = 'File loaded successfully.';
                    setTimeout(() => updateSigninStatus(true), 3000);

                } catch (error) {
                    console.error("Error loading file content:", error);
                    statusEl.textContent = 'Error loading file from Google Drive.';
                }
            }
        }

        function displayImportedGuide(fileName, markdownContent) {
            const section = document.getElementById('imported-guides-section');
            const container = document.getElementById('imported-guides-container');
            section.classList.remove('hidden');

            const cardId = `imported-${fileName.replace(/[^a-zA-Z0-9]/g, '')}-${Date.now()}`;
            
            const card = document.createElement('div');
            card.className = 'card md:col-span-2';
            card.id = cardId;
            
            const cardContent = document.createElement('div');
            cardContent.className = 'p-8 card-content';
            
            cardContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-2 themed-text-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                    Imported: ${fileName}
                </h2>
                <div class="prose max-w-none mt-4"></div>
            `;
            
            const renderTarget = cardContent.querySelector('.prose');
            renderAccordionFromMarkdown(markdownContent, renderTarget, false);

            card.appendChild(cardContent);
            container.prepend(card);

            card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // --- Core Application Functions ---

        async function loadAppContent(loadingMessageEl) {
            try {
                categoriesToGenerate.sort((a, b) => a.title.localeCompare(b.title));

                await Promise.allSettled([loadAITailoringOptions(), loadDynamicPlaceholders()]);
                
                const generationPromises = categoriesToGenerate.map(cat => {
                    if (loadingMessageEl) loadingMessageEl.textContent = `Generating guides for: ${cat.title}...`;
                    return generateAndPopulateAICategory(cat).catch(e => {
                        console.error(`Failed to load category: ${cat.title}`, e);
                        return { key: cat.key, error: e };
                    });
                });

                const results = await Promise.all(generationPromises);
                const firstFailure = results.find(r => r && r.error);
                if(firstFailure){
                    throw new Error(`One or more AI content categories failed to load, starting with ${firstFailure.key}. The process has been stopped.`);
                }
                
                if (loadingMessageEl) loadingMessageEl.textContent = `Building navigation...`;
                await generateTopicsMenu();

            } catch (error) {
                console.error("An error occurred while loading app content:", error.message);
                throw error;
            }
        }
        
        async function generateAndPopulateAICategory({key, title, description, initialPrompt, fullPrompt}) {
            const mainGrid = document.getElementById('main-grid');
            const card = document.createElement('div');
            card.className = 'card md:col-span-2';
            card.id = `${key}-card`;
            const selectorId = `${key}-selector-visual`;
            card.innerHTML = `<div class="p-8 card-content"><h2 class="text-2xl font-bold mb-2 themed-text-primary">${title}</h2><p class="mb-6 themed-text-muted">${description}</p><div id="${selectorId}" data-theme-type="${key}" class="w-full">${getLoaderHTML(`AI is generating guides for ${title}...`)}</div><div id="${key}-details" class="details-container mt-4"></div></div>`;
            mainGrid.appendChild(card);
            
            fullPrompts[key] = fullPrompt;

            try {
                const jsonText = await callGeminiAPI(initialPrompt, true, "Initial Category Population");
                if (!jsonText) throw new Error(`API returned empty content for ${title}.`);
                
                const data = parseJsonWithCorrections(jsonText);
                data.sort((a, b) => a.title.localeCompare(b.title));
                allThemeData[key] = data;
                populateCardGridSelector(selectorId, key);
            } catch (error) {
                handleApiError(error, document.getElementById(selectorId), title, card);
                throw error;
            }
        }
        
        function populateCardGridSelector(containerId, themeType, newItemsIds = new Set()) {
            const container = document.getElementById(containerId);
            const data = allThemeData[themeType] || [];
            const stickies = stickyTopics[themeType] || [];
            
            if (!container) return;
            if (data.length === 0 && stickies.length === 0) {
                 container.innerHTML = `<p class="themed-text-muted">No items to display.</p>`;
                return;
            }

            const gridClass = 'card-grid-container';
            const cardTitle = container.closest('.card').querySelector('h2').textContent;

            const stickyTitles = new Set(stickies.map(s => s.title));

            const stickyHtml = stickies.map(item => `
                <div id="grid-selector-${item.id}" class="grid-card-selector" data-theme-id="${item.id}" data-theme-type="${themeType}" title="${item.title}">
                    <div class="indicator sticky-indicator" title="Sticky Topic">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L13 7.414V17a1 1 0 11-2 0V7.414L7.707 10.707a1 1 0 01-1.414-1.414l4-4z" clip-rule="evenodd" /></svg>
                    </div>
                    <div class="icon">${getIconForTheme(themeType, item.id)}</div>
                    <div class="mt-2 overflow-hidden"><div class="text-sm font-normal leading-tight block">${truncateText(item.title, 50)}</div></div>
                </div>`
            ).join('');

            const regularItemsHtml = data
                .filter(item => !stickyTitles.has(item.title)) // Don't show AI item if a sticky with same title exists
                .map(item => {
                    const compositeKey = `${cardTitle} - ${item.title}`;
                    const isViewed = viewedItemIds.has(compositeKey);
                    const isNew = newItemsIds.has(item.id);
                    
                    const viewedIndicatorHtml = isViewed ? `<div class="indicator viewed-indicator" title="Viewed"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></div>` : '';
                    const newClass = isNew ? 'new-item-highlight' : '';
                    
                    return `
                    <div id="grid-selector-${item.id}" class="grid-card-selector ${newClass}" data-theme-id="${item.id}" data-theme-type="${themeType}" title="${item.description || item.title}">
                        ${viewedIndicatorHtml}
                        <div class="icon">${getIconForTheme(themeType, item.id)}</div>
                        <div class="mt-2 overflow-hidden"><div class="text-sm font-normal leading-tight block">${truncateText(item.title, 50)}</div></div>
                    </div>`;
            }).join('');
            
            const topicInputId = `add-topic-input-${themeType}`;
            const addNewTopicHtml = `
                <div class="add-topic-container">
                    <input type="text" id="${topicInputId}" name="${topicInputId}" placeholder="Enter a New Topic..." class="themed-input w-full p-2 rounded-lg text-sm">
                    <button class="btn-secondary add-topic-button !px-4 !py-2" data-container-id="${containerId}" data-theme-type="${themeType}">Add Topic</button>
                </div>
            `;
            
            const fullPrompt = fullPrompts[themeType];
            let actionButtonsHtml = '';
            const card = container.closest('.card');
            const isFullyLoaded = card.dataset.isFullyLoaded === 'true';

            if (fullPrompt && data.length > 0) {
                if (isFullyLoaded) {
                    actionButtonsHtml = `<div class="col-span-full text-center mt-4"><button class="generate-more-button btn-secondary" data-container-id="${containerId}" data-theme-type="${themeType}" title="Use AI to generate more topics for this category"><span class="flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Generate 10 More</span></button></div>`;
                } else {
                     actionButtonsHtml = `<div class="col-span-full text-center mt-4"><button class="show-all-button btn-secondary" data-container-id="${containerId}" data-theme-type="${themeType}">Show All (${data.length} of ~50 shown)</button></div>`;
                }
            }
            container.innerHTML = `<div class="${gridClass}">${stickyHtml}${regularItemsHtml}</div>${addNewTopicHtml}<div class="mt-4">${actionButtonsHtml}</div>`;
        }
        
        async function handleAddNewTopic(button) {
            const { containerId, themeType } = button.dataset;
            const inputField = button.previousElementSibling;
            const newTitle = inputField.value.trim();

            if (!newTitle) {
                inputField.focus();
                return;
            }

            const newTopic = {
                title: newTitle,
                id: `${sanitizeTitle(newTitle).replace(/\s+/g, '-')}-${Date.now()}`,
                description: `Custom guide for: ${newTitle}` // Provide a default description
            };

            // Add to the main data store so it can be found later
            if (!allThemeData[themeType]) {
                allThemeData[themeType] = [];
            }
            allThemeData[themeType].push(newTopic);
            allThemeData[themeType].sort((a, b) => a.title.localeCompare(b.title));

            populateCardGridSelector(containerId, themeType, new Set([newTopic.id]));

            const newTopicElement = document.getElementById(`grid-selector-${newTopic.id}`);
            if (newTopicElement) {
                newTopicElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                await handleGridSelect(newTopicElement);
            }
        }


        async function handleGenerateMoreClick(button) {
            const { containerId, themeType } = button.dataset;
            const container = document.getElementById(containerId);
            if (!container || !themeType || !allThemeData[themeType]) return;

            button.disabled = true;
            button.innerHTML = `<span class="flex items-center justify-center gap-2"><div class="loader themed-loader" style="width:20px; height:20px; border-width: 2px;"></div>Generating...</span>`;

            const card = container.closest('.card');
            const categoryTitle = card.querySelector('h2').textContent;
            const existingTitles = allThemeData[themeType].map(item => item.title);
            
            const prompt = `Generate 10 new and unique administrative task ideas for the IT category "${categoryTitle}". These tasks must be different from the ones in the following list.
            
            Existing Task List:
            - ${existingTitles.join('\n- ')}

            For each new task, provide a unique "id", a "title", and a short "description". Return the response as a valid JSON array.`;

            try {
                const jsonText = await callGeminiAPI(prompt, true, "Generate More Topics");
                if (!jsonText) throw new Error("AI did not return any new items.");

                const newItems = parseJsonWithCorrections(jsonText);
                const newItemIds = new Set(newItems.map(item => item.id));
                
                newItems.forEach(newItem => {
                    if (!allThemeData[themeType].some(existing => existing.id === newItem.id || existing.title === newItem.title)) {
                        allThemeData[themeType].push(newItem);
                    }
                });
                
                allThemeData[themeType].sort((a, b) => a.title.localeCompare(b.title));
                populateCardGridSelector(containerId, themeType, newItemIds);
                document.getElementById(`${themeType}-details`).innerHTML = '';

            } catch (error) {
                console.error(`Error generating more items for ${themeType}:`, error);
                const originalButtonContent = `<span class="flex items-center justify-center gap-2">...</span>`;
                button.disabled = false;
                button.innerHTML = originalButtonContent.replace('...', 'Error. Try Again.');
                button.classList.add('bg-red-100', 'text-red-700');
                 setTimeout(() => {
                    button.classList.remove('bg-red-100', 'text-red-700');
                    button.innerHTML = originalButtonContent.replace('...', `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Generate 10 More`);
                }, 3000);
            } 
        }
        
        async function handleShowAllClick(button) {
            const { containerId, themeType } = button.dataset;
            const container = document.getElementById(containerId);
            const fullPrompt = fullPrompts[themeType];

            if (!container || !fullPrompt) return;

            button.disabled = true;
            button.innerHTML = `<span class="flex items-center justify-center gap-2"><div class="loader themed-loader" style="width:20px; height:20px; border-width: 2px;"></div>Loading all...</span>`;

            try {
                const jsonText = await callGeminiAPI(fullPrompt, true, "Show All Topics");
                if (!jsonText) throw new Error(`API returned empty content for ${themeType} (full list).`);
                
                const fullData = parseJsonWithCorrections(jsonText);
                fullData.sort((a, b) => a.title.localeCompare(b.title));
                allThemeData[themeType] = fullData;

                const card = container.closest('.card');
                card.dataset.isFullyLoaded = 'true';

                populateCardGridSelector(containerId, themeType);
                document.getElementById(`${themeType}-details`).innerHTML = '';
            } catch (error) {
                button.disabled = false;
                button.classList.add('bg-red-100', 'text-red-700');
                button.textContent = "Error. Try again.";
                console.error(`Error loading full list for ${themeType}:`, error);
            }
        }

        async function handleGridSelect(target) {
            const { themeId, themeType } = target.dataset;
            // Unified search for item data in both AI-generated and sticky topic lists
            let item = allThemeData[themeType]?.find(d => String(d.id) === String(themeId)) || 
                       stickyTopics[themeType]?.find(d => String(d.id) === String(themeId));
            
            if (!item) {
                console.error("Could not find theme item for:", {themeId, themeType});
                return;
            }
            
            const gridContainer = target.closest('.card-grid-container');
            if (gridContainer) {
                const currentlyActive = gridContainer.querySelector('.active');
                if (currentlyActive) currentlyActive.classList.remove('active');
                target.classList.add('active');
            }

            const card = target.closest('.card');
            const cardTitle = card.querySelector('h2').textContent;
            
            await markItemAsViewed(cardTitle, item.title);
            
            if (!target.querySelector('.viewed-indicator') && !target.querySelector('.sticky-indicator')) {
                const indicator = document.createElement('div');
                indicator.className = 'indicator viewed-indicator';
                indicator.title = 'Viewed';
                indicator.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
                target.prepend(indicator);
            }

            const prompt = `
                You are creating a summary for an IT administration guide.
                The overall category is: "${cardTitle}"
                The category description is: "${item.description || 'General task'}"
                The specific topic is: "${item.title}"

                Based on this context, generate a very brief, condensed summary for the guide on "${item.title}".
                For each section (Objective, Pre-requisites, Key Steps, Verification, Helpful Resources), provide a single descriptive sentence.
                Return the response as a simple markdown string where each section is a bullet point, starting with '*'.
            `;
            
            const resultContainer = document.getElementById(`${themeType}-details`);
            resultContainer.innerHTML = getLoaderHTML(`Generating summary for ${item.title}...`);

            try {
                let resultText = await callGeminiAPI(prompt, false, "Generate Topic Summary");
                resultText = resultText ? resultText.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : '';
                originalGeneratedText.set(themeId, resultText); 
                
                const resultHtml = marked.parse(resultText || '');
                resultContainer.innerHTML = `<div class="prose max-w-none">${resultHtml}</div>`;

                addPostGenerationButtons(resultContainer, themeId, themeType);
            } catch (error) {
                handleApiError(error, resultContainer, `guide for ${item.title}`);
            }
        }
        
        async function markItemAsViewed(cardTitle, buttonTitle) {
            if (!viewedItemsCollectionRef) return;

            const compositeKey = `${cardTitle} - ${buttonTitle}`;
            
            try {
                const docRef = doc(viewedItemsCollectionRef, compositeKey);
                await setDoc(docRef, { 
                    viewedAt: Timestamp.fromDate(new Date()) 
                });
            } catch (error) {
                console.error("Error marking item as viewed:", error);
            }
        }

        async function handleGeminiSubmit(e) {
            e.preventDefault();
            const promptInput = document.getElementById('gemini-prompt');
            const userPrompt = promptInput.value.trim();
            if (!userPrompt) return;

            const titleEl = document.getElementById('inDepthModalTitle');
            const contentEl = document.getElementById('inDepthModalContent');
            const footerEl = document.getElementById('inDepthModalFooter');
            const buttonContainer = document.getElementById('inDepthModalButtons');

            const fullTitle = `Custom Guide: ${userPrompt}`;
            titleEl.textContent = truncateText(fullTitle, 40);
            contentEl.innerHTML = getLoaderHTML(`Generating initial sections for your custom guide for "${userPrompt}"...`);
            buttonContainer.innerHTML = '';
            document.getElementById('modal-status-message').textContent = '';
            
            footerEl.dataset.fullTitle = fullTitle;
            footerEl.dataset.cardName = "Custom Task"; 
            
            openModal('inDepthModal');
            
            const selectedOptions = Array.from(document.querySelectorAll('#tailoring-buttons-container .btn-toggle.active'))
                                        .map(btn => btn.textContent.trim())
                                        .join(', ');

            const initialCustomPrompt = `You are an expert senior IT administrator and technical writer AI.
Your task is to generate ONLY the "Introduction", "Architectural Overview", "Key Concepts & Terminology", and "Prerequisites" sections for a comprehensive, in-depth IT administration guide for the following custom topic:
- **Topic:** "${userPrompt}"
- **Tailoring Options:** ${selectedOptions ? selectedOptions : 'None'}

Structure these sections logically using '###' markdown syntax for headers. The content must be detailed, accurate, and reflect real-world best practices.
Return only these sections in markdown format. Do not include any other sections.`;

            try {
                let initialResultText = await callGeminiAPI(initialCustomPrompt, false, "Generate Custom Guide (Initial)");
                initialResultText = initialResultText ? initialResultText.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : '';
                
                originalGeneratedText.set(fullTitle, initialResultText);
                
                contentEl.innerHTML = '';
                renderAccordionFromMarkdown(initialResultText, contentEl, false); 
                
                addModalActionButtons(buttonContainer, true);

            } catch(error) {
                handleApiError(error, contentEl, 'custom IT guide (initial sections)');
            } finally {
                promptInput.value = '';
            }
        }

        
        function parseJsonWithCorrections(jsonString) {
            if (!jsonString || typeof jsonString !== 'string') {
                throw new Error("Invalid input: not a string.");
            }
            let cleanedString = jsonString.replace(/```(json|markdown)?\n?/g, '').replace(/```/g, '').trim();
            
            try {
                return JSON.parse(cleanedString);
            } catch (error) {
                console.warn("Initial JSON.parse failed. Attempting correction for common errors.", error);
                
                try {
                    // This regex is a bit more robust for fixing unquoted keys.
                    const correctedJsonString = cleanedString
                        .replace(/\\'/g, "'") 
                        .replace(/([{\s,])(\w+)(:)/g, '$1"$2"$3');
                    return JSON.parse(correctedJsonString);
                } catch (finalError) {
                     console.error("Failed to parse JSON even after cleaning:", finalError);
                    console.error("Original string received from API:", jsonString);
                    console.error("String after cleaning attempts:", cleanedString);
                    throw new Error(`JSON Parse Error: ${finalError.message}. Check console for the problematic string.`);
                }
            }
        }
        
        // --- API CALL FUNCTIONS ---
        function logAiInteraction(prompt, response, type) {
            aiLog.push({
                timestamp: new Date(),
                type: type,
                prompt: prompt,
                response: response
            });
        }

        async function callApi(apiUrl, payload, authorization = null) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 90000);

            const headers = { 'Content-Type': 'application/json' };
            if (authorization) {
                headers['Authorization'] = authorization;
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    let errorBody;
                    try { errorBody = await response.json(); } catch { errorBody = await response.text(); }
                    console.error("API Error Response:", { status: response.status, body: errorBody });
                    const errorMsg = errorBody?.error?.message || response.statusText;
                    throw new Error(`API request failed with status ${response.status}. Message: ${errorMsg}`);
                }
                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') throw new Error('The AI service request timed out. Please try again.');
                throw error;
            }
        }

        async function callGeminiAPI(prompt, isJson = false, logType = "General") {
            if (!geminiApiKey) {
                throw new Error("Gemini API Key is not set. Please enter it in the initial modal.");
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            if (isJson) {
                payload.generationConfig = { responseMimeType: "application/json", maxOutputTokens: 8192 };
            }
            const result = await callApi(apiUrl, payload);
            const responseText = result?.candidates?.[0]?.content?.parts?.[0]?.text || null;
            logAiInteraction(prompt, responseText, logType); // Log the interaction
            return responseText;
        }

        async function callImageGenAPI(prompt) {
            const token = gapi.client.getToken();
            if (!token) {
                throw new Error("Please connect your Google Account to generate images.");
            }
            if (!firebaseConfig || !firebaseConfig.projectId) {
                throw new Error("Firebase project ID is not configured. Cannot make image generation request.");
            }

            const apiUrl = `https://us-central1-aiplatform.googleapis.com/v1/projects/${firebaseConfig.projectId}/locations/us-central1/publishers/google/models/imagegeneration@0.0.5:predict`;
            const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
            const authHeader = `Bearer ${token.access_token}`;

            const result = await callApi(apiUrl, payload, authHeader);
            const base64 = result?.predictions?.[0]?.bytesBase64Encoded;
            return base64 ? `data:image/png;base64,${base64}` : null;
        }
        
        async function callColorGenAPI(prompt) {
            const fullPrompt = `Based on the theme "${prompt}", generate a color palette. I need a JSON object with keys: "bg", "text", "primary", "primaryDark", "accent", "cardBg", "cardBorder", "textMuted", "inputBg", "inputBorder", "buttonText". Determine if the "primary" color is light or dark to set the "buttonText" appropriately (#FFFFFF for dark, #111827 for light). ${jsonInstruction}`;
            const jsonText = await callGeminiAPI(fullPrompt, true, "Generate Color Theme");
            if (jsonText) return parseJsonWithCorrections(jsonText);
            throw new Error("Could not parse a valid color theme from API response.");
        }

        function handleApiError(error, container, contentType = 'content') {
            console.error(`Error generating ${contentType}:`, error);
            const errorMessage = generateErrorMessage(error, contentType);
            if (container) {
                container.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">${errorMessage}</div>`;
            }
        }
        
        async function generateAndApplyDefaultTheme() {
            showThemeLoading(true);
            const themePrompt = "Modern Data Center";
            const imagePrompt = `Artistic, abstract background image inspired by "${themePrompt}". Suitable for an IT administration website. Professional, clean. Wide aspect ratio, photographic, cinematic lighting.`;
            try {
                const colors = await callColorGenAPI(themePrompt);
                applyTheme(colors);

                if (gapi.client.getToken()) {
                    const imageUrl = await callImageGenAPI(imagePrompt);
                    applyHeaderImage(imageUrl);
                } else {
                    console.warn("Skipping default header image generation: Google user not signed in.");
                }

            } catch (error) {
                handleApiError(null, null, 'default theme');
                console.error("Failed to generate default theme, continuing with default styles.", error);
            } finally {
                showThemeLoading(false);
            }
        }
        
        async function loadAITailoringOptions() {
            const container = document.getElementById('tailoring-buttons-container');
            container.innerHTML = getLoaderHTML('Loading AI options...');
            try {
                const prompt = `Generate a comprehensive list of 40-50 diverse keywords and concepts for tailoring IT administration guides. The list should cover a wide range of topics including security, performance, automation, specific technologies (like PowerShell, Ansible), methodologies (like IaC), and user levels (like 'for beginners', 'for experts'). Return ONLY a valid JSON array of strings. IMPORTANT: Ensure any double quotes inside the strings are properly escaped.`;
                const jsonText = await callGeminiAPI(prompt, true, "Load Tailoring Options");
                if (!jsonText) {
                    throw new Error("AI did not return any tailoring options.");
                }
                const options = parseJsonWithCorrections(jsonText);
                populateTailoringButtons(options);
            } catch (error) {
                handleApiError(error, container, 'tailoring options');
                const fallbackOptions = ["Security Hardening", "Performance Tuning", "Automation Script", "For Beginners"];
                populateTailoringButtons(fallbackOptions);
            }
        }


        function populateTailoringButtons(options) {
            const container = document.getElementById('tailoring-buttons-container');
            container.innerHTML = options.map(option =>
                `<button type="button" class="btn-toggle text-sm px-3 py-1 rounded-full">${option}</button>`
            ).join('');
        }
        
        async function loadDynamicPlaceholders() {
            const promptInput = document.getElementById('gemini-prompt');
            const prompt = `Generate a JSON array of 3 creative IT administration task ideas for input placeholders. Examples: "Onboard a new employee", "Decommission a legacy server". Return ONLY the valid JSON array of strings, ensuring any double quotes inside the strings are properly escaped (e.g., \\"like this\\").`;
            try {
                const jsonText = await callGeminiAPI(prompt, true, "Load Placeholders");
                if(!jsonText) return;
                const placeholders = parseJsonWithCorrections(jsonText);
                if (placeholders && placeholders.length > 0) {
                    let i = 0;
                    promptInput.placeholder = `e.g., '${placeholders[i]}'`;
                    setInterval(() => {
                        i = (i + 1) % placeholders.length;
                        promptInput.placeholder = `e.g., '${placeholders[i]}'`;
                    }, 3000);
                }
            } catch(error) {
                console.error("Could not load dynamic placeholders", error);
            }
        }

        function applyTheme(colors) {
            Object.entries(colors).forEach(([key, value]) => {
                const cssVar = `--color-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                root.style.setProperty(cssVar, value);
            });
        }
        
        function applyHeaderImage(imageUrl) {
            if (!imageUrl) return;
            const bgImageDiv = document.getElementById('header-bg-image');
            bgImageDiv.style.backgroundImage = `url('${imageUrl}')`;
        }

        function showThemeLoading(isLoading) {
            const loader = document.getElementById('header-loader');
            loader.classList.toggle('hidden', !isLoading);
            loader.classList.toggle('flex', isLoading);
        }
        
        function getAppPrompts() {
            const prompts = {};

            categoriesToGenerate.forEach(cat => {
                prompts[`${cat.title} (Initial Load)`] = cat.initialPrompt;
                prompts[`${cat.title} (Full Details)`] = cat.fullPrompt;
            });

            prompts["Generate Detailed Guide (Generic Task)"] = getEnhancedPrompt("{task}", "", "", { cardTitle: "{cardTitle}", cardDescription: "{cardDescription}" });
            prompts["Refine Existing Guide"] = getEnhancedPrompt("{refinement_request}", "", "{original_text}");
            prompts["Generate Summary for Topic"] = `Generate a very brief, condensed summary for an IT administration guide on the topic: "{item.title}". For each section (Objective, Pre-requisites, Key Steps, Verification, Helpful Resources), provide a single descriptive sentence. Return the response as a simple markdown string where each section is a bullet point, starting with '*'.`;
            prompts["Generate UI Screenshot"] = `UI Screenshot for an IT Administration guide showing: {description}. Clean, professional, minimal.`;
            prompts["Generate Color Theme"] = `Based on the theme "${prompt}", generate a color palette. I need a JSON object with keys: "bg", "text", "primary", "primaryDark", "accent", "cardBg", "cardBorder", "textMuted", "inputBg", "inputBorder", "buttonText". Determine if the "primary" color is light or dark to set the "buttonText" appropriately (#FFFFFF for dark, #111827 for light). ${jsonInstruction}`;
            prompts["Discover New Topic"] = `Generate 1 new, useful IT administration category NOT on this list: {existing_titles}. Provide a "key" (camelCase, unique), "title", "description", an "initialPrompt" (for 10 items), and a "fullPrompt" (for 40-50). The prompts you generate should instruct an AI to create a JSON array of objects, where each object has an "id", "title", and "description". ${jsonInstruction}`;
            
            return prompts;
        }
        
        function displayPromptsInModal() {
            const contentEl = document.getElementById('promptsModalContent');
            contentEl.innerHTML = ''; 

            const prompts = getAppPrompts();

            for (const [title, promptText] of Object.entries(prompts)) {
                const promptContainer = document.createElement('div');
                promptContainer.className = 'mb-6';
                
                const promptTitle = document.createElement('h3');
                promptTitle.className = 'text-lg font-semibold themed-text-accent mb-2';
                promptTitle.textContent = title;
                promptContainer.appendChild(promptTitle);

                const codeBlockContainer = document.createElement('div');
                codeBlockContainer.className = 'code-block-container !mt-0';
                
                const header = document.createElement('div');
                header.className = 'code-block-header';
                header.innerHTML = `<span>Prompt</span><button class="copy-code-button">Copy</button>`;
                codeBlockContainer.appendChild(header);

                const pre = document.createElement('pre');
                pre.className = 'text-sm';
                pre.style.color = 'var(--code-text)';
                pre.textContent = promptText;
                codeBlockContainer.appendChild(pre);
                
                promptContainer.appendChild(codeBlockContainer);
                contentEl.appendChild(promptContainer);
            }

            openModal('promptsModal');
        }

        function getEnhancedPrompt(task, options = '', originalText = '', context = {}) {
            const optionsText = options ? `With a special focus on these elements: ${options}.` : '';

            if (originalText) {
                // This is the prompt for refining existing text
                return `You are an expert senior IT administrator AI. A user has provided the following content and a request to refine it. Your task is to rewrite the entire text to incorporate the user's request.
**ORIGINAL TEXT:**
---
${originalText}
---
**USER'S REFINEMENT REQUEST:**
"${task}"

**Instructions for rewriting:**
1.  **Integrate:** Seamlessly integrate the user's request into the text.
2.  **Quality Standards:** The rewritten text must be clear, accurate, and practical.
3.  **Format:** Maintain the original markdown format unless the refinement request implies a structural change.
Return only the new, complete, and rewritten markdown text.`;
            }

            let contextText = `for the task: "${task}"`;
            if (context.cardTitle) {
                contextText = `for the following topic.
- **Category:** "${context.cardTitle}"
- **Topic Description:** "${context.cardDescription}"
- **Specific Task:** "${task}"`;
            }

            // REVISED PROMPT STRUCTURE
            return `You are an expert senior IT administrator and technical writer AI. Your task is to generate a comprehensive, in-depth, and practical guide ${contextText}. ${optionsText}

**CRITICAL FORMATTING INSTRUCTION:** You MUST format each of the main sections below (e.g., "1. Introduction", "2. Architectural Overview") with a '###' markdown header. For example: '### 1. Introduction'. This is required for the content to be displayed correctly.

**REQUIRED GUIDE STRUCTURE & CONTENT:**
### 1. Introduction
    * **Overview:** Briefly explain the technology or task.
    * **Importance:** Describe why this task/technology is important in modern IT environments.
    * **What You'll Learn:** Provide a bulleted list of key takeaways the user will gain from this guide.
### 2. Architectural Overview (If Applicable)
    * For complex topics, explain the high-level architecture. Describe the main components and how they interact. Use simple analogies if possible.
### 3. Key Concepts & Terminology
    * **List and Define:** List and clearly define the fundamental principles, terminology, and acronyms the user MUST understand to perform the main task.
### 4. Prerequisites
    * **Permissions:** Detail the specific administrative roles or granular permissions required.
    * **Software/Licensing:** List any necessary software, specific versions, and licensing requirements.
    * **System Requirements:** Specify any hardware or network prerequisites.
### 5. Key Concepts and Terminology - Explained
    * **Practical Application:** This is a critical section. For each item you listed in "Key Concepts & Terminology", provide a detailed practical guide on how to perform, configure, or manage it. 
    * **Detailed Instructions:** Use either GUI-based step-by-step instructions (describing exact clicks and navigation) or provide clear, descriptive "how-to" text for more conceptual items. Treat this as a collection of mini-guides that bring the concepts to life.
### 6. Verification and Validation
    * Provide specific commands or procedures to run to confirm the overall task was completed successfully.
    * Describe what a successful output or system state looks like.
### 7. Best Practices
    * Offer expert advice on the most effective, secure, and efficient ways to perform the task and manage the related concepts.
### 8. Automation Techniques for Key Concepts
    * **Concept-Specific Automation:** For each concept from 'Key Concepts & Terminology,' describe relevant automation opportunities.
    * **Scripting Examples:** Provide complete, practical script examples (e.g., PowerShell, PowerCLI, bash) or explain how to use APIs (like Microsoft Graph) to automate tasks related to that specific concept.
### 9. Security Considerations
    * **Hardening:** Provide specific steps to harden the configuration related to the main task and concepts.
    * **Common Vulnerabilities:** Discuss potential security risks.
    * **Auditing & Logging:** Recommend what to audit and how to configure logging.
### 10. Advanced Use Cases & Scenarios
    * Describe 2-3 advanced or less-common scenarios related to the topic.
### 11. Troubleshooting
    * Provide a table of common problems, their likely causes, and step-by-step solutions.
### 12. Helpful Resources
    * Include a final section with a bulleted list of high-quality, relevant links.

**MANDATORY QUALITY STANDARDS:**
${linkVerificationAndGenerationMandate}
${powershellStandard}
${powerCLIStandard}

Return only the complete markdown guide, ensuring each main section has a '###' header.`;
        }
        
        async function handleExploreInDepth(themeId, themeType, cardName) {
            const item = allThemeData[themeType]?.find(d => String(d.id) === String(themeId)) ||
                       stickyTopics[themeType]?.find(d => String(d.id) === String(themeId));

            if (!item) {
                console.error("Could not find item for in-depth view", { themeId, themeType });
                return;
            }

            const titleEl = document.getElementById('inDepthModalTitle');
            const contentEl = document.getElementById('inDepthModalContent');
            const footerEl = document.getElementById('inDepthModalFooter');
            const buttonContainer = document.getElementById('inDepthModalButtons');

            const fullTitle = `In-Depth: ${item.title}`;
            titleEl.textContent = fullTitle;
            contentEl.innerHTML = getLoaderHTML(`Generating foundational guide for ${item.title}...`);
            buttonContainer.innerHTML = '';
            document.getElementById('modal-status-message').textContent = '';

            footerEl.dataset.themeId = themeId;
            footerEl.dataset.themeType = themeType;
            footerEl.dataset.fullTitle = fullTitle;
            footerEl.dataset.cardName = cardName;

            openModal('inDepthModal');

            const context = { cardTitle: cardName, cardDescription: item.description };

            const initialPrompt = `You are an expert senior IT administrator and technical writer AI.
Your task is to generate ONLY the "Introduction", "Architectural Overview", "Key Concepts & Terminology", and "Prerequisites" sections for a comprehensive, in-depth IT administration guide for the following topic:
- **Category:** "${context.cardTitle}"
- **Topic Description:** "${context.cardDescription}"
- **Specific Task:** "${item.title}"
Structure these sections logically using '###' markdown syntax for headers. The content must be detailed, accurate, and reflect real-world best practices.
Return only these sections in markdown format. Do not include any other sections.`;

            try {
                let initialResultText = await callGeminiAPI(initialPrompt, false, "Explore In-Depth (Initial)");
                initialResultText = initialResultText ? initialResultText.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : '';

                originalGeneratedText.set(fullTitle, initialResultText);

                contentEl.innerHTML = '';
                renderAccordionFromMarkdown(initialResultText, contentEl, false);

                addModalActionButtons(buttonContainer, true); 

            } catch (error) {
                handleApiError(error, contentEl, 'initial in-depth content');
            }
        }
        
        async function generateFullDetailedGuide(button) {
            const firstModalFooter = document.getElementById('inDepthModalFooter');
            const fullTitleFromFirstModal = firstModalFooter.dataset.fullTitle;
            const cardName = firstModalFooter.dataset.cardName;
            const initialContentMarkdown = originalGeneratedText.get(fullTitleFromFirstModal); 

            if (!initialContentMarkdown) {
                console.error("No initial content found to generate detailed steps from.");
                handleApiError({ message: "Initial guide content missing. Cannot generate detailed instructions." }, document.getElementById('inDepthModalContent'), "detailed instructions");
                return;
            }
            
            button.disabled = true;
            button.innerHTML = `<span class="flex items-center justify-center gap-2"><div class="loader themed-loader" style="width:20px; height:20px; border-width: 2px;"></div>Opening...</span>`;

            const detailedTitleEl = document.getElementById('inDepthDetailedModalTitle');
            const detailedContentEl = document.getElementById('inDepthDetailedModalContent');
            const detailedFooterEl = document.getElementById('inDepthDetailedModalFooter');
            const detailedButtonContainer = document.getElementById('inDepthDetailedModalButtons');

            const detailedModalTitle = `Complete Guide: ${fullTitleFromFirstModal.replace(/In-Depth: |Custom Guide: /g, '')}`;
            detailedTitleEl.textContent = detailedModalTitle;
            detailedButtonContainer.innerHTML = '';
            
            detailedFooterEl.dataset.fullTitle = detailedModalTitle; 
            detailedFooterEl.dataset.cardName = cardName;
            
            openModal('inDepthDetailedModal');

            try {
                detailedContentEl.innerHTML = getLoaderHTML('Generating full guide...');
                const topicName = fullTitleFromFirstModal.replace(/In-Depth: |Custom Guide: /g, '');
                const fullGuidePrompt = getEnhancedPrompt(topicName, '', '', {cardTitle: cardName, cardDescription: 'A comprehensive guide.'});
                
                let finalCompleteGuideMarkdown = await callGeminiAPI(fullGuidePrompt, false, "Generate Full Guide");
                finalCompleteGuideMarkdown = finalCompleteGuideMarkdown ? finalCompleteGuideMarkdown.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : '';
                if (!finalCompleteGuideMarkdown) throw new Error("Failed to generate the full guide.");

                originalGeneratedText.set(detailedModalTitle, finalCompleteGuideMarkdown);

                detailedContentEl.innerHTML = '';
                renderAccordionFromMarkdown(finalCompleteGuideMarkdown, detailedContentEl, false);

                addDetailedModalActionButtons(detailedButtonContainer);
                document.getElementById('detailed-modal-status-message').textContent = 'Full guide generated successfully!';

            } catch (error) {
                handleApiError(error, detailedContentEl, 'full detailed guide');
            } finally {
                 button.disabled = false;
                 button.innerHTML = `Generate Full Detailed Guide`;
            }
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) {
                modal.classList.remove('hidden');
                document.body.classList.add('modal-open', `${modalId}-open`);
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) {
                modal.classList.add('hidden');
                document.body.classList.remove(`${modalId}-open`);
                // If this was the last modal, remove the generic class
                if (document.querySelectorAll('.modal:not(.hidden)').length === 0) {
                     document.body.classList.remove('modal-open');
                }
            }
        }

        function addModalActionButtons(buttonContainer, isInitialPhase = false) {
            buttonContainer.innerHTML = '';

            const saveDriveBtnHtml = gapi.client.getToken() !== null ?
                `<button id="save-to-drive-btn" class="btn-secondary">Save to Google Drive</button>` : '';

            if (isInitialPhase) {
                buttonContainer.innerHTML = `
                    <button class="btn-secondary text-sm modal-refine-button">Refine with AI</button>
                    <button class="btn-secondary text-sm copy-button">Copy Text</button>
                    <button id="generate-detailed-steps-btn" class="btn-primary text-sm px-4 py-2" title="Generate a full, detailed guide in a new modal">Generate Full Detailed Guide</button>
                    ${saveDriveBtnHtml}
                `;
            } else {
                buttonContainer.innerHTML = `
                    <button class="btn-secondary text-sm modal-refine-button">Refine with AI</button>
                    <button class="btn-secondary text-sm copy-button">Copy Text</button>
                    ${saveDriveBtnHtml}
                `;
            }

            const copyButton = buttonContainer.querySelector('.copy-button');
            if (copyButton) {
                copyButton.addEventListener('click', e => {
                    const contentToCopy = e.target.closest('.card').querySelector('[id$="ModalContent"]');
                    copyElementTextToClipboard(contentToCopy, e.target);
                });
            }
        }

        function addDetailedModalActionButtons(buttonContainer) {
            const saveDriveBtnHtml = gapi.client.getToken() !== null ?
                `<button id="save-to-drive-btn" class="btn-secondary">Save to Google Drive</button>` : '';
            
            buttonContainer.innerHTML = `
                <button class="btn-secondary text-sm modal-refine-button">Refine with AI</button>
                <button class="btn-secondary text-sm copy-button">Copy Text</button>
                ${saveDriveBtnHtml}
            `;
            
            const copyButton = buttonContainer.querySelector('.copy-button');
            if (copyButton) {
                copyButton.addEventListener('click', e => {
                    const contentToCopy = e.target.closest('.card').querySelector('[id$="ModalContent"]');
                    copyElementTextToClipboard(contentToCopy, e.target);
                });
            }
        }
        
        function addSearchModalActionButtons(buttonContainer) {
             const saveDriveBtnHtml = gapi.client.getToken() !== null ? `<button id="save-to-drive-btn" class="btn-secondary">Save to Google Drive</button>` : '';
             buttonContainer.innerHTML = `
                <button class="btn-secondary text-sm modal-refine-button">Refine with AI</button>
                <button class="btn-secondary text-sm copy-button">Copy Text</button>
                ${saveDriveBtnHtml}
            `;
             const copyButton = buttonContainer.querySelector('.copy-button');
            if (copyButton) {
                copyButton.addEventListener('click', e => {
                    const contentToCopy = document.getElementById('searchGeminiResult');
                    copyElementTextToClipboard(contentToCopy, e.target);
                });
            }
        }
        
        function handleTextSelection(e) {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            const searchButton = document.getElementById('search-gemini-button');

            // Don't show button for selections in input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                searchButton.classList.add('hidden');
                return;
            }
            
            const isInsideModal = e.target.closest('#inDepthModalContent, #inDepthDetailedModalContent, #promptsModalContent');

            if (selectedText && isInsideModal) {
                searchButton.classList.remove('hidden');
            } else {
                 searchButton.classList.add('hidden');
            }
        }

        async function handleSearchGemini() {
            const searchButton = document.getElementById('search-gemini-button');
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            if (!selectedText) return;

            searchButton.classList.add('hidden');

            const searchTextEl = document.getElementById('searchGeminiQueryText');
            const resultEl = document.getElementById('searchGeminiResult');
            
            searchTextEl.value = selectedText; 
            resultEl.innerHTML = getLoaderHTML(`Searching Gemini for an explanation of "${selectedText}"...`);
            
            addSearchModalActionButtons(document.getElementById('searchGeminiModalButtons'));
            
            openModal('searchGeminiModal');
            
            const prompt = `In the context of IT administration, please explain the following term or concept clearly and concisely: "${selectedText}". Provide a simple definition and a practical example of how it's used. Format the response as a simple markdown string.`;

            try {
                let resultText = await callGeminiAPI(prompt, false, "Text Selection Search");
                resultText = resultText ? resultText.replace(/```(markdown|json)?\n?|```/g, '').trim() : '';
                
                originalGeneratedText.set("currentSearch", resultText); // Store for refinement
                
                resultEl.innerHTML = marked.parse(resultText || 'No explanation found.');
            } catch (error) {
                handleApiError(error, resultEl, 'Gemini search');
            }
        }


        function convertMarkdownToHtml(text, generateImages = true) {
            if (!text) return '<p class="themed-text-muted">No content received from AI. Please try a different prompt.</p>';

            let processedText;
            if (generateImages) {
                processedText = text.replace(/\[Screenshot: (.*?)\]/g, (match, description) => {
                    const placeholderId = `image-placeholder-${Date.now()}-${Math.random()}`;
                    return `<div id="${placeholderId}" class="image-generation-container" data-prompt="${description.replace(/"/g, '&quot;')}">
                                <div class="loader themed-loader"></div>
                                <p class="mt-2 text-sm italic">${description}</p>
                            </div>`;
                });
            } else {
                processedText = text.replace(/\[Screenshot: (.*?)\]/g, '');
            }


            let html = marked.parse(processedText);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            tempDiv.querySelectorAll('pre').forEach(preBlock => {
                if (preBlock.parentElement.classList.contains('code-block-container')) return;

                const codeBlock = preBlock.querySelector('code');
                const lang = codeBlock ? (Array.from(codeBlock.classList).find(c => c.startsWith('language-'))?.replace('language-', '') || 'text') : 'text';
                
                const container = document.createElement('div');
                container.className = 'code-block-container';
                
                const header = document.createElement('div');
                header.className = 'code-block-header';
                header.innerHTML = `
                    <span>${lang}</span>
                    <button class="copy-code-button">Copy</button>
                `;

                container.appendChild(header);
                preBlock.parentNode.insertBefore(container, preBlock);
                container.appendChild(preBlock);
            });

            return tempDiv.innerHTML;
        }

        async function generateAndInjectImages(container) {
            const placeholders = container.querySelectorAll('.image-generation-container');
            if (placeholders.length === 0) return;
            
            if (!gapi.client.getToken()) {
                placeholders.forEach(placeholder => {
                    placeholder.innerHTML = `<p class="text-sm themed-text-muted">Connect Google Account to generate images.</p>`;
                });
                return;
            }

            placeholders.forEach(async (placeholder) => {
                const prompt = placeholder.dataset.prompt;
                const imagePrompt = `UI Screenshot for an IT Administration guide showing: ${prompt}. Clean, professional, minimal.`;
                try {
                    const imageUrl = await callImageGenAPI(imagePrompt);
                    if (imageUrl) {
                        placeholder.innerHTML = `<img src="${imageUrl}" alt="${prompt}">`;
                    } else {
                        throw new Error('API returned no image.');
                    }
                } catch (error) {
                    console.error(`Failed to generate image for prompt: "${prompt}"`, error);
                    placeholder.innerHTML = `<p class="text-red-500 text-sm">Image generation failed.</p><p class="text-xs">${prompt}</p>`;
                }
            });
        }


        function addPostGenerationButtons(container, themeId, themeType) {
            let buttonBar = container.querySelector('.button-bar');
            if (buttonBar) buttonBar.remove();

            buttonBar = document.createElement('div');
            buttonBar.className = 'button-bar flex flex-wrap gap-2 mt-4 pt-4 border-t';
            buttonBar.style.borderColor = 'var(--color-card-border)';
            buttonBar.innerHTML = `
                <button class="btn-secondary text-sm refine-button">Refine with AI</button>
                <button class="btn-secondary text-sm copy-button">Copy Text</button>
                <button class="btn-secondary text-sm explore-button" data-theme-id="${themeId}" data-theme-type="${themeType}">Explore In-Depth</button>
            `;
            container.appendChild(buttonBar);
            buttonBar.querySelector('.copy-button').addEventListener('click', e => {
                const contentToCopy = e.target.closest('.details-container, #gemini-result-container');
                if(contentToCopy) copyElementTextToClipboard(contentToCopy, e.target);
            });
        }
        
        async function handleDiscoverMoreClick() {
            const button = document.getElementById('discover-more-button');
            const errorP = document.getElementById('discover-more-error');
            errorP.textContent = '';
            button.disabled = true;

            const existingTitles = Array.from(document.querySelectorAll('#main-grid h2')).map(h2 => h2.textContent.trim()).filter(Boolean);
            const titlesString = existingTitles.length > 0 ? `[${existingTitles.map(t => `"${t}"`).join(', ')}]` : 'the default ones';
            
            const prompt = `Generate 1 new, useful IT administration category that is NOT in the following list: ${titlesString}.
Return your response as a single, valid JSON object with the following keys: "key" (camelCase, unique), "title", "description", an "initialPrompt" (for 10 items), and a "fullPrompt" (for 40-50).
The prompts you generate should instruct an AI to create a JSON array of objects, where each object has an "id", "title", and "description".
${jsonInstruction}`;

            try {
                const jsonText = await callGeminiAPI(prompt, true, "Discover More Topics");
                if (!jsonText) throw new Error("AI did not return a new category.");
                const newCategory = parseJsonWithCorrections(jsonText);
                categoriesToGenerate.push(newCategory);
                categoriesToGenerate.sort((a,b) => a.title.localeCompare(b.title));
                await generateAndPopulateAICategory(newCategory);
                await generateTopicsMenu();
            } catch (error) {
                console.error("Failed to discover more topics:", error);
                errorP.textContent = "Sorry, couldn't generate a new topic right now. Please try again.";
                 handleApiError(error, null, "discover more");
            } finally {
                button.disabled = false;
            }
        }
        
        async function handleCustomVisualThemeGeneration() {
            const prompt = document.getElementById('theme-prompt').value;
            if(!prompt) return;

            const loader = document.getElementById('theme-loader-container');
            const errorContainer = document.getElementById('theme-error-container');
            const generateBtn = document.getElementById('generate-theme-btn');
            
            loader.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            generateBtn.disabled = true;

            try {
                const imagePrompt = `Artistic, abstract background image inspired by "${prompt}". Suitable for an IT administration website. Professional, clean. Wide aspect ratio, photographic, cinematic lighting.`;
                
                const promises = [callColorGenAPI(prompt)];
                if (gapi.client.getToken()) {
                    promises.push(callImageGenAPI(imagePrompt));
                } else {
                    showThemeError("Connect your Google Account to generate a new header image.");
                }

                const [colorResult, imageResult] = await Promise.allSettled(promises);
                
                if (colorResult.status === 'fulfilled' && colorResult.value) {
                    applyTheme(colorResult.value);
                } else {
                    throw colorResult.reason || new Error("Failed to generate color theme.");
                }

                if (imageResult && imageResult.status === 'fulfilled' && imageResult.value) {
                    applyHeaderImage(imageResult.value);
                } else if (imageResult) {
                    showThemeError("Failed to generate header image, but colors were updated.");
                }
                
                closeModal('themeGeneratorModal');
            } catch (error) {
                showThemeError(error.message);
            } finally {
                loader.classList.add('hidden');
                generateBtn.disabled = false;
            }
        }
        
        function showThemeError(message) {
            const errorContainer = document.getElementById('theme-error-container');
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        async function generateTopicsMenu() {
            const menuContainer = document.getElementById('topics-menu-container');
            const menuItemsContainer = document.getElementById('topics-menu-items').querySelector('div');
            const cards = Array.from(document.querySelectorAll('#main-grid .card'));
            
            if (cards.length <= 1) {
                menuContainer.classList.add('hidden');
                return;
            }

            const cardData = cards.map(card => ({
                id: card.id,
                title: card.querySelector('h2')?.textContent
            })).filter(c => c.id && c.title).sort((a,b) => a.title.localeCompare(b.title));
            
            if (cardData.length === 0) {
                 menuContainer.classList.add('hidden');
                return;
            }
            
            menuItemsContainer.innerHTML = ''; // Clear previous items

            const menuHtml = cardData.map(card => {
                return `<a href="#" class="topics-menu-item" role="menuitem" data-target-id="${card.id}">${card.title}</a>`;
            }).join('');

            menuItemsContainer.innerHTML = menuHtml;
            menuContainer.classList.remove('hidden');
        }

        function populateTypographySettings() {
            const fontSelect = document.getElementById('font-family-select');
            const sizeSelect = document.getElementById('font-size-select');
            const lineHeightSelect = document.getElementById('line-height-select');
            
            const fonts = { 'Default (Inter)': "'Inter', sans-serif", 'Lato': "'Lato', sans-serif", 'Montserrat': "'Montserrat', sans-serif", 'Nunito Sans': "'Nunito Sans', sans-serif", 'Open Sans': "'Open Sans', sans-serif", 'Poppins': "'Poppins', sans-serif", 'Roboto Slab': "'Roboto Slab', serif" };
            const sizes = { '14': '14px', '15': '15px', '16 (Default)': '16px', '17': '17px', '18': '18px' };
            const lineHeights = { '1.4': '1.4', '1.5 (Default)': '1.5', '1.6': '1.6', '1.7': '1.7', '1.8': '1.8' };

            Object.entries(fonts).forEach(([name, value]) => fontSelect.add(new Option(name, value)));
            Object.entries(sizes).forEach(([name, value]) => sizeSelect.add(new Option(name, value)));
            Object.entries(lineHeights).forEach(([name, value]) => lineHeightSelect.add(new Option(name, value)));

            fontSelect.value = fonts['Default (Inter)'];
            sizeSelect.value = '16px';
            lineHeightSelect.value = '1.5';
            
            root.style.setProperty('--font-family', fontSelect.value);
            root.style.setProperty('--font-size-base', sizeSelect.value);
            root.style.setProperty('--line-height-base', lineHeightSelect.value);
        }

        function copyElementTextToClipboard(element, button) {
            const textToCopy = element.innerText;
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed'; 
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => { button.textContent = originalText; }, 2000);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textarea);
        }

        function renderAccordionFromMarkdown(markdownText, containerElement, generateImages = true) {
            containerElement.innerHTML = ''; 
            if (!markdownText || !markdownText.trim()) {
                containerElement.innerHTML = convertMarkdownToHtml(null, false);
                return;
            }

            const fullHtml = convertMarkdownToHtml(markdownText, generateImages);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = fullHtml;

            const nodes = Array.from(tempDiv.childNodes);
            let currentAccordionItem = null;
            let introContent = document.createElement('div');
            introContent.className = 'accordion-intro mb-4 prose max-w-none';

            let firstHeaderFound = false;

            nodes.forEach(node => {
                if (!firstHeaderFound && node.tagName !== 'H3') {
                    introContent.appendChild(node.cloneNode(true));
                    return;
                }
                
                if (node.tagName === 'H3') {
                    firstHeaderFound = true;
                    if (introContent.hasChildNodes()) {
                        containerElement.appendChild(introContent);
                        introContent = document.createElement('div'); 
                        introContent.className = 'accordion-intro mb-4 prose max-w-none';
                    }

                    currentAccordionItem = document.createElement('div');
                    currentAccordionItem.className = 'accordion-item';

                    const title = node.textContent;
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'accordion-content prose max-w-none';

                    currentAccordionItem.innerHTML = `
                        <button type="button" class="accordion-header">
                            <span class="text-left">${title}</span>
                            <svg class="icon w-5 h-5 transition-transform shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    `;
                    currentAccordionItem.appendChild(contentDiv);
                    containerElement.appendChild(currentAccordionItem);
                } else if (currentAccordionItem) {
                    const contentDiv = currentAccordionItem.querySelector('.accordion-content');
                    contentDiv.appendChild(node.cloneNode(true));
                }
            });
            
            if (!firstHeaderFound && introContent.hasChildNodes()) {
                 containerElement.appendChild(introContent);
                 return;
            }


            if (introContent.hasChildNodes()) {
                containerElement.appendChild(introContent);
            }

            const firstItem = containerElement.querySelector('.accordion-item');
            if (firstItem) {
                const header = firstItem.querySelector('.accordion-header');
                header.classList.add('active');
                header.querySelector('.icon').style.transform = 'rotate(180deg)';
                firstItem.querySelector('.accordion-content').classList.add('open');
            }
        }
        
        async function handleAIHelpRequest() {
            document.getElementById('inDepthModalTitle').textContent = "AI Help & Feedback";
            const contentEl = document.getElementById('inDepthModalContent');
            contentEl.innerHTML = getLoaderHTML('Generating help guide and AI feedback...');
            document.getElementById('inDepthModalButtons').innerHTML = '';
            document.getElementById('modal-status-message').innerHTML = '';
            openModal('inDepthModal');

            const helpPrompt = `Generate a user-friendly help guide for this "IT Administration Hub" application. Explain the key features in separate sections using '###' for each title: Main Dashboard, Generative AI Prompt, Cloud Storage, In-Depth Guides, AI Theme Generator, and Floating Action Buttons.`;
            const feedbackPrompt = `You are an AI expert in user experience (UX) and IT administration tools. You are reviewing this "IT Administration Hub" application. Based on the features, provide constructive feedback on what is intuitive, what could be improved, and what features might be missing for a senior IT administrator. Format your feedback using '###' for titles "Strengths", "Areas for Improvement", and "Suggested Features".`;
            
            try {
                const [helpResult, feedbackResult] = await Promise.all([
                    callGeminiAPI(helpPrompt, false, "Generate Help Guide"), 
                    callGeminiAPI(feedbackPrompt, false, "Generate AI Feedback")
                ]);

                const helpText = helpResult ? marked.parse(helpResult.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim()) : '<p class="themed-text-muted">Could not load help content.</p>';
                const feedbackText = feedbackResult ? marked.parse(feedbackResult.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim()) : '<p class="themed-text-muted">Could not load feedback.</p>';
                
                contentEl.innerHTML = `
                    <div class="accordion-item"><button type="button" class="accordion-header active"><span class="text-left font-semibold">Application Help Guide</span><svg class="icon w-5 h-5 transition-transform shrink-0" style="transform: rotate(180deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div class="accordion-content open prose max-w-none">${helpText}</div></div>
                    <div class="accordion-item"><button type="button" class="accordion-header"><span class="text-left font-semibold">AI-Generated Feedback</span><svg class="icon w-5 h-5 transition-transform shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div class="accordion-content prose max-w-none">${feedbackText}</div></div>
                `;
            } catch (error) {
                handleApiError(error, contentEl, 'AI help content');
            }
        }
        
        function toggleRefineUI(buttonContainer, isModal = false, targetModalId = 'inDepthModal') {
            const refineContainerId = `refine-container-${targetModalId}`;
            let refineContainer = document.getElementById(refineContainerId);

            if (refineContainer) {
                refineContainer.remove();
                return;
            }

            refineContainer = document.createElement('div');
            refineContainer.id = refineContainerId;
            refineContainer.className = 'refine-container w-full';
            
            const textareaId = `refine-textarea-${targetModalId}`;
            refineContainer.innerHTML = `<textarea id="${textareaId}" name="${textareaId}" class="w-full p-2 themed-input border rounded-lg" rows="2" placeholder="e.g., 'Make it for a junior admin' or 'Add PowerShell examples'"></textarea><button class="btn-primary text-sm mt-2 submit-refinement-button" data-is-modal="${isModal}" data-target-modal-id="${targetModalId}">Submit Refinement</button>`;
            buttonContainer.insertAdjacentElement('afterend', refineContainer);
            refineContainer.querySelector('textarea').focus();
        }

        async function handleRefineRequest(refineContainer, targetModalId) {
            const refinementRequest = refineContainer.querySelector('textarea').value;
            if (!refinementRequest) return;

            let contentArea, titleElement, isSearchModal, textKey;
            
            isSearchModal = (targetModalId === 'searchGeminiModal');
            contentArea = document.getElementById(`${targetModalId}Content`);
            
            if (isSearchModal) {
                 textKey = "currentSearch";
            } else {
                 titleElement = document.getElementById(`${targetModalId}Title`);
                 textKey = titleElement.textContent;
            }
            
            const originalText = originalGeneratedText.get(textKey);

            if (!originalText) {
                handleApiError({message: "Could not find the original text to refine."}, contentArea, "refinement");
                return;
            }
            
            const renderTarget = isSearchModal ? document.getElementById('searchGeminiResult') : contentArea;
            renderTarget.innerHTML = getLoaderHTML(`Refining content based on your request...`);
            
            const prompt = getEnhancedPrompt(refinementRequest, '', originalText);
            
            try {
                let newText = await callGeminiAPI(prompt, false, "Refine Content");
                newText = newText ? newText.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : '';
                
                originalGeneratedText.set(textKey, newText);
                
                if (isSearchModal) {
                    renderTarget.innerHTML = marked.parse(newText || '');
                } else {
                    renderTarget.innerHTML = '';
                    renderAccordionFromMarkdown(newText, renderTarget, false);
                }
                
            } catch(error) {
                handleApiError(error, renderTarget, 'refinement');
            }
        }
        
        function getIconForTheme(themeType, themeId) { 
            const icons = {
                serviceNowAdmin: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`,
                windowsServer: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>`,
                m365Admin: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path></svg>`,
                default: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`
            }
            return icons[themeType] || icons.default;
        }
        
        function getLoaderHTML(message) { return `<div class="flex justify-center items-center my-4"><div class="loader themed-loader"></div><p class="ml-4 themed-text-muted">${message}</p></div>`; }

        function sanitizeTitle(title) {
            if (typeof title !== 'string') return '';
            return title.replace(/^["*-\s]+|["*-\s]+$/g, '').trim();
        }
        
        function truncateText(text, maxLength = 50) {
            if (typeof text !== 'string' || text.length <= maxLength) {
                return text;
            }
            return text.substring(0, maxLength) + '...';
        }

        function generateErrorMessage(error, type = 'general') { 
            console.error(`Error during ${type} generation:`, error);
            const baseErrorMessage = error && error.message ? error.message : "An unknown error occurred";
            let message = `An unknown error occurred. ${baseErrorMessage}`; 
            const errText = baseErrorMessage.toLowerCase(); 
            if (errText.includes('safety') || errText.includes('blocked')) {
                message = `Request blocked for safety reasons. Please try a different prompt.`;
            } else if (errText.includes('api key not valid')) {
                message = `Authentication failed. Your API Key is not valid. Please re-enter it.`;
            } else if (errText.includes('429')) {
                message = `Request limit exceeded. Please try again later.`;
            } else if (errText.includes('timed out')) {
                message = `The request timed out. Please check your connection and try again.`;
            } else if (errText.includes('google account to generate images')) {
                message = `Image generation requires you to connect your Google Account. Please use the 'Connect' button in the Cloud Storage card.`
            }
            return `Sorry, a critical error occurred: ${message}`; 
        }

        // --- Sticky Topics Functions ---
        function openStickyTopicsModal() {
            const select = document.getElementById('sticky-topic-category-select');
            select.innerHTML = '<option value="">Select a category...</option>'; // Clear and add placeholder
            
            const sortedCategories = [...categoriesToGenerate].sort((a,b) => a.title.localeCompare(b.title));

            sortedCategories.forEach(cat => {
                select.add(new Option(cat.title, cat.key));
            });

            document.getElementById('sticky-topics-list').innerHTML = '';
            document.getElementById('new-sticky-topic-input').value = '';

            openModal('stickyTopicsModal');
        }

        function listenForStickyTopics(categoryKey) {
            if (stickyTopicsUnsubscribe) {
                stickyTopicsUnsubscribe();
            }
            if (!userId || !categoryKey) {
                 if(stickyTopics[categoryKey]) {
                    stickyTopics[categoryKey] = [];
                 }
                 renderStickyTopics(categoryKey);
                 return;
            }
            
            const appId = firebaseConfig.appId || 'it-admin-hub-global';
            const stickyTopicsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/stickyTopics/${categoryKey}/topics`);
            
            stickyTopicsUnsubscribe = onSnapshot(stickyTopicsCollectionRef, (snapshot) => {
                const topics = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                stickyTopics[categoryKey] = topics;
                renderStickyTopics(categoryKey);
                // Also refresh the main card grid if it's visible
                const gridContainer = document.getElementById(`${categoryKey}-selector-visual`);
                if (gridContainer) {
                    populateCardGridSelector(`${categoryKey}-selector-visual`, categoryKey);
                }
            }, (error) => {
                console.error(`Error listening to sticky topics for ${categoryKey}:`, error);
            });
        }

        function renderStickyTopics(categoryKey) {
            const listEl = document.getElementById('sticky-topics-list');
            const topics = stickyTopics[categoryKey] || [];
            if(topics.length === 0) {
                listEl.innerHTML = `<p class="text-sm themed-text-muted text-center">No sticky topics for this category yet.</p>`;
                return;
            }
            listEl.innerHTML = topics.map(topic => `
                <div class="flex items-center gap-2 p-2 rounded-lg bg-gray-50">
                    <input type="text" value="${topic.title}" class="themed-input w-full p-1 rounded text-sm sticky-topic-title-input" data-doc-id="${topic.id}">
                    <button class="p-1 text-green-600 hover:text-green-800 update-sticky-topic-btn" title="Save Changes">&#10004;</button>
                    <button class="p-1 text-red-600 hover:text-red-800 delete-sticky-topic-btn" title="Delete Topic">&times;</button>
                </div>
            `).join('');

            listEl.querySelectorAll('.update-sticky-topic-btn').forEach(btn => btn.onclick = (e) => handleUpdateStickyTopic(e));
            listEl.querySelectorAll('.delete-sticky-topic-btn').forEach(btn => btn.onclick = (e) => handleDeleteStickyTopic(e));
        }

        async function handleAddStickyTopic() {
            const categoryKey = document.getElementById('sticky-topic-category-select').value;
            const input = document.getElementById('new-sticky-topic-input');
            const title = input.value.trim();

            if (!categoryKey || !title || !userId) {
                alert("Please select a category and enter a title.");
                return;
            }
            const appId = firebaseConfig.appId || 'it-admin-hub-global';
            const stickyTopicsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/stickyTopics/${categoryKey}/topics`);
            
            try {
                // Add a default description for new sticky topics
                await addDoc(stickyTopicsCollectionRef, { 
                    title: title, 
                    description: `Custom sticky topic: ${title}`,
                    createdAt: Timestamp.now() 
                });
                input.value = '';
            } catch(error) {
                console.error("Error adding sticky topic:", error);
            }
        }

        async function handleUpdateStickyTopic(e) {
            const categoryKey = document.getElementById('sticky-topic-category-select').value;
            const input = e.target.previousElementSibling;
            const docId = input.dataset.docId;
            const newTitle = input.value.trim();

            if (!categoryKey || !docId || !newTitle || !userId) return;

            const appId = firebaseConfig.appId || 'it-admin-hub-global';
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/stickyTopics/${categoryKey}/topics`, docId);
            try {
                await updateDoc(docRef, { title: newTitle });
                e.target.textContent = '‚úì';
                setTimeout(() => e.target.innerHTML = '&#10004;', 2000);
            } catch (error) {
                console.error("Error updating sticky topic:", error);
            }
        }

        async function handleDeleteStickyTopic(e) {
            const categoryKey = document.getElementById('sticky-topic-category-select').value;
            const docId = e.target.previousElementSibling.previousElementSibling.dataset.docId;

            if (!categoryKey || !docId || !userId) return;
            
            if (confirm("Are you sure you want to delete this sticky topic?")) {
                const appId = firebaseConfig.appId || 'it-admin-hub-global';
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/stickyTopics/${categoryKey}/topics`, docId);
                try {
                    await deleteDoc(docRef);
                } catch (error) {
                    console.error("Error deleting sticky topic:", error);
                }
            }
        }

        // --- NEW: AI Log Functions ---
        function displayAiLog() {
            const contentEl = document.getElementById('aiLogModalContent');
            contentEl.innerHTML = ''; // Clear previous logs
            
            if (aiLog.length === 0) {
                contentEl.innerHTML = `<p class="themed-text-muted text-center">No AI interactions have been logged yet.</p>`;
                openModal('aiLogModal');
                return;
            }

            // Reverse the log to show the most recent first
            const reversedLog = [...aiLog].reverse();

            reversedLog.forEach((log, index) => {
                const logItem = document.createElement('div');
                logItem.className = 'accordion-item';

                const promptBlockId = `prompt-block-${index}`;
                const responseBlockId = `response-block-${index}`;

                logItem.innerHTML = `
                    <button type="button" class="accordion-header">
                        <span class="text-left font-semibold">${log.timestamp.toLocaleTimeString()} - ${log.type}</span>
                        <svg class="icon w-5 h-5 transition-transform shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="accordion-content">
                        <div class="mb-4">
                            <h4 class="font-semibold themed-text-accent mb-2">Prompt:</h4>
                            <div id="${promptBlockId}" class="code-block-container !mt-0">
                                <div class="code-block-header"><span>Prompt</span><button class="copy-code-button">Copy</button></div>
                                <pre class="text-sm">${log.prompt}</pre>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold themed-text-accent mb-2">Response:</h4>
                             <div id="${responseBlockId}" class="code-block-container !mt-0">
                                <div class="code-block-header"><span>Response</span><button class="copy-code-button">Copy</button></div>
                                <pre class="text-sm">${log.response || "No response text received."}</pre>
                            </div>
                        </div>
                    </div>
                `;
                contentEl.appendChild(logItem);
            });

            openModal('aiLogModal');
        }

    </script>
</body>
</html>
