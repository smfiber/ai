<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Administration Hub</title>
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Nunito+Sans:wght@400;700&family=Open+Sans:wght@400;700&family=Poppins:wght@400;500;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* * ==============================================
         * CSS Custom Properties for Theming & Typography
         * ==============================================
        */
        :root {
            --color-bg: #f3e8ff; [cite_start]/* [cite: 2] */
            --color-text: #374151; [cite_start]/* [cite: 3] */
            --color-text-muted: #6b7280; [cite_start]/* [cite: 3] */
            --color-primary: #9333ea; [cite_start]/* [cite: 3] */
            --color-primary-dark: #7e22ce; [cite_start]/* [cite: 3] */
            --color-accent: #581c87; [cite_start]/* [cite: 3] */
            --color-card-bg: rgba(255, 255, 255, 0.9); [cite_start]/* [cite: 3] */
            --color-card-border: #e9d5ff; [cite_start]/* [cite: 3] */
            --color-input-bg: #f9fafb; [cite_start]/* [cite: 3] */
            --color-input-border: #d1d5db; [cite_start]/* [cite: 4] */
            --color-button-text: #ffffff; [cite_start]/* [cite: 4] */
            --code-bg: #282c34; [cite_start]/* [cite: 4] */
            --code-text: #abb2bf; [cite_start]/* [cite: 4] */
        }

        /* Applying the theme variables */
        html { scroll-behavior: smooth; [cite_start]/* [cite: 4] */ }
        body {
            font-family: var(--font-family, 'Inter', sans-serif); [cite_start]/* [cite: 5] */
            background-color: var(--color-bg); [cite_start]/* [cite: 6] */
            color: var(--color-text); [cite_start]/* [cite: 6] */
            font-size: var(--font-size-base, '16px'); [cite_start]/* [cite: 6] */
            line-height: var(--line-height-base, 1.5); [cite_start]/* [cite: 6] */
            transition: background-color 0.5s ease, color 0.5s ease; [cite_start]/* [cite: 6] */
        }
        
        /* General Prose styling for AI-generated content */
        .prose { font-size: inherit; [cite_start]/* [cite: 7] */ line-height: 1.6; [cite_start]/* [cite: 8] */ }
        .prose p { margin-bottom: 1rem; [cite_start]/* [cite: 8] */ }
        .prose ul, .prose ol { 
            margin-bottom: 1rem; [cite_start]/* [cite: 9] */
            padding-left: 1.75rem; [cite_start]/* [cite: 10] */
        }
        .prose ul { list-style-type: disc; [cite_start]/* [cite: 10] */ }
        .prose ol { list-style-type: decimal; [cite_start]/* [cite: 11] */ }
        .prose li { margin-bottom: 0.5rem; padding-left: 0.25rem; [cite_start]/* [cite: 12] */ }
        .prose li > p { margin-bottom: 0.25rem; [cite_start]/* [cite: 13] */ }
        .prose li > ul, .prose li > ol { margin-top: 0.5rem; [cite_start]/* [cite: 14] */ }
        .prose strong { font-weight: 600; color: var(--color-text); [cite_start]/* [cite: 15] */ }
        .prose a { color: var(--color-primary); text-decoration: none; border-bottom: 1px solid var(--color-primary); [cite_start]/* [cite: 16] */ }
        .prose a:hover { color: var(--color-primary-dark); border-bottom-color: var(--color-primary-dark); [cite_start]/* [cite: 17] */ }
        .prose h3 {
            font-size: 1.25rem; [cite_start]/* [cite: 18] */
            font-weight: 600; [cite_start]/* [cite: 19] */
            color: var(--color-accent); [cite_start]/* [cite: 19] */
            margin-top: 1.5em; [cite_start]/* [cite: 19] */
            margin-bottom: 0.5em; [cite_start]/* [cite: 19] */
        }
        
        .screenshot-placeholder, .image-generation-container {
            border: 2px dashed var(--color-card-border); [cite_start]/* [cite: 19] */
            border-radius: 8px; [cite_start]/* [cite: 20] */
            padding: 1rem; [cite_start]/* [cite: 20] */
            margin: 1.5rem 0; [cite_start]/* [cite: 20] */
            background-color: var(--color-input-bg); [cite_start]/* [cite: 20] */
            text-align: center; [cite_start]/* [cite: 20] */
            color: var(--color-text-muted); [cite_start]/* [cite: 20] */
            min-height: 100px; [cite_start]/* [cite: 20] */
            display: flex; [cite_start]/* [cite: 20] */
            align-items: center; [cite_start]/* [cite: 20] */
            justify-content: center; [cite_start]/* [cite: 21] */
            flex-direction: column; [cite_start]/* [cite: 21] */
        }
        .screenshot-placeholder::before {
            content: 'üñºÔ∏è'; [cite_start]/* [cite: 21] */
            display: block; [cite_start]/* [cite: 22] */
            font-size: 1.5rem; [cite_start]/* [cite: 22] */
            margin-bottom: 0.5rem; [cite_start]/* [cite: 22] */
        }
        .image-generation-container img {
            max-width: 100%; [cite_start]/* [cite: 22] */
            border-radius: 6px; [cite_start]/* [cite: 23] */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); [cite_start]/* [cite: 23] */
        }

        /* Code Block Styling */
        .code-block-container {
            background-color: var(--code-bg); [cite_start]/* [cite: 23] */
            border-radius: 8px; [cite_start]/* [cite: 24] */
            margin: 1.5rem 0; [cite_start]/* [cite: 24] */
            overflow: hidden; [cite_start]/* [cite: 24] */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); [cite_start]/* [cite: 24] */
        }
        .code-block-header {
            display: flex; [cite_start]/* [cite: 25] */
            justify-content: space-between; [cite_start]/* [cite: 26] */
            align-items: center; [cite_start]/* [cite: 26] */
            background-color: rgba(0,0,0,0.2); [cite_start]/* [cite: 26] */
            padding: 0.5rem 1rem; [cite_start]/* [cite: 26] */
            color: #d1d5db; [cite_start]/* [cite: 26] */
            font-size: 0.875rem; [cite_start]/* [cite: 26] */
            font-family: 'Inter', sans-serif; [cite_start]/* [cite: 26] */
        }
        .copy-code-button {
            background-color: rgba(255,255,255,0.1); [cite_start]/* [cite: 27] */
            color: white; [cite_start]/* [cite: 28] */
            border: none; [cite_start]/* [cite: 28] */
            padding: 0.25rem 0.75rem; [cite_start]/* [cite: 28] */
            border-radius: 6px; [cite_start]/* [cite: 28] */
            cursor: pointer; [cite_start]/* [cite: 28] */
            font-size: 0.8rem; [cite_start]/* [cite: 28] */
            transition: background-color 0.2s; [cite_start]/* [cite: 28] */
        }
        .copy-code-button:hover {
            background-color: rgba(255,255,255,0.2); [cite_start]/* [cite: 29] */
        }
        .code-block-container pre {
            background-color: transparent !important; [cite_start]/* [cite: 30] */
            margin: 0; [cite_start]/* [cite: 31] */
            padding: 1rem; [cite_start]/* [cite: 31] */
            color: var(--code-text); [cite_start]/* [cite: 31] */
            white-space: pre-wrap; [cite_start]/* [cite: 31] */
            word-wrap: break-word; [cite_start]/* [cite: 31] */
        }
        .prose code, .code-block-container code {
            font-family: 'Menlo', 'Consolas', monospace; [cite_start]/* [cite: 32] */
            font-size: 0.9em; [cite_start]/* [cite: 33] */
        }


        .card {
            background-color: var(--color-card-bg); [cite_start]/* [cite: 33] */
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); [cite_start]/* [cite: 34] */
            border-radius: 16px; [cite_start]/* [cite: 34] */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05); [cite_start]/* [cite: 34] */
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, background-color 0.5s ease, border-color 0.5s ease, opacity 0.3s ease; [cite_start]/* [cite: 35] */
            border: 1px solid var(--color-card-border); [cite_start]/* [cite: 35] */
            display: flex; flex-direction: column; [cite_start]/* [cite: 36] */
        }
        .card:hover { box-shadow: 0 10px 20px -5px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.05); [cite_start]/* [cite: 36] */ }
        .card-content { flex-grow: 1; display: flex; flex-direction: column; [cite_start]/* [cite: 37] */ }

        .btn-primary {
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark)); [cite_start]/* [cite: 38] */
            color: var(--color-button-text); [cite_start]/* [cite: 39] */
            font-weight: 600; padding: 12px 24px; border-radius: 8px; [cite_start]/* [cite: 39] */
            transition: all 0.3s ease; [cite_start]/* [cite: 39] */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); [cite_start]/* [cite: 40] */
            border: none; cursor: pointer; [cite_start]/* [cite: 40] */
        }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 7px 10px rgba(0, 0, 0, 0.15); [cite_start]/* [cite: 41] */ filter: brightness(1.1); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; [cite_start]/* [cite: 42] */ }

        .btn-secondary {
            background-color: var(--color-input-bg); [cite_start]/* [cite: 43] */
            color: var(--color-text-muted); [cite_start]/* [cite: 44] */
            font-weight: 600; padding: 10px 20px; border-radius: 8px; [cite_start]/* [cite: 44] */
            border: 1px solid var(--color-input-border); cursor: pointer; [cite_start]/* [cite: 44] */
            transition: all 0.2s ease; [cite_start]/* [cite: 44] */
            display: inline-flex; [cite_start]/* [cite: 45] */
            align-items: center; justify-content: center; gap: 8px; [cite_start]/* [cite: 45] */
        }
        .btn-secondary:hover:not(:disabled) { background-color: #e5e7eb; [cite_start]/* [cite: 45] */ color: var(--color-accent); }
        .btn-secondary:disabled { opacity: 0.7; [cite_start]/* [cite: 46] */ cursor: not-allowed;}
        
        .btn-toggle {
            background-color: var(--color-input-bg); [cite_start]/* [cite: 47] */
            color: var(--color-text-muted); [cite_start]/* [cite: 48] */
            border: 1px solid var(--color-input-border); transition: all 0.2s ease; [cite_start]/* [cite: 48] */
        }
        .btn-toggle.active {
            background-color: var(--color-accent); [cite_start]/* [cite: 49] */
            color: var(--color-button-text); [cite_start]/* [cite: 50] */
            border-color: var(--color-primary-dark); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); [cite_start]/* [cite: 50] */
        }
        .jump-to-button {
            background-color: var(--color-card-bg); [cite_start]/* [cite: 51] */
            color: var(--color-text-muted); [cite_start]/* [cite: 52] */
            border: 1px solid var(--color-card-border); transition: all 0.2s ease; [cite_start]/* [cite: 52] */
            padding: 8px 16px; border-radius: 9999px; font-size: 0.875rem; [cite_start]/* [cite: 52] */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); [cite_start]/* [cite: 53] */
        }
        .jump-to-button:hover { background-color: var(--color-primary); color: var(--color-button-text); [cite_start]/* [cite: 53] */ border-color: var(--color-primary-dark); transform: translateY(-1px); }

        .floating-action-button {
            position: fixed; [cite_start]/* [cite: 54] */
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark)); [cite_start]/* [cite: 55] */
            color: var(--color-button-text); width: 56px; height: 56px; [cite_start]/* [cite: 55] */
            border-radius: 50%; display: flex; align-items: center; justify-content: center; [cite_start]/* [cite: 55] */
            box-shadow: 0 10px 20px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.1); [cite_start]/* [cite: 56] */
            cursor: pointer; transition: all 0.3s ease; z-index: 50; [cite_start]/* [cite: 56] */
        }
        .floating-action-button:hover { transform: translateY(-3px) scale(1.05); [cite_start]/* [cite: 57] */ }
        #new-plan-button { bottom: 2rem; right: 2rem; [cite_start]/* [cite: 58] */ }
        #settings-button { bottom: 6.5rem; right: 2rem; [cite_start]/* [cite: 59] */ }
        #ai-help-button { bottom: 11rem; right: 2rem; [cite_start]/* [cite: 60] */ }
        #theme-changer-button { bottom: 15.5rem; right: 2rem; [cite_start]/* [cite: 61] */ }
        #prompts-button { bottom: 20rem; right: 2rem; [cite_start]/* [cite: 62] */ }
        #saved-articles-button { bottom: 24.5rem; right: 2rem; [cite_start]/* [cite: 63] */ }
        #scroll-to-top-button { bottom: 2rem; left: 2rem; [cite_start]/* [cite: 64] */ }
        
        #settings-panel {
            position: fixed; [cite_start]/* [cite: 65] */
            bottom: 11rem; right: 2rem; [cite_start]/* [cite: 66] */
            background-color: var(--color-card-bg); border: 1px solid var(--color-card-border); [cite_start]/* [cite: 66] */
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); [cite_start]/* [cite: 66] */
            padding: 1rem; [cite_start]/* [cite: 66] */
            width: 280px; z-index: 40; [cite_start]/* [cite: 67] */
            transition: opacity 0.3s ease, transform 0.3s ease; transform-origin: bottom right; [cite_start]/* [cite: 67] */
        }

        .themed-text-primary { color: var(--color-primary); [cite_start]/* [cite: 68] */ }
        .themed-text-accent { color: var(--color-accent); [cite_start]/* [cite: 69] */ }
        .themed-text-muted { color: var(--color-text-muted); [cite_start]/* [cite: 70] */ }
        .themed-input {
            background-color: var(--color-input-bg); [cite_start]/* [cite: 71] */
            border-color: var(--color-input-border); [cite_start]/* [cite: 72] */
            color: var(--color-text); transition: background-color 0.5s ease, border-color 0.5s ease; [cite_start]/* [cite: 72] */
        }
        .themed-input::placeholder { color: var(--color-text-muted); opacity: 0.7; [cite_start]/* [cite: 73] */ }
        .themed-input:focus { --tw-ring-color: var(--color-primary); [cite_start]/* [cite: 74] */ }

        .loader { border-radius: 50%; width: 40px; height: 40px; [cite_start]/* [cite: 75] */ animation: spin 1s linear infinite; }
        .themed-loader { border: 4px solid var(--color-card-border); [cite_start]/* [cite: 76] */ border-top: 4px solid var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); [cite_start]/* [cite: 77] */ } 100% { transform: rotate(360deg); } }

        .header-bg-image { 
            background-image: url('https://i.ibb.co/Kjs2bJvq/Image-fx-31.png'); [cite_start]/* [cite: 78] */
            background-size: cover; background-position: center; opacity: 1; [cite_start]/* [cite: 79] */
            transition: opacity 1.5s ease-in-out; [cite_start]/* [cite: 79] */
        }
        .header-loader-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: white; [cite_start]/* [cite: 80] */ }

        .accordion-item { border-bottom: 1px solid var(--color-card-border); [cite_start]/* [cite: 81] */ }
        .accordion-item:last-child { border-bottom: none; [cite_start]/* [cite: 82] */ }
        .accordion-header {
            width: 100%; [cite_start]/* [cite: 83] */
            text-align: left; padding: 1rem; display: flex; justify-content: space-between; align-items: center; font-weight: 600; [cite_start]/* [cite: 84] */
            color: var(--color-text); background-color: transparent; border: none; cursor: pointer; [cite_start]/* [cite: 84] */
            transition: background-color 0.2s; [cite_start]/* [cite: 85] */
        }
        .accordion-header:hover { background-color: rgba(0,0,0,0.03); [cite_start]/* [cite: 85] */ }
        .accordion-content { padding: 1rem; display: none; [cite_start]/* [cite: 86] */ }
        .accordion-content.open { display: block; [cite_start]/* [cite: 87] */ }
        .accordion-header .icon { transition: transform 0.3s ease; [cite_start]/* [cite: 88] */ }
        .accordion-header.active .icon { transform: rotate(180deg); [cite_start]/* [cite: 89] */ }

        .refine-container { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-card-border); [cite_start]/* [cite: 90] */ }
        
        .card-grid-container {
            display: grid; [cite_start]/* [cite: 91] */
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); [cite_start]/* [cite: 92] */
            gap: 1rem; margin-top: 1rem; padding: 0.5rem; border-radius: 8px; [cite_start]/* [cite: 92] */
            background: rgba(0,0,0,0.02); [cite_start]/* [cite: 92] */
        }
        .grid-card-selector {
            background-color: white; [cite_start]/* [cite: 93] */
            border: 1px solid var(--color-card-border); [cite_start]/* [cite: 94] */
            border-radius: 8px; padding: 1rem; text-align: center; [cite_start]/* [cite: 94] */
            cursor: pointer; transition: all 0.2s ease; font-size: 0.875rem; font-weight: 500; [cite_start]/* [cite: 4] */
            display: flex; flex-direction: column; justify-content: space-between; height: 100%; [cite_start]/* [cite: 95] */
            position: relative;
        }
        .grid-card-selector:hover { transform: translateY(-3px); [cite_start]/* [cite: 95] */ box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .grid-card-selector.active {
            background-color: var(--color-accent); [cite_start]/* [cite: 96] */
            color: var(--color-button-text); border-color: var(--color-primary-dark); [cite_start]/* [cite: 97] */
        }
        .grid-card-selector .icon { margin-bottom: 0.5rem; [cite_start]/* [cite: 97] */ }
        .grid-card-selector svg { width: 2.5rem; height: 2.5rem; margin: 0 auto; display: block; [cite_start]/* [cite: 98] */ }
        .grid-card-selector.active small { color: rgba(255, 255, 255, 0.8); [cite_start]/* [cite: 99] */ }
        
        /* New styling for the 'viewed' item indicator */
        .viewed-indicator {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 20px;
            height: 20px;
            background-color: var(--color-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transform: scale(0);
            transition: transform 0.3s ease-out;
        }
        .grid-card-selector.is-viewed .viewed-indicator {
            transform: scale(1);
        }
        .viewed-indicator svg {
             width: 12px; height: 12px;
        }


        /* Style for newly generated items */
        .new-item-highlight {
            border: 2px solid var(--color-primary); [cite_start]/* [cite: 100] */
            box-shadow: 0 0 10px var(--color-primary); [cite_start]/* [cite: 101] */
        }

    </style>
</head>
<body>
    
    <div id="apiKeyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="card p-8 w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4 themed-text-primary">Enter Your API Keys</h2>
            <p class="mb-4 themed-text-muted">Please provide the necessary API keys to use the application's features.</p>
            <form id="apiKeyForm">
                 <div class="mb-4">
                    <label for="geminiApiKeyInput" class="block text-sm font-medium themed-text-muted">Gemini API Key (Required)</label>
                    <input type="password" id="geminiApiKeyInput" class="w-full mt-1 px-4 py-2 themed-input border rounded-lg focus:ring-2" placeholder="Your Gemini API Key" required>
                </div>

                 <div class="mb-4">
                    <label for="firebaseConfigInput" class="block text-sm font-medium themed-text-muted">Firebase Config Object (Required)</label>
                    <textarea id="firebaseConfigInput" class="w-full mt-1 px-3 py-2 themed-input border rounded-lg focus:ring-2 font-mono text-xs" rows="6" placeholder="Paste your Firebase config snippet here."></textarea>
                     <p class="text-xs themed-text-muted mt-1">Find this in your Firebase project settings. You can paste the entire snippet.</p>
                </div>

                <h3 class="text-xl font-semibold mb-2 mt-6 themed-text-accent">Cloud Integrations (Optional)</h3>
                <p class="mb-2 themed-text-muted text-sm">To save/load guides from Google Drive, also provide your Client ID.</p>
                
                 <div class="mb-4">
                    <label for="googleClientIdInput" class="block text-sm font-medium themed-text-muted">Google Cloud Client ID</label>
                    <input type="password" id="googleClientIdInput" class="w-full mt-1 px-4 py-2 themed-input border rounded-lg focus:ring-2" placeholder="For Google Drive integration">
                </div>
                 
                <button type="submit" class="w-full btn-primary mt-6">Save Keys and Start</button>
            </form>
        </div>
    </div>
    <div id="loadingStateModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="card p-8 w-full max-w-md m-4 text-center">
            <h2 class="text-2xl font-bold mb-4 themed-text-primary">Waking up the AI...</h2>
            <div class="flex justify-center my-4"><div class="loader themed-loader"></div></div>
            <p id="loading-message" class="mb-6 themed-text-muted">The AI is generating the initial content and guides. This may take a few moments.</p>
            <button id="closeLoadingStateModal" class="btn-secondary">Close</button>
        </div>
    </div>
    <div id="inDepthModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-3xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 id="inDepthModalTitle" class="text-2xl font-bold themed-text-primary">In-Depth Guide</h2>
                <button id="closeInDepthModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="inDepthModalContent" class="p-6 overflow-y-auto"></div>
            <div id="inDepthModalFooter" class="p-4 border-t" style="border-color: var(--color-card-border);">
                 <div id="inDepthModalButtons" class="flex flex-wrap justify-center gap-2"></div>
                <p id="modal-status-message" class="text-xs text-center themed-text-muted mt-2"></p>
            </div>
        </div>
    </div>
     <div id="utilityModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-3xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 id="utilityModalTitle" class="text-2xl font-bold themed-text-primary">AI-Generated Utility</h2>
                <button id="closeUtilityModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="utilityModalContent" class="p-6 overflow-y-auto"></div>
        </div>
    </div>
     <div id="savedArticlesModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-2xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                 <h2 class="text-2xl font-bold themed-text-primary">My Saved Articles</h2>
                <button id="closeSavedArticlesModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div id="savedArticlesContent" class="p-6 overflow-y-auto"></div>
        </div>
    </div>
    <div id="themeGeneratorModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-lg m-4 flex flex-col">
             <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 class="text-2xl font-bold themed-text-primary">AI Visual Theme Generator</h2>
                <button id="closeThemeGeneratorModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
            <div class="p-6">
                 <p class="mb-6 themed-text-muted">Describe a mood or concept to create a new color palette and header image for the app.</p>
                <textarea id="theme-prompt" rows="3" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'Modern data center at dusk'"></textarea>
                <button id="generate-theme-btn" class="btn-primary w-full mt-4" title="Generate new app visuals based on your text">Generate Visuals</button>
                <div id="theme-loader-container" class="hidden mt-4 flex items-center space-x-3">
                    <div class="loader themed-loader" style="width:25px; height:25px;"></div>
                    <span class="themed-text-muted">AI is generating colors & image...</span>
                </div>
                <div id="theme-error-container" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>
            </div>
        </div>
    </div>
    <div id="promptsModal" class="fixed hidden inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-4xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--color-card-border);">
                <h2 class="text-2xl font-bold themed-text-primary">Application AI Prompts</h2>
                <button id="closePromptsModal" class="themed-text-muted hover:themed-text-accent text-3xl leading-none" title="Close Modal">&times;</button>
            </div>
             <div id="promptsModalContent" class="p-6 overflow-y-auto"></div>
        </div>
    </div>

    <div id="app-container" class="container mx-auto px-4 sm:px-6 lg:px-8 hidden">
        <header class="relative text-center mb-10 rounded-2xl overflow-hidden shadow-lg">
            <div id="header-loader" class="hidden absolute inset-0 bg-black bg-opacity-50 flex-col items-center justify-center z-20 transition-opacity duration-500">
                <div class="loader header-loader-spinner"></div>
                 <p class="text-white mt-4 text-lg">Generating new header image...</p>
            </div>
            <div id="header-bg-image" class="absolute inset-0 header-bg-image"></div>
            <div class="absolute inset-0 bg-black opacity-40"></div>
            <div class="relative z-10 py-24 px-12 text-white">
                <h1 class="text-4xl md:text-5xl font-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.6);">IT Administration Hub</h1>
                <p class="text-lg text-purple-200 mt-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.6);">AI-powered guides and task generation for IT professionals.</p>
            </div>
            <div id="auth-status" class="absolute top-4 right-4"></div>
            <div id="version-display" class="absolute bottom-2 right-4 text-white text-xs opacity-70">v4.34</div>
        </header>

        <nav id="jump-to-nav-container" class="hidden text-center mb-8"></nav>

         <main id="main-content" class="space-y-8">
            <div id="imported-guides-section" class="hidden">
                 <h2 class="text-3xl font-bold text-center mb-4 themed-text-accent">Imported Guides</h2>
                 <div id="imported-guides-container" class="space-y-8"></div>
            </div>
            
             <div id="cloud-storage-card" class="card p-6 hidden">
                 <h2 class="text-xl font-bold themed-text-primary flex items-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.32-10.9A5 5 0 1 1 22 17Z"></path></svg>
                     Cloud Storage
                  </h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                     <div id="google-drive-section" class="hidden">
                          <h3 class="font-semibold themed-text-accent mb-2">Google Drive</h3>
                           <p id="drive-status" class="text-sm themed-text-muted mt-1 mb-3">Connect to load/save guides.</p>
                          <div class="flex gap-2">
                             <button id="auth-button" class="btn-secondary">Connect</button>
                           <button id="load-from-drive-btn" class="btn-secondary hidden">Import from Drive</button>
                         </div>
                     </div>
                     <div id="onedrive-section" class="hidden">
                           <h3 class="font-semibold themed-text-accent mb-2">Microsoft OneDrive</h3>
                          <p id="onedrive-status" class="text-sm themed-text-muted mt-1 mb-3">Connect to save guides.</p>
                          <div class="flex gap-2">
                              <button id="msal-auth-button" class="btn-secondary">Connect</button>
                         </div>
                     </div>
                 </div>
            </div>

            <div id="generative-ai-prompt-card" class="card">
                 <div class="p-8 card-content">
                    <h2 class="text-2xl font-bold mb-2 themed-text-primary">Generative AI Prompt</h2>
                    <p class="mb-6 themed-text-muted">Need a guide for a specific task? Enter any keyword or concept, and let AI craft a step-by-step plan for you.</p>
                    <form id="gemini-form">
                        <input type="text" id="gemini-prompt" class="w-full p-3 themed-input border rounded-lg focus:ring-2" placeholder="e.g., 'Configure a new firewall rule'">
                        
                         <div class="my-4 border rounded-lg" style="border-color: var(--color-card-border);">
                            <div class="accordion-item">
                                <button type="button" class="accordion-header" title="Click to see more options">
                                      <span>Tailor Your Guide:</span>
                                    <svg class="icon w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                 </button>
                                <div class="accordion-content">
                                    <div id="tailoring-buttons-container" class="flex flex-wrap gap-2"></div>
                             </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary w-full mt-4" title="Generate a custom guide based on your text">Generate AI Guide</button>
                    </form>
                    <div id="gemini-result-container" class="mt-6"></div>
                </div>
            </div>

            <div id="main-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8">
               </div>
            
            <div id="discover-more-container" class="text-center py-8">
                <button id="discover-more-button" class="btn-primary px-8 py-4 text-lg" title="Generate a new random IT category">
                    <span class="flex items-center justify-center gap-3">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v2.5"/><path d="M12 22v-2.5"/><path d="M21.5 12.5h-2.5"/><path d="M4.5 12.5h2.5"/><path d="M18.89 6.11l-1.77 1.77"/><path d="M6.88 18.88l-1.77 1.77"/></svg>
                        Discover More IT Topics
                    </span>
                 </button>
                <p id="discover-more-error" class="text-red-500 mt-2"></p>
            </div>
        </main>
    </div>

    <button id="saved-articles-button" class="floating-action-button" title="My Saved Articles">
         <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
    </button>
    <button id="prompts-button" class="floating-action-button" title="View AI Prompts">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 16 4-4-4-4"/><path d="m6 8-4 4 4 4"/><path d="m14.5 4-5 16"/></svg>
    </button>
    <button id="theme-changer-button" class="floating-action-button" title="Change Visual Theme">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l.34.34a8 8 0 0111.32 11.32l-.34.34a8 8 0 01-11.32-11.32l.34-.34z"/><path d="M16 12l-4.5 4.5-2.5-2.5"/><path d="M22 12s-4-8-10-8S2 12 2 12s4 8 10 8 10-8 10-8z"/></svg>
    </button>
    <button id="ai-help-button" class="floating-action-button" title="AI Help & Feedback">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"/><path d="M12 22A10 10 0 1 0 12 2a10 10 0 0 0 0 20z"/></svg>
    </button>
    <button id="settings-button" class="floating-action-button" title="Typography Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
    </button>
    <button id="new-plan-button" class="floating-action-button" title="New Session (Reload)">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
    </button>
    <button id="scroll-to-top-button" class="floating-action-button hidden" title="Scroll to top">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
    </button>
    <div id="settings-panel" class="hidden"><h3 class="text-lg font-bold themed-text-accent mb-4">Display Settings</h3><div class="space-y-4"><div><label for="font-family-select" class="block text-sm font-medium themed-text-muted mb-1">Font Family</label><select id="font-family-select" class="w-full p-2 themed-input border rounded-lg"></select></div><div><label for="font-size-select" class="block text-sm font-medium themed-text-muted mb-1">Font Size (px)</label><select id="font-size-select" class="w-full p-2 themed-input border rounded-lg"></select></div><div><label for="line-height-select" class="block text-sm font-medium themed-text-muted mb-1">Line Spacing</label><select id="line-height-select" class="w-full p-2 themed-input border rounded-lg"></select></div></div></div>

    <footer class="mt-16 py-8 text-center border-t" style="border-color: var(--color-card-border);">
        <div class="max-w-4xl mx-auto px-4">
             <p class="themed-text-muted font-semibold">Disclaimer</p>
            <p class="themed-text-muted text-sm mt-2">
                This application and its content are for informational and educational purposes only. [cite_start]/* [cite: 141] */ The administrative guides and suggestions generated by AI are not a substitute for professional IT advice, vendor documentation, or certified training. [cite_start]/* [cite: 142] */ Always test procedures in a non-production environment before applying them to live systems. [cite_start]/* [cite: 143] */ Never disregard official documentation or professional advice because of something you have read on this application. [cite_start]/* [cite: 144] */ The creators of this application are not responsible for any data loss, system downtime, or damages that may result from the use of these guides. [cite_start]/* [cite: 145] */
            </p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"; [cite_start]/* [cite: 146] */
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; [cite_start]/* [cite: 147] */
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, Timestamp, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; [cite_start]/* [cite: 148] */
        // --- Firebase State ---
        let db; [cite_start]/* [cite: 149] */
        let auth; [cite_start]/* [cite: 149] */
        let userId; [cite_start]/* [cite: 149] */
        let articlesCollectionRef; [cite_start]/* [cite: 149] */
        let viewedItemsCollectionRef; [cite_start]/* [cite: 150] */
        const savedArticleIds = new Set(); [cite_start]/* [cite: 150] */
        const viewedItemIds = new Set(); [cite_start]/* [cite: 150] */
        let firebaseConfig = null; [cite_start]/* [cite: 150] */
        let appIsInitialized = false; [cite_start]/* [cite: 150] */
        // --- Global State & Configuration ---
        let geminiApiKey = ""; [cite_start]/* [cite: 151] */
        const root = document.documentElement; [cite_start]/* [cite: 152] */
        const allThemeData = {}; [cite_start]/* [cite: 152] */
        const fullPrompts = {};  [cite_start]/* [cite: 152] */
        let originalGeneratedText = new Map(); [cite_start]/* [cite: 152] */
        // --- Google Drive Integration State & Config ---
        let gapiInited = false; [cite_start]/* [cite: 153] */
        let gisInited = false; [cite_start]/* [cite: 154] */
        let tokenClient; [cite_start]/* [cite: 154] */
        let GOOGLE_CLIENT_ID = ''; [cite_start]/* [cite: 154] */
        const G_SCOPES = 'https://www.googleapis.com/auth/drive.file'; [cite_start]/* [cite: 154] */
        let driveFolderId = null; [cite_start]/* [cite: 154] */
        // --- Microsoft OneDrive Integration State & Config ---
        let msalInstance = null; [cite_start]/* [cite: 155] */
        let MSAL_CLIENT_ID = '';  [cite_start]/* [cite: 156] */
        const MSAL_SCOPES = { scopes: ["User.Read", "Files.ReadWrite.AppFolder"] }; [cite_start]/* [cite: 156] */
        let msalAccount = null; [cite_start]/* [cite: 156] */
        // --- App Initialization & Event Listeners ---
        function initializeApplication() {
            setupEventListeners(); [cite_start]/* [cite: 157] */
            populateTypographySettings(); [cite_start]/* [cite: 158] */
            marked.setOptions({
                renderer: new marked.Renderer(),
                highlight: (code, lang) => code,
                langPrefix: 'language-',
                gfm: true,
                breaks: true,
           }); [cite_start]/* [cite: 158] */

            // Load credentials. If successful, initialize Firebase.
            // GAPI/MSAL initialization is now deferred until after successful Firebase auth. [cite_start]/* [cite: 160] */
            if (loadConfigFromStorage()) {
                initializeFirebase(); [cite_start]/* [cite: 161] */
            } else {
                document.getElementById('apiKeyModal').classList.remove('hidden'); [cite_start]/* [cite: 162] */
            }
        }
        
        document.addEventListener('DOMContentLoaded', initializeApplication); [cite_start]/* [cite: 163] */
        function loadConfigFromStorage() {
            geminiApiKey = localStorage.getItem('geminiApiKey'); [cite_start]/* [cite: 164] */
            const firebaseConfigString = localStorage.getItem('firebaseConfig'); [cite_start]/* [cite: 165] */
            GOOGLE_CLIENT_ID = localStorage.getItem('googleClientId');

            if (firebaseConfigString) {
                try {
                    firebaseConfig = JSON.parse(firebaseConfigString); [cite_start]/* [cite: 165] */
                } catch (e) {
                    console.error("Failed to parse Firebase config from localStorage", e); [cite_start]/* [cite: 166] */
                    localStorage.clear(); [cite_start]/* [cite: 167] */
                    return false;
                }
            }

            if (geminiApiKey && firebaseConfig) {
                document.getElementById('geminiApiKeyInput').value = geminiApiKey; [cite_start]/* [cite: 167] */
                document.getElementById('firebaseConfigInput').value = JSON.stringify(firebaseConfig, null, 2); [cite_start]/* [cite: 168] */
                if (GOOGLE_CLIENT_ID) {
                    document.getElementById('googleClientIdInput').value = GOOGLE_CLIENT_ID; [cite_start]/* [cite: 168] */
                }
                return true; [cite_start]/* [cite: 169] */
            }
            return false; [cite_start]/* [cite: 170] */
        }
        
        function setupAuthUI(user) {
            const authStatusEl = document.getElementById('auth-status'); [cite_start]/* [cite: 171] */
            const appContainer = document.getElementById('app-container'); [cite_start]/* [cite: 172] */
            const apiKeyModal = document.getElementById('apiKeyModal');

            if (user) {
                appContainer.classList.remove('hidden'); [cite_start]/* [cite: 172] */
                apiKeyModal.classList.add('hidden'); [cite_start]/* [cite: 173] */
                
                authStatusEl.innerHTML = `
                    <div class="bg-white/20 backdrop-blur-sm rounded-full p-1 flex items-center gap-2 text-white text-sm">
                        <img src="${user.photoURL}" alt="User photo" class="w-8 h-8 rounded-full">
                        <span class="font-medium pr-2">${user.displayName}</span>
                         <button id="sign-out-button" class="bg-white/20 hover:bg-white/40 text-white font-bold h-8 w-8 rounded-full flex items-center justify-center" title="Sign Out">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                         </button>
                    </div>
                `; [cite_start]/* [cite: 173] */
                document.getElementById('sign-out-button').addEventListener('click', () => signOut(auth)); [cite_start]/* [cite: 176] */
                
                if (!appIsInitialized) {
                    initializeAppContent(); [cite_start]/* [cite: 176] */
                }

            } else {
                appContainer.classList.add('hidden'); [cite_start]/* [cite: 177] */
            }
        }
        
        async function initializeAppContent() {
            appIsInitialized = true; [cite_start]/* [cite: 178] */
            const loadingModal = document.getElementById('loadingStateModal'); [cite_start]/* [cite: 179] */
            const loadingMessageEl = document.getElementById('loading-message'); [cite_start]/* [cite: 179] */
            loadingMessageEl.textContent = "The AI is generating the initial content and guides. This may take a few moments."; [cite_start]/* [cite: 179] */
            loadingModal.classList.remove('hidden'); [cite_start]/* [cite: 180] */

            document.getElementById('main-grid').innerHTML = ''; [cite_start]/* [cite: 180] */
            document.getElementById('jump-to-nav-container').innerHTML = ''; [cite_start]/* [cite: 180] */
            document.getElementById('gemini-result-container').innerHTML = ''; [cite_start]/* [cite: 180] */
            document.getElementById('discover-more-error').innerHTML = ''; [cite_start]/* [cite: 180] */
            try {
                await generateAndApplyDefaultTheme(); [cite_start]/* [cite: 181] */
                await loadAppContent(loadingMessageEl); [cite_start]/* [cite: 182] */
            } catch (error) {
                console.error("A critical error occurred during app initialization:", error.message); [cite_start]/* [cite: 182] */
                localStorage.clear(); [cite_start]/* [cite: 183] */
                document.getElementById('apiKeyModal').classList.remove('hidden'); [cite_start]/* [cite: 183] */
                const form = document.getElementById('apiKeyForm'); [cite_start]/* [cite: 183] */
                let errorP = form.querySelector('.error-message'); [cite_start]/* [cite: 183] */
                if (!errorP) {
                    errorP = document.createElement('p'); [cite_start]/* [cite: 184] */
                    errorP.className = 'error-message text-red-500 text-sm mt-4 text-center'; [cite_start]/* [cite: 185] */
                    form.appendChild(errorP); [cite_start]/* [cite: 185] */
                }
                errorP.textContent = `Setup failed: ${error.message}. Your keys have been cleared. Please check and re-enter them.`; [cite_start]/* [cite: 185] */
            } finally {
                loadingModal.classList.add('hidden'); [cite_start]/* [cite: 187] */
            }
        }

        function initializeFirebase() {
             if (!firebaseConfig) {
                console.warn("Firebase config is missing. Firebase initialization skipped."); [cite_start]/* [cite: 188] */
                return;
            }
            
            try {
                const app = initializeApp(firebaseConfig); [cite_start]/* [cite: 189] */
                db = getFirestore(app); [cite_start]/* [cite: 190] */
                auth = getAuth(app); [cite_start]/* [cite: 190] */

                getRedirectResult(auth)
                    .then((result) => {
                        if (result) {
                            [cite_start]console.log("Successfully handled sign-in redirect.", result.user); /* [cite: 190] */
                       }
                    }).catch((error) => {
                        [cite_start]console.error("Error processing sign-in redirect:", error); /* [cite: 191] */
                        alert(`Sign-in failed: ${error.message}`); [cite_start]/* [cite: 191] */
                     });

                onAuthStateChanged(auth, user => {
                    if (user) {
                        [cite_start]userId = user.uid; /* [cite: 192] */
                        const appId = firebaseConfig.appId || 'it-admin-hub-global';  [cite_start]/* [cite: 192] */
                         articlesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/articles`); [cite_start]/* [cite: 193] */
                        viewedItemsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/viewedItems`); [cite_start]/* [cite: 193] */
                        listenForSavedArticles();  [cite_start]/* [cite: 193] */
                        listenForViewedItems(); [cite_start]/* [cite: 193] */
                         
                        // --- LOGIN FIX ---
                        // Defer GAPI/MSAL initialization until after Firebase auth state is confirmed. [cite_start]/* [cite: 194] */
                         // This prevents race conditions between Firebase's redirect handling and GAPI's initialization. [cite_start]/* [cite: 195] */
                        if (GOOGLE_CLIENT_ID && !gapiInited && !gisInited) {
                            document.getElementById('google-drive-section').classList.remove('hidden'); [cite_start]/* [cite: 195] */
                            gapi.load('client:picker', () => {
                                [cite_start]gisInited = true; /* [cite: 196] */
                                initializeGapiClient(); [cite_start]/* [cite: 196] */
                            });
                        }
                        // You can add a similar check for MSAL if needed. [cite_start]/* [cite: 197] */
                    } else {
                        userId = null; [cite_start]/* [cite: 198] */
                        articlesCollectionRef = null; [cite_start]/* [cite: 199] */
                        viewedItemsCollectionRef = null; [cite_start]/* [cite: 199] */
                    }
                    setupAuthUI(user); [cite_start]/* [cite: 199] */
                });
            } catch (error) {
                console.error("Firebase initialization error:", error); [cite_start]/* [cite: 200] */
                const form = document.getElementById('apiKeyForm'); [cite_start]/* [cite: 201] */
                let errorP = form.querySelector('.error-message'); [cite_start]/* [cite: 201] */
                 if (!errorP) {
                    errorP = document.createElement('p'); [cite_start]/* [cite: 201] */
                    errorP.className = 'error-message text-red-500 text-sm mt-4 text-center'; [cite_start]/* [cite: 202] */
                    form.appendChild(errorP); [cite_start]/* [cite: 202] */
                }
                errorP.textContent = `Firebase Error: ${error.message}. Please check your config object.`; [cite_start]/* [cite: 202] */
                document.getElementById('apiKeyModal').classList.remove('hidden'); [cite_start]/* [cite: 203] */
            }
        }
        
        function listenForSavedArticles() {
            if (!articlesCollectionRef) return; [cite_start]/* [cite: 203] */
            onSnapshot(articlesCollectionRef, (snapshot) => {
                [cite_start]savedArticleIds.clear(); /* [cite: 204] */
                snapshot.forEach(doc => {
                    [cite_start]savedArticleIds.add(doc.data().title); /* [cite: 205] */
                });
            }, (error) => {
                 console.error("Error listening to saved articles:", error); [cite_start]/* [cite: 205] */
            });
        }

        function listenForViewedItems() {
            if (!viewedItemsCollectionRef) return; [cite_start]/* [cite: 206] */
            onSnapshot(viewedItemsCollectionRef, (snapshot) => {
                [cite_start]const newViewedIds = new Set(); /* [cite: 207] */
                snapshot.forEach(doc => {
                    [cite_start]newViewedIds.add(doc.id); /* [cite: 208] */
                });
                
                  if (newViewedIds.size !== viewedItemIds.size || ![...newViewedIds].every(id => viewedItemIds.has(id))) {
                    viewedItemIds.clear(); [cite_start]/* [cite: 208] */
                    newViewedIds.forEach(id => viewedItemIds.add(id)); [cite_start]/* [cite: 208] */
                    
                    document.querySelectorAll('.card-grid-container').forEach(container => {
                          [cite_start]const containerId = container.parentElement.id; /* [cite: 209] */
                        const themeType = container.parentElement.dataset.themeType; [cite_start]/* [cite: 209] */
                        if(containerId && themeType && allThemeData[themeType]) {
                            populateCardGridSelector(containerId, themeType); [cite_start]/* [cite: 210] */
                        }
                    });
                }
            }, (error) => {
                console.error("Error listening to viewed items:", error); [cite_start]/* [cite: 210] */
            });
        }


        function setupEventListeners() {
            document.getElementById('apiKeyForm').addEventListener('submit', handleApiKeySubmit); [cite_start]/* [cite: 211] */
            document.getElementById('gemini-form').addEventListener('submit', handleGeminiSubmit); [cite_start]/* [cite: 212] */
            document.getElementById('generate-theme-btn').addEventListener('click', handleCustomVisualThemeGeneration); [cite_start]/* [cite: 212] */
            document.getElementById('discover-more-button').addEventListener('click', handleDiscoverMoreClick); [cite_start]/* [cite: 212] */

            document.getElementById('auth-button').addEventListener('click', handleAuthClick); [cite_start]/* [cite: 212] */
            document.getElementById('load-from-drive-btn').addEventListener('click', async () => {
                [cite_start]const folderId = await getDriveFolderId(); /* [cite: 212] */
                createPicker('open', folderId); [cite_start]/* [cite: 212] */
            });
            document.getElementById('msal-auth-button').addEventListener('click', handleMsalAuthClick); [cite_start]/* [cite: 213] */

            document.getElementById('new-plan-button').addEventListener('click', () => location.reload()); [cite_start]/* [cite: 213] */
            document.getElementById('prompts-button').addEventListener('click', displayPromptsInModal); [cite_start]/* [cite: 213] */
            document.getElementById('saved-articles-button').addEventListener('click', showSavedArticles); [cite_start]/* [cite: 213] */
            document.getElementById('theme-changer-button').addEventListener('click', () => {
                if(!geminiApiKey) {
                    [cite_start]document.getElementById('apiKeyModal').classList.remove('hidden'); /* [cite: 214] */
                    return;
                }
                document.getElementById('themeGeneratorModal').classList.remove('hidden'); [cite_start]/* [cite: 214] */
             });
            document.getElementById('ai-help-button').addEventListener('click', handleAIHelpRequest); [cite_start]/* [cite: 215] */
            document.getElementById('scroll-to-top-button').addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' })); [cite_start]/* [cite: 215] */
            
            const settingsPanel = document.getElementById('settings-panel'); [cite_start]/* [cite: 215] */
            document.getElementById('settings-button').addEventListener('click', (e) => {
                [cite_start]e.stopPropagation(); /* [cite: 216] */
                settingsPanel.classList.toggle('hidden'); [cite_start]/* [cite: 216] */
            });
            document.getElementById('font-family-select').addEventListener('change', (e) => root.style.setProperty('--font-family', e.target.value)); [cite_start]/* [cite: 217] */
            document.getElementById('font-size-select').addEventListener('change', (e) => root.style.setProperty('--font-size-base', e.target.value)); [cite_start]/* [cite: 217] */
            document.getElementById('line-height-select').addEventListener('change', (e) => root.style.setProperty('--line-height-base', e.target.value)); [cite_start]/* [cite: 217] */
            
            ['themeGeneratorModal', 'inDepthModal', 'promptsModal', 'loadingStateModal', 'savedArticlesModal', 'utilityModal'].forEach(id => {
                [cite_start]const modal = document.getElementById(id); /* [cite: 218] */
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target.id === id || e.target.closest('[id^="close"]')) {
                             [cite_start]modal.classList.add('hidden'); /* [cite: 219] */
                        }
                    });
                }
            });
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('copy-code-button')) {
                    [cite_start]const codeBlock = e.target.closest('.code-block-container').querySelector('code, pre'); /* [cite: 220] */
                    copyElementTextToClipboard(codeBlock, e.target); [cite_start]/* [cite: 220] */
                    return;
                 }
                
                if (e.target.id === 'save-to-drive-btn') {
                     handleSaveToDriveClick(e.target); [cite_start]/* [cite: 221] */
                     return;
                }

                 if (e.target.id === 'save-to-onedrive-btn') {
                    handleSaveToOneDriveClick(e.target); [cite_start]/* [cite: 222] */
                    return;
                }
                
                 if(e.target.id === 'save-to-db-btn') {
                    saveArticleToDb(e.target); [cite_start]/* [cite: 223] */
                    return;
                }
                
                if(e.target.classList.contains('saved-article-link')) {
                     e.preventDefault(); [cite_start]/* [cite: 224] */
                    const article = JSON.parse(e.target.dataset.article); [cite_start]/* [cite: 224] */
                    displaySavedArticle(article); [cite_start]/* [cite: 225] */
                    return;
                }

                const tailorBtn = e.target.closest('#tailoring-buttons-container .btn-toggle'); [cite_start]/* [cite: 225] */
                if (tailorBtn) {
                    tailorBtn.classList.toggle('active'); [cite_start]/* [cite: 226] */
                    return;
                }

                const gridSelector = e.target.closest('.grid-card-selector'); [cite_start]/* [cite: 227] */
                if (gridSelector) {
                    const container = gridSelector.closest('.card-grid-container').parentElement; [cite_start]/* [cite: 228] */
                    const currentlyActive = container.querySelector('.grid-card-selector.active'); [cite_start]/* [cite: 229] */
                    if(currentlyActive) currentlyActive.classList.remove('active'); [cite_start]/* [cite: 229] */
                    gridSelector.classList.add('active'); [cite_start]/* [cite: 229] */
                    handleGridSelect(gridSelector); [cite_start]/* [cite: 229] */
                    return;
                }

                const exploreBtn = e.target.closest('.explore-button'); [cite_start]/* [cite: 229] */
                if (exploreBtn) {
                    const cardName = exploreBtn.closest('.card').querySelector('h2').textContent; [cite_start]/* [cite: 230] */
                    handleExploreInDepth(exploreBtn.dataset.themeId, exploreBtn.dataset.themeType, cardName); [cite_start]/* [cite: 231] */
                    return;
                }
                
                const refineBtn = e.target.closest('.refine-button'); [cite_start]/* [cite: 231] */
                if (refineBtn) {
                    toggleRefineUI(refineBtn.parentElement); [cite_start]/* [cite: 232] */
                    return;
                }

                const modalRefineBtn = e.target.closest('.modal-refine-button'); [cite_start]/* [cite: 233] */
                if (modalRefineBtn) {
                    toggleRefineUI(modalRefineBtn.parentElement, true); [cite_start]/* [cite: 234] */
                    return;
                }
                
                const submitRefineBtn = e.target.closest('.submit-refinement-button'); [cite_start]/* [cite: 235] */
                if(submitRefineBtn) {
                    handleRefineRequest(submitRefineBtn.closest('.refine-container')); [cite_start]/* [cite: 236] */
                    return;
                }
                
                const showAllBtn = e.target.closest('.show-all-button'); [cite_start]/* [cite: 237] */
                if (showAllBtn) {
                    handleShowAllClick(showAllBtn); [cite_start]/* [cite: 238] */
                    return;
                }

                const generateMoreBtn = e.target.closest('.generate-more-button'); [cite_start]/* [cite: 239] */
                if (generateMoreBtn) {
                    handleGenerateMoreClick(generateMoreBtn); [cite_start]/* [cite: 240] */
                    return;
                }
                
                const scriptBtn = e.target.closest('.generate-script-button');
                if(scriptBtn) {
                    handleGenerateScriptClick(scriptBtn);
                    return;
                }

                const cheatSheetBtn = e.target.closest('.generate-cheatsheet-button');
                if(cheatSheetBtn) {
                    handleGenerateCheatSheetClick(cheatSheetBtn);
                    return;
                }

                const accordionHeader = e.target.closest('.accordion-header'); [cite_start]/* [cite: 241] */
                if (accordionHeader) {  
                    accordionHeader.classList.toggle('active'); [cite_start]/* [cite: 242] */
                    const icon = accordionHeader.querySelector('.icon'); [cite_start]/* [cite: 242] */
                    if(icon) {
                       icon.style.transform = accordionHeader.classList.contains('active') ? [cite_start]/* [cite: 243] */
                        'rotate(180deg)' : 'rotate(0deg)'; [cite_start]/* [cite: 244] */
                    }
                    accordionHeader.nextElementSibling.classList.toggle('open'); [cite_start]/* [cite: 244] */
                    return;
                }
                
                const jumpToBtn = e.target.closest('.jump-to-button'); [cite_start]/* [cite: 245] */
                if (jumpToBtn) {
                    const targetCard = document.getElementById(jumpToBtn.dataset.targetId); [cite_start]/* [cite: 246] */
                    if (targetCard) {
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'start'}); [cite_start]/* [cite: 247] */
                        targetCard.style.boxShadow = '0 0 0 4px var(--color-primary)'; [cite_start]/* [cite: 248] */
                        setTimeout(() => targetCard.style.boxShadow = '', 2000); [cite_start]/* [cite: 248] */
                    }
                    return;
                }

                if (!settingsPanel.classList.contains('hidden') && !settingsPanel.contains(e.target) && !e.target.closest('#settings-button')) {
                    settingsPanel.classList.add('hidden'); [cite_start]/* [cite: 250] */
                }
            });
            window.addEventListener('scroll', () => {
                [cite_start]const scrollTopButton = document.getElementById('scroll-to-top-button'); /* [cite: 252] */
                if (window.scrollY > 300) {
                    scrollTopButton.classList.remove('hidden'); [cite_start]/* [cite: 252] */
                } else {
                    
                    scrollTopButton.classList.add('hidden'); [cite_start]/* [cite: 253] */
                }
            });
        }
        
        async function handleApiKeySubmit(e) {
            e.preventDefault(); [cite_start]/* [cite: 254] */
            const tempGeminiKey = document.getElementById('geminiApiKeyInput').value.trim(); [cite_start]/* [cite: 255] */
            const tempFirebaseConfigText = document.getElementById('firebaseConfigInput').value.trim(); [cite_start]/* [cite: 255] */
            const tempGoogleClientId = document.getElementById('googleClientIdInput').value.trim(); [cite_start]/* [cite: 255] */
            let tempFirebaseConfig; [cite_start]/* [cite: 255] */

            const form = document.getElementById('apiKeyForm'); [cite_start]/* [cite: 255] */
            let errorP = form.querySelector('.error-message'); [cite_start]/* [cite: 256] */
            if (!errorP) {
                errorP = document.createElement('p'); [cite_start]/* [cite: 256] */
                errorP.className = 'error-message text-red-500 text-sm mt-4 text-center'; [cite_start]/* [cite: 257] */
                form.appendChild(errorP); [cite_start]/* [cite: 257] */
            }
            errorP.textContent = ''; [cite_start]/* [cite: 257] */
            if (!tempGeminiKey || !tempFirebaseConfigText) {
                errorP.textContent = "Gemini API Key and Firebase Config are required."; [cite_start]/* [cite: 258] */
                return;
            }
            
            // *** MODIFIED: Use a more robust parsing method for the Firebase config ***
            try {
                const match = tempFirebaseConfigText.match(/\{[\s\S]*\}/); [cite_start]/* [cite: 259] */
                if (!match) {
                    throw new Error("Could not find a config object starting with '{' and ending with '}'."); [cite_start]/* [cite: 260] */
                }
                const configString = match[0]; [cite_start]/* [cite: 261] */
                // Use new Function() to safely parse the config as a JavaScript object,
                // which is more robust than JSON.parse for user-pasted snippets from Firebase. [cite_start]/* [cite: 262] */
                const configFactory = new Function(`return ${configString}`); [cite_start]/* [cite: 263] */
                tempFirebaseConfig = configFactory(); [cite_start]/* [cite: 263] */

                if (!tempFirebaseConfig || typeof tempFirebaseConfig !== 'object' || !tempFirebaseConfig.apiKey || !tempFirebaseConfig.projectId) {
                    throw new Error("The parsed Firebase config is invalid or missing required properties like 'apiKey' or 'projectId'."); [cite_start]/* [cite: 263] */
                }
            } catch (err) {
                errorP.textContent = `Invalid Firebase Config: ${err.message}. Please ensure you've pasted the complete snippet from your Firebase project settings.`; [cite_start]/* [cite: 264] */
                return;
            }
            
            localStorage.setItem('geminiApiKey', tempGeminiKey); [cite_start]/* [cite: 266] */
            localStorage.setItem('firebaseConfig', JSON.stringify(tempFirebaseConfig)); [cite_start]/* [cite: 267] */
            localStorage.setItem('googleClientId', tempGoogleClientId); [cite_start]/* [cite: 267] */
            
            loadConfigFromStorage(); [cite_start]/* [cite: 267] */
            initializeFirebase(); [cite_start]/* [cite: 267] */
            
            try {
                const provider = new GoogleAuthProvider(); [cite_start]/* [cite: 267] */
                await signInWithRedirect(auth, provider); [cite_start]/* [cite: 268] */
            } catch (error) {
                console.error("Google Sign-In Redirect failed:", error); [cite_start]/* [cite: 268] */
                errorP.textContent = `Google Sign-In Failed: ${error.message}`; [cite_start]/* [cite: 269] */
            }
        }

        // --- Google Drive & Firebase Functions ---
        
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: geminiApiKey,
 
                    [cite_start]discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'], /* [cite: 270] */
                });
                gapiInited = true; [cite_start]/* [cite: 271] */
                initializeTokenClient(); [cite_start]/* [cite: 271] */

            } catch(error) {
                console.error("Error initializing GAPI Client", error); [cite_start]/* [cite: 271] */
                document.getElementById('drive-status').textContent = 'Google API init failed. Check keys.'; [cite_start]/* [cite: 272] */
            }
        }

        function initializeTokenClient() {
            if (!GOOGLE_CLIENT_ID) {
                console.error("Google Client ID is missing."); [cite_start]/* [cite: 272] */
                return;
            }
            tokenClient = google.accounts.oauth2.initTokenClient({
                [cite_start]client_id: GOOGLE_CLIENT_ID, /* [cite: 273] */
                [cite_start]scope: G_SCOPES, /* [cite: 273] */
                callback: (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
        
                        gapi.client.setToken(tokenResponse); [cite_start]/* [cite: 274] */
                        updateSigninStatus(true); [cite_start]/* [cite: 274] */
                    } else {
                        console.error('Provided token response was invalid.', tokenResponse); [cite_start]/* [cite: 274] */
         
                        updateSigninStatus(false); [cite_start]/* [cite: 275] */
                    }
                },
            });
            tokenClient.requestAccessToken({prompt: 'none'}); [cite_start]/* [cite: 276] */
        }


        function handleAuthClick() {
             if (!gapiInited || !gisInited || !tokenClient) {
                console.error('Google services are not initialized yet.'); [cite_start]/* [cite: 276] */
                document.getElementById('drive-status').textContent = 'Services initializing, please wait...'; [cite_start]/* [cite: 277] */
                return;
            }

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'}); [cite_start]/* [cite: 277] */
            } else {
                const token = gapi.client.getToken(); [cite_start]/* [cite: 278] */
                if (token) {
                    google.accounts.oauth2.revoke(token.access_token, () => {
                        [cite_start]gapi.client.setToken(null); /* [cite: 279] */
                        updateSigninStatus(false); [cite_start]/* [cite: 279] */
                    });
                }
            }
        }
        
        function updateSigninStatus(isSignedIn) {
            const authButton = document.getElementById('auth-button'); [cite_start]/* [cite: 280] */
            const loadBtn = document.getElementById('load-from-drive-btn'); [cite_start]/* [cite: 281] */
            const statusEl = document.getElementById('drive-status'); [cite_start]/* [cite: 281] */
            
            if (isSignedIn) {
                authButton.textContent = 'Sign Out'; [cite_start]/* [cite: 281] */
                loadBtn.classList.remove('hidden'); [cite_start]/* [cite: 282] */
                statusEl.textContent = 'Connected to Google Drive.'; [cite_start]/* [cite: 282] */
                getDriveFolderId();  [cite_start]/* [cite: 282] */
            } else {
                authButton.textContent = 'Connect'; [cite_start]/* [cite: 282] */
                loadBtn.classList.add('hidden'); [cite_start]/* [cite: 283] */
                statusEl.textContent = 'Connect to load/save guides.'; [cite_start]/* [cite: 283] */
                driveFolderId = null; [cite_start]/* [cite: 283] */
            }
        }

        async function getDriveFolderId() {
            if (driveFolderId) return driveFolderId; [cite_start]/* [cite: 284] */
            const driveStatusEl = document.getElementById('drive-status'); [cite_start]/* [cite: 285] */
            driveStatusEl.textContent = 'Searching for app folder...'; [cite_start]/* [cite: 285] */
            try {
                const response = await gapi.client.drive.files.list({
                    [cite_start]q: "mimeType='application/vnd.google-apps.folder' and name='IT Administration Hub' and trashed=false", /* [cite: 286] */
                    [cite_start]fields: 'files(id, name)', /* [cite: 286] */
                });
                if (response.result.files && response.result.files.length > 0) {
                    driveFolderId = response.result.files[0].id; [cite_start]/* [cite: 287] */
                } else {
                    driveStatusEl.textContent = 'Creating app folder...'; [cite_start]/* [cite: 288] */
                    const folderResponse = await gapi.client.drive.files.create({
                        [cite_start]resource: { 'name': 'IT Administration Hub', 'mimeType': 'application/vnd.google-apps.folder' }, /* [cite: 289] */
                        [cite_start]fields: 'id' /* [cite: 289] */
                    });
                    driveFolderId = folderResponse.result.id; [cite_start]/* [cite: 290] */
                }
                updateSigninStatus(true); [cite_start]/* [cite: 290] */
                return driveFolderId; [cite_start]/* [cite: 291] */
            } catch (error) {
                console.error("Error finding/creating Drive folder:", error); [cite_start]/* [cite: 291] */
                driveStatusEl.textContent = 'Error with Drive folder access.'; [cite_start]/* [cite: 292] */
                return null;
            }
        }
        
        async function handleSaveToDriveClick(button) {
             const modalFooter = button.closest('#inDepthModalFooter'); [cite_start]/* [cite: 292] */
             const { cardName, fullTitle } = modalFooter.dataset; [cite_start]/* [cite: 293] */
             
             const rawMarkdown = originalGeneratedText.get(fullTitle); [cite_start]/* [cite: 293] */
             if (!rawMarkdown) {
                console.error("Could not find markdown to save for:", fullTitle); [cite_start]/* [cite: 294] */
                return;
             }

             const fileName = `${cardName} - ${document.getElementById('inDepthModalTitle').textContent}.md`.replace('In-Depth: ', ''); [cite_start]/* [cite: 295] */
             const statusEl = document.getElementById('modal-status-message'); [cite_start]/* [cite: 296] */
             
             await saveContentToDrive(rawMarkdown, fileName, statusEl); [cite_start]/* [cite: 296] */
        }

        async function saveContentToDrive(content, fileName, statusElement) {
            if (gapi.client.getToken() === null) {
                statusElement.textContent = 'Please connect to Google Drive first.'; [cite_start]/* [cite: 296] */
                return;
            }

            statusElement.textContent = 'Saving to Google Drive...'; [cite_start]/* [cite: 297] */
            const folderId = await getDriveFolderId(); [cite_start]/* [cite: 298] */
            if (!folderId) {
                statusElement.textContent = 'Could not find or create the app folder in Drive.'; [cite_start]/* [cite: 298] */
                return;
            }
           
            const fileMetadata = { name: fileName, parents: [folderId] }; [cite_start]/* [cite: 299] */
            const boundary = '-------314159265358979323846'; [cite_start]/* [cite: 300] */
            const delimiter = "\r\n--" + boundary + "\r\n"; [cite_start]/* [cite: 300] */
            const close_delim = "\r\n--" + boundary + "--"; [cite_start]/* [cite: 300] */
            const multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(fileMetadata) + delimiter + 'Content-Type: text/markdown\r\n\r\n' + content + close_delim; [cite_start]/* [cite: 301] */
            try {
                await gapi.client.request({
                    [cite_start]'path': '/upload/drive/v3/files', /* [cite: 302] */
                    [cite_start]'method': 'POST', /* [cite: 302] */
                    [cite_start]'params': {'uploadType': 'multipart'}, /* [cite: 302] */
                  
                    [cite_start]'headers': {'Content-Type': 'multipart/related; boundary="' + boundary + '"'}, /* [cite: 303] */
                    [cite_start]'body': multipartRequestBody /* [cite: 303] */
                });
                statusElement.textContent = `File '${fileName}' saved to Drive!`; [cite_start]/* [cite: 304] */
                 setTimeout(()=> statusElement.textContent = '', 4000); [cite_start]/* [cite: 304] */
            } catch (error) {
                console.error('Error saving file to Drive:', error); [cite_start]/* [cite: 305] */
                statusElement.textContent = 'Error saving file. Check console.'; [cite_start]/* [cite: 306] */
            }
        }


        function createPicker(mode, startInFolderId = null) {  
            if (!gisInited) {
                 console.error("Google services not ready for picker."); [cite_start]/* [cite: 306] */
                 (document.getElementById('drive-status') || document.getElementById('modal-status-message')).textContent = 'Google API not ready.'; [cite_start]/* [cite: 307] */
                 return;
             }
            
             const token = gapi.client.getToken()?.access_token; [cite_start]/* [cite: 307] */
             if (!token) {
                 (document.getElementById('drive-status') || document.getElementById('modal-status-message')).textContent = 'You are not signed in.'; [cite_start]/* [cite: 308] */
                 return;
             }
             const builder = new google.picker.PickerBuilder()
                .setOAuthToken(token); [cite_start]/* [cite: 309] */
             if (mode === 'open') {
                const view = new google.picker.View(google.picker.ViewId.DOCS); [cite_start]/* [cite: 310] */
                view.setMimeTypes("text/markdown,text/plain,.md"); [cite_start]/* [cite: 311] */
                if (startInFolderId) {
                    view.setParent(startInFolderId); [cite_start]/* [cite: 311] */
                }
                builder.addView(view).setCallback(pickerCallbackOpen); [cite_start]/* [cite: 312] */
             } 

             const picker = builder.build(); [cite_start]/* [cite: 313] */
             picker.setVisible(true); [cite_start]/* [cite: 313] */
        }

        async function pickerCallbackOpen(data) {
            if (data.action === google.picker.Action.PICKED) {
                const fileId = data.docs[0].id; [cite_start]/* [cite: 314] */
                const statusEl = document.getElementById('drive-status'); [cite_start]/* [cite: 315] */
                statusEl.textContent = 'Loading selected file...'; [cite_start]/* [cite: 315] */
                try {
                    const response = await gapi.client.drive.files.get({ fileId, alt: 'media' }); [cite_start]/* [cite: 315] */
                    const fileContent = response.body; [cite_start]/* [cite: 316] */
                    const fileName = data.docs[0].name; [cite_start]/* [cite: 316] */
                    
                    displayImportedGuide(fileName, fileContent); [cite_start]/* [cite: 316] */
                    statusEl.textContent = 'File loaded successfully.'; [cite_start]/* [cite: 316] */
                    setTimeout(() => updateSigninStatus(true), 3000); [cite_start]/* [cite: 316] */
                } catch (error) {
                    console.error("Error loading file content:", error); [cite_start]/* [cite: 317] */
                    statusEl.textContent = 'Error loading file from Google Drive.'; [cite_start]/* [cite: 318] */
                }
            }
        }
        
        // --- Microsoft OneDrive Functions ---
        
        function initializeMsal() {
            if (!MSAL_CLIENT_ID) return; [cite_start]/* [cite: 318] */
            const config = { auth: { clientId: MSAL_CLIENT_ID, authority: "https://login.microsoftonline.com/common" } }; [cite_start]/* [cite: 319] */
            msalInstance = new msal.PublicClientApplication(config); [cite_start]/* [cite: 319] */
            msalInstance.handleRedirectPromise().then(resp => {
                if (resp !== null) {
                    [cite_start]msalAccount = resp.account; /* [cite: 320] */
                    updateMsalSigninStatus(true); [cite_start]/* [cite: 320] */
                } else {
                  
                     const currentAccounts = msalInstance.getAllAccounts(); [cite_start]/* [cite: 321] */
                    if (currentAccounts.length > 0) {
                        msalAccount = currentAccounts[0]; [cite_start]/* [cite: 321] */
                        updateMsalSigninStatus(true); [cite_start]/* [cite: 321] */
                    }
 
                 }
            }).catch(err => console.error(err)); [cite_start]/* [cite: 322] */
        }
        
        function handleMsalAuthClick() {
            if (!msalInstance) return; [cite_start]/* [cite: 323] */
            if (msalAccount) {
                msalInstance.logoutRedirect({ account: msalAccount }); [cite_start]/* [cite: 324] */
            } else {
                msalInstance.loginRedirect(MSAL_SCOPES); [cite_start]/* [cite: 325] */
            }
        }
        
        function updateMsalSigninStatus(isSignedIn) {
            const authButton = document.getElementById('msal-auth-button'); [cite_start]/* [cite: 326] */
            const statusEl = document.getElementById('onedrive-status'); [cite_start]/* [cite: 327] */
            if(isSignedIn) {
                authButton.textContent = 'Sign Out'; [cite_start]/* [cite: 327] */
                statusEl.textContent = `Connected as ${msalAccount.username}.`; [cite_start]/* [cite: 328] */
            } else {
                authButton.textContent = 'Connect'; [cite_start]/* [cite: 328] */
                statusEl.textContent = 'Connect to save guides.'; [cite_start]/* [cite: 329] */
            }
        }

        async function handleSaveToOneDriveClick(button) {
            const modalFooter = button.closest('#inDepthModalFooter'); [cite_start]/* [cite: 329] */
            const { cardName, fullTitle } = modalFooter.dataset; [cite_start]/* [cite: 330] */
            
            const rawMarkdown = originalGeneratedText.get(fullTitle); [cite_start]/* [cite: 330] */
            if (!rawMarkdown) {
                console.error("Could not find markdown to save for:", fullTitle); [cite_start]/* [cite: 331] */
                return;
            }

            const fileName = `${cardName} - ${document.getElementById('inDepthModalTitle').textContent}.md`.replace('In-Depth: ', ''); [cite_start]/* [cite: 332] */
            const statusEl = document.getElementById('modal-status-message'); [cite_start]/* [cite: 333] */
            
            if (!msalAccount) {
                statusEl.textContent = 'Please connect to OneDrive first.'; [cite_start]/* [cite: 333] */
                return;
            }

            statusEl.textContent = 'Saving to OneDrive...'; [cite_start]/* [cite: 334] */
            try {
                const tokenResponse = await msalInstance.acquireTokenSilent({ ...MSAL_SCOPES, account: msalAccount }); [cite_start]/* [cite: 335] */
                const filePath = `special/approot:/IT Administration Hub/${fileName}:/content`; [cite_start]/* [cite: 336] */
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/${filePath}`, {
                    [cite_start]method: 'PUT', /* [cite: 336] */
                    headers: {
                        [cite_start]'Authorization': `Bearer ${tokenResponse.accessToken}`, /* [cite: 336] */
                     
                         [cite_start]'Content-Type': 'text/plain' /* [cite: 337] */
                    },
                    [cite_start]body: rawMarkdown /* [cite: 337] */
                });
                if (response.ok) {
                    statusEl.textContent = `File '${fileName}' saved to OneDrive!`; [cite_start]/* [cite: 338] */
                    setTimeout(() => statusEl.textContent = '', 4000); [cite_start]/* [cite: 339] */
                } else {
                    const error = await response.json(); [cite_start]/* [cite: 339] */
                    if (error.error.code === 'itemNotFound') {
                         statusEl.textContent = 'Folder not found. Trying to create... Please try again.'; [cite_start]/* [cite: 340] */
                    } else {
                        throw new Error(`Graph API Error: ${error.error.message}`); [cite_start]/* [cite: 341] */
                    }
                }
            } catch(error) {
                console.error("Error saving to OneDrive:", error); [cite_start]/* [cite: 342] */
                if (error.errorCode === 'consent_required' || error.errorCode === 'interaction_required') {
                    statusEl.textContent = 'Permissions required. Please try signing in again.'; [cite_start]/* [cite: 343] */
                    msalInstance.acquireTokenPopup(MSAL_SCOPES).catch(err => console.error(err)); [cite_start]/* [cite: 344] */
                } else {
                    statusEl.textContent = `Error: ${error.message}`; [cite_start]/* [cite: 344] */
                }
            }
        }


        // --- Firebase Functions ---
        
        async function saveArticleToDb(button) {
            if (!articlesCollectionRef) {
                console.error("Firestore not initialized, cannot save article."); [cite_start]/* [cite: 345] */
                alert("Saved articles feature is not available. Check Firebase config."); [cite_start]/* [cite: 346] */
                return;
            }
            
            const title = document.getElementById('inDepthModalTitle').textContent; [cite_start]/* [cite: 347] */
            const markdown = originalGeneratedText.get(button.closest('#inDepthModalFooter').dataset.fullTitle); [cite_start]/* [cite: 348] */

            if (!title || !markdown) {
                console.error("Could not find title or markdown to save."); [cite_start]/* [cite: 348] */
                return;
            }
            
            button.disabled = true; [cite_start]/* [cite: 349] */
            button.textContent = 'Saving...'; [cite_start]/* [cite: 350] */

            try {
                await addDoc(articlesCollectionRef, { 
                    title, 
                    markdown, 
                    savedAt: Timestamp.fromDate(new Date()) 
                 }); [cite_start]/* [cite: 350] */
                button.textContent = 'Saved!'; [cite_start]/* [cite: 351] */
            } catch (error) {
                console.error("Error saving article to Firestore:", error); [cite_start]/* [cite: 351] */
                button.disabled = false; [cite_start]/* [cite: 352] */
                button.textContent = 'Save Failed'; [cite_start]/* [cite: 352] */
            }
        }
        
         async function showSavedArticles() {
            if (!articlesCollectionRef) {
                alert("Saved articles feature is not available. Please ensure your API key is correct and Firebase is configured."); [cite_start]/* [cite: 352] */
                return;
            }
            const modal = document.getElementById('savedArticlesModal'); [cite_start]/* [cite: 353] */
            const contentEl = document.getElementById('savedArticlesContent'); [cite_start]/* [cite: 354] */
            contentEl.innerHTML = getLoaderHTML('Loading saved articles...'); [cite_start]/* [cite: 354] */
            modal.classList.remove('hidden'); [cite_start]/* [cite: 354] */
            try {
                const querySnapshot = await getDocs(articlesCollectionRef); [cite_start]/* [cite: 355] */
                if (querySnapshot.empty) {
                    contentEl.innerHTML = `<p class="themed-text-muted">You haven't saved any articles yet.</p>`; [cite_start]/* [cite: 356] */
                    return;
                }

                let articlesHtml = '<ul class="space-y-2 list-disc pl-5">'; [cite_start]/* [cite: 357] */
                querySnapshot.forEach(doc => {
                    [cite_start]const article = doc.data(); /* [cite: 358] */
                    articlesHtml += `
                        <li>
                            <a href="#" class="saved-article-link themed-text-primary hover:underline" data-article='${JSON.stringify(article)}'>
                                ${article.title}
                            </a>
                        </li>
                     `; [cite_start]/* [cite: 358] */
                });
                articlesHtml += '</ul>'; [cite_start]/* [cite: 361] */
                contentEl.innerHTML = articlesHtml; [cite_start]/* [cite: 361] */
            } catch (error) {
                console.error("Error fetching saved articles:", error); [cite_start]/* [cite: 361] */
                contentEl.innerHTML = `<p class="text-red-500">Could not load saved articles.</p>`; [cite_start]/* [cite: 362] */
            }
        }

        function displaySavedArticle(article) {
            document.getElementById('savedArticlesModal').classList.add('hidden'); [cite_start]/* [cite: 362] */
            const modal = document.getElementById('inDepthModal'); [cite_start]/* [cite: 363] */
            const titleEl = document.getElementById('inDepthModalTitle'); [cite_start]/* [cite: 363] */
            const contentEl = document.getElementById('inDepthModalContent'); [cite_start]/* [cite: 363] */
            const footerEl = document.getElementById('inDepthModalFooter'); [cite_start]/* [cite: 363] */

            titleEl.textContent = article.title; [cite_start]/* [cite: 364] */
            contentEl.innerHTML = '';  [cite_start]/* [cite: 364] */
            renderAccordionFromMarkdown(article.markdown, contentEl, false); [cite_start]/* [cite: 364] */
            
            const fullTitle = article.title; [cite_start]/* [cite: 364] */
            originalGeneratedText.set(fullTitle, article.markdown); [cite_start]/* [cite: 364] */
            footerEl.dataset.fullTitle = fullTitle; [cite_start]/* [cite: 364] */
            footerEl.dataset.cardName = "Saved Article"; [cite_start]/* [cite: 364] */
            const buttonContainer = document.getElementById('inDepthModalButtons'); [cite_start]/* [cite: 365] */
            buttonContainer.innerHTML = `<button id="save-to-db-btn" class="btn-secondary" disabled>Saved!</button>`; [cite_start]/* [cite: 365] */
            if (gapi.client.getToken() !== null) {
                const saveDriveBtn = document.createElement('button'); [cite_start]/* [cite: 366] */
                saveDriveBtn.id = 'save-to-drive-btn'; [cite_start]/* [cite: 367] */
                saveDriveBtn.className = 'btn-secondary'; [cite_start]/* [cite: 367] */
                saveDriveBtn.textContent = 'Save to Google Drive'; [cite_start]/* [cite: 367] */
                buttonContainer.appendChild(saveDriveBtn); [cite_start]/* [cite: 367] */
            }
            if (msalAccount) {
                 const saveOneDriveBtn = document.createElement('button'); [cite_start]/* [cite: 368] */
                 saveOneDriveBtn.id = 'save-to-onedrive-btn'; [cite_start]/* [cite: 369] */
                 saveOneDriveBtn.className = 'btn-secondary'; [cite_start]/* [cite: 369] */
                 saveOneDriveBtn.textContent = 'Save to OneDrive'; [cite_start]/* [cite: 369] */
                 buttonContainer.appendChild(saveOneDriveBtn); [cite_start]/* [cite: 369] */
            }

            modal.classList.remove('hidden'); [cite_start]/* [cite: 370] */
        }


        function displayImportedGuide(fileName, markdownContent) {
            const section = document.getElementById('imported-guides-section'); [cite_start]/* [cite: 371] */
            const container = document.getElementById('imported-guides-container'); [cite_start]/* [cite: 372] */
            section.classList.remove('hidden'); [cite_start]/* [cite: 372] */

            const cardId = `imported-${fileName.replace(/[^a-zA-Z0-9]/g, '')}-${Date.now()}`; [cite_start]/* [cite: 372] */
            
            const card = document.createElement('div'); [cite_start]/* [cite: 372] */
            card.className = 'card md:col-span-2'; [cite_start]/* [cite: 372] */
            card.id = cardId; [cite_start]/* [cite: 373] */
            
            const cardContent = document.createElement('div'); [cite_start]/* [cite: 373] */
            cardContent.className = 'p-8 card-content'; [cite_start]/* [cite: 374] */
            cardContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-2 themed-text-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                    Imported: ${fileName}
                 </h2>
                <div class="prose max-w-none mt-4"></div>
            `; [cite_start]/* [cite: 374] */
            const renderTarget = cardContent.querySelector('.prose'); [cite_start]/* [cite: 376] */
            renderAccordionFromMarkdown(markdownContent, renderTarget, false); [cite_start]/* [cite: 376] */

            card.appendChild(cardContent); [cite_start]/* [cite: 376] */
            container.prepend(card); [cite_start]/* [cite: 376] */

            card.scrollIntoView({ behavior: 'smooth', block: 'start' }); [cite_start]/* [cite: 376] */
        }
        
        // --- Core Application Functions ---

        async function loadAppContent(loadingMessageEl) {
            try {
                const categoriesToGenerate = [
                    { 
                         [cite_start]key: 'activeDirectory',  /* [cite: 378] */
                        [cite_start]title: 'Active Directory Management',  /* [cite: 378] */
                        [cite_start]description: "Tasks for managing users, groups, GPOs, and other AD objects.",  /* [cite: 378] */
                        initialPrompt: `Generate 10 common administrative tasks for Active Directory Management. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 378] */
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for Active Directory Management. For each, give a unique "id", "title", and a detailed "description" of the task. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 380] */
                    },
                    { 
                        [cite_start]key: 'aiProgramming',  /* [cite: 382] */
                        [cite_start]title: 'Artificial Intelligence (AI) Programming',  /* [cite: 382] */
                        [cite_start]description: "Concepts and guides for getting started with AI development and programming.",  /* [cite: 383] */
                        initialPrompt: `Generate 10 common topics for an introduction to AI Programming. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 383] */
                        fullPrompt: `Generate 40-50 topics for learning AI Programming, from beginner to advanced. For each, give a unique "id", "title", and a detailed "description" of the topic. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 385] */
                    },
                    { 
                        [cite_start]key: 'citrixAdmin',  /* [cite: 387] */
                        [cite_start]title: 'Citrix Administration',  /* [cite: 387] */
                        [cite_start]description: "Managing Citrix Virtual Apps and Desktops environments.",  /* [cite: 388] */
                        initialPrompt: `Generate 10 common administrative tasks for Citrix. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 388] */
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for Citrix. For each, give a unique "id", "title", and a detailed "description" of the task. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 390] */
                    },
                    { 
                        [cite_start]key: 'dataCenterPractices',  /* [cite: 392] */
                        [cite_start]title: 'Data Center Best Practices',  /* [cite: 392] */
                        [cite_start]description: "Guides on data center operations, cooling, power, and security.",  /* [cite: 393] */
                        initialPrompt: `Generate 10 best practices for data center management. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 393] */
                        fullPrompt: `Generate 40-50 best practices for modern data center management. For each, give a unique "id", "title", and a detailed "description" of the practice. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 395] */
                    },
                    { 
                        [cite_start]key: 'webDesignBestPractices',  /* [cite: 397] */
                        [cite_start]title: 'Designing Web Pages Best Practices',  /* [cite: 397] */
                        [cite_start]description: "Best practices for UI/UX, accessibility, and performance in web design.",  /* [cite: 398] */
                        initialPrompt: `Generate 10 best practices for designing web pages. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 398] */
                        fullPrompt: `Generate 40-50 detailed best practices for designing modern web pages. For each, give a unique "id", "title", and a detailed "description" of the practice. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 400] */
                    },
                    { 
                        [cite_start]key: 'webDesignGemini',  /* [cite: 402] */
                        [cite_start]title: 'Designing Web Pages with Gemini AI',  /* [cite: 402] */
                        [cite_start]description: "Using Gemini AI to assist in the design and development of web pages.",  /* [cite: 403] */
                        initialPrompt: `Generate 10 ways to use Gemini AI for web design. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 403] */
                        fullPrompt: `Generate 40-50 detailed methods for using Gemini AI in web design and development. For each, give a unique "id", "title", and a detailed "description" of the method. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 405] */
                    },
                    { 
                        [cite_start]key: 'dosCommands',  /* [cite: 407] */
                        [cite_start]title: 'DOS Commands for Administrators',  /* [cite: 407] */
                        [cite_start]description: "A reference for essential DOS and Command Prompt commands for system admins.",  /* [cite: 408] */
                        initialPrompt: `Generate 10 essential DOS commands for administrators. For each, give a unique "id", "title" (the command itself), and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 408] */
                        fullPrompt: `Generate 40-50 essential and advanced DOS/CMD commands for administrators. For each, give a unique "id", "title" (the command itself), and a detailed "description" of its use and parameters. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 410] */
                    },
                     { 
                        [cite_start]key: 'geminiCliGuide',  /* [cite: 412] */
                        [cite_start]title: 'A Guide to Using the Gemini CLI',  /* [cite: 412] */
                        [cite_start]description: "Learn how to use the Gemini Command Line Interface for various tasks.",  /* [cite: 413] */
                        initialPrompt: `Generate 10 common use cases for the Gemini CLI. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 413] */
                        fullPrompt: `Generate 40-50 common and advanced use cases and commands for the Gemini CLI. For each, give a unique "id", "title", and a detailed "description" of the use case. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 415] */
                    },
                    { 
                        [cite_start]key: 'hpeProLiant',  /* [cite: 417] */
                        [cite_start]title: 'HPE ProLiant Server Management',  /* [cite: 417] */
                        [cite_start]description: "Managing and troubleshooting HPE ProLiant servers with iLO and other tools.",  /* [cite: 418] */
                        initialPrompt: `Generate 10 common administrative tasks for HPE ProLiant Server Management. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 418] */
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for HPE ProLiant Server Management. For each, give a unique "id", "title", and a detailed "description" of the task. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 420] */
                    },
                    { 
                        [cite_start]key: 'javascriptForHtml',  /* [cite: 422] */
                        [cite_start]title: 'JavaScript for HTML',  /* [cite: 422] */
                        [cite_start]description: "Core JavaScript concepts for manipulating HTML DOM and creating interactive web pages.",  /* [cite: 423] */
                        initialPrompt: `Generate 10 fundamental JavaScript concepts for HTML manipulation. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 423] */
                        fullPrompt: `Generate 40-50 essential JavaScript concepts and techniques for HTML web development. For each, give a unique "id", "title", and a detailed "description" of the concept. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 425] */
                    },
                    { 
                        [cite_start]key: 'm365Admin',  /* [cite: 427] */
                        [cite_start]title: 'Microsoft 365 Administration',  /* [cite: 427] */
                        [cite_start]description: "Administering users, services, and security in Microsoft 365.",  /* [cite: 428] */
                        initialPrompt: `Generate 10 common administrative tasks for Microsoft 365. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 428] */
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for Microsoft 365. For each, give a unique "id", "title", and a detailed "description" of the task. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 429] */
                    },
                    { 
                        [cite_start]key: 'msGraphScripting',  /* [cite: 430] */
                        [cite_start]title: 'MS Graph scripting',  /* [cite: 431] */
                        [cite_start]description: "Automating M365 tasks using the Microsoft Graph API.",  /* [cite: 431] */
                        initialPrompt: `Generate 10 common tasks to automate with MS Graph scripting. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 431] */
                        fullPrompt: `Generate 40-50 common and advanced tasks to automate with Microsoft Graph scripting. For each, give a unique "id", "title", and a detailed "description" of the task. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 433] */
                    },
                    { 
                        [cite_start]key: 'powershellM365',  /* [cite: 435] */
                        [cite_start]title: 'PowerShell for M365 Administration',  /* [cite: 435] */
                        [cite_start]description: "Using PowerShell to manage Microsoft 365 services like Exchange Online and SharePoint.",  /* [cite: 436] */
                        initialPrompt: `Generate 10 common PowerShell tasks for M365 Administration. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 436] */
                        fullPrompt: `Generate 40-50 common and advanced PowerShell tasks for M365 Administration. For each, give a unique "id", "title", and a detailed "description" of the task. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 438] */
                    },
                    { 
                        [cite_start]key: 'powershellWindowsServer',  /* [cite: 440] */
                        [cite_start]title: 'PowerShell for Windows Server Administration',  /* [cite: 440] */
                        [cite_start]description: "Automating Windows Server management with PowerShell scripts and cmdlets.",  /* [cite: 441] */
                        initialPrompt: `Generate 10 common PowerShell tasks for Windows Server Administration. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 441] */
                        fullPrompt: `Generate 40-50 common and advanced PowerShell tasks for Windows Server Administration. For each, give a unique "id", "title", and a detailed "description" of the task. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 443] */
                    },
                    { 
                        [cite_start]key: 'powershellScripts',  /* [cite: 445] */
                        [cite_start]title: 'PowerShell Scripts',  /* [cite: 445] */
                        [cite_start]description: "A collection of useful PowerShell scripts for various administrative tasks.",  /* [cite: 446] */
                        initialPrompt: `Generate 10 useful PowerShell script ideas for administrators. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 446] */
                        fullPrompt: `Generate 40-50 useful and practical PowerShell script ideas for administrators. For each, give a unique "id", "title", and a detailed "description" of the script's purpose. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 448] */
                    },
                    {
                        [cite_start]key: 'serviceNowAdmin', /* [cite: 450] */
                        [cite_start]title: 'ServiceNow Platform Administration', /* [cite: 450] */
  
                        [cite_start]description: 'Guides for administering the ServiceNow cloud platform for IT service management (ITSM) and digital workflows.', /* [cite: 451] */
                        initialPrompt: `Generate 10 common administrative tasks for the ServiceNow platform (servicenow.com). Focus on ITSM, user management, and workflow administration. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`, /* [cite: 451] */
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for the ServiceNow platform (servicenow.com). Cover topics like ITSM, CMDB, user roles, UI policies, business rules, and integrations. For each, give a unique "id", "title", and a detailed "description" of the task. [cite_start]Return ONLY a valid JSON array.` /* [cite: 453] */
                    },
                    { 
                        [cite_start]key: 'usefulApis',  /* [cite: 456] */
                        [cite_start]title: 'Useful APIs for Web Development',  /* [cite: 456] */
                        [cite_start]description: "A curated list of public APIs that are useful for web development projects.",  /* [cite: 457] */
                        initialPrompt: `Generate a list of 10 useful public APIs for web developers. For each, give a unique "id", "title" (API name), and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 457] */
                        fullPrompt: `Generate a list of 40-50 useful public APIs for web developers across different categories. For each, give a unique "id", "title" (API name), and a detailed "description" of what it offers. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 459] */
                    },
                    { 
                        [cite_start]key: 'vmwareEsxi',  /* [cite: 461] */
                        [cite_start]title: 'VMware ESXi Administration',  /* [cite: 461] */
                        [cite_start]description: "Guides and best practices for managing VMware ESXi environments.",  /* [cite: 462] */
                        initialPrompt: `Generate 10 common administrative tasks for VMware ESXi. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 462] */
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for VMware ESXi. For each, give a unique "id", "title", and a detailed "description" of the task. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 464] */
                    },
                    { 
                        [cite_start]key: 'vmwarePowerCli',  /* [cite: 466] */
                        [cite_start]title: 'VMware PowerCLI',  /* [cite: 466] */
                        [cite_start]description: "Automating VMware vSphere administration using PowerCLI.",  /* [cite: 467] */
                        initialPrompt: `Generate 10 common VMware PowerCLI commands for administrators. For each, give a unique "id", "title" (the command/task), and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 467] */
                        fullPrompt: `Generate 40-50 common and advanced tasks using VMware PowerCLI. For each, give a unique "id", "title", and a detailed "description" of the task. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 469] */
                    },
                    { 
                        [cite_start]key: 'windowsServer2019',  /* [cite: 471] */
                        [cite_start]title: 'Windows Server 2019 Administration',  /* [cite: 471] */
                        [cite_start]description: "Key tasks and features for administering Windows Server 2019.",  /* [cite: 472] */
                        initialPrompt: `Generate 10 key administrative tasks for Windows Server 2019. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 472] */
                        fullPrompt: `Generate 40-50 administrative tasks specific to Windows Server 2019. For each, give a unique "id", "title", and a detailed "description" of the task. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 473] */
                    },
                    { 
                        [cite_start]key: 'windowsServer2022',  /* [cite: 474] */
                        [cite_start]title: 'Windows Server 2022 Administration',  /* [cite: 474] */
                        [cite_start]description: "Key tasks and new features for administering Windows Server 2022.",  /* [cite: 475] */
                        initialPrompt: `Generate 10 key administrative tasks for Windows Server 2022. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 475] */
                        fullPrompt: `Generate 40-50 administrative tasks specific to Windows Server 2022, including new features. For each, give a unique "id", "title", and a detailed "description" of the task. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 476] */
                    },
                    { 
                        [cite_start]key: 'windowsServer',  /* [cite: 478] */
                        [cite_start]title: 'Windows Server Administration',  /* [cite: 478] */
                        [cite_start]description: "Essential tasks for managing Windows Server instances.",  /* [cite: 479] */
                        initialPrompt: `Generate 10 common administrative tasks for Windows Server. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.`,  /* [cite: 479] */
                        fullPrompt: `Generate 40-50 common and advanced administrative tasks for Windows Server. For each, give a unique "id", "title", and a detailed "description" of the task. [cite_start]Return ONLY a valid JSON array.`  /* [cite: 481] */
                    }
                ];
                const jsonInstruction = ' IMPORTANT: Ensure that any double quotes inside JSON string values are properly escaped (e.g., \\"example\\"). Return ONLY a valid JSON array.'; [cite_start]/* [cite: 484] */
                const jsonObjectInstruction = ' IMPORTANT: Ensure that any double quotes inside JSON string values are properly escaped (e.g., \\"example\\"). Return ONLY a valid JSON object.'; [cite_start]/* [cite: 485] */

                categoriesToGenerate.forEach(cat => {
                    [cite_start]if (cat.initialPrompt) cat.initialPrompt = cat.initialPrompt.replace('Return ONLY a valid JSON array.', jsonInstruction); /* [cite: 486] */
                    if (cat.fullPrompt) cat.fullPrompt = cat.fullPrompt.replace('Return ONLY a valid JSON array.', jsonInstruction); [cite_start]/* [cite: 486] */
                });
                categoriesToGenerate.sort((a, b) => a.title.localeCompare(b.title)); [cite_start]/* [cite: 487] */

                await Promise.allSettled([loadAITailoringOptions(), loadDynamicPlaceholders()]); [cite_start]/* [cite: 487] */
                
                const generationPromises = categoriesToGenerate.map(cat => {
                    [cite_start]if (loadingMessageEl) loadingMessageEl.textContent = `Generating guides for: ${cat.title}...`; /* [cite: 488] */
                    return generateAndPopulateAICategory(cat).catch(e => {
                        [cite_start]console.error(`Failed to load category: ${cat.title}`, e); /* [cite: 488] */
         
                        return { key: cat.key, error: e }; [cite_start]/* [cite: 488] */
                    });
                });
                const results = await Promise.all(generationPromises); [cite_start]/* [cite: 489] */
                const firstFailure = results.find(r => r && r.error); [cite_start]/* [cite: 489] */
                if(firstFailure){
                    throw new Error(`One or more AI content categories failed to load, starting with ${firstFailure.key}. The process has been stopped.`); [cite_start]/* [cite: 490] */
                }
                
                if (loadingMessageEl) loadingMessageEl.textContent = `Building navigation...`; [cite_start]/* [cite: 491] */
                await generateJumpToButtons(); [cite_start]/* [cite: 492] */

            } catch (error) {
                console.error("An error occurred while loading app content:", error.message); [cite_start]/* [cite: 492] */
                throw error; [cite_start]/* [cite: 493] */
            }
        }
        
        async function generateAndPopulateAICategory({key, title, description, initialPrompt, fullPrompt}) {
            const mainGrid = document.getElementById('main-grid'); [cite_start]/* [cite: 493] */
            const card = document.createElement('div'); [cite_start]/* [cite: 494] */
            card.className = 'card md:col-span-2'; [cite_start]/* [cite: 494] */
            card.id = `${key}-card`; [cite_start]/* [cite: 494] */
            const selectorId = `${key}-selector-visual`; [cite_start]/* [cite: 494] */
            card.innerHTML = `<div class="p-8 card-content"><h2 class="text-2xl font-bold mb-2 themed-text-primary">${title}</h2><p class="mb-6 themed-text-muted">${description}</p><div id="${selectorId}" data-theme-type="${key}" class="w-full">${getLoaderHTML(`AI is generating guides for ${title}...`)}</div><div id="${key}-details" class="details-container mt-4"></div></div>`; [cite_start]/* [cite: 495] */
            mainGrid.appendChild(card); [cite_start]/* [cite: 496] */
            
            fullPrompts[key] = fullPrompt; [cite_start]/* [cite: 496] */

            try {
                const jsonText = await callGeminiAPI(initialPrompt, true); [cite_start]/* [cite: 496] */
                if (!jsonText) throw new Error(`API returned empty content for ${title}.`); [cite_start]/* [cite: 497] */
                
                const data = parseJsonWithCorrections(jsonText); [cite_start]/* [cite: 497] */
                data.sort((a, b) => a.title.localeCompare(b.title)); [cite_start]/* [cite: 497] */
                allThemeData[key] = data; [cite_start]/* [cite: 498] */
                populateCardGridSelector(selectorId, key); [cite_start]/* [cite: 498] */
            } catch (error) {
                handleApiError(error, document.getElementById(selectorId), title, card); [cite_start]/* [cite: 498] */
                throw error; [cite_start]/* [cite: 499] */
            }
        }
        
        function populateCardGridSelector(containerId, themeType, newItemsIds = new Set()) {
            const container = document.getElementById(containerId); [cite_start]/* [cite: 499] */
            const data = allThemeData[themeType]; [cite_start]/* [cite: 500] */
            if (!container || !data || !Array.isArray(data)) {
                if (container) container.innerHTML = `<p class="themed-text-muted">No items to display.</p>`; [cite_start]/* [cite: 500] */
                return;
            }

            const gridClass = 'card-grid-container'; [cite_start]/* [cite: 501] */
            const cardTitle = container.closest('.card').querySelector('h2').textContent; [cite_start]/* [cite: 502] */

            const itemsHtml = data.map(item => {
                [cite_start]const compositeKey = `${cardTitle} - ${item.title}`; /* [cite: 502] */
                const cleanTitle = sanitizeTitle(item.title); [cite_start]/* [cite: 502] */
                const isViewed = viewedItemIds.has(compositeKey); [cite_start]/* [cite: 502] */
                const isNew = newItemsIds.has(item.id); [cite_start]/* [cite: 502] */
             
                const viewedClass = isViewed ? 'is-viewed' : ''; [cite_start]/* [cite: 503] */
                const newClass = isNew ? 'new-item-highlight' : ''; [cite_start]/* [cite: 503] */
                const truncatedTitle = truncateText(cleanTitle, 50); [cite_start]/* [cite: 503] */

                return `
                <div class="grid-card-selector ${viewedClass} ${newClass}" data-theme-id="${item.id}" data-theme-type="${themeType}" title="${item.description || cleanTitle}">
                     <div class="icon">${getIconForTheme(themeType, item.id)}</div>
                     <div class="viewed-indicator">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                     </div>
                    <div class="mt-2 overflow-hidden">
                        <div class="text-sm font-normal leading-tight block">${truncatedTitle}</div>
                    </div>
                 </div>`; [cite_start]/* [cite: 503] */
            }).join('');
            
            const fullPrompt = fullPrompts[themeType]; [cite_start]/* [cite: 505] */
            let actionButtonsHtml = ''; [cite_start]/* [cite: 505] */
            if (fullPrompt && data.length < 35 && data.length > 0) {
                actionButtonsHtml = `
                    <div class="col-span-full text-center mt-4">
                        <button class="show-all-button btn-secondary" data-container-id="${containerId}" data-theme-type="${themeType}">
                     
                             Show All (${data.length} of ~50 shown)
                        </button>
                    </div>`; [cite_start]/* [cite: 506] */
            } 
            else if (fullPrompt && data.length >= 35) {
                actionButtonsHtml = `
                    <div class="col-span-full text-center mt-4">
                        <button class="generate-more-button btn-secondary" data-container-id="${containerId}" data-theme-type="${themeType}" title="Use AI to generate more topics for this category">
  
                             <span class="flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                  
                                 Generate 10 More
                            </span>
                        </button>
                    </div>`; [cite_start]/* [cite: 508] */
            }

            container.innerHTML = `<div class="${gridClass}">${itemsHtml}</div>${actionButtonsHtml}`; [cite_start]/* [cite: 511] */
        }

        async function handleGenerateMoreClick(button) {
            const { containerId, themeType } = button.dataset; [cite_start]/* [cite: 512] */
            const container = document.getElementById(containerId); [cite_start]/* [cite: 513] */
            if (!container || !themeType || !allThemeData[themeType]) return; [cite_start]/* [cite: 513] */

            button.disabled = true; [cite_start]/* [cite: 513] */
            button.innerHTML = `<span class="flex items-center justify-center gap-2"><div class="loader themed-loader" style="width:20px; height:20px; border-width: 2px;"></div>Generating...</span>`; [cite_start]/* [cite: 514] */

            const card = container.closest('.card'); [cite_start]/* [cite: 514] */
            const categoryTitle = card.querySelector('h2').textContent; [cite_start]/* [cite: 515] */
            const existingTitles = allThemeData[themeType].map(item => item.title); [cite_start]/* [cite: 515] */
            const prompt = `Generate 10 new and unique administrative task ideas for the IT category "${categoryTitle}". These tasks must be different from the ones in the following list. Existing Task List:
            - ${existingTitles.join('\n- ')}

            For each new task, provide a unique "id", a "title", and a short "description". IMPORTANT: Ensure that any double quotes inside the description are properly escaped (e.g., \\"example\\"). Return ONLY a valid JSON array of the 10 new items.`; [cite_start]/* [cite: 515] */
            try {
                const jsonText = await callGeminiAPI(prompt, true); [cite_start]/* [cite: 521] */
                if (!jsonText) throw new Error("AI did not return any new items."); [cite_start]/* [cite: 522] */

                const newItems = parseJsonWithCorrections(jsonText); [cite_start]/* [cite: 522] */
                const newItemIds = new Set(newItems.map(item => item.id)); [cite_start]/* [cite: 523] */
                
                newItems.forEach(newItem => {
                    if (!allThemeData[themeType].some(existing => existing.id === newItem.id || existing.title === newItem.title)) {
                        [cite_start]allThemeData[themeType].push(newItem); /* [cite: 523] */
                    }
                });
                allThemeData[themeType].sort((a, b) => a.title.localeCompare(b.title)); [cite_start]/* [cite: 524] */
                populateCardGridSelector(containerId, themeType, newItemIds); [cite_start]/* [cite: 524] */
                document.getElementById(`${themeType}-details`).innerHTML = ''; [cite_start]/* [cite: 524] */
            } catch (error) {
                console.error(`Error generating more items for ${themeType}:`, error); [cite_start]/* [cite: 525] */
                const originalButtonContent = `<span class="flex items-center justify-center gap-2">...</span>`; [cite_start]/* [cite: 526] */
                button.disabled = false; [cite_start]/* [cite: 526] */
                button.innerHTML = originalButtonContent.replace('...', 'Error. Try Again.'); [cite_start]/* [cite: 526] */
                button.classList.add('bg-red-100', 'text-red-700'); [cite_start]/* [cite: 526] */
                setTimeout(() => {
                    [cite_start]button.classList.remove('bg-red-100', 'text-red-700'); /* [cite: 527] */
                    button.innerHTML = originalButtonContent.replace('...', `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Generate 10 More`); [cite_start]/* [cite: 527] */
                }, 3000);
            } 
        }
        
        async function handleShowAllClick(button) {
            const { containerId, themeType } = button.dataset; [cite_start]/* [cite: 528] */
            const container = document.getElementById(containerId); [cite_start]/* [cite: 529] */
            const fullPrompt = fullPrompts[themeType]; [cite_start]/* [cite: 529] */

            if (!container || !fullPrompt) return; [cite_start]/* [cite: 529] */

            button.disabled = true; [cite_start]/* [cite: 529] */
            button.innerHTML = `<span class="flex items-center justify-center gap-2"><div class="loader themed-loader" style="width:20px; height:20px; border-width: 2px;"></div>Loading all...</span>`; [cite_start]/* [cite: 530] */
            try {
                const jsonText = await callGeminiAPI(fullPrompt, true); [cite_start]/* [cite: 531] */
                if (!jsonText) throw new Error(`API returned empty content for ${themeType} (full list).`); [cite_start]/* [cite: 532] */
                const fullData = parseJsonWithCorrections(jsonText); [cite_start]/* [cite: 532] */
                fullData.sort((a, b) => a.title.localeCompare(b.title)); [cite_start]/* [cite: 532] */
                allThemeData[themeType] = fullData; [cite_start]/* [cite: 533] */
                populateCardGridSelector(containerId, themeType); [cite_start]/* [cite: 533] */
                document.getElementById(`${themeType}-details`).innerHTML = ''; [cite_start]/* [cite: 533] */
            } catch (error) {
                button.disabled = false; [cite_start]/* [cite: 533] */
                button.classList.add('bg-red-100', 'text-red-700'); [cite_start]/* [cite: 534] */
                button.textContent = "Error. Try again."; [cite_start]/* [cite: 534] */
                console.error(`Error loading full list for ${themeType}:`, error); [cite_start]/* [cite: 534] */
            }
        }

        async function handleGridSelect(target) {
            const { themeId, themeType } = target.dataset; [cite_start]/* [cite: 535] */
            const item = allThemeData[themeType]?.find(d => String(d.id) == String(themeId)); [cite_start]/* [cite: 536] */
            if (!item) {
                console.error("Could not find theme item for:", {themeId, themeType}); [cite_start]/* [cite: 536] */
                return;
            }
            
            const card = target.closest('.card'); [cite_start]/* [cite: 537] */
            const cardTitle = card.querySelector('h2').textContent; [cite_start]/* [cite: 538] */
            const cardDescription = card.querySelector('p').textContent; [cite_start]/* [cite: 538] */

            const prompt = `
                You are creating a summary for an IT administration guide. [cite_start]/* [cite: 539] */
                The overall category is: "${cardTitle}"
                The category description is: "${cardDescription}"
                The specific topic is: "${item.title}"

                Based on this context, generate a very brief, condensed summary for the guide on "${item.title}". [cite_start]/* [cite: 540] */
                For each section (Objective, Pre-requisites, Key Steps, Verification, Helpful Resources), provide a single descriptive sentence. [cite_start]/* [cite: 541] */
                Return the response as a simple markdown string where each section is a bullet point, starting with '*'. [cite_start]/* [cite: 542] */
            `;
            const resultContainer = document.getElementById(`${themeType}-details`); [cite_start]/* [cite: 543] */
            resultContainer.innerHTML = getLoaderHTML(`Generating summary for ${item.title}...`); [cite_start]/* [cite: 543] */
            try {
                let resultText = await callGeminiAPI(prompt); [cite_start]/* [cite: 544] */
                resultText = resultText ? resultText.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : ''; [cite_start]/* [cite: 545] */
                
                const compositeKey = `${cardTitle} - ${item.title}`; [cite_start]/* [cite: 545] */
                originalGeneratedText.set(compositeKey, resultText); 
                
                const resultHtml = marked.parse(resultText || ''); [cite_start]/* [cite: 545] */
                resultContainer.innerHTML = `<div class="prose max-w-none">${resultHtml}</div>`; [cite_start]/* [cite: 546] */

                addPostGenerationButtons(resultContainer, themeId, themeType); [cite_start]/* [cite: 546] */
            } catch (error) {
                handleApiError(error, resultContainer, `guide for ${item.title}`); [cite_start]/* [cite: 546] */
            }
        }
        
        async function markItemAsViewed(cardTitle, buttonTitle) {
            if (!viewedItemsCollectionRef) return; [cite_start]/* [cite: 547] */
            const compositeKey = `${cardTitle} - ${buttonTitle}`; [cite_start]/* [cite: 548] */
            
            if (viewedItemIds.has(compositeKey)) return;

            try {
                const docRef = doc(viewedItemsCollectionRef, compositeKey); [cite_start]/* [cite: 548] */
                await setDoc(docRef, { 
                    [cite_start]viewedAt: Timestamp.fromDate(new Date())  /* [cite: 549] */
                });
            } catch (error) {
                console.error("Error marking item as viewed:", error); [cite_start]/* [cite: 550] */
            }
        }

        async function handleGeminiSubmit(e) {
            e.preventDefault(); [cite_start]/* [cite: 551] */
            const promptInput = document.getElementById('gemini-prompt'); [cite_start]/* [cite: 552] */
            let userPrompt = promptInput.value.trim(); [cite_start]/* [cite: 552] */
            if (!userPrompt) return; [cite_start]/* [cite: 552] */
            const selectedOptions = Array.from(document.querySelectorAll('#tailoring-buttons-container .btn-toggle.active'))
                                        .map(btn => btn.textContent.trim())
                                        .join(', '); [cite_start]/* [cite: 553] */
            const prompt = getEnhancedPrompt(userPrompt, selectedOptions); [cite_start]/* [cite: 554] */

            const resultContainer = document.getElementById('gemini-result-container'); [cite_start]/* [cite: 554] */
            resultContainer.innerHTML = getLoaderHTML('Generating your custom AI guide...'); [cite_start]/* [cite: 554] */
            try {
                let resultText = await callGeminiAPI(prompt); [cite_start]/* [cite: 555] */
                resultText = resultText ? resultText.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : ''; [cite_start]/* [cite: 556] */
                
                originalGeneratedText.set('custom-plan', resultText); [cite_start]/* [cite: 556] */
                renderAccordionFromMarkdown(resultText, resultContainer); [cite_start]/* [cite: 556] */
                addPostGenerationButtons(resultContainer, 'custom-plan', 'custom'); [cite_start]/* [cite: 556] */
                generateAndInjectImages(resultContainer); [cite_start]/* [cite: 556] */
            } catch(error) {
                handleApiError(error, resultContainer, 'custom IT guide'); [cite_start]/* [cite: 557] */
            }
        }

        function parseJsonWithCorrections(jsonString) {
            if (!jsonString || typeof jsonString !== 'string') {
                throw new Error("Invalid input: not a string."); [cite_start]/* [cite: 558] */
            }
            let cleanedString = jsonString.replace(/```(json|markdown)?\n?/g, '').replace(/```/g, '').trim(); [cite_start]/* [cite: 559] */
            // Attempt to fix common JSON errors from the API
            // 1. Remove trailing commas before closing curly braces or brackets
            cleanedString = cleanedString.replace(/,\s*(}|])/g, '$1'); [cite_start]/* [cite: 560] */
            // 2. Fix improperly escaped single quotes which are invalid in JSON
            cleanedString = cleanedString.replace(/\\'/g, "'"); [cite_start]/* [cite: 561] */
            // 3. Fix unescaped backslashes (common in file paths) that are not part of a valid escape sequence.
            // This looks for a backslash that is NOT followed by a double quote, another backslash, or any of the other valid escape characters. [cite_start]/* [cite: 562] */
            [cite_start]cleanedString = cleanedString.replace(/\\(?!["\\/bfnrtu])/g, '\\\\'); /* [cite: 564] */

            try {
                return JSON.parse(cleanedString); [cite_start]/* [cite: 564] */
            } catch (error) {
                console.error("Failed to parse JSON even after cleaning:", error); [cite_start]/* [cite: 564] */
                console.error("Original string:", jsonString); [cite_start]/* [cite: 564] */
           
                 console.error("Cleaned string:", cleanedString); [cite_start]/* [cite: 565] */
                throw new Error(`JSON Parse Error: ${error.message}. Check console for the problematic string.`); [cite_start]/* [cite: 565] */
            }
        }

        async function callApi(apiUrl, payload) {
            const controller = new AbortController(); [cite_start]/* [cite: 565] */
            const timeoutId = setTimeout(() => controller.abort(), 
            60000); [cite_start]/* [cite: 566] */

            try {
                const response = await fetch(apiUrl, {
                    [cite_start]method: 'POST', /* [cite: 566] */
                    [cite_start]headers: { 'Content-Type': 'application/json' }, /* [cite: 566] */
                    body: 
                    [cite_start]JSON.stringify(payload), /* [cite: 567] */
                    [cite_start]signal: controller.signal /* [cite: 567] */
                });
                clearTimeout(timeoutId); [cite_start]/* [cite: 568] */

                if (!response.ok) {
                    let errorBody; [cite_start]/* [cite: 568] */
                    try { errorBody = await response.json(); } catch { errorBody = await response.text(); [cite_start]/* [cite: 569] */ }
                    console.error("API Error Response:", errorBody); [cite_start]/* [cite: 570] */
                    const errorMsg = errorBody?.error?.message || response.statusText; [cite_start]/* [cite: 571] */
                    throw new Error(`API request failed with status ${response.status}. Message: ${errorMsg}`); [cite_start]/* [cite: 571] */
                }
                return await response.json(); [cite_start]/* [cite: 572] */
            } catch (error) {
                clearTimeout(timeoutId); [cite_start]/* [cite: 573] */
                if (error.name === 'AbortError') throw new Error('The AI service request timed out. Please try again.'); [cite_start]/* [cite: 574] */
                throw error; [cite_start]/* [cite: 574] */
            }
        }

        async function callGeminiAPI(prompt, isJson = false) {
            const payload = { contents: [{ parts: [{ text: prompt }] }] }; [cite_start]/* [cite: 575] */
            if (isJson) {
                payload.generationConfig = { responseMimeType: "application/json", maxOutputTokens: 8192 }; [cite_start]/* [cite: 576] */
            }
            const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`, payload); [cite_start]/* [cite: 577] */
            return result?.candidates?.[0]?.content?.parts?.[0]?.text || null; [cite_start]/* [cite: 578] */
        }

        async function callImageGenAPI(prompt) {
            const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } }; [cite_start]/* [cite: 578] */
            const result = await callApi(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${geminiApiKey}`, payload); [cite_start]/* [cite: 579] */
            const base64 = result?.predictions?.[0]?.bytesBase64Encoded; [cite_start]/* [cite: 579] */
            return base64 ? `data:image/png;base64,${base64}` : null; [cite_start]/* [cite: 579] */
        }
        
        async function callColorGenAPI(prompt) {
            const fullPrompt = `Based on the theme "${prompt}", generate a color palette. I need a JSON object with keys: "bg", "text", "primary", "primaryDark", "accent", "cardBg", "cardBorder", "textMuted", "inputBg", "inputBorder", "buttonText". Determine if the "primary" color is light or dark to set the "buttonText" appropriately (#FFFFFF for dark, #111827 for light). Return only the complete, valid JSON object.`; [cite_start]/* [cite: 580] */
            const jsonText = await callGeminiAPI(fullPrompt, true); [cite_start]/* [cite: 583] */
            if (jsonText) return parseJsonWithCorrections(jsonText); [cite_start]/* [cite: 583] */
            throw new Error("Could not parse a valid color theme from API response."); [cite_start]/* [cite: 584] */
        }

        function handleApiError(error, container, contentType = 'content') {
            console.error(`Error generating ${contentType}:`, error); [cite_start]/* [cite: 585] */
            const errorMessage = generateErrorMessage(error, contentType); [cite_start]/* [cite: 586] */
            if (container) {
                container.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">${errorMessage}</div>`; [cite_start]/* [cite: 586] */
            }
        }
        
        async function generateAndApplyDefaultTheme() {
            showThemeLoading(true); [cite_start]/* [cite: 587] */
            const themePrompt = "Modern Data Center"; [cite_start]/* [cite: 588] */
            const imagePrompt = `Artistic, abstract background image inspired by "${themePrompt}". Suitable for an IT administration website. Professional, clean. Wide aspect ratio, photographic, cinematic lighting.`; [cite_start]/* [cite: 588] */
            try {
                const [colorResult, imageResult] = await Promise.allSettled([callColorGenAPI(themePrompt), callImageGenAPI(imagePrompt)]); [cite_start]/* [cite: 590] */
                if (colorResult.status === 'fulfilled' && colorResult.value) applyTheme(colorResult.value); [cite_start]/* [cite: 591] */
                else throw colorResult.reason || new Error("Failed to generate color theme."); [cite_start]/* [cite: 591] */
                if (imageResult.status === 'fulfilled' && imageResult.value) applyHeaderImage(imageResult.value); [cite_start]/* [cite: 592] */
                else throw imageResult.reason || new Error("Failed to generate header image."); [cite_start]/* [cite: 592] */
            } catch (error) {
                handleApiError(null, null, 'default theme'); [cite_start]/* [cite: 593] */
                throw error; [cite_start]/* [cite: 594] */
            } finally {
                showThemeLoading(false); [cite_start]/* [cite: 594] */
            }
        }
        
        async function loadAITailoringOptions() {
            const container = document.getElementById('tailoring-buttons-container'); [cite_start]/* [cite: 595] */
            container.innerHTML = getLoaderHTML('Loading AI options...'); [cite_start]/* [cite: 596] */
            try {
                const prompt = `Generate a comprehensive list of 40-50 diverse keywords and concepts for tailoring IT administration guides. The list should cover a wide range of topics including security, performance, automation, specific technologies (like PowerShell, Ansible), methodologies (like IaC), and user levels (like 'for beginners', 'for experts'). Return ONLY a valid JSON array of strings. IMPORTANT: Ensure any double quotes inside the strings are properly escaped.`; [cite_start]/* [cite: 596] */
                const jsonText = await callGeminiAPI(prompt, true); [cite_start]/* [cite: 599] */
                if (!jsonText) {
                    throw new Error("AI did not return any tailoring options."); [cite_start]/* [cite: 599] */
                }
                const options = parseJsonWithCorrections(jsonText); [cite_start]/* [cite: 600] */
                populateTailoringButtons(options); [cite_start]/* [cite: 601] */
            } catch (error) {
                handleApiError(error, container, 'tailoring options'); [cite_start]/* [cite: 601] */
                const fallbackOptions = ["Security Hardening", "Performance Tuning", "Automation Script", "For Beginners"]; [cite_start]/* [cite: 602] */
                populateTailoringButtons(fallbackOptions); [cite_start]/* [cite: 602] */
            }
        }


        function populateTailoringButtons(options) {
            const container = document.getElementById('tailoring-buttons-container'); [cite_start]/* [cite: 603] */
            container.innerHTML = options.map(option =>
                `<button type="button" class="btn-toggle text-sm px-3 py-1 rounded-full">${option}</button>`
            ).join(''); [cite_start]/* [cite: 604] */
        }
        
        async function loadDynamicPlaceholders() {
            const promptInput = document.getElementById('gemini-prompt'); [cite_start]/* [cite: 605] */
            const prompt = `Generate a JSON array of 3 creative IT administration task ideas for input placeholders. Examples: "Onboard a new employee", "Decommission a legacy server". Return ONLY the valid JSON array of strings, ensuring any double quotes inside the strings are properly escaped (e.g., \\"like this\\").`; [cite_start]/* [cite: 605] */
            try {
                const jsonText = await callGeminiAPI(prompt, true); [cite_start]/* [cite: 608] */
                if(!jsonText) return; [cite_start]/* [cite: 609] */
                const placeholders = parseJsonWithCorrections(jsonText); [cite_start]/* [cite: 609] */
                if (placeholders && placeholders.length > 0) {
                    let i = 0; [cite_start]/* [cite: 609] */
                    promptInput.placeholder = `e.g., '${placeholders[i]}'`; [cite_start]/* [cite: 610] */
                    setInterval(() => {
                        [cite_start]i = (i + 1) % placeholders.length; /* [cite: 610] */
                        promptInput.placeholder = `e.g., '${placeholders[i]}'`; [cite_start]/* [cite: 610] */
                    }, 3000);
                }
            } catch(error) {
                console.error("Could not load dynamic placeholders", error); [cite_start]/* [cite: 611] */
            }
        }

        function applyTheme(colors) {
            Object.entries(colors).forEach(([key, value]) => {
                [cite_start]const cssVar = `--color-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`; /* [cite: 612] */
                root.style.setProperty(cssVar, value); [cite_start]/* [cite: 612] */
            });
        }
        
        function applyHeaderImage(imageUrl) {
            const bgImageDiv = document.getElementById('header-bg-image'); [cite_start]/* [cite: 613] */
            bgImageDiv.style.backgroundImage = `url('${imageUrl}')`; [cite_start]/* [cite: 614] */
        }

        function showThemeLoading(isLoading) {
            const loader = document.getElementById('header-loader'); [cite_start]/* [cite: 614] */
            loader.classList.toggle('hidden', !isLoading); [cite_start]/* [cite: 615] */
            loader.classList.toggle('flex', isLoading); [cite_start]/* [cite: 615] */
        }
        
        function getAppPrompts() {
            return {
                [cite_start]"Generate Detailed Guide": getEnhancedPrompt("{task}", "", "", { cardTitle: "{cardTitle}", cardDescription: "{cardDescription}" }), /* [cite: 615] */
                [cite_start]"Refine Existing Guide": getEnhancedPrompt("{refinement_request}", "", "{original_text}"), /* [cite: 615] */
                [cite_start]"Generate In-Depth Guide": getEnhancedPrompt("{item_title}"), /* [cite: 615] */
                "Generate Summary": `Generate a very brief, condensed summary for an IT administration guide on the topic: "{item.title}". For each section (Objective, Pre-requisites, Key Steps, Verification, Helpful Resources), provide a single descriptive sentence. [cite_start]Return the response as a simple markdown string where each section is a bullet point, starting with '*'.`, /* [cite: 616] */
                "Generate UI Screenshot": `UI Screenshot for an IT Administration guide showing: {description}. [cite_start]Clean, professional, minimal.`, /* [cite: 618] */
                "Generate Color Theme": `Based on the theme "{prompt}", generate a color palette. I need a JSON object with keys: "bg", "text", "primary", "primaryDark", "accent", "cardBg", "cardBorder", "textMuted", "inputBg", "inputBorder", "buttonText". Determine if the "primary" color is light or dark to set the "buttonText" appropriately (#FFFFFF for dark, #111827 for light). [cite_start]Return only the complete, valid JSON.`, /* [cite: 619] */
                "Discover New Topic": `Generate 1 new, useful IT administration category NOT on this list: {existing_titles}. Provide a "key" (camelCase, unique), "title", "description", an "initialPrompt" (for 10 items), and a "fullPrompt" (for 40-50). Prompts must request a JSON array of objects, each with id, title, and description. [cite_start]Return ONLY a valid JSON object.`, /* [cite: 622] */
                "Gemini CLI Guide": `Generate 10 common use cases for the Gemini CLI. For each, give a unique "id", "title", and a short "description". [cite_start]Return ONLY a valid JSON array.` /* [cite: 625] */
            };
        }
        
        function displayPromptsInModal() {
            const modal = document.getElementById('promptsModal'); [cite_start]/* [cite: 628] */
            const contentEl = document.getElementById('promptsModalContent'); [cite_start]/* [cite: 629] */
            contentEl.innerHTML = '';  [cite_start]/* [cite: 629] */

            const prompts = getAppPrompts(); [cite_start]/* [cite: 629] */
            for (const [title, promptText] of Object.entries(prompts)) {
                const promptContainer = document.createElement('div'); [cite_start]/* [cite: 630] */
                promptContainer.className = 'mb-6'; [cite_start]/* [cite: 631] */
                
                const promptTitle = document.createElement('h3'); [cite_start]/* [cite: 631] */
                promptTitle.className = 'text-lg font-semibold themed-text-accent mb-2'; [cite_start]/* [cite: 631] */
                promptTitle.textContent = title; [cite_start]/* [cite: 631] */
                promptContainer.appendChild(promptTitle); [cite_start]/* [cite: 631] */
                const codeBlockContainer = document.createElement('div'); [cite_start]/* [cite: 632] */
                codeBlockContainer.className = 'code-block-container !mt-0'; [cite_start]/* [cite: 632] */
                
                const header = document.createElement('div'); [cite_start]/* [cite: 632] */
                header.className = 'code-block-header'; [cite_start]/* [cite: 632] */
                header.innerHTML = `<span>Prompt</span><button class="copy-code-button">Copy</button>`; [cite_start]/* [cite: 632] */
                codeBlockContainer.appendChild(header); [cite_start]/* [cite: 632] */
                const pre = document.createElement('pre'); [cite_start]/* [cite: 633] */
                pre.className = 'text-sm'; [cite_start]/* [cite: 633] */
                pre.style.color = 'var(--code-text)'; [cite_start]/* [cite: 633] */
                pre.textContent = promptText; [cite_start]/* [cite: 633] */
                codeBlockContainer.appendChild(pre); [cite_start]/* [cite: 633] */
                
                promptContainer.appendChild(codeBlockContainer); [cite_start]/* [cite: 633] */
                contentEl.appendChild(promptContainer); [cite_start]/* [cite: 633] */
            }

            modal.classList.remove('hidden'); [cite_start]/* [cite: 634] */
        }


        function getEnhancedPrompt(task, options = '', originalText = '', context = {}) {
            const optionsText = options ?
            `With a special focus on these elements: ${options}.` : ''; [cite_start]/* [cite: 635] */
            if (originalText) {
                // Refinement Prompt
                return `You are an expert senior IT administrator AI. A user has provided an IT guide and a request to refine it. Your task is to rewrite the entire guide to incorporate the user's request, structuring the new guide into the most logical sections possible.
**ORIGINAL IT GUIDE:**
---
${originalText}
---

**USER'S REFINEMENT REQUEST:**
"${task}"

**Instructions for rewriting:**
1.  **Structure:** Do not use the old section headers unless they are still the most logical choice. Instead, create new, clear, and descriptive section headers using '###' markdown syntax based on the refined content. [cite_start]/* [cite: 637] */
2.  **Integrate:** Seamlessly integrate the user's request into the guide. [cite_start]/* [cite: 642] */
3.  **Quality Standards:** The entire rewritten guide must still meet these requirements for the specific technology being discussed:
    * **Authoritative Links:** Embed hyperlinks to official vendor documentation, relevant articles, or other authoritative sources. [cite_start]/* [cite: 643] */
    * **Code Blocks:** When providing code examples, wrap them in markdown code fences with the language specified (e.g., \`\`\`powershell\`). [cite_start]/* [cite: 644] */
    * **Screenshot Placeholders:** Include placeholders for screenshots where visual context is beneficial. [cite_start]/* [cite: 645] */
    * Use the format: [Screenshot: A clear, concise description for an AI image generator to create a UI screenshot]. [cite_start]/* [cite: 646] */
    * **Practicality:** Ensure all advice, steps, and examples are practical and reflect real-world scenarios. [cite_start]/* [cite: 647] */
    * **Helpful Resources:** Ensure there is a final section with a bulleted list of high-quality, relevant links. [cite_start]/* [cite: 648] */
Return only the new, complete, and rewritten markdown guide.`; [cite_start]/* [cite: 648] */
            }

            // In-depth and Custom Guide Generation Prompt
            let contextText = `for the task: "${task}"`; [cite_start]/* [cite: 649] */
            if (context.cardTitle) {
                contextText = `for the following topic.
- **Category:** "${context.cardTitle}"
- **Topic Description:** "${context.cardDescription}"
- **Specific Task:** "${task}"`; [cite_start]/* [cite: 650] */
            }

            return `You are an expert senior IT administrator AI. Generate a comprehensive and practical guide ${contextText}. ${optionsText}

Your task is to structure this guide into the most logical and helpful sections. [cite_start]/* [cite: 651] */
For each section, create a clear and descriptive header using '###' markdown syntax. [cite_start]/* [cite: 653] */
The content within each section should be detailed and practical. [cite_start]/* [cite: 654] */
When generating the guide, ensure the guide as a whole meets the following requirements for the specific technology being discussed:

1.  **Authoritative Links:** Throughout the guide, embed hyperlinks to official vendor documentation, relevant articles, or other authoritative sources. [cite_start]/* [cite: 655] */
2.  **Code Blocks:** When providing code examples (like PowerShell), wrap them in markdown code fences with the language specified, like \`\`\`powershell... \`\`\`. [cite_start]/* [cite: 656] */
3.  **Prerequisites:** Create a dedicated "Prerequisites" section that details relevant administrative roles, permissions, and any specific licensing requirements. [cite_start]/* [cite: 657] */
4.  **Verification:** Include a section on how to verify the task was successful, mentioning practical, real-world details (e.g., specific logs to check). [cite_start]/* [cite: 658] */
5.  **Troubleshooting:** Include a section covering common problems that administrators face. [cite_start]/* [cite: 659] */
6.  **Helpful Resources:** Include a final section with a bulleted list of high-quality, relevant links to official documentation, tutorials, or tools. [cite_start]/* [cite: 660] */
7.  **Screenshot Placeholders:** In the 'Step-by-Step Guide' or equivalent section, include placeholders for screenshots where visual context would be beneficial. [cite_start]/* [cite: 661] */
Use the format: [Screenshot: A clear, concise description for an AI image generator to create a UI screenshot]. [cite_start]/* [cite: 662] */
Return only the complete markdown guide.`; [cite_start]/* [cite: 663] */
        }
        
        function convertMarkdownToHtml(text, generateImages = true) {
            if (!text) return '<p class="themed-text-muted">No content received from AI. Please try a different prompt.</p>'; [cite_start]/* [cite: 663] */

            let processedText; [cite_start]/* [cite: 664] */
            if (generateImages) {
                processedText = text.replace(/\[Screenshot: (.*?)\]/g, (match, description) => {
                    [cite_start]const placeholderId = `image-placeholder-${Date.now()}-${Math.random()}`; /* [cite: 664] */
                    return `<div id="${placeholderId}" class="image-generation-container" data-prompt="${description.replace(/"/g, '&quot;')}">
                    
                             <div class="loader themed-loader"></div>
                                <p class="mt-2 text-sm italic">${description}</p>
                            [cite_start]</div>`; /* [cite: 664] */
                });
       
             } else {
                processedText = text.replace(/\[Screenshot: (.*?)\]/g, ''); [cite_start]/* [cite: 666] */
            }


            let html = marked.parse(processedText); [cite_start]/* [cite: 666] */
            const tempDiv = document.createElement('div'); [cite_start]/* [cite: 666] */
            tempDiv.innerHTML = html; [cite_start]/* [cite: 666] */

            tempDiv.querySelectorAll('pre').forEach(preBlock => {
   
                 [cite_start]if (preBlock.parentElement.classList.contains('code-block-container')) return; /* [cite: 667] */

                const codeBlock = preBlock.querySelector('code'); [cite_start]/* [cite: 667] */
                const lang = codeBlock ? (Array.from(codeBlock.classList).find(c => c.startsWith('language-'))?.replace('language-', '') || 'text') : 'text'; [cite_start]/* [cite: 668] */
                
                const container = document.createElement('div'); [cite_start]/* [cite: 668] */
                container.className = 'code-block-container'; [cite_start]/* [cite: 668] */
                const header = document.createElement('div'); [cite_start]/* [cite: 669] */
                header.className = 'code-block-header'; [cite_start]/* [cite: 669] */
                header.innerHTML = `
                    <span>${lang}</span>
                    <button class="copy-code-button">Copy</button>
                `; [cite_start]/* [cite: 669] */
                container.appendChild(header); [cite_start]/* [cite: 670] */
                preBlock.parentNode.insertBefore(container, preBlock); [cite_start]/* [cite: 670] */
                container.appendChild(preBlock); [cite_start]/* [cite: 670] */
            });

            return tempDiv.innerHTML; [cite_start]/* [cite: 670] */
        }

        async function generateAndInjectImages(container) {
            const placeholders = container.querySelectorAll('.image-generation-container'); [cite_start]/* [cite: 670] */
            if (placeholders.length === 0) return; [cite_start]/* [cite: 671] */

            placeholders.forEach(async (placeholder) => {
                [cite_start]const prompt = placeholder.dataset.prompt; /* [cite: 671] */
                const imagePrompt = `UI Screenshot for an IT Administration guide showing: ${prompt}. Clean, professional, minimal.`; [cite_start]/* [cite: 671] */
                try {
                    const imageUrl = await callImageGenAPI(imagePrompt); [cite_start]/* [cite: 671] */
  
                      if (imageUrl) {
                        placeholder.innerHTML = `<img src="${imageUrl}" alt="${prompt}">`; [cite_start]/* [cite: 672] */
                    } else {
                        throw new Error('API returned no image.'); [cite_start]/* [cite: 672] */
 
                     }
                } catch (error) {
                    console.error(`Failed to generate image for prompt: "${prompt}"`, error); [cite_start]/* [cite: 673] */
                    placeholder.innerHTML = `<p class="text-red-500 text-sm">Image generation failed.</p><p class="text-xs">${prompt}</p>`; [cite_start]/* [cite: 673] */
        
                 }
            });
        }


        function addPostGenerationButtons(container, themeId, themeType) {
            let buttonBar = container.querySelector('.button-bar'); [cite_start]/* [cite: 675] */
            if (buttonBar) buttonBar.remove(); [cite_start]/* [cite: 676] */

            buttonBar = document.createElement('div'); [cite_start]/* [cite: 676] */
            buttonBar.className = 'button-bar flex flex-wrap gap-2 mt-4 pt-4 border-t'; [cite_start]/* [cite: 676] */
            buttonBar.style.borderColor = 'var(--color-card-border)'; [cite_start]/* [cite: 676] */
            
            const originalTextKey = (themeType === 'custom') ? 'custom-plan' : `${container.closest('.card').querySelector('h2').textContent} - ${allThemeData[themeType].find(d => String(d.id) == String(themeId)).title}`;

            buttonBar.innerHTML = `
                <button class="btn-secondary text-sm refine-button">Refine with AI</button>
                <button class="btn-secondary text-sm copy-button">Copy Text</button>
                <button class="btn-secondary text-sm explore-button" data-theme-id="${themeId}" data-theme-type="${themeType}">Explore In-Depth</button>
                <button class="btn-secondary text-sm generate-script-button" data-text-key="${originalTextKey}">Generate Script</button>
                <button class="btn-secondary text-sm generate-cheatsheet-button" data-text-key="${originalTextKey}">Generate Cheat Sheet</button>
            `; [cite_start]/* [cite: 677] */
            container.appendChild(buttonBar); [cite_start]/* [cite: 678] */
            buttonBar.querySelector('.copy-button').addEventListener('click', e => {
                [cite_start]const contentToCopy = e.target.closest('.details-container, #gemini-result-container'); /* [cite: 678] */
                if(contentToCopy) copyElementTextToClipboard(contentToCopy, e.target); [cite_start]/* [cite: 678] */
            });
        }

        async function handleUtilityModal(title, prompt) {
            const modal = document.getElementById('utilityModal');
            const titleEl = document.getElementById('utilityModalTitle');
            const contentEl = document.getElementById('utilityModalContent');
            
            titleEl.textContent = title;
            contentEl.innerHTML = getLoaderHTML(`AI is generating your ${title.toLowerCase()}...`);
            modal.classList.remove('hidden');

            try {
                let resultText = await callGeminiAPI(prompt);
                resultText = resultText ? resultText.replace(/^```(markdown|powershell|bash|sh)?\n?/g, '').replace(/\n?```$/g, '').trim() : '';
                
                // For script, wrap it in a proper code block if not already
                if (title.toLowerCase().includes('script') && !resultText.includes('class="code-block-container"')) {
                     contentEl.innerHTML = convertMarkdownToHtml(`\`\`\`powershell\n${resultText}\n\`\`\``, false);
                } else { // For cheat sheet, it should be markdown
                    contentEl.innerHTML = convertMarkdownToHtml(resultText, false);
                }

            } catch (error) {
                handleApiError(error, contentEl, title);
            }
        }

        function handleGenerateScriptClick(button) {
            const textKey = button.dataset.textKey;
            const originalText = originalGeneratedText.get(textKey);
            if (!originalText) {
                alert("Could not find the guide's content. Please generate the guide first.");
                return;
            }
            const prompt = `Based on the following IT guide, generate a functional PowerShell script to automate the described task.\n\n**Guide Content:**\n${originalText}\n\n**Instructions:**\n1. The script should be functional and include comments for clarity.\n2. Use placeholders like <YourParameter> for user-specific input.\n3. Include error handling.\n4. Return ONLY the PowerShell code block, nothing else.`;
            handleUtilityModal("PowerShell Script", prompt);
        }

        function handleGenerateCheatSheetClick(button) {
            const textKey = button.dataset.textKey;
            const originalText = originalGeneratedText.get(textKey);
            if (!originalText) {
                alert("Could not find the guide's content. Please generate the guide first.");
                return;
            }
            const prompt = `Analyze the following IT guide and generate a concise command-line cheat sheet.\n\n**Guide Content:**\n${originalText}\n\n**Instructions:**\n1. Extract the most critical commands (e.g., PowerShell, bash).\n2. Present them in a markdown table with "Command" and "Description" columns.\n3. Keep descriptions brief.\n4. Return ONLY the markdown table.`;
            handleUtilityModal("Command Cheat Sheet", prompt);
        }


        async function handleDiscoverMoreClick() {
            const button = document.getElementById('discover-more-button'); [cite_start]/* [cite: 679] */
            const errorP = document.getElementById('discover-more-error'); [cite_start]/* [cite: 680] */
            errorP.textContent = ''; [cite_start]/* [cite: 680] */
            button.disabled = true; [cite_start]/* [cite: 680] */

            const existingTitles = Array.from(document.querySelectorAll('#main-grid h2')).map(h2 => h2.textContent); [cite_start]/* [cite: 680] */
            const prompt = `Generate 1 new, useful IT administration category NOT on this list: ${existingTitles.join(', ')}. Provide a "key" (camelCase, unique), "title", "description", an "initialPrompt" (for 10 items), and a "fullPrompt" (for 40-50). Prompts must request a JSON array of objects, each with id, title, and description. IMPORTANT: Ensure any double quotes in string values are properly escaped (e.g., \\"like this\\"). Return ONLY a valid JSON object.`; [cite_start]/* [cite: 681] */
            try {
                const jsonText = await callGeminiAPI(prompt, true); [cite_start]/* [cite: 685] */
                if (!jsonText) throw new Error("AI did not return a new category."); [cite_start]/* [cite: 686] */
                const newCategory = parseJsonWithCorrections(jsonText); [cite_start]/* [cite: 686] */
                await generateAndPopulateAICategory(newCategory); [cite_start]/* [cite: 686] */
                await generateJumpToButtons(); [cite_start]/* [cite: 686] */
            } catch (error) {
                console.error("Failed to discover more topics:", error); [cite_start]/* [cite: 687] */
                errorP.textContent = "Sorry, couldn't generate a new topic right now."; [cite_start]/* [cite: 688] */
            } finally {
                button.disabled = false; [cite_start]/* [cite: 689] */
            }
        }
        
        async function handleCustomVisualThemeGeneration() {
            const prompt = document.getElementById('theme-prompt').value; [cite_start]/* [cite: 690] */
            if(!prompt) return; [cite_start]/* [cite: 691] */

            const loader = document.getElementById('theme-loader-container'); [cite_start]/* [cite: 691] */
            const errorContainer = document.getElementById('theme-error-container'); [cite_start]/* [cite: 691] */
            const generateBtn = document.getElementById('generate-theme-btn'); [cite_start]/* [cite: 691] */
            
            loader.classList.remove('hidden'); [cite_start]/* [cite: 691] */
            errorContainer.classList.add('hidden'); [cite_start]/* [cite: 692] */
            generateBtn.disabled = true; [cite_start]/* [cite: 692] */
            try {
                const imagePrompt = `Artistic, abstract background image inspired by "${prompt}". Suitable for an IT website. Professional, clean. Wide aspect ratio, photographic, cinematic lighting.`; [cite_start]/* [cite: 692] */
                const [colorResult, imageResult] = await Promise.allSettled([callColorGenAPI(prompt), callImageGenAPI(imagePrompt)]); [cite_start]/* [cite: 693] */
                if (colorResult.status === 'fulfilled' && colorResult.value) applyTheme(colorResult.value); [cite_start]/* [cite: 694] */
                else throw colorResult.reason || new Error("Failed to generate color theme."); [cite_start]/* [cite: 694] */
                if (imageResult.status === 'fulfilled' && imageResult.value) applyHeaderImage(imageResult.value); [cite_start]/* [cite: 695] */
                else throw imageResult.reason || new Error("Failed to generate header image."); [cite_start]/* [cite: 695] */
                
                document.getElementById('themeGeneratorModal').classList.add('hidden'); [cite_start]/* [cite: 695] */
            } catch (error) {
                showThemeError(error.message); [cite_start]/* [cite: 696] */
            } finally {
                loader.classList.add('hidden'); [cite_start]/* [cite: 697] */
                generateBtn.disabled = false; [cite_start]/* [cite: 698] */
            }
        }
        
        function showThemeError(message) {
            const errorContainer = document.getElementById('theme-error-container'); [cite_start]/* [cite: 698] */
            errorContainer.textContent = message; [cite_start]/* [cite: 699] */
            errorContainer.classList.remove('hidden'); [cite_start]/* [cite: 699] */
        }

        async function generateJumpToButtons() {
            const container = document.getElementById('jump-to-nav-container'); [cite_start]/* [cite: 699] */
            const cards = Array.from(document.querySelectorAll('#custom-plan-card, #main-grid .card')); [cite_start]/* [cite: 700] */
            if (cards.length <= 1) return; [cite_start]/* [cite: 700] */
            const cardData = cards.map(card => ({
                [cite_start]id: card.id, /* [cite: 701] */
                [cite_start]title: card.querySelector('h2')?.textContent /* [cite: 701] */
            })).filter(c => c.id && c.title); [cite_start]/* [cite: 701] */
            if (cardData.length === 0) return; [cite_start]/* [cite: 702] */
        
            const prompt = `For the following IT category titles, generate a very short, engaging label (1-2 words). Return a valid JSON object where keys are the original titles and values are the short labels. Titles: ${JSON.stringify(cardData.map(c => c.title))}. IMPORTANT: Ensure any double quotes in string values are properly escaped.`; [cite_start]/* [cite: 702] */
            try {
                const jsonText = await callGeminiAPI(prompt, true); [cite_start]/* [cite: 705] */
                if (!jsonText) throw new Error("AI returned empty data for jump-to buttons."); [cite_start]/* [cite: 706] */
                
                const labels = parseJsonWithCorrections(jsonText); [cite_start]/* [cite: 706] */
                const buttonsHtml = cardData.map(card => {
                    [cite_start]const label = labels[card.title] || card.title.split(' ')[0]; /* [cite: 707] */
                    return `<button class="jump-to-button" data-target-id="${card.id}">${label}</button>`; [cite_start]/* [cite: 707] */
                }).join('');
                container.innerHTML = `<div class="flex flex-wrap gap-2 justify-center">${buttonsHtml}</div>`; [cite_start]/* [cite: 708] */
                container.classList.remove('hidden'); [cite_start]/* [cite: 708] */
            } catch (error) {
                console.error("Failed to generate jump-to buttons:", error); [cite_start]/* [cite: 708] */
                container.innerHTML = ''; [cite_start]/* [cite: 709] */
                container.classList.add('hidden');  [cite_start]/* [cite: 709] */
            }
        }

        function populateTypographySettings() {
            const fontSelect = document.getElementById('font-family-select'); [cite_start]/* [cite: 709] */
            const sizeSelect = document.getElementById('font-size-select'); [cite_start]/* [cite: 710] */
            const lineHeightSelect = document.getElementById('line-height-select'); [cite_start]/* [cite: 710] */
            
            const fonts = { 'Default (Inter)': "'Inter', sans-serif", 'Lato': "'Lato', sans-serif", 'Montserrat': "'Montserrat', sans-serif", 'Nunito Sans': "'Nunito Sans', sans-serif", 'Open Sans': "'Open Sans', sans-serif", 'Poppins': "'Poppins', sans-serif", 'Roboto Slab': "'Roboto Slab', serif" }; [cite_start]/* [cite: 710] */
            const sizes = { '14': '14px', '15': '15px', '16 (Default)': '16px', '17': '17px', '18': '18px' }; [cite_start]/* [cite: 711] */
            const lineHeights = { '1.4': '1.4', '1.5 (Default)': '1.5', '1.6': '1.6', '1.7': '1.7', '1.8': '1.8' }; [cite_start]/* [cite: 712] */
            Object.entries(fonts).forEach(([name, value]) => fontSelect.add(new Option(name, value))); [cite_start]/* [cite: 713] */
            Object.entries(sizes).forEach(([name, value]) => sizeSelect.add(new Option(name, value))); [cite_start]/* [cite: 713] */
            Object.entries(lineHeights).forEach(([name, value]) => lineHeightSelect.add(new Option(name, value))); [cite_start]/* [cite: 713] */
            fontSelect.value = fonts['Default (Inter)']; [cite_start]/* [cite: 714] */
            sizeSelect.value = '16px'; [cite_start]/* [cite: 714] */
            lineHeightSelect.value = '1.5'; [cite_start]/* [cite: 714] */
            
            root.style.setProperty('--font-family', fontSelect.value); [cite_start]/* [cite: 714] */
            root.style.setProperty('--font-size-base', sizeSelect.value); [cite_start]/* [cite: 714] */
            root.style.setProperty('--line-height-base', lineHeightSelect.value); [cite_start]/* [cite: 714] */
        }

        function copyElementTextToClipboard(element, button) {
            const textToCopy = element.innerText; [cite_start]/* [cite: 715] */
            const textarea = document.createElement('textarea'); [cite_start]/* [cite: 716] */
            textarea.value = textToCopy; [cite_start]/* [cite: 716] */
            textarea.style.position = 'fixed';  [cite_start]/* [cite: 716] */
            document.body.appendChild(textarea); [cite_start]/* [cite: 716] */
            textarea.select(); [cite_start]/* [cite: 716] */
            try {
                document.execCommand('copy'); [cite_start]/* [cite: 717] */
                const originalText = button.textContent; [cite_start]/* [cite: 718] */
                button.textContent = 'Copied!'; [cite_start]/* [cite: 718] */
                setTimeout(() => { button.textContent = originalText; }, 2000); [cite_start]/* [cite: 718] */
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err); [cite_start]/* [cite: 719] */
            }
            document.body.removeChild(textarea); [cite_start]/* [cite: 720] */
        }

        function renderAccordionFromMarkdown(markdownText, containerElement, generateImages = true) {
            containerElement.innerHTML = ''; [cite_start]/* [cite: 721] */
            if (!markdownText || !markdownText.trim()) {
                containerElement.innerHTML = convertMarkdownToHtml(null, false); [cite_start]/* [cite: 722] */
                return;
            }

            const fullHtml = convertMarkdownToHtml(markdownText, generateImages); [cite_start]/* [cite: 723] */
            const tempDiv = document.createElement('div'); [cite_start]/* [cite: 724] */
            tempDiv.innerHTML = fullHtml; [cite_start]/* [cite: 724] */

            const nodes = Array.from(tempDiv.childNodes); [cite_start]/* [cite: 724] */
            let currentAccordionItem = null; [cite_start]/* [cite: 724] */
            let introContent = document.createElement('div'); [cite_start]/* [cite: 724] */
            introContent.className = 'accordion-intro mb-4 prose max-w-none'; [cite_start]/* [cite: 725] */

            let firstHeaderFound = false; [cite_start]/* [cite: 725] */
            nodes.forEach(node => {
                if (!firstHeaderFound && node.tagName !== 'H3') {
                    [cite_start]introContent.appendChild(node.cloneNode(true)); /* [cite: 726] */
                    return;
                }
                
    
                 if (node.tagName === 'H3') {
                    firstHeaderFound = true; [cite_start]/* [cite: 727] */
                    if (introContent.hasChildNodes()) {
                        containerElement.appendChild(introContent); [cite_start]/* [cite: 727] */
                
                         introContent = document.createElement('div');  [cite_start]/* [cite: 728] */
                        introContent.className = 'accordion-intro mb-4 prose max-w-none'; [cite_start]/* [cite: 728] */
                    }

                    currentAccordionItem = document.createElement('div'); [cite_start]/* [cite: 728] */
                  
                   currentAccordionItem.className = 'accordion-item'; [cite_start]/* [cite: 729] */

                    const title = node.textContent; [cite_start]/* [cite: 729] */
                    const contentDiv = document.createElement('div'); [cite_start]/* [cite: 729] */
                    contentDiv.className = 'accordion-content prose max-w-none'; [cite_start]/* [cite: 729] */

                    currentAccordionItem.innerHTML = `
    
                         <button type="button" class="accordion-header">
                            <span class="text-left">${title}</span>
                            <svg class="icon w-5 h-5 transition-transform shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
    
                         </button>
                    `; [cite_start]/* [cite: 730] */
                    currentAccordionItem.appendChild(contentDiv); [cite_start]/* [cite: 732] */
                    containerElement.appendChild(currentAccordionItem); [cite_start]/* [cite: 732] */
                } else if (currentAccordionItem) {
                    const contentDiv = currentAccordionItem.querySelector('.accordion-content'); [cite_start]/* [cite: 732] */
                    contentDiv.appendChild(node.cloneNode(true)); [cite_start]/* [cite: 733] */
                }
            });
            if (!firstHeaderFound) {
                 const contentDiv = document.createElement('div'); [cite_start]/* [cite: 734] */
                 contentDiv.className = 'prose max-w-none'; [cite_start]/* [cite: 735] */
                 contentDiv.innerHTML = fullHtml; [cite_start]/* [cite: 735] */
                 containerElement.appendChild(contentDiv); [cite_start]/* [cite: 735] */
                 return;
            }

            if (introContent.hasChildNodes()) {
                containerElement.appendChild(introContent); [cite_start]/* [cite: 736] */
            }

            const firstItem = containerElement.querySelector('.accordion-item'); [cite_start]/* [cite: 736] */
            if (firstItem) {
                const header = firstItem.querySelector('.accordion-header'); [cite_start]/* [cite: 737] */
                header.classList.add('active'); [cite_start]/* [cite: 738] */
                header.querySelector('.icon').style.transform = 'rotate(180deg)'; [cite_start]/* [cite: 738] */
                firstItem.querySelector('.accordion-content').classList.add('open'); [cite_start]/* [cite: 738] */
            }
        }
        
        async function handleAIHelpRequest() {
            const modal = document.getElementById('inDepthModal'); [cite_start]/* [cite: 738] */
            const titleEl = document.getElementById('inDepthModalTitle'); [cite_start]/* [cite: 739] */
            const contentEl = document.getElementById('inDepthModalContent'); [cite_start]/* [cite: 739] */
            
            titleEl.textContent = "AI Help & Feedback"; [cite_start]/* [cite: 739] */
            contentEl.innerHTML = getLoaderHTML('Generating help guide and AI feedback...'); [cite_start]/* [cite: 740] */
            document.getElementById('inDepthModalButtons').innerHTML = ''; [cite_start]/* [cite: 740] */
            document.getElementById('modal-status-message').innerHTML = ''; [cite_start]/* [cite: 740] */
            modal.classList.remove('hidden'); [cite_start]/* [cite: 740] */
            const helpPrompt = `
                Generate a user-friendly help guide for this "IT Administration Hub" application. [cite_start]/* [cite: 741] */
                Explain the key features in separate sections. [cite_start]/* [cite: 741] */
                The features are: 
                1.  **Cloud Storage Integration**: A dedicated card on the main screen allows you to connect to Google Drive and/or Microsoft OneDrive. [cite_start]/* [cite: 742] */
                Once connected, you can save guides. Google Drive also supports importing guides. [cite_start]/* [cite: 743] */
                2.  **Saving Guides**: Inside the "In-Depth Guide" modal, buttons will appear to save the guide to your connected cloud services. [cite_start]/* [cite: 744] */
                The file is saved to an "IT Administration Hub" folder with a descriptive name. [cite_start]/* [cite: 745] */
                3.  **Custom Task Generator**: User enters any IT task, and the AI creates a detailed, step-by-step guide. [cite_start]/* [cite: 746] */
                4.  **Tailoring Options**: Buttons to refine the custom guide (e.g., 'for Security', 'for Beginners'). [cite_start]/* [cite: 747] */
                5.  **Pre-Built Categories**: AI-generated topics like VMware, Windows Server, etc., for quick access to common subjects. [cite_start]/* [cite: 748] */
                6.  **Visual Theme Generator**: A floating button allows you to describe a mood (e.g., 'ocean sunset'), and the AI creates a new color theme and header image for the application. [cite_start]/* [cite: 749] */
                7.  **In-Depth Exploration & Refinement**: You can expand a summary to see a full guide or ask the AI to rewrite and refine any generated content with further instructions. [cite_start]/* [cite: 750] */
                8.  **Important Note on Images**: Image generation for screenshot placeholders has been disabled in the pop-up modal views to improve readability and focus on the text content. [cite_start]/* [cite: 751] */
                Images are still generated on the main page. [cite_start]/* [cite: 752] */
                Format the output as a clean markdown document using '###' for each section title.`; [cite_start]/* [cite: 752] */
            const feedbackPrompt = `
                You are an AI expert in user experience (UX) and IT administration tools. [cite_start]/* [cite: 753] */
                You are reviewing this "IT Administration Hub" application.  [cite_start]/* [cite: 754] */
                Based on the feature descriptions below, provide constructive feedback. What is intuitive? [cite_start]/* [cite: 754] */
                What could be improved? What features might be missing for a senior IT administrator? [cite_start]/* [cite: 755] */
                **Application Features:**
                1.  **Cloud Storage Integration**: Connect to Google Drive/OneDrive to save/load guides. [cite_start]/* [cite: 756] */
                2.  **Custom Task Generator**: Enter any IT task for a step-by-step AI-generated guide. [cite_start]/* [cite: 757] */
                3.  **Tailoring Options**: Buttons to refine guides (e.g., 'for Security', 'for Beginners'). [cite_start]/* [cite: 758] */
                4.  [cite_start]**Pre-Built Categories**: AI-generated topics like VMware, Windows Server, etc. /* [cite: 759] */
                5.  **Visual Theme Generator**: Floating button to generate a new color theme and header image from a text prompt. [cite_start]/* [cite: 759] */
                6.  **In-Depth Exploration & Refinement**: Expand summaries to full guides or ask AI to rewrite content. [cite_start]/* [cite: 760] */
                7.  **Saved Articles**: A feature to save generated guides within the application's database. [cite_start]/* [cite: 761] */
                Format your feedback as a clean markdown document. Use '###' for section titles like "Strengths", "Areas for Improvement", and "Suggested Features".`; [cite_start]/* [cite: 762] */
            try {
                const [helpResult, feedbackResult] = await Promise.all([
                    [cite_start]callGeminiAPI(helpPrompt), /* [cite: 763] */
                    [cite_start]callGeminiAPI(feedbackPrompt) /* [cite: 763] */
                ]);
                const helpText = helpResult ? helpResult.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : ''; [cite_start]/* [cite: 764] */
                const feedbackText = feedbackResult ? feedbackResult.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : ''; [cite_start]/* [cite: 764] */
                contentEl.innerHTML = `
                    <div class="accordion-item">
                        <button type="button" class="accordion-header active">
                            <span class="text-left font-semibold">Application Help Guide</span>
                  
                             <svg class="icon w-5 h-5 transition-transform shrink-0" style="transform: rotate(180deg);"
 fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content open prose max-w-none">
                            ${marked.parse(helpText || '<p class="themed-text-muted">Could not load help content.</p>')}
                         </div>
                    </div>
                    <div class="accordion-item">
                        <button type="button" class="accordion-header">
           
                              <span class="text-left font-semibold">AI-Generated Feedback</span>
                            <svg class="icon w-5 h-5 transition-transform shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
           
                          <div class="accordion-content prose max-w-none">
                            ${marked.parse(feedbackText ||
 '<p class="themed-text-muted">Could not load feedback.</p>')}
                        </div>
                    </div>
                `; [cite_start]/* [cite: 765] */
                contentEl.querySelectorAll('pre:not(code-block-container pre)').forEach(preBlock => {
                    [cite_start]const codeBlock = preBlock.querySelector('code'); /* [cite: 772] */
                    const lang = codeBlock ? (Array.from(codeBlock.classList).find(c => c.startsWith('language-'))?.replace('language-', '') || 'text') : 'text'; [cite_start]/* [cite: 772] */
                    
                    const container 
 = document.createElement('div'); [cite_start]/* [cite: 772] */
                    container.className = 'code-block-container'; [cite_start]/* [cite: 773] */
                    
                    const header = document.createElement('div'); [cite_start]/* [cite: 773] */
                    header.className = 'code-block-header'; [cite_start]/* [cite: 773] */
            
                     header.innerHTML = `<span>${lang}</span><button class="copy-code-button">Copy</button>`; [cite_start]/* [cite: 774] */

                    container.appendChild(header); [cite_start]/* [cite: 774] */
                    preBlock.parentNode.insertBefore(container, preBlock); [cite_start]/* [cite: 774] */
                    container.appendChild(preBlock); [cite_start]/* [cite: 774] */
                });
            } catch (error) {
                handleApiError(error, contentEl, 'AI help content'); [cite_start]/* [cite: 775] */
            }
        }
        
        async function handleExploreInDepth(themeId, themeType, cardName) {
            const item = allThemeData[themeType]?.find(d => String(d.id) === String(themeId)); [cite_start]/* [cite: 776] */
            if (!item) {
                console.error("Could not find item for in-depth view", {themeId, themeType}); [cite_start]/* [cite: 777] */
                return;
            }
            
            await markItemAsViewed(cardName, item.title);

            const modal = document.getElementById('inDepthModal'); [cite_start]/* [cite: 778] */
            const titleEl = document.getElementById('inDepthModalTitle'); [cite_start]/* [cite: 779] */
            const contentEl = document.getElementById('inDepthModalContent'); [cite_start]/* [cite: 779] */
            const footerEl = document.getElementById('inDepthModalFooter'); [cite_start]/* [cite: 779] */
            
            const fullTitle = `In-Depth: ${item.title}`; [cite_start]/* [cite: 779] */
            titleEl.textContent = fullTitle; [cite_start]/* [cite: 779] */
            contentEl.innerHTML = getLoaderHTML(`Generating detailed guide for ${item.title}...`); [cite_start]/* [cite: 780] */
            document.getElementById('modal-status-message').textContent = ''; [cite_start]/* [cite: 780] */
            
            const buttonContainer = document.getElementById('inDepthModalButtons'); [cite_start]/* [cite: 780] */
            buttonContainer.innerHTML = ''; [cite_start]/* [cite: 780] */

            footerEl.dataset.themeId = themeId; [cite_start]/* [cite: 780] */
            footerEl.dataset.themeType = themeType; [cite_start]/* [cite: 781] */
            footerEl.dataset.fullTitle = fullTitle; [cite_start]/* [cite: 781] */
            footerEl.dataset.cardName = cardName; [cite_start]/* [cite: 781] */

            modal.classList.remove('hidden'); [cite_start]/* [cite: 781] */
            
            const context = { cardTitle: cardName, cardDescription: item.description }; [cite_start]/* [cite: 781] */
            const prompt = getEnhancedPrompt(item.title, '', '', context); [cite_start]/* [cite: 782] */

            try {
                let resultText = await callGeminiAPI(prompt); [cite_start]/* [cite: 782] */
                resultText = resultText ? resultText.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : ''; [cite_start]/* [cite: 783] */
                
                originalGeneratedText.set(fullTitle, resultText); [cite_start]/* [cite: 783] */
                // Save original text for refinement
                
                const summaryHeader = `### ${item.title} - A Comprehensive Guide`; [cite_start]/* [cite: 784] */
                const summaryParagraph = `This guide provides a detailed walkthrough for "${item.title}". It covers prerequisites, step-by-step instructions, verification methods, troubleshooting common issues, and helpful resources to assist you in successfully completing this task within the broader context of "${cardName}".`; [cite_start]/* [cite: 784] */
                const finalMarkdownForDisplay = `${summaryHeader}\n\n${summaryParagraph}\n\n${resultText}`; [cite_start]/* [cite: 787] */

                contentEl.innerHTML = ''; [cite_start]/* [cite: 787] */
                renderAccordionFromMarkdown(finalMarkdownForDisplay, contentEl, false); [cite_start]/* [cite: 787] */
                
                const saveDbBtn = document.createElement('button'); [cite_start]/* [cite: 787] */
                saveDbBtn.id = 'save-to-db-btn'; [cite_start]/* [cite: 787] */
                saveDbBtn.className = 'btn-secondary'; [cite_start]/* [cite: 787] */
                saveDbBtn.disabled = savedArticleIds.has(fullTitle); [cite_start]/* [cite: 788] */
                saveDbBtn.textContent = savedArticleIds.has(fullTitle) ? 'Saved!' : 'Save to My Articles'; [cite_start]/* [cite: 788] */
                buttonContainer.appendChild(saveDbBtn); [cite_start]/* [cite: 788] */
                
                // Add script and cheat sheet buttons
                const scriptBtn = document.createElement('button');
                scriptBtn.className = 'btn-secondary generate-script-button';
                scriptBtn.textContent = 'Generate Script';
                scriptBtn.dataset.textKey = fullTitle;
                buttonContainer.appendChild(scriptBtn);
                
                const cheatSheetBtn = document.createElement('button');
                cheatSheetBtn.className = 'btn-secondary generate-cheatsheet-button';
                cheatSheetBtn.textContent = 'Generate Cheat Sheet';
                cheatSheetBtn.dataset.textKey = fullTitle;
                buttonContainer.appendChild(cheatSheetBtn);

                if (gapi.client.getToken() !== null) {
                    const saveDriveBtn = document.createElement('button'); [cite_start]/* [cite: 789] */
                    saveDriveBtn.id = 'save-to-drive-btn'; [cite_start]/* [cite: 790] */
                    saveDriveBtn.className = 'btn-secondary'; [cite_start]/* [cite: 790] */
                    saveDriveBtn.textContent = 'Save to Google Drive'; [cite_start]/* [cite: 790] */
                    buttonContainer.appendChild(saveDriveBtn); [cite_start]/* [cite: 790] */
                }
                if (msalAccount) {
                     const saveOneDriveBtn = document.createElement('button'); [cite_start]/* [cite: 791] */
                     saveOneDriveBtn.id = 'save-to-onedrive-btn'; [cite_start]/* [cite: 792] */
                     saveOneDriveBtn.className = 'btn-secondary'; [cite_start]/* [cite: 792] */
                     saveOneDriveBtn.textContent = 'Save to OneDrive'; [cite_start]/* [cite: 792] */
                     buttonContainer.appendChild(saveOneDriveBtn); [cite_start]/* [cite: 792] */
                }


            } catch (error) {
                handleApiError(error, contentEl, 'in-depth content'); [cite_start]/* [cite: 793] */
            }
        }
        
        function toggleRefineUI(buttonContainer, isModal = false) {
            let refineContainer = buttonContainer.nextElementSibling; [cite_start]/* [cite: 794] */
            if (refineContainer && refineContainer.classList.contains('refine-container')) {
                refineContainer.remove(); [cite_start]/* [cite: 795] */
                return;
            }

            refineContainer = document.createElement('div'); [cite_start]/* [cite: 796] */
            refineContainer.className = 'refine-container w-full'; [cite_start]/* [cite: 796] */
            refineContainer.innerHTML = `
                <textarea class="w-full p-2 themed-input border rounded-lg" rows="2" placeholder="e.g., 'Make it for a junior admin' or 'Add PowerShell examples'"></textarea>
                <button class="btn-primary text-sm mt-2 submit-refinement-button" data-is-modal="${isModal}">Submit Refinement</button>
            `; [cite_start]/* [cite: 797] */
            buttonContainer.insertAdjacentElement('afterend', refineContainer); [cite_start]/* [cite: 798] */
            refineContainer.querySelector('textarea').focus(); [cite_start]/* [cite: 798] */
        }

        async function handleRefineRequest(refineContainer) {
            const refinementRequest = refineContainer.querySelector('textarea').value; [cite_start]/* [cite: 798] */
            if (!refinementRequest) return; [cite_start]/* [cite: 799] */

            const isModal = refineContainer.querySelector('.submit-refinement-button').dataset.isModal === 'true'; [cite_start]/* [cite: 799] */
            
            const contentArea = isModal ? document.getElementById('inDepthModalContent') : refineContainer.closest('.details-container, #gemini-result-container'); [cite_start]/* [cite: 799] */
            let themeId, themeType, textKey; [cite_start]/* [cite: 800] */
            if (isModal) {
                const footerEl = document.getElementById('inDepthModalFooter'); [cite_start]/* [cite: 800] */
                themeId = footerEl.dataset.themeId; [cite_start]/* [cite: 801] */
                themeType = footerEl.dataset.themeType; [cite_start]/* [cite: 801] */
                textKey = footerEl.dataset.fullTitle; [cite_start]/* [cite: 801] */
            } else {
                const exploreButton = contentArea.querySelector('.explore-button'); [cite_start]/* [cite: 801] */
                themeId = exploreButton?.dataset.themeId || 'custom-plan'; [cite_start]/* [cite: 802] */
                themeType = exploreButton?.dataset.themeType || 'custom'; [cite_start]/* [cite: 802] */
                const item = allThemeData[themeType]?.find(d => String(d.id) == String(themeId)); [cite_start]/* [cite: 802] */
                const cardTitle = contentArea.closest('.card').querySelector('h2').textContent; [cite_start]/* [cite: 802] */
                textKey = item ? `${cardTitle} - ${item.title}` : 'custom-plan';
            }
            
            const originalText = originalGeneratedText.get(textKey); [cite_start]/* [cite: 803] */
            if (!originalText) {
                handleApiError({message: "Could not find the original text to refine. Please generate the content again first."}, contentArea, "refinement"); [cite_start]/* [cite: 804] */
                return;
            }
            
            contentArea.innerHTML = getLoaderHTML(`Refining guide based on your request...`); [cite_start]/* [cite: 805] */
            const prompt = getEnhancedPrompt(refinementRequest, '', originalText); [cite_start]/* [cite: 806] */
            
            try {
                let newText = await callGeminiAPI(prompt); [cite_start]/* [cite: 806] */
                newText = newText ? newText.replace(/^```(markdown)?\n?/g, '').replace(/\n?```$/g, '').trim() : ''; [cite_start]/* [cite: 807] */
                
                originalGeneratedText.set(textKey, newText); [cite_start]/* [cite: 807] */
                if (isModal) {
                    renderAccordionFromMarkdown(newText, contentArea, false); [cite_start]/* [cite: 808] */
                } else {
                    renderAccordionFromMarkdown(newText, contentArea); [cite_start]/* [cite: 809] */
                    addPostGenerationButtons(contentArea, themeId, themeType); [cite_start]/* [cite: 810] */
                    generateAndInjectImages(contentArea); [cite_start]/* [cite: 810] */
                }

            } catch(error) {
                handleApiError(error, contentArea, 'refinement'); [cite_start]/* [cite: 810] */
            }
        }
        
        function getIconForTheme(themeType, themeId) { 
            const icons = {
                [cite_start]serviceNowAdmin: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`, /* [cite: 811] */
                [cite_start]windowsServer: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>`, /* [cite: 812] */
                [cite_start]m365Admin: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path></svg>`, /* [cite: 812] */
                [cite_start]default: `<svg class="w-8 h-8 mx-auto themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>` /* [cite: 813] */
            }
            return icons[themeType] ||
            icons.default; [cite_start]/* [cite: 813] */
        }
        
        function getLoaderHTML(message) { return `<div class="flex justify-center items-center my-4"><div class="loader themed-loader"></div><p class="ml-4 themed-text-muted">${message}</p></div>`; [cite_start]/* [cite: 814] */ }

        function sanitizeTitle(title) {
            if (typeof title !== 'string') return ''; [cite_start]/* [cite: 815] */
            // Removes leading/trailing quotes, asterisks, hyphens, and whitespace.
            return title.replace(/^["*-\s]+|["*-\s]+$/g, '').trim(); [cite_start]/* [cite: 816] */
        }
        
        function truncateText(text, maxLength = 50) {
            if (typeof text !== 'string' || text.length <= maxLength) {
                return text; [cite_start]/* [cite: 817] */
            }
            return text.substring(0, maxLength) + '...'; [cite_start]/* [cite: 818] */
        }

        function generateErrorMessage(error, type = 'general') { console.error(`Error during ${type} generation:`, error); [cite_start]/* [cite: 819] */ let message = `An unknown error occurred. ${error.message}`; const errText = error.message.toLowerCase(); [cite_start]/* [cite: 819] */ if (errText.includes('safety') || errText.includes('blocked')) message = `Request blocked for safety reasons. Please try a different prompt.`; [cite_start]/* [cite: 821] */ else if (errText.includes('api key not valid')) message = `Authentication failed. Your API Key is not valid.`; [cite_start]/* [cite: 822] */ else if (errText.includes('429')) message = `Request limit exceeded. Please try again later.`; [cite_start]/* [cite: 823] */ else if (errText.includes('timed out')) message = `The request timed out. Please check your connection and try again.`; [cite_start]/* [cite: 824] */ return `Sorry, a critical error occurred: ${message}`; }

    </script>
</body>
</html>
